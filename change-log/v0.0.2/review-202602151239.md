# PR Review: procutil HideWindow 共通化 & ConPTY ロジック修正

**レビュー日時**: 2026-02-15 12:39  
**レビュー対象**: コミット前の myT-x 配下の全変更ファイル  
**レビュー方式**: 5つの専門エージェントによる並列レビュー + ビルド・テスト検証  

---

## 変更概要

### 目的
`HideWindow`（Windows でのコンソールウィンドウフラッシュ防止）を複数パッケージの重複実装から `internal/procutil` パッケージに一元化し、未適用箇所にも追加する。

### 変更ファイル一覧

| カテゴリ | ファイル | 変更種別 |
|---------|---------|---------|
| **procutil（新規共通パッケージ）** | `internal/procutil/hide_window_other.go` | 新規 |
| | `internal/procutil/hide_window_windows.go` | 新規 |
| | `internal/procutil/hide_window_windows_test.go` | 新規 |
| **Worktree API** | `app_worktree_api.go` | 変更 |
| | `app_worktree_api_test.go` | 変更 |
| | `app_worktree_other.go` | 削除 |
| | `app_worktree_windows.go` | 削除 |
| **Git internal** | `internal/git/command.go` | 変更 |
| | `internal/git/git_other.go` | 削除 |
| | `internal/git/git_windows.go` | 削除 |
| **Install internal** | `internal/install/shim_path_windows.go` | 変更 |
| | `internal/install/shim_source_windows.go` | 変更 |
| **Terminal** | `internal/terminal/terminal.go` | 変更 |
| | `internal/terminal/terminal_unix.go` | 変更 |
| | `internal/terminal/terminal_windows.go` | 変更 |
| | `internal/terminal/should_use_conpty_windows_test.go` | 新規 |
| **その他** | `.gitattributes` | 新規 |

---

## ビルド・テスト結果

| 項目 | 結果 |
|------|------|
| `go build ./...` | ✅ PASS |
| `go test ./internal/procutil/` | ✅ PASS (3/3 テスト合格) |
| `go test ./internal/terminal/ -run TestShouldUseConPty` | ✅ PASS (22/22 テスト合格) |

---

## レビュー結果サマリ

### Critical Issues (0件)

なし。

### Important Issues (0件)

なし。

### Suggestions (7件)

#### S-1: SECURITYコメント「validated installDir」の表現が不正確
- **ファイル**: `internal/install/shim_path_windows.go` L35
- **内容**: コメントに「validated installDir」とあるが、`installDir` は `LOCALAPPDATA` 環境変数 + 固定文字列から生成されており、明示的なバリデーションは行われていない。`exec.Command` はシェルを介さないためインジェクションリスクは実質ないが、コメントの正確性として以下を推奨：
  ```go
  // SECURITY: "reg" args are fixed constants; installDir is derived from LOCALAPPDATA (not user input).
  ```

#### S-2: DISABLE環境変数の非対称なパース（ドキュメント推奨）
- **ファイル**: `internal/terminal/terminal_windows.go`
- **内容**: `GO_TMUX_DISABLE_CONPTY` はホワイトリスト（`1/true/yes/on` のみ無効化）、`GO_TMUX_ENABLE_CONPTY` はブラックリスト（`0/false/no/off` のみ有効化阻止）。方針として「デフォルト有効」で一貫しているため実害はないが、`DISABLE=random` が無効化しない挙動は直感に反する可能性がある。テストで挙動は文書化済みなので、現状のまま問題ないレベル。

#### S-3: `TestHideWindowDoesNotAffectOtherFields` の検証対象が不適切
- **ファイル**: `internal/procutil/hide_window_windows_test.go`
- **内容**: `cmd.Dir` や `cmd.Env` は `SysProcAttr` とは構造的に無関係で、検証の価値が薄い。代わりに冪等性テスト（二重呼び出し）に置き換えることを推奨：
  ```go
  func TestHideWindowIdempotent(t *testing.T) {
      cmd := exec.Command("cmd.exe", "/c", "echo", "test")
      HideWindow(cmd)
      HideWindow(cmd) // 二重呼び出し
      if !cmd.SysProcAttr.HideWindow {
          t.Error("HideWindow should remain true after double call")
      }
  }
  ```

#### S-4: `shouldUseConPty` テストにエッジケース追加候補
- **ファイル**: `internal/terminal/should_use_conpty_windows_test.go`
- **内容**: 以下のケースを追加するとより堅牢：
  - `disable=random_string` → 期待値: `true`
  - `enable=" "` (空白のみ) → 期待値: `true`（`TrimSpace` 後に空文字 → デフォルト有効）

#### S-5: `procutil.HideWindow` に cmd の nil ガードが無い
- **ファイル**: `internal/procutil/hide_window_windows.go`
- **内容**: `cmd.SysProcAttr` の nil チェックはあるが、`cmd` 自体が nil の場合 panic する。呼び出し元では `exec.Command` 直後に呼ぶパターンなので実質問題ないが、ユーティリティ関数としては `if cmd == nil { return }` を先頭に置くとより堅牢。

#### S-6: `.gitattributes` のカバレッジ不足
- **ファイル**: `.gitattributes`
- **内容**: `*.go`, `go.mod`, `go.sum`, `frontend/wailsjs/**` がカバーされているが、`Makefile`, `*.yaml`, `*.json`, `*.ts`, `*.html` が含まれていない。広範な正規化を意図するなら `* text=auto` をベースに設定する方がよい。

#### S-7: `internal/procutil` に `doc.go` がない
- **ファイル**: `internal/procutil/`
- **内容**: 他の `internal/` パッケージとの一貫性として `doc.go` があるとよいが、現時点では関数1つのみのため優先度低。

---

### Positive Observations (8件)

1. **DRY原則に則った適切なリファクタリング** - 4箇所の重複実装を1パッケージに統合
2. **SysProcAttr保全ロジックの改善** - 旧実装は毎回新規作成して上書きしていたバグを修正
3. **shouldUseConPtyのデッドコード修正** - 旧コードでは `ENABLE=0/false` が効かないバグがあったのを正しく修正
4. **SECURITYコメントの一貫した付与** - 全ての `exec.Command` 呼び出しに信頼境界コメント
5. **install/startPipeModeへのHideWindow新規追加** - 未適用だった箇所を漏れなく対応
6. **テストの充実** - 22ケースの `shouldUseConPty` テスト、3ケースの `HideWindow` テスト
7. **削除ファイルの完全な除去** - 旧実装への参照が残っていないことを確認
8. **ConPTYパスでのHideWindow不要の明示的コメント** - 技術的に正確

---

## exec.Command 呼び出し箇所の網羅性確認

本番コードの全 `exec.Command` / `exec.CommandContext` 使用箇所を調査した結果：

| # | ファイル | HideWindow | 備考 |
|---|---------|:----------:|------|
| 1 | `app_worktree_api.go` L29 | ✅ | `exec.CommandContext` |
| 2 | `internal/git/command.go` L75 | ✅ | `exec.Command` |
| 3 | `internal/terminal/terminal.go` L55 | ✅ | `startPipeMode` |
| 4 | `internal/terminal/terminal_unix.go` L27 | — | Unix専用, HideWindowはno-op |
| 5 | `internal/install/shim_source_windows.go` L33 | ✅ | 新規追加 |
| 6 | `internal/install/shim_path_windows.go` L36 | ✅ | 新規追加 |
| 7 | `internal/install/shim_path_windows.go` L46 | ✅ | 新規追加 |

**cmd/tmux-shim**, **cmd/go-tmux** には `exec.Command` 使用なし。漏れなし。

---

## 修正タスク一覧と並列作業可否

| # | タスク | 優先度 | 対象ファイル | 並列作業 | 理由 |
|---|--------|--------|-------------|:--------:|------|
| S-1 | SECURITYコメント文言修正 | 低 | `install/shim_path_windows.go` | ✅ 可能 | 他タスクと独立、同ファイル内の変更 |
| S-2 | DISABLE非対称パースのドキュメント化 | 低 | `terminal_windows.go` または README | ✅ 可能 | 他タスクと独立 |
| S-3 | テスト改善（冪等性テスト追加） | 低 | `procutil/hide_window_windows_test.go` | ✅ 可能 | 他タスクと独立 |
| S-4 | shouldUseConPtyテストのエッジケース追加 | 低 | `terminal/should_use_conpty_windows_test.go` | ✅ 可能 | 他タスクと独立 |
| S-5 | cmd nil ガード追加 | 低 | `procutil/hide_window_windows.go` | ✅ 可能 | 他タスクと独立 |
| S-6 | .gitattributes カバレッジ拡大 | 低 | `.gitattributes` | ✅ 可能 | 他タスクと独立 |
| S-7 | doc.go 追加 | 低 | `procutil/doc.go` | ✅ 可能 | 他タスクと独立 |

### 並列作業の詳細判定

全7タスクは互いに異なるファイルを対象としており、依存関係がありません。  
**全タスクが並列で同時実行可能です。**

| 並列グループ | 含まれるタスク | 競合リスク |
|-------------|--------------|:----------:|
| グループ A | S-1 (`shim_path_windows.go`) | なし |
| グループ B | S-2 (`terminal_windows.go` / README) | なし |
| グループ C | S-3 (`hide_window_windows_test.go`) | なし |
| グループ D | S-4 (`should_use_conpty_windows_test.go`) | なし |
| グループ E | S-5 (`hide_window_windows.go`) | なし |
| グループ F | S-6 (`.gitattributes`) | なし |
| グループ G | S-7 (`procutil/doc.go`) | なし |

---

## 総合判定

| レベル | 件数 |
|--------|:----:|
| Critical | **0** |
| Important | **0** |
| Suggestion | **7** |
| Positive | **8** |

**結論**: Critical・Important の指摘事項なし。コードは正しくビルド・テスト通過済み。`HideWindow` の共通化は完全に実施されており、旧実装の `SysProcAttr` 上書きバグと `shouldUseConPty` のデッドコードバグも修正されている。Suggestion は全て低優先度であり、マージをブロックする要因はない。
