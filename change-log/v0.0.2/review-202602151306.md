# PR Review Summary

**レビュー日時**: 2026-02-15 13:06  
**レビュー対象**: myT-x/ 配下のコミット前差分  
**変更概要**: `HideWindow` の `procutil` パッケージへの共通化リファクタリング、`shouldUseConPty` のバグ修正、`.gitattributes` 追加

---

## 変更ファイル一覧

### 変更されたファイル (12件)
| ファイル | 変更内容 |
|---------|---------|
| `app_worktree_api.go` | `hideWindowForSetup(cmd)` → `procutil.HideWindow(cmd)` |
| `app_worktree_api_test.go` | 同上（テスト側） |
| `app_worktree_other.go` | **削除** (旧 no-op stub) |
| `app_worktree_windows.go` | **削除** (旧 Windows 実装) |
| `internal/git/command.go` | `hideWindow(cmd)` → `procutil.HideWindow(cmd)` + SECURITYコメント |
| `internal/git/git_other.go` | **削除** (旧 no-op stub) |
| `internal/git/git_windows.go` | **削除** (旧 Windows 実装) |
| `internal/install/shim_path_windows.go` | `procutil.HideWindow` 追加 (reg add/query) |
| `internal/install/shim_source_windows.go` | `procutil.HideWindow` 追加 (go build) + エラーメッセージ改善 |
| `internal/terminal/terminal.go` | `procutil.HideWindow` 追加 (startPipeMode) |
| `internal/terminal/terminal_unix.go` | SECURITYコメント追加 |
| `internal/terminal/terminal_windows.go` | `shouldUseConPty` ロジック修正 + docコメント追加 |

### 新規作成ファイル (6件)
| ファイル | 内容 |
|---------|------|
| `internal/procutil/doc.go` | パッケージドキュメント |
| `internal/procutil/hide_window_other.go` | HideWindow no-op (!windows) |
| `internal/procutil/hide_window_windows.go` | HideWindow 実装 (windows) |
| `internal/procutil/hide_window_windows_test.go` | HideWindow テスト (4ケース) |
| `internal/terminal/should_use_conpty_windows_test.go` | shouldUseConPty テスト (22ケース) |
| `.gitattributes` | 改行コード正規化設定 |

---

## Critical Issues (0件)

なし。

---

## Important Issues (1件)

### I-1: コメント内の旧関数名が残存
- **ファイル**: `internal/git/command.go:52`
- **内容**: `runGitCLI` のdocコメントに旧関数名 `hideWindow` が残っている
  ```go
  // Handles semaphore concurrency limiting, index.lock retry, and Windows hideWindow.
  ```
- **修正案**: `hideWindow` → `HideWindow` または `procutil.HideWindow` に更新
- **理由**: 実際の呼び出しは `procutil.HideWindow(cmd)` に変更済みのため、コメントが実装と乖離している

---

## Suggestions (5件)

### S-1: `HideWindow` のgodocコメントの同語反復
- **ファイル**: `internal/procutil/hide_window_windows.go:10`
- **内容**: `HideWindow sets HideWindow on Windows` は同語反復（tautology）
- **修正案**: `// HideWindow configures cmd to suppress the console window flash on Windows.`
- **優先度**: 低

### S-2: `shouldUseConPty` テストに両方非標準値のケース追加
- **ファイル**: `internal/terminal/should_use_conpty_windows_test.go`
- **内容**: `disable=random, enable=random` 等の両方非標準値ケースがない
- **修正案**: テストケース追加
  ```go
  {name: "both non-standard defaults true", disable: "random", enable: "random", want: true},
  {name: "disable=random + enable=off", disable: "random", enable: "off", want: false},
  ```
- **優先度**: 低

### S-3: `shouldUseConPty` のロジック変更をコミットメッセージに明記
- **内容**: `GO_TMUX_ENABLE_CONPTY=0/false/no/off` が ConPTY を無効化するようになった動作変更（旧ロジックのバグ修正）をコミットメッセージに記載推奨
- **理由**: CLAUDE.mdで後方互換不要と明記されているため問題にはならないが、変更点の可視化として有用
- **優先度**: 低

### S-4: `.gitattributes` にバイナリファイル指定の追加検討
- **ファイル**: `.gitattributes`
- **内容**: `build/` 配下のバイナリファイルの誤テキスト検出防止
- **修正案**:
  ```
  # Binary files
  *.exe    binary
  *.dll    binary
  *.ico    binary
  *.png    binary
  *.syso   binary
  ```
- **優先度**: 低

### S-5: `shouldUseConPty` の "whitelist/blacklist" 用語
- **ファイル**: `internal/terminal/terminal_windows.go:55-63`
- **内容**: DISABLE変数に「whitelist」、ENABLE変数に「blacklist」という表現は二重否定的で初見で混乱する可能性がある
- **修正案**: 「opt-in disabling / opt-out enabling」のような用語に変更
- **優先度**: 低（直後の箇条書きで具体値と挙動が明記されているため実害なし）

---

## Strengths（良い点）

1. **DRY原則に忠実な共通化**: 4パッケージに散在していた `hideWindow` 系関数を `procutil.HideWindow` に一元化。旧ファイル4つも確実に削除済み
2. **防御的な `HideWindow` 実装**: nil ガード、既存 `SysProcAttr` の保持、冪等性が全て担保されている
3. **SECURITYコメントの一貫性**: 全 `exec.Command` 呼び出し箇所にSECURITYコメントが付与され、信頼境界が文書化されている
4. **テストの網羅性**: `HideWindow` 4ケース + `shouldUseConPty` 22ケースで主要パターンを網羅
5. **ConPTYパスの明確なコメント**: HideWindow が不要な理由をコメントで記載し、将来の誤追加を防止
6. **`shouldUseConPty` のバグ修正**: 旧ロジックのデッドコード（ENABLE変数が機能しない）を正しく修正
7. **`.gitattributes` による改行コード問題の根本解決**: Windows開発環境でのCRLF/LF混在問題を解消
8. **エラーメッセージの改善**: `shim_source_windows.go` のエラーメッセージに `dir=` を追加しデバッグ性向上
9. **ビルド・テスト確認**: `go build ./...` PASS、全テスト PASS 確認済み

---

## `shouldUseConPty` ロジック変更の動作差分

| 条件 | 旧結果 | 新結果 | 変更 |
|------|--------|--------|------|
| 両方未設定 | `true` | `true` | なし |
| `DISABLE=1` | `false` | `false` | なし |
| `DISABLE=0` | `true` | `true` | なし |
| `DISABLE=1, ENABLE=1` | `false` | `false` | なし |
| `ENABLE=1` | `true` | `true` | なし |
| `ENABLE=true` | `true` | `true` | なし |
| `ENABLE=0` | **`true`** | **`false`** | **バグ修正** |
| `ENABLE=false` | **`true`** | **`false`** | **バグ修正** |
| `ENABLE=no` | **`true`** | **`false`** | **バグ修正** |
| `ENABLE=off` | **`true`** | **`false`** | **バグ修正** |
| `ENABLE=unknown` | `true` | `true` | なし |
| `ENABLE=  ` (空白のみ) | `true` | `true` | なし |

---

## `exec.Command` 呼び出し箇所の HideWindow 適用状況

| # | ファイル | 用途 | HideWindow | 備考 |
|---|---------|------|-----------|------|
| 1 | `app_worktree_api.go:29` | シェルスクリプト実行 | ✅ | `exec.CommandContext` |
| 2 | `internal/git/command.go:75` | git CLI | ✅ | `exec.Command` |
| 3 | `internal/install/shim_path_windows.go:36` | reg add | ✅ | `exec.Command` |
| 4 | `internal/install/shim_path_windows.go:46` | reg query | ✅ | `exec.Command` |
| 5 | `internal/install/shim_source_windows.go:33` | go build | ✅ | `exec.Command` |
| 6 | `internal/terminal/terminal.go:55` | pipe mode | ✅ | `exec.Command` |
| 7 | `internal/terminal/terminal_unix.go:27` | PTY (creack/pty) | 不要 | PTY経由 |
| 8 | `internal/terminal/terminal_windows.go` | ConPTY | 不要 | CreateProcess経由、コメント記載済み |

**漏れ: なし**

---

## Recommended Action

1. ✅ I-1 を修正（コメントの旧関数名）
2. 任意: S-1〜S-5 を検討
3. コミット

---

## タスク修正の並列作業可否

以下は各修正タスクについて、他のタスクと並列作業しても問題がないかを整理した表です。

| # | タスク | 対象ファイル | 並列OK | 理由 |
|---|--------|------------|--------|------|
| I-1 | コメント旧関数名修正 | `internal/git/command.go` | ✅ 可 | コメントのみの変更。他ファイルに影響なし |
| S-1 | HideWindow godoc修正 | `internal/procutil/hide_window_windows.go` | ✅ 可 | コメントのみの変更。他ファイルに影響なし |
| S-2 | テストケース追加 | `internal/terminal/should_use_conpty_windows_test.go` | ✅ 可 | テストファイルのみ。本番コードに影響なし |
| S-3 | コミットメッセージ記載 | (コミット時) | ✅ 可 | コードへの変更なし |
| S-4 | .gitattributes バイナリ指定 | `.gitattributes` | ✅ 可 | 独立した設定ファイル。他ファイルに影響なし |
| S-5 | whitelist/blacklist用語変更 | `internal/terminal/terminal_windows.go` | ⚠️ S-2と同時編集注意 | 同パッケージのテストファイル(S-2)との整合確認推奨。ただしコメントのみ変更なのでコンフリクトリスクは低い |

### 並列作業ガイド

```
グループA（独立して並列可能）:
  I-1: command.go コメント修正
  S-1: hide_window_windows.go godoc修正
  S-4: .gitattributes バイナリ指定

グループB（同パッケージ・要調整）:
  S-2: テストケース追加 (terminal テスト)
  S-5: コメント用語変更 (terminal 本体)
  → 同パッケージだが編集ファイルは別（test vs 本体）なので並列可能。
     ただし同一PRでの整合性確認を推奨。

単独:
  S-3: コミットメッセージ（コード変更なし）
```

**結論: 全タスクが並列作業可能**。全てコメント・テスト・設定の変更であり、本番ロジックへの影響がないため、同時修正してもコンフリクトや副作用のリスクはありません。
