# PR Review Summary — 2026-02-15 13:30

## レビュー対象

`hideWindow` 関数群を共通パッケージ `internal/procutil` に集約するリファクタリング。
加えて、`shouldUseConPty()` のロジック修正、SECURITYコメント追加、エラーメッセージ改善。

### 変更ファイル一覧

| カテゴリ | ファイル | 変更種別 |
|---------|---------|---------|
| 新規パッケージ | `internal/procutil/doc.go` | 新規 |
| 新規パッケージ | `internal/procutil/hide_window_windows.go` | 新規 |
| 新規パッケージ | `internal/procutil/hide_window_other.go` | 新規 |
| 新規パッケージ | `internal/procutil/hide_window_windows_test.go` | 新規 |
| Worktree | `app_worktree_api.go` | 修正 |
| Worktree | `app_worktree_api_test.go` | 修正 |
| Worktree | `app_worktree_other.go` | 削除 |
| Worktree | `app_worktree_windows.go` | 削除 |
| Git | `internal/git/command.go` | 修正 |
| Git | `internal/git/git_other.go` | 削除 |
| Git | `internal/git/git_windows.go` | 削除 |
| Install | `internal/install/shim_path_windows.go` | 修正 |
| Install | `internal/install/shim_source_windows.go` | 修正 |
| Terminal | `internal/terminal/terminal.go` | 修正 |
| Terminal | `internal/terminal/terminal_unix.go` | 修正 |
| Terminal | `internal/terminal/terminal_windows.go` | 修正 |

---

## Critical Issues (0件)

なし。

---

## Important Issues (3件)

### I-1: [silent-failure-hunter] `readUserPathFromRegistry` が全エラーをサイレントに握りつぶし

**ファイル:** `internal/install/shim_path_windows.go` L44-48

```go
output, err := cmd.CombinedOutput()
if err != nil {
    // PATH value might not exist yet.
    return "", nil
}
```

**問題:** `reg query` の失敗を `("", nil)` で返しており、「PATH値が未登録」だけでなく、レジストリアクセス拒否・`reg.exe` 未検出・タイムアウト等の全エラーを正常扱いにしている。呼び出し元の `ensurePathContains` は `err == nil` を信じて処理を続けるため、深刻なシステムエラー時に不正なPATH上書きが起きうる。

**推奨修正:**
```go
output, err := cmd.CombinedOutput()
if err != nil {
    errMsg := strings.TrimSpace(string(output))
    if strings.Contains(errMsg, "unable to find the specified registry key or value") {
        return "", nil
    }
    slog.Debug("[DEBUG-SHIM] reg query failed", "error", err, "output", errMsg)
    return "", fmt.Errorf("read user PATH from registry: %v (%s)", err, errMsg)
}
```

---

### I-2: [comment-analyzer] `terminal_unix.go` のSECURITYコメントのcross-referenceが不正確

**ファイル:** `internal/terminal/terminal_unix.go` L26

```go
// SECURITY: see startPipeMode in terminal.go for trust boundary documentation.
cmd := exec.Command(cfg.Shell, cfg.Args...)
```

**問題:** このコメントはUnixの **PTYパス** (`pty.StartWithSize`) の `exec.Command` に付与されている。しかし参照先の `startPipeMode` はpipe-modeフォールバック関数であり、PTYパスとは別のコードパス。伝えたいのは「`cfg.Shell`/`cfg.Args` は信頼された値である」こと。

**推奨修正:**
```go
// SECURITY: cfg.Shell and cfg.Args are trusted values from internal Config struct,
// populated by application code (not user input).
cmd := exec.Command(cfg.Shell, cfg.Args...)
```

---

### I-3: [comment-analyzer] `shim_source_windows.go` のSECURITYコメントの表現

**ファイル:** `internal/install/shim_source_windows.go` L33

```go
// SECURITY: "go build" args are fixed constants; workspaceRoot is verified by go.mod check above.
```

**問題:** `go.mod` チェックは「このディレクトリがGoプロジェクトであるか」の**機能的チェック**であり、セキュリティ検証ではない。`go.mod` が存在するだけでは `workspaceRoot` の安全性は保証されない。

**推奨修正:**
```go
// NOTE: "go build" args are fixed constants; workspaceRoot is validated as a Go project via go.mod check above.
```

---

## Suggestions (8件)

### S-1: [code-simplifier] `shouldUseConPty` の冗長な空文字チェック

**ファイル:** `internal/terminal/terminal_windows.go` L67-70

```go
if value == "" {
    return true
}
```

`value == ""` の場合も `default: return true` に到達するため、この `if` ブロックは削除可能。動作変更なし。

---

### S-2: [code-reviewer] `git/command.go` のコメントに実装詳細の関数名

**ファイル:** `internal/git/command.go` L52

```go
// Handles semaphore concurrency limiting, index.lock retry, and Windows procutil.HideWindow.
```

パッケージ修飾付き関数名 `procutil.HideWindow` は実装詳細。振る舞い記述「console-window suppression」の方が保守性が高い。

**推奨修正:**
```go
// Handles semaphore concurrency limiting, index.lock retry, and Windows console-window suppression.
```

---

### S-3: [comment-analyzer] `shim_path_windows.go` L44のcross-referenceコメント

**ファイル:** `internal/install/shim_path_windows.go` L44

```go
// SECURITY: see ensurePathContains for trust boundary documentation.
```

直上の関数まで8行しかなく、情報量がほぼゼロ。削除するか `// reg query args are fixed constants.` 程度に。

---

### S-4: [code-reviewer] デバッグログの `args` 出力

**ファイル:** `internal/git/command.go` L63-66

```go
slog.Debug("[DEBUG-GIT] git command completed",
    "dir", dir,
    "args", args,
    "duration_ms", time.Since(start).Milliseconds())
```

現時点ではgit argsにセンシティブ情報は含まれないが、将来リスクあり。開発フェーズなのでブロッカーではないが、コメントで判断根拠を残すか、`args[0]`（サブコマンド名のみ）のログに抑えることを検討。

---

### S-5: [code-reviewer] `procutil` non-Windows側のテスト不在

**ファイル:** `internal/procutil/hide_window_other.go`

対応する `hide_window_other_test.go` が存在しない。Windows専用アプリのため実質問題はないが、CI等で `!windows` ビルド検証する場合にカバレッジが漏れる。低優先度。

---

### S-6: [silent-failure-hunter] `shim_installer_windows.go` のハッシュファイル書き込みエラー無視

**ファイル:** `internal/install/shim_installer_windows.go` L53, L72

```go
_ = os.WriteFile(hashFile, []byte(sourceHash), 0o644)
```

ハッシュファイルはキャッシュ目的で動作に支障はないが、ディスクフル等のデバッグが困難。デバッグログの追加を推奨:
```go
if err := os.WriteFile(hashFile, []byte(sourceHash), 0o644); err != nil {
    slog.Debug("[DEBUG-SHIM] failed to write hash file", "path", hashFile, "error", err)
}
```

---

### S-7: [code-reviewer] `shouldUseConPty` の動作変更の記録

**ファイル:** `internal/terminal/terminal_windows.go` L56-75

旧実装では `GO_TMUX_ENABLE_CONPTY=0` が無視されていた（デッドコード）。新実装では `0/false/no/off` で実際にConPTYが無効化される。開発フェーズで後方互換不要だが、コミットメッセージ等で動作変更であることを明記すべき。

---

### S-8: [code-simplifier] SECURITYコメントの粒度

`exec.Command` 呼び出し6箇所中4箇所にSECURITYコメントがある。内部デスクトップアプリにしてはやや過剰。主要エントリポイント（`runGitCLI`, `startPipeMode`）の2箇所に絞り、個別の呼び出しサイトからのcross-referenceは省略する方がノイズを減らせる。

---

## Strengths（よくできている点）

| # | 内容 |
|---|------|
| 1 | **DRY原則の正しい適用**: 4箇所に散在していた完全重複コード（hideWindow系）を1パッケージに正しく集約。旧ファイル4つも完全削除済み |
| 2 | **旧実装のバグ修正**: 旧コードは `SysProcAttr` を上書きしていたが、新実装は既存フィールドを保持する防御的実装 |
| 3 | **nilガード・冪等性**: `HideWindow` は nil安全かつ冪等。防御的コーディングとして適切 |
| 4 | **テストカバレッジ**: `procutil` に4テスト、`shouldUseConPty` に26テスト。主要ロジック変更に十分なカバレッジ |
| 5 | **デッドコード修正**: `shouldUseConPty` の `GO_TMUX_ENABLE_CONPTY` switch が実際に機能するよう修正 |
| 6 | **ConPTY/HideWindow分離の正確な文書化**: ConPTYパスで `HideWindow` が不要な理由が技術的に正確に説明されている |
| 7 | **エラーメッセージ改善**: `shim_source_windows.go` で `dir=%s` 追加によりデバッグ容易性が向上 |
| 8 | **install パッケージへの HideWindow 追加**: 以前は `reg`/`go build` コマンドでコンソールがフラッシュしていたUX問題を修正 |

---

## Recommended Action

1. **Important 3件を修正** — I-1（readUserPathRegistry）、I-2（unix cross-ref）、I-3（SECURITY文言）
2. **Suggestion のうち S-1, S-2, S-3 は低コストで修正可能** — 検討の上対応
3. 残りの Suggestion は開発フェーズを考慮し任意対応
4. 修正後にレビュー再実行を推奨

---

## タスク整理・並列作業可否一覧

以下の表は、各修正タスクの並列作業可否を示します。
異なるファイルを修正するタスクは並列作業可能です。

| # | タスク | 対象ファイル | 重要度 | 並列作業 | 備考 |
|---|--------|-------------|--------|---------|------|
| T-1 | `readUserPathFromRegistry` のエラー分類修正 | `internal/install/shim_path_windows.go` | Important | ✅ 可 | 他タスクと異なるファイル・関数を修正。単独で完結 |
| T-2 | `terminal_unix.go` SECURITYコメント修正 | `internal/terminal/terminal_unix.go` | Important | ✅ 可 | コメントのみの変更。他への依存なし |
| T-3 | `shim_source_windows.go` SECURITY→NOTE文言変更 | `internal/install/shim_source_windows.go` | Important | ✅ 可 | コメントのみの変更。T-1とは別ファイル |
| T-4 | `shouldUseConPty` 空文字チェック削除 | `internal/terminal/terminal_windows.go` | Suggestion | ✅ 可 | T-2とは別ファイル。ロジック変更だがテスト済み |
| T-5 | `command.go` コメントの関数名→振る舞い記述 | `internal/git/command.go` | Suggestion | ✅ 可 | コメントのみの変更。単独で完結 |
| T-6 | `shim_path_windows.go` L44 cross-refコメント簡略化 | `internal/install/shim_path_windows.go` | Suggestion | ⚠️ T-1と同一ファイル | T-1と同じファイルを修正。T-1と**順次作業**推奨 |
| T-7 | `shim_installer_windows.go` ハッシュ書込みログ追加 | `internal/install/shim_installer_windows.go` | Suggestion | ✅ 可 | T-1, T-3とは別ファイル |
| T-8 | `shouldUseConPty` 動作変更のコミットメッセージ記載 | コミットメッセージ | Suggestion | ✅ 可 | コード変更なし。ドキュメント作業 |

### 並列作業グループ

```
グループA（並列実行可能）: T-1 + T-6（同一ファイルなので順次）
グループB（並列実行可能）: T-2
グループC（並列実行可能）: T-3
グループD（並列実行可能）: T-4
グループE（並列実行可能）: T-5
グループF（並列実行可能）: T-7
グループG（並列実行可能）: T-8

→ グループ A, B, C, D, E, F, G は全て同時に着手可能
→ グループA内のT-1とT-6のみ順次実行（同一ファイル競合回避）
```

### 作業者への補足

- **T-1 が最優先**: `readUserPathFromRegistry` のサイレント障害は実害の可能性あり
- **T-2, T-3 はコメントのみ**: 低リスクで即座に修正可能
- **T-4 はテスト済み**: `shouldUseConPty` の26件のテーブル駆動テストが存在するため、変更後のリグレッション確認が容易
- **T-7 は差分ファイル外**: 今回のPRの直接的な変更範囲外だが、同パッケージ内の関連問題として指摘
- **全タスク完了後**: `go build ./...` と `go test ./internal/...` で回帰確認推奨
