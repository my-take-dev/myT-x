# PR Review Summary — 2026-02-15 14:02

## 変更概要

`hideWindow` / `hideWindowForSetup` の重複実装（4箇所以上）を共通パッケージ `internal/procutil` へ集約するリファクタリング。
加えて、エラー処理改善、SECURITYコメント追加、ロケール対応、テストカバレッジ拡充を含む。

### 変更ファイル一覧

| カテゴリ | ファイル | 状態 |
|---------|--------|------|
| **procutil（新規）** | `internal/procutil/doc.go` | NEW |
| | `internal/procutil/hide_window_other.go` | NEW |
| | `internal/procutil/hide_window_windows.go` | NEW |
| | `internal/procutil/hide_window_windows_test.go` | NEW |
| **terminal** | `internal/terminal/terminal.go` | MODIFIED |
| | `internal/terminal/terminal_unix.go` | MODIFIED |
| | `internal/terminal/terminal_windows.go` | MODIFIED |
| | `internal/terminal/should_use_conpty_windows_test.go` | NEW |
| **git** | `internal/git/command.go` | MODIFIED |
| | `internal/git/git_test.go` | MODIFIED |
| | `internal/git/git_other.go` | DELETED |
| | `internal/git/git_windows.go` | DELETED |
| **install** | `internal/install/shim_installer_windows.go` | MODIFIED |
| | `internal/install/shim_path_windows.go` | MODIFIED |
| | `internal/install/shim_source_windows.go` | MODIFIED |
| **worktree API** | `app_worktree_api.go` | MODIFIED |
| | `app_worktree_api_test.go` | MODIFIED |
| | `app_worktree_other.go` | DELETED |
| | `app_worktree_windows.go` | DELETED |

---

## Critical Issues (0件)

なし。

---

## Important Issues (2件)

### I-1. 非英語ロケールでのレジストリエラー処理が既存PATH消失リスクを持つ

**ファイル**: `internal/install/shim_path_windows.go` (`readUserPathFromRegistry` 関数)

**内容**: `reg query` で非英語ロケールのエラーメッセージが判別できない場合、全てのエラーを `("", nil)` として返却する。コメントには「後続の `reg add` で失敗をキャッチする」と記載があるが、 `ensurePathContains` は `readUserPathFromRegistry` の結果を使って既存PATHに追記するため、**アクセス拒否などの真のエラー時に既存PATHを空文字として扱い、`reg add` の `/d` に `installDir` のみを渡して既存PATH項目を上書きしてしまう可能性がある**。

```go
// 現在の実装（問題箇所）
slog.Warn("[DEBUG-SHIM] reg query returned unexpected error (treating as empty PATH)",
    "error", err, "output", errMsg)
return "", nil  // ← この空文字が ensurePathContains で既存PATHの上書きに使われる
```

**推奨対応**:
- `readUserPathFromRegistry` がエラーを返せなかった場合、`ensurePathContains` 側で空PATHに対するガードを入れる
- もしくは、`golang.org/x/sys/windows/registry` パッケージ（既に依存内）を使ってレジストリAPIを直接呼び、テキスト解析を回避する

---

### I-2. ConPTY起動失敗時のログ出力が無い

**ファイル**: `internal/terminal/terminal_windows.go` (L41-43)

**内容**: `startConPty` が失敗した場合、サイレントにパイプモードへフォールスルーしている。ConPTYが利用可能と判断されたにもかかわらず起動に失敗したケースは、デバッグのためにログ出力すべき。

```go
cpty, err := startConPty(cmdLine, opts...)
if err == nil {
    // ...成功パス
}
// ← ここにログが無い
return startPipeMode(cfg)
```

**推奨対応**: `slog.Warn("[DEBUG-TERMINAL] ConPTY start failed, falling back to pipe mode", "error", err)` を追加。

---

## Suggestions (11件)

### S-1. テストのcleanupが本番コードを複製している

**ファイル**: `app_worktree_api_test.go` (TestRunSetupScripts内)

**内容**: `executeSetupCommandFn` のリストア処理で、本番のクロージャを丸ごと複製して設定し直している。本番コードが変更された場合に追従漏れリスクあり。

**推奨**: save-and-restore パターンへ変更:
```go
origExecute := executeSetupCommandFn
origEmit := runtimeEventsEmitFn
t.Cleanup(func() {
    executeSetupCommandFn = origExecute
    runtimeEventsEmitFn = origEmit
})
```

---

### S-2. `createBareAndClone` にも `filepath.EvalSymlinks` を追加すべき

**ファイル**: `internal/git/git_test.go` (`createBareAndClone` 関数)

**内容**: `createTempGitRepo` にはWindows 8.3短縮パス対策が追加されたが、`createBareAndClone` には未適用。将来テスト追加時にflakinessを生む可能性がある。

```go
bareDir = t.TempDir()
if resolved, err := filepath.EvalSymlinks(bareDir); err == nil {
    bareDir = resolved
}
// cloneDir にも同様
```

---

### S-3. SECURITYコメントとNOTEコメントの統一

**ファイル**: `internal/install/shim_source_windows.go` (L32)

**内容**: `go build` のコマンド引数が固定値であることを `// NOTE:` で記載しているが、同パターンの `shim_path_windows.go` では `// SECURITY:` を使用。外部プロセス実行に対するコメントは `// SECURITY:` に統一すべき。

---

### S-4. `shouldUseConPty` のdocコメント表現の改善

**ファイル**: `internal/terminal/terminal_windows.go` (L53-63)

**内容**: `GO_TMUX_ENABLE_CONPTY` を「opt-out enabling」と記述しているが、「opt-out disabling」の方が実際のロジックに正確。混乱を避ける表現を推奨:
```
//   - GO_TMUX_ENABLE_CONPTY: only "0/false/no/off" explicitly disables.
//     Any other value (including unset, empty, unrecognized) keeps ConPTY enabled.
```

---

### S-5. `slog.Warn` に `[DEBUG-` プレフィックスの混在

**ファイル**: `internal/install/shim_path_windows.go` (L61)

**内容**: `slog.Warn` レベルで `[DEBUG-SHIM]` プレフィックスを使用。開発中のため意図的ではあるが、プレフィックスの命名としてWarnレベルに `DEBUG` は紛らわしい。

---

### S-6. `readUserPathFromRegistry` の行パースロジックのテスト不足

**ファイル**: `internal/install/shim_path_windows.go`

**内容**: `reg query` の出力パースロジック（`strings.Fields` → `strings.Join(parts[2:], " ")`）に対するユニットテストがない。スペースを含むPATH値で誤動作しないか検証するテーブル駆動テストの追加を推奨。

---

### S-7. `matchesHashFile` / `sha256Hex` / `sha256HexFile` のテスト不足

**ファイル**: `internal/install/shim_installer_windows.go`

**内容**: shimスキップ判定に使われるハッシュ関連ヘルパーのユニットテストがない。ハッシュ一致/不一致/ファイル不在の各ケースのテスト追加を推奨。

---

### S-8. `runGitCLI` のリトライデバッグログに attempt 番号がない

**ファイル**: `internal/git/command.go`

**内容**: index.lockリトライ発生時、「何回目で成功したか」をログから読み取れない。リトライ時のログにattempt番号を追加するとデバッグ効率が向上する。

---

### S-9. `runSetupScripts` の空白スクリプト skip のテスト未作成

**ファイル**: `app_worktree_api.go` / `app_worktree_api_test.go`

**内容**: `strings.TrimSpace(script) == ""` で `continue` するパスのテストケースがない。`["echo one", "  ", "echo two"]` のようなケースで空白スクリプトが正しくスキップされることを検証すべき。

---

### S-10. `findShimSource` で `os.Executable()` エラー時の条件分岐改善

**ファイル**: `internal/install/shim_source_windows.go` (L16-22)

**内容**: `os.Executable()` がエラーを返しつつ空でない `exePath` を返す可能性はほぼないが、意図を明確にするためエラー時は `exePath` を使わない方がよい:
```go
if exeErr == nil && exePath != "" {
```

---

### S-11. `CreateSessionWithExistingWorktree` のブランチ検出エラー時の意図コメント

**ファイル**: `app_worktree_api.go` (L522-531)

**内容**: `err != nil` の場合に戻り値 `branchName` を参照する分岐は Go の慣習では非推奨だが、意図的設計。コメントで「エラーがあっても空文字以外の branchName が返った場合は意味のあるエラーとして扱う」旨を記載すると可読性向上。

---

## Strengths（良い点）

1. **DRY原則の適切な適用**: 4箇所以上に散在していた `hideWindow` を `procutil` に集約。単一責任原則にも準拠
2. **防御的コーディング**: `procutil.HideWindow` の nil ガード、既存 `SysProcAttr` 保持、冪等性
3. **テストカバレッジ**: `procutil` テスト4ケース + `shouldUseConPty` テスト30ケースで網羅的
4. **セキュリティ文書化**: 全 `exec.Command` 箇所にSECURITY/NOTEコメントで引数の信頼性を明示
5. **エラー可視化**: `_ = os.WriteFile(...)` パターンを `slog.Debug` + エラーチェックに改善
6. **行動リグレッションなし**: OVERWRITE→PRESERVE の変更は全呼び出し箇所で安全（テスト検証済み）
7. **ビルド確認**: `go vet` パス、全テストPASS
8. **新規外部依存なし**: procutil は stdlib のみ使用

---

## タスク修正の並列作業可否一覧

作業者が効率的に修正できるよう、各指摘項目の並列作業可否を整理しました。

| # | 種別 | 対象ファイル | 修正内容 | 並列作業 | 備考 |
|---|------|------------|---------|:-------:|------|
| I-1 | Important | `shim_path_windows.go` | 非英語ロケール時の空PATH上書き防止ガード | ✅ 可 | 他タスクと独立。`ensurePathContains` 側のガード追加 or registry API直接呼出へ変更 |
| I-2 | Important | `terminal_windows.go` | ConPTY失敗時のログ追加（1行） | ✅ 可 | `slog.Warn` 1行追加のみ |
| S-1 | Suggestion | `app_worktree_api_test.go` | cleanup の save-restore パターン化 | ✅ 可 | テストコードのみ変更 |
| S-2 | Suggestion | `git_test.go` | `createBareAndClone` に EvalSymlinks 追加 | ✅ 可 | テストヘルパーのみ変更 |
| S-3 | Suggestion | `shim_source_windows.go` | `NOTE:` → `SECURITY:` へ変更 | ✅ 可 | コメント変更のみ |
| S-4 | Suggestion | `terminal_windows.go` | docコメント表現修正 | ⚠️ I-2と同ファイル | I-2 と同時作業する場合はマージ注意 |
| S-5 | Suggestion | `shim_path_windows.go` | Warnログプレフィックス修正 | ⚠️ I-1と同ファイル | I-1 と同時作業する場合はマージ注意 |
| S-6 | Suggestion | `shim_path_windows.go` + テスト新規 | PATH パースロジックのテスト追加 | ⚠️ I-1と同ファイル | I-1 とテスト追加は並列可。パース関数分離が必要なら順次 |
| S-7 | Suggestion | `shim_installer_windows.go` + テスト新規 | ハッシュヘルパーテスト追加 | ✅ 可 | 新規テストファイル作成のみ |
| S-8 | Suggestion | `command.go` | リトライログに attempt 番号追加 | ✅ 可 | 1行変更のみ |
| S-9 | Suggestion | `app_worktree_api_test.go` | 空白スクリプトskipテスト追加 | ⚠️ S-1と同ファイル | S-1 と同時作業する場合はマージ注意 |
| S-10 | Suggestion | `shim_source_windows.go` | `os.Executable` エラー条件分岐改善 | ⚠️ S-3と同ファイル | S-3 と同時作業する場合はマージ注意 |
| S-11 | Suggestion | `app_worktree_api.go` | ブランチ検出意図コメント追加 | ✅ 可 | コメント追加のみ |

### 並列作業グループ推奨

効率的に作業するための推奨グルーピング：

| グループ | タスク | 対象ファイル | 理由 |
|---------|--------|------------|------|
| **A** | I-1, S-5, S-6 | `shim_path_windows.go` | 同一ファイルなので順次作業 |
| **B** | I-2, S-4 | `terminal_windows.go` | 同一ファイルなので順次作業 |
| **C** | S-1, S-9 | `app_worktree_api_test.go` | 同一ファイルなので順次作業 |
| **D** | S-3, S-10 | `shim_source_windows.go` | 同一ファイルなので順次作業 |
| **E** | S-2 | `git_test.go` | 独立 |
| **F** | S-7 | `shim_installer_windows.go` + 新規テスト | 独立 |
| **G** | S-8 | `command.go` | 独立 |
| **H** | S-11 | `app_worktree_api.go` | 独立 |

**グループ A〜D は各グループ内で順次作業、グループ A/B/C/D/E/F/G/H 間は全て並列作業可能。**

---

## Recommended Action

1. **Important 2件を優先修正**（I-1: PATH上書きリスク、I-2: ConPTYログ欠如）
2. Suggestion は優先度順に: S-1 > S-2 > S-3 > S-6 > S-7 > 残り
3. 修正後にテスト再実行で確認
