# PR Review Summary — 2026-02-15 14:31

## 対象

`myT-x/` 配下の未コミット変更（16ファイル、+210/-75行）

### 変更概要

1. **`hideWindow` → `procutil.HideWindow` リファクタリング**: git, terminal, app各パッケージに散在していたプラットフォーム固有 `hideWindow`/`hideWindowForSetup` 関数を共通 `internal/procutil` パッケージに集約。4ファイル削除。
2. **install パッケージのエラーハンドリング強化**: hashファイル書き込みエラーのログ出力、非英語ロケール対応の `readUserPathFromRegistry` リファクタリング、`findShimSource` の `os.Executable()` エラーチェック追加。
3. **ConPTY 環境変数ロジック変更**: `GO_TMUX_ENABLE_CONPTY` をopt-in（有効値のみ有効）からopt-out（無効値のみ無効）に変更。両環境変数ともデフォルト有効方向に統一。
4. **テスト改善**: Windows 8.3短縮パス対応（EvalSymlinks）、新規テストケース追加、cleanup パターン改善。
5. **SECURITY コメント追加**: `exec.Command` 呼び出し箇所に、引数がアプリケーション構築値であることを明記。

### レビュー体制

5つの専門レビューエージェントが並列でレビューを実施:

| エージェント | 担当領域 |
|---|---|
| **code-reviewer** | App layer（worktree/session API + テスト） |
| **code-reviewer-git** | Git + procutil layer |
| **security-engineer** | セキュリティ + 副作用 + リグレッション |
| **pr-test-analyzer** | テストカバレッジ品質 |
| **code-simplifier** | コード簡素化・DRY |

---

## Critical Issues (1件)

### C-1. `readUserPathFromRegistry` のエラー分岐テストが完全不在
- **エージェント**: pr-test-analyzer
- **ファイル**: [shim_path_windows.go](myT-x/internal/install/shim_path_windows.go#L45-L65)
- **説明**: `readUserPathFromRegistry` は非英語ロケール対応として大幅にリファクタリングされた。英語ロケールの `"unable to find"` メッセージ → `("", nil)` 返却、それ以外 → `error` 返却の分岐が追加されたが、テストが一切存在しない。
- **リスク**: 非英語Windows（日本語環境含む）で初回shimインストール失敗の可能性がある。PATHレジストリ値未存在時に `reg query` が非英語エラーメッセージを返すケースがテストされていない。
- **対策**: `readUserPathFromRegistry` のエラー分岐ロジックを単体テスト可能な形に分離し、テーブル駆動テストを追加。あるいはレジストリ呼び出し部分を `golang.org/x/sys/windows/registry` パッケージに移行して `reg.exe` 依存を排除。

---

## Important Issues (6件)

### I-1. `TestParseRegQueryOutput` に `REG_SZ` 型テストケース不足
- **エージェント**: code-reviewer-install
- **ファイル**: [shim_installer_windows_test.go](myT-x/internal/install/shim_installer_windows_test.go#L88-L143)
- **説明**: テストは `REG_EXPAND_SZ` のみをカバー。手動設定等で `REG_SZ` 型の場合もある。実装は対応しているがテストで網羅されていない。
- **対策**: `REG_SZ` 型のテストケースを追加。

### I-2. `startPipeMode` の StdinPipe/StdoutPipe/StderrPipe リソースリーク
- **エージェント**: code-reviewer-terminal
- **ファイル**: [terminal.go](myT-x/internal/terminal/terminal.go#L58-L74)
- **説明**: `StdinPipe()` 成功後に `StdoutPipe()` や `StderrPipe()` が失敗した場合、先に確保したパイプがクリーンアップされない。
- **対策**: 後続パイプ取得失敗時に先行パイプを明示的に `Close()` する。

### I-3. `findShimSource` のテスト不在
- **エージェント**: pr-test-analyzer
- **ファイル**: [shim_source_windows.go](myT-x/internal/install/shim_source_windows.go#L18-L44)
- **説明**: `exeErr` チェック追加は正しいが、`findShimSource` 自体のテストが一切存在しない。`os.Executable()` 失敗パス、`workspaceRoot` 空の場合、`go.mod` 不在の場合のフォールバック等が未テスト。
- **対策**: DI可能な設計に変更し、ユニットテストを追加。

### I-4. `startPipeMode` で `procutil.HideWindow` が呼ばれていることの検証不足
- **エージェント**: pr-test-analyzer
- **ファイル**: [terminal.go](myT-x/internal/terminal/terminal.go#L62)
- **説明**: `procutil.HideWindow` 自体のテストは存在するが、`startPipeMode` で実際に呼ばれていることを検証するテストがない。
- **対策**: pipe mode テストで `cmd.SysProcAttr.HideWindow == true` のアサーション追加。

### I-5. ログレベルとプレフィックスの不一致
- **エージェント**: code-reviewer-install
- **ファイル**: [shim_path_windows.go](myT-x/internal/install/shim_path_windows.go#L55)
- **説明**: `slog.Warn` を使用しているがプレフィックスは `[DEBUG-SHIM]`。デバッグ目的なら `slog.Debug` に統一、または `Warn` が適切ならプレフィックスを `[WARN-SHIM]` に変更すべき。
- **対策**: ログレベルとプレフィックスを統一する。

### I-6. `conpty_windows.go` の `startupInfoEx.Cb` サイズ計算の可読性
- **エージェント**: code-reviewer-terminal
- **ファイル**: [conpty_windows.go](myT-x/internal/terminal/conpty_windows.go#L101)
- **説明**: `unsafe.Sizeof(windows.StartupInfo{}) + unsafe.Sizeof((*byte)(nil))` は STARTUPINFOEXW のサイズとして正しいが、意図がわかりにくい。
- **対策**: コメント `// STARTUPINFOEXW = STARTUPINFOW + lpAttributeList pointer` を追加。

---

## Suggestions (14件)

### S-1. `createTempGitRepo` + `skipIfNoGit` がパッケージ間で完全重複
- **エージェント**: code-simplifier
- **ファイル**: [app_session_api_test.go](myT-x/app_session_api_test.go#L227-L260) / [git_test.go](myT-x/internal/git/git_test.go#L19-L50)
- **説明**: EvalSymlinks対応を含めて完全に同一のコード。修正時に同期が必要。
- **対策**: `internal/testutil` パッケージに共通ヘルパーとして切り出す。

### S-2. EvalSymlinks パターンが6箇所に散在
- **エージェント**: code-simplifier, code-reviewer
- **ファイル**: テスト全体（6箇所）
- **説明**: 同一の3行パターンが繰り返されている。
- **対策**: `resolveSymlinks(path string) string` テストヘルパー関数を作成。

### S-3. テスト内の `runtimeEventsEmitFn` 復元パターン不統一
- **エージェント**: code-reviewer, pr-test-analyzer
- **ファイル**: [app_worktree_api_test.go](myT-x/app_worktree_api_test.go) / [app_session_api_test.go](myT-x/app_session_api_test.go)
- **説明**: save/restore パターン（良い）と直接 `runtime.EventsEmit` リストア（wails依存）が混在。
- **対策**: save/restore パターンに統一し、wails runtime import の除去を目指す。

### S-4. `TestParseRegQueryOutput` にタブ区切り出力テスト追加
- **エージェント**: code-reviewer-install
- **ファイル**: [shim_installer_windows_test.go](myT-x/internal/install/shim_installer_windows_test.go#L88-L143)
- **説明**: `reg query` がタブ区切りで出力するケースのテストが無い。
- **対策**: タブ区切りテストケースを追加。

### S-5. `TestParseRegQueryOutput` に非ASCII（日本語等）パスのテスト追加
- **エージェント**: pr-test-analyzer
- **ファイル**: [shim_installer_windows_test.go](myT-x/internal/install/shim_installer_windows_test.go#L88-L143)
- **説明**: 非英語ロケール対応が変更動機だが、非ASCIIパスのテストが無い。
- **対策**: `C:\ユーザー\テスト\bin` 等のケースを追加。

### S-6. `EnsureShimInstalled` の embedded/file-based 分岐でhash+write ロジック重複
- **エージェント**: code-simplifier
- **ファイル**: [shim_installer_windows.go](myT-x/internal/install/shim_installer_windows.go#L29-L69)
- **説明**: hash計算→比較→書込→hashファイル更新のパターンが2つの分岐で重複。
- **対策**: `installShimIfChanged` 等の共通関数に抽出。

### S-7. `parseRegQueryOutput` の定数に対する不要な `ToLower` 呼出
- **エージェント**: code-simplifier
- **ファイル**: [shim_path_windows.go](myT-x/internal/install/shim_path_windows.go#L57-L64)
- **説明**: `pathValueName` は定数 `"Path"` だが、毎回 `strings.ToLower(pathValueName)` を呼んでいる。
- **対策**: `strings.HasPrefix(strings.ToLower(line), "path")` と直接記述。

### S-8. `HasUnpushedCommits` の upstream エラー飲み込み範囲
- **エージェント**: code-reviewer-git
- **ファイル**: [git.go](myT-x/internal/git/git.go#L107-L113)
- **説明**: upstream がない場合の `false, nil` は仕様通りだが、ディスクI/Oエラー等の別種エラーも同様に無視される。
- **対策**: エラーメッセージに upstream 関連キーワードが含まれるか判定して分岐。

### S-9. `isIndexLockError` のユニットテスト不足
- **エージェント**: code-reviewer-git
- **ファイル**: [command.go](myT-x/internal/git/command.go#L46-L49)
- **説明**: リトライロジックの要だがテストが無い。
- **対策**: テーブル駆動テストを追加。

### S-10. `buildCommandLine` のユニットテスト不在
- **エージェント**: code-reviewer-terminal
- **ファイル**: [terminal_windows.go](myT-x/internal/terminal/terminal_windows.go#L70-L82)
- **説明**: スペースを含むパスの処理を `syscall.EscapeArg` に委譲しているがテストが無い。
- **対策**: テストケース追加。

### S-11. `TestCopyConfigFilesToWorktree` で EvalSymlinks 未使用
- **エージェント**: pr-test-analyzer
- **ファイル**: [app_worktree_api_test.go](myT-x/app_worktree_api_test.go#L97-L181)
- **説明**: git出力との比較が無いため実害は少ないが、一貫性の観点。
- **対策**: 必要に応じてEvalSymlinks追加。

### S-12. `ConPty.Close()` のプロセス終了順序
- **エージェント**: code-reviewer-terminal
- **ファイル**: [conpty_windows.go](myT-x/internal/terminal/conpty_windows.go#L127-L152)
- **説明**: `closePseudoConsole` 後の自然終了待機 → `TerminateProcess` の順があるとクリーン。
- **対策**: `WaitForSingleObject` でブリーフに待機後 `TerminateProcess`。

### S-13. `createEnvBlock` の空文字列環境変数フィルタリング
- **エージェント**: code-reviewer-terminal
- **ファイル**: [conpty_syscall_windows.go](myT-x/internal/terminal/conpty_syscall_windows.go#L92-L101)
- **説明**: `env` に空文字列が含まれた場合、ヌル文字エントリでブロック終端と誤認される可能性。
- **対策**: 空文字列をフィルタリング。

### S-14. `FindAvailableWorktreePath` の `os.Stat` エラー種別無視
- **エージェント**: code-reviewer-git
- **ファイル**: [validation.go](myT-x/internal/git/validation.go#L77-L80)
- **説明**: 権限不足等の `IsNotExist` 以外のエラーも「存在する」として扱われる。
- **対策**: 権限エラー等をログ出力。

---

## Strengths（良い点）

1. **`procutil.HideWindow` の統一**: プラットフォーム固有ロジックが適切に `internal/procutil` に集約され、重複が排除された。nilガード、既存属性保持、冪等性が全てテスト済み。
2. **安全側に倒した非英語ロケール対応**: `readUserPathFromRegistry` がエラー時にサイレント無視ではなくエラーを返すことで、既存PATHの上書き（データ損失）を防止。
3. **SECURITYコメントによる監査容易性**: `exec.Command` の呼び出し箇所が引数の出所を明記しており、セキュリティ監査が容易。
4. **`shouldUseConPty` テストの網羅性**: 31パターンのテーブル駆動テストで環境変数のあらゆる組み合わせをカバー。
5. **Windows 8.3パス問題の体系的修正**: EvalSymlinks が全テストヘルパーに一貫して適用。
6. **テストの cleanup パターン改善**: save/restore パターンへの移行で wails 依存を削減。
7. **`findShimSource` の `exeErr` チェック**: 以前はエラーを無視して空パスを操作する可能性があったバグが修正。

---

## Recommended Action

### 即対応（コミット前）

| 優先度 | 項目 | 工数 |
|---|---|---|
| **Critical** | C-1: `readUserPathFromRegistry` エラー分岐テスト追加 | 中 |
| **Important** | I-1: `TestParseRegQueryOutput` に REG_SZ テストケース追加 | 小 |
| **Important** | I-5: ログレベルとプレフィックスの統一 | 小 |

### 後続対応（コミット後可）

| 優先度 | 項目 | 工数 |
|---|---|---|
| **Important** | I-2: `startPipeMode` パイプリソースリーク修正 | 小 |
| **Important** | I-3: `findShimSource` テスト追加 | 中 |
| **Important** | I-4: `startPipeMode` HideWindow 検証テスト | 小 |
| **Important** | I-6: `Cb` サイズ計算コメント追加 | 小 |
| **Suggestion** | S-1〜S-14 | 各 小〜中 |

---

## タスク修正並列作業可否表

以下の表は各修正タスクを並列に実施できるかを示しています。「並列OK」のタスク同士は独立しており、同時に作業しても互いに競合しません。「依存あり」のタスクは、他のタスクの完了を待つ必要があります。

| # | タスク | 対象ファイル | 並列OK | 依存・競合する項目 | 備考 |
|---|-------|------------|--------|-------------------|------|
| C-1 | `readUserPathFromRegistry` テスト追加 | `shim_path_windows.go`, `shim_installer_windows_test.go` | ✅ 並列OK | なし | テスト関数の追加のみ。I-1と同一テストファイルだが追加するテスト関数名が異なるため競合なし |
| I-1 | `TestParseRegQueryOutput` REG_SZ ケース追加 | `shim_installer_windows_test.go` | ✅ 並列OK | C-1と同一ファイルだが競合箇所が異なる | 既存テーブルにケース追加のみ |
| I-2 | `startPipeMode` パイプリソースリーク修正 | `terminal.go` | ✅ 並列OK | なし | terminal パッケージのみ変更 |
| I-3 | `findShimSource` テスト追加 | `shim_source_windows.go`, `shim_source_windows_test.go`(新規) | ✅ 並列OK | なし | install パッケージだが他タスクと異なるファイル |
| I-4 | `startPipeMode` HideWindow 検証テスト | `terminal_windows_test.go` | ⚠️ 要注意 | I-2 完了後が望ましい | I-2のリーク修正後にテスト追加した方が無駄がない |
| I-5 | ログレベルとプレフィックス統一 | `shim_path_windows.go` | ✅ 並列OK | C-1と同一ファイルだがログ出力行のみ変更 | 1行変更のみ |
| I-6 | `Cb` サイズ計算コメント追加 | `conpty_windows.go` | ✅ 並列OK | なし | コメント追加のみ |
| S-1 | `createTempGitRepo` 重複排除 | `app_session_api_test.go`, `git_test.go`, 新規 `testutil/` | ⚠️ 要注意 | S-2 と密接に関連 | S-2のEvalSymlinksヘルパーと合わせて実施が効率的 |
| S-2 | EvalSymlinks ヘルパー関数化 | テスト全体（6箇所） | ⚠️ 要注意 | S-1 と密接に関連 | S-1と同時に作業すると `testutil` パッケージ設計で競合 |
| S-3 | `runtimeEventsEmitFn` 復元パターン統一 | `app_session_api_test.go` 等 | ✅ 並列OK | なし | テストの cleanup セクションのみ変更 |
| S-4 | `TestParseRegQueryOutput` タブ区切りテスト | `shim_installer_windows_test.go` | ⚠️ 要注意 | C-1, I-1 と同一ファイル | 同一テーブルへの追加。個別の行追加なら並列可。同時マージ時に注意 |
| S-5 | `TestParseRegQueryOutput` 非ASCIIテスト | `shim_installer_windows_test.go` | ⚠️ 要注意 | S-4 と同一テーブル | S-4 と合わせて実施推奨 |
| S-6 | `EnsureShimInstalled` hash+write 共通化 | `shim_installer_windows.go` | ✅ 並列OK | なし | 本体コードのリファクタリング |
| S-7 | `parseRegQueryOutput` ToLower 不要除去 | `shim_path_windows.go` | ✅ 並列OK | なし | 1行修正 |
| S-8 | `HasUnpushedCommits` エラー分類改善 | `git.go` | ✅ 並列OK | なし | git パッケージのみ。他タスクと独立 |
| S-9 | `isIndexLockError` テスト追加 | `command_test.go`(新規 or 既存) | ✅ 並列OK | なし | 新規テスト関数の追加 |
| S-10 | `buildCommandLine` テスト追加 | `terminal_windows_test.go` | ✅ 並列OK | I-4 と同一ファイルだが別テスト関数 | 新規テスト関数の追加 |
| S-11 | `TestCopyConfigFilesToWorktree` EvalSymlinks | `app_worktree_api_test.go` | ✅ 並列OK | なし | 最小変更 |
| S-12 | `ConPty.Close()` 終了順序改善 | `conpty_windows.go` | ✅ 並列OK | I-6 と同一ファイルだが異なる関数 | 実装変更 |
| S-13 | `createEnvBlock` 空文字列フィルタ | `conpty_syscall_windows.go` | ✅ 並列OK | なし | 独立したファイル |
| S-14 | `FindAvailableWorktreePath` Stat エラーログ | `validation.go` | ✅ 並列OK | なし | 独立したファイル |

### 推奨作業グルーピング

並列効率を最大化するため、以下のグループに分けて作業することを推奨します:

| グループ | タスク | 理由 |
|---------|--------|------|
| **Group A: install テスト** | C-1 + I-1 + S-4 + S-5 | 同一テストファイル・テーブルを操作。順次実施が安全 |
| **Group B: install 本体** | I-5 + S-6 + S-7 | install パッケージの本体コード修正。それぞれ独立だが同一パッケージ |
| **Group C: terminal** | I-2 → I-4 + I-6 + S-10 + S-12 | terminal パッケージ。I-2 完了後に I-4 実施 |
| **Group D: テストヘルパー統一** | S-1 + S-2 | 密接に関連するためセットで実施 |
| **Group E: 独立タスク** | I-3, S-3, S-8, S-9, S-11, S-13, S-14 | 各々完全に独立。並列実施可能 |

**Group A〜E は互いに並列で作業可能です。**

---

*レビュー実施: 5 並列レビューエージェント（code-reviewer, code-reviewer-git, security-engineer, pr-test-analyzer, code-simplifier）*
