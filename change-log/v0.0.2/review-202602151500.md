# PR Review Summary — 2026-02-15 15:00

## レビュー対象

myT-x 配下のコミット前変更ファイル（5カテゴリ、22ファイル変更 + 8ファイル新規）

### カテゴリ別対象ファイル

| カテゴリ | 変更ファイル | 新規ファイル |
|---------|------------|------------|
| **A: internal/git/** | command.go, git.go, git_test.go, validation.go, worktree_test.go, ~~git_other.go~~(削除), ~~git_windows.go~~(削除) | command_test.go |
| **B: internal/install/** | shim_installer_windows.go, shim_installer_windows_test.go, shim_path_windows.go, shim_source_windows.go | shim_source_windows_test.go |
| **C: internal/terminal/** | conpty_syscall_windows.go, conpty_windows.go, terminal.go, terminal_unix.go, terminal_windows.go, terminal_windows_test.go | should_use_conpty_windows_test.go |
| **D: App層** | app_session_api_test.go, app_worktree_api.go, app_worktree_api_test.go, ~~app_worktree_other.go~~(削除), ~~app_worktree_windows.go~~(削除) | — |
| **E: internal/procutil/** (新規パッケージ) | — | doc.go, hide_window_other.go, hide_window_windows.go, hide_window_windows_test.go |
| **F: internal/testutil/** (新規パッケージ) | — | git.go |

---

## Critical Issues（2件）

### C-1: `isRegValueNotFoundError("")` が空出力を「値が見つからない」と判定 — PATH喪失リスク

**ファイル**: [internal/install/shim_path_windows.go](myT-x/internal/install/shim_path_windows.go#L48-L50)

```go
func isRegValueNotFoundError(errMsg string) bool {
    return strings.Contains(strings.ToLower(errMsg), "unable to find") || errMsg == ""
}
```

**問題**: `reg.exe` が実行不能（PATHにSystem32が無い等）の場合、`cmd.CombinedOutput()` は `err != nil` かつ出力が空文字となる。`isRegValueNotFoundError("")` が `true` を返し、`readUserPathFromRegistry()` は `"", nil` を返す。結果、`ensurePathContains()` で `reg add` が `installDir` のみをPATH値として書き込み、**ユーザーPATH全体が上書きされる**リスクがある。

**修正案**: 空文字列を genuine error として扱う:
```go
func isRegValueNotFoundError(errMsg string) bool {
    if errMsg == "" {
        return false // no output with error → cannot distinguish from genuine error
    }
    return strings.Contains(strings.ToLower(errMsg), "unable to find")
}
```

`readUserPathFromRegistry()` で `errMsg == ""` を別途安全にハンドリングする。テスト `TestIsRegValueNotFoundError` の `"empty output"` ケースの `want` も `false` に修正が必要。

---

### C-2: `ConPty.Close()` のパイプ閉鎖とプロセス待機の順序が逆

**ファイル**: [internal/terminal/conpty_windows.go](myT-x/internal/terminal/conpty_windows.go#L237-L277)

**問題**: 現在の `Close()` は以下の順序で実行される:
1. `closePseudoConsole(hpCon)` — コンソール切断
2. **パイプ全閉鎖** (`ptyIn`, `ptyOut`, `cmdIn`, `cmdOut`)
3. `WaitForSingleObject` — プロセスの終了待ち
4. `TerminateProcess` — タイムアウト時の強制終了

子プロセスがパイプに書き込み中（stdout flush等）にパイプが先に閉じられると、子プロセスで書き込みエラーが発生し、グレースフルシャットダウンが期待通りに動作しない可能性がある。

**推奨順序**:
```
closePseudoConsole → WaitForSingleObject → TerminateProcess → ハンドル閉鎖 → パイプ閉鎖
```

プロセス待機/終了 を パイプ閉鎖の**前**に移動すべき。

---

## Important Issues（7件）

### I-1: `HasUnpushedCommits` のエラー文字列マッチング

**ファイル**: [internal/git/git.go](myT-x/internal/git/git.go#L130-L137)

```go
if strings.Contains(errStr, "upstream") || strings.Contains(errStr, "no such ref") ||
    strings.Contains(errStr, "@{u}") || strings.Contains(errStr, "does not point to a branch") {
```

gitのバージョンやロケールによってエラーメッセージが変わるリスクがある。旧実装（全エラーswallow）よりは大幅に改善されているが、マッチ対象のメッセージ例をコメントに追記し、保守性を向上させることを推奨。将来的に `runGitCLI` が exit code を返す構造にすれば、より堅牢にできる。

### I-2: `HasUnpushedCommits` エラー伝播パスのテスト不足

**ファイル**: [internal/git/git_test.go](myT-x/internal/git/git_test.go)

`TestHasUnpushedCommitsNoUpstream` で「upstream なし → false」のパスはテスト済みだが、今回新たに追加された **upstream以外のエラー（ディスクI/O等）が伝播されるパス** のテストがない。

### I-3: `parseRegQueryOutput` の prefix マッチが `PathExt` 等にも一致しうる

**ファイル**: [internal/install/shim_path_windows.go](myT-x/internal/install/shim_path_windows.go#L59-L60)

```go
if line == "" || !strings.HasPrefix(strings.ToLower(line), "path") {
```

`reg query HKCU\Environment /v Path` では `Path` のみ出力されるため現状は問題ないが、防御的には先頭フィールドの完全一致が安全:
```go
parts := strings.Fields(line)
if len(parts) < 3 || !strings.EqualFold(parts[0], "path") {
    continue
}
return strings.Join(parts[2:], " ")
```

### I-4: `parseRegQueryOutput` が連続スペースを含むPATH値を正規化してしまう

**ファイル**: [internal/install/shim_path_windows.go](myT-x/internal/install/shim_path_windows.go#L57-L68)

`strings.Fields` + `strings.Join(parts[2:], " ")` は複数連続スペースを1つに正規化する。`C:\Dir  Name` → `C:\Dir Name` となる。実用上は極めて稀だが、完全性を担保するならインデックスベースのパースが望ましい。

### I-5: save/restore パターンが変更対象外テストファイルで旧パターンのまま残存

**ファイル**: 以下のテストファイルで旧パターン `runtimeEventsEmitFn = runtime.EventsEmit` が合計21箇所残存

| ファイル | 箇所数 |
|---------|--------|
| [app_events_test.go](myT-x/app_events_test.go) | 6 |
| [app_config_api_test.go](myT-x/app_config_api_test.go) | 14 |
| [app_lifecycle_test.go](myT-x/app_lifecycle_test.go) | 1 |
| [app_pane_api_test.go](myT-x/app_pane_api_test.go) | 1 |

今回の差分では `app_session_api_test.go`、`app_worktree_api_test.go` が新パターン（`origEmit := runtimeEventsEmitFn`）に移行済み。テスト実行順序によっては、別テストが `runtimeEventsEmitFn` を書き換えた状態で旧パターンが `runtime.EventsEmit` に固定リストアし、想定外の副作用を生む可能性がある。

### I-6: `copyFile` が非アトミック書き込み

**ファイル**: [internal/install/shim_source_windows.go](myT-x/internal/install/shim_source_windows.go)

`os.Create(dst)` は既存ファイルをtruncateする。その後 `io.Copy` 失敗時、元のshimも新しいshimも失われる。一時ファイルに書いてから `os.Rename` するアトミックパターンを推奨。shimの再インストールで復旧可能なため影響は限定的。

### I-7: `createEnvBlock` と `CREATE_UNICODE_ENVIRONMENT` フラグの整合性

**ファイル**: [internal/terminal/conpty_windows.go](myT-x/internal/terminal/conpty_windows.go#L175-L180)

`len(args.env) > 0` の場合に `CREATE_UNICODE_ENVIRONMENT` フラグを追加するが、`createEnvBlock` は空文字列フィルタ後に `nil` を返す可能性がある（`env = ["", "", ""]`）。フラグが設定されているのに環境ブロックが `nil` となる不整合が生じる。実害は低い（nil環境ブロックは親プロセス環境を継承）が、フラグ設定ロジックの修正を推奨。

---

## Suggestions（14件）

### S-1: `isIndexLockError` の関数名が実態と乖離

**ファイル**: [internal/git/command.go](myT-x/internal/git/command.go#L51-L54)

`"Unable to create" && "File exists"` は `shallow.lock` 等にもマッチするが、関数名は `isIndexLockError`。`isLockFileConflict` に変更するか、コメントで明記を推奨。

### S-2: `ResolveSymlinks` のエラー時のログ出力検討

**ファイル**: [internal/testutil/git.go](myT-x/internal/testutil/git.go#L19-L23)

`EvalSymlinks` エラー時に元パスを返す設計はテストヘルパーとして合理的だが、失敗時のデバッグが難しい。

### S-3: `FindAvailableWorktreePath` の「非NotExistエラー」パスのテスト不足

**ファイル**: [internal/git/validation.go](myT-x/internal/git/validation.go#L87-L100)

パーミッションエラーなどの非NotExistエラー時の防御的動作が追加されたが、テストがない。

### S-4: `installShimIfChanged` の空 sourceHash パスに対するテスト不足

**ファイル**: [internal/install/shim_installer_windows.go](myT-x/internal/install/shim_installer_windows.go#L150-L168)

`sourceHash = ""` で強制コピーが発生するパスの単体テストがない。

### S-5: `copyFile` のテスト不足

**ファイル**: [internal/install/shim_source_windows.go](myT-x/internal/install/shim_source_windows.go)

`copyFile` の正常コピー、読取元不存在、書込先パーミッションエラー等をカバーするテストがない。

### S-6: `runGitCLI` が exit code を失う設計

**ファイル**: [internal/git/command.go](myT-x/internal/git/command.go#L58-L100)

`*exec.ExitError` から exit code を取得すれば、I-1のエラー文字列マッチがより堅牢になる。将来の拡張候補。

### S-7: `testutil` 委譲ラッパーの削除検討

**ファイル**: [app_session_api_test.go](myT-x/app_session_api_test.go#L192-L199)

`skipIfNoGit` / `createTempGitRepo` が `testutil` への単なる委譲。開発フェーズで後方互換不要なら呼び出し元を直接 `testutil.*` に変更しラッパー削除。

### S-8: `WaitForSingleObject` エラー時のデバッグログ追加

**ファイル**: [internal/terminal/conpty_windows.go](myT-x/internal/terminal/conpty_windows.go#L268-L271)

```go
ret, _ := windows.WaitForSingleObject(c.pi.Process, gracePeriod)
```

`WAIT_FAILED` 時のログ出力追加で問題診断を容易に。

### S-9: `createEnvBlock` のテスト追加

**ファイル**: [internal/terminal/conpty_syscall_windows.go](myT-x/internal/terminal/conpty_syscall_windows.go#L118-L134)

空文字列フィルタリングの追加に合わせて、`createEnvBlock` の単体テストがあると良い。

### S-10: `procutil` の non-Windows テスト追加

**ファイル**: [internal/procutil/hide_window_other.go](myT-x/internal/procutil/hide_window_other.go)

no-op関数だが、`HideWindow(cmd)` 後に `SysProcAttr == nil` のままであること、`HideWindow(nil)` がパニックしないことを確認するテスト追加推奨。

### S-11: `branchName` 非空 + err != nil のテストケース追加

**ファイル**: [app_worktree_api.go](myT-x/app_worktree_api.go#L720-L727)

`currentBranchFn` が非空branchとerrを同時に返すケースのテストがない。分岐の到達可能性確認のためテスト追加推奨。

### S-12: `ensurePathContains` 後の `WM_SETTINGCHANGE` 送信検討

**ファイル**: [internal/install/shim_path_windows.go](myT-x/internal/install/shim_path_windows.go#L33-L36)

`reg add` 後に `WM_SETTINGCHANGE` を送信すれば Explorer 等が即座にPATH変更を認識。現状は「新しいターミナルを開け」メッセージで対処しているため必須ではないが UX 向上候補。

### S-13: `ConPty.Close()` のべき等性

**ファイル**: [internal/terminal/conpty_windows.go](myT-x/internal/terminal/conpty_windows.go#L237)

`Close()` が2回呼ばれた場合、無効なハンドルで API が呼ばれる。`Terminal.Close()` 側の `closed` フラグでガードされているため通常パスでは問題ないが、 `ConPty` 単体ではガードがない。

### S-14: グレース期間 500ms のデフォルト値

**ファイル**: [internal/terminal/conpty_windows.go](myT-x/internal/terminal/conpty_windows.go#L269)

重いシェル（PowerShell 等）の終了処理には短い可能性あり。定数定義は適切。実運用フィードバック後の調整候補。

---

## Strengths（良い点）

### 設計改善
- **`procutil` パッケージ抽出**: `HideWindow` を3箇所（git/app_worktree/install）に散在していたプラットフォーム固有実装から共有パッケージに集約。SRP、DRY原則に適合
- **`testutil` パッケージ抽出**: `SkipIfNoGit`、`CreateTempGitRepo`、`ResolveSymlinks` をテストヘルパーとして一元管理。Windows 8.3短縮パス問題が全テストで統一的に解消
- **`installShimIfChanged` ヘルパー**: embedded/file両パスの重複ロジックを排除

### エラーハンドリング改善
- **`HasUnpushedCommits`**: 全エラーswallow → 特定エラーのみ吸収 + それ以外は伝播
- **`FindAvailableWorktreePath`**: パーミッションエラー等の非NotExistエラーを安全に処理
- **`readUserPathFromRegistry`**: "value not found" vs genuine error の区別
- **`startPipeMode` リソースリーク修正**: パイプ生成途中の失敗時に既取得リソースを適切に閉鎖
- **`exeErr == nil && exePath != ""`**: `os.Executable()` 失敗時の未定義動作を防止

### テスト品質
- **`shouldUseConPty`**: 26ケースで全組み合わせを網羅するテーブル駆動テスト
- **`parseRegQueryOutput`**: 日本語パス・タブ区切り・大文字小文字等のエッジケースカバー
- **`HideWindow`**: nil guard、べき等性、既存属性保持を個別テスト
- **save/restore パターン**: `runtime.EventsEmit` への直接依存を排除、テスト独立性向上

### セキュリティコメント
- `runGitCLI`、`startPipeMode`、`ensurePathContains` 等でコマンド引数がアプリケーション構築であることを明示。将来の開発者への有用な情報

---

## Recommended Action

### 優先度別対応計画

```
1. [Critical] C-1, C-2 を修正
2. [Important] I-1 〜 I-7 を対応
3. [Suggestion] 必要に応じて対応
4. 修正後に再レビュー実施
```

---

## タスク整理表（並列作業可否）

以下に修正タスクを整理し、並列で作業して問題ないかを示します。

| # | タスクID | 対象ファイル | 修正内容 | 優先度 | 並列作業 | 備考 |
|---|---------|------------|---------|--------|---------|------|
| 1 | C-1 | `internal/install/shim_path_windows.go`<br>`internal/install/shim_installer_windows_test.go` | `isRegValueNotFoundError("")` を `false` に変更 + テスト修正 | Critical | **可** | install パッケージ内で完結 |
| 2 | C-2 | `internal/terminal/conpty_windows.go` | `Close()` 内のプロセス終了待機をパイプ閉鎖の前に移動 | Critical | **可** | terminal パッケージ内で完結。C-1と並列OK |
| 3 | I-1 | `internal/git/git.go` | `HasUnpushedCommits` のエラー文字列リストにバージョン例コメント追加 | Important | **可** | git パッケージ内で完結 |
| 4 | I-2 | `internal/git/git_test.go` | `HasUnpushedCommits` エラー伝播パスのテスト追加 | Important | **可** | I-1と同時作業可（別関数） |
| 5 | I-3 | `internal/install/shim_path_windows.go` | `parseRegQueryOutput` の prefix マッチを完全一致に変更 | Important | **注意** | **C-1と同一ファイル**。C-1 → I-3 の順序推奨 |
| 6 | I-4 | `internal/install/shim_path_windows.go` | `parseRegQueryOutput` の連続スペース正規化対応 | Important | **注意** | **I-3と同一関数**。I-3と同時修正推奨 |
| 7 | I-5 | `app_events_test.go`<br>`app_config_api_test.go`<br>`app_lifecycle_test.go`<br>`app_pane_api_test.go` | save/restore パターンを新方式に統一（21箇所） | Important | **可** | app層テストのみ。他タスクと並列OK |
| 8 | I-6 | `internal/install/shim_source_windows.go` | `copyFile` をアトミック書き込みに変更 | Important | **可** | install パッケージ内。C-1完了後が安全 |
| 9 | I-7 | `internal/terminal/conpty_windows.go` | `CREATE_UNICODE_ENVIRONMENT` フラグ設定を `createEnvBlock` 結果で判定 | Important | **注意** | **C-2と同一ファイル**。C-2 → I-7 の順序推奨 |

### 並列作業グループ

依存関係がないタスクをグループ化して並列実行できます。

| グループ | タスク | 理由 |
|----------|-------|------|
| **Group A** | C-1, I-3, I-4 | 全て `shim_path_windows.go` に関連。同一ファイルのため**順次作業推奨** |
| **Group B** | C-2, I-7 | 全て `conpty_windows.go` に関連。同一ファイルのため**順次作業推奨** |
| **Group C** | I-1, I-2 | `internal/git/` パッケージ内。git.go と git_test.go で**並列OK** |
| **Group D** | I-5 | app層テスト4ファイル。他グループと**完全に独立**、並列OK |
| **Group E** | I-6 | `shim_source_windows.go`。Group Aと別ファイルのため**並列OK** |

**推奨実行順序**:
```
Phase 1 (並列): Group A (C-1→I-3→I-4) | Group B (C-2→I-7) | Group C (I-1+I-2) | Group D (I-5) | Group E (I-6)
Phase 2: 修正後の再レビュー
```

### 注意事項

- Group A 内（C-1, I-3, I-4）は同一ファイル・同一関数を修正するため、**グループ内は順次作業**が必要
- Group B 内（C-2, I-7）も同一ファイルのため**グループ内は順次作業**が必要  
- 各グループ間は完全に独立しており、**グループ間は並列作業可能**
- Suggestion はブロッカーではなく、Critical/Important 完了後に余裕があれば対応

