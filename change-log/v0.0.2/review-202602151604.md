# PR Review Summary — 2026-02-15 16:04

## レビュー対象

コミット前の `myT-x/` 配下の全差分（26ファイル、2145行）

### 変更カテゴリ

| カテゴリ | ファイル数 | 変更種別 |
|---------|-----------|---------|
| App Worktree API | 4 (2 修正 + 2 削除) | `procutil.HideWindow` 統合、テスト追加 |
| App テスト群 | 5 | cleanup パターン統一、testutil 移行 |
| Internal git パッケージ | 7 (5 修正 + 2 削除) | エラーハンドリング改善、リネーム |
| Internal install パッケージ | 4 | リファクタリング、アトミック書込み、レジストリ対応 |
| Internal terminal パッケージ | 6 | sync.Once 冪等化、パイプ cleanup |

### 新規共通パッケージ

- `internal/procutil` — `HideWindow` のクロスプラットフォーム統合
- `internal/testutil` — テストヘルパー共通化（`CreateTempGitRepo`, `SkipIfNoGit`, `ResolveSymlinks`）

---

## Critical Issues (0件)

なし

---

## Important Issues (2件)

### I-1. [install] 非英語ロケールでの `isRegValueNotFoundError` の判定不足

**ファイル**: `myT-x/internal/install/shim_path_windows.go` L75-79

`isRegValueNotFoundError` は `strings.Contains(lower, "unable to find")` のみで判定している。日本語 Windows では `reg.exe` のエラーメッセージが `"指定されたレジストリ キーまたは値が見つかりませんでした"` となり、この判定に合致しない。

**影響**: 日本語 Windows 環境で PATH レジストリ値が未設定の場合、`readUserPathFromRegistry` がエラーを返し、`ensurePathContains` が PATH 更新を断念する。shim インストールは成功するがPATH追加が失敗する。

**対策案**:
1. `golang.org/x/sys/windows/registry` パッケージで直接レジストリを読む（`reg.exe` 不要）（推奨）
2. `reg.exe` の終了コードで判別する
3. エラー時のフォールバックとして `os.Getenv("PATH")` を返す

### I-2. [install] `copyFile` の `tmpFile.Close()` 二重呼び出しリスク

**ファイル**: `myT-x/internal/install/shim_source_windows.go` L46-64

正常パス: L60 `tmpFile.Close()` → L62 `os.Rename` → return
エラーパス（L60でClose失敗時）: defer 内 L53 で再度 `tmpFile.Close()` が呼ばれる

Go の `*os.File.Close()` 二重呼び出しは現状エラーを返すだけで安全だが、将来的な FD 再利用の文脈では防御的に避けるべき。

**修正案**:
```go
closed := false
defer func() {
    if retErr != nil {
        if !closed {
            tmpFile.Close()
        }
        os.Remove(tmpPath)
    }
}()
// ...
if err := tmpFile.Close(); err != nil { return err }
closed = true
return os.Rename(tmpPath, dst)
```

---

## Suggestions (10件)

### S-1. [git] `HasUnpushedCommits` のエラーパターンに `"not a valid ref"` 追加を検討

**ファイル**: `myT-x/internal/git/git.go` L135-139

コメントに `"fatal: '@{upstream}' is not a valid ref"` パターンが記載されているが、マッチ条件に `"not a valid ref"` が含まれていない。現状は `"upstream"` でマッチするため動作に問題はないが、git が upstream を含まないメッセージを出す可能性に備えて追加を検討。

### S-2. [git] リトライログに `dir` フィールドを追加

**ファイル**: `myT-x/internal/git/command.go` L106-109

ロックファイル競合時のデバッグログに `args` はあるが `dir` がない。どのリポジトリで競合が起きたかの特定が困難。

```go
slog.Debug("[DEBUG-GIT] lock file conflict, retrying",
    "attempt", attempt+1, "maxRetries", maxGitRetries,
    "backoff_ms", backoff.Milliseconds(), "args", args,
    "dir", dir)  // ← 追加
```

### S-3. [git] `TestFindAvailableWorktreePath` のテスト重複

**ファイル**: `myT-x/internal/git/validation_test.go` L191 と `myT-x/internal/git/worktree_test.go` L255

ほぼ同内容の3サブテストが2ファイルに重複。`validation_test.go` に統一し `worktree_test.go` 側の `TestFindAvailableWorktreePathBasicBehavior` を削除推奨。

### S-4. [git] `HasUnpushedCommits` テストで `errors.Is` による unwrap 検証追加

**ファイル**: `myT-x/internal/git/git_test.go` L400-404

`"HasUnpushedCommits"` プレフィックスの存在のみ検証。`%w` ラップの正しさを `errors.Unwrap` でも確認すると堅牢。

### S-5. [install] `installShimIfChanged` のテストケース追加

**ファイル**: `myT-x/internal/install/shim_installer_windows_test.go`

以下2ケースが未カバー:
- `writeFn` がエラーを返すケース（ハッシュファイルが書かれないことの検証）
- `sourceHash` が既存ハッシュファイルと一致する場合に `writeFn` が呼ばれないことの検証

### S-6. [session_test] `TestRollbackCreatedSessionDirect` のクリーンアップパターン不統一

**ファイル**: `myT-x/app_session_api_test.go` L842-847

`executeRouterRequestFn` の復元にインライン関数再構築パターンを使用。同ファイル内の他テストは `origExecute` キャプチャパターンを使用。スタイル統一推奨。

### S-7. [testutil] `ResolveSymlinks` の命名

**ファイル**: `myT-x/internal/testutil/git.go`

主目的は Windows 8.3 短パスの解決だが、関数名が `ResolveSymlinks` で一般的すぎる。GoDoc に意図が記載されているため実用上は問題ないが、`ResolvePath` 等も検討可。

### S-8. [terminal] ConPty.Close() の冪等性テスト追加

**ファイル**: `myT-x/internal/terminal/conpty_windows.go`

`sync.Once` による冪等化が実装されたが、Close()→Close() の連続呼び出しで同じエラー値が返ることを検証するテストがない。

### S-9. [terminal] createEnvBlock の内容検証テスト

**ファイル**: `myT-x/internal/terminal/conpty_syscall_windows.go`

現在のテストは nil/non-nil のみ確認。変換結果の UTF-16 内容の正しさを検証するテスト追加を検討。

### S-10. [install] `parseRegQueryOutput` での `strings.Index` エッジケース

**ファイル**: `myT-x/internal/install/shim_path_windows.go` L67-84

PATH 値に型名文字列（例: `C:\REG_EXPAND_SZ\bin`）が含まれる場合に誤マッチの可能性。実用上は問題にならないが、`strings.Fields` のインデックスで位置特定する方が堅牢。

---

## Strengths（良い点）

1. **DRY 原則の徹底** — `procutil.HideWindow` と `testutil` への共通化が全ファイルで完全に適用済み。ローカル定義の残存ゼロ、死参照ゼロ

2. **テストクリーンアップパターンの統一** — `origEmit := runtimeEventsEmitFn` + `t.Cleanup` が全テストファイルで一貫。`runtime.EventsEmit` への直接依存が完全排除

3. **エラーハンドリングの適正化** — `HasUnpushedCommits` の「全エラー飲み込み」を分類型に改善。呼び出し元との整合性確認済み

4. **アトミック書込み** — `copyFile` の temp file + `os.Rename` パターンで部分書込みリスク排除

5. **ConPty の graceful shutdown** — `closePseudoConsole` → `WaitForSingleObject(500ms)` → `TerminateProcess` の正しい順序実装

6. **sync.Once による冪等 Close** — スレッドセーフな二重呼出し防止

7. **createEnvBlock の防御** — 空文字列フィルタリングでダブル null ターミネータ誤認防止

8. **セキュリティコメントの充実** — `runGitCLI`, `startPipeMode`, reg コマンド等の `SECURITY:` コメントにより、引数の信頼性根拠が明示

9. **`shouldUseConPty` の論理簡素化** — 死コードを排除し opt-out 方式に統一

10. **コメント精度** — `branchName` チェックの意図記述が正確でコードと一致

---

## タスク一覧と並列作業可否

| # | タスク | 重要度 | 対象ファイル | 並列作業 | 説明 |
|---|--------|--------|-------------|---------|------|
| I-1 | `isRegValueNotFoundError` の非英語ロケール対応 | Important | `shim_path_windows.go` | ✅ 可 | 他タスクと独立。レジストリ読取り方式の変更。install パッケージ内で完結 |
| I-2 | `copyFile` の Close 二重呼出し防止 | Important | `shim_source_windows.go` | ✅ 可 | I-1 と同じ install パッケージだが異なるファイル・異なる関数。並列可 |
| S-1 | `HasUnpushedCommits` エラーパターン追加 | Suggestion | `git.go` | ✅ 可 | git パッケージ内で完結。他タスクと無関係 |
| S-2 | リトライログに `dir` 追加 | Suggestion | `command.go` | ✅ 可 | 1行追加のみ。他タスクと無関係 |
| S-3 | テスト重複 `TestFindAvailableWorktreePath` 削除 | Suggestion | `worktree_test.go` | ✅ 可 | テスト削除のみ。他タスクと無関係 |
| S-4 | `HasUnpushedCommits` テストで unwrap 検証 | Suggestion | `git_test.go` | ⚠️ S-1 と順次 | S-1 でエラーパターンが変わる場合テストも影響 |
| S-5 | `installShimIfChanged` テスト追加 | Suggestion | `shim_installer_windows_test.go` | ✅ 可 | テスト追加のみ。本体コード変更なし |
| S-6 | `TestRollbackCreatedSessionDirect` cleanup 統一 | Suggestion | `app_session_api_test.go` | ✅ 可 | テストのみ。他タスクと無関係 |
| S-7 | `ResolveSymlinks` 命名検討 | Suggestion | `testutil/git.go` | ⚠️ 影響大 | リネームすると全テストファイルの呼出し元変更が必要。単独で実施推奨 |
| S-8 | ConPty.Close() 冪等性テスト追加 | Suggestion | `conpty_windows_test.go` (新規) | ✅ 可 | テスト追加のみ |
| S-9 | createEnvBlock 内容検証テスト追加 | Suggestion | `conpty_syscall_windows_test.go` | ✅ 可 | テスト追加のみ。S-8 と並列可 |
| S-10 | `parseRegQueryOutput` エッジケース対応 | Suggestion | `shim_path_windows.go` | ⚠️ I-1 と順次 | I-1 がレジストリ読取り方式を変更する場合、この関数自体が不要になる可能性 |

### 並列作業グループ

```
グループ A（並列可）: I-1, I-2, S-1, S-2, S-3, S-5, S-6, S-8, S-9
グループ B（順次実行）: S-1 → S-4（S-1完了後）
グループ C（順次実行）: I-1 → S-10（I-1の方針確定後）
グループ D（単独推奨）: S-7（影響範囲が広い）
```

### 推奨対応順序

```
1. [Important] I-1 + I-2 を最優先で並列対応
2. [Suggestion] S-1〜S-6, S-8, S-9 を並列対応
3. [Suggestion] S-4 を S-1 完了後に対応
4. [Suggestion] S-10 を I-1 完了後に方針判断
5. [Suggestion] S-7 は影響範囲を考慮して単独で判断
```

---

## レビュー方法

5カテゴリに分割し並列レビューを実施:

| エージェント | 担当カテゴリ | 対象ファイル数 |
|------------|------------|--------------|
| Agent 1 | App Worktree API | 4 |
| Agent 2 | App テスト群 | 5 |
| Agent 3 | Internal git | 7 |
| Agent 4 | Internal install | 4 |
| Agent 5 | Internal terminal | 6 |
| Agent 6 | クロスカッティング | 全26 |
