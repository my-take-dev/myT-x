# PR Review Summary — 2026-02-15 16:40

## レビュー対象

コミット前の `myT-x/` 配下の全変更ファイル（12 modified + 1 new = 13 files）

| カテゴリ | ファイル | 変更概要 |
|---------|---------|---------|
| **A: git** | `internal/git/command.go` | リトライログに `dir` フィールド追加 |
| **A: git** | `internal/git/git.go` | `HasUnpushedCommits` に `"not a valid ref"` パターン追加 |
| **A: git** | `internal/git/git_test.go` | `ResolveSymlinks→ResolvePath` リネーム、`errors.Unwrap` テスト追加 |
| **A: git** | `internal/git/worktree_test.go` | `TestFindAvailableWorktreePathBasicBehavior` 削除（`validation_test.go` に移動済） |
| **B: install** | `internal/install/shim_installer_windows.go` | `userEnvRegPath` 定数削除 |
| **B: install** | `internal/install/shim_installer_windows_test.go` | reg.exe テスト削除、レジストリAPI・`installShimIfChanged` テスト3件追加 |
| **B: install** | `internal/install/shim_path_windows.go` | **主要変更**: `reg.exe` CLI → `golang.org/x/sys/windows/registry` API に完全移行 |
| **B: install** | `internal/install/shim_source_windows.go` | `copyFile` のダブルクローズ防止修正 |
| **C: terminal** | `internal/terminal/conpty_syscall_windows_test.go` | `TestCreateEnvBlockContent` + `readUTF16Block` ヘルパー追加 |
| **C: terminal** | `internal/terminal/conpty_close_windows_test.go` | **新規**: `TestConPtyCloseIdempotent` |
| **C: testutil** | `internal/testutil/git.go` | `ResolveSymlinks→ResolvePath` リネーム |
| **C: app** | `app_session_api_test.go` | `executeRouterRequestFn` のクリーンアップをsave/restore方式に改善 |
| **C: app** | `app_worktree_api_test.go` | `ResolveSymlinks→ResolvePath` リネーム |

---

## レビュー体制

6つの専門レビューエージェントによる並列レビュー:

| エージェント | 担当領域 |
|-------------|---------|
| code-reviewer | コーディング規約・バグ・API設計 |
| test-analyzer | テスト品質・カバレッジ |
| silent-failure-hunter | エラーハンドリング・サイレント障害 |
| type-design-analyzer | 型設計・インバリアント |
| comment-analyzer | コメント精度・陳腐化 |
| code-simplifier | コード簡素化 |
| side-effect-analyzer | 差分外モジュールへの影響 |

---

## Critical Issues（0件）

なし。

---

## Important Issues（4件）

### IMP-1. `copyFile` — `tmpFile.Close()` 失敗時のダブルクローズ

**ファイル**: `myT-x/internal/install/shim_source_windows.go` L75-80付近
**検出**: silent-failure-hunter

`tmpFile.Close()` がエラーを返した場合、`closed` フラグが `true` にセットされる前に `return` されるため、deferredクリーンアップ内で再度 `tmpFile.Close()` が呼ばれる。

```go
if err := tmpFile.Close(); err != nil {
    return err  // ← ここでreturn、closed = true に到達しない
}
closed = true
```

deferred側で `!closed` チェックにより二重Closeが発生する。Goの `os.File` は内部でfd状態を追跡するため即座にパニックにはならないが、防御的修正を推奨。

**修正案**:
```go
closeErr := tmpFile.Close()
closed = true  // Close呼出し済みのフラグは結果に関係なく設定
if closeErr != nil {
    return closeErr
}
```

---

### IMP-2. `ensurePathContains` — レジストリキー未存在時の書き込み失敗

**ファイル**: `myT-x/internal/install/shim_path_windows.go` L40-45付近
**検出**: code-reviewer, silent-failure-hunter

`readUserPathFromRegistry()` は `HKCU\Environment` キーが存在しない場合に `"", nil` を返す設計だが、書き込み時に `registry.OpenKey` を使用しており、キーが存在しなければOpenが失敗する。read側とwrite側の一貫性が欠けている。

**修正案**:
```go
// OpenKey → CreateKey に変更（キーが無ければ作成）
key, _, err := registry.CreateKey(registry.CURRENT_USER, registryEnvKeyPath, registry.SET_VALUE)
```

※ 実運用上 `HKCU\Environment` は通常存在するため発生頻度は極めて低いが、設計一貫性の観点で推奨。

---

### IMP-3. `HasUnpushedCommits` の `"not a valid ref"` 条件にテストが無い

**ファイル**: `myT-x/internal/git/git.go` L141
**検出**: test-analyzer

`strings.Contains(errStr, "not a valid ref")` が追加されたが、この条件を直接テストするケースが存在しない。`TestHasUnpushedCommitsNoUpstream` は `"upstream"` 文字列でカバーされるケースのみ検証。

**推奨**: detached HEAD状態で `HasUnpushedCommits` を呼ぶテストを追加し、`false, nil` が返ることを検証。
```go
t.Run("detached HEAD returns false", func(t *testing.T) {
    _, cloneDir := createBareAndClone(t)
    repo, _ := Open(cloneDir)
    runGitInDir(t, cloneDir, "checkout", "--detach")
    has, err := repo.HasUnpushedCommits()
    if err != nil { t.Fatalf("unexpected error: %v", err) }
    if has { t.Error("expected false for detached HEAD") }
})
```

---

### IMP-4. `git.go` のコメントとコードの乖離

**ファイル**: `myT-x/internal/git/git.go` L119-131
**検出**: comment-analyzer

条件式に `"not a valid ref"` が追加されたが、コメント（Known error message patterns）にこのパターンが独立エントリとして列挙されていない。コメント中の既存パターン `"@{upstream}' is not a valid ref"` は `"upstream"` 条件で先にマッチするため、`"not a valid ref"` 単独マッチのケース（他のref参照エラー）がコメントに文書化されていない。

**修正案**: コメントに行を追加：
```go
//   - "fatal: ... is not a valid ref" (other invalid ref errors, e.g. bare HEAD ref)
```

---

## Suggestions（7件）

### SUG-1. `TestConPtyCloseIdempotent` — `sync.Once{}` は冗長な初期化

**ファイル**: `myT-x/internal/terminal/conpty_close_windows_test.go` L14

`sync.Once` のゼロ値はそのまま使用可能。`closeOnce: sync.Once{}` → `cpty := &ConPty{}` で十分。

---

### SUG-2. `doClose()` — `closePseudoConsole(0)` のゼロ値ガード欠如

**ファイル**: `myT-x/internal/terminal/conpty_windows.go` L254

`doClose()` で `closePseudoConsole(c.hpCon)` が無条件に呼ばれる。`closeHandles()` はゼロ値ガード（`h == 0 || h == windows.InvalidHandle`）を持つが、`hpCon` にはガードが無い。`TestConPtyCloseIdempotent` ではゼロ値 `hpCon` で `Close()` を呼んでいる。Windows API `ClosePseudoConsole(0)` の動作は未定義。

**推奨**: `if c.hpCon != 0` ガードを追加し、`closeHandles` と防御パターンを統一。

---

### SUG-3. `copyFile` の引数宣言 — Go慣用スタイル

**ファイル**: `myT-x/internal/install/shim_source_windows.go` L49

`(src string, dst string)` → `(src, dst string)` に変更するとGo慣用スタイルになる。

---

### SUG-4. `TestReadUserPathFromRegistry` — 環境依存テスト

**ファイル**: `myT-x/internal/install/shim_installer_windows_test.go` L88-96

実レジストリ読み取りテスト。CI環境や特殊Windows構成ではflakyになる可能性がある。スモークテストとしては有効だが、レグレッション検出力は低い。

---

### SUG-5. `matchesHashFile` — IOエラーの暗黙的飲み込み

**ファイル**: `myT-x/internal/install/shim_installer_windows.go` `matchesHashFile` 関数

`os.ReadFile` エラー時に `false` を返すが、ファイル未存在もIO障害も同じ扱い。結果として不要な再コピーが実行されるため実害は低いが、ディスク障害をログに残さない。

---

### SUG-6. `pathValueName` 定数 — 定義箇所の集約

**ファイル**: `myT-x/internal/install/shim_installer_windows.go` L18

`pathValueName` は `shim_installer_windows.go` で定義されているが、主に使用するのは `shim_path_windows.go`。`registryEnvKeyPath` と共に `shim_path_windows.go` に集約する方が可読性向上。

---

### SUG-7. `testutil/git.go` `ResolvePath` — EvalSymlinks使用理由の補足コメント

**ファイル**: `myT-x/internal/testutil/git.go` L22-24

`filepath.EvalSymlinks` はシンボリックリンク解決が本来目的だが、Windowsでは副次効果として8.3短縮パス解決も行う。使用理由の補足コメント追加を推奨。

---

## Strengths（良い点）

1. **レジストリAPI移行の品質が高い** — `reg.exe` CLI → `golang.org/x/sys/windows/registry` への移行が適切。テキストパースの全クラスが排除され、`SetExpandStringValue`（REG_EXPAND_SZ）の使用で環境変数展開を正しく維持。非英語ロケールでのreg.exeエラーメッセージ問題も解消。

2. **`copyFile` のダブルクローズ修正が最小変更** — `closed` フラグ1つで問題を解決。アトミック書き込みパターン（tmpファイル→rename）も維持。

3. **エラーラッピングの一貫性** — 全 `fmt.Errorf` で `%w` を使用。`errors.Is`/`errors.Unwrap` で辿れる構造。

4. **`[DEBUG-*]` ログプレフィックスの統一** — プロジェクト規約通り。

5. **`ResolveSymlinks→ResolvePath` リネーム** — 全6箇所の呼び出し元で漏れなく完了。関数名が実際の目的を正確に反映。

6. **テスト設計** — `installShimIfChanged` の異常系・スキップ条件をカバー。`TestConPtyCloseIdempotent` は `sync.Once` の冪等性を軽量に検証。

7. **テストクリーンアップ改善** — `TestRollbackCreatedSessionDirect` のsave/restoreパターンが正しいテスト分離を実現。

8. **diff外モジュールへの副作用なし** — 全削除関数（`parseRegQueryOutput`, `isRegValueNotFoundError`, `ResolveSymlinks`）の残存参照がゼロ。`go.mod` に新依存も対応済み。

---

## タスク一覧と並列作業可否

以下の表は、各指摘事項の修正タスクについて、他タスクとの依存関係と並列作業の可否をまとめたものです。

| # | タスク | 対象ファイル | 重要度 | 修正内容 | 並列作業 | 備考 |
|---|--------|-------------|--------|----------|---------|------|
| T-1 | `copyFile` ダブルクローズ修正 | `internal/install/shim_source_windows.go` | **Important** | `closed = true` を `Close()` 直後に移動（結果に関わらず設定） | ✅ 可能 | 他タスクと無関係。1行の移動で修正完了 |
| T-2 | `ensurePathContains` の `OpenKey→CreateKey` | `internal/install/shim_path_windows.go` | **Important** | `registry.OpenKey` → `registry.CreateKey` で未存在キー対応 | ✅ 可能 | T-1と同パッケージだが別ファイル・別関数 |
| T-3 | detached HEAD テスト追加 | `internal/git/git_test.go` | **Important** | `HasUnpushedCommits` の `"not a valid ref"` パスをカバーするテスト | ✅ 可能 | 他タスクと無関係 |
| T-4 | `HasUnpushedCommits` コメント更新 | `internal/git/git.go` | **Important** | Known error patterns に `"not a valid ref"` 独立エントリ追加 | ✅ 可能 | T-3と同パッケージだが別ファイル。同時にやっても競合しない |
| T-5 | `sync.Once{}` 冗長初期化の削除 | `internal/terminal/conpty_close_windows_test.go` | Suggestion | `closeOnce: sync.Once{}` → フィールド省略 | ✅ 可能 | 他タスクと無関係 |
| T-6 | `doClose()` ゼロ値ガード追加 | `internal/terminal/conpty_windows.go` | Suggestion | `if c.hpCon != 0` ガード追加 | ✅ 可能 | T-5のテストファイルと関連するが競合しない |
| T-7 | `copyFile` 引数スタイル修正 | `internal/install/shim_source_windows.go` | Suggestion | `(src string, dst string)` → `(src, dst string)` | ⚠️ T-1と同ファイル | T-1と同時修正が効率的 |

### 並列作業ガイド

```
並列グループ1（install パッケージ）:
  T-1 + T-7 → 同ファイルのため一括修正推奨
  T-2      → 別ファイルなので独立して並列可

並列グループ2（git パッケージ）:
  T-3 → git_test.go のテスト追加
  T-4 → git.go のコメント更新
  ※ 別ファイルなので並列可

並列グループ3（terminal パッケージ）:
  T-5 → テストファイル修正
  T-6 → 本体ファイル修正
  ※ 別ファイルなので並列可
```

**全タスクが互いに独立しており、全て並列作業可能です。**
T-1 と T-7 のみ同一ファイルのため一括修正が効率的ですが、それでも並列作業で競合は発生しません。

---

## Recommended Action

1. **Important（T-1〜T-4）を先に修正** — 特に T-1（ダブルクローズ）は実害リスクがあり最優先
2. **Suggestion（T-5〜T-7）は余裕があれば対応**
3. **修正後に `go build ./...` と `go vet ./...` で確認**
