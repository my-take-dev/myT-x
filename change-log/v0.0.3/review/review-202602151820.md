# PR Review Summary — 2026/02/15 18:20

## レビュー概要

| 項目 | 内容 |
|------|------|
| レビュー対象 | `myT-x/` 配下のコミット前変更 |
| 変更量 | +883行 / -470行（19ファイル） |
| レビュー手法 | 5カテゴリ並列レビュー + クロスカッティング検証 |
| 結果 | Critical: 2件, Important: 8件, Suggestion: 12件 |

### カテゴリ分類

| カテゴリ | 対象ファイル | 変更概要 |
|----------|-------------|----------|
| 1. Git/Worktreeコアロジック | `git.go`, `git_test.go`, `command.go`, `worktree.go`, `worktree_test.go`, `testutil/git.go` | ブランチフィルタリング、孤立ブランチ削除、upstream判定改善 |
| 2. Session/Worktree API | `app_session_api.go`, `app_session_api_test.go`, `app_worktree_api.go`, `app_worktree_api_test.go` | ブランチクリーンアップ統合、ListBranches改善 |
| 3. Windows Registry/Shim | `shim_path_windows.go`, `shim_installer_windows.go`, `shim_installer_windows_test.go`, `shim_source_windows.go` | reg.exe → ネイティブregistry API移行、WM_SETTINGCHANGE |
| 4. Terminal/ConPTY | `conpty_windows.go`, `conpty_syscall_windows_test.go` | Close安全性向上、EnvBlockテスト |
| 5. バージョン・設定 | `main.go`, `wails.json`, `README.md` | v0.0.1→v0.0.2、README削除 |

---

## Critical Issues（2件）— マージ前に修正必須

### C-1. `ListBranchesForWorktreeBase()` に専用ユニットテストが不足
- **ファイル**: `myT-x/internal/git/git.go` (L96)
- **説明**: 新規公開メソッドだが `git_test.go` に専用のテーブル駆動テストが存在しない。`app_worktree_api_test.go` の `TestListBranchesHidesWorktreeOnlyLocalBranches` で間接テストされているのみ。
- **CLAUDE.md規約**: 「新規公開関数 → テーブル駆動テスト（正常系+異常系）が**必須**」
- **不足ケース**:
  - リモートあり＋upstream alive → ブランチが返る
  - upstream `[gone]` → 除外される
  - 完全ローカルリポジトリ（リモートなし）→ フォールバック全ブランチ返却
  - ブランチ0件 → 空スライス
  - ローカルブランチ名がリモートと一致 → 含まれる

### C-2. `CleanupLocalBranchIfOrphaned()` に専用ユニットテストが不足
- **ファイル**: `myT-x/internal/git/git.go` (L135)
- **説明**: 新規公開メソッドだが `git_test.go` に専用テストが存在しない。`app_session_api_test.go` で間接テストのみ。
- **不足ケース**:
  - 不正ブランチ名 → `(false, ValidateBranchName error)`
  - 存在しないブランチ → `(false, nil)`
  - live upstream あり → 削除しない `(false, nil)`
  - リモートに同名ブランチ → 削除しない `(false, nil)`
  - orphanブランチ → 削除成功 `(true, nil)`
  - `git branch -d` 失敗（未マージ）→ `(false, error)`

---

## Important Issues（8件）— 修正を推奨

### I-1. `cleanupSessionWorktree` のパラメータ数が多い（可読性リスク）
- **ファイル**: `myT-x/app_session_api.go` (L179)
- **説明**: `(sessionName, wtPath, repoPath, branchName string, lookupErr error)` — 同じ型(`string`)のパラメータが4つ連続。引数順序を間違えてもコンパイルエラーにならず、サイレントバグの温床になりうる。
- **推奨**: パラメータを構造体に束ねる:
  ```go
  type worktreeCleanupParams struct {
      SessionName string
      WtPath      string
      RepoPath    string
      BranchName  string
      LookupErr   error
  }
  ```

### I-2. `ListBranches` が毎回 `PruneWorktrees()` を実行する副作用
- **ファイル**: `myT-x/app_worktree_api.go` (L336-L340)
- **説明**: read系API `ListBranches` 内で書き込み副作用（`PruneWorktrees`）が発生する。Principle of Least Surprise 違反。ブランチ選択ドロップダウン開閉のたびに prune が走る可能性あり。
- **備考**: `ListBranchesForWorktreeBase` が stale worktree を前提にフィルタするため prune は必要だが、コメントで副作用を明示すべき。
- **推奨**: prune をセッション/worktree削除時に限定するか、メソッド名に副作用を反映する。

### I-3. `isNoUpstreamTrackingError` テストケースの軽微な漏れ
- **ファイル**: `myT-x/internal/git/git_test.go`
- **説明**: `"@{u}"` パターン単独（`@{upstream}` でなく）での `"not a valid ref"` テストケースが明示的に含まれていない。現在の `"detached head valid ref"` テストは `@{upstream}` パターンで、`@{u}` 短縮形のテストが無い。
- **追加推奨ケース**:
  ```go
  {name: "no such ref with @{u} short form", errMsg: "fatal: no such ref: 'main@{u}'", want: true},
  ```

### I-4. `branchTrackingInfo.hasLiveUpstream()` のユニットテストが存在しない
- **ファイル**: `myT-x/internal/git/git.go` (L84-L89)
- **説明**: `ListBranchesForWorktreeBase` / `CleanupLocalBranchIfOrphaned` でコア判定ロジックとして使用される。`[gone]` の大文字小文字、空文字列 upstream など、テーブル駆動テストが望ましい。

### I-5. `readUserPathFromRegistryWithType` の二段階 GetValue TOCTOU
- **ファイル**: `myT-x/internal/install/shim_path_windows.go` (L101-L119)
- **説明**: 1回目 `GetValue(nil)` でサイズ取得後、2回目で読み取り。他プロセスが PATH 変更すると `ERROR_MORE_DATA` で失敗しうる。インストーラの1回実行のため実害は極低いが、堅牢性としてリトライループの追加を検討。

### I-6. `TestReadUserPathFromRegistry` が環境依存テスト
- **ファイル**: `myT-x/internal/install/shim_installer_windows_test.go` (L93-L103)
- **説明**: 実レジストリ `HKCU\Environment\Path` に依存。CI環境での不安定さリスクあり。テスト用レジストリキーの作成/削除ヘルパーを使ったエッジケーステストが望ましい。

### I-7. `createConPtyProcess` で `runtime.KeepAlive(envBlock)` が不足
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go`（本diff範囲外だが、テスト側で KeepAlive を入れた同じ理由が適用される）
- **説明**: テストで `runtime.KeepAlive(ptr)` を正しく配置しているが、プロダクションコードにおいて `createConPtyProcess` の `CreateProcess` 呼び出し後に `runtime.KeepAlive(envBlock)` がない。unsafe ルール上は保証がない。

### I-8. `TestDecodeRegistryUTF16String` にCJKテストケースが不足
- **ファイル**: `myT-x/internal/install/shim_installer_windows_test.go` (L203-L225)
- **説明**: 日本語パスはレジストリPATHに含まれうるが、テストケースに CJK 文字のエンコード/デコードが含まれていない。
- **追加推奨ケース**:
  ```go
  {name: "CJK characters", raw: encodeUTF16RegistryTestValue(`C:\ユーザー\bin`), want: `C:\ユーザー\bin`},
  ```

---

## Suggestions（12件）— 改善提案

### S-1. `containsUpstreamToken` の冗長な条件
- **ファイル**: `myT-x/internal/git/git.go` (L290-L292)
- **説明**: `"upstream"` は `"@{upstream}"` のスーパーセット。2番目の条件は論理的に冗長。可読性観点で許容可能だが、コメントで意図を補足すると良い。

### S-2. `hasAnyUpstreamTracking` の冗長な `TrimSpace`
- **ファイル**: `myT-x/internal/git/git.go` (L235)
- **説明**: `listLocalBranchTrackingInfo()` が既に `TrimSpace` 済み。防御的コーディングとして許容。

### S-3. `ListBranchesForWorktreeBase` のフォールバック条件の微妙なエッジケース
- **ファイル**: `myT-x/internal/git/git.go` (L122-L124)
- **説明**: リモートが存在するが、全ローカルブランチの upstream が `[gone]` かつリモートに同名ブランチがない場合、空リストを返す。意図的な設計であればコメントで補足。

### S-4. `CleanupLocalBranchIfOrphaned` のエラーメッセージ改善
- **ファイル**: `myT-x/internal/git/git.go` (L170)
- **説明**: `git branch -d` 失敗時のエラーがラップなしで返る。`fmt.Errorf("failed to delete orphaned branch %q: %w", branchName, err)` でログ可読性向上。

### S-5. `cleanupOrphanedLocalWorktreeBranch` の `repo == nil` でのサイレントリターン
- **ファイル**: `myT-x/app_session_api.go` (L233-L235)
- **説明**: `repo == nil` で早期リターンするがログなし。呼び出し元で nil にならないはずだが、Debug ログがあると調査しやすい。

### S-6. `broadcastEnvironmentSettingChange` の `lpdwResult` に NULL を渡している件
- **ファイル**: `myT-x/internal/install/shim_path_windows.go` (L209-L218)
- **説明**: `HWND_BROADCAST` では結果値は無意味だが、防御的に `var result uintptr` を渡す方がより安全。

### S-7. `selectPathRegistryValueType` の `default` ケースに到達不能コメント
- **ファイル**: `myT-x/internal/install/shim_path_windows.go` (L141-L151)
- **説明**: 呼び出し元が SZ/EXPAND_SZ 以外をエラーとしているため `default` は到達不能。防御的に残すのは妥当だが、意図をコメントで明示すると良い。

### S-8. `hpCon` のゼロ化
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` (L252-L254)
- **説明**: `closePseudoConsole` 後に `c.hpCon = 0` でゼロ化すると、Close後のResize呼び出し時の二次的安全性が向上。

### S-9. `readUTF16Block` のマジックナンバー `2` → `unsafe.Sizeof`
- **ファイル**: `myT-x/internal/terminal/conpty_syscall_windows_test.go` (L83)
- **説明**: `uintptr(i)*2` → `uintptr(i)*unsafe.Sizeof(uint16(0))` で意図が明確に。

### S-10. `TerminateProcess` 失敗ログに `WaitForSingleObject` の戻り値を追加
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` (L266-L270)
- **説明**: `WAIT_TIMEOUT` vs `WAIT_FAILED` の切り分けに `ret` 値のログ追加が有用。

### S-11. `cleanupSessionWorktree` の空 `branchName` テスト
- **ファイル**: `myT-x/app_session_api_test.go`
- **説明**: `branchName=""` の場合（detached HEAD worktree）のテストが暗黙的にしかカバーされていない。明示的テストが望ましい。

### S-12. `CleanupWorktree` と `cleanupSessionWorktree` の prune+ブランチクリーンアップ共通化
- **ファイル**: `myT-x/app_worktree_api.go`, `myT-x/app_session_api.go`
- **説明**: 2箇所で「prune → cleanupOrphanedLocalWorktreeBranch」の同一パターン。現時点では許容だが、箇所が増える場合はヘルパー抽出を検討。

---

## Positive Observations（良い点）

1. **`reg.exe` → ネイティブレジストリAPI移行**: ロケール依存の文字列パース排除、型安全なエラー処理、外部プロセス起動コスト消滅。品質・信頼性の大幅改善。
2. **`isNoUpstreamTrackingError` リファクタリング**: 旧コードの過度に広範な `strings.Contains` パターンから構造化された判定に改善。誤判定リスク低減。
3. **`WM_SETTINGCHANGE` ブロードキャスト実装**: TODO コメントの解消。PATH変更の他プロセスへの通知が正しく実装。
4. **`CleanupLocalBranchIfOrphaned` の安全設計**: `ValidateBranchName`、upstream確認、リモート確認、`-d`（safe delete）の多層防御。
5. **`ConPty.Close()` の安全性向上**: `hpCon != 0` ガード、`TerminateProcess` エラーログ化。
6. **`copyFile` ロールバック改善**: 二重close の無害化。
7. **`ResolveSymlinks` → `ResolvePath`**: 実際の目的を正確に反映する命名。全参照箇所で漏れなく完了。
8. **`--expire=now` の追加**: デスクトップアプリの明示的操作での即時反映は適切。
9. **テストの改善**: `TestRollbackCreatedSessionDirect` の cleanup パターン修正、`SkipIfNoGit` の追加、`errors.Unwrap` 検証。
10. **`TestCreateEnvBlockContent`**: unsafe メモリ内容を直接検証する高品質テスト。

---

## クロスカッティング検証結果

| 検証項目 | 結果 | 詳細 |
|----------|------|------|
| `cleanupSessionWorktree` 全呼び出し更新 | ✅ OK | 4箇所すべて5引数に更新済み |
| `ResolveSymlinks` 残存参照 | ✅ OK | Goファイル内に参照ゼロ |
| `ListBranches` API互換 | ✅ OK | 公開API名・型は変更なし。フロントエンドに影響なし |
| `PruneWorktrees` 呼び出し箇所 | ✅ OK | 6箇所確認、ユーザー操作起因で影響軽微 |
| `pathValueName` 定数移動 | ✅ OK | 参照整合性問題なし |
| `runGitCommandRaw` 使用 | ✅ OK | `for-each-ref` 出力保持に適切 |
| デッドコード | ✅ OK | 新規関数すべて1箇所以上から呼び出しあり |

---

## タスク整理 — 並列修正可否表

作業者が効率的に修正を進められるよう、各タスクの依存関係と並列作業の可否を整理します。

### 修正タスク一覧

| # | 重要度 | タスク | 対象ファイル | 推定作業量 | 並列作業可否 |
|---|--------|--------|-------------|-----------|-------------|
| T-1 | **Critical** | `ListBranchesForWorktreeBase` テーブル駆動テスト追加 | `internal/git/git_test.go` | 中 | ✅ 他と並列可 |
| T-2 | **Critical** | `CleanupLocalBranchIfOrphaned` テーブル駆動テスト追加 | `internal/git/git_test.go` | 中 | ⚠️ T-1と**同一ファイル**のため順次推奨 |
| T-3 | Important | `cleanupSessionWorktree` パラメータ構造体化 | `app_session_api.go`, `app_session_api_test.go` | 中 | ✅ T-1/T-2と並列可 |
| T-4 | Important | `ListBranches` の prune 副作用コメント追記 or 設計見直し | `app_worktree_api.go` | 小 | ✅ 他と並列可 |
| T-5 | Important | `isNoUpstreamTrackingError` テストケース追加 | `internal/git/git_test.go` | 小 | ⚠️ T-1/T-2と**同一ファイル**のため順次推奨 |
| T-6 | Important | `hasLiveUpstream()` テーブル駆動テスト追加 | `internal/git/git_test.go` | 小 | ⚠️ T-1/T-2/T-5と**同一ファイル**のため順次推奨 |
| T-7 | Important | `createConPtyProcess` に `runtime.KeepAlive` 追加 | `internal/terminal/conpty_windows.go` | 小 | ✅ 他と並列可 |
| T-8 | Important | `TestDecodeRegistryUTF16String` CJKテストケース追加 | `internal/install/shim_installer_windows_test.go` | 小 | ✅ 他と並列可 |
| T-9 | Suggestion | `containsUpstreamToken` コメント追加 | `internal/git/git.go` | 極小 | ✅ T-1/T-2と並列可（test/srcが別） |
| T-10 | Suggestion | `ListBranchesForWorktreeBase` フォールバック条件コメント | `internal/git/git.go` | 極小 | ✅ T-9と同時可 |
| T-11 | Suggestion | `hpCon` ゼロ化追加 | `internal/terminal/conpty_windows.go` | 極小 | ⚠️ T-7と**同一ファイル**のため順次推奨 |
| T-12 | Suggestion | `cleanupOrphanedLocalWorktreeBranch` nil ログ追加 | `app_session_api.go` | 極小 | ⚠️ T-3と**同一ファイル**のため順次推奨 |

### 並列作業グループ分け

```
並列グループA (git_test.go 関連 — 順次実行):
  T-1 → T-2 → T-5 → T-6

並列グループB (app_session_api 関連 — 順次実行):
  T-3 → T-12

並列グループC (conpty 関連 — 順次実行):
  T-7 → T-11

並列グループD (独立タスク — それぞれ独立して実行可):
  T-4 (app_worktree_api.go)
  T-8 (shim_installer_windows_test.go)
  T-9 (git.go コメント)
  T-10 (git.go コメント — T-9と同時可)
```

### 推奨作業順序

```
Phase 1 (Critical — 最優先):
  [グループA]  T-1 → T-2 → T-5 → T-6
  [グループB]  T-3 → T-12          ← グループAと並列可
  [グループC]  T-7 → T-11          ← グループA/Bと並列可
  [グループD]  T-4, T-8            ← グループA/B/Cと並列可

Phase 2 (Suggestion — 余力があれば):
  T-9, T-10                        ← 他が完了後でも可
```

### 並列可否の視覚マトリクス

| タスク | T-1 | T-2 | T-3 | T-4 | T-5 | T-6 | T-7 | T-8 | T-9 | T-10 | T-11 | T-12 |
|--------|-----|-----|-----|-----|-----|-----|-----|-----|-----|------|------|------|
| **T-1** | — | ⚠️同ファイル | ✅ | ✅ | ⚠️同ファイル | ⚠️同ファイル | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **T-2** | ⚠️ | — | ✅ | ✅ | ⚠️同ファイル | ⚠️同ファイル | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **T-3** | ✅ | ✅ | — | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ⚠️同ファイル |
| **T-4** | ✅ | ✅ | ✅ | — | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **T-5** | ⚠️ | ⚠️ | ✅ | ✅ | — | ⚠️同ファイル | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **T-6** | ⚠️ | ⚠️ | ✅ | ✅ | ⚠️ | — | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **T-7** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | — | ✅ | ✅ | ✅ | ⚠️同ファイル | ✅ |
| **T-8** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | — | ✅ | ✅ | ✅ | ✅ |

**凡例**: ✅ = 並列OK、⚠️ = 同一ファイル編集のため順次推奨、— = 自身

---

## Recommended Action

1. **最優先**: C-1, C-2 のテスト追加（CLAUDE.md 必須規約違反）
2. **推奨**: I-1 (パラメータ構造体化), I-7 (`KeepAlive` 追加) — 即座に修正可能
3. **検討**: I-2 (`ListBranches` 副作用), I-5 (TOCTOU) — 設計判断が必要
4. **再レビュー**: 上記修正後に `code` アスペクトで再レビュー推奨
