# PR Review Summary — 2026-02-15 21:18

## 対象差分

| ファイル | 変更量 | カテゴリ |
|---------|--------|---------|
| `myT-x/app_session_api.go` | +37 -19 | Session/Worktree API |
| `myT-x/app_session_api_test.go` | +34 -5 | Session/Worktree API |
| `myT-x/app_worktree_api.go` | -4 | Session/Worktree API |
| `myT-x/internal/git/git.go` | +5 -1 | Git Internal |
| `myT-x/internal/git/git_test.go` | +391 | Git Internal |
| `myT-x/internal/install/shim_path_windows.go` | +33 -12 | Windows Install |
| `myT-x/internal/install/shim_installer_windows_test.go` | +15 | Windows Install |
| `myT-x/internal/terminal/conpty_windows.go` | +7 -2 | Windows Terminal |
| `myT-x/internal/terminal/conpty_syscall_windows_test.go` | +2 -1 | Windows Terminal |

**合計: 9ファイル, +533行, -47行**

---

## Critical Issues (0件)

なし

---

## Important Issues (4件)

### I-1: コメントがworktreeCleanupParams型に誤って紐付いている
- **レビュー観点**: comment-analyzer / code-reviewer
- **ファイル**: `app_session_api.go:178-186`
- **説明**: `// cleanupSessionWorktree removes a worktree after session destruction.` は関数のドキュメントだが、直後にある `type worktreeCleanupParams struct` に対するgodocコメントとして解釈される。関数 `cleanupSessionWorktree` にはドキュメントコメントがない状態になっている。
- **推奨修正**:
  ```go
  // worktreeCleanupParams holds parameters for cleanupSessionWorktree.
  type worktreeCleanupParams struct { ... }

  // cleanupSessionWorktree removes a worktree after session destruction.
  // Called only when the user explicitly chose to delete the worktree.
  func (a *App) cleanupSessionWorktree(params worktreeCleanupParams) {
  ```

### I-2: `LookupErr` フィールドの設計上の懸念
- **レビュー観点**: type-design-analyzer
- **ファイル**: `app_session_api.go:180-186`
- **説明**: データフィールド（`SessionName`, `WtPath`, `RepoPath`, `BranchName`）とエラー状態（`LookupErr`）が同一構造体に混在している。`LookupErr != nil` の場合、他のフィールドは部分的にしか設定されない。これは「パラメータ構造体」の責務を超えている。
- **推奨修正**: `LookupErr` を構造体から分離し、呼び出し元（KillSession）で事前にガードする方式に変更する:
  ```go
  // KillSession内:
  if deleteWorktree {
      if wtErr != nil {
          slog.Warn(...)
          a.emitWorktreeCleanupFailure(sessionName, "", wtErr)
      } else if worktreeInfo != nil {
          a.cleanupSessionWorktree(worktreeCleanupParams{...})
      }
  }
  ```

### I-3: `ListBranches`からの`PruneWorktrees`削除理由がコードに記載されていない
- **レビュー観点**: cross-cutting / comment-analyzer
- **ファイル**: `app_worktree_api.go:334`
- **説明**: `PruneWorktrees()`コールが削除されたが、なぜ不要なのかの説明コメントがない。将来の開発者が再追加する可能性がある。`ListBranchesForWorktreeBase()`は`git for-each-ref refs/heads`と`refs/remotes`を使用しており、worktreeメタデータには依存しないため、削除自体は安全。残存呼び出し箇所（4箇所）もすべて書き込み操作後の適切な位置。
- **推奨修正**: 1行コメントを追加:
  ```go
  // NOTE: PruneWorktrees is not needed here — ListBranchesForWorktreeBase uses git refs, not worktree metadata.
  return repo.ListBranchesForWorktreeBase()
  ```

### I-4: デバッグログタグ `[DEBUG-kill]` が命名規約と不整合
- **レビュー観点**: cross-cutting / code-reviewer
- **ファイル**: `app_session_api.go:155` (及び同ファイル内の他の`[DEBUG-kill]`箇所)
- **説明**: コードベース全体では `[DEBUG-GIT]`、`[DEBUG-SESSION]`、`[DEBUG-SHIM]`、`[DEBUG-CONPTY]`、`[DEBUG-EVENT]` など大文字コンポーネント名を使用しているが、`[DEBUG-kill]` のみ小文字。grep一括削除時に漏れるリスクがある。
- **推奨修正**: `[DEBUG-SESSION]` または `[DEBUG-KILL]` に統一

---

## Suggestions (12件)

### S-1: `cleanupOrphanedLocalWorktreeBranch` の `repo == nil` パスに対するテスト不足
- **レビュー観点**: pr-test-analyzer
- **ファイル**: `app_session_api_test.go`
- **説明**: "empty branch name" テストは追加されたが、分離されたもう一方の条件（`repo == nil` で `slog.Debug` が出力されるパス）を直接テストするケースがない。`cleanupOrphanedLocalWorktreeBranch(nil, "some-branch")` を呼び出しpanicしないことを確認するテストの追加を検討。

### S-2: `cleanupOrphanedLocalWorktreeBranch` のログフィールド対称性
- **レビュー観点**: code-reviewer
- **ファイル**: `app_session_api.go:242-255`
- **説明**: `repo == nil` のケースでは `branchName` をログに出力しているのに対し、`branchName == ""` のケースでは branch を出力していない。デバッグ時の可読性のため、両方とも同じフィールドセットをログに含めると有用。

### S-3: `containsUpstreamToken` の `"upstream"` マッチの過剰マッチリスク
- **レビュー観点**: silent-failure-hunter / code-reviewer
- **ファイル**: `internal/git/git.go:289`
- **説明**: `strings.Contains(errMsg, "upstream")` は `@{u}` と `@{upstream}` を含む時点で冗長であり、`"upstream"` を偶然含む無関係なエラーメッセージもマッチさせてしまうリスクがある。テストに `"fatal: 'refs/upstream/main' is not a valid ref"` → 期待値 `false` を追加して挙動を検証すべき。

### S-4: `runGitCommandInDir` ヘルパーでの `dir` 出力追加
- **レビュー観点**: pr-test-analyzer
- **ファイル**: `internal/git/git_test.go:230`
- **説明**: 失敗時に `t.Fatalf` で即座にテスト終了するが、失敗したコマンドの `dir` も出力するとデバッグが容易になる。`t.Fatalf("git %v in %s failed: ..."`, args, dir, ...)`

### S-5: `TestListBranchesForWorktreeBase` の "upstream gone" テストでgit前提条件のコメント
- **レビュー観点**: pr-test-analyzer
- **ファイル**: `internal/git/git_test.go`
- **説明**: `git push origin --delete feature/gone` 後に `git fetch --prune` を実行していない。bare → clone構成のため直接push deleteで問題ないが、git動作の前提を明示するコメントがあると安心。

### S-6: HEADブランチ削除の防御テスト追加
- **レビュー観点**: pr-test-analyzer
- **ファイル**: `internal/git/git_test.go`
- **説明**: 現在チェックアウト中のブランチに対する `CleanupLocalBranchIfOrphaned` の呼び出しテストがない。gitコマンドが適切にエラーを返すことを確認するテストがあると防御力が向上する。

### S-7: リモートありだがローカルブランチがリモートにないケースのテスト
- **レビュー観点**: pr-test-analyzer
- **ファイル**: `internal/git/git_test.go`
- **説明**: `TestCleanupLocalBranchIfOrphaned` の "orphan branch is deleted" ケースはリモートなしのローカルリポジトリで実行されている。リモートが存在するがそのブランチがリモートにない（upstream trackingもgone）というケースのテスト追加が推奨。

### S-8: `broadcastEnvironmentSettingChange` の `result` 変数未読み取りコメント
- **レビュー観点**: code-reviewer
- **ファイル**: `internal/install/shim_path_windows.go:153`
- **説明**: `result` 変数は syscall 後に読み取られていない。意図的に未使用であることを示すコメントがあると、レビュアーの疑問を防げる。例: `var result uintptr // populated by SendMessageTimeoutW; not inspected here`

### S-9: リトライ上限超過エラーメッセージに試行回数を含める
- **レビュー観点**: code-reviewer
- **ファイル**: `internal/install/shim_path_windows.go:147`
- **説明**: `"retry limit exceeded"` に `maxReadAttempts` の値も含めるとデバッグ時に有用。例: `fmt.Errorf("read user PATH from registry: retry limit exceeded (%d attempts)", maxReadAttempts)`

### S-10: `Resize` の `hpCon == 0` ガード追加検討
- **レビュー観点**: code-reviewer / type-design-analyzer
- **ファイル**: `internal/terminal/conpty_windows.go:238-240`
- **説明**: `doClose` で `c.hpCon = 0` にゼロクリアしているが、`Close()` 後に `Resize()` が呼ばれると `resizePseudoConsole(0, coord)` が実行される。Windows APIにハンドル `0` の保証がないため、`Resize` 先頭にガード追加が望ましい。

### S-11: `WaitForSingleObject` の ret 値をフォーマット表示
- **レビュー観点**: code-reviewer
- **ファイル**: `internal/terminal/conpty_windows.go:230-232`
- **説明**: `ret` の値は `WAIT_OBJECT_0 (0)`, `WAIT_TIMEOUT (0x102)`, `WAIT_FAILED (0xFFFFFFFF)` のいずれか。`fmt.Sprintf("0x%X", ret)` にするか文字列化ヘルパーを使うと可読性が向上。

### S-12: `doClose` 内の `c.pi` nil化の検討
- **レビュー観点**: cross-cutting / code-reviewer
- **ファイル**: `internal/terminal/conpty_windows.go:258`
- **説明**: `c.hpCon = 0` と同様に、`closeHandles` 後に `c.pi` もnil化すると、`hpCon` のゼロクリアと一貫性が取れる。

---

## Strengths (良い点)

### 全体
- **前回レビュー指摘への的確な対応**: 5パラメータ問題の構造体化、read系APIからのwrite副作用除去、nil/空文字チェック分離とデバッグログ追加など、前回指摘が正確に反映されている
- **デバッグログプレフィックスの一貫使用**: `[DEBUG-GIT]`, `[DEBUG-SHIM]`, `[DEBUG-CONPTY]` が統一されており一括削除が容易

### Session/Worktree API
- `worktreeCleanupParams` は非公開型で適切なスコープ設計。命名もコードベース内の既存パターンと一貫
- テスト更新が完全（3つのサブテスト全てが構造体呼び出しに更新、新テストケース追加）

### Git Internal
- `TestCleanupLocalBranchIfOrphaned` と `TestListBranchesForWorktreeBase` は実gitリポジトリ統合テストとして優秀。setup/assertions/verify分離の構造は可読性が高い
- `wantErrContains` によるエラーメッセージ部分マッチ検証は良い手法
- bareリポジトリ、clone、ローカルのみ、壊れたリポジトリなど多様な構成をカバー

### Windows Install
- レジストリリトライのERROR_MORE_DATA対応は堅実。ループ上限、即座リトライ（レジストリ操作はプロセス内バッファ再確保のみ）、型再検証の正確性
- `SendMessageTimeoutW` の `lpdwResult` 修正はWindows API仕様に忠実

### Windows Terminal
- `runtime.KeepAlive(envBlock)` は正しい位置に配置。Go unsafe+syscallパターンの重要なGCリスク対策
- `hpCon = 0` ゼロクリアは `sync.Once` との二重防御で堅牢
- ログフィールド名 `"error"` → `"wait_ret"` の変更で構造化ログの曖昧さを解消

---

## 横断的影響分析

| 確認項目 | 判定 | 備考 |
|---------|------|------|
| `PruneWorktrees`削除の行動変更 | ✅ 安全 | `ListBranchesForWorktreeBase`はgit refsベースでworktreeメタデータ非依存。残4箇所は書き込み操作後 |
| `CleanupLocalBranchIfOrphaned`エラーチェーン | ✅ 互換 | 唯一の呼び出し元はログ出力のみ、`errors.Is()`不使用 |
| `worktreeCleanupParams`移行の完全性 | ✅ 完全 | 呼び出し箇所全3箇所（KillSession, テスト2箇所）が更新済み |
| フロントエンドへの影響 | ✅ なし | `ListBranches` API名・型は変更なし |
| テスト既存の破壊 | ✅ なし | 既存テストはすべてパス。新テストは独立 |

---

## Recommended Action

### 1. Important Issues を修正 (4件)
1. I-1: コメント配置の修正
2. I-2: `LookupErr` の構造体分離を検討
3. I-3: `PruneWorktrees` 削除理由コメント追加
4. I-4: `[DEBUG-kill]` の命名統一

### 2. Suggestions のうち優先度の高いもの (任意)
- S-1: `repo == nil` パスのテスト追加
- S-3: `containsUpstreamToken` の過剰マッチテスト追加
- S-10: `Resize` のhpConガード追加

### 3. その他のSuggestions (任意)
- 残りのSuggestions は必要に応じて対応

---

## タスク修正の並列作業可否

以下の表は、各タスクを並列に作業可能かどうかを示しています。

| # | タスク | 対象ファイル | 並列作業 | 理由 |
|---|--------|------------|----------|------|
| I-1 | コメント配置修正 | `app_session_api.go` | ⚠️ I-2と競合 | I-2と同じファイル・同じ箇所を変更するため、I-2と同時作業は不可 |
| I-2 | `LookupErr`構造体分離 | `app_session_api.go`, `app_session_api_test.go` | ⚠️ I-1と競合 | I-1と同じ箇所。さらにテストファイルも影響。I-1を先に行い、その後I-2を実施 |
| I-3 | PruneWorktrees削除コメント追加 | `app_worktree_api.go` | ✅ 他と独立 | 他のタスクと異なるファイル・異なるロジック |
| I-4 | `[DEBUG-kill]` 命名統一 | `app_session_api.go` | ⚠️ I-1/I-2と競合 | 同一ファイルだが変更箇所が離れている場合は並列可能。ただし安全のため I-1/I-2 完了後が推奨 |
| S-1 | `repo==nil` テスト追加 | `app_session_api_test.go` | ⚠️ I-2と競合 | I-2がテストファイルを変更するため、I-2完了後が安全 |
| S-3 | 過剰マッチテスト追加 | `internal/git/git_test.go` | ✅ 他と独立 | 他のタスクと異なるファイル |
| S-4 | `runGitCommandInDir` dir出力 | `internal/git/git_test.go` | ⚠️ S-3と競合 | S-3と同じファイルだが変更箇所が離れているため、注意すれば並列可能 |
| S-5 | gone テストコメント追加 | `internal/git/git_test.go` | ⚠️ S-3/S-4と競合 | 同一ファイル |
| S-6 | HEADブランチ削除テスト | `internal/git/git_test.go` | ⚠️ S-3/S-4/S-5と競合 | 同一ファイル |
| S-7 | リモートありorphanテスト | `internal/git/git_test.go` | ⚠️ S-3/S-4/S-5/S-6と競合 | 同一ファイル |
| S-8 | result変数コメント | `internal/install/shim_path_windows.go` | ✅ 他と独立 | 他のタスクと異なるファイル |
| S-9 | リトライエラーメッセージ改善 | `internal/install/shim_path_windows.go` | ⚠️ S-8と競合 | 同一ファイルだが変更箇所が離れている。注意すれば並列可能 |
| S-10 | Resize hpConガード | `internal/terminal/conpty_windows.go` | ✅ 他と独立 | 他のタスクと異なるファイル |
| S-11 | ret値フォーマット | `internal/terminal/conpty_windows.go` | ⚠️ S-10と競合 | 同一ファイルだが変更箇所が離れている |
| S-12 | pi nil化 | `internal/terminal/conpty_windows.go` | ⚠️ S-10/S-11と競合 | 同一ファイル |

### 推奨作業順序

```
並列グループ1（同時作業可能）:
  ├── I-3: PruneWorktrees コメント追加 (app_worktree_api.go)
  ├── S-3 + S-4 + S-5 + S-6 + S-7: git_test.go 関連 (まとめて1人が担当)
  ├── S-8 + S-9: shim_path_windows.go 関連 (まとめて1人が担当)
  └── S-10 + S-11 + S-12: conpty_windows.go 関連 (まとめて1人が担当)

順次グループ（上記完了後）:
  1. I-1: コメント配置修正 (app_session_api.go)
  2. I-2: LookupErr構造体分離 (app_session_api.go + テスト)
  3. I-4: [DEBUG-kill] 命名統一 (app_session_api.go)
  4. S-1: repo==nil テスト追加 (app_session_api_test.go)
```

---

## レビュー実施エージェント

| エージェント | 対象カテゴリ | 対象ファイル |
|------------|------------|------------|
| code-reviewer | Session/Worktree API | app_session_api.go, app_session_api_test.go, app_worktree_api.go |
| code-reviewer | Git Internal | internal/git/git.go, internal/git/git_test.go |
| code-reviewer | Windows Install | internal/install/shim_path_windows.go, shim_installer_windows_test.go |
| code-reviewer | Windows Terminal | internal/terminal/conpty_windows.go, conpty_syscall_windows_test.go |
| type-design-analyzer | 型設計分析 | app_session_api.go, app_session_api_test.go |
| cross-cutting-reviewer | 横断的影響分析 | 全変更ファイル |
