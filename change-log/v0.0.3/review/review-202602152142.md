# PR Review Summary — 2026-02-15 21:42

## レビュー対象

| ファイル | 変更量 | カテゴリ |
|---------|--------|---------|
| myT-x/app_session_api.go | +77 -52 | Session/Worktree API |
| myT-x/app_session_api_test.go | +44 -1 | Session/Worktree テスト |
| myT-x/app_worktree_api.go | +6 -6 | Session/Worktree API |
| myT-x/internal/git/git.go | +8 -2 | Git パッケージ |
| myT-x/internal/git/git_test.go | +441 | Git テスト |
| myT-x/internal/install/shim_installer_windows_test.go | +15 | Install テスト |
| myT-x/internal/install/shim_path_windows.go | +45 -13 | Install (Registry) |
| myT-x/internal/terminal/conpty_syscall_windows_test.go | +3 -1 | Terminal テスト |
| myT-x/internal/terminal/conpty_windows.go | +27 -5 | Terminal (ConPTY) |

合計: **+611 -54**

---

## Critical Issues (0 件)

なし

---

## Important Issues (4 件)

### I-1: KillSession で `deleteWorktree=false` 時の `wtErr != nil` ログレベルが Warn
- **ファイル**: myT-x/app_session_api.go:153-156
- **説明**: コメントに「Metadata lookup failures are non-fatal when deleteWorktree is false」と記載されており、削除を要求していない場合のメタデータ取得エラーは本質的に無害。しかし `slog.Warn` で出力しているため、worktreeメタデータ未設定のセッション削除時に正常運用でもWarnログが大量に出る可能性がある。
- **推奨**: `slog.Warn` → `slog.Debug` に変更

### I-2: フロントエンドでの `worktree:cleanup-failed` イベント購読確認
- **ファイル**: myT-x/app_session_api.go:252-263
- **説明**: `emitWorktreeCleanupFailure` が `"worktree:cleanup-failed"` イベントを発行しているが、フロントエンド（React側）でこのイベントを購読してユーザーに通知しているか要確認。購読がなければ、worktree削除失敗がユーザーに通知されない。

### I-3: Resize と Close 間の TOCTOU データ競合
- **ファイル**: myT-x/internal/terminal/conpty_windows.go:238-242
- **説明**: `Resize` が `c.hpCon == 0` をロックなしで読み取る一方、`doClose` が `closePseudoConsole(hpCon)` 後に `c.hpCon = 0` を書き込む。Go のメモリモデル上、`uintptr` の read/write は atomic ではないため、技術的にはデータ競合が存在する。
  - タイムライン: Resize で `hpCon != 0` を確認 → doClose が `closePseudoConsole` → Resize が `resizePseudoConsole` にクローズ済みハンドルを渡す
  - Windows API はクローズ済みハンドルに対して `ERROR_INVALID_HANDLE` を返すためクラッシュにはならない
  - Resize は通常フロントエンドのリサイズイベントから単一ゴルーチンで呼ばれるため、実運用リスクは低い
- **推奨**: 現時点では指摘に留める。修正する場合は `sync.Mutex` または `atomic.Uintptr` の使用を検討

### I-4: rawSize=0 時のスライス境界パニック可能性（レジストリリトライループ）
- **ファイル**: myT-x/internal/install/shim_path_windows.go:121-130
- **説明**: 初回サイズクエリが `rawSize=0` を返した場合（PATH値が空文字列）、ループ内で `buffer := make([]byte, 0)` が生成される。他プロセスが同時にPATH値を空→非空に変更した場合、`n > len(buffer)` となり `buffer[:n]` でパニックする可能性がある。旧コードでは `if rawSize > 0` ガードで回避していた。
- **推奨**: 成功時に `n > len(buffer)` ガードを追加
  ```go
  if readErr == nil {
      if n > len(buffer) {
          rawSize = n
          continue // size grew; re-read
      }
      ...
  }
  ```

---

## Suggestions (12 件)

### S-1: `worktreeCleanupParams` のフィールド数ガードテスト未作成
- **ファイル**: myT-x/app_session_api_test.go
- **説明**: CLAUDE.md のテスト方針で「structフィールド追加時 → フィールド数ガードテスト更新」が必須。非公開型のためリスクは低いが、フィールド追加時のテスト漏れ防止のために追加を推奨。

### S-2: KillSession の `deleteWorktree=true` かつ `worktreeInfo=nil` のサイレントスキップ
- **ファイル**: myT-x/app_session_api.go:162-173
- **説明**: worktree情報を持たない通常セッションに対してユーザーが `deleteWorktree=true` を指定した場合、ログもイベントも出さずに何もしない。デバッグ時の追跡のため `slog.Debug` を追加推奨。
  ```go
  } else {
      slog.Debug("[DEBUG-SESSION] deleteWorktree requested but session has no worktree metadata",
          "session", sessionName)
  }
  ```

### S-3: `cleanupSessionWorktree` の `WtPath==""` サイレントリターン
- **ファイル**: myT-x/app_session_api.go:189-191
- **説明**: `params.WtPath == ""` で無言リターン。Debug ログを追加するとデバッグ時に有用。
  ```go
  if params.WtPath == "" {
      slog.Debug("[DEBUG-GIT] skip worktree cleanup: worktree path is empty",
          "session", params.SessionName)
      return
  }
  ```

### S-4: `TestCleanupOrphanedLocalWorktreeBranchHandlesNilRepository` のアサーション不足
- **ファイル**: myT-x/app_session_api_test.go:1015-1017
- **説明**: パニックしないことのみ確認。ログ出力の検証を追加すると、期待するパスを通過していることをより確実に検証可能。

### S-5: `TestBranchTrackingInfoHasLiveUpstream` に `[ahead N]` ケース追加推奨
- **ファイル**: myT-x/internal/git/git_test.go:418-449
- **説明**: `UpstreamTrack` が `[ahead 1]` や `[ahead 1, behind 2]` のケースがない。実運用で最も一般的な状態であり、追加すると回帰検知が確実になる。
  ```go
  {
      name: "upstream with ahead/behind is live",
      info: branchTrackingInfo{Upstream: "origin/main", UpstreamTrack: "[ahead 1, behind 2]"},
      want: true,
  },
  ```

### S-6: `TestListBranchesForWorktreeBase` に「リモート存在＋全ブランチstale」ケースの不足
- **ファイル**: myT-x/internal/git/git_test.go:451-564
- **説明**: git.go のコメント「When remotes exist but every local branch is stale/non-remote, return an empty list」を直接テストするケースがない。コメントの仕様をテストで保護すべき。

### S-7: `TestIsNoUpstreamTrackingError` に `"no such ref"` + upstream トークン無しケース追加
- **ファイル**: myT-x/internal/git/git_test.go:380-416
- **説明**: `containsUpstreamToken` のガードを検証するため、`"no such ref"` パスのネガティブケースを追加推奨。
  ```go
  {
      name: "no such ref without upstream token should not be swallowed",
      errMsg: "fatal: no such ref: 'refs/heads/nonexistent'",
      want:   false,
  },
  ```

### S-8: CleanupLocalBranchIfOrphaned はカレントブランチ保護を行わない
- **ファイル**: myT-x/internal/git/git.go:135-166
- **説明**: チェックアウト中のブランチに対して `git branch -d` を実行するまで失敗を検知しない。テストでエラーが正しく返ることは確認されているが、事前に `CurrentBranch()` でチェックすれば不要な git コマンド実行を省略可能。呼び出し元が保証しているなら現状でも許容。

### S-9: リトライループ内の valueType 更新のコメント追加
- **ファイル**: myT-x/internal/install/shim_path_windows.go:135-136
- **説明**: `ERROR_MORE_DATA` ハンドラで `valueType` が更新されることは意図的な設計だが、コメントがあるとレビュアーの疑問を防げる。

### S-10: handleIO の pipe ハンドルの nil クリア未実施
- **ファイル**: myT-x/internal/terminal/conpty_windows.go:282-303
- **説明**: `c.hpCon = 0` と `c.pi = nil` は設定されているが、`ptyIn`, `ptyOut`, `cmdIn`, `cmdOut` は Close 後も nil 化されていない。`closeOnce` で二重呼び出しは防がれるため実害はないが、一貫性のため nil クリアが望ましい。

### S-11: ERROR_MORE_DATA リトライパスのテストカバレッジ不足
- **ファイル**: myT-x/internal/install/shim_installer_windows_test.go
- **説明**: `readUserPathFromRegistryWithType` のリトライロジック（ERROR_MORE_DATA, 型不整合, リトライ上限超過）のユニットテストが存在しない。`registry.Key` はインターフェースではないためモック化が困難だが、将来的なテスト容易性の向上を検討する価値がある。

### S-12: `ListBranchesForWorktreeBase` のコメント位置
- **ファイル**: myT-x/internal/git/git.go:121-123
- **説明**: `return filtered, nil` のコメント「When remotes exist but every local branch is stale...」は `filtered` が空でない場合（正常フィルタ結果返却）にも到達するパスに付与されている。コメントは filtered 空の場合のみを説明しており、位置を調整するか両ケースをカバーする記述にすると正確性が向上する。

---

## Positive Observations (11 件)

### P-1: `worktreeCleanupParams` 構造体への変更
パラメータの意味が明確になり、将来のフィールド追加にも対応しやすい。Clean Architecture/SOLID に合致。

### P-2: `cleanupOrphanedLocalWorktreeBranch` の nil/empty 分離
`repo == nil` と `branchName == ""` の個別チェック＋Debug ログで原因特定が容易に。

### P-3: `ListBranches` から `PruneWorktrees()` 除去
`ListBranchesForWorktreeBase` は `git for-each-ref` で refs を直接読むため worktree メタデータに非依存。不要な外部コマンド実行の省略でパフォーマンス向上。

### P-4: `[DEBUG-SESSION]` タグ統一
ログフィルタリングが容易になり、CLAUDE.md の「デバッグ用としてログ名を統一」要件に準拠。

### P-5: `containsUpstreamToken` の安全性向上
`"upstream"` 汎用マッチ削除は正しい改善。`@{u}` / `@{upstream}` のみマッチで誤判定リスクを排除。

### P-6: `CleanupLocalBranchIfOrphaned` エラーラッピング改善
`%q` でブランチ名クォート、`%w` で元エラーラップは Effective Go 準拠。

### P-7: テストヘルパー設計品質
`runGitCommandInDir` / `assertBranchPresence` は `t.Helper()` 正しく使用。テーブル駆動テストの setup/assertions/verify 分離で可読性向上。

### P-8: テストカバレッジの網羅性
`TestCleanupLocalBranchIfOrphaned` (8ケース)、`TestListBranchesForWorktreeBase` (6ケース) で主要パスを網羅。

### P-9: SendMessageTimeoutW の lpdwResult 修正
`uintptr(unsafe.Pointer(&result))` を渡す修正は MSDN 仕様に忠実。

### P-10: `runtime.KeepAlive(envBlock)` の追加
CreateProcess 中の GC による UTF-16 環境ブロック回収を防止。配置位置も正確。

### P-11: doClose の防御的ゼロクリア + formatWaitResult
`hpCon = 0`, `pi = nil` のゼロクリアで堅牢性向上。`formatWaitResult` による構造化ログの可読性向上も適切。

---

## 全体サマリー

| 重要度 | 件数 |
|--------|------|
| **Critical** | 0 |
| **Important** | 4 |
| **Suggestion** | 12 |
| **Positive** | 11 |

全体として高品質な変更。致命的な問題はなく、主な改善ポイントはデバッグログの追加（サイレントスキップの可視化）とテストケースの補強。

---

## タスク一覧と並列修正可否

以下は指摘事項の修正タスクを整理し、**並列で作業しても競合しないか**を明示した表です。

| # | タスク | ファイル | 重要度 | 並列修正 | 補足 |
|---|--------|---------|--------|----------|------|
| I-1 | `slog.Warn` → `slog.Debug` 変更 (deleteWorktree=false 時のwtErr) | app_session_api.go:153-156 | Important | ✅ 可能 | 単一行の変更。他タスクと競合しない |
| I-2 | フロントエンドの `worktree:cleanup-failed` イベント購読確認 | frontend/ 調査 | Important | ✅ 可能 | 調査のみ。Go側変更なし |
| I-3 | Resize vs Close の TOCTOU 競合対応 | conpty_windows.go:238-242 | Important | ✅ 可能 | terminal パッケージのみ。他ファイルと独立 |
| I-4 | rawSize=0 時のパニック防止ガード追加 | shim_path_windows.go:121-130 | Important | ✅ 可能 | install パッケージのみ。他ファイルと独立 |
| S-1 | `worktreeCleanupParams` フィールド数ガードテスト | app_session_api_test.go | Suggestion | ⚠️ S-4と同一ファイル | S-4 と同時編集の場合はマージ注意 |
| S-2 | KillSession worktreeInfo=nil の Debug ログ追加 | app_session_api.go:162-173 | Suggestion | ⚠️ S-3と同一ファイル | S-3, I-1 と同一ファイルだが行が離れているため可 |
| S-3 | cleanupSessionWorktree WtPath="" の Debug ログ追加 | app_session_api.go:189-191 | Suggestion | ⚠️ S-2と同一ファイル | S-2 と同一ファイルだが行が離れているため可 |
| S-4 | TestCleanupOrphanedLocal のアサーション強化 | app_session_api_test.go | Suggestion | ⚠️ S-1と同一ファイル | S-1 と同時編集の場合はマージ注意 |
| S-5 | `[ahead N]` テストケース追加 | git_test.go | Suggestion | ⚠️ S-6, S-7と同一ファイル | 同一ファイル内の異なるテスト関数。注意すれば可 |
| S-6 | 全ブランチstale テストケース追加 | git_test.go | Suggestion | ⚠️ S-5, S-7と同一ファイル | 同一ファイル内の異なるテスト関数。注意すれば可 |
| S-7 | `"no such ref"` ネガティブケース追加 | git_test.go | Suggestion | ⚠️ S-5, S-6と同一ファイル | 同一ファイル内の異なるテスト関数。注意すれば可 |
| S-8 | CleanupLocalBranchIfOrphaned カレントブランチ保護 | git.go | Suggestion | ✅ 可能 | git パッケージのみ。テスト追加はS-5～S-7と要調整 |
| S-9 | リトライループ内の valueType コメント追加 | shim_path_windows.go | Suggestion | ✅ 可能 | I-4 と同一ファイルだが行が離れているため可 |
| S-10 | handleIO パイプハンドルの nil クリア | conpty_windows.go | Suggestion | ⚠️ I-3と同一ファイル | I-3 と同時修正する場合はマージ注意 |
| S-11 | ERROR_MORE_DATA テストカバレッジ | shim_installer_windows_test.go | Suggestion | ✅ 可能 | テストのみ。独立 |
| S-12 | ListBranchesForWorktreeBase コメント位置調整 | git.go | Suggestion | ⚠️ S-8と同一ファイル | S-8 と同一ファイルだが行が離れているため可 |

### 並列作業グループ推奨

同一ファイルの修正をグループ化し、グループ間は安全に並列作業可能：

| グループ | ファイル群 | 含むタスク | 備考 |
|---------|-----------|-----------|------|
| **A** | app_session_api.go + app_session_api_test.go | I-1, S-1, S-2, S-3, S-4 | セッション/ワークツリーAPI。1人で順番に修正推奨 |
| **B** | git.go + git_test.go | S-5, S-6, S-7, S-8, S-12 | Git パッケージ。1人で順番に修正推奨 |
| **C** | conpty_windows.go | I-3, S-10 | ConPTY。1人で修正 |
| **D** | shim_path_windows.go + shim_installer_windows_test.go | I-4, S-9, S-11 | Install パッケージ。1人で修正 |
| **E** | frontend/ (調査のみ) | I-2 | フロントエンドイベント購読確認。他と完全に独立 |

**グループ A, B, C, D, E は全て並列で修正可能**（ファイルが異なるため衝突しない）。
