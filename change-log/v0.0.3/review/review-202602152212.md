# PR Review Summary — 2026-02-15 22:12

## 変更概要

| カテゴリ | 対象ファイル | 変更行 |
|---------|-------------|--------|
| **App層 (Session/Worktree API)** | `app_session_api.go`, `app_session_api_test.go`, `app_worktree_api.go` | +223 / -74 |
| **Git パッケージ** | `internal/git/git.go`, `internal/git/git_test.go` | +492 / -4 |
| **Install パッケージ** | `internal/install/shim_path_windows.go`, `internal/install/shim_installer_windows_test.go` | +202 / -11 |
| **Terminal パッケージ** | `internal/terminal/conpty_windows.go`, `conpty_close_windows_test.go`, `conpty_syscall_windows_test.go` | +126 / -41 |
| **合計** | 10ファイル | +969 / -74 |

---

## Critical Issues (0件)

すべてのカテゴリで修正必須のクリティカルな問題は検出されませんでした。

---

## Important Issues (4件)

### I-1: `WtPath` と `RepoPath` のバリデーション不一致
- **ファイル**: `myT-x/app_session_api.go` L189, L196
- **内容**: `params.WtPath == ""` は `strings.TrimSpace` なしで比較しているのに対し、`params.RepoPath` は `strings.TrimSpace(params.RepoPath) == ""` で比較している。`WtPath` が `"  "` (空白のみ) の場合、早期リターンをすり抜けて `gitpkg.Open("  ")` に到達する。
- **推奨修正**:
  ```go
  if strings.TrimSpace(params.WtPath) == "" {
  ```

### I-2: `cleanupSessionWorktree` に `RepoPath == ""` のテストケース不足
- **ファイル**: `myT-x/app_session_api_test.go`
- **内容**: `TestCleanupSessionWorktreeSkipsWhenWorktreePathEmpty` は追加済みだが、`RepoPath == ""` (WtPath は非空) のパスをテストするケースがない。`app_session_api.go` L196-200 で Warn ログ出力 + `emitWorktreeCleanupFailure` が行われるパスが、テストで保護されていない。

### I-3: `readRegistryPathRawValueWithRetry` のテストカバレッジ不足 (3パス)
- **ファイル**: `myT-x/internal/install/shim_installer_windows_test.go`
- **内容**: 以下の3パスのテストが不足:
  1. **inconsistent value type**: `readValue` が成功するが `valueTypeRead != valueType` のケース (`shim_path_windows.go` L155)
  2. **readSizeAndType 失敗**: ERROR_MORE_DATA後の `readSizeAndType()` がエラーを返すケース (`shim_path_windows.go` L173-176)
  3. **非ERROR_MORE_DATA エラー**: `readValue` が `ERROR_ACCESS_DENIED` 等を返す即時エラーパス (`shim_path_windows.go` L183-184)

### I-4: `handleIO.Close()` にゼロハンドルガードがない
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L37-39
- **内容**: `handleIO.Close()` は `CloseHandle(h.handle)` を直接呼び出しており、handle == 0 のとき `ERROR_INVALID_HANDLE` が返る。`TestConPtyCloseClearsPipeReferences` テストは `handleIO{handle: 0}` で ConPty を構築するため、`doClose` 内で `CloseHandle(0)` が呼ばれ、`closeErr` に不要なエラーが記録される可能性がある。
- **推奨修正**:
  ```go
  func (h *handleIO) Close() error {
      if h.handle == 0 || h.handle == windows.InvalidHandle {
          return nil
      }
      return windows.CloseHandle(h.handle)
  }
  ```

---

## Suggestions (13件)

### App層

#### S-1: `cleanupOrphanedLocalWorktreeBranch` の `branchName == ""` ログに空値フィールドが冗長
- **ファイル**: `myT-x/app_session_api.go` L249-250
- **内容**: `branchName` は直前の `TrimSpace` で空文字確定のため `"branch", branchName` は常に `"branch", ""`。ログメッセージ自体で空であることは伝わっているため冗長。

#### S-2: `emitWorktreeCleanupFailure` で `wtPath=""` のフロントエンド表示確認
- **ファイル**: `myT-x/app_session_api.go` L166-168
- **内容**: `wtErr != nil` 時に `a.emitWorktreeCleanupFailure(sessionName, "", wtErr)` で `wtPath=""` を渡している。フロントエンド側でこの空のパスをどう表示するか確認が必要。

#### S-3: `cleanupOrphanedLocalWorktreeBranch` のテストをテーブル駆動化
- **ファイル**: `myT-x/app_session_api_test.go` L1089-1107
- **内容**: `repo == nil` / `branchName == ""` / 正常系 の3パスをテーブル駆動テストで統一すると網羅性が一目瞭然になる。

### Git パッケージ

#### S-4: `containsUpstreamToken` の引数がlower-case前提であることの明示
- **ファイル**: `myT-x/internal/git/git.go` L165付近
- **内容**: `containsUpstreamToken` は `errMsg` が `strings.ToLower()` 済みであることを前提としているが、関数シグネチャからはその制約が読み取れない。パラメータ名を `lowerErrMsg` にするか、GoDocに「caller must pass lowercased string」を記述すると安全。

#### S-5: `CleanupLocalBranchIfOrphaned` — ローカルリポジトリでの挙動をGoDocに明記
- **ファイル**: `myT-x/internal/git/git.go` L127付近
- **内容**: リモートなしローカルリポジトリでは `listRemoteBranchNames()` が空マップを返し、全ローカルブランチが「orphan」と判定される。呼び出し側の制御で問題ないなら、GoDocに「ローカルリポジトリでは全ブランチがorphan扱いになる」旨を明記すべき。

#### S-6: `CleanupLocalBranchIfOrphaned` — detached HEAD時の挙動コメント
- **ファイル**: `myT-x/internal/git/git.go`
- **内容**: `CurrentBranch()` が detached HEAD で `""` を返す場合、`branchName` は `ValidateBranchName` で空文字が弾かれるため安全。だが、detached HEADケースの安全性についてのコメントがあると後続開発者に明瞭。

#### S-7: `TestCleanupLocalBranchIfOrphaned` に detached HEAD + orphan ケースを追加
- **ファイル**: `myT-x/internal/git/git_test.go`
- **内容**: 現在のテストは「チェックアウト中のブランチは削除されない」ケースをカバーしているが、「detached HEAD状態で orphan ブランチを削除する」ケースが明示的にはない。

### Install パッケージ

#### S-8: `readRegistryPathRawValueWithRetry` の `n > len(buffer)` パスのコメント精度
- **ファイル**: `myT-x/internal/install/shim_path_windows.go` L157-160
- **内容**: コメントの「size grew after length query」はミスリーディング。実際にはこのパスは `rawSize == 0` のとき（`len(buffer) == 0` でAPIがサイズだけ返す場合）に主に発動する。コメントに `primarily handles the zero-initial-size case` を追記すると明確。

#### S-9: `rawSize` パラメータの負値ガード
- **ファイル**: `myT-x/internal/install/shim_path_windows.go` L140
- **内容**: `rawSize int` は負値を受け付けうる。`make([]byte, rawSize)` で負値は panic する。呼び出し元は安全だが、防御的に入口で `rawSize < 0` ガードを置くと安全性が向上。

### Terminal パッケージ

#### S-10: `Read`/`Write` のレース後エラーメッセージ統一
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L244-263
- **内容**: `RUnlock()` と `cmdOut.Read(p)` の間に `doClose` がハンドルをCloseする時間窓が存在する。この場合 `ERROR_INVALID_HANDLE` がWindowsから返り、ユーザーには意味不明なエラーが見える。戻りエラーをラップし統一メッセージに変換する対応を検討。

#### S-11: `Resize`/`Pid` のClose後テスト追加
- **ファイル**: `myT-x/internal/terminal/conpty_close_windows_test.go`
- **内容**: `TestConPtyReadWriteAfterCloseReturnErrors` で `Read`/`Write` は検証されているが、`Resize` と `Pid` のClose後テストがない。

#### S-12: `formatWaitResult` に `WAIT_ABANDONED_0` のハンドリング追加
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L338-348
- **内容**: `WaitForSingleObject` は `WAIT_ABANDONED_0 (0x80)` も返す可能性がある（プロセスハンドルでは発生しないが、defensiveに追加しておくとデバッグ時に有用）。

#### S-13: `Resize` ロック保持パターンの理由コメント
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L266-273
- **内容**: `Read`/`Write` はローカルコピー＋ロック解放パターン、`Resize` は `defer RUnlock` でロック保持パターンと異なる。I/O特性の違いによる意図的設計だが、コメントで理由を記載すると保守性向上。

---

## Positive Observations (良い点)

### App層
- **`worktreeCleanupParams` 構造体の導入**: 5引数 → 構造体化で可読性と保守性が大幅向上。フィールド名も自己説明的。
- **`KillSession` の3分岐明確化**: `wtErr != nil` / `worktreeInfo != nil` / `else` の3パスが明示的に分離。旧コードの混在した責務が正しく移動。
- **ログプレフィックスの統一**: `[DEBUG-kill]` → `[DEBUG-SESSION]` への統一でコードベース全体の命名規約と整合。
- **`ListBranches` からの `PruneWorktrees` 除去**: Read系APIからWrite副作用を除去。適切な設計判断。
- **テストの網羅性**: フィールド数ガードテスト、空パス早期リターン、nilリポジトリ、メタデータ未設定時のDebugログテスト等を網羅。

### Git パッケージ
- **チェックアウトガード**: `branch -d` のgit側エラーに頼らずアプリケーション層でガード。防御的プログラミングとして優秀。
- **`containsUpstreamToken` の over-matching 修正**: `"upstream"` 単語の部分一致から明示的トークンベースへの変更は正確。
- **テーブル駆動テストの網羅性**: `TestCleanupLocalBranchIfOrphaned` は8ケースで境界条件を丁寧にカバー。
- **`branch -d` (安全削除)の使用**: `-D` (強制) ではなく `-d` で未マージブランチの誤削除を防止。テストでもこの挙動を検証。

### Install パッケージ
- **`SendMessageTimeoutW` の `lpdwResult` 修正**: NULL渡しを安全なローカル変数ポインタに修正。正確な修正。
- **関数パラメータによるテスタビリティ確保**: クロージャ注入で各リトライパスを単体テスト可能に。Clean Architectureの好例。
- **三重バリデーション**: 型チェックが初回クエリ直後、ERROR_MORE_DATA後、リード成功時の3箇所で実施。
- **CJK文字テストの追加**: マルチバイト文字の正しいデコードを検証。

### Terminal パッケージ
- **`doClose` のローカルコピーパターン**: ロック内でフィールドをコピー＋nil化→ロック外でリソース解放。デッドロック回避の古典的パターン。
- **`closeOnce` による冪等Close**: 二重呼び出しの安全性を保証。
- **`runtime.KeepAlive(envBlock)` の配置**: GCによるenvBlockの早期回収を正しく防止。
- **I/O特性に応じたロック戦略**: Read/Writeはブロッキングなのでロック早期解放、Resizeはノンブロッキングなのでロック保持と適切に使い分け。
- **リソース解放順序**: 疑似コンソール → プロセス → パイプの順はMicrosoftドキュメントに準拠。

---

## タスク一覧と並列作業可否

以下は全てのImportant Issuesと重要度の高いSuggestionsをタスクとして整理したものです。

| # | タスク | カテゴリ | 対象ファイル | 優先度 | 並列作業 | 備考 |
|---|--------|---------|-------------|--------|---------|------|
| 1 | `WtPath` のバリデーションに `TrimSpace` を追加 | App層 | `app_session_api.go` L189 | **Important** | ✅ 可 | 1行変更。他タスクと独立 |
| 2 | `RepoPath == ""` パスのテスト追加 | App層 | `app_session_api_test.go` | **Important** | ✅ 可 | テスト追加のみ。他タスクと独立 |
| 3 | `readRegistryPathRawValueWithRetry` の3つの未テストパスのテスト追加 | Install | `shim_installer_windows_test.go` | **Important** | ✅ 可 | テスト追加のみ。他カテゴリと独立 |
| 4 | `handleIO.Close()` にゼロハンドルガード追加 | Terminal | `conpty_windows.go` L37-39 | **Important** | ✅ 可 | 他カテゴリと独立 |
| 5 | `containsUpstreamToken` のパラメータ名改善 | Git | `git.go` L165付近 | Suggestion | ✅ 可 | 他タスクと独立 |
| 6 | `CleanupLocalBranchIfOrphaned` のGoDoc強化 | Git | `git.go` L127付近 | Suggestion | ✅ 可 | コメント追加のみ。他タスクと独立 |
| 7 | detached HEAD + orphan テストケース追加 | Git | `git_test.go` | Suggestion | ✅ 可 | テスト追加のみ |
| 8 | `Resize`/`Pid` のClose後テスト追加 | Terminal | `conpty_close_windows_test.go` | Suggestion | ✅ 可 | テスト追加のみ。タスク4と独立 |
| 9 | `formatWaitResult` に `WAIT_ABANDONED_0` 追加 | Terminal | `conpty_windows.go` | Suggestion | ✅ 可 | 他タスクと独立 |
| 10 | `Resize` のロック保持理由コメント追加 | Terminal | `conpty_windows.go` | Suggestion | ✅ 可 | コメント追加のみ |
| 11 | `readRegistryPathRawValueWithRetry` のコメント精度改善 | Install | `shim_path_windows.go` L157 | Suggestion | ✅ 可 | コメント変更のみ |
| 12 | `rawSize` 負値ガード追加 | Install | `shim_path_windows.go` L140 | Suggestion | ✅ 可 | 他タスクと独立 |
| 13 | `cleanupOrphanedLocalWorktreeBranch` テーブル駆動化 | App層 | `app_session_api_test.go` | Suggestion | ✅ 可 | テストリファクタ |

### 並列作業ガイド

**全13タスクが並列作業可能です。** 各タスクは異なるファイル or ファイル内の異なる箇所を対象としており、相互に依存関係がありません。

| 作業グループ | タスク | 理由 |
|-------------|--------|------|
| **グループA: App層** | #1, #2, #13 | `app_session_api.go` と `app_session_api_test.go` のみ。他カテゴリと独立 |
| **グループB: Git** | #5, #6, #7 | `git.go` と `git_test.go` のみ。他カテゴリと独立 |
| **グループC: Install** | #3, #11, #12 | `shim_path_windows.go` と `shim_installer_windows_test.go` のみ |
| **グループD: Terminal** | #4, #8, #9, #10 | `conpty_windows.go` と `conpty_close_windows_test.go` のみ |

**グループA〜Dは全て並列実行可能です。** 各グループ内のタスクも並列実行可能ですが、同一ファイルの編集が重複する場合はマージコンフリクトに注意してください。

---

## 推奨アクション

1. **Important Issues (#1〜#4)** を優先的に修正
2. **Suggestions** のうち、テスト追加系 (#7, #8) を次に対応
3. コメント改善系 (#5, #6, #9, #10, #11) は任意のタイミングで
4. 修正後に再度レビューを実行して検証
