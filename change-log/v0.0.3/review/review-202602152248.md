# PR Review Summary — 2026-02-15 22:48

## レビュー対象

| カテゴリ | 変更ファイル |
|---------|------------|
| **Terminal/ConPTY** | `myT-x/internal/terminal/conpty_windows.go`<br>`myT-x/internal/terminal/conpty_close_windows_test.go`<br>`myT-x/internal/terminal/conpty_syscall_windows_test.go` |
| **Git内部** | `myT-x/internal/git/git.go`<br>`myT-x/internal/git/git_test.go` |
| **Install/Registry** | `myT-x/internal/install/shim_path_windows.go`<br>`myT-x/internal/install/shim_installer_windows_test.go` |
| **App Session API** | `myT-x/app_session_api.go`<br>`myT-x/app_session_api_test.go`<br>`myT-x/app_worktree_api.go` |

## レビュー手法

6つの専門レビューエージェントを並列実行:
1. **code-reviewer** — ConPTY/Terminal コード品質
2. **code-reviewer** — Git/Session/Worktree コード品質
3. **code-reviewer** — Registry/Install コード品質
4. **pr-test-analyzer** — テストカバレッジ分析
5. **silent-failure-hunter** — サイレント障害検出
6. **code-simplifier** — 簡略化提案

---

## Critical Issues (1件)

### C-1: `readRegistryPathRawValueWithRetry` テスト — `n < 0` パス未テスト
- **エージェント**: pr-test-analyzer
- **ファイル**: `myT-x/internal/install/shim_path_windows.go` L144-146 / `myT-x/internal/install/shim_installer_windows_test.go`
- **内容**: `readRegistryPathRawValueWithRetry` 内の成功読み取り後の `n < 0` チェック（L144: `if n < 0 { return ... "invalid read size %d" }`）に対するテストが存在しない。既存テスト「returns error when raw size is negative」は初期 `rawSize < 0` ガード（L135）のテストであり、別のコードパス。
- **修正案**: `readValue` コールバックが `(negative_n, SZ, nil)` を返すテストケースを `TestReadRegistryPathRawValueWithRetry` に追加。

---

## Important Issues (4件)

### I-1: Read/Write の TOCTOU 設計判断をコメントで明示すべき
- **エージェント**: code-reviewer (ConPTY)
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L232-253
- **内容**: `Read`/`Write` は `RLock` 解放後に実I/Oを行う。この間に `doClose` が先行してハンドルを Close する可能性がある。結果として `ERROR_INVALID_HANDLE` が返り `normalizeConPtyPipeError` で適切にラップされる。動作的には正しいが、`Resize` メソッドにだけこの設計コメントがあり、`Read`/`Write` には無い。
- **修正案**: `Read`/`Write` にも以下のようなコメントを追加:
  ```go
  // Read may race with Close: if Close runs between RUnlock and ReadFile,
  // the OS returns ERROR_INVALID_HANDLE/ERROR_BROKEN_PIPE, which
  // normalizeConPtyPipeError converts to a clear "closed" message.
  // Holding the lock during blocking I/O would risk deadlock with Close.
  ```

### I-2: `handleIO.Close()` がハンドル値をゼロ化しない
- **エージェント**: code-reviewer (ConPTY), silent-failure-hunter
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L37-42
- **内容**: `Close()` は `CloseHandle` を呼ぶが、`h.handle` を 0 にリセットしない。現在は `closeOnce` で保護されているため実害は無いが、防御的に Close 後にハンドルを無効化すると将来的な double-close 事故を防げる。
- **修正案**:
  ```go
  func (h *handleIO) Close() error {
      if h.handle == 0 || h.handle == windows.InvalidHandle {
          return nil
      }
      err := windows.CloseHandle(h.handle)
      h.handle = windows.InvalidHandle
      return err
  }
  ```

### I-3: `formatWaitResult` テストカバレッジ不足
- **エージェント**: pr-test-analyzer
- **ファイル**: `myT-x/internal/terminal/conpty_close_windows_test.go` L108
- **内容**: `formatWaitResult` は5分岐（WAIT_OBJECT_0, WAIT_ABANDONED, WAIT_TIMEOUT, WAIT_FAILED, default）だが、テストは `WAIT_ABANDONED` の1ケースのみ。テーブル駆動テストで全分岐を網羅すべき。
- **修正案**: テーブル駆動テストに `WAIT_OBJECT_0`, `WAIT_TIMEOUT`, `WAIT_FAILED`, 任意の値 を追加。

### I-4: `cleanupOrphanedLocalWorktreeBranch` エラーパスのテスト不足
- **エージェント**: pr-test-analyzer
- **ファイル**: `myT-x/app_session_api.go` L252-258 / `myT-x/app_session_api_test.go`
- **内容**: `CleanupLocalBranchIfOrphaned` がエラーを返した場合、`cleanupOrphanedLocalWorktreeBranch` は `slog.Warn` でログ出力するが return しない。この「ログ出力されるがエラーが伝播しない」パスを検証するテストが存在しない。
- **修正案**: テスト用のモックリポジトリで `CleanupLocalBranchIfOrphaned` がエラーを返すケースを作成し、ログ出力を検証するテストを追加。

---

## Suggestions (11件)

### S-1: `doClose` パイプClose呼び出しのループ化
- **エージェント**: code-simplifier
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L321-340
- **内容**: 4つの `*handleIO` に対する同一パターン（nil-check → Close → firstErr 更新）をループで簡潔にできる。Go 1.25 なら `errors.Join` も利用可能。
- **修正案**:
  ```go
  for _, closer := range []*handleIO{ptyIn, ptyOut, cmdIn, cmdOut} {
      if closer != nil {
          if err := closer.Close(); err != nil && firstErr == nil {
              firstErr = err
          }
      }
  }
  ```

### S-2: `Resize` の int16 オーバーフロー防御
- **エージェント**: code-reviewer (ConPTY)
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L259, L75
- **内容**: `int16(width)` は width > 32767 で無音にオーバーフローする。ターミナルサイズでは現実的に起きないが、バリデーションがあると安心。

### S-3: `formatWaitResult` の `uint32(windows.WAIT_TIMEOUT)` キャストにコメント追加
- **エージェント**: code-simplifier
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L351
- **内容**: `WAIT_TIMEOUT` は `syscall.Errno`（uintptr）型で定義されているため `uint32` キャストが必要。他の定数はそのまま使える。この差の理由が不明瞭なのでコメントを追加。

### S-4: `TerminateProcess` 失敗時のログレベル昇格
- **エージェント**: silent-failure-hunter
- **ファイル**: `myT-x/internal/terminal/conpty_windows.go` L313-315
- **内容**: `TerminateProcess` が失敗するとゾンビプロセスが残存する可能性がある。現在 `slog.Debug` だが `slog.Warn` に昇格する方が運用上安全。

### S-5: `readRegistryPathRawValueWithRetry` — `n > len(buffer)` パスのコメント修正
- **エージェント**: code-reviewer (Registry)
- **ファイル**: `myT-x/internal/install/shim_path_windows.go` L153-154
- **内容**: コメントが「zero-length 初期バッファで API が最初のデータ読み取りで必要バイト数を返す」と説明しているが、実際の Windows API は `ERROR_MORE_DATA` を返す。コメントを「モック/カスタムリーダー用の防御的パス」に修正する方が正確。

### S-6: `normalizeConPtyPipeError(nil)` パスのテスト追加
- **エージェント**: pr-test-analyzer
- **ファイル**: `myT-x/internal/terminal/conpty_close_windows_test.go`
- **内容**: `normalizeConPtyPipeError("op", nil)` → `nil` パスのテストがない。ガード節のカバレッジ向上。

### S-7: `CleanupLocalBranchIfOrphaned` — `CurrentBranch()` エラーパステスト追加
- **エージェント**: pr-test-analyzer
- **ファイル**: `myT-x/internal/git/git_test.go`
- **内容**: `CurrentBranch()` がエラーを返すパスで `"failed to determine current branch before orphan cleanup"` メッセージが返されることを検証するテストがない。

### S-8: `selectPathRegistryValueType` の GoDoc に未知型の戻り値仕様を明記
- **エージェント**: code-reviewer (Registry)
- **ファイル**: `myT-x/internal/install/shim_path_windows.go` L198-211
- **内容**: default ケースで未知型をそのまま返す動作について、呼び出し元でバリデーションが必要であることを GoDoc に明記すると将来の利用者のミス防止になる。

### S-9: `listRemoteBranchNames` のリモート名にスラッシュが含まれる場合の防御コメント
- **エージェント**: code-reviewer (Git)
- **ファイル**: `myT-x/internal/git/git.go` L230-257
- **内容**: `SplitN(refName, "/", 2)` で `origin/feature/foo` → `feature/foo` は正しいが、リモート名にスラッシュが含まれる場合（`my/remote/branch`）は不正なパースになる。実用上は問題ないが、コメントで説明すると安心。

### S-10: `cleanupSessionWorktree` で `gitpkg.Open(repoPath)` 失敗時のテスト追加
- **エージェント**: pr-test-analyzer
- **ファイル**: `myT-x/app_session_api.go` L203-207 / `myT-x/app_session_api_test.go`
- **内容**: `Open` 失敗パスの `emitWorktreeCleanupFailure` イベント発行をテストするケースがない。既存テスト `TestCleanupSessionWorktreeEmitsFailureWhenRepoPathEmpty` はRepoPath空文字のチェックだけ。

### S-11: テスト「handles size growth after initial zero-length query」でバッファサイズ検証
- **エージェント**: pr-test-analyzer, code-reviewer (Registry)
- **ファイル**: `myT-x/internal/install/shim_installer_windows_test.go` L245-275
- **内容**: モックの初回呼び出し時に `len(buffer) == 0` を検証するアサーションを追加すると、テストの意図がより正確になる。

---

## Strengths (正の評価点)

| # | 対象 | 評価 |
|---|------|------|
| P-1 | **ConPTY sync.Once + RWMutex パターン** | Close の冪等性と Read/Write の並行安全性を正しく実現。copy-under-lock パターンでデッドロック回避。 |
| P-2 | **runtime.KeepAlive(envBlock)** | CreateProcess が UTF-16 環境ブロック読み取り中の GC 回収問題を正確に防御。 |
| P-3 | **doClose リソース解放順序** | pseudo console → プロセス待機 → プロセスハンドル → パイプの順序が ConPTY ライフサイクルに合致。 |
| P-4 | **normalizeConPtyPipeError の %w ラップ** | errors.Is による原因判定が可能。テストでラップを検証済み。 |
| P-5 | **CleanupLocalBranchIfOrphaned の多層ガード** | validate → find → upstream → remote → current check → delete の段階的短絡で安全。 |
| P-6 | **branch -d（安全削除）の使用** | 未マージブランチはデータ損失なく保護される。テストで検証済み。 |
| P-7 | **readRegistryPathRawValueWithRetry のリトライ制限** | maxReadAttempts=3 で確実にバウンド。無限ループの可能性なし。 |
| P-8 | **broadcastEnvironmentSettingChange の &result 修正** | SendMessageTimeoutW の MSDN 仕様に準拠した正しいバグフィックス。 |
| P-9 | **テスト品質** | テーブル駆動テスト構造一貫、setup+verify パターン、field count guard、ヘルパー関数活用。 |
| P-10 | **KillSession の worktreeInfo 事前取得** | session kill 前にメタデータを取得し TOCTOU 回避。 |
| P-11 | **utf16UnitSize 定数化** | ハードコード `2` を `unsafe.Sizeof(uint16(0))` で自己文書化。 |
| P-12 | **エラー処理の一貫性** | 全エラーパスがログ/返却/イベント通知で明示的に処理されている。サイレント障害 Critical 0件。 |

---

## Recommended Action

1. **Critical (C-1)** を最優先で修正 — テスト追加のみなので影響範囲小
2. **Important (I-1～I-4)** を対応 — コメント追加・防御コード・テスト追加
3. **Suggestions** は任意対応 — 品質向上に寄与するが必須ではない
4. 修正後に再レビューで確認

---

## 修正タスク整理 — 並列作業可否マトリクス

以下の表は、各修正タスクを作業者が効率よく並列で処理できるかを示します。

| タスクID | 重大度 | 対象ファイル | 修正内容 | 作業時間目安 | 並列作業 | 依存関係 | 備考 |
|---------|--------|------------|---------|------------|---------|---------|------|
| **C-1** | Critical | `shim_installer_windows_test.go` | `n < 0` パスのテストケース追加 | 小 | ✅ 可能 | なし | テストファイルのみ。他タスクと独立 |
| **I-1** | Important | `conpty_windows.go` | Read/Write に TOCTOU 設計コメント追加 | 小 | ✅ 可能 | なし | コメント追加のみ。実装変更なし |
| **I-2** | Important | `conpty_windows.go` | `handleIO.Close()` で handle をゼロ化 | 小 | ⚠️ 注意 | I-1 と同一ファイル | I-1 と同時編集可だが同一セクション付近なのでコンフリクト注意 |
| **I-3** | Important | `conpty_close_windows_test.go` | `formatWaitResult` テーブル駆動テスト拡充 | 小 | ✅ 可能 | なし | テストファイルのみ。C-1 と別ファイル |
| **I-4** | Important | `app_session_api_test.go` | `cleanupOrphanedLocalWorktreeBranch` エラーパステスト追加 | 中 | ✅ 可能 | なし | テストファイルのみ。他と独立 |
| **S-1** | Suggestion | `conpty_windows.go` | doClose パイプ Close をループ化 | 小 | ⚠️ 注意 | I-1, I-2 と同一ファイル | I-1, I-2 と連続して実施推奨 |
| **S-2** | Suggestion | `conpty_windows.go` | Resize に int16 バリデーション追加 | 小 | ⚠️ 注意 | S-1 と同一ファイル | conpty_windows.go の変更はまとめて実施推奨 |
| **S-3** | Suggestion | `conpty_windows.go` | WAIT_TIMEOUT キャストにコメント追加 | 極小 | ⚠️ 注意 | S-1 と同一ファイル | 同上 |
| **S-4** | Suggestion | `conpty_windows.go` | TerminateProcess ログレベル昇格 | 極小 | ⚠️ 注意 | S-1 と同一ファイル | 同上 |
| **S-5** | Suggestion | `shim_path_windows.go` | `n > len(buffer)` パスのコメント修正 | 極小 | ✅ 可能 | なし | 独立したファイル |
| **S-6** | Suggestion | `conpty_close_windows_test.go` | `normalizeConPtyPipeError(nil)` テスト追加 | 極小 | ⚠️ 注意 | I-3 と同一ファイル | I-3 と連続して実施推奨 |
| **S-7** | Suggestion | `git_test.go` | `CurrentBranch()` エラーパステスト追加 | 小 | ✅ 可能 | なし | 独立したファイル |
| **S-8** | Suggestion | `shim_path_windows.go` | `selectPathRegistryValueType` GoDoc 追記 | 極小 | ⚠️ 注意 | S-5 と同一ファイル | S-5 と連続して実施推奨 |
| **S-9** | Suggestion | `git.go` | `listRemoteBranchNames` に防御コメント追加 | 極小 | ✅ 可能 | なし | S-7 と同一パッケージだが別ファイル |
| **S-10** | Suggestion | `app_session_api_test.go` | Open 失敗パスのテスト追加 | 小 | ⚠️ 注意 | I-4 と同一ファイル | I-4 と連続して実施推奨 |
| **S-11** | Suggestion | `shim_installer_windows_test.go` | バッファサイズ検証追加 | 極小 | ⚠️ 注意 | C-1 と同一ファイル | C-1 と連続して実施推奨 |

### 推奨作業グループ（並列実行可能な単位）

同一ファイルへの変更はコンフリクトを避けるためグループ化して**順次実施**、グループ間は**並列実施可能**です。

| グループ | タスク | 対象ファイル | 備考 |
|---------|--------|------------|------|
| **Group A** | C-1, S-11 | `shim_installer_windows_test.go` | テスト追加のみ |
| **Group B** | I-1, I-2, S-1, S-2, S-3, S-4 | `conpty_windows.go` | 実装変更 + コメント |
| **Group C** | I-3, S-6 | `conpty_close_windows_test.go` | テスト拡充 |
| **Group D** | I-4, S-10 | `app_session_api_test.go` | テスト追加 |
| **Group E** | S-5, S-8 | `shim_path_windows.go` | コメント/GoDoc 追記 |
| **Group F** | S-7 | `git_test.go` | テスト追加 |
| **Group G** | S-9 | `git.go` | コメント追加 |

**Group A〜G は全て並列実行可能**です。各グループ内は順次で行ってください。
