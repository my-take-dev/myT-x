# コードレビュー — myT-x コミット前差分レビュー

**日時**: 2025-02-15 23:26  
**対象**: `myT-x/` 配下の変更ファイル（10ファイル, +1421/-86）  
**レビュー方式**: カテゴリ別並列レビュー（6エージェント）

---

## レビュー対象ファイル一覧

| カテゴリ | ファイル | 変更量 |
|---------|---------|--------|
| Session API | `app_session_api.go` | ~73行変更 |
| Session API | `app_session_api_test.go` | ~270行追加 |
| Worktree API | `app_worktree_api.go` | ~6行変更 |
| Git パッケージ | `internal/git/git.go` | ~42行変更 |
| Git パッケージ | `internal/git/git_test.go` | ~517行追加 |
| Install (shim) | `internal/install/shim_path_windows.go` | ~90行変更 |
| Install (shim) | `internal/install/shim_installer_windows_test.go` | ~253行追加 |
| Terminal (ConPTY) | `internal/terminal/conpty_windows.go` | ~140行変更 |
| Terminal (ConPTY) | `internal/terminal/conpty_close_windows_test.go` | ~113行追加 |
| Terminal (ConPTY) | `internal/terminal/conpty_syscall_windows_test.go` | ~3行変更 |

---

## Critical（致命的）

### C-1: `KillSession` でアクティブセッション削除時に `activeSess` が更新されない
- **ファイル**: `app_session_api.go` (KillSession)
- **内容**: `RenameSession` ではアクティブセッション名を追跡・更新しているが、`KillSession` では削除対象がアクティブセッションであるかのチェックと、該当時のクリアが行われていない。削除済みセッション名が `activeSess` に残り続け、フロントエンドが存在しないセッションを「アクティブ」として参照し続ける。
- **修正案**:
  ```go
  // emitSnapshot() の前に追加:
  if a.getActiveSessionName() == sessionName {
      a.setActiveSessionName("")
  }
  ```

### C-2: `CreateSession` で `activateCreatedSession` 失敗時にスナップショットが発行されない
- **ファイル**: `app_session_api.go` (CreateSession L87-91)
- **内容**: `storeRootPath` 失敗→ロールバック時は `emitSnapshot()` が呼ばれるが、`activateCreatedSession` が失敗した場合は `emitSnapshot()` なしで即 return。バックエンドにはセッションが存在しており、フロントエンドとの状態不整合が発生する。
- **修正案**: `activateCreatedSession` 失敗時にもロールバック + `emitSnapshot()` を呼ぶ

---

## Important（重要）

### I-1: `CreateSession` で `createdName` が空文字になり得る
- **ファイル**: `app_session_api.go` L57
- **内容**: ルーターが `ExitCode: 0` を返しつつ `Stdout` が空の場合、`createdName` は空文字列になり、その後の `SetWorktreeInfo`、`storeRootPath`、`activateCreatedSession` が全て空文字列キーで実行される。
- **修正案**: `createdName` が空の場合にエラーを返すガードを追加

### I-2: `CreateSession` で `rootPath` の空文字バリデーション欠如
- **ファイル**: `app_session_api.go` L38
- **内容**: `RenameSession`、`KillSession`、`GetSessionEnv` は全て空文字チェックを行っているが、`CreateSession` は `rootPath` のトリム後に空文字チェックを行っていない。API一貫性の問題。

### I-3: `ConPtyDimensions` で int16 オーバーフロー検証がない
- **ファイル**: `conpty_windows.go` L79-83
- **内容**: `Resize()` では int16 範囲チェックが入っているが、初期作成時の `ConPtyDimensions` では検証がない。`int` → `int16` のキャストでサイレントオーバーフローが発生し得る（例: `width=40000` → `-25536`）。
- **修正案**: `startConPty` 内で `args.coord` の範囲検証を追加

### I-4: `isNoUpstreamTrackingError` のgitロケール依存性
- **ファイル**: `internal/git/git.go` L246-261
- **内容**: gitの `LC_MESSAGES` や `LANG` 環境変数によってエラーメッセージが翻訳される場合、文字列マッチングが機能しなくなる。日本語Windows環境で問題となる可能性。
- **対策案**: `runGitCLI` 実行時に `cmd.Env` で `LC_ALL=C` を設定し、gitの出力を英語に固定

### I-5: `PromoteWorktreeToBranch` でブランチ作成成功後のメタデータ更新失敗時にGit側のロールバックがない
- **ファイル**: `app_worktree_api.go` L380-403
- **内容**: `CheckoutNewBranch` 成功後に `SetWorktreeInfo` が失敗した場合、Git リポジトリにはブランチが作成された状態のまま、メタデータだけが旧状態に残る。次回リトライ時にブランチ名衝突が発生する可能性がある。

### I-6: `CreateSessionWithExistingWorktree` の `os.Stat` エラーハンドリング漏れ
- **ファイル**: `app_worktree_api.go` L700-702
- **内容**: `os.IsNotExist(err)` のみチェックしており、パーミッションエラー等の `!os.IsNotExist(err) && err != nil` が無視されて処理が続行される。
- **修正案**: `err != nil` でガード

### I-7: レジストリ Read-Then-Write の TOCTOU 競合
- **ファイル**: `shim_path_windows.go` L43-73
- **内容**: `ensurePathContains` は、レジストリを `QUERY_VALUE` で読み取り→キーを閉じ→`SET_VALUE` で再オープン→書き込みという二段階で操作している。読み取りと書き込みの間に他プロセスが PATH を変更した場合、その変更が上書きされて消失する可能性がある。
- **改善案**: 単一キーハンドルを `QUERY_VALUE|SET_VALUE` で開き、読み→計算→書き込みを同一ハンドル内で行う

### I-8: `strings.TrimSuffix(regValue, ";")` が末尾の `;` を1つだけ除去
- **ファイル**: `shim_path_windows.go` L55-59
- **内容**: レジストリの PATH が `C:\foo;;` のように複数の末尾セミコロンを持つ場合、空エントリが PATH に残る。
- **修正案**: `strings.TrimRight(regValue, ";")` を使用

### I-9: `getStartupInfoExForPTY` の `STARTF_USESTDHANDLES` 設定
- **ファイル**: `conpty_windows.go` L169
- **内容**: ConPTYでは stdio ハンドルは ConPTY 経由で制御されるため `STARTF_USESTDHANDLES` は不要。`StdInput`, `StdOutput`, `StdErr` も設定していない。Microsoft公式ConPTYサンプルでは通常このフラグを設定しない。
- **リスク**: ConPTYがI/Oを管理するため実害は少ないが、確認推奨

### I-10: `startupInfoEx.startupInfo.Cb` のサイズ計算がx64前提
- **ファイル**: `conpty_windows.go` L167
- **内容**: `unsafe.Sizeof(windows.StartupInfo{}) + unsafe.Sizeof((*byte)(nil))` はパディングを考慮していないが、Win64 では結果的に正しい値（112バイト）になる。x64前提のコメントがあると保守性向上。

### I-11: `CleanupLocalBranchIfOrphaned` の `-d` 失敗時のエラーメッセージが紛らわしい
- **ファイル**: `internal/git/git.go` L155-158
- **内容**: 未マージブランチの削除拒否時、エラーメッセージが「orphaned branchの削除に失敗」となるため、呼び出し元が「orphanedなのに削除できなかった＝バグ？」と誤解する可能性。
- **修正案**: `"failed to delete orphaned branch %q (may have unmerged commits): %w"`

---

## Suggestion（提案）

### S-1: `cleanupSessionWorktree` で worktree削除成功時にフロントエンドへの通知がない
- **ファイル**: `app_session_api.go` L183-237
- **内容**: 失敗時は `emitWorktreeCleanupFailure` で通知されるが、成功時はイベントが発行されない。UX上の問題になりうる。

### S-2: `CleanupWorktree` で通常削除失敗時のログがない
- **ファイル**: `app_worktree_api.go` L449-455
- **内容**: 通常削除が失敗して強制削除に移行する際、通常削除の失敗理由がログに残らない。`slog.Warn` を追加推奨。

### S-3: `formatWaitResult` の `WAIT_ABANDONED_0` 表記
- **ファイル**: `conpty_windows.go` L348
- **内容**: `WaitForSingleObject` では `_0` サフィックスに意味がない。`"WAIT_ABANDONED(0x80)"` の方がWindows API定数名と一致し混乱が少ない。

### S-4: `FindRepoRoot` の戻り値にWindowsパス正規化がない
- **ファイル**: `internal/git/git.go` L45-50
- **内容**: `git rev-parse --show-toplevel` がスラッシュ区切りのパスを返すことがある。`filepath.FromSlash` で正規化すべき。`ListWorktrees` では既に使用されている。

### S-5: `runSetupScripts` の最初のスクリプト失敗で全スクリプト中断
- **ファイル**: `app_worktree_api.go` L500-511
- **内容**: スクリプト間の依存関係が前提の設計と思われるが、意図を明示するコメントがあると保守性向上。

### S-6: `readRegistryPathRawValueWithRetry` のハッピーパスのテストケース追加
- **ファイル**: `shim_installer_windows_test.go`
- **内容**: エラーケースとリトライケースは網羅されているが、「初回読み取りで成功」の基本テストケースが明示的にない。

---

## テストカバレッジの主要欠落

### 優先度 高

| 対象 | 欠落テスト内容 |
|------|---------------|
| `CheckWorktreeStatus` | テストが完全に無い。全パス（worktreeなし、正常系、HasUnpushed失敗フォールバック、branchNameフォールバック）要テスト |
| `CommitAndPushWorktree` | `sessionName=""` バリデーション、`push=false` ケース、`commitMessage=""` + `push=true` ケースが不足 |
| `CreateSession` 正常系 | gitリポジトリでのメタデータ保存パスのテストが無い |
| `RenameSession` | `oldName=""` `newName=""` の個別バリデーションテストが無い |
| `KillSession` | `sessionName=""` のバリデーションエラーテストが無い |
| `ConPty.Resize` | 境界値テスト（負値、32768超、正常値）が無い |

### 優先度 中

| 対象 | 欠落テスト内容 |
|------|---------------|
| `PromoteWorktreeToBranch` | detachedでないセッション拒否テスト、空sessionNameバリデーション |
| `CreateSessionWithWorktree` | ロールバック統合テスト |
| `ValidateBranchName` | gitパッケージ内の独立テスト（現在は `app_session_api_test.go` のみ） |
| `ensurePathContains` | レジストリ書き込み側のテスト |
| UTF-16サロゲートペア | テストケースで補助文字面(U+10000以上)が未検証 |
| BOM (U+FEFF) | `decodeRegistryUTF16String` でBOM除去がない |

---

## 良い設計・変更点

| # | 対象 | 内容 |
|---|------|------|
| 1 | ConPTY | `sync.Once` による冪等Close、RWMutexによる状態保護、ロック外でのブロッキングI/O — デッドロック回避として正しい設計 |
| 2 | ConPTY | `normalizeConPtyPipeError` — Close/I/Oレースを明確なエラーメッセージに変換 |
| 3 | ConPTY | `doClose` でのパイプクローズのループ化による簡潔化 |
| 4 | Git | `exec.Command("git", args...)` でシェル非経由、インジェクション耐性あり |
| 5 | Git | `ValidateBranchName` でパストラバーサル（`..`）や危険文字をブロック |
| 6 | Git | `CleanupLocalBranchIfOrphaned` で `-d`（安全削除）を使用 |
| 7 | Git | `containsUpstreamToken` の限定マッチング（`@{u}`, `@{upstream}`）で誤マッチ低減 |
| 8 | Git | `CleanupLocalBranchIfOrphaned` のGoDocが2つのエッジケース（リモートなしリポ、detached HEAD）を正確に説明 |
| 9 | Install | `readRegistryPathRawValueWithRetry` のリトライロジック（`ERROR_MORE_DATA` 対応と回数制限） |
| 10 | Install | `broadcastEnvironmentSettingChange` での `SMTO_ABORTIFHUNG` + タイムアウト |
| 11 | Install | hashファイルによる不要な書き込みスキップ / atomicWrite (`tmp + rename`) |
| 12 | Session | Worktreeクリーンアップの多段フォールバック（通常削除→強制削除）とロールバック機構 |
| 13 | Session | `copyConfigFilesToWorktree` のパストラバーサル防御 |
| 14 | テスト全般 | テーブル駆動テストの適切な活用（`TestCleanupLocalBranchIfOrphaned` 9パターン、`TestListBranchesForWorktreeBase` 7パターン等） |
| 15 | テスト全般 | `t.Cleanup` によるグローバル状態の確実な復元 |

---

## タスク整理表 — 並列修正可否

| # | 指摘ID | 修正内容 | 対象ファイル | 並列修正 | 依存関係 |
|---|--------|---------|-------------|---------|---------|
| 1 | C-1 | KillSessionのアクティブセッション追跡 | `app_session_api.go` | ○ 可 | なし |
| 2 | C-2 | activateCreatedSession失敗時のemitSnapshot/rollback | `app_session_api.go` | ○ 可 | #1と同ファイルだが修正箇所は独立 |
| 3 | I-1 | createdName空文字ガード | `app_session_api.go` | ○ 可 | #1,#2と同ファイルだが別関数 |
| 4 | I-2 | rootPath空文字バリデーション | `app_session_api.go` | ○ 可 | #3と近い箇所だが独立 |
| 5 | I-3 | ConPtyDimensions int16オーバーフロー検証 | `conpty_windows.go` | ○ 可 | なし |
| 6 | I-4 | git LC_ALL=C設定 | `internal/git/git_cli.go` | ○ 可 | 他と独立 |
| 7 | I-5 | PromoteWorktreeToBranch ロールバック | `app_worktree_api.go` | ○ 可 | なし |
| 8 | I-6 | os.Stat エラーハンドリング修正 | `app_worktree_api.go` | ○ 可 | #7と同ファイルだが別関数 |
| 9 | I-7 | レジストリ操作の単一ハンドル化 | `shim_path_windows.go` | ○ 可 | #10と同ファイルだが別関数 |
| 10 | I-8 | TrimRight修正 | `shim_path_windows.go` | ○ 可 | #9と同ファイルだが独立 |
| 11 | I-9 | STARTF_USESTDHANDLES確認・除去 | `conpty_windows.go` | ○ 可 | #5と同ファイルだが別関数 |
| 12 | I-10 | Cbサイズ計算コメント追加 | `conpty_windows.go` | ○ 可 | #5,#11と同ファイルだが独立 |
| 13 | I-11 | エラーメッセージ改善 | `internal/git/git.go` | ○ 可 | なし |
| 14 | テスト | CheckWorktreeStatus テスト追加 | 新規test | ○ 可 | なし |
| 15 | テスト | CommitAndPushWorktree テスト追加 | 新規test | ○ 可 | なし |
| 16 | テスト | ConPty.Resize 境界値テスト | `conpty_close_windows_test.go` | ○ 可 | なし |
| 17 | テスト | RenameSession/KillSession バリデーションテスト | `app_session_api_test.go` | ○ 可 | #1完了後が望ましい |

**結論**: 全タスクが並列修正可能。同一ファイル内の修正も修正箇所が異なるため、順次適用であれば衝突しない。ただし #17（バリデーションテスト）は #1（C-1修正）の後に作成する方が、テストが最新の実装を検証できるため望ましい。
