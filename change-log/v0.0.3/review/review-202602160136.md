# PR Review Summary — 2026-02-16 01:36

## レビュー対象

myT-x 配下の未コミット差分 (13ファイル, +1809/-107行)

### カテゴリ別ファイル構成

| カテゴリ | ファイル |
|---------|---------|
| **アプリ層 (Session/Worktree API)** | `app_session_api.go`, `app_session_api_test.go`, `app_worktree_api.go`, `app_worktree_api_test.go` |
| **Git内部パッケージ** | `internal/git/command.go`, `internal/git/command_test.go`, `internal/git/git.go`, `internal/git/git_test.go` |
| **インストーラ (Shimパス管理)** | `internal/install/shim_path_windows.go`, `internal/install/shim_installer_windows_test.go` |
| **ターミナル (ConPTY)** | `internal/terminal/conpty_windows.go`, `internal/terminal/conpty_close_windows_test.go`, `internal/terminal/conpty_syscall_windows_test.go` |

---

## レビューエージェント構成

| エージェント | 対象 | 観点 |
|------------|------|------|
| code-reviewer | 全ファイル(アプリ層) | バグ, 設計, ガイドライン準拠 |
| code-reviewer | 全ファイル(Git内部) | バグ, 設計, Git CLI統合 |
| code-reviewer | 全ファイル(ConPTY) | 並行性, リソース管理, Windows API |
| code-reviewer | 全ファイル(Install/Shim) | レジストリ操作, TOCTOU, エラー処理 |
| test-analyzer | 全テストファイル | カバレッジ, テスト品質, パターン準拠 |
| simplify + error-handler | 全ソースファイル | サイレントエラー, デッドコード, ログレベル |

---

## Critical Issues (0件)

致命的な問題は検出されませんでした。

---

## Important Issues (10件)

### I-1. `CheckoutDetachedHead` / `DeleteLocalBranch` にエラーラップがない
- **ファイル**: `internal/git/git.go` L241-L256
- **内容**: 他のメソッド（`CleanupLocalBranchIfOrphaned` 等）では `fmt.Errorf("failed to ... : %w", err)` でラップしているが、新規メソッドは `runGitCommand` のエラーをそのまま返している
- **推奨**: `fmt.Errorf("failed to checkout detached HEAD: %w", err)` のようにラップを統一する

### I-2. `DeleteLocalBranch` 単体のテーブル駆動テストが不足
- **ファイル**: `internal/git/git_test.go`
- **内容**: CLAUDE.md「新規公開関数にはテーブル駆動テストが必須」に抵触
- **必要ケース**: 正常削除(`-d`), 強制削除(`-D`), 無効ブランチ名, 存在しないブランチ, チェックアウト中ブランチ

### I-3. `CheckoutDetachedHead` 単体のテストが不足
- **ファイル**: `internal/git/git_test.go`
- **内容**: 同上。最低限の正常系・異常系テストが必要

### I-4. `validateConPtyDimensions` が width=0, height=0 を許可
- **ファイル**: `internal/terminal/conpty_windows.go` L302-L308
- **内容**: `width < 0` でチェックしているが、ターミナルの幅・高さ=0は意味的に無効。Windows API `CreatePseudoConsole` / `ResizePseudoConsole` に0を渡した場合の挙動はドキュメント上未定義
- **推奨**: `width <= 0` へ変更し、テストに `width=0`, `height=0` のケースを追加

### I-5. `CreateSession` のロールバック方式が他の関数と不統一
- **ファイル**: `app_session_api.go` L93-L108
- **内容**: 手動ロールバック + 個別 `emitSnapshot()` を採用しているが、`CreateSessionWithWorktree` / `CreateSessionWithExistingWorktree` は `defer` + named return パターンを採用。手動方式は呼び出し箇所が増えるたびに `emitSnapshot()` の漏れリスクがある
- **推奨**: `defer` パターンに統一

### I-6. `shim_path_windows.go` の `setPathRegistryValue` に渡される型とログ表示型の不一致リスク
- **ファイル**: `internal/install/shim_path_windows.go` L73-L78
- **内容**: `targetValueType` はログ表示専用に計算されるが、`setPathRegistryValue` には元の `regValueType` を渡しており、内部で `selectPathRegistryValueType` を再計算。ログと実際の書き込み型がずれるリスク
- **推奨**: `setPathRegistryValue` に `targetValueType` を直接渡すか、`targetValueType` 変数を廃止

### I-7. `readRegistryPathRawValueWithRetry` の `n > len(buffer)` パスで `valueType` 未更新
- **ファイル**: `internal/install/shim_path_windows.go` L173-L179
- **内容**: `ERROR_MORE_DATA` パスでは `readSizeAndType` で `valueType` を更新しているが、`readErr == nil` かつ `n > len(buffer)` のパスでは `rawSize` のみ更新し `valueType` は更新しない。防御的パスでの一貫性に欠ける
- **推奨**: `valueType = valueTypeRead` を明示的に追加

### I-8. Read/Write後のエラーメッセージが原因区別困難
- **ファイル**: `internal/terminal/conpty_windows.go` L231-L243
- **内容**: nilチェックパスと `normalizeConPtyPipeError` パスの両方が同じ文言 `"Read called on closed pseudo console"` を返す。OS error pathは `: %w` で元エラーが付くが、nil checkパスにも原因を明示すべき
- **推奨**: `"Read called on closed pseudo console (nil handle)"` のように区別

### I-9. 非同期 Setup Script 実行中のロールバック競合リスク
- **ファイル**: `app_worktree_api.go` L156-L165
- **内容**: `activateCreatedSession` 失敗時に `defer` が worktree を削除するが、goroutine の setup script は `wtPath` で動作中の可能性がある
- **推奨**: cancelable context を goroutine に渡し、defer 内でキャンセル

### I-10. `createWorktreeForSession` 内にデタッチモードのデッドコード
- **ファイル**: `app_worktree_api.go` L174-L207
- **内容**: 呼び出し元で `BranchName == ""` を事前にエラーとして弾いているため、`isDetached=true` 分岐は到達不能。プロジェクト仕様で「後方互換不要」のため、削除して関数シグネチャを簡素化可能
- **推奨**: `isDetached` 戻り値と関連ロジックを除去

---

## Suggestions (18件)

### S-1. `WaitForSingleObject` 失敗のログレベルを Warn へ
- **ファイル**: `internal/terminal/conpty_windows.go` L261-L264
- **内容**: プロセスハンドルの Wait 失敗は想定外。直後に `TerminateProcess` で対処しているが、Debug ではフィルタされやすい

### S-2. `broadcastEnvironmentSettingChange` 失敗のログレベルを Warn へ
- **ファイル**: `internal/install/shim_path_windows.go` L72-L76
- **内容**: ブロードキャスト失敗は既存ターミナルが新しい PATH を認識しない結果につながり、ユーザー影響がある

### S-3. `findSessionByRootPath` のサイレントエラーにコメント追加
- **ファイル**: `app_session_api.go` L282-L290
- **内容**: エラー時に `""` を返す（衝突なし扱い）意図が明示されていない

### S-4. `findSessionByWorktreePath` のサイレントエラーにコメント追加
- **ファイル**: `app_worktree_api.go` L527
- **内容**: 同上

### S-5. `localeNeutralGitEnv` の防御コピーが二重コピー
- **ファイル**: `internal/git/command.go` L45-L50
- **内容**: `os.Environ()` 自体がコピーを返すため、`append([]string(nil), baseEnv...)` は冗長。防御的コーディングとして意図的であれば許容

### S-6. `conPtyDimensions` のデフォルト値を定数化
- **ファイル**: `internal/terminal/conpty_windows.go` L103-L104
- **内容**: `_COORD{X: 80, Y: 40}` がマジックナンバー

### S-7. `createEnvBlock` のdocコメントに `runtime.KeepAlive` 必須の注記
- **ファイル**: `internal/terminal/conpty_syscall_windows.go`
- **内容**: 呼び出し元が追加された場合に `KeepAlive` 忘れのリスク

### S-8. テストヘルパーの重複統合
- **ファイル**: `app_worktree_api_test.go` L15 (`runGitInDir`), `internal/git/git_test.go` L192 (`runGitCommandInDir`)
- **内容**: 同一機能。`testutil` パッケージに統合すべき

### S-9. `executeRouterRequestFn` モック差替パターンのヘルパー化
- **ファイル**: `app_session_api_test.go`, `app_worktree_api_test.go`
- **内容**: 保存→差替→Cleanup復元パターンが多数繰り返されている

### S-10. `slog.SetDefault` の並列テスト時のグローバル競合リスク
- **ファイル**: `app_session_api_test.go` L454, L505, L537
- **内容**: `t.Parallel()` を使わない前提なら問題ないが、将来的なリスク

### S-11. テスト不足: `runGitCLI` のリトライロジック直接テスト
- **ファイル**: `internal/git/command.go` L59-L95
- **内容**: index.lock コンフリクト→リトライ→成功/上限到達の重要パスにテストがない

### S-12. テスト不足: ステートフル関数の連続呼び出しシーケンステスト
- **ファイル**: `app_session_api_test.go`, `app_worktree_api_test.go`
- **内容**: Create→Rename→Kill, CreateWithWorktree→CheckStatus→Cleanup の一連フロー検証がない

### S-13. テスト不足: `readRegistryPathRawValueWithRetry` の空値成功パス
- **ファイル**: `internal/install/shim_installer_windows_test.go`
- **内容**: `rawSize=0`, `readValue` が `(0, SZ, nil)` を返す正しい空値のケース未テスト

### S-14. テスト不足: `Resize(0, 0)` の境界値テスト
- **ファイル**: `internal/terminal/conpty_close_windows_test.go`
- **内容**: I-4 を修正する場合に必須

### S-15. `CreateSession` の git メタデータ保存にベストエフォート意図のコメント追加
- **ファイル**: `app_session_api.go` L72-L86
- **内容**: `Open` / `CurrentBranch` / `SetWorktreeInfo` の失敗は Warn ログのみ。意図的だが明示されていない

### S-16. `findSessionByRootPath` の冗長な `filepath.Clean`
- **ファイル**: `app_session_api.go` L280-L282
- **内容**: `pathsEqualFold` 内部で両引数に `filepath.Clean` を再適用しているため

### S-17. `shellExecFlag` のループ外移動
- **ファイル**: `app_worktree_api.go` L272
- **内容**: `shell` はループ内で不変。`shellFlag` の算出をループ直前に移動可能

### S-18. `validateConPtyDimensions` の二重呼び出し
- **ファイル**: `internal/terminal/conpty_windows.go` L121-L127
- **内容**: `hasCustomDimensions=true` 時は同じ値が2回バリデートされる。防御的コーディング意図のコメント推奨

---

## Strengths (良い点)

### 設計品質
- **ロールバックの堅実な設計**: `CreateSessionWithWorktree` の `defer` による二段階ロールバック（セッション→worktree）
- **TOCTOU防止**: `ensurePathContains` が単一レジストリハンドルで読み書き
- **ConPTY スレッドセーフ化**: `doClose` のロック→スナップショット→アンロックパターン
- **`closeOnce` によるリソース解放の冪等性**
- **`normalizeConPtyPipeError`**: OS固有エラーの正規化 + `%w` で元エラー保持

### コード品質
- **パストラバーサル防御**: `copyConfigFilesToWorktree` での `filepath.Clean` + `HasPrefix` + セパレータ付加
- **ロケール中立化**: `localeNeutralGitEnv` でgitエラーメッセージの文字列マッチング信頼性向上
- **`containsUpstreamToken` の厳格化**: `@{u}` / `@{upstream}` のみにマッチさせ誤検出防止
- **`runtime.KeepAlive(envBlock)`**: CreateProcess中のGCリスクの正しい対処
- **UTF-16 デコード**: BOM除去、CJK文字、奇数バイト長のエッジケース対応

### テスト品質
- **構造体フィールド数ガード**: `worktreeCleanupParams`, `WorktreeSessionOptions`, `WorktreeStatus` に存在
- **`TestCleanupLocalBranchIfOrphaned`**: 10シナリオの網羅的テーブル駆動テスト
- **`readRegistryPathRawValueWithRetry`**: 10ケースの包括的リトライテスト
- **デバッグログの統一命名**: `[DEBUG-SESSION]`, `[DEBUG-GIT]`, `[DEBUG-CONPTY]`, `[DEBUG-SHIM]`

---

## タスク整理 — 並列作業可否表

| # | タスク | 対象ファイル | 優先度 | 並列作業 | 備考 |
|---|-------|------------|--------|---------|------|
| 1 | `CheckoutDetachedHead` にエラーラップ追加 | `internal/git/git.go` | Important | ✅ 可 | 他タスクと独立 |
| 2 | `DeleteLocalBranch` にエラーラップ追加 | `internal/git/git.go` | Important | ⚠️ #1と同ファイル | #1と同時に対応推奨 |
| 3 | `DeleteLocalBranch` のテーブル駆動テスト追加 | `internal/git/git_test.go` | Important | ✅ 可 | #2完了後が理想だが独立テストとしても可 |
| 4 | `CheckoutDetachedHead` のテスト追加 | `internal/git/git_test.go` | Important | ⚠️ #3と同ファイル | #3と同時に対応推奨 |
| 5 | `validateConPtyDimensions` を `<= 0` に変更 | `internal/terminal/conpty_windows.go` | Important | ✅ 可 | 他ファイルと独立 |
| 6 | `Resize(0,0)` テストケース追加 | `internal/terminal/conpty_close_windows_test.go` | Important | ⚠️ #5と同モジュール | #5完了後が理想 |
| 7 | `CreateSession` のロールバックを defer パターンに統一 | `app_session_api.go` | Important | ✅ 可 | 影響範囲が広いため慎重に |
| 8 | Read/Write nil チェックのエラーメッセージに原因付加 | `internal/terminal/conpty_windows.go` | Important | ⚠️ #5と同ファイル | #5と同時に対応推奨 |
| 9 | `setPathRegistryValue` への型渡し整理 | `internal/install/shim_path_windows.go` | Important | ✅ 可 | 他ファイルと独立 |
| 10 | `readRegistryPathRawValueWithRetry` の `valueType` 一貫性修正 | `internal/install/shim_path_windows.go` | Important | ⚠️ #9と同ファイル | #9と同時に対応推奨 |
| 11 | `createWorktreeForSession` のデッドコード除去 | `app_worktree_api.go` | Important | ✅ 可 | 関数シグネチャ変更のため呼び出し元も変更 |
| 12 | Setup Script goroutine への cancelable context 渡し | `app_worktree_api.go` | Important | ⚠️ #11と同ファイル | #11完了後に対応推奨 |
| 13 | `WaitForSingleObject` ログレベル Debug→Warn | `internal/terminal/conpty_windows.go` | Suggestion | ⚠️ #5,#8と同ファイル | まとめて対応推奨 |
| 14 | `broadcastEnvironmentSettingChange` ログレベル Debug→Warn | `internal/install/shim_path_windows.go` | Suggestion | ⚠️ #9,#10と同ファイル | まとめて対応推奨 |
| 15 | テストヘルパー `runGitInDir` の `testutil` 統合 | `testutil/`, `app_worktree_api_test.go`, `git_test.go` | Suggestion | ✅ 可 | |
| 16 | `executeRouterRequestFn` モックヘルパー化 | `app_session_api_test.go`, `app_worktree_api_test.go` | Suggestion | ✅ 可 | テストのみ変更 |
| 17 | `findSessionByRootPath`, `findSessionByWorktreePath` にコメント追加 | `app_session_api.go`, `app_worktree_api.go` | Suggestion | ✅ 可 | コメントのみ |
| 18 | デフォルト ConPTY 次元値の定数化 | `internal/terminal/conpty_windows.go` | Suggestion | ⚠️ #5,#8,#13と同ファイル | まとめて対応推奨 |

### 並列作業の推奨グループ

以下のグループ内のタスクは**同一ファイルまたは強い依存関係**があるため、**グループ内は順次作業**、**グループ間は並列作業が可能**です。

| グループ | タスク | ファイル | 理由 |
|---------|--------|---------|------|
| **A: Git内部パッケージ** | #1, #2, #3, #4 | `git.go`, `git_test.go` | 同一ファイル群に対する変更 |
| **B: ConPTY** | #5, #6, #8, #13, #18 | `conpty_windows.go`, `conpty_close_windows_test.go` | 同一ファイル群に対する変更 |
| **C: Install/Shim** | #9, #10, #14 | `shim_path_windows.go` | 同一ファイルに対する変更 |
| **D: アプリ層 (Session)** | #7, #17 | `app_session_api.go` | 同一ファイルに対する変更 |
| **E: アプリ層 (Worktree)** | #11, #12 | `app_worktree_api.go` | 同一ファイル、#11がシグネチャ変更 |
| **F: テスト整理** | #15, #16 | テストファイル群 | 他グループと独立 |

```
並列作業フロー:
  A (#1→#2→#3→#4)  ←── 並列可 ──→  B (#5→#6→#8→#13→#18)
         ↓                                  ↓
  C (#9→#10→#14)   ←── 並列可 ──→  D (#7→#17)
         ↓                                  ↓
  E (#11→#12)      ←── 並列可 ──→  F (#15→#16)
```

### 作業者向け注意事項

- **グループ A, B, C** は相互に完全独立。3名が同時に着手可能
- **グループ D (#7)** は `CreateSession` のロールバック方式変更であり、テストも影響するため慎重に
- **グループ E (#11)** は `createWorktreeForSession` の戻り値変更を伴い、呼び出し元 (`CreateSessionWithWorktree` 内) も変更が必要
- **グループ F** はリファクタリングのみ。機能に影響なし
- Important タスクを全て完了してから Suggestion に着手することを推奨
