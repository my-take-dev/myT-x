# PR Review: myT-x 未コミット変更レビュー

**日時**: 2026-02-16 04:35  
**対象**: myT-x 配下の未コミット変更ファイル（13ファイル、+2100/-429行）  
**レビュー方式**: カテゴリ別並列レビュー + テスト品質横断レビュー

---

## 対象ファイル一覧

| カテゴリ | ファイル | 変更概要 |
|---------|--------|---------|
| A (App層) | app_session_api.go | セッション作成/Kill/リネーム、ロールバック、worktreeクリーンアップ |
| A (App層) | app_session_api_test.go | セッションライフサイクルテスト（+341行） |
| A (App層) | app_worktree_api.go | Worktreeセッション作成、ブランチプロモーション、ロールバック |
| A (App層) | app_worktree_api_test.go | rollbackPromotedWorktreeBranch、バリデーションテスト |
| B (Git) | internal/git/command.go | セマフォ制御、指数バックオフリトライ、ロケール中立env |
| B (Git) | internal/git/command_test.go | isLockFileConflict、upsertEnvVar、localeNeutralGitEnv |
| B (Git) | internal/git/git.go | ブランチ追跡、orphanクリーンアップ、checkout/delete |
| B (Git) | internal/git/git_test.go | ブランチ操作、クリーンアップ、upstream追跡テスト（+700行） |
| C (Install) | internal/install/shim_path_windows.go | レジストリPATH管理、リトライ、UTF-16デコード |
| C (Install) | internal/install/shim_installer_windows_test.go | PATH操作、レジストリリトライ、UTF-16テスト |
| D (Terminal) | internal/terminal/conpty_windows.go | ConPTYライフサイクル、sync.Once close、RWMutex状態保護 |
| D (Terminal) | internal/terminal/conpty_close_windows_test.go | close冪等性、post-close操作、次元バリデーション |
| D (Terminal) | internal/terminal/conpty_syscall_windows_test.go | envブロック関連の軽微変更 |

---

## カテゴリA: App層（app_session_api.go / app_worktree_api.go）レビュー

### Critical Issues（致命的）

なし

### Important Issues（重要）

#### A-I1: パッケージレベル関数変数が t.Parallel() を阻害

**対象**: app_session_api.go, app_worktree_api.go  
**重要度**: 中（テスト設計）

`executeRouterRequestFn`、`currentBranchFn`、`executeSetupCommandFn` 等のテストダブルがパッケージレベル `var` で定義されているため、テスト間で共有され `t.Parallel()` が使用不可。

**現状の影響**: テスト速度が若干低下。現在のテスト規模では実害は少ないが、テスト増加時にボトルネックとなる。

**推奨対応**: 関数変数を `App` struct のフィールドまたは interface に移行し、DI 化することで `t.Parallel()` に対応可能にする。ただし、規模が大きい変更のため優先度は中。

#### A-I2: setupScriptsCancel クロージャキャプチャのレース懸念

**対象**: app_worktree_api.go (`CreateSessionWithWorktree`)  
**重要度**: 中

`setupScriptsCancel` 変数が defer と goroutine の間でクロージャキャプチャされている。defer 実行時に goroutine がまだ `setupScriptsCancel` を参照している場合、レースが発生しうる。

**注意**: `setupWG.Wait()` による同期があるため、実動作では問題が発生しにくい。コメントによる意図の明示が望ましい。

#### A-I3: CommitAndPushWorktree の空 commitMessage + push=true の挙動が未定義

**対象**: app_session_api.go  
**重要度**: 低〜中

`commitMessage` が空で `push=true` の場合の仕様が不明確。コメントまたはバリデーションの追加が望ましい。

#### A-I4: CreateSession の defer が失敗ロールバック後にもスナップショットを発行

**対象**: app_session_api.go  
**重要度**: 低

`defer` で `emitSnapshotDelta` が呼ばれるため、ロールバック失敗後にも不正なスナップショットが発行される。動作上の問題は軽微だが、NOTEコメントの追記が望ましい。

#### A-I5: latestAppCtx の多段フォールバックが認知負荷高い

**対象**: app_session_api.go / app_worktree_api.go 共通  
**重要度**: 低

`latestAppCtx` は `ctx → a.runtimeCtx → context.Background()` の3段フォールバックを持ち、呼び出し元のコンテキスト伝播意図が分かりづらい。

---

### Suggestions（提案）

- **A-S1**: `validateTmuxSessionName` と `CreateSession` のバリデーションで `strings.TrimSpace` が二重に呼ばれている。`validateTmuxSessionName` 内で trim 済みの値を返すか、呼び出し元で事前 trim しないかのどちらかに統一。
- **A-S2**: `shellExecFlag` 変数が `for` ループ外で1回だけ設定される改善は良い。ただし、`sh.exe` / `git-bash.exe` 等の POSIX 互換シェルが未考慮。将来的にシェル判定ロジックを拡張する際の拡張ポイントをコメントで明示するとよい。
- **A-S3**: `RenameSession` で同名リネーム（oldName == newName）時のバリデーションが未実装。エラーにするか no-op にするか明確化が望ましい。
- **A-S4**: ロールバックエラーのチェーン化—`rollbackCreatedSession` でエラーが発生した場合、元の作成失敗エラーとチェーンすると診断しやすい。
- **A-S5**: `copyConfigFilesToWorktree` のパストラバーサル防御は優秀。防御の意図を DOC コメントで残すとよい。
- **A-S6**: `findAvailableSessionName` のループ上限100が定数化・コメント化されていない。

---

## カテゴリB: internal/git パッケージ レビュー

### Critical Issues（致命的）

なし

### Important Issues（重要）

#### B-I1: os.Environ() がリトライループ内で毎回呼ばれている

**対象**: internal/git/command.go (`runGitCLI`)  
**重要度**: 中（パフォーマンス）

`os.Environ()` がリトライループ内（最大3回）で毎回呼ばれ、`localeNeutralGitEnv()` も毎回新しいスライスを生成している。最大9回の不要なアロケーションが発生する。

**推奨修正**: ループ外で1回だけ `os.Environ()` と `localeNeutralGitEnv()` を呼び、結果を再利用する。

```go
env := localeNeutralGitEnv()
for attempt := 1; attempt <= maxRetries; attempt++ {
    cmd := exec.Command("git", args...)
    cmd.Dir = dir
    cmd.Env = env
    // ...
}
```

#### B-I2: time.After によるタイマーリーク

**対象**: internal/git/command.go (`acquireGitSemaphore`)  
**重要度**: 中（リソースリーク）

`time.After` は返されたチャネルからの読み取りが行われなかった場合でも、タイマー期限切れまでリソースを保持する。セマフォ取得が成功した場合、タイマーは不要だがGCされるまでメモリを消費する。

**推奨修正**: `time.NewTimer` + `defer timer.Stop()` に置き換える。

```go
func acquireGitSemaphore() bool {
    timer := time.NewTimer(gitSemaphoreTimeout)
    defer timer.Stop()
    select {
    case gitSemaphore <- struct{}{}:
        return true
    case <-timer.C:
        return false
    }
}
```

---

### Suggestions（提案）

- **B-S1**: `runGitCLI` に `context.Context` を伝播すると、タイムアウトやキャンセルに対応できる。`exec.CommandContext` を使用。
- **B-S2**: `CleanupLocalBranchIfOrphaned` 内で `GetCurrentBranch` → `getBranchTrackingInfo` → `DeleteBranch` と3つの git コマンドを連続実行する。セマフォ容量4のうち3スロットを消費するため、高並行時にデッドロックの可能性あり。内部関数用のセマフォバイパス機構の検討を推奨。
- **B-S3**: リモート名に `/` を含む場合（例: `my/remote`）の `upstream` パースが未対応。通常はないが防御的に考慮可能。
- **B-S4**: `FindRepoRoot` のパス正規化（`filepath.Clean` 等）が未適用。シンボリックリンクや `..` を含むパスで不整合になる可能性。

---

### Strengths（良い点）

- セマフォによる並行実行制御（最大4本）は git index.lock 競合の根本対策として優秀
- 指数バックオフリトライ（100ms→200ms→400ms）が適切な間隔設計
- `localeNeutralGitEnv` による `LC_ALL=C` 強制で国際化環境での安定性確保
- エラーメッセージにコマンド・引数・stderr を含め、デバッグ容易性が高い
- テストカバレッジが非常に高く、テーブル駆動テストが一貫して使用されている
- `runGitCommand` / `runGitCommandRaw` の分離により、出力の trim 有無を呼び出し元が明確に選択可能
- `branchTrackingInfo` の構造化設計が適切

---

## カテゴリC: internal/install パッケージ レビュー

### Critical Issues（致命的）

なし

### Important Issues（重要）

なし

### Suggestions（提案）

#### C-S1: containsPathEntry の空文字エッジケース

**対象**: internal/install/shim_path_windows.go  

`filepath.Clean("")` は `"."` を返すため、`containsPathEntry("C:\\foo;.;C:\\bar", "")` が意図せず `true` を返しうる。現在の呼び出し元は有効パスのみを渡すため実害はないが、入口での空文字ガードがあるとより堅牢。

#### C-S2: broadcastEnvironmentSettingChange のエラー比較

**対象**: internal/install/shim_path_windows.go  

`callErr == windows.ERROR_SUCCESS` は `error` インターフェースと `syscall.Errno(0)` の直接比較。`errors.Is(callErr, windows.ERROR_SUCCESS)` の方が意図が明確。

#### C-S3: テストファイルとソースファイルの対応関係

`shim_path_windows.go` の関数テストが `shim_installer_windows_test.go` に配置されている。`shim_path_windows_test.go` への分離でファイル対応が明確になる。

---

### Strengths（良い点）

- `readRegistryPathRawValueWithRetry` は `ERROR_MORE_DATA` に対するサイズ再取得・リトライを最大3回まで実施し、並行プロセスによる PATH 変更への耐性が優秀
- バウンドチェック（負値サイズ、型不整合）が網羅的
- レジストリ値の型保存（SZ / EXPAND_SZ）の設計が適切
- UTF-16 デコードの堅牢性（BOM除去、奇数バイト長トランケート、nullターミネータ処理）
- `ensurePathContains` で `broadcastEnvironmentSettingChange` 失敗を non-fatal として扱う判断が適切

---

## カテゴリD: internal/terminal パッケージ レビュー

### Critical Issues（致命的）

なし

### Important Issues（重要）

#### D-I1: ptyIn/ptyOut ハンドル保持によるプロセス終了検出遅延

**対象**: internal/terminal/conpty_windows.go (`startConPty`)  
**重要度**: 中〜高

`createPseudoConsole` に渡した `ptyIn`（pipe read端）と `ptyOut`（pipe write端）を `ConPty` 構造体に保持し続けている。Microsoft の ConPTY サンプルでは、`CreatePseudoConsole` 呼び出し直後にこれらを閉じる（"These handles are now owned by the pseudoconsole"）。

アプリがこれらを保持していると、子プロセスが予期せず終了しても pipe の write 端が閉じないため、`cmdOut.Read()` が `ERROR_BROKEN_PIPE` を返さず、ReadLoop が終了しない。`doClose()` が呼ばれるまで exit を検知できない。

**推奨修正**: `startConPty` の成功パスで `ptyIn` と `ptyOut` を即座に閉じ、ConPty 構造体から除外する。

```go
// After createPseudoConsole succeeds:
closeHandles(ptyIn, ptyOut)
return &ConPty{
    hpCon:  hpCon,
    pi:     pi,
    cmdIn:  &handleIO{handle: cmdIn},
    cmdOut: &handleIO{handle: cmdOut},
}, nil
```

#### D-I2: handleIO.Read が io.Reader 契約に不完全準拠

**対象**: internal/terminal/conpty_windows.go  
**重要度**: 低〜中

Windows の `ReadFile` はパイプ切断時に `ERROR_BROKEN_PIPE` を返すが、`handleIO.Read` はこれを `io.EOF` に変換しない。Go 標準の `os.File.Read` はこの変換を行う。`normalizeConPtyPipeError` は "closed pseudo console" ラップエラーに変換するため、`io.EOF` をチェックする将来の呼び出し元で問題になりうる。

現在の `readSource` は任意のエラーで終了するため動作上は問題ないが、`io.Reader` インターフェースの意味的契約からは逸脱している。

---

### Suggestions（提案）

- **D-S1**: `startConPty` のディメンションバリデーションが2重実行（`hasCustomDimensions` 時に1回、その後 coord 変換後にもう1回）。防御的には許容だが、スリム化可能。
- **D-S2**: `getStartupInfoExForPTY` のコメントの Win32 サイズ値が不正確（"104 bytes on Win32" → 実際は72 bytes）。コードは `unsafe.Sizeof` で正確だが、コメント修正が望ましい。

---

### Strengths（良い点）

- `sync.Once` による `Close()` の冪等性保証が適切
- `doClose` のクリーンアップ順序（pseudo console → process wait/terminate → pipe handles）が正しく設計されている
- Read/Write でブロッキング I/O 中に RLock を保持しない設計判断が優秀（デッドロック回避）
- `normalizeConPtyPipeError` による OS エラーの正規化が呼び出し元に優しい
- `formatWaitResult` のデバッグ情報が丁寧
- テストで close 冪等性、post-close 操作、次元バリデーションが網羅されている

---

## テスト品質 横断レビュー

### カバレッジ欠落（テストされていない重要パス）

#### 優先度: 高

| # | 対象ファイル | 欠落内容 |
|---|------------|---------|
| T1 | app_worktree_api_test.go | `CreateSessionWithWorktree` の `PullBeforeCreate=true` パスが未テスト。pull 失敗時にエラーを返す分岐が未カバー |
| T2 | app_worktree_api_test.go | `CreateSessionWithWorktree` のロールバックパスが不十分。worktree作成成功後にセッション作成失敗した場合の `rollbackWorktree` 統合動作が未検証 |
| T3 | app_worktree_api_test.go | `CreateSessionWithWorktree` の `EnableAgentTeam=true` パスが未テスト |
| T4 | app_session_api_test.go | `KillSession(deleteWorktree=true)` で dirty worktree 拒否パスの統合テストが存在しない |
| T5 | app_pane_api_test.go | `SplitPane` の成功パスが未テスト（バリデーションテストのみ） |

#### 優先度: 中

| # | 対象ファイル | 欠落内容 |
|---|------------|---------|
| T6 | app_session_api_test.go | `CreateSession` の git metadata enrichment 成功パスのE2Eテストが不足 |
| T7 | app_pane_api_test.go | `GetPaneEnv` の成功パスが未テスト（バリデーションのみ） |
| T8 | app_helpers.go | `toString` / `toBytes` にテストが存在しない |

### テストの脆さ・改善点

- **app_pane_feed_test.go**: `waitForCondition` ヘルパーの `2*time.Second` タイムアウト — CI環境でflakyになる可能性（現状は許容範囲）
- **app_lifecycle_test.go**: `TestShutdownWaitsForTrackedSetupGoroutines` の `100ms` タイムアウト — CI遅延で偶発的パスのリスク
- **app_session_api_test.go**: `// NOTE: Do not use t.Parallel()` コメントが他ファイルと比べて欠落

### 良いテスト実践

- `reflect.TypeOf().NumField()` によるフィールド数ガードテストが優秀（struct変更の伝播漏れ検知）
- テーブル駆動テストが一貫して使用されている
- `runtimeEventsEmitFn` のモックによるイベント発火の確実な検証
- パストラバーサル攻撃のセキュリティテストが充実
- 並行安全性テスト（`TestRuntimeContextConcurrentSetGet` 等）が明示的
- デッドロック検出テストが実装されている

---

## 全体評価

### 総合所見

コード品質は全体的に高水準。特に以下の点が優れている：

1. **ロールバック設計**: セッション作成・worktree作成の各段階でロールバックが設計されており、部分的失敗からの回復が考慮されている
2. **並行制御**: git セマフォ、ConPTY の RWMutex、closeOnce 等、並行処理の安全性が体系的に設計されている
3. **Windows 固有対応**: レジストリ操作のリトライ、UTF-16 デコード、ConPTY ハンドル管理が堅実
4. **テストカバレッジ**: 全体的に高く、テーブル駆動テスト、フィールド数ガード、セキュリティテストが充実
5. **防御的コーディング**: パストラバーサル防御、入力バリデーション、エラー伝播が適切

### 改善推奨優先度

| 優先度 | ID | 内容 |
|-------|-----|------|
| 高 | D-I1 | ptyIn/ptyOut ハンドルの即時解放（プロセス終了検出遅延の解消） |
| 中 | B-I1 | os.Environ() のリトライループ外への移動 |
| 中 | B-I2 | time.After → time.NewTimer + defer Stop() |
| 中 | T1 | CreateSessionWithWorktree PullBeforeCreate テスト追加 |
| 中 | T2 | CreateSessionWithWorktree ロールバック統合テスト追加 |
| 中 | T4 | KillSession dirty worktree 統合テスト追加 |
| 中 | T5 | SplitPane 成功パステスト追加 |
| 低 | A-I3 | CommitAndPushWorktree 空コミットメッセージの仕様明確化 |
| 低 | A-I4 | ロールバック後スナップショット発行のNOTEコメント |
| 低 | C-S1 | containsPathEntry 空文字ガード |
| 低 | C-S2 | errors.Is 使用への移行 |
| 低 | D-I2 | handleIO.Read の io.EOF 変換 |

---

## タスク並列修正可否テーブル

以下の表は、各指摘事項の修正を並列で作業した場合の依存関係・競合リスクを示す。

| ID | 修正内容 | 対象ファイル | 並列作業可否 | 競合リスク | 備考 |
|----|---------|------------|:-----------:|:---------:|------|
| D-I1 | ptyIn/ptyOut ハンドル即時解放 | conpty_windows.go | ✅ 可 | なし | 他の変更と独立 |
| B-I1 | os.Environ() ループ外移動 | command.go | ✅ 可 | なし | command.go 内で完結 |
| B-I2 | time.After → NewTimer | command.go | ⚠️ B-I1と同時不可 | B-I1 と同ファイル | B-I1 と同時修正推奨 |
| A-I3 | 空commitMessage仕様明確化 | app_session_api.go | ✅ 可 | なし | コメント/バリデーション追加のみ |
| A-I4 | ロールバック後snapshot NOTE | app_session_api.go | ⚠️ A-I3と同時不可 | A-I3 と同ファイル | A-I3 と同時修正推奨 |
| C-S1 | containsPathEntry 空文字ガード | shim_path_windows.go | ✅ 可 | なし | 他の変更と独立 |
| C-S2 | errors.Is 使用 | shim_path_windows.go | ⚠️ C-S1と同時不可 | C-S1 と同ファイル | C-S1 と同時修正推奨 |
| D-I2 | io.EOF 変換 | conpty_windows.go | ⚠️ D-I1と同時不可 | D-I1 と同ファイル | D-I1 と同時修正推奨 |
| T1 | PullBeforeCreate テスト追加 | app_worktree_api_test.go | ✅ 可 | なし | テストファイルのみ |
| T2 | ロールバック統合テスト追加 | app_worktree_api_test.go | ⚠️ T1と同時不可 | T1 と同ファイル | T1 と同時修正推奨 |
| T4 | dirty worktree 統合テスト追加 | app_session_api_test.go | ✅ 可 | なし | テストファイルのみ |
| T5 | SplitPane 成功パステスト追加 | app_pane_api_test.go | ✅ 可 | なし | テストファイルのみ |
| A-S6 | ループ上限100 定数化 | app_session_api.go | ⚠️ A-I3/A-I4と同時不可 | 同ファイル | まとめて修正推奨 |

### 推奨並列作業グループ

同時に着手可能な独立グループ:

| グループ | 担当ファイル群 | 含む修正ID |
|---------|-------------|-----------|
| **Worker 1** | conpty_windows.go | D-I1, D-I2 |
| **Worker 2** | command.go | B-I1, B-I2 |
| **Worker 3** | app_session_api.go + test | A-I3, A-I4, A-S6, T4 |
| **Worker 4** | app_worktree_api_test.go | T1, T2 |
| **Worker 5** | shim_path_windows.go | C-S1, C-S2 |
| **Worker 6** | app_pane_api_test.go | T5 |

**上記6グループは全て並列作業可能**。各グループ内の修正は順次実施。

---

*Review completed by parallel review agents*
