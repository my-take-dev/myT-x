# レビュー結果: myT-x コミット前レビュー
- **日時**: 2025-02-16 07:45
- **対象**: myT-x 未コミット変更 (14ファイル, +2466/-175行)
- **レビュー方式**: 並列レビュー (4エージェント)

---

## レビューサマリ

| カテゴリ | 件数 |
|---------|------|
| 🔴 Critical | 1 |
| 🟠 Important | 14 |
| 🟡 Suggestion | 15 |
| 🟢 Positive | 29 |

---

## 🔴 Critical Issues (1件)

### C-1: `TestConPtyCloseIdempotent` のアサーション不足（偽パスリスク）

| 項目 | 詳細 |
|------|------|
| **ファイル** | `internal/terminal/conpty_close_windows_test.go` L15-L23 |
| **問題** | `err1 != err2` の比較のみで、`err1 == nil` の明示検証がない。両方 nil でも両方同じ非nil エラーでもテスト通過する。冪等性テストの本来の意図（2回目の Close がエラーを返さない）が検証されていない |
| **影響** | `doClose` がnilハンドルでエラーを返す場合にもテストが通過するため、リグレッションを検出できない |
| **修正方針** | `assert err1 == nil` と `assert err2 == nil` を明示追加 |

---

## 🟠 Important Issues (14件)

### カテゴリ A: Session/Worktree API (3件)

#### I-1: `CreateSession` ロールバック時のデバッグログ欠如

| 項目 | 詳細 |
|------|------|
| **ファイル** | `app_session_api.go` (storeRootPath 失敗パス) |
| **問題** | `storeRootPath` 失敗でロールバック（defer で `kill-session`）が実行されるが、ロールバック実行のログが出力されない |
| **影響** | デバッグ時にロールバック発生の追跡が困難 |
| **修正方針** | ロールバック発生時に `slog.Debug("[DEBUG-SESSION] rolling back session...")` を追加 |

#### I-2: `CreateSession` と `CreateSessionWithWorktree` の defer/emitSnapshot パターン不整合

| 項目 | 詳細 |
|------|------|
| **ファイル** | `app_session_api.go` vs `app_worktree_api.go` |
| **問題** | `CreateSession` は `sessionMayExist` フラグ + defer でロールバックとスナップショット送信を行うが、`CreateSessionWithWorktree` は成功パス末尾で明示的にスナップショット送信。パターンが異なるため保守性に影響 |
| **影響** | 将来の変更時に一方のパターンを見て他方を修正すると不整合が生じるリスク |
| **修正方針** | コメントでパターンの違いの理由を明記するか、統一を検討 |

#### I-3: `findAvailableSessionName` でのサイレントフォールバック

| 項目 | 詳細 |
|------|------|
| **ファイル** | `app_worktree_api.go` L365-L369 |
| **問題** | `requireSessions()` 失敗時、ログなしで元の名前をそのまま返す。重複名でセッション作成される可能性 |
| **影響** | 同名セッション作成時に下流で予期しないエラーが発生 |
| **修正方針** | `slog.Debug` を追加（他の `requireSessions` 呼び出し箇所と同等の対応） |

### カテゴリ B: Git パッケージ (3件)

#### I-4: グローバルセマフォが異なるリポジトリ間で共有

| 項目 | 詳細 |
|------|------|
| **ファイル** | `internal/git/command.go` L33 |
| **問題** | `gitSemaphore` はプロセス全体で共有。リポジトリAへの操作がリポジトリBの操作をブロック |
| **影響** | worktree数が増加すると不要なスロット待ちが顕在化。30秒タイムアウトがあるため致命的ではない |
| **修正方針** | 現時点では許容。将来的にリポジトリごとのセマフォを検討するコメントを追加 |

#### I-5: `listRemoteBranchNames` のリモート名パース精度

| 項目 | 詳細 |
|------|------|
| **ファイル** | `internal/git/git.go` L189-L199 |
| **問題** | `SplitN(refName, "/", 2)` でリモート名を除去。リモート名自体にスラッシュが含まれる場合、ブランチ名が不正確になる |
| **影響** | 低（実運用では稀なケース） |
| **修正方針** | `--format=%(upstream:lstrip=3)` を使えばより正確だが、優先度は低い |

#### I-6: `worktreePath` バリデーションの欠如

| 項目 | 詳細 |
|------|------|
| **ファイル** | `internal/git/worktree.go` |
| **問題** | `CreateWorktree`, `CreateWorktreeFromBranch` でブランチ名はバリデーションされるが、`worktreePath` の `ValidateWorktreePath` 呼び出しがない |
| **影響** | 不正パスでの worktree 作成試行の可能性（git が拒否するため実害は限定的） |
| **修正方針** | 各メソッド冒頭に `ValidateWorktreePath` 呼び出しを追加 |

### カテゴリ C: Install + Terminal (4件)

#### I-7: `closeHandles` でのエラーサイレント無視

| 項目 | 詳細 |
|------|------|
| **ファイル** | `internal/terminal/conpty_windows.go` L150-L157 |
| **問題** | `_ = windows.CloseHandle(h)` でOSハンドルのクローズエラーが無視される。ハンドルリーク時のデバッグ情報が失われる |
| **影響** | 低〜中。デバッグ時にリソースリーク原因の特定が困難になる |
| **修正方針** | `slog.Debug("[DEBUG-CONPTY] CloseHandle failed", "handle", h, "error", err)` に変更 |

#### I-8: ログレベルと `[DEBUG-]` プレフィックスの不整合

| 項目 | 詳細 |
|------|------|
| **ファイル** | `shim_path_windows.go` L82, `conpty_windows.go` L233, L237 |
| **問題** | `slog.Warn` で `[DEBUG-...]` プレフィックスを使用。開発完了後にDEBUGプレフィックスで一括削除するとWarnレベルのログも消えてしまう |
| **影響** | ログ管理上の混乱 |
| **修正方針** | Warnレベルのログは `[WARN-CONPTY]` 等に変更するか、コメントで意図を明記 |

#### I-9: `doClose` の `TerminateProcess` 失敗が呼び出し元に返されない

| 項目 | 詳細 |
|------|------|
| **ファイル** | `internal/terminal/conpty_windows.go` L235-L239 |
| **問題** | `TerminateProcess` 失敗はログに記録されるが、`Close()` の戻り値には反映されない。ゾンビプロセスリスクが呼び出し元に通知されない |
| **影響** | 中。ゾンビプロセスの存在を上位層が把握できない |
| **修正方針** | `firstErr` が nil の場合に `termErr` を返す |

#### I-10: `handleIO.Write` のエラー正規化欠如

| 項目 | 詳細 |
|------|------|
| **ファイル** | `internal/terminal/conpty_windows.go` L33-L37 |
| **問題** | `Read` は `normalizeReadFileError` を通しているが `Write` は生エラーを返す。Read/Write の防御パターンが非対称 |
| **影響** | 低。上位の `ConPTY.Write` が `normalizeConPtyPipeError` で正規化するため実害なし |
| **修正方針** | `handleIO.Write` にも `normalizeConPtyPipeError("WriteFile", err)` を追加 |

### カテゴリ D: テスト品質 (4件)

#### I-11: `TestCreateSessionLogsGitMetadataFailures` がログ出力を未検証

| 項目 | 詳細 |
|------|------|
| **ファイル** | `app_session_api_test.go` L108-L128 |
| **問題** | テスト名に「LogsGitMetadataFailures」とあるが、実際にはログ出力を検証せず、セッション作成成功のみ確認。ログ出力のリグレッションを検出できない |
| **影響** | テストの偽パスリスク |
| **修正方針** | `slog.SetDefault` でバッファにリダイレクトし、ログ内容を検証 |

#### I-12: `TestKillSessionStopsOutputBuffersOutsideOutputLock` のタイムアウト依存

| 項目 | 詳細 |
|------|------|
| **ファイル** | `app_session_api_test.go` L278-L311 |
| **問題** | `time.After(2s)` / `time.After(500ms)` に依存。CI遅延時にflakyになるリスク |
| **影響** | テストの不安定化 |
| **修正方針** | デッドロック検出目的のため現時点では妥協可能。長期的にはチャネル同期化を検討 |

#### I-13: `TestListBranchesForWorktreeBase` の仕様妥当性が不明

| 項目 | 詳細 |
|------|------|
| **ファイル** | `internal/git/git_test.go` L352-L373 |
| **問題** | ローカルブランチとリモートブランチが存在するのに結果が空リスト。仕様として正しいかテストコメントで明記すべき |
| **影響** | 仕様不明確によるメンテナンス困難 |
| **修正方針** | テストにコメントで理由を追記 |

#### I-14: `createBareAndClone` テストヘルパーが `localeNeutralGitEnv` 未使用

| 項目 | 詳細 |
|------|------|
| **ファイル** | `internal/git/git_test.go` L191-L231 |
| **問題** | テストヘルパー内で `exec.Command("git", ...)` を直接実行しているが、本番コード側の `localeNeutralGitEnv` を未設定。ロケール依存の環境でテストが壊れる可能性 |
| **影響** | ロケール依存CI環境でのテスト不安定化 |
| **修正方針** | テストヘルパーにも `localeNeutralGitEnv` を適用 |

---

## 🟡 Suggestions (15件)

| ID | ファイル | 概要 |
|----|---------|------|
| S-1 | `app_session_api.go` | `findSessionByRootPath` で `IsWorktreeSession()` メソッドを活用 |
| S-2 | `app_worktree_api.go` L199-L210 | `copyConfigFilesToWorktree` のパス安全性違反をUIイベントに含める検討 |
| S-3 | `app_worktree_api.go` L295-L297 | `runSetupScripts` ラッパーの使用箇所確認（未使用なら削除） |
| S-4 | `internal/git/command.go` L145 | `runGitCommandRaw` の `TrimRight` 意図をコメントで明記 |
| S-5 | `internal/git/git.go` L12 | `Open` に空文字列ガードを追加 |
| S-6 | `internal/git/git.go` L111-L125 | `CleanupLocalBranchIfOrphaned` で `slices.IndexFunc` 使用を検討 |
| S-7 | `internal/git/git.go` L244-L252 | `CommitAll` の空コミットケースをコメントで明記 |
| S-8 | `internal/git/validation.go` L95-L108 | `FindAvailableWorktreePath` のフォールバック到達時にログ追加 |
| S-9 | `internal/install/shim_path_windows.go` L39 | `environmentSettingPayload` に `runtime.KeepAlive` 追加検討 |
| S-10 | `internal/terminal/conpty_windows.go` L110-L119 | `startConPty` での二重バリデーション削減 |
| S-11 | `internal/terminal/conpty_syscall_windows.go` L40-L42 | `_COORD.Pack()` に制約条件コメント追加 |
| S-12 | `app_pane_api_test.go` L96-L113 | `TestPaneMutationAPIsRequireSessionManager` を `t.Run` でサブテスト化 |
| S-13 | `internal/git/command_test.go` L48-L68 | `TestUpsertEnvVar` にエッジケース追加（空env、不正フォーマットエントリ） |
| S-14 | `conpty_close_windows_test.go` | `TestNormalizeReadFileError` に nil 入力テストケース追加 |
| S-15 | `app_worktree_api_test.go` L31 | `TestShellExecFlag` の unknown shell フォールバック挙動をコメント明記 |

---

## 🟢 Positive Observations (29件)

### 設計・アーキテクチャ (8件)

| ID | 概要 |
|----|------|
| P-1 | `CreateSession` の `sessionMayExist` フラグ + defer によるロールバック設計が堅牢 |
| P-2 | `worktreeCleanupParams` struct で cleanup ロジックの引数を整理し可読性向上 |
| P-3 | `cleanupSessionWorktree` が cleanup 失敗を non-fatal として処理（CLAUDE.md 準拠） |
| P-4 | ConPTY の `sync.Once` による冪等 Close, `RLock` によるデッドロック回避設計 |
| P-5 | ConPTY リソース解放順序（pseudo console → process → handles → pipes）が正確 |
| P-6 | Git コマンドの指数バックオフ付きリトライ + semaphore 同時実行制御 |
| P-7 | `localeNeutralGitEnv` による git 出力のロケール非依存化 |
| P-8 | `executeRouterRequestFn` / `currentBranchFn` の関数変数パターンでテスト容易性確保 |

### セキュリティ (3件)

| ID | 概要 |
|----|------|
| P-9 | `copyConfigFilesToWorktree` の多層パストラバーサル防止（絶対パス拒否 + `..` 拒否 + ベースディレクトリ外解決拒否） |
| P-10 | git command 実行時の `procutil.HideWindow` による Windows コンソールウィンドウ抑制 |
| P-11 | `ValidateBranchName` のパストラバーサル防御（`..`、先頭 `/`・`.`・`-`、`.lock` 除外） |

### エラーハンドリング (5件)

| ID | 概要 |
|----|------|
| P-12 | 全体で `fmt.Errorf("...: %w", err)` によるエラーコンテキスト維持が徹底 |
| P-13 | `isNoUpstreamTrackingError` の upstreamトークンとのAND条件で過剰マッチ防止 |
| P-14 | `normalizeConPtyPipeError` / `normalizeReadFileError` によるエラー正規化 |
| P-15 | レジストリ `readRegistryPathRawValueWithRetry` の `ERROR_MORE_DATA` リトライ |
| P-16 | レジストリ値型（`SZ`/`EXPAND_SZ`）の保持による環境変数展開破壊防止 |

### テスト (8件)

| ID | 概要 |
|----|------|
| P-17 | テーブル駆動テストの徹底（全テストファイルで一貫） |
| P-18 | `WorktreeCleanupParamsFieldCountGuard` / `WorktreeStructFieldCounts` によるフィールド数ガードテスト |
| P-19 | `TestGetPaneEnvSuccess` で防御的コピーの独立性検証 |
| P-20 | `TestCleanupLocalBranchIfOrphaned` の11ケース網羅テスト |
| P-21 | `TestReadRegistryPathRawValueWithRetry` のコールバック注入による完全ユニットテスト |
| P-22 | `TestDecodeRegistryUTF16String` のCJK文字、BOM、奇数バイト長テスト |
| P-23 | `TestConPtyResizeDimensionValidation` の境界値テスト（-1, 0, 32767, 32768） |
| P-24 | ログ出力の内容検証パターン（`slog.SetDefault` バッファリダイレクト） |

### コード品質 (5件)

| ID | 概要 |
|----|------|
| P-25 | `[DEBUG-SESSION]`, `[DEBUG-GIT]`, `[DEBUG-CONPTY]`, `[DEBUG-SHIM]` のプレフィックス統一 |
| P-26 | `formatWaitResult` によるデバッグ可能性の向上 |
| P-27 | `runtime.KeepAlive(envBlock)` による GC 防止（unsafe ポインタ管理のベストプラクティス） |
| P-28 | UTF-16 デコードの堅牢性（BOM除去、奇数バイト長、null ターミネータ） |
| P-29 | AGENTS.md 準拠（コード英語、既存日本語コメント保持） |

---

## 修正タスク一覧

| # | ID | ファイル | 修正内容 | 優先度 | 並列可 | 推定規模 |
|---|-----|---------|----------|--------|--------|---------|
| 1 | C-1 | `conpty_close_windows_test.go` | テスト: `err1 == nil` 明示検証追加 | 🔴高 | ✅ | 小 |
| 2 | I-11 | `app_session_api_test.go` | テスト: ログ出力の検証追加 | 🟠中 | ✅ | 中 |
| 3 | I-1 | `app_session_api.go` | ロールバック時デバッグログ追加 | 🟠中 | ✅ | 小 |
| 4 | I-3 | `app_worktree_api.go` | `findAvailableSessionName` にログ追加 | 🟠中 | ✅ | 小 |
| 5 | I-7 | `conpty_windows.go` | `closeHandles` エラーログ追加 | 🟠中 | ✅ | 小 |
| 6 | I-8 | `shim_path_windows.go`, `conpty_windows.go` | Warn ログプレフィックス整理 | 🟠中 | ✅ | 小 |
| 7 | I-9 | `conpty_windows.go` | `TerminateProcess` 失敗をエラー返却 | 🟠中 | ✅ | 小 |
| 8 | I-10 | `conpty_windows.go` | `handleIO.Write` エラー正規化追加 | 🟠低 | ✅ | 小 |
| 9 | I-6 | `internal/git/worktree.go` | `worktreePath` バリデーション追加 | 🟠中 | ✅ | 小 |
| 10 | I-2 | `app_session_api.go`, `app_worktree_api.go` | defer/emitSnapshot パターンコメント追加 | 🟠低 | ✅ | 小 |
| 11 | I-14 | `internal/git/git_test.go` | テストヘルパーに `localeNeutralGitEnv` 適用 | 🟠中 | ✅ | 小 |
| 12 | I-12 | `app_session_api_test.go` | タイムアウト依存テストのコメント追加 | 🟡低 | ✅ | 小 |
| 13 | I-13 | `internal/git/git_test.go` | テストの仕様コメント追加 | 🟡低 | ✅ | 小 |
| 14 | S-5 | `internal/git/git.go` | `Open` 空文字列ガード追加 | 🟡低 | ✅ | 小 |

> **並列可**: 全タスクが独立しており、全て並列作業可能です。
> **推定規模**: 小 = 1-5行変更, 中 = 5-20行変更

---

## 総評

全体として**高品質**なコードです。特にエラーハンドリングの一貫性、テスト設計（テーブル駆動テスト、フィールド数ガード、DI パターン）、Windows 固有処理の堅牢性（レジストリ UTF-16、ConPTY ライフサイクル管理）が優れています。

Critical は1件（テストのアサーション不足）のみで、本番コードには Critical 指摘なし。Important の多くはログ追加やコメント追加であり、ロジック変更を伴うものは少ないです。
