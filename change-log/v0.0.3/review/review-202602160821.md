# PR Review — dev-v3-1 (2026-02-16)

**対象**: `myT-x/` 配下の変更ファイル 15件 (+2,547/-448 lines)
**レビュー方式**: 4カテゴリ並列レビュー（App API / Git Internal / Install/Shim / Terminal/ConPTY）
**レビュー観点**: comments, tests, errors, types, code, simplify

---

## 変更ファイル一覧

| # | カテゴリ | ファイル | 主な変更内容 |
|---|---------|---------|-------------|
| 1 | App API | `app_session_api.go` | `worktreeCleanupParams`構造体、`cleanupOrphanedLocalWorktreeBranch` |
| 2 | App API | `app_session_api_test.go` | +432行 バリデーション/kill/rollback/cleanup テスト |
| 3 | App API | `app_worktree_api.go` | `ListBranchesForWorktreeBase`への切替、NOTE付きPrune削除 |
| 4 | App API | `app_worktree_api_test.go` | +236行 ブランチ非表示/pushed保持/rollback テスト |
| 5 | App API | `app_pane_api_test.go` | +47行 テスト追加 |
| 6 | Git | `internal/git/git.go` | `branchTrackingInfo`, `ListBranchesForWorktreeBase`, `CleanupLocalBranchIfOrphaned` |
| 7 | Git | `internal/git/git_test.go` | +709行 テーブル駆動テスト（7+9+6+9ケース） |
| 8 | Git | `internal/git/command.go` | `runGitCommandRaw`（空白保持版） |
| 9 | Git | `internal/git/command_test.go` | +63行 `isLockFileConflict`, `upsertEnvVar`, `localeNeutralGitEnv` |
| 10 | Git | `internal/git/worktree.go` | `PruneWorktrees`に`--expire=now` |
| 11 | Install | `internal/install/shim_path_windows.go` | +139行 reg.exe→ネイティブレジストリAPI完全書き換え |
| 12 | Install | `internal/install/shim_installer_windows_test.go` | +292行 リトライ/デコード/型判定テスト |
| 13 | ConPTY | `internal/terminal/conpty_windows.go` | `stateMu RWMutex`、`doClose`capture-and-nil、エラー正規化 |
| 14 | ConPTY | `internal/terminal/conpty_close_windows_test.go` | +209行 新規テストファイル |
| 15 | ConPTY | `internal/terminal/conpty_syscall_windows_test.go` | `runtime.KeepAlive`、magic number修正 |

---

## Critical (C)

**指摘なし** — クラッシュ、データ破壊、セキュリティホールに該当する問題は検出されませんでした。

---

## Important (I)

### I-1: `ListBranchesForWorktreeBase` — remote削除後にフォールバックが機能しないエッジケース
- **カテゴリ**: Git Internal
- **ファイル**: `internal/git/git.go` L118-L126
- **内容**: `git remote remove origin`でリモート削除後、`branch.*.remote`設定が残存する場合：
  - `hasAnyUpstreamTracking(infos)` → `true`（Upstream非空）
  - `remoteBranchNames` → 空（refs/remotesなし）
  - `filtered` → 空（live upstreamもリモートマッチもなし）
  - フォールバック条件 `!hasAnyUpstreamTracking(infos)` が `false` → 空リストを返す → ブランチ選択UIが使えなくなる
- **修正案**: `hasAnyUpstreamTracking` を `hasAnyLiveUpstream` に変更し、全upstreamが `[gone]` の場合もフォールバック発動
```go
func hasAnyLiveUpstream(infos []branchTrackingInfo) bool {
    for _, info := range infos {
        if info.hasLiveUpstream() { return true }
    }
    return false
}
// フォールバック条件:
if len(filtered) == 0 && len(remoteBranchNames) == 0 && !hasAnyLiveUpstream(infos) {
```

### I-2: `handleIO.Write` と `ConPty.Write` で `normalizeConPtyPipeError` が二重適用
- **カテゴリ**: ConPTY
- **ファイル**: `internal/terminal/conpty_windows.go` L33-37 / L243-252
- **内容**: `handleIO.Write`と`ConPty.Write`の両方で`normalizeConPtyPipeError`を呼んでいるため、エラーメッセージが二重ラップされる
  - 結果: `"Write called on closed pseudo console: WriteFile called on closed pseudo console: broken pipe"`
  - Read側は`handleIO.Read` → `normalizeReadFileError`、`ConPty.Read` → `normalizeConPtyPipeError`と**別関数**のため二重ラップなし
- **修正案**: `handleIO.Write`から`normalizeConPtyPipeError`を除去し、生エラーを返す（Read側と同パターン）
```go
func (h *handleIO) Write(p []byte) (int, error) {
    var numWritten uint32
    err := windows.WriteFile(h.handle, p, &numWritten, nil)
    return int(numWritten), err  // let ConPty.Write normalize
}
```

### I-3: `CleanupLocalBranchIfOrphaned` — `listRemoteBranchNames` エラー時のラップ不足
- **カテゴリ**: Git Internal
- **ファイル**: `internal/git/git.go` L152-157
- **内容**: `listRemoteBranchNames`のエラーがラップなしで返される。呼び出し元からどのステップで失敗したか判別しにくい。同様に`ListBranchesForWorktreeBase`内のL107も同様。
- **修正案**:
```go
remoteBranchNames, err := r.listRemoteBranchNames()
if err != nil {
    return false, fmt.Errorf("failed to list remote branches for orphan check: %w", err)
}
```

### I-4: `setupScriptsCancel` が成功パスでcancelされない（contextリソースリーク）
- **カテゴリ**: App API
- **ファイル**: `app_worktree_api.go` L113-128
- **内容**: `CreateSessionWithWorktree`の成功パスでdeferが`if retErr == nil { return }`で早期リターンするため、`setupScriptsCancel`が呼ばれない。Go公式ではWithCancelのcancelは確実に呼ぶべきとされている。
- **修正案**: goroutine内でcancelをdeferする
```go
go func(ctx context.Context, cancel context.CancelFunc) {
    defer cancel()
    defer a.setupWG.Done()
    // ...
}(setupScriptsCtx, setupScriptsCancel)
```

### I-5: `decodeRegistryUTF16String` — 1バイト入力のテストケース不足
- **カテゴリ**: Install/Shim
- **ファイル**: `internal/install/shim_installer_windows_test.go`
- **内容**: 奇数バイト切り詰めは実装済みだが、1バイト入力（`[]byte{0xAA}`）のテストケースがない。動作上は安全だが、エッジケースの明示的検証として追加推奨。
- **修正案**:
```go
{name: "single byte is truncated to empty", raw: []byte{0xAA}, want: ""},
```

### I-6: `readRegistryPathRawValueWithRetry` — `n > len(buffer)` パスのリトライ上限テスト不足
- **カテゴリ**: Install/Shim
- **ファイル**: `internal/install/shim_installer_windows_test.go`
- **内容**: サイズ成長で2回目に成功するケースのみテスト済み。`n > len(buffer)`が**3回連続**返されるリトライ上限到達ケースが未テスト。
- **修正案**:
```go
t.Run("returns retry limit when n always exceeds buffer", func(t *testing.T) {
    callCount := 0
    _, _, err := readRegistryPathRawValueWithRetry(
        0, registry.SZ,
        func(buffer []byte) (int, uint32, error) {
            callCount++
            return len(buffer) + 4, registry.SZ, nil
        },
        func() (int, uint32, error) {
            t.Fatal("readSizeAndType should not be called in n>len path")
            return 0, registry.NONE, nil
        },
    )
    if err == nil || !strings.Contains(err.Error(), "retry limit exceeded") {
        t.Fatalf("expected retry limit exceeded, got %v", err)
    }
})
```

### I-7: `GetSessionEnv` 空名パスのテスト不足
- **カテゴリ**: App API
- **ファイル**: `app_session_api.go` L329-332 / `app_session_api_test.go` L1328-1332
- **内容**: `sessionName == ""`時のエラーリターンが実装済みだが、テストはsessions=nilのみ。空名のバリデーションテストが欠落。
- **修正案**:
```go
t.Run("returns error when session name is empty", func(t *testing.T) {
    app := NewApp()
    app.sessions = tmux.NewSessionManager()
    if _, err := app.GetSessionEnv("   "); err == nil {
        t.Fatal("GetSessionEnv() expected empty name validation error")
    }
})
```

### I-8: `listLocalBranchTrackingInfo` / `listRemoteBranchNames` の直接テスト不在
- **カテゴリ**: Git Internal
- **ファイル**: `internal/git/git_test.go`
- **内容**: 統合テストで間接的にカバーされているが、以下のエッジケースの直接テストがない：
  - スラッシュ付きブランチ名（`feature/team/task-123`）のパース正確性
  - `%(upstream:track)` が複合ステータス（`[ahead 1, behind 2]`）の場合
  - `listRemoteBranchNames`でリモート名にスラッシュを含む場合（コメントL202で既知制約として記載）

### I-9: `handleIO.handle` へのデータ競合（記録事項）
- **カテゴリ**: ConPTY
- **ファイル**: `internal/terminal/conpty_windows.go` L229-240 / L40-45
- **内容**: Read/Writeが`RLock`で`cmdOut`/`cmdIn`ポインタをコピー後`RUnlock`、その後`cmdOut.Read()`/`cmdIn.Write()`を呼ぶ間に、`Close()`が`doClose`内で`h.handle`を書き換え得る。Goメモリモデル上は未定義動作。
- **状況**: 設計上のトレードオフとしてコメントに明示済み。プロジェクト方針で`-race`テスト不要。OS側が適切なエラーを返すため実用上の安全性は確保されている。
- **対応**: 将来的に`handleIO.handle`を`atomic.Uintptr`にするか個別mutex検討。現時点では記録のみ。

---

## Suggestion (S)

### S-1: `hasAnyUpstreamTracking` 内の冗長な `TrimSpace`
- **ファイル**: `internal/git/git.go` L218-224
- **内容**: `listLocalBranchTrackingInfo`がL193で既に`TrimSpace`済みのため、`hasAnyUpstreamTracking`内の`TrimSpace(info.Upstream)`は冗長
- **修正案**: `if info.Upstream != "" {` に簡素化

### S-2: `CleanupLocalBranchIfOrphaned` のエラーメッセージ精度
- **ファイル**: `internal/git/git.go` L169-171
- **内容**: `"may have unmerged commits"` はgit branch -d失敗の最頻原因だが、パーミッションエラー等でも同メッセージになる。`%w`で元エラーがラップされているため実害は少ない。
- **修正案**: `"failed to delete orphaned branch %q: %w"` に簡素化

### S-3: `runGitCommandRaw` のdoc commentにユースケース記載
- **ファイル**: `internal/git/command.go` L120-126
- **内容**: `runGitCommand`との違いの**理由**（タブ区切りfor-each-ref出力の保持）を明記するとメンテナビリティ向上

### S-4: `branchTrackingInfo` 構造体にフィールドコメント追加
- **ファイル**: `internal/git/git.go` L85-89
- **内容**: 3フィールドが`%(refname:short)`, `%(upstream:short)`, `%(upstream:track)` に対応する旨を明記

### S-5: `startConPty` 内のバリデーション二重実行
- **ファイル**: `internal/terminal/conpty_windows.go` L108-121
- **内容**: `hasCustomDimensions=true`時に同じ値が2回バリデーションされる。2回目は`int16`変換後の再検証だが、1回目で`int16`範囲が保証済み。防御的で害はないが冗長。

### S-6: `createEnvBlock` に `runtime.KeepAlive` 必須のドキュメント追加
- **ファイル**: `internal/terminal/conpty_syscall_windows.go` L127-148
- **内容**: 返却ポインタがローカルスライスのバッキング配列を参照するため、呼び出し元で`runtime.KeepAlive`が必須。現在の呼び出し元は正しく対処済みだが、将来の呼び出し元向けにコメント追加推奨。

### S-7: `ensurePathContains` のプロセスPATH vs レジストリPATHの意味的差異
- **ファイル**: `internal/install/shim_path_windows.go` L44-47
- **内容**: `os.Getenv("PATH")`はSystem+User PATHの展開済み結合値。System PATHに含まれている場合User PATHへの書き込みをスキップする。意図的であればコメントで明示推奨。

### S-8: `broadcastEnvironmentSettingChange` のエラーメッセージに `result` 値追加
- **ファイル**: `internal/install/shim_path_windows.go` L227-235
- **内容**: `"returned 0 without extended error"` にresult変数の値を含めると診断しやすい
- **修正案**: `fmt.Errorf("SendMessageTimeoutW returned 0 without extended error (result=%d)", result)`

### S-9: `pathsEqualFold` のユーティリティ関数配置
- **ファイル**: `app_session_api.go` L360-362
- **内容**: `findSessionByWorktreePath`（`app_worktree_api.go`）からも使用されるため、`app_helpers.go`への移動を検討

### S-10: `cleanupSessionWorktree` のエラーメッセージの曖昧さ
- **ファイル**: `app_session_api.go` L239
- **内容**: `"worktree cleanup skipped due to uncommitted changes or status check failure"` — uncommitted changesとstatus check failureが区別できない。フロントエンドがイベントのエラーメッセージを表示する場合、原因の特定が困難。

### S-11: `emitWorktreeCleanupFailure` のnil errフォールバック未テスト
- **ファイル**: `app_session_api.go` L312-314
- **内容**: `err == nil`時に`"unknown worktree cleanup failure"`を生成するロジックのテストが無い。防御的コードだが、テスト追加またはコメントで到達不能を明記推奨。

### S-12: `TestConPtyResizeDimensionValidation` — 最小有効値の境界テスト
- **ファイル**: `internal/terminal/conpty_close_windows_test.go`
- **内容**: 無効値（0, -1, 32768）は網羅だが、最小有効値`width=1, height=1`のテストケースがない

---

## Positive (P) — 良いパターン

### P-1: `worktreeCleanupParams` 構造体とフィールド数ガードテスト
- 5つの文字列パラメータ→構造体集約。`TestWorktreeCleanupParamsFieldCountGuard`でフィールド追加時のテスト更新漏れを防止。

### P-2: `cleanupOrphanedLocalWorktreeBranch` の防御的ガード
- `repo == nil`と`branchName == ""`の両方にデバッグログ付きearly return。

### P-3: `CleanupLocalBranchIfOrphaned` — 5段階安全ガード
- ValidateBranchName → hasLiveUpstream → remoteBranchNames → currentBranch → git branch -d

### P-4: `containsUpstreamToken` — 過剰マッチ防止設計
- `@{u}`/`@{upstream}`のgitリファレンストークン構文のみマッチ、"upstream"の単純マッチ回避。テストで意図文書化。

### P-5: テストカバレッジの充実
- `TestListBranchesForWorktreeBase`: 7ケース
- `TestCleanupLocalBranchIfOrphaned`: 9ケース（+unmergedケース）
- `TestBranchTrackingInfoHasLiveUpstream`: 6ケース
- `TestIsNoUpstreamTrackingError`: 9ケース
- ConPTYライフサイクルテスト: close冪等性、パイプ参照クリア、close後全操作検証

### P-6: `sync.Once` + `doClose` のcapture-and-nilパターン
- 二重解放防止、クリーンアップ順序保証（pseudo console → process → handles → pipes）

### P-7: エラー正規化で `%w` による原因チェーン保持
- `normalizeConPtyPipeError`/`normalizeReadFileError`が`errors.Is`対応設計。

### P-8: レジストリリトライロジックの堅牢性
- `maxReadAttempts=3`上界付き、`ERROR_MORE_DATA`時のサイズ・型再検証。コールバック分離によるテスト容易性。

### P-9: `runtime.KeepAlive(envBlock)` の正確な配置
- CreateProcess呼び出し直後、エラーチェック前。GC回収リスクを確実に防止。

### P-10: ロケール中立化とリトライ機構
- `LC_ALL=C`によるgitメッセージパース信頼性、`index.lock`指数バックオフリトライ、セマフォ4並行制御。

---

## 総合評価

| 重要度 | 件数 | 概要 |
|--------|------|------|
| **Critical** | 0 | — |
| **Important** | 9 | フォールバック条件(I-1)、二重ラップ(I-2)、エラーラップ(I-3)、contextリーク(I-4)、テスト補強(I-5〜I-8)、データ競合記録(I-9) |
| **Suggestion** | 12 | コメント改善、冗長コード、エラーメッセージ精度、テスト境界値 |
| **Positive** | 10 | 構造体リファクタリング、防御的設計、テストカバレッジ、エラー正規化、ロケール中立化 |

### 優先対応推奨

1. **I-2**（`handleIO.Write`の`normalizeConPtyPipeError`除去）— 1行修正、エラーメッセージ品質に直結
2. **I-1**（`hasAnyUpstreamTracking` → `hasAnyLiveUpstream`）— UIが使えなくなるエッジケース防止
3. **I-4**（`setupScriptsCancel`のgoroutine内defer）— contextリソースリーク防止
4. **I-3**（エラーラッピング追加）— デバッグ容易性向上

---

## タスク整理・並列作業可能性

| タスクID | 対応内容 | 対象ファイル | 依存関係 | 並列可否 |
|---------|---------|-------------|---------|---------|
| T-1 | I-1: `hasAnyLiveUpstream`関数追加・フォールバック条件変更 | `internal/git/git.go` | なし | ✅ 並列可 |
| T-2 | I-2: `handleIO.Write`からnormalize除去 | `internal/terminal/conpty_windows.go` | なし | ✅ 並列可 |
| T-3 | I-3: `listRemoteBranchNames`エラーラッピング追加 | `internal/git/git.go` | T-1と同ファイル | ⚠️ T-1と順次 |
| T-4 | I-4: `setupScriptsCancel`のgoroutine内cancel | `app_worktree_api.go` | なし | ✅ 並列可 |
| T-5 | I-5: `decodeRegistryUTF16String`の1バイトテスト追加 | `shim_installer_windows_test.go` | なし | ✅ 並列可 |
| T-6 | I-6: `readRegistryPathRawValueWithRetry`リトライ上限テスト追加 | `shim_installer_windows_test.go` | T-5と同ファイル | ⚠️ T-5と順次 |
| T-7 | I-7: `GetSessionEnv`空名テスト追加 | `app_session_api_test.go` | なし | ✅ 並列可 |
| T-8 | I-8: `listLocalBranchTrackingInfo`直接テスト追加 | `internal/git/git_test.go` | T-1完了後推奨 | ⚠️ T-1後 |

### 並列実行グループ

```
Group A (独立・即時実行可能):
  T-2 (ConPTY Write二重ラップ修正)
  T-4 (context cancel修正)
  T-7 (GetSessionEnv テスト追加)

Group B (同ファイル順次):
  T-1 → T-3 (git.go: フォールバック → エラーラップ)
  T-5 → T-6 (shim_installer_test: 1バイト → リトライ上限)

Group C (依存あり):
  T-8 (T-1完了後)
```
