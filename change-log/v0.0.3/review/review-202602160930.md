# PR Review — myT-x 並列レビュー結果

**日時**: 2026-02-16 09:30  
**対象**: myT-x/ 配下の変更ファイル（15ファイル, +2,713 / -190）  
**レビュー方式**: 6エージェント並列レビュー（コード品質 / Git内部 / Terminal・Install / テスト品質 / エラーハンドリング / コード簡素化）

---

## 変更ファイル一覧

| カテゴリ | ファイル | 変更量 |
|---------|---------|--------|
| App Layer | `app_session_api.go` | ~123行 |
| App Layer | `app_worktree_api.go` | ~140行 |
| App Layer | `app_session_api_test.go` | +436行 |
| App Layer | `app_worktree_api_test.go` | +236行 |
| App Layer | `app_pane_api_test.go` | +47行 |
| Git Internal | `internal/git/git.go` | +82行 |
| Git Internal | `internal/git/command.go` | +33行 |
| Git Internal | `internal/git/worktree.go` | +15行 |
| Git Internal | `internal/git/git_test.go` | +823行 |
| Git Internal | `internal/git/command_test.go` | +63行 |
| Terminal | `internal/terminal/conpty_windows.go` | ~232行 |
| Terminal | `internal/terminal/conpty_close_windows_test.go` | +209行 |
| Terminal | `internal/terminal/conpty_syscall_windows_test.go` | +3行 |
| Install | `internal/install/shim_path_windows.go` | ~139行 |
| Install | `internal/install/shim_installer_windows_test.go` | +322行 |

---

## Critical 指摘

**指摘なし** — Critical レベルの問題は検出されませんでした。

---

## Important 指摘

### I-1. `handleIO.Read` でInvalidHandleチェック不在
**ファイル**: `internal/terminal/conpty_windows.go` (handleIO.Read)  
**種別**: バグリスク  

`handleIO.Read` でmutex解放後にhandle値の有効性チェックが行われていない。`Close()` が完了した後に `ReadFile(InvalidHandle)` が呼ばれると `ERROR_INVALID_HANDLE` が返るが、`normalizeReadFileError` はこのエラーを `io.EOF` に変換しない。結果として上位の `ConPty.Read` が `io.EOF` ではなく独自エラーメッセージを返し、`io.Reader` 契約（ストリーム終端 = `io.EOF`）と異なる挙動になる。

```go
// 修正案: mutex unlock直後にプレチェック追加
func (h *handleIO) Read(p []byte) (int, error) {
    h.mu.Lock()
    handle := h.handle
    h.mu.Unlock()
    if handle == 0 || handle == windows.InvalidHandle {
        return 0, io.EOF
    }
    // ... ReadFile call
}
```

---

### I-2. `handleIO.Write` のエラー正規化の不統一
**ファイル**: `internal/terminal/conpty_windows.go` (handleIO.Write)  
**種別**: 設計一貫性  

`handleIO.Read` は `normalizeReadFileError` でエラー正規化するが、`handleIO.Write` には同等の正規化がない。上位の `ConPty.Write` で `normalizeConPtyPipeError` が最終的にラップするため動作は正しいが、handleIOレベルでの正規化ポリシーが不統一。

---

### I-3. `context.WithCancel` の不要な二重生成
**ファイル**: `app_worktree_api.go` (CreateSessionWithWorktree L170-174)  
**種別**: リソースリーク（軽微）  

`context.WithCancel(context.Background())` を一度生成した直後に `appCtx != nil` の場合に破棄して再生成している。最初のcontextのcancelが呼ばれずリークする。

```go
// 現行: 1つ目のcontextが即座に無駄になる
setupScriptsCtx, cancel := context.WithCancel(context.Background())
if appCtx := a.runtimeContext(); appCtx != nil {
    setupScriptsCtx, cancel = context.WithCancel(appCtx)
}

// 修正案: 親contextを先に決定してから1回だけWithCancel
parentCtx := context.Background()
if appCtx := a.runtimeContext(); appCtx != nil {
    parentCtx = appCtx
}
setupScriptsCtx, cancel := context.WithCancel(parentCtx)
```

---

### I-4. `BranchName` バリデーションの重複
**ファイル**: `app_worktree_api.go` (CreateSessionWithWorktree L107-109 + createWorktreeForSession L200-203)  
**種別**: DRY違反  

`BranchName` の `TrimSpace` + 空チェック + 同一エラーメッセージが呼び出し元 `CreateSessionWithWorktree` と呼び出し先 `createWorktreeForSession` で完全に重複。どちらか一方にバリデーションを集約すべき。

---

### I-5. `CleanupLocalBranchIfOrphaned` — fully localリポジトリでの動作
**ファイル**: `internal/git/git.go` (CleanupLocalBranchIfOrphaned L140-175)  
**種別**: 設計リスク  

remote なしのリポジトリでは `listRemoteBranchNames()` が空mapを返し、`hasLiveUpstream()` もfalseになるため、**現在checkoutされていない全マージ済みローカルブランチ**がorphan判定される。`-d` フラグ（マージ済みのみ）を使用しているため未マージブランチは保護されるが、docstringに「caller は `git fetch --prune` を事前推奨」旨の追記が望ましい。

---

### I-6. `KillSession` — ワークツリー削除失敗がAPI応答に含まれない
**ファイル**: `app_session_api.go` (KillSession L123-130)  
**種別**: サイレント失敗リスク  

`deleteWorktree=true` で `GetWorktreeInfo` が失敗した場合、フロントエンドイベントのみ発火し `return nil`。ユーザーはUIイベント経由でのみ失敗を知れるため、UIがイベントをハンドリングしていなければサイレント失敗。

---

### I-7. テストカバレッジ — `runSetupScriptsWithParentContext` のコンテキストキャンセルパス未テスト
**ファイル**: `app_worktree_api_test.go`  
**種別**: テストカバレッジ不足  

テストは全て `runSetupScripts` 経由（`parentCtx = nil`）で呼んでおり、非nil parentContextのキャンセル伝播テストがない。本番コードでは `context.WithCancel(appCtx)` で非nilコンテキストを渡し、deferで `setupScriptsCancel()` を行うが、スクリプト実行の中断動作が検証されていない。

---

### I-8. テストカバレッジ — `createWorktreeForSession` のidentifierフォールバック未テスト
**ファイル**: `app_worktree_api_test.go`  
**種別**: テストカバレッジ不足  

`SanitizeCustomName` フォールバックロジック（identifier が空文字列 or `"work"` の場合にセッション名→タイムスタンプへフォールバック）が直接テストされていない。`identifier == "work"` のガード条件はエッジケースとして重要。

---

### I-9. テストカバレッジ — `doClose` のプロセス待機パス未テスト
**ファイル**: `internal/terminal/conpty_close_windows_test.go`  
**種別**: テストカバレッジ不足  

`doClose` のテストは全てnil/ゼロハンドルの `ConPty` のみ使用。`WaitForSingleObject` が `WAIT_TIMEOUT` を返した場合の `TerminateProcess` 呼び出しパスが未検証。

---

### I-10. `HasUnpushedCommits` のエラー文字列パターンマッチ  
**ファイル**: `internal/git/git.go` (HasUnpushedCommits + isNoUpstreamTrackingError)  
**種別**: ロバスト性  

`err.Error()` の文字列パターンマッチに依存。日本語ロケールWindows等ではgitエラーメッセージが変化する可能性がある。`localeNeutralGitEnv` により `LC_ALL=C` が設定されているため大半のケースは保護されるが、`containsUpstreamToken` で明示的に `@{u}` / `@{upstream}` トークンを要求することでオーバーマッチを防いでいる。NOTE コメントに自己認識あり。

---

### I-11. `ensurePathContains` のnon-atomic read-modify-write
**ファイル**: `internal/install/shim_path_windows.go` (ensurePathContains L48-68)  
**種別**: 並行性リスク（低頻度）  

同一ハンドルで読み書きするがトランザクション未使用。別インストーラが同時にPATH更新した場合に変更消失の可能性。インストール時のみの操作で頻度が低いため実用上許容範囲。コメントで制約の明記が望ましい。

---

## Suggestion 指摘

### S-1. `CreateSession` でgitメタデータ取得のネスト改善
**ファイル**: `app_session_api.go` (L83-96)  
`IsGitRepository` → `Open` → `CurrentBranch` の3段ネストを早期リターンパターンに変換すると可読性向上。

### S-2. `validateConPtyDimensions` の二重呼び出し
**ファイル**: `internal/terminal/conpty_windows.go` (startConPty L121, L125)  
カスタム次元設定時に同一値で2回検証。2回目はデフォルト値(80x40)の検証で常に成功するため冗長。

### S-3. `storeRootPath` 失敗時のワーキングツリーメタデータクリーンアップ
**ファイル**: `app_session_api.go` (L101)  
ロールバック対象にworktreeメタデータのクリーンアップが含まれていない。セッション削除でメタデータも消えるため影響は軽微だが一貫性の観点で留意。

### S-4. `identifier == "work"` のマジックストリング
**ファイル**: `app_worktree_api.go` (L231)  
`SanitizeCustomName` のデフォルト出力を定数に抽出するか、docに動作を明記すべき。

### S-5. `runGitCommandRaw` の命名
**ファイル**: `internal/git/command.go` (L140)  
「Raw」と命名されているが末尾の `\n\r` はTrimRight。`runGitCommandKeepWhitespace` のような名前かdocの強調が望ましい。

### S-6. `isNoUpstreamTrackingError` の後半2条件統合
**ファイル**: `internal/git/git.go`  
後半の2つの`if`は共通ガード `containsUpstreamToken` を持つため1つに統合可能。

### S-7. `CheckoutNewBranch` のエラーラッピング欠如
**ファイル**: `internal/git/git.go` (CheckoutNewBranch)  
`DeleteLocalBranch`, `CheckoutDetachedHead` はエラーをラッピングしているが `CheckoutNewBranch` はラッピングなし。一貫性の問題。

### S-8. テスト — スラッシュ付きブランチのend-to-end cleanup テスト
**ファイル**: `internal/git/git_test.go`  
パースレベルではカバー済みだが `CleanupLocalBranchIfOrphaned` の end-to-end で `feature/team/task-123` のケース追加が望ましい。

### S-9. テスト — `readRegistryPathRawValueWithRetry` のハッピーパステスト
**ファイル**: `internal/install/shim_installer_windows_test.go`  
初回読み取り成功のシンプルなケースが明示的にテストされていない。

### S-10. テスト — `GetPaneReplay` の空文字列paneIDケース
**ファイル**: `app_pane_api_test.go`  
`GetPaneEnv` は空文字列テスト済みだが `GetPaneReplay` の空文字列入力テストが欠如。

### S-11. `PruneWorktrees` エラーのフロントエンド通知なし
**ファイル**: `app_session_api.go` (cleanupSessionWorktree L185-187)  
他のエラーパスでは `emitWorktreeCleanupFailure` を呼ぶが、Prune失敗はログのみ。

### S-12. `runSetupScripts` ラッパーの必要性
**ファイル**: `app_worktree_api.go`  
`runSetupScripts` は `runSetupScriptsWithParentContext(nil, ...)` を呼ぶだけの1行ラッパーでテストからのみ使用。

### S-13. `readRegistryPathRawValueWithRetry` のリトライ上限エラーメッセージ
**ファイル**: `internal/install/shim_path_windows.go` (L119-168)  
最後のリトライ時のエラー原因（ERROR_MORE_DATA継続/バッファ超過）が含まれていない。

---

## 良い点（Positive Findings）

1. **ロールバックパターンの堅牢性**: `CreateSession`/`CreateSessionWithWorktree` の `defer` + ロールバックパターンが正しく適用。エラーチェイニング（`%w (session rollback also failed: %v)`）で情報損失なし
2. **`--` セパレータの一貫使用**: git CLI引数でユーザー由来の値がフラグ解釈されることを防止
3. **`ValidateBranchName`/`ValidateWorktreePath` の一貫適用**: 全公開APIエントリポイントでバリデーション
4. **`-d` フラグ選択**: orphanブランチ削除で `-D` ではなく `-d` を使用し、未マージコミットの意図せぬ削除を防止
5. **`localeNeutralGitEnv` の一貫使用**: git出力のパースがロケール非依存
6. **handleIO の二層ロック設計**: `stateMu (RWMutex)` + `handleIO.mu (Mutex)` でblocking I/O中のデッドロック回避
7. **テスト品質**: テーブル駆動テスト、structフィールドカウントガード、`t.Cleanup` による適切なリストア
8. **`readRegistryPathRawValueWithRetry` の堅牢性**: `ERROR_MORE_DATA` ハンドリング、valueType一貫性チェック、bounded retry
9. **`decodeRegistryUTF16String`**: BOM、奇数バイト長、null終端の全パターン対応
10. **`runtime.KeepAlive(envBlock)`**: GC安全性の適切な確保

---

## 並列修正可否テーブル

| ID | 指摘 | 対象ファイル | 並列修正 | 優先度 | 備考 |
|----|------|-------------|---------|--------|------|
| I-1 | handleIO.Read InvalidHandleチェック | conpty_windows.go | ✅可 | 高 | I-2と同時修正可 |
| I-2 | handleIO.Write エラー正規化不統一 | conpty_windows.go | ✅可 | 中 | I-1と同時修正可 |
| I-3 | context.WithCancel 二重生成 | app_worktree_api.go | ✅可 | 中 | I-4と同時修正可 |
| I-4 | BranchName バリデーション重複 | app_worktree_api.go | ✅可 | 低 | I-3と同時修正可 |
| I-5 | CleanupLocalBranchIfOrphaned docstring | git.go | ✅可 | 低 | 独立修正 |
| I-6 | KillSession worktree削除失敗の扱い | app_session_api.go | ⚠️要確認 | 中 | UI側の購読確認が必要 |
| I-7 | setupScriptsキャンセルパスのテスト追加 | app_worktree_api_test.go | ✅可 | 中 | I-8と同時修正可 |
| I-8 | identifierフォールバックのテスト追加 | app_worktree_api_test.go | ✅可 | 中 | I-7と同時修正可 |
| I-9 | doCloseプロセス待機パスのテスト追加 | conpty_close_windows_test.go | ✅可 | 中 | 独立修正 |
| I-10 | HasUnpushedCommits 文字列マッチ | git.go | ⚠️要確認 | 低 | localeNeutralGitEnvで保護済み |
| I-11 | ensurePathContains non-atomic | shim_path_windows.go | ✅可 | 低 | コメント追記のみ |
| S-1 | gitメタデータ取得のネスト改善 | app_session_api.go | ✅可 | 低 | |
| S-2 | validateConPtyDimensions 二重呼び出し | conpty_windows.go | ✅可 | 低 | I-1/I-2と同時修正可 |
| S-4 | "work" マジックストリング定数化 | app_worktree_api.go | ✅可 | 低 | I-3/I-4と同時修正可 |
| S-6 | isNoUpstreamTrackingError 条件統合 | git.go | ✅可 | 低 | I-5と同時修正可 |
| S-7 | CheckoutNewBranch エラーラッピング | git.go | ✅可 | 低 | I-5/S-6と同時修正可 |

### 並列修正グループ

| グループ | 修正対象 | 担当可能な独立ワーカー |
|---------|---------|---------------------|
| **Group A** (ConPTY) | I-1, I-2, S-2, I-9 | ワーカー1 |
| **Group B** (Worktree API) | I-3, I-4, S-4, S-12 | ワーカー2 |
| **Group C** (Git Internal) | I-5, S-6, S-7, I-10 | ワーカー3 |
| **Group D** (テスト追加) | I-7, I-8, S-8, S-9, S-10 | ワーカー4 |
| **Group E** (要確認) | I-6, I-11 | 設計判断後に着手 |

---

## レビュー担当エージェント

| エージェント | 対象カテゴリ | 指摘数 |
|------------|------------|--------|
| コード品質レビュー | App Layer (Session/Worktree API) | 12件 |
| Git Internalレビュー | internal/git | 7件 |
| Terminal/Installレビュー | internal/terminal, internal/install | 10件 |
| テスト品質レビュー | 全テストファイル | 9件 |
| エラーハンドリングレビュー | 全本番コード | 13件 |
| コード簡素化レビュー | 全変更ファイル | 8件 |
