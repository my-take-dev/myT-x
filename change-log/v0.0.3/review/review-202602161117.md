# コードレビュー結果 — myT-x コミット前レビュー

**日時**: 2026-02-16 11:17  
**対象**: `myT-x/` 配下の変更ファイル 15件（約2987行追加、206行削除）  
**レビュー方法**: 4カテゴリに分割し並列レビューを実施  

---

## 対象ファイル一覧

| カテゴリ | ファイル |
|---------|---------|
| App API | `app_session_api.go`, `app_worktree_api.go`, `app_pane_api_test.go`, `app_session_api_test.go`, `app_worktree_api_test.go` |
| Git Package | `internal/git/command.go`, `command_test.go`, `git.go`, `git_test.go`, `worktree.go` |
| Install Package | `internal/install/shim_path_windows.go`, `shim_installer_windows_test.go` |
| Terminal Package | `internal/terminal/conpty_windows.go`, `conpty_close_windows_test.go`, `conpty_syscall_windows_test.go` |

---

## レビューサマリー

| 重要度 | 件数 |
|--------|------|
| Critical | 0 |
| Important | 13 |
| Suggestion | 18 |
| Positive（良い点） | 22 |

---

## Important（修正推奨）

### I-01: `rollbackWorktree` でブランチのクリーンアップが漏れている 
**ファイル**: `app_worktree_api.go` — `rollbackWorktree()`  
**問題**: `CreateSessionWithWorktree` のロールバック時、worktreeディレクトリの削除とpruneのみ行うが、`repo.CreateWorktree(wtPath, branchName, baseBranch)` で作成されたローカルブランチを削除しない。正常フロー側の `cleanupSessionWorktree` は `cleanupOrphanedLocalWorktreeBranch` を呼んでブランチも削除しており、不整合。  
**修正案**: `rollbackWorktree` に `branchName` パラメータを追加し、`repo.CleanupLocalBranchIfOrphaned(branchName)` を呼ぶ。

---

### I-02: `CreateSessionWithWorktree` のロールバック時、setup goroutineの終了を待たずにworktreeを削除
**ファイル**: `app_worktree_api.go` — defer rollback  
**問題**: `setupScriptsCancel()` 後、goroutine内のプロセスが完全終了する前に `rollbackWorktree` → `RemoveWorktreeForced` が呼ばれる。Windows環境ではスクリプトプロセスがworktreeディレクトリ内のファイルをロック中だと削除失敗の可能性がある。  
**修正案**: ロールバック時に `setupWG.Wait()` をタイムアウト付きで待つか、この制約をコメントで明示する。

---

### I-03: `createWorktreeForSession` で `normalizeWorktreeBranchName` が二重呼び出し
**ファイル**: `app_worktree_api.go` — `CreateSessionWithWorktree()` → `createWorktreeForSession()`  
**問題**: `CreateSessionWithWorktree` で `normalizeWorktreeBranchName(opts.BranchName)` 呼び出し済みなのに、`createWorktreeForSession` 内で再度呼ばれている。  
**修正案**: `createWorktreeForSession` 側の呼び出しを削除するか、`createWorktreeForSession` を独立して呼べる設計意図であることをコメントで明示。

---

### I-04: `CreateWorktree` で `baseBranch` のバリデーションが欠落
**ファイル**: `internal/git/worktree.go` — `CreateWorktree()`  
**問題**: `worktreePath` と `branchName` はバリデーションされているが、`baseBranch` はバリデーションなしでgitコマンドに渡される。`baseBranch` もユーザー入力由来であれば `ValidateBranchName` を適用すべき。  
**修正案**: 
```go
if err := ValidateBranchName(baseBranch); err != nil {
    return fmt.Errorf("invalid base branch name: %w", err)
}
```

---

### I-05: worktree.go / git.go のエラーが `%w` ラップされていない箇所がある
**ファイル**: `internal/git/worktree.go` 全体, `internal/git/git.go` — `Pull()`, `Push()`  
**問題**: バリデーションエラーは `%w` でラップされているが、gitコマンド失敗時のエラーは生のまま返却。呼び出し元が `errors.Is` / `errors.As` で分類したい場合に困る。`CheckoutNewBranch`, `DeleteLocalBranch`, `CommitAll` 等は統一されている。  
**修正案**: `fmt.Errorf("failed to ...: %w", err)` で統一。  
**該当箇所**: 
- `CreateWorktree` → `return err`
- `CreateWorktreeFromBranch` → `return err`
- `CreateWorktreeDetached` → `return err` (2箇所)
- `RemoveWorktree` → `return err`
- `RemoveWorktreeForced` → `return err`
- `PruneWorktrees` → `return err`
- `Pull` → `return err`
- `Push` → `return err`

---

### I-06: `Open()` でパスの正規化がされていない
**ファイル**: `internal/git/git.go` — `Open()`  
**問題**: `path` は `TrimSpace` されるのみで `filepath.Clean` が適用されない。相対パスや `../` 付きパスがそのまま `Repository.path` に格納されると、ログ出力やパス比較で不整合が起きうる。  
**修正案**: `path = filepath.Clean(strings.TrimSpace(path))`

---

### I-07: `EnsureProcessPathContains` — `os.Setenv` のエラーを無視
**ファイル**: `internal/install/shim_installer_windows.go` — `EnsureProcessPathContains()`  
**問題**: `os.Setenv("PATH", ...)` のエラーが無視されている。CLAUDE.mdの「エラー処理は明示的に行う」ポリシーに違反。  
**修正案**:
```go
if err := os.Setenv("PATH", currentPath+";"+dir); err != nil {
    slog.Warn("[WARN-SHIM] failed to update process PATH", "error", err)
    return false
}
```

---

### I-08: `readRegistryPathRawValueWithRetry` — retryパスで valueType 整合性チェック漏れ
**ファイル**: `internal/install/shim_path_windows.go` — `readRegistryPathRawValueWithRetry()`  
**問題**: `n > len(buffer)` のretryパスでは `valueTypeRead` がそのまま受け入れられるが、正常パスでは型チェックが行われる。不正な型（`registry.BINARY` 等）がチェックをバイパスする可能性。  
**修正案**: retryの前にも型チェックを追加。
```go
if n > len(buffer) {
    if valueTypeRead != registry.SZ && valueTypeRead != registry.EXPAND_SZ {
        return nil, registry.NONE, fmt.Errorf("read user PATH from registry: unsupported value type %d on size-growth retry", valueTypeRead)
    }
    rawSize = n
    valueType = valueTypeRead
    continue
}
```

---

### I-09: `handleIO.Close()` — `CloseHandle` エラー時にログ出力がない
**ファイル**: `internal/terminal/conpty_windows.go` — `handleIO.Close()`  
**問題**: `doClose` では `firstErr` に集約されるが、パイプ2本のうち最初のCloseエラーしか返されない。`closeHandles` ではデバッグログを出しているのに `handleIO.Close` では出していない。  
**修正案**: エラー時にログ追加。
```go
err := windows.CloseHandle(handle)
if err != nil {
    slog.Debug("[DEBUG-CONPTY] handleIO.Close failed", "error", err)
}
return err
```

---

### I-10: `createEnvBlock` のGoDocに `runtime.KeepAlive` 必須の注記がない
**ファイル**: `internal/terminal/conpty_syscall_windows.go` — `createEnvBlock()`  
**問題**: 返値の `*uint16` はGoスライスの内部ポインタであり、GCによる回収リスクがある。呼び出し元で `runtime.KeepAlive(envBlock)` は正しく使用されているが、関数のGoDocに注記がない。  
**修正案**: 関数コメントに追加:
```go
// IMPORTANT: The caller MUST use runtime.KeepAlive on the returned pointer
// until the Windows API call that consumes it has returned.
```

---

### I-11: `startConPty` — dimensions validation の二重呼び出し
**ファイル**: `internal/terminal/conpty_windows.go` — `startConPty()`  
**問題**: `hasCustomDimensions == true` の場合、`validateConPtyDimensions` が2回実行される。デフォルト値（80, 40）は定数で保証済みのため、カスタム指定時のみ検証すれば十分。  
**修正案**: 2つ目のバリデーションを `!args.hasCustomDimensions` の場合のみ実行するか、削除。

---

### I-12: テスト不足 — `CreateWorktreeFromBranch` のテストが存在しない
**ファイル**: `internal/git/` テスト全体  
**問題**: `CreateWorktree` と `CreateWorktreeDetached` はテストされているが、`CreateWorktreeFromBranch` のテストがない。  

---

### I-13: テスト不足 — worktree API のエラーパステスト
**ファイル**: `app_worktree_api_test.go`  
**不足テスト一覧**:

| 対象関数 | 不足テスト |
|---------|---------|
| `PromoteWorktreeToBranch` | `sessionName` が空の場合 |
| `PromoteWorktreeToBranch` | 無効なブランチ名 |
| `CommitAndPushWorktree` | `sessionName` が空の場合 |
| `CheckWorktreeStatus` | `sessionName` が空の場合 |
| `CleanupWorktree` | `sessionName` が空の場合 |
| `CreateSessionWithExistingWorktree` | worktree機能が無効の場合 |
| `CreateSessionWithExistingWorktree` | `enableAgentTeam=true` |
| `CreateSession` | `storeRootPath` 失敗時のロールバック |

---

## Suggestion（改善提案）

### S-01: `CreateSession` で空名返却時に孤立セッションログ欠如
**ファイル**: `app_session_api.go`  
tmux が `ExitCode == 0` かつ空白 `Stdout` を返した場合、`sessionMayExist = true` だが `createdName = ""` でロールバック対象外。エラーは返すが孤立リスクのログがない。

### S-02: `cleanupSessionWorktree` の失敗が `KillSession` の戻り値に反映されない
**ファイル**: `app_session_api.go`  
設計上の選択だが、コメントで意図を明示すべき。

### S-03: `runSetupScriptsWithParentContext` で `parentCtx` のキャンセル済みチェック
**ファイル**: `app_worktree_api.go`  
`runtimeContext()` が `nil` の場合にキャンセル済み `parentCtx` がフォールバックで使われる。

### S-04: `runGitCLI` の defer ログでエラーステータスが記録されない
**ファイル**: `internal/git/command.go`  
成功/失敗の判別のため `"success", err == nil` をログに追加する提案。

### S-05: `ListWorktrees` が空結果で `nil` を返す（`ListBranches` は空スライス返却と不統一）
**ファイル**: `internal/git/worktree.go`  
`var worktrees []string` → `worktrees := make([]string, 0)` で統一。

### S-06: `ValidateWorktreePath` の `..` チェックが `filepath.Clean` 前の生パスに対して行われている
**ファイル**: `internal/git/validation.go`  
`C:\folder..name` のような合法パスも拒否されうる（実害は極小）。

### S-07: `FindAvailableWorktreePath` の上限 100 がハードコーディング
**ファイル**: `internal/git/validation.go`  
定数化で意図明確化。

### S-08: `Open()` でパスが実在するか確認がない
**ファイル**: `internal/git/git.go`  
`git rev-parse --git-dir` で検出されるため実害なし。エラーメッセージがわかりにくいのみ。

### S-09: `containsPathEntry` — 8.3短縮名やシンボリックリンクの解決なし
**ファイル**: `internal/install/shim_path_windows.go`  
現行で十分。インストールディレクトリはLOCALAPPDATA下のシンプルパスのため問題発生しづらい。

### S-10: `broadcastEnvironmentSettingChange` のテストがない
**ファイル**: `internal/install/shim_path_windows.go`  
Win32 API直接呼出しでテストシームなし。失敗がnon-fatalのためリスク低。

### S-11: `createEnvBlock` テストの `maxUTF16Units` 上限が大きすぎる
**ファイル**: `internal/terminal/conpty_syscall_windows_test.go`  
テストヘルパーなのでプロダクション影響なし。

### S-12: `normalizeConPtyPipeError` / `normalizeWriteFileError` のエラーコード重複
**ファイル**: `internal/terminal/conpty_windows.go`  
変換先が異なるため設計上意図的。

### S-13: `TestConPtyReadWriteAfterCloseReturnErrors` に4アサーション混在
**ファイル**: `internal/terminal/conpty_close_windows_test.go`  
テーブル駆動に分離するとどの操作が失敗したか明確に。

### S-14: `doClose` テストで `InvalidHandle` を使用する理由コメント欠如
**ファイル**: `internal/terminal/conpty_close_windows_test.go`  
`closeHandles` が `InvalidHandle` スキップ処理に入るため実際のCloseパスは未テスト。

### S-15: `listRemoteBranchNames` がスラッシュ含むリモート名に非対応
**ファイル**: `internal/git/git.go`  
既にコメントで認識済み。将来的に `git for-each-ref --format` で正確に分離可能。

### S-16: `handleIO` の Read/Write — Mutex使用パターン
**ファイル**: `internal/terminal/conpty_windows.go`  
ハンドル取得→即アンロック→ReadFile/WriteFile間にClose競合の理論的リスク。既存コメントで意図明記済み、`normalizeConPtyPipeError` で無害化。将来的にRWMutex保持パターンへの移行を検討可。

### S-17: `decodeRegistryUTF16String` — サロゲートペア不正データ
**ファイル**: `internal/install/shim_path_windows.go`  
`utf16.Decode` がU+FFFDに変換。PATHには基本ASCII文字のみで実害なし。

### S-18: `ensurePathContains` のDual-check設計
**ファイル**: `internal/install/shim_path_windows.go`  
設計意図は正しいが、コメントで意図を明示すると保守性向上。

---

## Positive（良い点）

### コード品質
1. **ロールバックパターンが一貫して堅牢**: `CreateSession`, `CreateSessionWithWorktree`, `CreateSessionWithExistingWorktree`, `PromoteWorktreeToBranch` 全てでdeferによるロールバック実装。失敗時に元エラーとロールバックエラーが複合化される。
2. **Best-effortとHard-errorの適切な使い分け**: git meta取得失敗は `slog.Warn` でログのみ（継続）、重大エラーはreturn。
3. **パストラバーサル防御が二重チェック**: `copyConfigFilesToWorktree` で `filepath.Clean` + `strings.HasPrefix`。テストもカバー。
4. **入力バリデーションの一貫性**: 全API関数先頭で `strings.TrimSpace` + 空チェック統一。

### セキュリティ
5. **gitコマンドインジェクション防御**: `runGitCLI` は `"git"` バイナリのみ実行。SECURITY注記あり。`--` セパレータで引数インジェクション防止。
6. **ブランチ名・worktreeパスのバリデーション**: `ValidateBranchName`, `ValidateWorktreePath` が一貫適用。
7. **`runtime.KeepAlive(envBlock)` の適切な使用**: GC回収防止が正しく実装。

### 並行処理
8. **goroutineパニック対策**: `recoverBackgroundPanic` + `setupWG.Done()` のdefer順序がLIFOに沿って正しい。
9. **セマフォによるgit並行制御**: プロセスワイド semaphore、タイムアウト付きacquire。
10. **`closeOnce` + `doClose` パターン**: `sync.Once` によるClose冪等性保証、リソース解放順序が正確。

### エラー処理
11. **index.lock リトライの堅実実装**: exponential backoff、lock conflict検出、テストが境界条件を網羅。
12. **エラーメッセージの一貫性**: `fmt.Errorf("... : %w", err)` 形式で文脈情報付き。
13. **レジストリretryの堅牢性**: `ERROR_MORE_DATA` 対応、サイズリフレッシュ、型整合チェック、回数制限を網羅。

### テスト
14. **テーブル駆動テストの一貫使用**: 全パッケージで統一。
15. **フィールド数ガードテスト**: struct変更時の漏れ防止。
16. **実git/レジストリ統合テスト**: bare/clone/worktreeの各シナリオカバー。
17. **テストシーム設計**: `waitForSingleObjectFn`, `terminateProcessFn`, `executeRouterRequestFn`, `currentBranchFn` 等のDI。

### Windows固有
18. **RegistryPath読み取りretry**: 11テストパターンで全エッジケースカバー。
19. **`containsPathEntry` の正規化**: 大文字小文字、`filepath.Clean`、空白トリム、空エントリスキップ。
20. **`installShimIfChanged` のハッシュ差分検知**: SHA256変更検知、graceful degradation。
21. **ConPTY dimension validation**: 1-32767の範囲を適切に検証。

### デバッグ支援
22. **ログ命名規則の統一**: `[DEBUG-SESSION]`, `[DEBUG-GIT]`, `[DEBUG-CONPTY]`, `[DEBUG-SHIM]` で一括削除容易。

---

## タスク整理表

以下は修正タスクの一覧と、並列作業の可否を示す。

| # | 重要度 | タスク概要 | 対象ファイル | 並列修正 | 理由 |
|---|--------|-----------|-------------|---------|------|
| I-01 | Important | `rollbackWorktree` にブランチクリーンアップ追加 | `app_worktree_api.go` | ⚠️ I-02, I-03 と同一ファイル | |
| I-02 | Important | ロールバック時のgoroutine終了待機 | `app_worktree_api.go` | ⚠️ I-01, I-03 と同一ファイル | |
| I-03 | Important | `normalizeWorktreeBranchName` 二重呼び出し除去 | `app_worktree_api.go` | ⚠️ I-01, I-02 と同一ファイル | |
| I-04 | Important | `CreateWorktree` に `baseBranch` バリデーション追加 | `internal/git/worktree.go` | ✅ 独立修正可 | |
| I-05 | Important | worktree.go / git.go のエラー `%w` ラップ統一 | `internal/git/worktree.go`, `git.go` | ⚠️ I-04 と同一ファイル | |
| I-06 | Important | `Open()` にパス正規化追加 | `internal/git/git.go` | ⚠️ I-05 と同一ファイル | |
| I-07 | Important | `EnsureProcessPathContains` `os.Setenv` エラー処理 | `internal/install/shim_installer_windows.go` | ✅ 独立修正可 | |
| I-08 | Important | registry retry の値型チェック追加 | `internal/install/shim_path_windows.go` | ✅ 独立修正可 | |
| I-09 | Important | `handleIO.Close()` エラーログ追加 | `internal/terminal/conpty_windows.go` | ⚠️ I-10, I-11 と同一ファイル | |
| I-10 | Important | `createEnvBlock` GoDoc に KeepAlive 注記追加 | `internal/terminal/conpty_syscall_windows.go` | ✅ 独立修正可 | |
| I-11 | Important | `startConPty` dimensions 二重バリデーション修正 | `internal/terminal/conpty_windows.go` | ⚠️ I-09 と同一ファイル | |
| I-12 | Important | `CreateWorktreeFromBranch` テスト追加 | `internal/git/*_test.go` | ✅ 独立修正可 | |
| I-13 | Important | worktree API エラーパステスト追加 | `app_worktree_api_test.go` | ✅ 独立修正可 | |

### 並列修正グループ

| グループ | タスク | 理由 |
|---------|--------|------|
| **Group A** — 同一ファイル（`app_worktree_api.go`） | I-01, I-02, I-03 | 同一ファイルの近接箇所を変更するため順次作業推奨 |
| **Group B** — 同一ファイル群（`internal/git/`） | I-04, I-05, I-06 | worktree.go と git.go を両方変更。順次推奨 |
| **Group C** — 同一ファイル（`conpty_windows.go`） | I-09, I-11 | 同一ファイル内の独立箇所だが順次推奨 |
| **独立タスク** | I-07, I-08, I-10, I-12, I-13 | 他タスクと完全に独立。並列修正可能 |

### 推奨修正順序

```
Phase 1（並列実行可能）:
  ├── I-07: install shim Setenv エラー処理
  ├── I-08: registry retry 型チェック
  ├── I-10: createEnvBlock GoDoc
  ├── I-12: CreateWorktreeFromBranch テスト
  └── I-13: worktree API エラーパステスト

Phase 2（Group B: internal/git → 順次）:
  I-04 → I-05 → I-06

Phase 3（Group A: app_worktree_api.go → 順次）:
  I-01 → I-03 → I-02

Phase 4（Group C: conpty_windows.go → 順次）:
  I-09 → I-11
```

---

## レビュー総括

全体として**高品質なコードベース**です。特に以下の点が優秀です：
- ロールバックパターンの一貫した堅牢性
- Windows syscall操作（レジストリ、ConPTY）の安全な実装
- テストシームによるテスタビリティ設計
- デバッグログの命名規則統一

Critical指摘は0件。Important 13件の大部分は、エラーハンドリングの統一性向上とテストカバレッジ拡充です。
