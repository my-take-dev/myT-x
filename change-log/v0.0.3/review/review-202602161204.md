# PR Review Summary — 2026/02/16 12:04

## レビュー対象

| カテゴリ | ファイル | 変更行数 |
|---------|--------|---------|
| App Layer (Session/Worktree/Pane API) | app_session_api.go, app_session_api_test.go, app_worktree_api.go, app_worktree_api_test.go, app_pane_api_test.go | +654 / -24 |
| Internal Git Library | internal/git/command.go, command_test.go, git.go, git_test.go, worktree.go, worktree_test.go | +1,160 / -33 |
| Install/Shim Package | internal/install/shim_installer_windows.go, shim_installer_windows_test.go, shim_path_windows.go | +506 / -0 |
| Terminal/ConPTY Package | internal/terminal/conpty_windows.go, conpty_syscall_windows.go, conpty_syscall_windows_test.go, conpty_close_windows_test.go | +586 / -169 |
| **合計** | **18 files** | **+3,378 / -226** |

## レビューエージェント構成

| エージェント | 担当カテゴリ | 観点 |
|------------|------------|------|
| code-reviewer + silent-failure-hunter | App Layer | コード品質、エラーハンドリング、API設計 |
| code-reviewer + type-design-analyzer | Git Library | コマンド安全性、型設計、テスト品質 |
| security-engineer + silent-failure-hunter | Install/Shim | パス安全性、レジストリ操作、セキュリティ |
| code-reviewer + type-design-analyzer | Terminal/ConPTY | リソース管理、並行処理、Windows API |
| pr-test-analyzer | 全ファイル | テストカバレッジ、品質、パターン |
| code-simplifier + comment-analyzer | 全ソースファイル | 重複、簡素化、コメント品質 |

---

## Critical Issues (0件)

**致命的な問題は検出されませんでした。**

コマンドインジェクション防御、リソースリーク防止、メモリ安全性、デッドロック防止のいずれも適切に実装されています。

---

## Important Issues (8件)

### IMP-1: `CreateSessionWithExistingWorktree` で `repoPath` の空文字チェック欠如
- **ファイル**: app_worktree_api.go:412
- **カテゴリ**: App Layer
- **説明**: `CreateSessionWithWorktree` は `repoPath` を `TrimSpace` 後に `IsGitRepository` で検証しているが、`CreateSessionWithExistingWorktree` は `repoPath` が空文字でもそのまま `os.Stat(worktreePath)` へ進む。空の `RepoPath` がメタデータに保存されると、後続の `CleanupWorktree` や `CheckWorktreeStatus` で `gitpkg.Open("")` が呼ばれ予期しないエラーになる。
- **修正案**:
```go
if repoPath == "" {
    return tmux.SessionSnapshot{}, errors.New("repository path is required")
}
```

### IMP-2: `CreateSessionWithExistingWorktree` で `worktreePath` の空文字チェック欠如
- **ファイル**: app_worktree_api.go:421-424
- **カテゴリ**: App Layer
- **説明**: `worktreePath` が空文字（スペースのみ含む）の場合、`os.Stat("")` の結果はプラットフォーム依存でエラーメッセージが不明瞭。
- **修正案**:
```go
if worktreePath == "" {
    return tmux.SessionSnapshot{}, errors.New("worktree path is required")
}
```

### IMP-3: `IsValidBranchName` でパストラバーサル的な名前 `a/../b` が通過する
- **ファイル**: internal/git/validation.go:38-41
- **カテゴリ**: Git Library
- **説明**: `filepath.Clean("a/../b")` は `"b"` に正規化されるため `".."` チェックを通過する。git 自体が `check-ref-format` で拒否するため実害はないが、バリデーション関数としての正確性が損なわれている。コメントの「catches raw '..' sequences」と実装が乖離。
- **修正案**:
```go
// filepath.Clean を使わず、直接 ".." を検出する
if strings.Contains(name, "..") {
    return false
}
```

### IMP-4: セッション作成ロジックの重複
- **ファイル**: app_session_api.go:57-73 と app_worktree_api.go:198-221
- **カテゴリ**: コード品質
- **説明**: `CreateSession` の tmux `new-session` コマンド実行ロジックが `createSessionForDirectory` とほぼ同一。エラーメッセージも不整合（`CreateSession`: prefix無し、`createSessionForDirectory`: `"failed to create session: %s"` prefix有り）。
- **修正案**: `CreateSession` 内で `createSessionForDirectory` を呼び出す統合を検討。

### IMP-5: `normalizeWorktreeBranchName` の命名が不正確
- **ファイル**: app_worktree_api.go:224-228
- **カテゴリ**: コード品質
- **説明**: 関数名は「正規化」を示唆するが、実際には TrimSpace + 空文字チェック + バリデーションのみ。正規化（大文字変換、文字置換等）は行っていない。
- **修正案**: `validateBranchNameForWorktree` や `validateAndTrimBranchName` の方が正確。

### IMP-6: `EnsureProcessPathContains` に排他制御がない
- **ファイル**: internal/install/shim_installer_windows.go:102-113
- **カテゴリ**: Install/Shim
- **説明**: `os.Getenv("PATH")` → `containsPathEntry` → `os.Setenv("PATH", ...)` の間にTOCTOU隙間がある。現在は単一スタートアップスレッドから呼ばれるため問題にならないが、将来複数箇所から呼ばれた場合にサイレント重複追加の可能性あり。
- **修正案**: `ensurePathMu` で保護するか、「シングルスレッドで呼ぶこと」のコメント追加。

### IMP-7: `handleIO.Read/Write` のレースウィンドウ設計意図のコメント不足
- **ファイル**: internal/terminal/conpty_windows.go:33-39
- **カテゴリ**: Terminal/ConPTY
- **説明**: `Read` がハンドル値をコピーした直後に `Close()` が同じハンドルを `CloseHandle` する可能性がある。`ConPty.Read` のコメント(L232-234)では意図的設計と記述されているが、`handleIO` 自体にこの設計意図のコメントがない。
- **修正案**: `handleIO.Read` / `handleIO.Write` にも設計意図コメントを追加。

### IMP-8: `doClose` で `TerminateProcess` 後にプロセスの終了を待っていない
- **ファイル**: internal/terminal/conpty_windows.go:270-276
- **カテゴリ**: Terminal/ConPTY
- **説明**: `TerminateProcess` は非同期API。呼び出し後すぐに `closeHandles` でハンドルを閉じている。Windows ではカーネルオブジェクトが存続するため実害は低いが、短い `WaitForSingleObject` (100ms等) を追加すると堅牢になる。

---

## Suggestions (21件)

### コード品質・設計

| # | ファイル | 指摘内容 |
|---|---------|---------|
| SUG-1 | app_worktree_api.go:293-295 | `PromoteWorktreeToBranch` で `ValidateBranchName` を `requireWorktreeInfo` の前に移動しているが、detachedでないセッションに対しても先にバリデーションが走る。ユーザーエクスペリエンス的に問題はないが、エラーメッセージ優先度の検討余地あり |
| SUG-2 | app_worktree_api.go:163-165 | `createSessionForDirectory` が router の nil チェックを行わない。内部ヘルパーとして上位で検証済みだが、防御的チェックがあるとより安全 |
| SUG-3 | app_worktree_api.go:349-354 | `CheckWorktreeStatus` で `branchName == "" && !isDetached` の fallback ロジック。このケース自体がメタデータ保存時のバグを示唆するため、発生条件の検討が望ましい |
| SUG-4 | app_session_api.go:63 | `CreateSession` で `sessionName` の空文字バリデーションが `findAvailableSessionName` の後。明示的な空文字チェックを `TrimSpace` 直後に追加する方が安全 |
| SUG-5 | app_worktree_api.go:106 | `CreateSessionWithWorktree` の成功パスで `emitSnapshot` が呼ばれない。他の箇所は成功パスでも呼んでおり、一貫性の検討が望ましい |
| SUG-6 | app_worktree_api.go:542-544 | `runSetupScripts` はテスト専用ラッパー。テスト側を `runSetupScriptsWithParentContext(nil, ...)` に直接変更して削除を検討 |
| SUG-7 | app_worktree_api.go:40 | UI から Detached HEAD mode 削除済み。`CreateWorktreeDetached` の公開スコープについてコメントで意図明示 |
| SUG-8 | app_session_api.go:188-198 | `cleanupOrphanedLocalWorktreeBranch` の nilガード — 呼び出し箇所では常に非nil repo を渡している。「Defensive guard」コメント追加で意図明確化 |

### Git Library

| # | ファイル | 指摘内容 |
|---|---------|---------|
| SUG-9 | internal/git/validation_test.go:12-38 | `IsValidBranchName` テストに `{"path traversal via slash", "a/../b", false}` ケース追加 |
| SUG-10 | internal/git/command.go:87-133 | `runGitCLI` リトライの全体タイムアウトを `context.Context` で制御すると呼び出し元がキャンセルしやすい |
| SUG-11 | internal/git/worktree.go:107 | `ListWorktreesWithInfo` bare ハンドリングが暗黙的。コメントで意図を明記するか `IsBare` フィールド検討 |
| SUG-12 | internal/git/git.go:228-237 | `CommitAll` で変更がない場合のエラーメッセージが不親切。事前チェックまたはパターンマッチング改善 |
| SUG-13 | internal/git/git.go:56-62 | `FindRepoRoot` の入力パスが未正規化。`Open()` と一貫性を持たせるべき |

### Install/Shim

| # | ファイル | 指摘内容 |
|---|---------|---------|
| SUG-14 | internal/install/shim_path_windows.go:42-45 | `ensurePathContains` のプロセスPATH事前チェックの意図をコメント化 |
| SUG-15 | internal/install/shim_source_windows.go:46 | `copyFile` 一時ファイルの残存クリーンアップ手段がない。起動時の `.shim-*.tmp` クリーンアップ検討 |
| SUG-16 | internal/install/shim_path_windows.go:118 | レジストリ value type 不正時に `pathRegistryTypeName` も含めると障害調査容易 |

### Terminal/ConPTY

| # | ファイル | 指摘内容 |
|---|---------|---------|
| SUG-17 | internal/terminal/conpty_windows.go:128-140 | ConPTY オプションの dimension 処理の簡素化 — `width`/`height` のみにデフォルト値設定で `hasCustomDimensions` フラグ不要 |
| SUG-18 | internal/terminal/conpty_windows.go:157-159 | `ptyIn/ptyOut` クローズ失敗を無視する理由のコメント追加 |
| SUG-19 | internal/terminal/conpty_windows.go:85-87 | `closeErr` に「closeOnce で保護」のフィールドコメント追加 |
| SUG-20 | internal/terminal/conpty_syscall_windows.go:57-65 | HRESULT エラーメッセージの書式を `0x%X` (大文字) に統一（Windows慣例） |
| SUG-21 | internal/terminal/conpty_windows.go:300-310 | `WAIT_TIMEOUT` のキャスト — 定数定義 `waitTimeout = uint32(windows.WAIT_TIMEOUT)` をファイルトップに置くと switch がクリア |

---

## テスト品質・不足テストケース

### カバレッジ分析

| ソースファイル | テストファイル | カバレッジ評価 | 不足点 |
|---|---|---|---|
| app_session_api.go | app_session_api_test.go | ★★★★☆ 良好 | KillSession clean worktree削除成功パス |
| app_worktree_api.go | app_worktree_api_test.go | ★★★★☆ 良好 | PromoteWorktree 非 detached ガード, CommitAndPush エラー, ExistingWorktree disabled/conflict |
| app_pane_api.go | app_pane_api_test.go | ★★★★★ 優秀 | ほぼ完全 |
| internal/git/command.go | command_test.go | ★★★☆☆ 普通 | runGitCLI リトライ/セマフォの直接テストなし |
| internal/git/git.go | git_test.go | ★★★★★ 優秀 | 非常に網羅的 |
| internal/git/worktree.go | worktree_test.go | ★★★★☆ 良好 | CreateWorktree の path/branch validation 個別テスト |
| internal/install/shim_installer_windows.go | shim_installer_windows_test.go | ★★★☆☆ 普通 | NeedsShimInstall, EnsureShimInstalled の直接テスト欠如 |
| internal/install/shim_path_windows.go | shim_installer_windows_test.go | ★★★★☆ 良好 | readRegistryPathRawValueWithRetry 非常に網羅的 |
| internal/terminal/conpty_syscall_windows.go | conpty_syscall_windows_test.go | ★★★☆☆ 普通 | Win32 API テスト困難 (許容) |
| internal/terminal/conpty_windows.go | conpty_close_windows_test.go | ★★★★★ 優秀 | Close/Read/Write/Resize/doClose 全カバー |

### 不足テストケース一覧

| # | ファイル | テストケース | 優先度 |
|---|---------|------------|--------|
| T-1 | app_worktree_api_test.go | `PromoteWorktreeToBranch` — 非 detached ワークツリー (`session is not a detached worktree` エラーパス) | Important |
| T-2 | app_worktree_api_test.go | `CommitAndPushWorktree` — commit 失敗 (nothing to commit) や push 失敗のエラーパス | Important |
| T-3 | app_session_api_test.go | `KillSession` — `deleteWorktree=true` で正常にworktreeが削除されるケース | Important |
| T-4 | app_worktree_api_test.go | `CreateSessionWithExistingWorktree` — worktreePath 重複チェック (conflict) | Important |
| T-5 | app_worktree_api_test.go | `CreateSessionWithExistingWorktree` — worktree feature disabled | Important |
| T-6 | app_worktree_api_test.go | `CreateSessionWithExistingWorktree` — 存在しないパスのテスト (os.IsNotExist パス) | Suggestion |
| T-7 | internal/git/validation_test.go | `IsValidBranchName("a/../b")` — filepath.Clean ..' 吸収バグ検出 | Important |
| T-8 | internal/install/shim_installer_windows_test.go | `NeedsShimInstall` — ファイル存在/不在、PATH チェック分岐 | Important |
| T-9 | conpty_close_windows_test.go | `doClose` — `TerminateProcess` 失敗時に `firstErr` が正しく設定されるか | Suggestion |
| T-10 | app_worktree_api_test.go | `PromoteWorktreeToBranch` — `SetWorktreeInfo` 失敗 → rollback パス | Suggestion |
| T-11 | app_worktree_api_test.go | `CommitAndPushWorktree` — `push=false, commitMessage != ""` のコミットのみケース | Suggestion |
| T-12 | internal/git/command_test.go | セマフォタイムアウト — `acquireGitSemaphore` タイムアウト時のエラー返却 | Suggestion |

---

## コード重複分析

| パターン | 箇所 | 重複度 | 備考 |
|---------|------|--------|------|
| tmux `new-session` 実行 | CreateSession (session_api:57-73), createSessionForDirectory (worktree_api:198-221) | **高** | CreateSession が createSessionForDirectory を使えば解消 |
| `RemoveWorktree` → `RemoveWorktreeForced` フォールバック | cleanupSessionWorktree (session_api:160-172), CleanupWorktree (worktree_api:495-504) | 中 | ForceCleanup 設定分岐が異なるため完全統合困難。ヘルパー extractable |
| `repo.PruneWorktrees()` 呼び出し | cleanupSessionWorktree, CleanupWorktree, rollbackWorktree, ListWorktreesByRepo | 低 | パターン一貫、変更不要 |
| `ValidateWorktreePath` 二重呼び出し | worktree.go メソッド内 + createWorktreeForSession | 低 | 防御的。現状維持で問題なし |

---

## Strengths (優れた点)

### 設計・アーキテクチャ
- **堅牢なロールバック戦略**: `CreateSession`, `CreateSessionWithWorktree`, `CreateSessionWithExistingWorktree` で defer によるロールバック処理が包括的に実装
- **コマンドインジェクション防御の徹底**: `exec.Command("git", args...)` でスライス引数使用、シェル展開を完全に回避
- **セマフォによる git 並行制御**: `maxConcurrentGitCommands=4` でプロセス全体の git 並行実行を制限し、index.lock 競合を軽減
- **`sync.Once` による Close の冪等性**: ConPTY の Close が複数回呼び出しでも安全

### エラーハンドリング
- **アトミックなファイルコピー**: 一時ファイル + `os.Rename` パターンで部分書き込み防止
- **レジストリリトライロジック**: `ERROR_MORE_DATA` や value size 変動に対して最大3回リトライ
- **エラー正規化の3層設計**: Read/Write/ConPtyPipe のエラーコードを `io.EOF` / `io.ErrClosedPipe` に正規化

### テスト
- **テーブル駆動テスト活用**: 全パッケージで一貫したパターン
- **struct field count guard**: フィールド数変更時のテスト更新漏れ検出
- **テスト可能な設計**: 関数変数パターン (`executeRouterRequestFn`, `currentBranchFn` 等) でモック差し替え可能
- **パストラバーサル防御テスト**: `copyConfigFilesToWorktree` で攻撃パターンを検証
- **ConPTY の30パターン以上の `shouldUseConPty` テスト**

### Windows 固有対応
- **ケースインセンシティブパス比較**: `pathsEqualFold` で正しく処理
- **レジストリ value type 保全**: 既存 `SZ`/`EXPAND_SZ` を変更せず保持
- **環境ブロックの GC 安全対策**: `runtime.KeepAlive` の正しい使用

---

## Recommended Action

1. **IMP-1, IMP-2 を修正** — `CreateSessionWithExistingWorktree` の入力バリデーション追加（影響範囲小、工数小）
2. **IMP-3 を修正** — `IsValidBranchName` のパストラバーサルバグ修正 + テストケース追加（T-7）
3. **IMP-4 を検討** — セッション作成ロジック重複の統合（リファクタリング、工数中）
4. **IMP-5〜8 を検討** — 命名改善、コメント追加（工数小）
5. **T-1〜T-5 のテスト追加** — Important 不足テストの対応
6. **SUG 系は次回スプリントで検討**
7. **修正後に再レビュー実施**

---

## タスク並列作業可否表

以下は、修正タスクを並列で作業できるかどうかの一覧です。**同一ファイルの修正は競合リスクがあるため順次作業**を推奨し、**異なるパッケージ間は並列作業可能**です。

### 修正タスク一覧と並列作業可否

| タスクID | 内容 | 対象ファイル | 推定工数 | 依存関係 |
|---------|------|------------|---------|---------|
| FIX-1 | `CreateSessionWithExistingWorktree` repoPath 空文字チェック追加 | app_worktree_api.go | 小 | なし |
| FIX-2 | `CreateSessionWithExistingWorktree` worktreePath 空文字チェック追加 | app_worktree_api.go | 小 | FIX-1 と同一ファイル |
| FIX-3 | `IsValidBranchName` パストラバーサルバグ修正 | internal/git/validation.go | 小 | なし |
| FIX-4 | `IsValidBranchName` テストケース追加 (a/../b) | internal/git/validation_test.go | 小 | FIX-3 |
| FIX-5 | `CreateSession` ⇔ `createSessionForDirectory` 統合検討 | app_session_api.go, app_worktree_api.go | 中 | FIX-1,2 完了後 |
| FIX-6 | `normalizeWorktreeBranchName` リネーム | app_worktree_api.go + テスト | 小 | FIX-1,2 完了後 |
| FIX-7 | `EnsureProcessPathContains` コメント追加 | internal/install/shim_installer_windows.go | 小 | なし |
| FIX-8 | `handleIO.Read/Write` 設計意図コメント追加 | internal/terminal/conpty_windows.go | 小 | なし |
| FIX-9 | `doClose` TerminateProcess 後の Wait 追加検討 | internal/terminal/conpty_windows.go | 小 | FIX-8 と同一ファイル |
| TEST-1 | `PromoteWorktreeToBranch` 非 detached テスト追加 | app_worktree_api_test.go | 小 | なし |
| TEST-2 | `CommitAndPushWorktree` エラーパステスト追加 | app_worktree_api_test.go | 小 | TEST-1 と同一ファイル |
| TEST-3 | `KillSession` clean worktree 削除テスト追加 | app_session_api_test.go | 中 | なし |
| TEST-4 | `CreateSessionWithExistingWorktree` conflict/disabled テスト | app_worktree_api_test.go | 小 | TEST-1,2 と同一ファイル |
| TEST-5 | `NeedsShimInstall` テスト追加 | shim_installer_windows_test.go | 中 | なし |
| TEST-6 | `doClose` TerminateProcess 失敗テスト追加 | conpty_close_windows_test.go | 小 | なし |

### 並列作業グループ

```
┌─────────────────────────────────────────────────────────────────────┐
│ 並列作業が可能なグループ分け                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │
│  │ グループA       │  │ グループB     │  │ グループC                 │ │
│  │ App Layer      │  │ Git Library  │  │ Install + Terminal       │ │
│  │                │  │              │  │                          │ │
│  │ FIX-1,2 (順次) │  │ FIX-3 → FIX-4│  │ FIX-7 (install)         │ │
│  │     ↓          │  │  (順次)      │  │ FIX-8,9 (terminal,順次)  │ │
│  │ FIX-5,6 (順次) │  │              │  │ TEST-5 (install)         │ │
│  │ TEST-1→2→4     │  │              │  │ TEST-6 (terminal)        │ │
│  │  (順次)        │  │              │  │  ※install と terminal は │ │
│  │ TEST-3 (別ファイル│  │              │  │   並列作業可能           │ │
│  │  →グループA内   │  │              │  │                          │ │
│  │  並列OK)       │  │              │  │                          │ │
│  └───────────────┘  └──────────────┘  └──────────────────────────┘ │
│                                                                     │
│  ★ グループ A / B / C は互いに並列作業可能                            │
│  ★ グループ内は記載順に順次作業を推奨                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 作業者向け クイックリファレンス

| 作業者 | 担当グループ | 並列OK | 注意点 |
|-------|------------|--------|-------|
| 作業者1 | グループA (App Layer) | グループB,Cと並列OK | FIX-1,2 → FIX-5,6 → TEST-1→2→4 の順。TEST-3 は別ファイルなので FIX-1,2 と並列可 |
| 作業者2 | グループB (Git Library) | グループA,Cと並列OK | FIX-3 → FIX-4 の順 (validation.go → validation_test.go) |
| 作業者3 | グループC (Install+Terminal) | グループA,Bと並列OK | FIX-7,TEST-5 (install) と FIX-8,9,TEST-6 (terminal) は並列可 |

### 並列作業 可否マトリクス

| タスク | FIX-1,2 | FIX-3,4 | FIX-5,6 | FIX-7 | FIX-8,9 | TEST-1~4 | TEST-3 | TEST-5 | TEST-6 |
|-------|---------|---------|---------|-------|---------|----------|--------|--------|--------|
| **FIX-1,2** | — | ✅可 | ❌同一ファイル | ✅可 | ✅可 | ❌関連 | ✅可 | ✅可 | ✅可 |
| **FIX-3,4** | ✅可 | — | ✅可 | ✅可 | ✅可 | ✅可 | ✅可 | ✅可 | ✅可 |
| **FIX-5,6** | ❌先行必要 | ✅可 | — | ✅可 | ✅可 | ❌関連 | ❌関連 | ✅可 | ✅可 |
| **FIX-7** | ✅可 | ✅可 | ✅可 | — | ✅可 | ✅可 | ✅可 | ❌同一pkg | ✅可 |
| **FIX-8,9** | ✅可 | ✅可 | ✅可 | ✅可 | — | ✅可 | ✅可 | ✅可 | ❌同一pkg |
| **TEST-1~4** | ❌先行必要 | ✅可 | ❌先行必要 | ✅可 | ✅可 | — | ❌同一pkg | ✅可 | ✅可 |
| **TEST-3** | ✅可 | ✅可 | ❌関連 | ✅可 | ✅可 | ❌同一pkg | — | ✅可 | ✅可 |
| **TEST-5** | ✅可 | ✅可 | ✅可 | ❌同一pkg | ✅可 | ✅可 | ✅可 | — | ✅可 |
| **TEST-6** | ✅可 | ✅可 | ✅可 | ✅可 | ❌同一pkg | ✅可 | ✅可 | ✅可 | — |

**凡例**: ✅可 = 並列作業可能 / ❌ = 順次作業推奨（理由を記載）
