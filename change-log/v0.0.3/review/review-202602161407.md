# PR Review — myT-x 変更ファイル一括レビュー

**日付**: 2025-02-16 14:07  
**対象**: `myT-x/` 配下の変更ファイル 20件（3,626行追加 / 245行削除）  
**レビュー方式**: カテゴリ別並列レビュー（4カテゴリ）

---

## 変更ファイル一覧

| カテゴリ | ファイル | 変更概要 |
|---------|---------|---------|
| A: Terminal/ConPTY | `internal/terminal/conpty_windows.go` | Close処理リファクタ、エラー正規化、ハンドルIO改善 |
| A: Terminal/ConPTY | `internal/terminal/conpty_close_windows_test.go` | 新規: Close/Read/Write/Resize後テスト |
| A: Terminal/ConPTY | `internal/terminal/conpty_syscall_windows.go` | runtime.KeepAliveコメント追加 |
| A: Terminal/ConPTY | `internal/terminal/conpty_syscall_windows_test.go` | utf16UnitSize定数化 |
| B: Git core | `internal/git/command.go` | セマフォ並行制御、index.lockリトライ |
| B: Git core | `internal/git/command_test.go` | isLockFileConflict、upsertEnvVarテスト |
| B: Git core | `internal/git/git.go` | ブランチ操作、orphanクリーンアップ |
| B: Git core | `internal/git/git_test.go` | 新規: 統合テスト（bare+clone） |
| B: Git core | `internal/git/validation.go` | ブランチ名・パス検証 |
| B: Git core | `internal/git/validation_test.go` | パストラバーサルテスト追加 |
| B: Git core | `internal/git/worktree.go` | Worktree CRUD操作 |
| B: Git core | `internal/git/worktree_test.go` | 新規: worktree操作テスト |
| C: App API | `app_session_api.go` | セッションCRUD、worktreeクリーンアップ |
| C: App API | `app_session_api_test.go` | セッションAPI包括テスト |
| C: App API | `app_worktree_api.go` | Worktreeセッション統合 |
| C: App API | `app_worktree_api_test.go` | 新規: worktreeAPI包括テスト |
| C: App API | `app_pane_api_test.go` | ペインAPI追加テスト |
| D: Install/Shim | `internal/install/shim_installer_windows.go` | SHA256ベース変更検出 |
| D: Install/Shim | `internal/install/shim_installer_windows_test.go` | 新規: installer包括テスト |
| D: Install/Shim | `internal/install/shim_path_windows.go` | レジストリPATH操作 |

---

## レビュー結果サマリー

| 重要度 | 件数 |
|--------|------|
| Critical | 2 |
| Important | 13 |
| Suggestion | 17 |

---

## Critical（重大：バグ・データ損失・クラッシュリスク）

### C-1: `CreateSession` — `createSessionForDirectory` 内で空Stdout時にtmuxセッションが孤立する

**ファイル**: `app_session_api.go` (CreateSession)

`createSessionForDirectory` は `executeRouterRequestFn` を呼び、ExitCode==0かつStdout空の場合にエラーを返す。しかし、tmux側ではセッションが既に作成されている可能性がある。`sessionMayExist = true` のセットは `createSessionForDirectory` の **後** なので、defer内のロールバックが実行されない。

```go
createdName, err = a.createSessionForDirectory(router, rootPath, sessionName, enableAgentTeam)
if err != nil {
    return tmux.SessionSnapshot{}, err  // ← sessionMayExist=false のためロールバックなし
}
sessionMayExist = true  // ← ここでセット
```

**修正案**: `createSessionForDirectory` 内で空Stdout時にセッション名を `-s` フラグから取り出して kill-session を試みるか、`sessionMayExist` を事前に `true` にする。

---

### C-2: `CreateSessionWithWorktree` — worktreeロールバック失敗時にUIへ通知されない

**ファイル**: `app_worktree_api.go` (CreateSessionWithWorktree defer)

セッションロールバック成功後にworktreeロールバックが失敗した場合、孤立worktreeディレクトリ＋孤立ブランチが残る。`retErr` にテキストは含まれるが、フロントエンドには `worktree:cleanup-failed` イベントが発行されない。

**修正案**: worktreeロールバック失敗時にも `emitWorktreeCleanupFailure` を呼び、UIで孤立リソースをユーザーに通知する。

---

## Important（重要：保守性・正確性・堅牢性）

### I-1: [Terminal/ConPTY] `handleIO` の Read/Write TOCTOU

**ファイル**: `internal/terminal/conpty_windows.go` (handleIO)

ハンドルをロック内でコピーし、ロック外でI/Oを実行する設計。理論的にはハンドル再利用リスクがあるが、デッドロック回避のための意図的な設計であり、実運用上のリスクは極小。

**対応**: ドキュメントに設計意図を記載（既にコメントあり）。

---

### I-2: [Terminal/ConPTY] `createEnvBlock` GCリスク

**ファイル**: `internal/terminal/conpty_syscall_windows.go` (createEnvBlock)

呼び出し側で `runtime.KeepAlive` が必要な設計。現在は正しく使用されているが、将来の呼び出し元で漏れる可能性。

**対応**: 関数コメントに `// Caller MUST call runtime.KeepAlive(envBlock)` 警告を付記。

---

### I-3: [Terminal/ConPTY] `_COORD.Pack()` のint16符号拡張

**ファイル**: `internal/terminal/conpty_windows.go` (Pack)

`validateConPtyDimensions` により安全だが、`Pack()` 自体が自己完結していない。

**対応**: `Pack()` 内にバリデーションを追加するか、docstringに前提条件を明記。

---

### I-4: [Git] `Open` が相対パスを絶対パスに解決しない

**ファイル**: `internal/git/git.go` (Open)

`filepath.Clean` は相対パスを絶対パスに変換しない。`Open(".")` で `r.path` が `"."` のまま格納されると、カレントディレクトリ変更時に予期しない動作を引き起こす。

**修正案**: `filepath.Abs` を追加:
```go
path = filepath.Clean(path)
absPath, err := filepath.Abs(path)
if err != nil {
    return nil, fmt.Errorf("failed to resolve absolute path: %w", err)
}
path = absPath
```

---

### I-5: [Git] `runGitCLI` に `context.Context` サポートがない

**ファイル**: `internal/git/command.go` (runGitCLI)

gitコマンドをキャンセルする手段がなく、アプリケーション終了時にハングする可能性。セマフォタイムアウト（30秒）が部分的に緩和しているが、実行中のgitプロセス自体は止まらない。

**修正案**: 将来的に `exec.CommandContext` を使用。

---

### I-6: [Git] `ValidateWorktreePath` の `".."` チェックが過剰に厳格

**ファイル**: `internal/git/validation.go` (ValidateWorktreePath)

`strings.Contains(path, "..")` は `my..project` のような正当なディレクトリ名も拒否する。

**修正案**: `filepath.Clean` 後にセパレータ付き `..` のみチェック。

---

### I-7: [Git] `CommitAll` で `git add` 成功後に `git commit` が失敗した場合のステージング残存

**ファイル**: `internal/git/git.go` (CommitAll)

`git add -A` 成功後に `git commit -m` が失敗するとステージングが残る。デスクトップアプリとしては許容範囲だが文書化推奨。

---

### I-8: [App] `KillSession` で `deleteWorktree=true` かつメタデータ取得失敗時にエラーを返すがセッションは既に削除済み

**ファイル**: `app_session_api.go` (KillSession)

セッションの kill-session は成功しているにもかかわらずエラーを返す。呼び出し元がリトライすると不整合になる可能性。

**修正案**: `emitWorktreeCleanupFailure` イベントだけで通知し、エラーではなくwarning扱いにすることを検討。

---

### I-9: [App] `PromoteWorktreeToBranch` ロールバックで `CheckoutDetachedHead` 失敗時に `DeleteLocalBranch` が実行されない

**ファイル**: `app_worktree_api.go` (rollbackPromotedWorktreeBranch)

`CheckoutDetachedHead` 失敗で早期リターンし、ブランチが残る。

**修正案**: `DeleteLocalBranch` も試み、両方のエラーを結合して返す。

---

### I-10: [App] `copyConfigFilesToWorktree` のパストラバーサル防止でシンボリックリンクが未考慮

**ファイル**: `app_worktree_api.go` (copyConfigFilesToWorktree)

`filepath.Join` + `filepath.Clean` のみの検証。`repoPath` 内にシンボリックリンクがあると、ベースディレクトリ外のファイルを読む可能性。

**修正案**: `filepath.EvalSymlinks` で実パスに解決後に比較。

---

### I-11: [Shim] `ensurePathContains` — プロセスPATHチェックによるレジストリ更新スキップ

**ファイル**: `internal/install/shim_path_windows.go` (ensurePathContains)

レジストリを読む前に `os.Getenv("PATH")` をチェックし、`installDir` が含まれていれば早期リターン。`EnsureProcessPathContains` が先に呼ばれていた場合、レジストリが一度も更新されず、新ターミナルでshimが見つからない可能性。

**修正案**: プロセスPATHチェックを削除し、常にレジストリを確認する。

---

### I-12: [Shim] 埋め込みshimの非アトミック書き込み

**ファイル**: `internal/install/shim_installer_windows.go` (EnsureShimInstalled)

非埋め込みパスでは `copyFile` がアトミック書き込み（一時ファイル＋リネーム）を行うが、埋め込みパスでは `os.WriteFile` を直接使用。ディスクフル等で中途半端に失敗した場合、破損 `tmux.exe` が残る。

**修正案**: 埋め込みパスでもアトミック書き込みパターンを使用。

---

### I-13: [Git] `listRemoteBranchNames` のリモート名にスラッシュが含まれるケースの制限

**ファイル**: `internal/git/git.go` (listRemoteBranchNames)

`SplitN(refName, "/", 2)` ではリモート名に `/` が含まれる場合に不正確。極めて稀なケースなので優先度低。

---

## Suggestion（提案：コード品質・可読性・パフォーマンス）

### S-1: [Terminal/ConPTY] `startConPty` の次元計算ロジック冗長

coord + width/height の二重管理。

### S-2: [Terminal/ConPTY] Read/Writeパスのエラー正規化の非対称性

Readは `normalizeReadFileError`、Writeは `normalizeWriteFileError` ＋ `normalizeConPtyPipeError` の二段階。

### S-3: [Terminal/ConPTY] テスト不足 — `doClose` で `WaitForSingleObject` エラー返却ケース

### S-4: [Terminal/ConPTY] テスト不足 — `startConPty` でConPTY利用不可やパイプ作成失敗ケース

### S-5: [Terminal/ConPTY] コンパイル時インターフェース準拠チェック欠如

`var _ ptyReadWriteCloser = (*ConPty)(nil)` の追加を推奨。

### S-6: [Git] `os.Environ()` の毎回コピー

`runGitCLI` の各呼び出しで環境変数の全コピーが発生。`sync.Once` でキャッシュ可能。

### S-7: [Git] 行分割パターンの重複

`ListBranches`, `listLocalBranchTrackingInfo`, `listRemoteBranchNames` で同じ分割・トリム・空行スキップパターン。ヘルパー関数への抽出を推奨。

### S-8: [Git] `runGitCommand` / `runGitCommandRaw` の命名

出力トリム方式の違い（`TrimSpace` vs `TrimRight("\n\r")`）が名前から推測しにくい。

### S-9: [Git] `FindAvailableWorktreePath` のループ上限100がマジックナンバー

定数化推奨: `const maxWorktreePathCandidates = 100`

### S-10: [Git] テストカバレッジ不足箇所

| 対象 | 不足テスト |
|------|-----------|
| `command.go` | セマフォタイムアウト |
| `validation.go` | `FindAvailableWorktreePath` ループ上限到達 |
| `worktree.go` | `RemoveWorktree`/`RemoveWorktreeForced` 不正パス |
| `worktree.go` | `ListWorktrees` 単体テスト |
| `git.go` | `Open("")` の明示的エラーテスト |

### S-11: [App] エラーラッピングの不一致

`errors.New(resp.Stderr)` / `fmt.Errorf("...: %s", resp.Stderr)` / `fmt.Errorf("...: %w", err)` が混在。統一推奨。

### S-12: [App] テスト不足 — `app_pane_api_test.go`

| 不足テスト |
|-----------|
| `ApplyLayoutPreset` 成功パス |
| 3ペイン以上での中間ペイン削除後のレイアウト再計算 |
| `ResizePane` 成功パス |
| `SplitPane` 後の `paneStates` 同期 |

### S-13: [App] テスト不足 — `app_worktree_api_test.go`

| 不足テスト |
|-----------|
| `CreateSessionWithWorktree` のセットアップスクリプト非同期実行結合テスト |
| `copyConfigFilesToWorktree` 失敗時の `worktree:copy-files-failed` イベント発行検証 |
| `CleanupWorktree` の強制削除パス（`RemoveWorktree` 失敗→`RemoveWorktreeForced` 成功） |

### S-14: [Shim] `NeedsShimInstall` のテストが存在しない

公開関数で3段階のロジックを持つが、テストケースがない。

### S-15: [Shim] `decodeRegistryUTF16String` サロゲートペアテスト不足

CJKテストはBMP内のみ。サロゲートペア（絵文字）のテストがない。

### S-16: [Shim] `containsPathEntry` 末尾バックスラッシュ付きエントリのテスト不足

`filepath.Clean` で末尾セパレータ除去される動作の明示的テストがない。

### S-17: [Shim] `matchesHashFile` の非対称TrimSpace

格納側ハッシュにのみ `strings.TrimSpace` を適用。将来のバグ予防に双方へ適用推奨。

---

## 優秀な設計ポイント

1. **セマフォ並行制御** — gitコマンドの最大同時実行数制限（4）とタイムアウト
2. **index.lockリトライ** — エクスポネンシャルバックオフ（100ms base, 1600ms cap, max 10回）
3. **ロケール中立環境変数** — `LC_ALL=C` で git 出力の安定化
4. **SHA256ベース変更検出** — shim更新の最小化
5. **レジストリ読み書きの単一ハンドル** — read-then-write レースの回避
6. **ERROR_MORE_DATAリトライ** — 並行PATH変更への堅牢な対応
7. **アトミックファイルコピー** — 一時ファイル＋リネームパターン（copyFile）
8. **ロールバック＋defer** — セッション＋worktreeの一貫したクリーンアップ
9. **パストラバーサル防止** — Clean + HasPrefix によるセキュリティ検証
10. **フィールド数ガードテスト** — struct変更時の検知メカニズム

---

## 並列修正可否テーブル

以下のタスクについて、並列で修正作業を行う場合の依存関係を示す。

| ID | 修正タスク | 対象ファイル | 並列作業 | 依存/競合 |
|----|-----------|-------------|---------|-----------|
| C-1 | createSessionForDirectory 空Stdoutロールバック | `app_session_api.go`, `app_worktree_api.go` | ⚠️ 注意 | C-2と同じrollbackロジックを共有 |
| C-2 | worktreeロールバック失敗時のUI通知 | `app_worktree_api.go` | ⚠️ 注意 | C-1と同じdeferブロック |
| I-1 | handleIO TOCTOUドキュメント | `conpty_windows.go` | ✅ 可能 | 独立 |
| I-2 | createEnvBlock KeepAliveコメント | `conpty_syscall_windows.go` | ✅ 可能 | 独立 |
| I-3 | Pack()前提条件ドキュメント | `conpty_windows.go` | ✅ 可能 | I-1と同ファイルだが競合なし |
| I-4 | Open絶対パス解決 | `git.go` | ✅ 可能 | 独立 |
| I-5 | context.Context対応 | `command.go`, `git.go` 他 | ❌ 不可 | I-4と同パッケージ、広範囲変更 |
| I-6 | ValidateWorktreePathの..チェック修正 | `validation.go` | ✅ 可能 | 独立 |
| I-7 | CommitAllドキュメント | `git.go` | ✅ 可能 | I-4、I-5と同ファイルだが競合なし |
| I-8 | KillSessionエラーハンドリング改善 | `app_session_api.go` | ⚠️ 注意 | C-1と同ファイル |
| I-9 | rollback両方試行 | `app_worktree_api.go` | ⚠️ 注意 | C-1, C-2と同ファイル |
| I-10 | EvalSymlinks追加 | `app_worktree_api.go` | ⚠️ 注意 | I-9と同ファイル |
| I-11 | ensurePathContainsレジストリ直接確認 | `shim_path_windows.go` | ✅ 可能 | 独立 |
| I-12 | 埋め込みshimアトミック書き込み | `shim_installer_windows.go` | ✅ 可能 | 独立 |
| I-13 | listRemoteBranchNames改善 | `git.go` | ✅ 可能 | I-4と同ファイルだが別関数 |

### 推奨並列グループ

| グループ | タスク | 理由 |
|---------|--------|------|
| Group A | C-1 + C-2 + I-8 + I-9 | 同一ファイル（app_session_api.go, app_worktree_api.go）のロールバック関連 → 順次作業推奨 |
| Group B | I-1 + I-2 + I-3 | Terminal/ConPTY — 独立、並列可能 |
| Group C | I-4 + I-6 + I-7 + I-13 | Git core — 同パッケージだが別関数、並列可能（I-5除く） |
| Group D | I-11 + I-12 | Install/Shim — 独立、並列可能 |
| Group E | I-10 | app_worktree_api.go — Group A完了後に作業 |

**並列実行パターン**: Group B + Group C + Group D を同時着手 → Group A を順次 → Group E

---

*レビュー完了*
