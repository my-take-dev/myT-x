# PR Review Summary — 2026/02/16 15:36

**対象**: myT-x 配下の未コミット変更（22ファイル, +4,158 / -543 行）

**レビュー方式**: 5つの専門エージェントによる並列レビュー
- code-reviewer（コード品質・バグ・設計）
- pr-test-analyzer（テスト品質・カバレッジ）
- silent-failure-hunter（サイレントエラー検出）
- comment-analyzer（コメント正確性）
- code-simplifier（簡素化・デッドコード）

---

## Critical Issues (0件)

なし

---

## Important Issues (11件)

### I-01: `CreateSession` の defer 内で成功時にも `emitSnapshot` が呼ばれる（snapshot二重発火）
- **エージェント**: code-reviewer
- **ファイル**: [app_session_api.go](../myT-x/app_session_api.go#L38-L49)
- **内容**: `CreateSessionWithWorktree` は成功時に `if retErr == nil { return }` で defer を早期リターンしているが、`CreateSession` は `sessionMayExist == true` であれば成功時にも `emitSnapshot()` を実行する。`activateCreatedSession` が snapshot を返却した後にさらに `emitSnapshot()` が発火するため、フロントエンド側で二重更新が生じる可能性がある
- **修正案**: defer 内に `if retErr == nil { return }` を追加し、`CreateSessionWithWorktree` と統一する

### I-02: `copyConfigFilesToWorktree` でベースパス解決失敗時にフロントエンドに通知されない
- **エージェント**: silent-failure-hunter
- **ファイル**: [app_worktree_api.go](../myT-x/app_worktree_api.go#L261-L273)
- **内容**: `resolveSymlinkEvaluatedBasePath` が失敗すると `slog.Warn` は出力されるが、空の `failures` スライスを返す。呼び出し元は `len(copyFailures) > 0` でのみイベントを発行するため、フロントエンドには通知されない
- **修正案**: 失敗時は `files` 全体を `failures` に追加してから返す。`wtBase` 解決失敗も同様

### I-03: `emitWorktreeCleanupFailure` で `runtimeContext()` が nil の場合イベントが消失
- **エージェント**: silent-failure-hunter
- **ファイル**: [app_session_api.go](../myT-x/app_session_api.go#L212-L224)
- **内容**: シャットダウン中やアプリ起動直後のレース条件で `runtimeContext()` が nil を返す場合、ログのみで UI へのイベントは一切発行されない。`KillSession` → `cleanupSessionWorktree` 経路では呼び出し元が nil を返す（セッション削除は成功扱い）ため、フロントエンドだけが唯一の通知経路
- **修正案**: `context.Background()` にフォールバック

### I-04: `installShimIfChanged` のハッシュファイル書き込み失敗が Debug レベル
- **エージェント**: silent-failure-hunter
- **ファイル**: [shim_installer_windows.go](../myT-x/internal/install/shim_installer_windows.go#L132-L135)
- **内容**: ハッシュファイル書き込み失敗は Debug レベルで記録される。ハッシュファイルが無いため毎回アプリ起動時に shim バイナリが再コピーされ、ディスク I/O 障害が永続的に発生していても気づけない
- **修正案**: `slog.Warn` に変更

### I-05: `slog.Warn` に `[DEBUG-*]` プレフィックスが混在
- **エージェント**: comment-analyzer
- **ファイル**: app_session_api.go（15箇所以上）, app_worktree_api.go（複数箇所）
- **内容**: CLAUDE.md の規約「デバッグ用としてログ名を統一して削除しやすくしておく事」に従い `[DEBUG-*]` プレフィックスは一括削除用。しかし `slog.Warn()` レベルのログにも `[DEBUG-*]` を使用している。デバッグログ一括削除時に本来残すべき警告まで消失する
- **修正案**: 方針を統一する（A: `slog.Warn` は `[WARN-*]` に統一 / B: 全て `[DEBUG-*]` + `slog.Debug()` に変更）

### I-06: `executeGitCommandAt` / `executeGitCommandAtWithContext` の不要なインダイレクション
- **エージェント**: code-simplifier
- **ファイル**: [command.go](../myT-x/internal/git/command.go#L208-L215)
- **内容**: `runGitCLI` / `runGitCLIWithContext` の完全なエイリアスで、意味的な差異がない。呼び出し元を追うときの認知負荷増
- **修正案**: 呼び出し元で `runGitCLI` を直接使用し、エイリアスを削除

### I-07: `acquireGitSemaphore()` がデッドコード
- **エージェント**: code-simplifier
- **ファイル**: [command.go](../myT-x/internal/git/command.go#L37-L38)
- **内容**: プロダクション・テストともに呼び出し元なし。全コードパスは `acquireGitSemaphoreWithContext` 経由
- **修正案**: 削除

### I-08: `GenerateBranchName()` がプロダクション未使用
- **エージェント**: code-simplifier
- **ファイル**: [validation.go](../myT-x/internal/git/validation.go#L68-L72)
- **内容**: テストファイルからのみ呼ばれ、プロダクションでは `chooseWorktreeIdentifier` が使用されている
- **修正案**: 不要であれば削除

### I-09: テスト欠如 — `doClose` で `WaitForSingleObject` がエラーを返すケース
- **エージェント**: pr-test-analyzer
- **ファイル**: [conpty_close_windows_test.go](../myT-x/internal/terminal/conpty_close_windows_test.go)
- **内容**: `WaitForSingleObject` が `(0, errors.New("wait failed"))` を返すケースのテストが無い
- **修正案**: テストケース追加

### I-10: テスト欠如 — ロックファイル競合時のリトライ動作テスト
- **エージェント**: pr-test-analyzer
- **ファイル**: [command_test.go](../myT-x/internal/git/command_test.go)
- **内容**: `isLockFileConflict` は検出テストがあるが、`runGitCLI` のリトライ動作自体（lock error → backoff → 再実行 → 成功）のテストが欠如
- **修正案**: モックベースでリトライ動作を検証するテスト追加

### I-11: テストの `time.After` 依存でフレーキーリスク
- **エージェント**: pr-test-analyzer
- **ファイル**: [app_session_api_test.go](../myT-x/app_session_api_test.go)
- **関数**: `TestKillSessionStopsOutputBuffersOutsideOutputLock`
- **内容**: `time.After(2*time.Second)` / `time.After(500*time.Millisecond)` でタイムアウト検出。CI 環境では不安定になるリスク
- **修正案**: チャネルベースの同期に移行、またはタイムアウト値を定数化

---

## Suggestions (17件)

### S-01: `KillSession` で `deleteWorktree=false` 時に不要な `GetWorktreeInfo` 呼び出し
- **エージェント**: code-reviewer
- **ファイル**: [app_session_api.go](../myT-x/app_session_api.go#L108)
- **修正案**: `deleteWorktree=true` の場合のみ呼び出す

### S-02: `runSetupScripts` ラッパーがデッドコード
- **エージェント**: code-simplifier / code-reviewer
- **ファイル**: [app_worktree_api.go](../myT-x/app_worktree_api.go#L319)
- **修正案**: テストを `runSetupScriptsWithParentContext(nil, ...)` に書き換え、ラッパーを削除

### S-03: `CreateWorktree` の `baseBranch` バリデーションが `ValidateBranchName` を通り "HEAD" が commit-ish として通過
- **エージェント**: code-reviewer
- **ファイル**: [worktree.go](../myT-x/internal/git/worktree.go#L11-L19)
- **修正案**: commit-ish 用の緩やかなバリデーションに分離するか、コメントで意図を明記

### S-04: `RemoveWorktree` / `RemoveWorktreeForced` の重複ロジック
- **エージェント**: code-simplifier
- **ファイル**: [worktree.go](../myT-x/internal/git/worktree.go#L60-L79)
- **修正案**: 内部ヘルパーに統合し、`force` パラメータで制御

### S-05: プロダクション未使用関数群（`CreateWorktreeDetached`, `CreateWorktreeFromBranch`, `ListWorktrees`）
- **エージェント**: code-simplifier
- **ファイル**: [worktree.go](../myT-x/internal/git/worktree.go)
- **修正案**: 不要なら削除、ロードマップにあるなら維持

### S-06: テストスタブ変数にグループコメントが無い
- **エージェント**: comment-analyzer
- **ファイル**: [app_worktree_api.go](../myT-x/app_worktree_api.go#L18-L33)
- **修正案**: `// Test seams: function variables ...` のグループコメントを追加

### S-07: `handleIO` 構造体のgodocにスレッドセーフティの記述なし
- **エージェント**: comment-analyzer
- **ファイル**: [conpty_windows.go](../myT-x/internal/terminal/conpty_windows.go#L20)
- **修正案**: 並行利用パターンの説明を追加

### S-08: `decodeRegistryUTF16String` の奇数バイト長切り捨てが Debug レベル
- **エージェント**: silent-failure-hunter
- **ファイル**: [shim_path_windows.go](../myT-x/internal/install/shim_path_windows.go#L185)
- **修正案**: `slog.Warn` に引き上げ

### S-09: `sha256HexFile` 失敗が Debug レベル
- **エージェント**: silent-failure-hunter
- **ファイル**: [shim_installer_windows.go](../myT-x/internal/install/shim_installer_windows.go#L51)
- **修正案**: `slog.Warn` に変更

### S-10: `closePseudoConsole` の `lastErr` 未使用
- **エージェント**: silent-failure-hunter
- **ファイル**: [conpty_syscall_windows.go](../myT-x/internal/terminal/conpty_syscall_windows.go#L64)
- **修正案**: デバッグログ追加（任意）

### S-11: `doClose()` で `WaitForSingleObject` 失敗が `firstErr` に含まれない
- **エージェント**: silent-failure-hunter
- **ファイル**: [conpty_windows.go](../myT-x/internal/terminal/conpty_windows.go#L280)
- **修正案**: 他エラーがない場合 `firstErr` にセット

### S-12: `TestCreateRenameKillSessionValidation` の9ケースが冗長
- **エージェント**: pr-test-analyzer
- **ファイル**: [app_session_api_test.go](../myT-x/app_session_api_test.go)
- **修正案**: テーブル駆動に統合

### S-13: `TestPaneMutationAPIsRequireSessionManager` が直列テスト
- **エージェント**: pr-test-analyzer
- **ファイル**: [app_pane_api_test.go](../myT-x/app_pane_api_test.go)
- **修正案**: テーブル駆動テストに変換

### S-14: `TestIsValidBranchName` にnull文字テストなし
- **エージェント**: pr-test-analyzer
- **ファイル**: [validation_test.go](../myT-x/internal/git/validation_test.go)
- **修正案**: `{"contains null", "a\x00b", false}` テストケース追加

### S-15: `TestCreateWorktreeWithBranch` にブランチ名重複テストなし
- **エージェント**: pr-test-analyzer
- **ファイル**: [worktree_test.go](../myT-x/internal/git/worktree_test.go)
- **修正案**: 同一ブランチ名で2回目の `CreateWorktree` が失敗するテストを追加

### S-16: `TestCreateEnvBlock` にUnicode環境変数テストなし
- **エージェント**: pr-test-analyzer
- **ファイル**: [conpty_syscall_windows_test.go](../myT-x/internal/terminal/conpty_syscall_windows_test.go)
- **修正案**: `[]string{"LANG=日本語"}` のようなテストケース追加

### S-17: デバッグログプレフィックスの不統一（`[WARN-*]` vs `[DEBUG-*]`）
- **エージェント**: comment-analyzer
- **ファイル**: conpty_windows.go, shim_path_windows.go
- **内容**: `[WARN-CONPTY]`, `[WARN-SHIM]` が `slog.Warn` で使われており、`[DEBUG-*]` の grep パターンでは拾えない。開発終了時の一括削除で漏れるリスク
- **修正案**: 本番で残す意図を明記するか、プレフィックス方針を統一

---

## Strengths（良い点）

1. **パストラバーサル防御**: `copyConfigFilesToWorktree` のシンボリックリンク解決・ベースパスチェックが徹底
2. **ロールバック処理**: セッション・ワークツリー・ブランチのロールバックが包括的で、エラーチェインも適切
3. **ConPTY リソース管理**: `sync.Once` + 適切なクリーンアップ順序が堅牢
4. **テスタビリティ**: 関数変数パターン（`executeRouterRequestFn`等）による依存注入が一貫
5. **レジストリ操作**: `ERROR_MORE_DATA` ハンドリングとリトライが防御的
6. **Git リトライ**: index.lock 競合に対する指数バックオフリトライが適切
7. **テスト品質**: テーブル駆動テスト、フィールドカウントガード、`t.Cleanup` による関数変数復元が一貫
8. **セキュリティテスト**: パストラバーサル、シンボリックリンクエスケープの検証が充実
9. **git_test.go**: `createBareAndClone` によるリモートリポジトリシミュレーションなど、テスト設計が非常に高品質

---

## タスク整理 — 並列作業可否一覧

以下は検出された指摘事項を修正タスクとして整理し、**並列で作業可能か否か**を判定した表です。

### 凡例
- **並列OK**: 他のタスクと同時に作業しても競合しない
- **順次**: 他のタスクの完了に依存するか、同一ファイルの近接行を変更するため順次作業が必要
- **—**: 修正不要（確認のみ）

| # | 重要度 | ファイル | タスク概要 | 並列可否 | 同時作業不可のタスク | 備考 |
|---|--------|---------|-----------|---------|-------------------|------|
| I-01 | Important | app_session_api.go | defer内 emitSnapshot 二重発火修正 | 順次 | I-03, I-05 | 同一ファイルの defer ブロック変更 |
| I-02 | Important | app_worktree_api.go | copyConfigFilesToWorktree 失敗通知追加 | 順次 | S-02, S-06 | 同一ファイル |
| I-03 | Important | app_session_api.go | emitWorktreeCleanupFailure のctxフォールバック | 順次 | I-01, I-05, S-01 | 同一ファイル |
| I-04 | Important | shim_installer_windows.go | ハッシュファイル書込失敗のログレベル変更 | **並列OK** | — | 独立ファイル |
| I-05 | Important | 複数ファイル | slog.Warn + [DEBUG-*] プレフィックス統一 | 順次 | I-01, I-03 | 複数ファイル横断、方針決定が先 |
| I-06 | Important | command.go | executeGitCommandAt 削除 | 順次 | I-07 | 同一ファイル、git.go にも波及 |
| I-07 | Important | command.go | acquireGitSemaphore 削除 | 順次 | I-06 | 同一ファイル |
| I-08 | Important | validation.go | GenerateBranchName 削除 | **並列OK** | — | validation_test.go のテスト削除も同時対応 |
| I-09 | Important | conpty_close_windows_test.go | WaitForSingleObject エラーテスト追加 | **並列OK** | — | テストファイルのみ |
| I-10 | Important | command_test.go | リトライ動作テスト追加 | **並列OK** | — | テストファイルのみ |
| I-11 | Important | app_session_api_test.go | time.After フレーキー修正 | **並列OK** | — | テストファイルのみ |
| S-01 | Suggestion | app_session_api.go | KillSession の不要な GetWorktreeInfo 削除 | 順次 | I-01, I-03, I-05 | 同一ファイル |
| S-02 | Suggestion | app_worktree_api.go | runSetupScripts ラッパー削除 | 順次 | I-02, S-06 | 同一ファイル + テスト変更 |
| S-03 | Suggestion | worktree.go | baseBranch バリデーションコメント追加 | 順次 | S-04 | 同一ファイル |
| S-04 | Suggestion | worktree.go | RemoveWorktree 統合 | 順次 | S-03 | 同一ファイル |
| S-05 | Suggestion | worktree.go | 未使用関数の精査・削除 | 順次 | S-03, S-04 | 同一ファイル |
| S-06 | Suggestion | app_worktree_api.go | テストスタブ変数にコメント追加 | 順次 | I-02, S-02 | 同一ファイル |
| S-07 | Suggestion | conpty_windows.go | handleIO godocにスレッドセーフティ記述追加 | 順次 | S-11 | 同一ファイル |
| S-08 | Suggestion | shim_path_windows.go | 奇数バイト切り捨てログレベル引き上げ | **並列OK** | — | 独立ファイル |
| S-09 | Suggestion | shim_installer_windows.go | sha256HexFile失敗ログレベル変更 | **並列OK** | I-04 | 同一ファイルだが近接しない |
| S-10 | Suggestion | conpty_syscall_windows.go | closePseudoConsole デバッグログ追加 | **並列OK** | — | 独立ファイル |
| S-11 | Suggestion | conpty_windows.go | WaitForSingleObject失敗をfirstErrに含める | 順次 | S-07 | 同一ファイル |
| S-12 | Suggestion | app_session_api_test.go | バリデーションテスト統合 | **並列OK** | — | テストのみ |
| S-13 | Suggestion | app_pane_api_test.go | テーブル駆動テスト化 | **並列OK** | — | テストのみ |
| S-14 | Suggestion | validation_test.go | null文字テスト追加 | **並列OK** | — | テストのみ |
| S-15 | Suggestion | worktree_test.go | ブランチ名重複テスト追加 | **並列OK** | — | テストのみ |
| S-16 | Suggestion | conpty_syscall_windows_test.go | Unicode環境変数テスト追加 | **並列OK** | — | テストのみ |
| S-17 | Suggestion | 複数ファイル | [WARN-*] プレフィックス方針統一 | 順次 | I-05 | I-05 と同時対応が望ましい |

### 推奨作業順序

```
Phase 1（並列実行可能なグループ）:
├── I-04: shim ハッシュファイルログレベル変更
├── I-08: GenerateBranchName 削除
├── I-09: WaitForSingleObject エラーテスト追加
├── I-10: リトライ動作テスト追加
├── I-11: time.After フレーキー修正
├── S-08: 奇数バイト切り捨てログレベル変更
├── S-09: sha256HexFile ログレベル変更
├── S-10: closePseudoConsole デバッグログ追加
├── S-13: app_pane_api_test テーブル駆動化
├── S-14: null文字テスト追加
├── S-15: ブランチ名重複テスト追加
└── S-16: Unicode環境変数テスト追加

Phase 2（app_session_api.go 集中変更）:
├── I-05: slog.Warn + [DEBUG-*] 方針決定・統一（→ S-17 同時対応）
├── I-01: emitSnapshot 二重発火修正
├── I-03: emitWorktreeCleanupFailure ctx フォールバック
└── S-01: KillSession 不要呼び出し削除

Phase 3（command.go + git.go 変更）:
├── I-06: executeGitCommandAt 削除
└── I-07: acquireGitSemaphore 削除

Phase 4（app_worktree_api.go 変更）:
├── I-02: copyConfigFilesToWorktree 通知追加
├── S-02: runSetupScripts ラッパー削除
└── S-06: テストスタブコメント追加

Phase 5（worktree.go + conpty_windows.go 変更）:
├── S-03 + S-04: RemoveWorktree 統合 + baseBranch コメント
├── S-05: 未使用関数精査
├── S-07: handleIO godoc 追加
└── S-11: WaitForSingleObject firstErr 修正
```
