# PR Review Summary — 2026-02-16 16:34

## レビュー対象

コミット前の `myT-x/` 配下の全差分ファイル（20ファイル、+4745 / -405行）

### カテゴリ別ファイル一覧

| カテゴリ | ファイル |
|---------|--------|
| **internal/git** | `command.go`, `command_test.go`, `git.go`, `git_test.go`, `validation.go`, `validation_test.go`, `worktree.go`, `worktree_test.go` |
| **App API** | `app_session_api.go`, `app_session_api_test.go`, `app_worktree_api.go`, `app_worktree_api_test.go`, `app_pane_api_test.go` |
| **internal/install** | `shim_installer_windows.go`, `shim_installer_windows_test.go`, `shim_path_windows.go` |
| **internal/terminal** | `conpty_windows.go`, `conpty_syscall_windows.go`, `conpty_syscall_windows_test.go`, `conpty_close_windows_test.go` |

---

## Critical Issues（1件：マージ前に修正必須）

### CRIT-1: [install] テストがユーザーのWindowsレジストリを汚染する
- **ファイル**: `internal/install/shim_installer_windows_test.go` (setupEmbedTestEnv)
- **説明**: 旧コードの `ensurePathContains` はプロセスPATHを先にチェックし、installDirが含まれていれば早期リターンしていた。今回の変更でプロセスPATHチェックが削除されレジストリのみを参照するようになったため、`TestEnsureShimInstalled_*` テスト群がユーザーの実 `HKCU\Environment\Path` にテンポラリディレクトリのパスを追加し、**クリーンアップされない**。さらに `broadcastEnvironmentSettingChange()` も呼ばれ他のアプリケーションにも影響する。
- **対策案**:
  1. レジストリ操作を含むテストには `MYTX_RUN_REGISTRY_INTEGRATION_TEST` ゲートを追加
  2. または、レジストリ操作をインターフェース化してモック可能にする
  3. テスト後に `t.Cleanup` でレジストリからテスト用エントリを削除する

---

## Important Issues（11件：マージ後に修正推奨）

### IMP-1: [app_session_api.go] CreateSession 成功時のスナップショット通知が削除された
- **ファイル**: `app_session_api.go` L49-52
- **説明**: defer内コメント「activateCreatedSession already emits the success snapshot」は不正確。`activateCreatedSession` は `emitSnapshot()` を呼ばない。旧コードでは成功時に明示的に `emitSnapshot()` を呼んでいた。セッション一覧のサイドバー等が `tmux:snapshot` イベントを監視している場合、更新されない可能性がある。`CreateSessionWithWorktree` も同パターン。

### IMP-2: [app_session_api.go] KillSession の deleteWorktree=false 時に診断ログが消失
- **ファイル**: `app_session_api.go` L147-151
- **説明**: 旧コードでは `deleteWorktree` に関わらず `GetWorktreeInfo` を呼び、取得失敗時に warning ログを出力していた。新コードでは `deleteWorktree=false` 時に `GetWorktreeInfo` を呼ばないため、メタデータ破損の診断情報が失われる。

### IMP-3: [app_worktree_api.go] copyConfigFilesToWorktree の Lstat で既存ファイル上書きに警告ログがない
- **ファイル**: `app_worktree_api.go` L434-449
- **説明**: `Lstat` で通常ファイル検出（非シンボリックリンク）の場合に既存ファイルを上書きするが、上書き前の警告ログがない。copy_files の誤設定で重要ファイルが上書きされるリスクがある。

### IMP-4: [git/validation.go] ValidateCommitish のエラーメッセージに不正文字情報がない
- **ファイル**: `internal/git/validation.go` L63
- **説明**: `invalid commit-ish: <value>` で返すのみ。`%q` でエスケープし、許可文字パターンを含めるとデバッグ容易になる。

### IMP-5: [git/git.go] CommitAll の message バリデーションが空チェックのみ
- **ファイル**: `internal/git/git.go` L249-250
- **説明**: 空白文字のみ（`"   "` 等）の場合に `strings.TrimSpace` でチェックすべき。

### IMP-6: [git/command.go] localeNeutralGitEnv で毎回 os.Environ() を呼びメモリ割当多発
- **ファイル**: `internal/git/command.go` L66-67
- **説明**: セマフォで並行数は制限されているため実用上の問題は小さいが、高頻度実行時にはパフォーマンス改善の余地あり。

### IMP-7: [install/shim_installer_windows.go] writeFileAtomically / copyFile で Sync() 未呼出
- **ファイル**: `internal/install/shim_installer_windows.go`
- **説明**: `tmpFile.Close()` 前に `tmpFile.Sync()` を呼んでいない。電源断時にrename後のファイルが不完全になるリスク。発生確率は低いがshimバイナリ破損はアプリ機能停止に繋がる。

### IMP-8: [terminal/conpty_windows.go] normalizeReadFileError が ERROR_INVALID_HANDLE を処理しない（非対称）
- **ファイル**: `internal/terminal/conpty_windows.go`
- **説明**: `normalizeWriteFileError` は `ERROR_INVALID_HANDLE → io.ErrClosedPipe` を処理するが、`normalizeReadFileError` は `ERROR_INVALID_HANDLE` を素通しさせる。`handleIO` が `io.Reader` を実装する契約として、閉じたハンドルには `io.EOF` を返すべき。上位の `normalizeConPtyPipeError` でキャッチするため実害は無いが、対称性を確保すべき。

### IMP-9: [install/shim_path_windows.go] readRegistryPathRawValueWithRetry のバリデーション重複
- **ファイル**: `internal/install/shim_path_windows.go` L119-185
- **説明**: `rawSize < 0` や型チェック（`SZ` / `EXPAND_SZ`）のバリデーションが3箇所に散在。共通バリデーション関数に抽出すると DRY 原則に沿う。

### IMP-10: [app_worktree_api.go] copyConfigFilesToWorktree のループ本体が50行以上で長すぎる
- **ファイル**: `app_worktree_api.go` L208-266
- **説明**: 1ファイルの処理（パス検証、シンボリックリンク解決、読み取り、ディレクトリ作成、書き込み）をヘルパーに抽出すべき。各部分のテストも容易になる。

### IMP-11: [app_worktree_api.go] appendCopyFailures が過剰に複雑（YAGNI違反）
- **ファイル**: `app_worktree_api.go` L268-290
- **説明**: 呼び出し元で `failures` は常に空。重複排除用 `map` 生成は不要なオーバーヘッド。

---

## Suggestions（18件：改善推奨）

### SUG-1: [git/validation.go] FindAvailableWorktreePath のマジックナンバー100を定数化
- `const maxWorktreePathSuffix = 100` としてプロジェクト内の同パターン（`findAvailableSessionName` の `maxSessionNameSuffix`）と統一する。

### SUG-2: [git/validation_test.go] ValidateCommitish にコマンドインジェクション系パターンを追加
- `HEAD;echo`, `` `whoami` ``, `HEAD|cat`, `$(cmd)`, `HEAD\nmalicious` 等のテストケースで regex の堅牢性を証明すべき。

### SUG-3: [git/git.go] stripRemotePrefix のフォールバック分岐にコメント追加
- 未知リモート名の `"/"` 単純分割の意図を明記する。

### SUG-4: [git/worktree.go] ListWorktreesWithInfo で bare worktree 除外のドキュメント追加
- 関数ドキュメントに「bare worktree はリストから除外される」と明記する。

### SUG-5: [git/command.go] runGitCLIWithContext が明示的にデフォルト値を渡しているが nil で委譲可能
- デフォルト管理を `WithDeps` 関数に一元化する選択肢がある。

### SUG-6: [app_session_api_test.go / app_worktree_api_test.go] slog.SetDefault の使用
- 並列テスト (`t.Parallel()`) 追加時にグローバルロガー競合が発生する。将来の注意事項として記載。

### SUG-7: [app_worktree_api.go] createWorktreeForSession の branchName 二重検証
- 呼び出し元で既にバリデーション済み。防御的コーディングとして合理的だが、コメントで意図を明記すると良い。

### SUG-8: [app_worktree_api.go] shellExecFlag のデフォルト `-Command` の設計理由をコメント追記
- 「Windows 環境では PowerShell がデフォルト」という前提をコメントに明記する。

### SUG-9: [terminal/conpty_windows.go] doClose の WaitForSingleObject 失敗時の TerminateProcess 意図をコメント追記
- `WAIT_FAILED (0xFFFFFFFF)` の場合の TerminateProcess 実行意図を明確にする。

### SUG-10: [terminal/conpty_syscall_windows_test.go] _COORD.Pack() テストケース拡充
- `{X:0, Y:0}`, `{X:80, Y:40}`, `{X:-1, Y:-1}` の追加を推奨。

### SUG-11: [install/shim_path_windows.go] containsPathEntry の filepath.Abs 適用検討
- PATHエントリに `..` が含まれる場合の同一ディレクトリ判定改善。リスク低。

### SUG-12: [install/shim_path_windows.go] decodeRegistryUTF16String に不正サロゲートペアテスト追加

### SUG-13: [install/shim_installer_windows.go] sha256HexFile の defer Close エラー無視
- read-only 操作なので Effective Go 的に許容だが、一貫性の検討として記載。

### SUG-14: テストヘルパー `runGitInDir` を `localeNeutralGitEnv` 適用版に統一
- `git_test.go` と `app_worktree_api_test.go` で同一処理のヘルパーが重複。ロケール依存環境での偽陰性リスク。

### SUG-15: 主要エラー返却関数に `errors.Is`/`errors.Unwrap` 検証を追加
- 大半のエラーテストは `strings.Contains(err.Error(), ...)` だが、`%w` ラッピングの正確性保証のため `errors.Is` チェックも追加推奨。

### SUG-16: [app_worktree_api.go / app_session_api.go] findSessionByRootPath と findSessionByWorktreePath の類似パターン
- 将来的に `findSessionByPredicate(pred func(SessionSnapshot) bool)` のような共通基盤を検討。

### SUG-17: [git/git.go] CleanupLocalBranchIfOrphaned の `-d` (safe delete) 使用は適切
- 将来 `-D`（force delete）が必要な場合は明示的なオプション追加が必要。注意喚起として記載。

### SUG-18: [terminal/conpty_windows.go] normalizeConPtyPipeError の二段正規化の意図コメント追記
- `normalizeWriteFileError` → `io.ErrClosedPipe` → `normalizeConPtyPipeError` のチェーンをコメントで説明。

---

## テストカバレッジ分析

### 未テスト関数一覧（Critical / Important）

| 優先度 | パッケージ | 関数名 | 理由 |
|-------|---------|-------|------|
| **P0** | install | `sha256Hex` / `sha256HexFile` | ハッシュ計算はインストール判定の根幹 |
| **P1** | install | `ensurePathContains` | レジストリ直接操作のAPI—DI未導入 |
| **P1** | install | `EnsureShimInstalled` / `NeedsShimInstall` | 公開APIの2関数に直接テストなし |
| **P2** | terminal | `ConPtyDimensions`/`ConPtyWorkDir`/`ConPtyEnv` | Optionパターンの不正値バリデーション |
| **P2** | git | `FindAvailableWorktreePath` 100超過境界 | タイムスタンプフォールバック未テスト |
| **P2** | install | `countPathEntries`/`pathRegistryTypeName` | 純粋関数でテスト容易 |
| **P3** | git | `runGitCLI`/`runGitCommand`/`runGitCommandRaw` | 統合テストで間接カバー済み |
| **P3** | app | `validateAndTrimWorktreeBranchName` | 内部関数、上位テストで間接カバー |
| **P3** | app | `isPathWithinBase` | copyConfigFiles テストで間接カバー |
| **P3** | app | `rollbackWorktree` | 部分的に間接カバー |

### テスト品質の強み
- **DI/テストシーム設計**: `executeRouterRequestFn`, `currentBranchFn`, `waitForSingleObjectFn` 等の関数変数パターンが一貫
- **ロールバック・リカバリテスト**: 正常完了、作成失敗→ロールバック、ロールバック自体の失敗を完全カバー
- **セキュリティテスト**: パストラバーサル、シンボリックリンク攻撃（src/dst両方向）を網羅
- **構造体フィールドガード**: `reflect.TypeOf(...).NumField()` で新フィールド追加時のテスト更新を強制
- **レジストリ操作テスト**: 12シナリオ以上で `ERROR_MORE_DATA` リトライ等を網羅
- **デッドロック検知テスト**: `outputMu` → `OutputBuffer.Stop` 間のデッドロックを明示的にテスト

---

## Strengths（この PR の良い点）

1. **セキュリティ意識の高い設計**: `"--"` セパレータの一貫使用、入力バリデーション（ブランチ名、commitish、ワークツリーパス）をgitコマンド実行前に全て実施
2. **堅牢なリトライ機構**: index.lock 競合に対する exponential backoff リトライが context キャンセル対応
3. **一貫したエラーハンドリング**: `%w` によるエラーラッピング、サイレントエラーの排除
4. **並行安全性の大幅改善**: `handleIO` にミューテックス導入、handle スナップショットパターンでデッドロック回避
5. **エラー正規化の三層設計**: OS→Go標準→操作コンテキストの階層化
6. **TOCTOU緩和**: レジストリ操作の read + write を単一ハンドルで実行
7. **`_COORD.Pack()` の符号拡張バグ修正**: `int32` → `uint16` キャストで符号拡張を防止
8. **`isPathWithinBase` の導入**: `strings.HasPrefix` から `filepath.Rel` ベースに改善、prefix collision 脆弱性を排除
9. **ロールバック設計の改善**: `defer` ベースロールバック、`rollbackWorktree` がブランチクリーンアップも実行
10. **テスト品質**: 構造体フィールドガード、シンボリックリンク攻撃テスト、レジストリ操作テストの網羅性

---

## 修正タスク一覧と並列作業可否

以下は、全指摘事項に対する修正タスクの一覧です。  
各タスクの**並列修正可否**は、他のタスクとの依存関係に基づいて判定しています。

### 凡例
- ✅ **並列OK**: 他タスクと独立して修正可能
- ⚠️ **条件付き並列**: 同ファイル内の別タスクと競合する可能性がある（マージ注意）
- ❌ **順次**: 他タスクの完了後に実施すべき

### Critical（マージ前 必須修正）

| # | タスクID | ファイル | 内容 | 優先度 | 並列 | 依存関係 | 備考 |
|---|---------|---------|------|-------|------|---------|------|
| 1 | CRIT-1 | `install/shim_installer_windows_test.go` | テストのレジストリ汚染防止（skipゲートまたはCleanup追加） | P0 | ✅ | なし | CI環境でも実害あり |

### Important（計画的に修正）

| # | タスクID | ファイル | 内容 | 優先度 | 並列 | 依存関係 | 備考 |
|---|---------|---------|------|-------|------|---------|------|
| 2 | IMP-1 | `app_session_api.go` | CreateSession 成功時の emitSnapshot() 追加またはコメント修正 | P1 | ✅ | なし | UIイベント同期に影響 |
| 3 | IMP-2 | `app_session_api.go` | KillSession の deleteWorktree=false 時の診断ログ復元 | P1 | ⚠️ | IMP-1と同ファイル | 同ファイル編集注意 |
| 4 | IMP-3 | `app_worktree_api.go` | copyConfigFilesToWorktree の上書き警告ログ追加 | P1 | ⚠️ | IMP-10, IMP-11と同ファイル | 同ファイル編集注意 |
| 5 | IMP-4 | `internal/git/validation.go` | ValidateCommitish のエラーメッセージ改善 | P2 | ✅ | なし | 1行変更 |
| 6 | IMP-5 | `internal/git/git.go` | CommitAll の TrimSpace バリデーション追加 | P2 | ✅ | なし | 1行変更 |
| 7 | IMP-6 | `internal/git/command.go` | localeNeutralGitEnv のアロケーション最適化 | P3 | ✅ | なし | 性能改善・低優先 |
| 8 | IMP-7 | `install/shim_installer_windows.go` | writeFileAtomically / copyFile に Sync() 追加 | P2 | ✅ | なし | 各関数に1行追加 |
| 9 | IMP-8 | `terminal/conpty_windows.go` | normalizeReadFileError に ERROR_INVALID_HANDLE 追加 | P2 | ✅ | なし | 1行追加 |
| 10 | IMP-9 | `install/shim_path_windows.go` | バリデーション重複の共通関数抽出 | P2 | ✅ | なし | リファクタリング |
| 11 | IMP-10 | `app_worktree_api.go` | copyConfigFilesToWorktree ループ本体のヘルパー抽出 | P2 | ⚠️ | IMP-3, IMP-11と同ファイル | リファクタリング |
| 12 | IMP-11 | `app_worktree_api.go` | appendCopyFailures 簡素化 | P2 | ⚠️ | IMP-3, IMP-10と同ファイル | YAGNI修正 |

### テストカバレッジ向上

| # | タスクID | ファイル | 内容 | 優先度 | 並列 | 依存関係 | 備考 |
|---|---------|---------|------|-------|------|---------|------|
| 13 | TEST-1 | `install/shim_installer_windows_test.go` | `sha256Hex`/`sha256HexFile` テスト追加 | P0 | ✅ | なし | テスト追加のみ |
| 14 | TEST-2 | `install/shim_path_windows_test.go` (新規) | `countPathEntries`/`pathRegistryTypeName` テスト追加 | P2 | ✅ | なし | テスト追加のみ |
| 15 | TEST-3 | `git/validation_test.go` | コマンドインジェクション系パターン追加 | P2 | ✅ | なし | テスト追加のみ |
| 16 | TEST-4 | `terminal/conpty_syscall_windows_test.go` | _COORD.Pack() テストケース拡充 | P3 | ✅ | なし | テスト追加のみ |
| 17 | TEST-5 | `install/shim_installer_windows_test.go` | writeFileAtomically エラーパステスト | P2 | ✅ | なし | テスト追加のみ |

### Suggestion（改善推奨・低優先）

| # | タスクID | ファイル | 内容 | 優先度 | 並列 | 依存関係 | 備考 |
|---|---------|---------|------|-------|------|---------|------|
| 18 | SUG-1 | `git/validation.go` | マジックナンバー100の定数化 | P3 | ✅ | なし | 1行変更 |
| 19 | SUG-3 | `git/git.go` | stripRemotePrefix フォールバックコメント追加 | P3 | ✅ | なし | コメントのみ |
| 20 | SUG-4 | `git/worktree.go` | ListWorktreesWithInfo のドキュメント追加 | P3 | ✅ | なし | コメントのみ |
| 21 | SUG-9 | `terminal/conpty_windows.go` | doClose WaitForSingleObject 失敗時のコメント追記 | P3 | ⚠️ | IMP-8と同ファイル | 同ファイル編集注意 |
| 22 | SUG-14 | `app_worktree_api_test.go` | runGitInDir を localeNeutralGitEnv 適用版に統一 | P3 | ✅ | なし | テストヘルパー修正 |
| 23 | SUG-15 | 複数テストファイル | errors.Is/errors.Unwrap 検証追加 | P3 | ✅ | なし | テスト改善 |

---

### 並列修正の注意事項まとめ

**完全に並列で修正可能なグループ：**
- グループA: CRIT-1（install テスト）
- グループB: IMP-1 + IMP-2（app_session_api.go — 同ファイルだが別関数なので注意してマージ）
- グループC: IMP-4 + IMP-5 + IMP-6（git 各ファイル — 全て別ファイル）
- グループD: IMP-7 + IMP-8 + IMP-9（install/terminal — 全て別ファイル）
- グループE: TEST-1 〜 TEST-5（全て別ファイルまたは別テスト関数）
- グループF: SUG-1 〜 SUG-15（コメント・定数化のみ — 低優先）

**同ファイル内で競合する可能性があるタスク：**
- `app_session_api.go`: IMP-1 + IMP-2（別関数だが同ファイル）
- `app_worktree_api.go`: IMP-3 + IMP-10 + IMP-11（同じ `copyConfigFilesToWorktree` 周辺）
- `terminal/conpty_windows.go`: IMP-8 + SUG-9（別関数だが同ファイル）

### 推奨修正順序

```
Phase 1 (最優先): CRIT-1, TEST-1
Phase 2 (重要):   IMP-1〜3, IMP-7〜9, TEST-2〜3
Phase 3 (改善):   IMP-4〜6, IMP-10〜11, TEST-4〜5
Phase 4 (最適化): SUG-* 全般
```
