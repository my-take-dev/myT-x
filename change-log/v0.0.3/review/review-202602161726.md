# PR Review: myT-x 全変更レビュー (2026-02-16)

## 概要

| 項目 | 値 |
|------|-----|
| 対象 | myT-x/ 配下 22ファイル |
| 変更規模 | +5,000行 / -426行 |
| レビュー方法 | 6並列エージェント（コード×4カテゴリ、テスト、サイレント障害） |
| Critical | 2件 |
| Important | 17件 |
| Suggestion | 31件 |

## カテゴリ別ファイル一覧

| カテゴリ | ファイル |
|---------|--------|
| App Layer | app_session_api.go, app_worktree_api.go, app_pane_api_test.go, app_session_api_test.go, app_worktree_api_test.go |
| internal/git | command.go, git.go, validation.go, worktree.go, command_test.go, git_test.go, validation_test.go, worktree_test.go |
| internal/install | shim_installer_windows.go, shim_path_windows.go, shim_source_windows.go, shim_embed_test.go, shim_installer_windows_test.go |
| internal/terminal | conpty_windows.go, conpty_syscall_windows.go, conpty_close_windows_test.go, conpty_syscall_windows_test.go |

---

## Critical (2件)

### C-1: `createWorktreeForSession` の `CurrentBranch()` エラーが完全サイレント
- **ファイル**: app_worktree_api.go L197付近
- **カテゴリ**: サイレント障害
- **内容**: `baseBranch` 解決時に `CurrentBranch()` が失敗しても、エラーログがゼロ。detached HEADの正常ケース（`resolved == ""`）とgitコマンド障害（`brErr != nil`）を区別できず、障害が完全に隠蔽される。`baseBranch = "HEAD"` で作成が進行し、意図しないベースからworktreeが作成されるリスクがある。
- **修正案**: `brErr != nil` の場合にWarnログを1行追加

```go
if baseBranch == "" {
    if resolved, brErr := repo.CurrentBranch(); brErr == nil && resolved != "" {
        baseBranch = resolved
    } else {
        if brErr != nil {
            slog.Warn("[WARN-GIT] failed to detect current branch, falling back to HEAD",
                "error", brErr)
        }
        baseBranch = "HEAD"
    }
}
```

### C-2: `runGitCLIWithContextAndDeps` で `args` が空スライスの場合にパニック
- **ファイル**: internal/git/command.go L119付近
- **カテゴリ**: バグ
- **内容**: `args[0]` を無条件でエラーメッセージに使用。`runGitCLIWithContext` 経由では発生しないが、テストから直接呼ばれた場合に index out of range パニックが起きる。
- **修正案**: 関数先頭に `len(args) == 0` チェックを追加

---

## Important (17件)

### App Layer (5件)

#### I-1: `chooseWorktreeIdentifier` がマジック文字列 `"work"` に依存
- **ファイル**: app_worktree_api.go L246-254
- **内容**: `SanitizeCustomName` のデフォルト戻り値 `"work"` をハードコードで判定。gitパッケージ側のデフォルト値が変更された場合にサイレントに壊れる。
- **修正案**: 定数またはパッケージ公開値で共有

#### I-2: `createSessionForDirectory` で empty stdout + rollback失敗時にセッションが孤立
- **ファイル**: app_worktree_api.go L227-233
- **内容**: tmuxがセッション作成に成功したが stdout が空、かつ rollback も失敗した場合、呼び出し元の defer ロールバックも発動しない（`createdName==""`条件で弾かれる）。tmux上に孤立セッションが残る。
- **修正案**: ログに「手動対応が必要」等の明確なメッセージを記録

#### I-3: `copyConfigFilesToWorktree` のエラー報告がイベントのみでログなし
- **ファイル**: app_worktree_api.go L145-149
- **内容**: フロントエンドイベントは発行されるが、バックエンドのログに `copyFailures` のサマリーが出力されない。フロントエンドが接続していない場合にイベントがロストする。
- **修正案**: `len(copyFailures) > 0` の直後にWarnログを追加

#### I-4: `rollbackPromotedWorktreeBranch` で `%v` 使用、エラーチェイン喪失
- **ファイル**: app_worktree_api.go L437付近
- **内容**: `fmt.Errorf("%v; %v", checkoutErr, deleteErr)` でエラーチェインが切れる。Go 1.20+ では `%w` を2つ使用可能。
- **修正案**: `fmt.Errorf("%w; %w", checkoutErr, deleteErr)` に変更

#### I-5: `KillSession` の `deleteWorktree=false` 時 `wtErr` のWarnログレベル
- **ファイル**: app_session_api.go L123-126
- **内容**: 削除を要求していないセッション終了時にworktreeメタデータの取得失敗をWarnで出力。worktree無しセッションの通常終了でもログが出る可能性がある。
- **修正案**: Debugレベルに変更するか、worktree有無の事前判定を追加

### internal/git (4件)

#### I-6: `upsertEnvVar` のクロスプラットフォーム考慮
- **ファイル**: internal/git/command.go L73-84
- **内容**: `strings.EqualFold` を使用。Windows専用アプリケーションなので現状問題なしだが、Linux CI環境では環境変数名の大文字小文字が区別される。
- **修正案**: 現時点で修正不要。将来のクロスプラットフォーム対応時に注意

#### I-7: 最終リトライの失敗ログ欠落
- **ファイル**: internal/git/command.go L141-148
- **内容**: `attempt >= maxGitRetries-1` で即座にループを抜けるが、最終試行の失敗がログに出ない。デバッグ時に混乱の原因になる。
- **修正案**: 最終試行の失敗もデバッグログに出力（待機は不要）

#### I-8: `ValidateWorktreePath` で元pathに対してセグメント分割する意図が不明確
- **ファイル**: internal/git/validation.go L81-96
- **内容**: `filepath.Clean` 後のパスではなく元の `path` で `..` チェックしている。ユーザーの意図的な `..` 入力を拒否する設計として正しいが、コメントがない。
- **修正案**: 元パスを使う理由をコメントで明示

#### I-9: `HasUnpushedCommits` のエラーメッセージパターンのロケール依存性
- **ファイル**: internal/git/git.go L285-303
- **内容**: `isNoUpstreamTrackingError` はgitのエラーメッセージ文字列に依存。`localeNeutralGitEnv` で `LC_ALL=C` を設定しているため現状動作するが、理想的には終了コードベースの判定。
- **修正案**: 現時点で修正不要だが、コメントで依存関係を明記

### internal/install (3件)

#### I-10: `readRegistryPathRawValueWithRetry` 型不一致時にリトライ不能
- **ファイル**: internal/install/shim_path_windows.go L135付近
- **内容**: `valueTypeRead != valueType` で即座にエラー返却。別プロセスがPATHの型を変更した場合（`%USERPROFILE%` 追加等）、リトライ可能な状況なのに失敗する。
- **修正案**: 型変更時にリトライするか、理由をコメントに記載

#### I-11: `ensurePathContainsFn` テストシームがテスト並列実行非安全
- **ファイル**: internal/install/shim_installer_windows.go L17付近
- **内容**: パッケージレベル変数のテストシーム。`t.Parallel()` 使用時にレース条件が発生する。
- **修正案**: テスト側に `t.Parallel()` 禁止コメントを追加

#### I-12: `rawSize` の上限チェックなし
- **ファイル**: internal/install/shim_path_windows.go L120付近
- **内容**: `validateRegistryPathRawSize` は負値のみチェック。レジストリ破損で極端に大きなサイズが返された場合、巨大バッファ確保を試みる。
- **修正案**: `maxRegistryPathSize = 64KB` 等の上限ガードを追加

### internal/terminal (3件)

#### I-13: `normalizeReadFileError` で `ERROR_NO_DATA` が未処理
- **ファイル**: internal/terminal/conpty_windows.go L47付近
- **内容**: Write側は `ERROR_NO_DATA` を処理しているが、Read側にはない。パイプのWrite端がクローズされた際にReadFileが `ERROR_NO_DATA` を返すと、io.EOF にマッピングされず `io.Reader` の契約に違反する可能性がある。
- **修正案**: `normalizeReadFileError` に `ERROR_NO_DATA` の `io.EOF` マッピングを追加

#### I-14: `doClose` の `postTerminateWaitErr` が `firstErr` に集約されない
- **ファイル**: internal/terminal/conpty_windows.go L270付近
- **内容**: `TerminateProcess` 成功後のプロセス終了確認結果が呼び出し元に伝搬されない。診断情報として有用。
- **修正案**: 必要に応じて `firstErr` に集約

#### I-15: `startConPty` の ptyIn/ptyOut 即座クローズの根拠コメント不足
- **ファイル**: internal/terminal/conpty_windows.go L160-175
- **内容**: `CreatePseudoConsole` が渡されたパイプハンドルを内部的にduplicate/保持するため呼び出し側のクローズは安全だが、この挙動を信頼する根拠がコメントにない。
- **修正案**: Windows 10 1809+でのCreatePseudoConsole仕様をコメントに補記

### テスト (2件)

#### I-16: slogテストヘルパーが6箇所以上で未共通化
- **ファイル**: app_session_api_test.go, app_worktree_api_test.go の複数箇所
- **内容**: `slog.SetDefault()` の差し替え+復元パターンが繰り返されている。コピーミスのリスクがある。
- **修正案**: `testutil` パッケージに `captureLogBuffer(t) *bytes.Buffer` ヘルパーを追加

#### I-17: 非同期テストのタイムアウト不整合
- **ファイル**: app_session_api_test.go L449
- **内容**: `waitForSignal` が固定500msタイムアウトを使用。`waitForAsyncError` は `t.Deadline()` を参照。パターンが不統一。
- **修正案**: タイムアウト戦略を統一

---

## Suggestion (31件)

### App Layer (8件)
| # | ファイル | 内容 |
|---|---------|------|
| S-1 | app_session_api.go L52 | `sessionMayExist` → `sessionCreationAttempted` の方が意図が明確 |
| S-2 | app_session_api.go L60-63 | ロールバック**成功**時のログがない |
| S-3 | app_session_api.go L141 | `KillSession` の `worktreeInfo` var宣言が冗長 |
| S-4 | app_worktree_api.go L113-122 | defer内のクリーンアップが20行超。ヘルパー抽出で可読性向上 |
| S-5 | app_worktree_api.go L189-200 | goroutineクロージャキャプチャの不変性コメント追加推奨 |
| S-6 | app_worktree_api.go L22-38 | テストシーム3つがファイル横断。定義場所のコメント明示 |
| S-7 | app_worktree_api.go L493-501 | `PromoteWorktreeToBranch` の空チェックパターン不統一 |
| S-8 | app_worktree_api.go L680-691 | `err != nil` かつ `branchName != ""` ケースのテスト検証推奨 |

### internal/git (5件)
| # | ファイル | 内容 |
|---|---------|------|
| S-9 | command.go L66-71 | `localeNeutralGitEnv` のスライスコピー意図コメント追加 |
| S-10 | command.go L95-102 | `gitRetryBackoff` のビットシフトオーバーフロー保護（現状maxGitRetries=10で発生しない） |
| S-11 | command.go L166-170 | デバッグログに `args` 出力 — 将来のcredentialリスク（現状OK） |
| S-12 | validation.go L58-60 | `ValidateCommitish` のスペース付き入力時エラーメッセージ改善 |
| S-13 | validation.go L19-22 | `commitishRegex` のコロン許可 — Windowsドライブレターとの混同リスク（現状git側で防御） |

### internal/install (6件)
| # | ファイル | 内容 |
|---|---------|------|
| S-14 | shim_installer_windows.go L109 | `EnsureProcessPathContains` の戻り値でSetenv失敗を区別不能 |
| S-15 | shim_installer_windows.go L50-58 | エラーラップの不整合（copy shimパスにラップ無し） |
| S-16 | shim_installer_windows.go/shim_source_windows.go | `writeFileAtomically` と `copyFile` のロジック重複。共通ヘルパー抽出推奨 |
| S-17 | shim_path_windows.go L235 | `broadcastEnvironmentSettingChange` の `callErr == nil` は到達不能 |
| S-18 | shim_path_windows.go L175 | `selectPathRegistryValueType` の `default` 分岐の意図がコメント依存 |
| S-19 | shim_source_windows.go L33 | `findShimSource` の `go build` にタイムアウト不在 |

### internal/terminal (5件)
| # | ファイル | 内容 |
|---|---------|------|
| S-20 | conpty_windows.go L268 | Resize/Read/Write のロック戦略の非対称性を集約コメント化 |
| S-21 | conpty_windows.go L346 | `doClose` の `firstErr` パターン → `errors.Join` 検討（現状で実用上問題なし） |
| S-22 | conpty_windows.go L131 | `maxConPtyDimension = 32767` — ConPTY API実際のサポート上限は不明 |
| S-23 | conpty_windows.go L113 | `gracePeriodMS = 500` — 重いPowerShellプロファイルでは短い可能性 |
| S-24 | conpty_syscall_windows.go L58 | `createPseudoConsole` のHRESULTに説明追加推奨 |

### サイレント障害 (3件)
| # | ファイル | 内容 |
|---|---------|------|
| S-25 | app_worktree_api.go L453 | `findAvailableSessionName` のfail-openフォールバック — WarnレベルへのSuggestion |
| S-26 | app_worktree_api.go L541 | `findSessionByWorktreePath` も同様のfail-open |
| S-27 | conpty_syscall_windows.go L52 | `closePseudoConsole` の戻り値完全無視 — void APIだが Debugログ推奨 |

### テスト (4件)
| # | ファイル | 内容 |
|---|---------|------|
| S-28 | app_pane_api_test.go | 空文字列の入力テキスト・無効サイズのエッジケーステスト欠落 |
| S-29 | worktree_test.go | パスにスペース/日本語文字を含むworktree作成テスト欠落 |
| S-30 | git_test.go/app_worktree_api_test.go | `runGitCommandInDir`/`runGitInDir` ヘルパーの重複。testutil共通化推奨 |
| S-31 | app_session_api_test.go | `TestValidationIntegration` が validation_test.go と重複。統合テスト意図の明確化推奨 |

---

## 良い設計判断（Strengths）

1. **defer統合ロールバック**: 成功/失敗双方でスナップショットを発行し、UI同期を保証
2. **`worktreeCleanupParams` 構造体化**: 引数の爆発を防止し将来のパラメータ追加に対応
3. **シンボリックリンク多層防御**: `copyConfigFilesToWorktree` の徹底した入力検証
4. **setupScripts のキャンセル対応**: ロールバック時にgoroutineの完了を待機
5. **handleIO スナップショットパターン**: Read/WriteのMutex保持時間を最小化しデッドロック回避
6. **closeOnce + stateMu 二段排他**: Close冪等性とRead/Write/Resize/Pidの状態可視性を両立
7. **localeNeutralGitEnv**: ロケール依存を排除しgitメッセージパースの信頼性向上
8. **DI対応テストシーム**: `gitCommandRunner`/`gitRetryWaiter` による高テスト容易性
9. **readRegistryPathRawValueWithRetry**: ERROR_MORE_DATA対応の堅牢なレジストリ読み取り
10. **writeFileAtomically**: temp→rename パターンによるアトミック書き込み
11. **エラー正規化レイヤー**: ConPTYのWindowsエラーコードをGo標準エラーにマッピング
12. **グローバル変数のsave/restore**: テストでの `t.Cleanup` パターンが全箇所で徹底

---

## タスクテーブル（並列実行可能性）

| Worker | 対象 | タスク | 依存 |
|--------|------|--------|------|
| A | app_worktree_api.go | C-1: CurrentBranch() Warnログ追加 | なし |
| A | app_worktree_api.go | I-1: "work" マジック文字列 → 定数化 | なし |
| A | app_worktree_api.go | I-2: empty stdout rollback失敗時のログ追加 | なし |
| A | app_worktree_api.go | I-3: copyFailures サマリーWarnログ追加 | なし |
| A | app_worktree_api.go | I-4: %v → %w 修正 | なし |
| B | internal/git/command.go | C-2: args空チェック追加 | なし |
| B | internal/git/command.go | I-7: 最終リトライ失敗ログ追加 | なし |
| B | internal/git/validation.go | I-8: 元pathセグメント分割コメント追加 | なし |
| C | internal/terminal/conpty_windows.go | I-13: normalizeReadFileError に ERROR_NO_DATA 追加 | なし |
| C | internal/terminal/conpty_windows.go | I-14: postTerminateWaitErr の firstErr 集約 | なし |
| C | internal/terminal/conpty_windows.go | I-15: ptyIn/ptyOut クローズ根拠コメント | なし |
| D | internal/install/shim_path_windows.go | I-10: 型不一致リトライ or コメント | なし |
| D | internal/install/shim_path_windows.go | I-12: rawSize 上限チェック追加 | なし |
| D | internal/install/shim_installer_windows.go | I-11: t.Parallel() 禁止コメント | なし |
| E | app_session_api.go | I-5: wtErr ログレベル調整 | なし |
| E | app_session_api_test.go | I-16: slogテストヘルパー共通化 | なし |
| E | app_session_api_test.go | I-17: タイムアウト戦略統一 | I-16 |

**並列実行**: Worker A〜E は全て独立して実行可能。E内のI-17はI-16に依存。

---

## レビュー実施エージェント

1. **コードレビュー: App Layer** — app_session_api.go, app_worktree_api.go
2. **コードレビュー: internal/git** — command.go, git.go, validation.go, worktree.go
3. **コードレビュー: internal/install** — shim_installer_windows.go, shim_path_windows.go, shim_source_windows.go
4. **コードレビュー: internal/terminal** — conpty_windows.go, conpty_syscall_windows.go
5. **テストレビュー** — 全11テストファイル
6. **サイレント障害ハンター** — 全22ファイル横断

レビュー完了日時: 2026-02-16 17:26
