# PR Review Summary

**レビュー日時**: 2026-02-16 18:27  
**対象**: myT-x/ 配下の未コミット変更（SessionWorkDir機能追加）  
**レビュー手法**: 6つの専門エージェントによる並列レビュー

## 変更概要

| ファイル | 変更内容 | 変更量 |
|---------|---------|--------|
| `internal/tmux/session_manager_env.go` | `PaneContextSnapshot`に`SessionWorkDir`フィールド追加、workDir解決ロジック追加 | +17/-5 |
| `internal/tmux/command_router_handlers_pane.go` | `splitWindowResolved`にworkDirフォールバック追加 | +6 |
| `internal/tmux/session_manager_env_test.go` | SessionWorkDirのテスト3パターン追加 | +32 |
| `app_snapshot_delta_test.go` | PaneContextSnapshotフィールド数ガード 5→6 更新 | +1/-1 |

**テスト結果**: 全テストPASS ✅

---

## Critical Issues (1件)

### C-1. `splitWindowResolved` のフォールバックロジックにテストが存在しない
- **レビュー観点**: テスト品質
- **箇所**: `internal/tmux/command_router_handlers_pane.go:47-49`
- **説明**: 今回の変更の**主要な目的**である`splitWindowResolved`内のworkDirフォールバック処理（GUIスプリット時にworkDirが空のときSessionWorkDirを使う）にユニットテスト・統合テストが存在しない。以下のシナリオが未検証：
  - `workDir`が空文字のときに`SessionWorkDir`が使われること
  - `workDir`が空白のみのときに`SessionWorkDir`が使われること
  - `workDir`が明示指定されたときに`SessionWorkDir`で**上書きされない**こと
  - `workDir`も`SessionWorkDir`も空の場合の挙動
- **リスク**: この修正が動作することを保証するテストがないため、将来のリファクタリングでリグレッションが発生するリスクがある

---

## Important Issues (4件)

### I-1. デバッグログのキー名 `"originalWorkDir"` がフォールバック後の値を表示している
- **レビュー観点**: サイレント障害、コメント品質
- **箇所**: `internal/tmux/command_router_handlers_pane.go:55-58`
- **説明**: `slog.Debug`のログ出力がフォールバック処理（L47-49）の**後**に配置されているため、`"originalWorkDir"`というキー名にもかかわらず、フォールバック後の値が表示される。デバッグ時に「元のworkDirが何だったか」が追跡不能。
- **修正案**: 
  - ラベルを`"resolvedWorkDir"`に変更する、または
  - フォールバック前にも元の値をログ出力する

### I-2. フォールバック後もworkDirが空の場合に警告ログが出ない
- **レビュー観点**: サイレント障害
- **箇所**: `internal/tmux/command_router_handlers_pane.go:48-50`
- **説明**: `workDir`（引数）と`targetCtx.SessionWorkDir`（`RootPath`/`Worktree.Path`ともに未設定）が両方空の場合、`attachTerminal`に空文字列が渡される。ConPTYは空Dir時にホストプロセスのCWDを使うため動作停止はしないが、ユーザーが意図しないディレクトリでペインが開く可能性あり。**警告ログが一切出ない**。
- **修正案**: フォールバック後も空なら`slog.Warn`を出力

### I-3. テストが状態を引き継ぐフラット構造で独立性が欠如
- **レビュー観点**: テスト品質
- **箇所**: `internal/tmux/session_manager_env_test.go:385-415`
- **説明**: `TestGetPaneContextSnapshot`に追記された3つのSessionWorkDirテストは、同一のmanagerインスタンスに対して順次状態変更を行っている（空状態→SetRootPath→SetWorktreeInfo）。テスト順序に依存しており、中間のSetRootPathが失敗すると後続テストの前提が崩れる。
- **修正案**: `t.Run`サブテストで各ケースを独立したManagerインスタンスで実行

### I-4. 境界値テストの欠落
- **レビュー観点**: テスト品質
- **箇所**: `internal/tmux/session_manager_env_test.go:385-415`
- **説明**: 以下の境界値パターンがテストされていない：
  - `Worktree.Path`が空白のみ（例: `"   "`）→ RootPathにフォールバックするはず
  - `RootPath`が空白のみ
  - RootPath未設定でWorktreeのみ設定（Worktreeのみのケース）

---

## Suggestions (6件)

### S-1. `RootPath`側の`strings.TrimSpace`非対称性
- **箇所**: `internal/tmux/session_manager_env.go:191-194`
- **説明**: `Worktree.Path`は`TrimSpace`でガードされているが、`RootPath`はそのまま使用。`SetWorktreeInfo`側では正規化済みだが`SetRootPath`では未正規化。`splitWindowResolved`側の`TrimSpace`チェックで実害は防がれているが、設計の対称性として改善の余地がある。
- **修正案**: `workDir := strings.TrimSpace(sess.RootPath)` に変更

### S-2. コメントの重複によるrot（陳腐化）リスク
- **箇所**: `internal/tmux/session_manager_env.go:17-19` / `internal/tmux/session_manager_env.go:191-192`
- **説明**: structフィールドコメントと`GetPaneContextSnapshot`内のインラインコメントが同一内容の重複。ロジック変更時に2箇所の同期が必要。
- **修正案**: インラインコメントを`// Resolve effective working directory.`に短縮

### S-3. `strings.TrimSpace(workDir)`の二重呼び出し
- **箇所**: `internal/tmux/command_router_handlers_pane.go:49,68`
- **説明**: L49のフォールバック判定で`TrimSpace`を行い、L68の`attachTerminal`呼び出しでも再度`TrimSpace`している。フォールバック時点で正規化すれば後続は不要。
- **修正案**: 
  ```go
  workDir = strings.TrimSpace(workDir)
  if workDir == "" {
      workDir = targetCtx.SessionWorkDir
  }
  ```

### S-4. フォールバック発生自体のログ追加
- **箇所**: `internal/tmux/command_router_handlers_pane.go:46-50`
- **説明**: フォールバックが発動したこと自体をログに記録していない。shim経由で`-c`が空になった場合（未期待ケース）のデバッグ手がかりがない。
- **修正案**: `slog.Debug`でフォールバック発動を記録

### S-5. テストのテーブル駆動化推奨
- **箇所**: `internal/tmux/session_manager_env_test.go:385-415`
- **説明**: 3ケースの繰り返しパターンをテーブル駆動テストに整理すると保守性が向上。各ケースで独立したManagerインスタンスを使用することで状態依存も解消。

### S-6. `splitWindowResolved`のnilガード過剰チェック
- **箇所**: `internal/tmux/command_router_handlers_pane.go:36-38`
- **説明**: `target.Window`と`target.Window.Session`のチェックはこの関数内で直接参照されていない。`GetPaneContextSnapshot`が内部で検証するため冗長。ただし防御的コーディングとして許容範囲。

---

## Strengths（良い点）

| 観点 | 内容 |
|------|------|
| **フィールド数ガード** | `TestSnapshotFieldCounts`による自動検出機構が正しく更新されている |
| **スナップショットパターン** | `RLock` + deep copy（`cloneLayout`, `copyEnvMap`）でmutation isolationが適切 |
| **責務の分離** | WorkDir解決ロジックは`GetPaneContextSnapshot`内に集約、呼び出し側は計算済みの値を使用 |
| **命名品質** | `SessionWorkDir`はGoコミュニティ慣用語に準拠、Sessionプレフィックスでスコープが明確 |
| **コメント品質** | フォールバックコメントが「なぜ」（GUI splitパスでworkDir未提供）を説明 |
| **nil安全性** | pane→Window→Sessionの完全なnilチェーンが正しく実装 |
| **影響範囲** | PaneContextSnapshotの全参照箇所を確認済み、delta比較・イベントへの悪影響なし |
| **ロールバック処理** | `attachTerminal`失敗時のKillPaneロールバックが堅牢 |
| **型選択** | string型はSnapshot用途として適切（ゼロ値で未設定表現、コピー安全） |

---

## タスク一覧・並列作業可否表

作業者が効率よく修正作業を行えるよう、並列作業の可否を整理しました。

| # | 優先度 | タスク | 対象ファイル | 並列作業 | 備考 |
|---|--------|--------|-------------|----------|------|
| C-1 | 🔴 Critical | `splitWindowResolved`フォールバックのテスト作成 | 新規テストファイル or `command_router_handlers_pane_test.go` | ✅ 可能 | 他タスクと独立して作成可能。`CommandRouter`のモック/テスト基盤が必要。優先対応 |
| I-1 | 🟡 Important | ログキー名`"originalWorkDir"`→`"resolvedWorkDir"`変更 | `command_router_handlers_pane.go:57` | ✅ 可能 | 1行変更のみ。I-2, S-4と同時修正推奨 |
| I-2 | 🟡 Important | 空workDir時の警告ログ追加 | `command_router_handlers_pane.go:50付近` | ✅ 可能 | I-1, S-4と同じファイル内で同時修正推奨 |
| I-3 | 🟡 Important | SessionWorkDirテストの独立化（t.Run分割） | `session_manager_env_test.go:385-415` | ✅ 可能 | I-4と同時にリファクタ可能 |
| I-4 | 🟡 Important | 境界値テスト追加（空白Pathフォールバック等） | `session_manager_env_test.go` | ✅ 可能 | I-3と同時にリファクタ可能 |
| S-1 | 🔵 Suggestion | `RootPath`のTrimSpace対称化 | `session_manager_env.go:191` | ✅ 可能 | 1行変更。S-2と同時修正可能 |
| S-2 | 🔵 Suggestion | 重複コメントの短縮 | `session_manager_env.go:191-192` | ✅ 可能 | S-1と同時修正可能 |
| S-3 | 🔵 Suggestion | TrimSpaceの二重呼び出し解消 | `command_router_handlers_pane.go:49,68` | ⚠️ 注意 | I-1, I-2と同じファイル。同時修正は可能だが、コンフリクトに注意 |
| S-4 | 🔵 Suggestion | フォールバック発生ログ追加 | `command_router_handlers_pane.go:50付近` | ⚠️ 注意 | I-2と同位置への変更。I-1, I-2と一括修正推奨 |
| S-5 | 🔵 Suggestion | テストのテーブル駆動化 | `session_manager_env_test.go:385-415` | ✅ 可能 | I-3, I-4と一括リファクタ推奨 |
| S-6 | 🔵 Suggestion | nilガード過剰チェックの簡略化 | `command_router_handlers_pane.go:36-38` | ✅ 可能 | 防御的コーディングとして残しても可 |

### 推奨作業グループ（並列実行可能な単位）

| グループ | タスク | 対象ファイル | 理由 |
|---------|--------|-------------|------|
| **A** | I-1 + I-2 + S-3 + S-4 | `command_router_handlers_pane.go` | 同一ファイル内の関連変更。まとめて修正 |
| **B** | I-3 + I-4 + S-5 | `session_manager_env_test.go` | テストリファクタリング。まとめて対応 |
| **C** | S-1 + S-2 | `session_manager_env.go` | 同一ファイル内の軽微修正 |
| **D** | C-1 | 新規テストファイル | 独立して作成可能。最優先 |
| **E** | S-6 | `command_router_handlers_pane.go` | 任意。グループAに含めても良い |

> **グループA, B, C, Dはすべて並列作業可能**です。グループEはグループAと同一ファイルのためコンフリクト注意。

---

## Recommended Action

1. **最優先**: C-1（`splitWindowResolved`フォールバックのテスト作成）
2. **次に**: グループA（I-1 + I-2 + S-3 + S-4）とグループB（I-3 + I-4 + S-5）を並列で修正
3. **任意**: グループC（S-1 + S-2）、グループE（S-6）
4. 修正後にレビューを再実行して検証
