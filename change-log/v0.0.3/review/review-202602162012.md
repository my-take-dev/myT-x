# PR Review Summary — 202602162012

## レビュー対象

### 変更ファイル (myT-x 配下)
| カテゴリ | ファイル | 状態 |
|---------|---------|------|
| Single Instance | `main.go` | 変更 |
| Single Instance | `internal/singleinstance/lock_windows.go` | 新規 |
| Single Instance | `internal/singleinstance/lock_other.go` | 新規 |
| Single Instance | `internal/singleinstance/lock_windows_test.go` | 新規 |
| Window Activation | `app_lifecycle.go` | 変更 |
| Window Activation | `app_events.go` | 変更 |
| Tmux Router | `internal/tmux/command_router.go` | 変更 |
| Tmux Router | `internal/tmux/command_router_handlers_window.go` | 新規 |
| Tmux Router | `internal/tmux/command_router_handlers_window_test.go` | 新規 |
| Pane WorkDir | `internal/tmux/command_router_handlers_pane.go` | 変更 |
| Pane WorkDir | `internal/tmux/session_manager_env.go` | 変更 |
| Pane WorkDir | `internal/tmux/session_manager_env_test.go` | 変更 |
| Pane WorkDir | `internal/tmux/command_router_handlers_pane_test.go` | 新規 |
| Frontend | `frontend/src/hooks/useFileDrop.ts` | 変更 |
| Test Guard | `app_snapshot_delta_test.go` | 変更 |

### レビュー観点（並列実行）
1. **code-reviewer**: コード品質・設計・プロジェクト規約準拠
2. **silent-failure-hunter**: サイレントエラー・ログ漏れ
3. **pr-test-analyzer**: テストカバレッジ・テスト品質
4. **code-simplifier**: DRY・簡素化・可読性
5. **comment-analyzer**: コメント・ドキュメント品質

---

## Critical Issues (1件)

### C-1. `useFileDrop.ts` — PowerShell `$` / バッククォート エスケープ除去

**ファイル**: `frontend/src/hooks/useFileDrop.ts` L6-L10

変更前は `$` と `` ` `` をエスケープしていたが、変更後は除去されている。`SendInput` → `pane.Terminal.Write` の経路でバイト列がそのまま端末に書き込まれる。

- **PowerShell端末**: `$` はダブルクォート内で変数展開される。ファイル名 `C:\Users\$admin\file.txt` は `$admin` が変数として解釈される。Windowsフォルダ名に `$` は**使用可能**（例: `C:\$Recycle.Bin`、管理共有 `C$`）
- **PowerShell端末**: `` ` `` はエスケープ文字。`` `n `` は改行、`` `0 `` はヌル文字に展開される。Windowsフォルダ名にバッククォートも**使用可能**
- `\` のエスケープ除去はWindows パスに対して正しい修正

**修正案**:
```typescript
function quotePathForShell(path: string): string {
  // Windows: \ はパス区切り文字でありエスケープ不要
  // Windowsファイル名に " は使用不可のためエスケープ不要
  // PowerShell: $ は変数展開、` はエスケープ文字のため退避が必要
  const escaped = path.replace(/[`$]/g, "`$&");
  return `"${escaped}"`;
}
```

---

## Important Issues (8件)

### I-1. `app_events.go` — `emitBackendEvent` の nil context サイレントドロップ

**ファイル**: `app_events.go` L33-35

```go
if a.runtimeContext() == nil {
    return  // ← ログ無しで全イベントを破棄
}
```

`emitRuntimeEventWithContext` では nil 時に `slog.Warn` でログを出しているのに、`emitBackendEvent` ではサイレント。IPC経由の `activate-window` が完全に無視される経路を含む。

**修正案**: Warn ログ追加:
```go
if a.runtimeContext() == nil {
    slog.Warn("[DEBUG-EVENT] backend event dropped: runtime context nil", "event", name)
    return
}
```

**補足**: pipeサーバーが `startup` 内で開始されるため、pipeサーバー動作中は `runtimeContext` は設定済み。実際には到達困難だが、デバッグ容易性のためにログを残すべき。

### I-2. `main.go` — `mutexLock.Release()` のエラー破棄

**ファイル**: `main.go` L37

```go
defer mutexLock.Release()  // ← error を無視
```

**修正案**:
```go
defer func() {
    if err := mutexLock.Release(); err != nil {
        slog.Warn("[DEBUG-SINGLE] mutex release failed", "error", err)
    }
}()
```

### I-3. `main.go` — `wails.Run` エラーの `println` 出力

**ファイル**: `main.go` L60-62

```go
if err != nil {
    println("Error:", err.Error())
}
```

プロジェクト全体が `slog` を使用しているのに、最も致命的なエラーが `println`。

**修正案**: `slog.Error` に変更。

### I-4. `app_lifecycle.go` — `bringWindowToFront` のサイレント nil リターン

**ファイル**: `app_lifecycle.go` L356-358

ctx nil 時にログ無しでリターン。IPC経由でactivate-windowを受信した操作がサイレントに失敗する。

**修正案**: `slog.Warn` 追加。

### I-5. `command_router_handlers_window.go` — ログレベル不整合

**ファイル**: `internal/tmux/command_router_handlers_window.go` L13

```go
slog.Info("[DEBUG-IPC] activate-window command received")
```

プロジェクト規約では `[DEBUG-*]` プレフィックスは `slog.Debug` とペアにすべき。

**修正案**: `slog.Debug` に変更。

### I-6. `command_router_handlers_window_test.go` — `Stdout` の検証漏れ

**ファイル**: `internal/tmux/command_router_handlers_window_test.go` L56-58

ハンドラは `Stdout: "ok\n"` を返すがテストで検証していない。

**修正案**: `resp.Stdout` の検証を追加。

### I-7. `sanitizeUsername` の重複実装

**ファイル**: `internal/singleinstance/lock_windows.go` L62-68 と `internal/ipc/protocol.go`

2つのパッケージで `sanitizeUsername` が独立に定義。パターン自体は同一 (`[^a-zA-Z0-9._-]+`) だが、一方を変更した際の追従忘れリスクがある。

**推奨**: テストで両方の正規表現パターンが同一であることを検証するか、`internal/userutil` パッケージに切り出す。

### I-8. `app_lifecycle.go` — ウィンドウ前面化ロジックのDRY違反

**ファイル**: `app_lifecycle.go` L383-387 と L410-413

`bringWindowToFront` と `toggleQuakeWindow` (show分岐) に同一の4行パターン:
```go
runtimeWindowShowFn(ctx)
runtimeWindowUnminimiseFn(ctx)
runtimeWindowSetAlwaysOnTopFn(ctx, true)
runtimeWindowSetAlwaysOnTopFn(ctx, false)
```

**修正案**: `raiseWindow(ctx)` ヘルパーに抽出して共通化。

---

## Suggestions (12件)

### S-1. `lock_other.go` — non-Windows で `TryLock("")` がサイレント成功

**ファイル**: `internal/singleinstance/lock_other.go` L13

Windows版では空文字でエラーを返すが、non-Windows版は常に成功。API契約の不一致。

**推奨**: コメントで明記。

### S-2. パイプサーバー未起動時の `ipc.Send` タイムアウト

**ファイル**: `main.go` L25-27

第2インスタンスが素早くダブルクリックで起動した場合、pipeサーバー未起動で3秒タイムアウトし、ウィンドウが前面に来ないまま終了する。

**推奨**: リトライ（1回、500ms後）の検討、またはログメッセージの改善。

### S-3. `bringWindowToFront` のCASガード未使用

**ファイル**: `app_lifecycle.go` L354-364

`toggleQuakeWindow` は `windowToggling` CASガードを使っているが、`bringWindowToFront` にはない。Wails runtime関数がGUIスレッドにdispatchされるため実害はないが、設計一貫性の観点。

### S-4. `splitWindowResolved` — workdir未解決時のログレベル

**ファイル**: `internal/tmux/command_router_handlers_pane.go` L63-67

workDir未解決でも `attachTerminal` がホストcwdにフォールバックして正常動作する。`slog.Warn` ではなく `slog.Debug` が適切。

### S-5. 二重 `TrimSpace` の冗長性

**ファイル**: `session_manager_env.go` L193 と `command_router_handlers_pane.go` L53

`GetPaneContextSnapshot` がtrim済みの値を返すため、`splitWindowResolved` での再trimは冗長。防御的コーディングとして許容範囲。

### S-6. 統合テストに worktree フォールバックケースが不足

**ファイル**: `internal/tmux/command_router_handlers_pane_test.go`

`TestSplitWindowWorkDirFallback` は `SetRootPath` 経由のフォールバックのみ。worktreeパスが設定されたケースの統合テストがない。

### S-7. `rootPathUnset` + `workDirOmitted` のテストケース欠如

**ファイル**: `internal/tmux/command_router_handlers_pane_test.go`

「セッション作成直後にGUIからsplit-windowを実行」するシナリオ（最も一般的なユーザーパス）が未テスト。

### S-8. `command_router_handlers_window_test.go` — テストケース不足

**ファイル**: `internal/tmux/command_router_handlers_window_test.go`

正常系1件のみ。emitter nil時のpanic未保護確認、イベントpayload (`nil`) の検証がない。

### S-9. `TryLock` のハンドル解放コード重複

**ファイル**: `internal/singleinstance/lock_windows.go` L37-49

`if h != 0 { windows.CloseHandle(h) }` が2つのエラー分岐に重複。統合可能。

### S-10. ハンドラーマップのアライメント不整合

**ファイル**: `internal/tmux/command_router.go` L128-130

`display-message` と `activate-window` のみダブルスペースで他とアライメントが不統一。

### S-11. `useFileDrop.ts` — Wails API由来の安全性コメント追記

**ファイル**: `frontend/src/hooks/useFileDrop.ts` L8-9

「Windowsファイル名に " は使用不可」の根拠として、Wails OnFileDrop がOS APIからパスを取得する旨を追記。

### S-12. `lock_windows_test.go` — 並行ロック取得テスト欠如

**ファイル**: `internal/singleinstance/lock_windows_test.go`

同一プロセス内の同一ゴルーチンでのテストのみ。並行ゴルーチンからの同時 `TryLock` でpanicしないことの確認が有用。

---

## Strengths（良い点）

1. **防御的起動設計**: mutex取得失敗時もアプリ起動を継続する設計がプロジェクト仕様に準拠
2. **`Release()` のnil安全・冪等性**: nilレシーバ安全かつ冪等で `defer` 安心設計
3. **CreateMutex ハンドルリーク防止**: `ERROR_ALREADY_EXISTS` 時の重複ハンドルを適切にClose
4. **テスト網羅性（lock_windows_test.go）**: 6パターンのTryLock + sanitize + DefaultMutexName
5. **テスト網羅性（session_manager_env_test.go）**: 8パターンのSessionWorkDir解決テスト
6. **統合テスト設計**: `router.Execute()` を通じた公開APIレベルテスト
7. **スレッドセーフなスナップショット**: `RLock` + deep copy でロック安全
8. **疎結合設計**: IPC→イベント→ウィンドウ操作の責任分離
9. **デバッグログの命名一貫性**: `[DEBUG-SINGLE]`, `[DEBUG-SPLIT]` で機能域分離
10. **tmux-shim仕様準拠**: send-keys失敗をWarnログしつつpane作成は維持

---

## Recommended Action

### 1. Critical修正（必須）
- C-1: `useFileDrop.ts` の `$` / `` ` `` エスケープ復元

### 2. Important修正（推奨）
- I-1〜I-8 をそれぞれ対応

### 3. Suggestion対応（任意）
- S-1〜S-12 は任意対応

### 4. 再レビュー
- Critical/Important修正後に対象箇所のみ再レビュー

---

## タスク整理・並列作業可否表

以下は各修正タスクの一覧と、並列作業の可否を整理した表です。
「並列可」のタスクは、他のタスクと依存関係がなく同時に作業しても問題ありません。

| # | タスク | ファイル | 分類 | 並列可 | 依存関係 | 備考 |
|---|--------|---------|------|--------|---------|------|
| T-1 | `$` / `` ` `` エスケープ復元 | `useFileDrop.ts` | Critical | ✅ 可 | なし | フロントエンド単独変更 |
| T-2 | `emitBackendEvent` nil context ログ追加 | `app_events.go` | Important | ✅ 可 | なし | 1行追加のみ |
| T-3 | `mutexLock.Release()` エラーログ追加 | `main.go` | Important | ✅ 可 | なし | `main.go` 単独変更 |
| T-4 | `wails.Run` エラーを `slog.Error` に変更 | `main.go` | Important | ⚠️ T-3と同一ファイル | T-3 | `main.go` の2箇所修正をまとめて実施推奨 |
| T-5 | `bringWindowToFront` nil context ログ追加 | `app_lifecycle.go` | Important | ✅ 可 | なし | 1行追加のみ |
| T-6 | `slog.Info` → `slog.Debug` 修正 | `handlers_window.go` | Important | ✅ 可 | なし | 1行変更のみ |
| T-7 | `Stdout` 検証追加 | `handlers_window_test.go` | Important | ✅ 可 | なし | テスト追加のみ |
| T-8 | `sanitizeUsername` 重複解消 or テスト保護 | `lock_windows.go` / `ipc` | Important | ✅ 可 | なし | パッケージ横断だが独立 |
| T-9 | `raiseWindow` ヘルパー抽出 | `app_lifecycle.go` | Important | ⚠️ T-5と同一ファイル | T-5 | `app_lifecycle.go` の修正をまとめて実施推奨 |
| T-10 | workdir未解決ログを `Debug` に変更 | `handlers_pane.go` | Suggestion | ✅ 可 | なし | 1行変更のみ |
| T-11 | ハンドラーマップ アライメント修正 | `command_router.go` | Suggestion | ✅ 可 | なし | フォーマットのみ |
| T-12 | テスト追加: `rootPathUnset + workDirOmitted` | `handlers_pane_test.go` | Suggestion | ✅ 可 | なし | テスト追加のみ |
| T-13 | テスト追加: worktreeフォールバック統合 | `handlers_pane_test.go` | Suggestion | ⚠️ T-12と同一ファイル | T-12 | まとめて実施推奨 |
| T-14 | テスト追加: window handler異常系 | `handlers_window_test.go` | Suggestion | ⚠️ T-7と同一ファイル | T-7 | まとめて実施推奨 |

### 並列作業グループ

以下のグループは**同時に着手しても安全**です：

| グループ | タスク | 対象ファイル |
|---------|--------|------------|
| **A** | T-1 | `useFileDrop.ts` |
| **B** | T-2 | `app_events.go` |
| **C** | T-3 + T-4 | `main.go` |
| **D** | T-5 + T-9 | `app_lifecycle.go` |
| **E** | T-6 | `handlers_window.go` |
| **F** | T-7 + T-14 | `handlers_window_test.go` |
| **G** | T-8 | `lock_windows.go` / `ipc` |
| **H** | T-10 | `handlers_pane.go` |
| **I** | T-11 | `command_router.go` |
| **J** | T-12 + T-13 | `handlers_pane_test.go` |

**全10グループが並列実行可能です。** 各グループ内のタスクは同一ファイルのため順次実施してください。
