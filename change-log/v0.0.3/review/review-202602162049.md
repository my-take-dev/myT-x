# PR Review Summary — 2026-02-16 20:49

## レビュー対象

コミット前の myT-x/ 配下の全変更ファイル（git diff HEAD）

### 変更ファイル一覧

| カテゴリ | ファイル | 概要 |
|---------|---------|------|
| App Events | `myT-x/app_events.go` | `emitBackendEvent` に activate-window 分岐追加、ctx 再利用最適化 |
| App Events | `myT-x/app_events_test.go` | nil context 時の警告ログテスト追加 |
| App Lifecycle | `myT-x/app_lifecycle.go` | `bringWindowToFront` / `raiseWindow` 追加、`toggleQuakeWindow` リファクタリング |
| App Lifecycle | `myT-x/app_lifecycle_test.go` | `bringWindowToFront` nil context テスト追加 |
| Entry Point | `myT-x/main.go` | single-instance mutex チェック + IPC activation signal |
| IPC | `myT-x/internal/ipc/protocol.go` | `sanitizeUsername` を `userutil` に委譲 |
| Tmux Router | `myT-x/internal/tmux/command_router.go` | `activate-window` コマンド登録 |
| Tmux Pane | `myT-x/internal/tmux/command_router_handlers_pane.go` | `splitWindowResolved` workDir フォールバック追加 |
| Session Manager | `myT-x/internal/tmux/session_manager_env.go` | `PaneContextSnapshot` に `SessionWorkDir` フィールド追加 |
| Session Manager | `myT-x/internal/tmux/session_manager_env_test.go` | `SessionWorkDir` 解決ロジックのテーブル駆動テスト追加 |
| Snapshot Delta | `myT-x/app_snapshot_delta_test.go` | `PaneContextSnapshot` フィールド数ガード 5→6 更新 |
| Frontend | `myT-x/frontend/src/hooks/useFileDrop.ts` | シェルエスケープ変更（bash→PowerShell方式） |

### レビューエージェント構成

| エージェント | 担当範囲 |
|------------|---------|
| code-reviewer (Events/Lifecycle) | app_events.go, app_lifecycle.go + tests |
| code-reviewer (IPC/Tmux) | ipc/protocol.go, tmux/command_router*.go, session_manager_env*.go |
| code-reviewer (main.go) | main.go, singleinstance パッケージ |
| security-reviewer (Frontend) | useFileDrop.ts エンコーディング・シェルインジェクション |
| test-analyzer | 全テストファイルのカバレッジ分析 |
| silent-failure-hunter | 全変更のサイレント失敗・簡素化分析 |

---

## Critical Issues (2件)

### C-1: [useFileDrop.ts] ファイルエンコーディング破損（文字化け）
**ファイル**: `myT-x/frontend/src/hooks/useFileDrop.ts`

日本語コメントが全て文字化け状態（Shift_JIS バイト列を UTF-8 として解釈した mojibake）。

```
// 現在（壊れている）:
/** 繝輔ぃ繧､繝ｫ繝代せ繧偵す繧ｧ繝ｫ螳牙・縺ｫ繧ｯ繧ｩ繝ｼ繝医☆繧・*/

// 本来あるべき内容:
/** ファイルパスをシェル安全にクォートする */
```

CLAUDE.md の「UTF-8 BOM無し」要件に違反。全コメントが可読性を完全に失っている。
Git履歴から元のコメントを復元し、UTF-8 で再保存する必要がある。

### C-2: [テスト] `splitWindowResolved` workDir フォールバックのテストが存在しない
**ファイル**: `myT-x/internal/tmux/command_router_handlers_pane.go:48-65`

本PRの主要機能である `splitWindowResolved` 内の `SessionWorkDir` フォールバック処理にテストが一切ない。以下のシナリオが未検証：
1. `workDir` 空文字 → `SessionWorkDir` が使われる
2. `workDir` 空白のみ → `SessionWorkDir` が使われる
3. `workDir` 明示指定 → `SessionWorkDir` で上書きされない
4. `workDir` も `SessionWorkDir` も空の場合

`command_router_handlers_pane_test.go` が存在せず、GUI分割パスのワークディレクトリ解決を保証するテストが完全に欠如。

---

## Important Issues (9件)

### I-1: [main.go:67] wails.Run エラーのログタグが不適切
**ファイル**: `myT-x/main.go:67`

```go
slog.Error("[DEBUG-SINGLE] wails run failed", "error", err)
```

`[DEBUG-SINGLE]` は single-instance 制御用のデバッグタグだが、`wails.Run` の失敗はそれとは無関係。将来デバッグログを一括削除する際に `[DEBUG-SINGLE]` で grep すると、この恒久的に必要なエラーログまで削除される。

**修正案**: `slog.Error("wails run failed", "error", err)`

### I-2: [テスト] `emitBackendEvent("app:activate-window")` 正常系テストが欠落
**ファイル**: `myT-x/app_events_test.go`

nil context のテストは存在するが、正常系（context 有効時）に `bringWindowToFront()` が呼ばれることの検証がない。新規コードパスであり、テーブル駆動テストで網羅すべき。

### I-3: [テスト] `bringWindowToFront` 正常系テストがない
**ファイル**: `myT-x/app_lifecycle_test.go`

`TestBringWindowToFrontSkipsWhenContextNil` は nil ガードのみ検証。ctx 非 nil で以下が呼ばれることの検証が不足：
- `raiseWindow(ctx)` の呼出（Show → Unminimise → AlwaysOnTop(true) → AlwaysOnTop(false)）
- `setWindowVisible(true)` の呼出

### I-4: [テスト] `TestBringWindowToFrontSkipsWhenContextNil` で状態非変更が未検証
**ファイル**: `myT-x/app_lifecycle_test.go`

テストはログ出力のみ検証しているが、`windowVisible` が変更されないことも確認すべき。

```go
// 推奨追加:
app.windowMu.Lock()
vis := app.windowVisible
app.windowMu.Unlock()
if vis {
    t.Fatal("windowVisible should remain false when context is nil")
}
```

### I-5: [テスト] `raiseWindow` 呼出順序テストがない
**ファイル**: `myT-x/app_lifecycle.go:298-303`

`raiseWindow` は Show → Unminimise → AlwaysOnTop(true) → AlwaysOnTop(false) の4ステップで構成されるが、順序を検証するテストがない。AlwaysOnTop true→false のフォーカス奪取パターンが正しく機能することの回帰保護が必要。

### I-6: [テスト] `TestEmitBackendEventSkipsNilRuntimeContextWithWarning` でグローバル関数変数が未復元
**ファイル**: `myT-x/app_events_test.go`

`runtimeEventsEmitFn` やWindow系グローバル関数をオーバーライドしていない。現状は nil context で早期 return するので実害はないが、将来のリファクタリングで nil チェック順序が変わった場合にパニックする可能性。

**推奨**: `t.Cleanup(restoreShimLifecycleHooks)` を追加しWindow関数をスタブ化。

### I-7: [session_manager_env.go] `SetRootPath` の書込み時正規化不一致
**ファイル**: `myT-x/internal/tmux/session_manager_env.go`

`SetWorktreeInfo` は全フィールドを TrimSpace して格納するが、`SetRootPath` は入力をそのまま格納。`GetPaneContextSnapshot` の read-side trim が補償しているため現時点では実害なし。ただし将来 `RootPath` を直接参照するコードが増えた場合にバグの温床になる。

### I-8: [useFileDrop.ts:9] cmd.exe 使用時のエスケープ不足
**ファイル**: `myT-x/frontend/src/hooks/useFileDrop.ts:9`

現在のエスケープ (`$ `) はPowerShellのダブルクォート内でのみ正しい。
- `cmd.exe`: `%VAR%` がダブルクォート内でも展開される
- `bash.exe`/`wsl.exe`: `$VAR` がダブルクォート内で展開される

SendInput → WriteToPaneでConPTYに生バイト列として書き込まれるため、シェルのコマンドラインに直接タイプされるのと同等。

**緩和要因**: Wails OnFileDrop が提供するパスは OS 由来の正規パスであり、`$` や `%` を含む実ファイルパスは稀。

**改善案**: シェル種別に応じたエスケープ、または設計判断をコメントで明記。

### I-9: [lock_windows_test.go:41] テストで `errors.Is` ではなく `==` を使用
**ファイル**: `myT-x/internal/singleinstance/lock_windows_test.go:41`

main.go では `errors.Is(err, singleinstance.ErrAlreadyRunning)` を正しく使用。テスト側は `!=` による直接比較。将来 `TryLock` がエラーをラップした場合にテストが壊れる。

---

## Suggestions (13件)

### S-1: [app_lifecycle.go] `raiseWindow` に ctx nil ガード追加
`raiseWindow` は内部関数で呼び出し元が事前検証済みだが、defensive-coding-checklist に従えば nil ガードがあった方が安全。

### S-2: [app_events.go:38] `"app:activate-window"` のイベント名定数化
他のイベント名と同様に定数化を検討。現時点で1箇所のみなので低優先度。

### S-3: [command_router_handlers_pane.go:52] 二重 TrimSpace は防御的だが冗長
`GetPaneContextSnapshot` が TrimSpace 済みの `SessionWorkDir` を返すため、`splitWindowResolved` の再トリムは冗長。意図的であればコメントで明示推奨。

### S-4: [ipc/protocol.go, lock_windows.go] ローカルラッパー `sanitizeUsername` 関数の必要性
ワンライナーのラッパーが両パッケージに残存。直接 `userutil.SanitizeUsername()` を呼ぶ方が簡潔。統一的な呼出名を意図しているなら現状維持で可。

### S-5: [lock_windows.go, protocol.go] ユーザー名取得ロジックの重複
`DefaultMutexName()` と `DefaultPipeName()` で同一の USERNAME 解決ロジックが重複。`userutil.ResolveCurrentUsername()` への切り出しで DRY 化可能。

### S-6: [main.go:30] `ipc.Send("", ...)` の空文字列セマンティクス明示
動作的に正しい（DefaultPipeName にフォールバック）が、`ipc.DefaultPipeName()` を明示渡しするか、コメントで意図を記述する方が可読性向上。

### S-7: [main.go:22-31] 第2インスタンスの終了コード
`return` で静かに終了するが activation 成功/失敗で終了コードを分けることを将来検討。

### S-8: [lock_windows.go:75] `Global\` プレフィックスの意図コメント追加
RDP セッション間でも単一インスタンスを強制する理由（WebView2 IME 状態破損防止）をコメントで明記推奨。

### S-9: [useFileDrop.ts:9] 正規表現パターンの意図明示
変換例を示すコメント追加で可読性向上。例: `// ` → `` , $ → `$ (PowerShell double-quote escaping)`

### S-10: [app_lifecycle.go:369-372] AlwaysOnTop true→false トリックの理由コメント
なぜ `SetAlwaysOnTop(true)` の後に `SetAlwaysOnTop(false)` を呼ぶのか、ウィンドウフォーカス強制テクニックの意図をコメントで明記推奨。

### S-11: [テスト] `TestGetPaneContextSnapshot` 既存テストに `SessionWorkDir` アサーション追加
既存テストはフィールド追加前のもので `SessionWorkDir` を一切チェックしていない。明示的な `""` アサーション追加推奨。

### S-12: [テスト] `SessionWorkDir` 変化時の snapshot delta 検出テスト追加
フィールド数ガードテストは更新済みだが、`SessionWorkDir` が変化したときに delta が正しく生成されるかの直接検証テストがない。

### S-13: [テスト] `main()` single-instance 統合テスト
ロジックをヘルパー関数に切り出せばテスト可能。現在の `main()` はテスト困難。

---

## Positive Observations (良い点)

1. **TOCTOU 競合の適切な回避**: `emitBackendEvent` で ctx をキャプチャし再利用する変更は正しい。旧コードのシャットダウンタイミング問題を解消。

2. **`bringWindowToFront` の防御的二重 nil チェック**: シャットダウンと IPC リクエストの競合に対応。将来他箇所からの呼出にも安全。

3. **`raiseWindow` 抽出リファクタリング**: DRY原則に従い、`toggleQuakeWindow` と `bringWindowToFront` の共通ロジックを集約。

4. **`activate-window` のエンドツーエンド統合が完全**: ルーター登録 → ハンドラー → イベント処理 → main.go IPC の連携が正確。nilEmitter テストも含む。

5. **`userutil.SanitizeUsername` 共通化**: ipc と singleinstance の正規表現パターンを一元化。動作変更なしの安全なリファクタリング。

6. **`SessionWorkDir` 解決ロジックの正確性**: Worktree.Path 優先 → RootPath フォールバック → 空文字。RLock 下の安全なアクセス。

7. **テストカバレッジの網羅性**: `TestGetPaneContextSnapshotSessionWorkDir` は8パターン、`singleinstance` は6パターンのテーブル駆動テスト。

8. **フィールド数ガードテストの即時更新**: CLAUDE.md 規約準拠。

9. **デバッグログの `[DEBUG-XXX]` 命名規約準拠**: 一括削除時の grep 容易性を確保。

10. **Windows ミューテックスパターンの堅実な実装**: ハンドルリーク防止が全パスで正確。`Release()` の nil-safe・冪等設計。

11. **防御的 main()**: mutex 取得失敗でもアプリ起動を継続。CLAUDE.md の「エラーで動作を止めない」方針に忠実。

12. **`splitWindowResolved` のロールバック処理**: `attachTerminal` 失敗時のペイン削除と失敗時のエラーラップが適切。

---

## タスク一覧と並列修正可否

以下のタスクは作業者が効率的に修正できるよう、並列作業の可否を整理した表です。

### 凡例
- **並列可**: 他のタスクと独立して同時に修正可能
- **並列不可**: 他のタスクの完了を待つ必要がある、または同一ファイルへの競合変更がある

| # | 重要度 | タスク | ファイル | 並列修正 | 依存関係・備考 |
|---|--------|--------|---------|---------|--------------|
| **C-1** | 🔴 Critical | useFileDrop.ts の文字化けを UTF-8 で復元 | `frontend/src/hooks/useFileDrop.ts` | ✅ 並列可 | 単独ファイル。I-8 と同一ファイルだが修正箇所が異なる（コメント vs ロジック）ので並列可 |
| **C-2** | 🔴 Critical | `splitWindowResolved` workDir フォールバックのテスト作成 | `internal/tmux/command_router_handlers_pane_test.go` (新規) | ✅ 並列可 | 新規テストファイル作成。他の変更と独立 |
| **I-1** | 🟡 Important | main.go の wails.Run エラーログタグ修正 | `main.go` | ✅ 並列可 | 1行修正。他タスクと独立 |
| **I-2** | 🟡 Important | `emitBackendEvent("app:activate-window")` 正常系テスト追加 | `app_events_test.go` | ⚠️ I-6と同一ファイル | I-6 と同一ファイルへの追記。順次作業または事前にマージ計画が必要 |
| **I-3** | 🟡 Important | `bringWindowToFront` 正常系テスト追加 | `app_lifecycle_test.go` | ⚠️ I-4, I-5と同一ファイル | I-4, I-5 と同一ファイル。これら3件をまとめて実施推奨 |
| **I-4** | 🟡 Important | `TestBringWindowToFrontSkipsWhenContextNil` 状態非変更アサーション追加 | `app_lifecycle_test.go` | ⚠️ I-3, I-5と同一ファイル | I-3 とまとめて実施推奨 |
| **I-5** | 🟡 Important | `raiseWindow` 呼出順序テスト追加 | `app_lifecycle_test.go` | ⚠️ I-3, I-4と同一ファイル | I-3 とまとめて実施推奨 |
| **I-6** | 🟡 Important | `TestEmitBackendEventSkipsNilRuntimeContextWithWarning` にグローバル関数復元追加 | `app_events_test.go` | ⚠️ I-2と同一ファイル | I-2 とまとめて実施推奨 |
| **I-7** | 🟡 Important | `SetRootPath` で write-side normalization 追加 | `internal/tmux/session_manager_env.go` | ✅ 並列可 | 他タスクと独立 |
| **I-8** | 🟡 Important | cmd.exe/bash 対応のエスケープ検討・コメント追記 | `frontend/src/hooks/useFileDrop.ts` | ✅ 並列可 | C-1 と同一ファイルだが修正箇所が異なるので並列可 |
| **I-9** | 🟡 Important | lock_windows_test.go で `errors.Is` に統一 | `internal/singleinstance/lock_windows_test.go` | ✅ 並列可 | 単独ファイル。他タスクと独立 |

### 推奨並列作業グループ

効率的に修正するために、以下のグループに分けて並列作業可能です：

| グループ | 含むタスク | 作業者 | 主な対象ファイル |
|---------|----------|-------|----------------|
| **A: Frontend修正** | C-1, I-8 | 1名 | `useFileDrop.ts` |
| **B: Tmuxテスト追加** | C-2, I-7 | 1名 | `command_router_handlers_pane_test.go`, `session_manager_env.go` |
| **C: App Events テスト強化** | I-2, I-6 | 1名 | `app_events_test.go` |
| **D: App Lifecycle テスト強化** | I-3, I-4, I-5 | 1名 | `app_lifecycle_test.go` |
| **E: 単独修正（並列可）** | I-1, I-9 | 1名 | `main.go`, `lock_windows_test.go` |

**グループ A〜E は全て並列実施可能です。**

---

## Recommended Action

1. **最優先**: C-1（文字化け復元）と C-2（テスト作成）を修正
2. **次優先**: I-1〜I-9 の Important issues を上記グループ単位で修正
3. **その後**: S-1〜S-13 の Suggestions を検討
4. **修正後**: 再レビュー実施で修正確認
