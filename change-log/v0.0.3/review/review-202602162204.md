# PR Review Summary — 2026/02/16 22:04

## 概要

スナップショット発行のデバウンス/コアレス化、`OutputFlushManager` への統合、ロック分離、タイマーリーク修正、SessionManager の世代管理（generation tracking）、フロントエンドの `memo()` / `useMemo` / RAF バッチング導入を含む、パフォーマンスと安定性に関する大規模な改善差分（30ファイル、855行追加 / 208行削除）。

## 変更ファイル一覧

| カテゴリ | ファイル | 変更行数 |
|---------|--------|---------|
| App層 Go | app.go, app_config_state.go, app_events.go, app_events_test.go, app_lifecycle.go, app_lifecycle_test.go, app_pane_api_test.go, app_pane_feed.go, app_session_api.go, app_session_api_test.go, app_snapshot_delta.go, app_snapshot_metrics.go, app_snapshot_metrics_test.go, app_worktree_api.go | 14ファイル |
| Internal tmux層 | command_router.go, command_router_handlers_pane.go, command_router_handlers_session.go, session_manager.go, session_manager_env.go, session_manager_idle.go, session_manager_pane_io.go, session_manager_pane_lifecycle.go, session_manager_panes.go, session_manager_sessions.go, session_manager_snapshot.go, session_manager_test.go | 12ファイル |
| Frontend | LayoutNodeView.tsx, StatusBar.tsx, TerminalPane.tsx, usePrefixKeyMode.ts | 4ファイル |

---

## Critical Issues (0件)

Critical な問題は検出されませんでした。

---

## Important Issues (8件)

### I-1: `snapshotDelta` のアンロック/リロックパターンにおけるTOCTOU競合リスク

- **カテゴリ**: Race Condition
- **ファイル**: [app_snapshot_delta.go](myT-x/app_snapshot_delta.go) `snapshotDelta()`
- **説明**: `snapshotMu` をアンロックしてdelta計算を行い、再度ロックしてキャッシュを更新するパターン。2つのgoroutineが同時に呼び出した場合、同一の `previous` を読み取り、lost update が発生しうる。
- **軽減要因**: `requestSnapshot` の generation メカニズムにより、同時に2つの `emitSnapshot()` が並行実行されるケースは極めて稀。
- **推奨**: コメントで「この関数は並行呼び出しを想定していない。requestSnapshot の generation メカニズムにより排他が保証される」旨を明記する。

### I-2: `estimateSnapshotPayloadBytes` のカウンタ読み取りのTOCTOU

- **カテゴリ**: Race Condition
- **ファイル**: [app_snapshot_metrics.go](myT-x/app_snapshot_metrics.go) `estimateSnapshotPayloadBytes()`
- **説明**: `eventCount` を読み取った後にロックを解放するため、「8回に1回サンプリング」は厳密には保証されない。ただしメトリクス用途であり厳密な精度は不要。
- **推奨**: コメントで意図を明示。`-1` のセンチネル値の意味もドキュメント化。

### I-3: `getConfigReadOnly()` の安全性（浅いコピー）

- **カテゴリ**: Design / Bug Risk
- **ファイル**: [app_config_state.go](myT-x/app_config_state.go) `getConfigReadOnly()`
- **説明**: `config.Config` 内の map/slice は浅いコピーのため、呼び出し元が誤って変更すると `a.cfg` の内部状態を破壊する可能性。現在の呼び出し元は全て読み取り専用で安全だが、将来のリスクがある。
- **推奨**: docコメントに `// Callers must not retain or mutate the returned value.` を補強。

### I-4: シャットダウン後の `flushSnapshotRequest` タイマー発火の可能性

- **カテゴリ**: Bug（軽微）
- **ファイル**: [app_events.go](myT-x/app_events.go) `requestSnapshot()` / [app_lifecycle.go](myT-x/app_lifecycle.go) `shutdown()`
- **説明**: `time.AfterFunc` のコールバックが既にスケジュール済みの場合、`Stop()` は実行を阻止できない（Go仕様）。shutdown後に `flushSnapshotRequest()` が実行される可能性がある。
- **軽減要因**: `emitSnapshot()` 内で `runtimeContext() == nil` チェックあり。generation リセットにより emit もスキップされる。
- **推奨**: `flushSnapshotRequest()` 冒頭に `runtimeContext() == nil` チェックを追加すると意図が明確。

### I-5: `Snapshot()` のAPI契約変更（キャッシュ共有参照）

- **カテゴリ**: API Design
- **ファイル**: [session_manager_snapshot.go](myT-x/internal/tmux/session_manager_snapshot.go) `Snapshot()`
- **説明**: コメントは `"returns deep-copied frontend-safe session state"` と記載しているが、キャッシュヒット時は同じスライス参照を複数の呼び出し元に返す。
- **推奨**: コメントを更新して「キャッシュ有効時は共有参照を返す。呼び出し元は返却値を変更してはならない」旨を明記。

### I-6: `IDString()` の遅延初期化のデータレース（技術的）

- **カテゴリ**: Race Condition（技術的）
- **ファイル**: [session_manager.go](myT-x/internal/tmux/session_manager.go) `IDString()`
- **説明**: `SplitPane()` と `CreateSession()` が生成時に `idString` をプリコンピュートしているため通常フローでは問題ないが、ロック外から複数goroutineが同時に呼び出した場合は技術的なデータレース。
- **軽減要因**: `-race` はプロジェクト方針で対象外。ID不変のため値の正確性には影響なし。
- **推奨**: 対応不要だが認識事項として記録。

### I-7: `ResizePane()` の不要なConPTYシステムコール

- **カテゴリ**: Performance
- **ファイル**: [session_manager_pane_io.go](myT-x/internal/tmux/session_manager_pane_io.go) `ResizePane()`
- **説明**: 寸法が変わっていなくても `pane.Terminal.Resize(cols, rows)` のsyscallが先に実行される。等価チェックを `Terminal.Resize()` の前に移動すべき。
- **推奨**:
```go
if pane.Width == cols && pane.Height == rows {
    return nil
}
if err := pane.Terminal.Resize(cols, rows); err != nil {
    return err
}
pane.Width = cols
pane.Height = rows
m.markStateMutationLocked()
return nil
```

### I-8: `SessionView` のインラインコールバックがメモ化チェーンを無効化

- **カテゴリ**: React Performance
- **ファイル**: [SessionView.tsx](myT-x/frontend/src/components/SessionView.tsx)（差分外だが影響大）
- **説明**: `SessionView` は `LayoutNodeView` に渡すコールバックを全てインラインアロー関数で定義している。`SessionView` が再レンダリングされるたびにコールバック参照が全て新規作成されるため:
  1. `LayoutNodeView` の `useMemo` が毎回再計算される
  2. `memo(TerminalPaneComponent)` のshallow comparisonが毎回failする
  3. **今回追加されたメモ化インフラの大部分が実質無効**
- **推奨**: `SessionView` の各コールバックを `useCallback` でメモ化する。これがなければ `useMemo` / `memo()` は実行時コストだけを増やす結果になる。

---

## Suggestions (17件)

### S-1: ロック順序ドキュメントに新規Mutex未追加

- **ファイル**: [app.go](myT-x/app.go)
- **説明**: `snapshotRequestMu` と `snapshotMetricsMu` がロック順序コメントの independent locks リストに記載されていない。
- **推奨**: Independent locks リストに追加。

### S-2: `requestSnapshot` の generation/dispatched → bool で簡素化可能

- **ファイル**: [app_events.go](myT-x/app_events.go)
- **説明**: `generation < dispatched` の比較は事実上「未処理リクエストの有無」を見ているだけ。`bool` フラグで十分。ただし現状でもバグは無い。
- **推奨**: 可読性改善として検討。

### S-3: `stopDetachedOutputBuffers` の命名がミスリーディング

- **ファイル**: [app_events.go](myT-x/app_events.go)
- **説明**: 実際には出力バッファの停止は行わず、pane stateエントリの削除のみ。名前がミスリーディング。
- **推奨**: `cleanupDetachedPaneStates` 等に改名。

### S-4: `shouldSyncPaneStates` が副作用を持つ述語関数

- **ファイル**: [app_events.go](myT-x/app_events.go)
- **説明**: 名前は判定のみを示唆するが、内部で `snapshotLastTopology` を更新する副作用がある。
- **推奨**: コメントで副作用の存在を明示。

### S-5: `snapshotLastTopology` を `atomic.Uint64` に変更検討

- **ファイル**: [app_events.go](myT-x/app_events.go)
- **説明**: `snapshotMu` の取得箇所を減らせる可能性。
- **推奨**: `CompareAndSwap` で更新するパターンに変更。

### S-6: `waitWithTimeout` の `time.After` が未移行

- **ファイル**: [app_lifecycle.go](myT-x/app_lifecycle.go)
- **説明**: 他箇所で `time.After` → `time.NewTimer` への移行がなされているが、ここは未移行。shutdown パスで1回のみのため実質影響なし。
- **推奨**: 一貫性のため `time.NewTimer` に統一。

### S-7: テスト内 `time.Sleep` のマージンがCI環境で不足する可能性

- **ファイル**: [app_events_test.go](myT-x/app_events_test.go), [app_pane_api_test.go](myT-x/app_pane_api_test.go)
- **説明**: `snapshotCoalesceWindow + 30ms` のマージンはCI環境で不十分になる可能性あり。
- **推奨**: マージンを 100ms 以上に拡大するか、チャネルベースの同期に切り替え。

### S-8: `killPaneLocked()` のセッション削除時の冗長な mutation tracking

- **ファイル**: [session_manager_pane_lifecycle.go](myT-x/internal/tmux/session_manager_pane_lifecycle.go)
- **説明**: セッション削除時に `sortedSessionNames = nil` + `sortedNamesDirty = true` を直接設定した上で `markTopologyMutationLocked()` も呼び出し。セッション削除は `markSessionMapMutationLocked()` に統一した方が意図が明確。
- **推奨**: セッション削除ブランチで `markSessionMapMutationLocked()` に統一。

### S-9: `paneEnvView()` の安全性契約が暗黙的

- **ファイル**: [command_router.go](myT-x/internal/tmux/command_router.go)
- **説明**: RLock解放後のmap参照を返す。`UpdatePaneEnv()` がcopy-on-writeパターンを使用するため現状安全だが、この不変条件が文書化されていない。
- **推奨**: ドキュメントに「`UpdatePaneEnv()` は必ず新規map割り当てで置換すること」を明記。

### S-10: `LayoutNodeView` と `SplitLayoutNodeView` で `useMemo` が重複

- **ファイル**: [LayoutNodeView.tsx](myT-x/frontend/src/components/LayoutNodeView.tsx)
- **説明**: 同一のactionsオブジェクトを2箇所で `useMemo` で構築。`LayoutNodeView` で作成したものを `SplitLayoutNodeView` にそのまま渡せば1つで済む。
- **推奨**: actions をpropとして子に渡す。

### S-11: StatusBar のイベントバーストでの連続APIコール

- **ファイル**: [StatusBar.tsx](myT-x/frontend/src/components/StatusBar.tsx)
- **説明**: `tmux:snapshot` と `tmux:snapshot-delta` が高頻度で連続発火すると `BuildStatusLine()` が複数回並行呼び出しされる。
- **推奨**: `requestRefresh` に50-100msのデバウンスを追加。

### S-12: `shouldBypassSnapshotDebounceForEvent` のテーブル駆動テスト未作成

- **ファイル**: [app_events_test.go](myT-x/app_events_test.go)
- **説明**: `shouldEmitSnapshotForEvent` にはテーブル駆動テストがあるが、`shouldBypassSnapshotDebounceForEvent` には無い。
- **推奨**: session-created=true, layout-changed=false 等を網羅するテーブル駆動テストを追加。

### S-13: `requestSnapshot` の nil ガードテスト未作成

- **ファイル**: [app_events_test.go](myT-x/app_events_test.go)
- **説明**: `runtimeContext() == nil` / `sessions == nil` のケースでpanicしないことを確認するテストがない。
- **推奨**: nil ガードの動作確認テストを追加。

### S-14: `clearSnapshotRequestTimer` のユニットテスト未作成

- **ファイル**: テスト全般
- **説明**: shutdown時に呼ばれるクリーンアップ関数の単体テストがない。
- **推奨**: タイマーアクティブ状態での `clearSnapshotRequestTimer()` → 待機 → snapshot emit されないことを検証。

### S-15: `generation` フィールドにコメント不足

- **ファイル**: [session_manager.go](myT-x/internal/tmux/session_manager.go)
- **説明**: `generation`、`topologyGeneration`、`snapshotGeneration` の各フィールドの目的にコメントがない。
- **推奨**: 1行コメント追加。

### S-16: `requestSnapshot` / `emitSnapshot` のnilガード早期リターンにDebugログなし

- **ファイル**: [app_events.go](myT-x/app_events.go)
- **説明**: シャットダウン遷移でのみ到達するパスだが、診断トレース性のため `slog.Debug` が望ましい。
- **推奨**: 低優先で `slog.Debug` 追加。

### S-17: `TestSnapshotCacheInvalidationByGeneration` がポインタ比較に依存

- **ファイル**: [session_manager_test.go](myT-x/internal/tmux/session_manager_test.go)
- **説明**: `&first[0] != &second[0]` のポインタ比較はキャッシュ戦略の実装詳細に依存。
- **推奨**: `reflect.DeepEqual` + generation 比較への変更を検討。

---

## 差分外ファイルの類似箇所チェック (横断的一貫性)

### 修正漏れ検出

| # | カテゴリ | ファイル | 箇所 | 説明 |
|---|---------|--------|------|------|
| X-1 | `time.After` リーク | [internal/hotkeys/manager_windows.go](myT-x/internal/hotkeys/manager_windows.go) L178 | `case <-time.After(2 * time.Second)` | `time.NewTimer` に置換すべき |
| X-2 | `.catch()` なし | [frontend/src/App.tsx](myT-x/frontend/src/App.tsx) L45 | `void api.SetActiveSession(current.name)` | `.catch()` 追加 |
| X-3 | `.catch()` なし | [frontend/src/hooks/useFileDrop.ts](myT-x/frontend/src/hooks/useFileDrop.ts) L24 | `void api.SendInput(activePaneId, quoted)` | `.catch()` 追加 |
| X-4 | `.catch()` なし | [frontend/src/components/LayoutPresetSelector.tsx](myT-x/frontend/src/components/LayoutPresetSelector.tsx) L63 | `void api.ApplyLayoutPreset(sessionName, p.id)` | `.catch()` 追加 |
| X-5 | `.catch()` なし | [frontend/src/components/SessionView.tsx](myT-x/frontend/src/components/SessionView.tsx) L73-94 | 7箇所のインライン `void api.X()` | `.catch()` 追加。ただしI-8の `useCallback` 化と合わせて対応推奨 |

### 問題なし（確認完了）

| パターン | 結果 |
|---------|------|
| `emitSnapshot()` 直接呼び出し残存 | なし。全て `requestSnapshot()` 経由に置換済み |
| `getConfigSnapshot()` 不適切使用 | なし。差分外で使用する箇所はフロントエンドへの値返却用（deep copy必須）|
| `markState/Topology/SessionMapMutationLocked` 配置漏れ | なし。全変更箇所で適切に呼び出し済み |

---

## Strengths（良い点）

1. **タイマーリーク修正**: `time.After()` → `time.NewTimer()` + `defer timer.Stop()` の移行が正確
2. **`requestSnapshot` の generation メカニズム**: タイマーコールバックとの競合を安全に処理し、更新の欠落を防止
3. **ロック分離**: `snapshotMetricsMu` を `snapshotMu` から分離し、メトリクス記録がスナップショット計算のクリティカルパスをブロックしない設計
4. **`OutputFlushManager` への統合**: per-pane バッファから単一マネージャーへの移行でメモリ効率とgoroutine数を改善
5. **SessionManager の世代管理**: 3レベル（state/topology/sessionMap）の明確な階層設計
6. **Snapshot キャッシュ**: RLock→Lock のダブルチェックロッキングが正しく実装
7. **フロントエンドのRAFバッチング**: TerminalPane の書き込みを `requestAnimationFrame` 単位でコアレスする適切な最適化
8. **エラーハンドリング改善**: 全フロントエンドAPI呼び出しに `.catch()` + `console.warn` を追加
9. **テスト追加**: デバウンス / コアレス / 世代追跡 / キャッシュ無効化のテストが網羅的
10. **Nilガード**: 全パスで適切なnilチェックが実装されており、panic 可能なパスは未検出

---

## タスク整理 — 修正作業の並列実行可否

以下は検出された指摘事項を修正タスクとして整理し、並列で作業可能かどうかを一覧にしたものです。

### 凡例
- **並列OK**: 他のタスクと独立して修正可能。同時に複数人が作業しても衝突しない
- **並列NG**: 他のタスクと同一ファイル・同一関数を触るため、順次作業が必要
- **依存先**: 先に完了すべきタスク

| # | タスク内容 | 対象ファイル | 優先度 | 並列可否 | 依存関係 | 備考 |
|---|-----------|-------------|--------|---------|---------|------|
| T-1 | `snapshotDelta` にコメント追加（並行呼び出し非想定の明記） | app_snapshot_delta.go | 中 | ✅ 並列OK | なし | コメント追加のみ |
| T-2 | `estimateSnapshotPayloadBytes` にサンプリング意図・-1の意味をコメント追加 | app_snapshot_metrics.go | 中 | ✅ 並列OK | なし | コメント追加のみ |
| T-3 | `getConfigReadOnly` のdocコメント補強 | app_config_state.go | 低 | ✅ 並列OK | なし | コメント追加のみ |
| T-4 | `flushSnapshotRequest` 冒頭に `runtimeContext() == nil` チェック追加 | app_events.go | 中 | ⚠️ 要注意 | T-6と同一ファイル | app_events.go の別関数なので並列可だが要調整 |
| T-5 | `Snapshot()` のコメント更新（キャッシュ共有参照の契約明記） | session_manager_snapshot.go | 中 | ✅ 並列OK | なし | コメント更新のみ |
| T-6 | `stopDetachedOutputBuffers` を `cleanupDetachedPaneStates` に改名 | app_events.go + 呼び出し元 | 低 | ⚠️ 要注意 | T-4と同一ファイル | 関数名変更のため影響範囲確認必要 |
| T-7 | `ResizePane()` の等価チェックを `Terminal.Resize()` の前に移動 | session_manager_pane_io.go | 中 | ✅ 並列OK | なし | ロジック修正 |
| T-8 | ロック順序コメントに `snapshotRequestMu`, `snapshotMetricsMu` 追加 | app.go | 低 | ✅ 並列OK | なし | コメント追加のみ |
| T-9 | `SessionView` のコールバックを `useCallback` 化 + `.catch()` 追加 | SessionView.tsx | **高** | ✅ 並列OK | なし | I-8 + X-5 をまとめて対応 |
| T-10 | `paneEnvView()` のドキュメントに不変条件追記 | command_router.go | 低 | ✅ 並列OK | なし | コメント追加のみ |
| T-11 | `killPaneLocked()` のセッション削除分岐で `markSessionMapMutationLocked()` に統一 | session_manager_pane_lifecycle.go | 低 | ✅ 並列OK | なし | リファクタ |
| T-12 | `shouldBypassSnapshotDebounceForEvent` テーブル駆動テスト追加 | app_events_test.go | 低 | ✅ 並列OK | なし | テスト追加 |
| T-13 | `requestSnapshot` nil ガードテスト追加 | app_events_test.go | 低 | ❌ 並列NG | T-12と同一ファイル | T-12と順次 |
| T-14 | `generation` フィールドにコメント追加 | session_manager.go | 低 | ✅ 並列OK | なし | コメント追加のみ |
| T-15 | `shouldSyncPaneStates` のコメントに副作用を明記 | app_events.go | 低 | ⚠️ 要注意 | T-4, T-6と同一ファイル | 3タスクまとめて対応推奨 |
| T-16 | StatusBar の `requestRefresh` にデバウンス追加 | StatusBar.tsx | 低 | ✅ 並列OK | なし | 軽微修正 |
| T-17 | `time.After` → `time.NewTimer` (hotkeys/manager_windows.go) | internal/hotkeys/manager_windows.go | 低 | ✅ 並列OK | なし | 差分外ファイル |
| T-18 | App.tsx / useFileDrop.ts / LayoutPresetSelector.tsx に `.catch()` 追加 | 3ファイル | 低 | ✅ 並列OK | なし | 差分外ファイル |
| T-19 | `LayoutNodeView` の `useMemo` 重複解消 | LayoutNodeView.tsx | 低 | ⚠️ 要注意 | T-9完了後 | SessionView のuseCallback化後に効果的 |

### 推奨作業順序

```
Phase 1（並列実行可能・高優先度）:
  ┌── T-9:  SessionView useCallback化 + .catch() 追加
  ├── T-7:  ResizePane 等価チェック移動  
  ├── T-1:  snapshotDelta コメント追加
  ├── T-2:  estimateSnapshotPayloadBytes コメント追加
  └── T-5:  Snapshot() コメント更新

Phase 2（並列実行可能・中優先度）:
  ┌── T-4 + T-6 + T-15: app_events.go の3タスクをまとめて対応
  ├── T-8:  ロック順序コメント更新
  ├── T-14: generation フィールドコメント追加
  ├── T-10: paneEnvView ドキュメント追加
  └── T-11: killPaneLocked リファクタ

Phase 3（並列実行可能・低優先度）:
  ┌── T-12 → T-13: テスト追加（同一ファイルなので順次）
  ├── T-16: StatusBar デバウンス追加
  ├── T-17: hotkeys time.After 修正
  ├── T-18: 差分外 .catch() 追加
  └── T-19: LayoutNodeView useMemo 整理（T-9完了後）
```

### 並列作業グループ一覧

| グループ | 含まれるタスク | 同時作業人数 | 注意事項 |
|---------|-------------|------------|---------|
| A: Frontend | T-9, T-16, T-18 | 3人まで | T-9完了後にT-19を実施 |
| B: App層コメント | T-1, T-2, T-3, T-8 | 4人まで | 全て独立したファイル |
| C: app_events.go | T-4, T-6, T-15 | **1人のみ** | 同一ファイルの為まとめて対応 |
| D: Internal tmux | T-5, T-7, T-10, T-11, T-14 | 5人まで | 全て独立したファイル |
| E: テスト | T-12, T-13 | **1人のみ** | 同一ファイルの為順次 |
| F: 差分外修正 | T-17, T-18 | 2人まで | 独立 |

---

## Recommended Action

1. **Phase 1 の5タスクを最優先で修正**（特に T-9 は今回のメモ化改善の実効性に直結）
2. Phase 2 のタスクを並列で対応
3. Phase 3 はリスク低のため、次回スプリントに持ち越しても可
4. 全修正後にレビューを再実行して解決を検証
