# PR Review Summary — 2026-02-16 22:55

## レビュー対象

- **変更規模**: 35ファイル / +1,107行 / -244行
- **主な変更内容**: スナップショット デバウンス機構、OutputFlushManager 導入、フロントエンド性能最適化

### カテゴリ別ファイル一覧

| カテゴリ | ファイル数 | 主な変更内容 |
|---|---|---|
| Backend App層 | 9 | snapshot debounce, OutputFlushManager 統合, 設定読取り最適化 |
| Backend テスト (App層) | 5 | debounce テスト追加, OutputFlushManager テスト追記 |
| Backend tmux層 | 11 | generation tracking, snapshot cache, mutation マーキング |
| Backend tmux テスト | 1 | topology generation, snapshot cache invalidation テスト |
| Backend その他 | 3 | hotkey timer修正, OutputFlushManager 新規作成+テスト |
| Frontend | 8 | memo化, RAF batching, useCallback, event-driven StatusBar |

---

## Critical Issues（0件）

全レビュー観点において、致命的なバグや データ破壊リスクは検出されませんでした。

---

## Important Issues（7件）

### I-1: `onToggleZoom` の不安定参照が `memo(TerminalPane)` を無効化
- **ファイル**: [SessionView.tsx](myT-x/frontend/src/components/SessionView.tsx) — `onToggleZoom` callback
- **レビュー観点**: Frontend / コード品質
- **内容**: `onToggleZoom` の `useCallback` 依存配列に `zoomPaneId` が含まれているため、ズームを切り替えるたびにコールバック参照が変化し、`memo(TerminalPaneComponent)` による再レンダー抑制効果が損なわれる。`LayoutRenderer.tsx` のズーム表示パスでも同じ `onToggleZoom` が `TerminalPane` に渡されており、全ペインの再レンダーが発生する。
- **修正案**:
  ```tsx
  const onToggleZoom = useCallback((paneId: string) => {
    const current = useTmuxStore.getState().zoomPaneId;
    setZoomPaneId(current === paneId ? null : paneId);
  }, [setZoomPaneId]);
  ```

### I-2: `snapshotDelta` の並行実行時にキャッシュ上書きの可能性
- **ファイル**: [app_snapshot_delta.go](myT-x/app_snapshot_delta.go) — `snapshotDelta()` メソッド
- **レビュー観点**: Backend / 並行処理
- **内容**: 2つの `requestSnapshot(true)` が高速連続で呼ばれた場合、両方が `snapshotMu` を開放した状態で差分計算を実行し、後からロック取得した側が先に更新されたキャッシュを上書きする可能性がある。コメントでは「generation gating がシリアライズする」と記載されているが、実際には dispatch の重複防止のみで execution の並行は許容されている。
- **影響**: UI上は冗長な delta 送信が発生する程度で、データ破壊には至らない。
- **修正案**: コメントを実態に合わせて更新する（並行実行は許容され、最悪ケースは冗長な delta emission であることを明記）。または、`emitSnapshot` 実行全体をシリアライズする mutex を追加する。

### I-3: `getConfigReadOnly` が参照型フィールドを共有する
- **ファイル**: [app_config_state.go](myT-x/app_config_state.go) — `getConfigReadOnly()`
- **レビュー観点**: Backend / 並行処理安全性
- **内容**: `config.Config` は `Keys map[string]string`, `PaneEnv map[string]string`, `Worktree.SetupScripts []string`, `Worktree.CopyFiles []string`, `AgentModel *AgentModel` 等の参照型フィールドを含む。`getConfigReadOnly` は struct を値コピーで返すが、これらの内部ポインタは共有される。現在は `setConfigSnapshot` が常に `config.Clone()` を使うため安全だが、`CreateSessionWithWorktree` で非同期ゴルーチンに `cfg.Worktree.SetupScripts` を渡すパスがある。
- **修正案**: コメントに「返値の参照型フィールドは内部configと共有。setConfigSnapshotが常にCloneするため安全。長寿命ゴルーチンに渡す場合はgetConfigSnapshotを使うこと」を明記する。または `CreateSessionWithWorktree` の呼び出し元を `getConfigSnapshot` に戻す。

### I-4: `SplitLayoutNodeView` の fallback actions が非メモ化
- **ファイル**: [LayoutNodeView.tsx](myT-x/frontend/src/components/LayoutNodeView.tsx) — `SplitLayoutNodeView` 内
- **レビュー観点**: Frontend / パフォーマンス
- **内容**: `props.actions` が `undefined` の場合、毎レンダーで新しいオブジェクトリテラルが生成される。現在の呼び出しフローでは `LayoutNodeView` が常に `actions` を渡すため到達しないが、インターフェース上は `actions?` （optional）のため防御的でない。
- **修正案**: `actions` を required に変更するか、`useMemo` でラップする。

### I-5: `SplitLayoutNodeView` で個別 action props と `actions` が冗長に渡されている
- **ファイル**: [LayoutNodeView.tsx](myT-x/frontend/src/components/LayoutNodeView.tsx) — 再帰 `LayoutNodeView` 呼び出し
- **レビュー観点**: Frontend / 保守性
- **内容**: 子の `LayoutNodeView` に `actions={actions}` を渡すと同時に、個別の `onFocusPane={actions.onFocusPane}` 等も全て渡している。子は `props.actions ?? rootActions` を使うため、`actions` が渡されている限り個別 props は使われない。しかし `LayoutNodeViewProps extends LayoutNodeActions` のため TypeScript 上は required。
- **修正案**: 将来的なリファクタで `LayoutNodeViewProps` を再設計し、再帰呼び出し時は `actions` のみを渡す形に簡素化する。

### I-6: `flushStateLocked` の `force` パラメータがデッドコード
- **ファイル**: [output_flush_manager.go](myT-x/internal/terminal/output_flush_manager.go) — `flushStateLocked()`
- **レビュー観点**: Backend / コード品質
- **内容**: 全呼び出し箇所で `force = true` を渡しており、`!force` 分岐は到達不能。旧 `OutputBuffer` の設計を引き継いだ残滓。
- **修正案**: `force` パラメータを削除し、常に flush する実装に簡素化する。

### I-7: テスト未作成の新規関数（テストカバレッジ不足）
- **レビュー観点**: テスト品質
- **対象関数と優先度**:

| 関数 | ファイル | 優先度 |
|---|---|---|
| `worktreeInfoEqual` | session_manager_env.go | **高** |
| `RecommendedIdleCheckInterval` | session_manager_idle.go | **高** |
| `OutputFlushManager.RemovePane` | output_flush_manager.go | **中** |
| `shouldSyncPaneStates` | app_events.go | **中** |
| `estimateSnapshotPayloadBytes` | app_snapshot_metrics.go | **中** |
| `getConfigReadOnly` | app_config_state.go | **中** |
| `sortedSessionNamesLocked` | session_manager_snapshot.go | **中** |
| `detachAllOutputBuffers` / `detachStaleOutputBuffers` | app_events.go | **低** |

---

## Suggestions（12件）

### S-1: `prefixMode` の ref 化による handler 再登録削減
- **ファイル**: [usePrefixKeyMode.ts](myT-x/frontend/src/hooks/usePrefixKeyMode.ts)
- **内容**: `sessions`, `activeSession`, `zoomPaneId` は ref 化したのに `prefixMode` は依存配列に残っている。prefix キー押下ごとに `keydown` ハンドラが再登録される。

### S-2: `memo(TerminalPane)` にカスタム比較関数の検討
- **ファイル**: [TerminalPane.tsx](myT-x/frontend/src/components/TerminalPane.tsx)
- **内容**: 将来的にコールバック props が不安定になるリスクに備え、`paneId` + `active` + `paneTitle` のみを比較するカスタム `areEqual` を検討。

### S-3: `snapshotDelta` のキャッシュコピー二重化を削減
- **ファイル**: [app_snapshot_delta.go](myT-x/app_snapshot_delta.go)
- **内容**: `previous := copySnapshotCache(...)` と `updated := copySnapshotCache(previous)` で2回コピーしている。`updated` は `previous` を直接 mutate すれば1回で済む。

### S-4: `estimateSnapshotPayloadBytes` コメントの正確性修正
- **ファイル**: [app_snapshot_metrics.go](myT-x/app_snapshot_metrics.go)
- **内容**: コメントに「lock の外で eventCount を読む」と記載されているが、実際は lock 内で読んでいる。unlock 後の modulus check が racy な部分。

### S-5: `requestSnapshot` の早期 nil チェックにコメント追加
- **ファイル**: [app_events.go](myT-x/app_events.go)
- **内容**: `a.sessions` は起動時に一度セットされ nil 化されないため、ロック外の nil チェックは安全。1行コメントで明示すると保守性向上。

### S-6: `paneEnvView` の writer 側契約リンクをコメントに追加
- **ファイル**: [command_router.go](myT-x/internal/tmux/command_router.go)
- **内容**: `// See UpdatePaneEnv for the writer side of this contract.` を追加すると copy-on-write 契約の追跡が容易になる。

### S-7: `SetActivePane` の topology generation 分類に関するコメント
- **ファイル**: [session_manager_panes.go](myT-x/internal/tmux/session_manager_panes.go)
- **内容**: active pane 変更は構造変更ではないが `markTopologyMutationLocked()` を使用。意図的であることをコメントで明記すると混乱を防げる。

### S-8: `OutputFlushManager.loop()` — wake 後の timer リセット
- **ファイル**: [output_flush_manager.go](myT-x/internal/terminal/output_flush_manager.go)
- **内容**: `wakeCh` 受信時に timer をリセットしていないため、timer.C が既に pending なら次のループで即 flush される。Go 1.23+ のバッファなしタイマーなら安全にリセット可能。

### S-9: `stopOnce.Do` 内の `stopped` ガードは冗長
- **ファイル**: [output_flush_manager.go](myT-x/internal/terminal/output_flush_manager.go)
- **内容**: `stopOnce.Do` が単一実行を保証するため、内部の `if m.stopped` チェックは到達不能。defense-in-depth として許容されるが、読者を混乱させる可能性。

### S-10: `OutputFlushManager.Write` の edge case テスト追加
- **ファイル**: [output_flush_manager_test.go](myT-x/internal/terminal/output_flush_manager_test.go)
- **内容**: 空 `paneID`/空 `data` → no-op、`Stop()` 後の `Write()` → 無視される、のテストが未作成。

### S-11: Flaky test リスク — `time.Sleep` 依存
- **ファイル**: app_events_test.go, app_pane_api_test.go, output_flush_manager_test.go
- **内容**: `time.Sleep(snapshotCoalesceWindow + 120ms)` パターンが複数テストで使用。CI 環境の負荷次第でフレーク化する可能性。ポーリングベースの待機を検討。

### S-12: エラーログの集約ユーティリティ検討
- **ファイル**: Frontend 全般
- **内容**: `console.warn("[tag] message", err)` パターンが一貫して使われている。将来的にログフィルタリングが必要になった場合に備え、集約 logger utility の導入を検討。

---

## Strengths（正の評価）

### Backend

1. **ロック順序ドキュメント**: `app.go` で `snapshotRequestMu`, `snapshotMetricsMu` を独立ロックとして明記。デッドロック分析の負債を防止。
2. **Generation ベースの debounce gating**: `requestSnapshot` / `flushSnapshotRequest` の dispatch 重複防止メカニズムが簡潔で正確。
3. **Timer ライフサイクル管理**: 全 `time.NewTimer` で適切な `Stop()` + drain パターンを実装。
4. **OutputFlushManager 統合**: N個のペイン別ゴルーチンを1つの共有 flusher に統合する大幅なアーキテクチャ改善。
5. **Topology-gated pane sync**: `shouldSyncPaneStates` で冗長な pane state 列挙を回避するホットパス最適化。
6. **3階層 mutation マーキング**: `markStateMutationLocked` ⊂ `markTopologyMutationLocked` ⊂ `markSessionMapMutationLocked` の階層が明確。
7. **Snapshot キャッシュ**: double-checked locking パターンで thundering herd を防止。
8. **エラーハンドリング**: サイレントな swallow なし。全エラーパスが `slog.Warn` / `slog.Debug` でログ出力。

### Frontend

1. **一貫したエラー処理**: 全 API 呼び出しに `.catch()` + タグ付き `console.warn`。
2. **RAF Batched Writes**: xterm.js の `term.write()` 呼び出し回数を大幅に削減。
3. **Event-Driven StatusBar**: 1秒ポーリング → 10秒 + イベント駆動 (75ms debounce) への効果的な移行。
4. **usePrefixKeyMode Ref パターン**: stale closure を防止する正しい ref 同期パターン。
5. **包括的な Cleanup**: 全タイマー、RAF、イベントリスナー、addon の cleanup が網羅的。

### テスト

1. **debounce テストの設計**: coalesce 動作（6回→1回）、immediate bypass（debounce→immediate→1回）の本質を正確にテスト。
2. **デッドロック検証パターン**: コールバック内で `outputMu` ロック取得 + タイムアウト検出。
3. **Generation 追跡テスト**: 各操作と topology generation の関係を段階的に検証。

---

## タスク一覧 — 修正の並列作業可否

以下の表は、各指摘事項を修正する際の並列作業の可否をまとめたものです。

| # | 指摘 | 対象ファイル | 作業内容 | 並列作業 | 備考 |
|---|---|---|---|---|---|
| **I-1** | `onToggleZoom` 不安定参照 | SessionView.tsx | `useCallback` 修正: `useTmuxStore.getState()` パターンに変更 | ✅ 可能 | 他のファイルに依存なし |
| **I-2** | `snapshotDelta` 並行キャッシュ上書き | app_snapshot_delta.go | コメント修正 or mutex 追加 | ✅ 可能 | Frontend と独立 |
| **I-3** | `getConfigReadOnly` コメント追記 | app_config_state.go | コメント追記 or `getConfigSnapshot` に戻す (app_worktree_api.go) | ✅ 可能 | I-2 と独立 |
| **I-4** | fallback actions 非メモ化 | LayoutNodeView.tsx | `actions` を required にするか `useMemo` 追加 | ⚠️ I-5と同時 | I-5 と同一ファイルのため同時修正推奨 |
| **I-5** | 冗長な個別 props | LayoutNodeView.tsx | props 再設計 (I-4 と同時) | ⚠️ I-4と同時 | I-4 と同一ファイルのため同時修正推奨 |
| **I-6** | `force` パラメータ デッドコード | output_flush_manager.go | パラメータ削除 + 呼び出し箇所修正 | ✅ 可能 | 他と独立 |
| **I-7a** | `worktreeInfoEqual` テスト | session_manager_env_test.go (新規) | テーブル駆動テスト作成 | ✅ 可能 | 他テストと独立 |
| **I-7b** | `RecommendedIdleCheckInterval` テスト | session_manager_idle_test.go (新規) | テーブル駆動テスト作成 | ✅ 可能 | 他テストと独立 |
| **I-7c** | `RemovePane` テスト | output_flush_manager_test.go | テスト追加 | ✅ 可能 | 他テストと独立 |
| **I-7d** | `shouldSyncPaneStates` テスト | app_events_test.go | テスト追加 | ✅ 可能 | 既存テストと同一ファイルだが独立ケース |
| **I-7e** | `estimateSnapshotPayloadBytes` テスト | app_snapshot_metrics_test.go | テスト追加 | ✅ 可能 | 既存テストと同一ファイルだが独立ケース |
| **S-1** | `prefixMode` ref 化 | usePrefixKeyMode.ts | ref パターン追加 + 依存配列削減 | ✅ 可能 | I-1 とは別ファイル |
| **S-3** | キャッシュコピー二重化削減 | app_snapshot_delta.go | `updated` を `previous` の直接変更に | ⚠️ I-2と同時 | I-2 と同一ファイルのため同時修正推奨 |
| **S-4** | コメント正確性修正 | app_snapshot_metrics.go | コメント文言修正 | ✅ 可能 | 他と独立 |
| **S-6** | writer 側契約リンク追加 | command_router.go | コメント追記 | ✅ 可能 | 他と独立 |
| **S-7** | SetActivePane コメント | session_manager_panes.go | コメント追記 | ✅ 可能 | 他と独立 |
| **S-8** | wake 後 timer リセット | output_flush_manager.go | timer.Stop + Reset 追加 | ⚠️ I-6と同時 | I-6 と同一ファイルのため同時修正推奨 |

### 並列作業グループ

以下のグループに分けて並列作業が可能です：

| グループ | 作業 | 担当可能な作業者 |
|---|---|---|
| **A: Frontend SessionView** | I-1 | 1名 |
| **B: Frontend LayoutNodeView** | I-4, I-5 | 1名（同一ファイル） |
| **C: Frontend usePrefixKeyMode** | S-1 | 1名 |
| **D: Backend app_snapshot_delta** | I-2, S-3 | 1名（同一ファイル） |
| **E: Backend app_config_state** | I-3 | 1名 |
| **F: Backend OutputFlushManager** | I-6, S-8, S-9 | 1名（同一ファイル） |
| **G: Backend コメント修正** | S-4, S-5, S-6, S-7 | 1名（各ファイル独立、軽微） |
| **H: テスト追加 (tmux 層)** | I-7a, I-7b | 1名（新規ファイル、独立） |
| **I: テスト追加 (App 層)** | I-7c, I-7d, I-7e | 1名（既存テストファイル追記） |

**最大9名で完全並列作業可能** — ただし現実的には3〜4名で A+C, B, D+E+G, F+H+I のように分担するのが効率的です。

---

## 推奨アクション

1. **最優先**: I-1 (`onToggleZoom`) — 修正1行で `memo()` 最適化の効果が発揮される
2. **次点**: I-7a, I-7b — 新規公開関数のテスト追加（プロジェクトポリシー必須）
3. **推奨**: I-2, I-3, I-6 — コメント修正/デッドコード削除でコードの正確性と保守性を向上
4. **検討**: I-4, I-5, S-1 — パフォーマンス/保守性の追加改善
