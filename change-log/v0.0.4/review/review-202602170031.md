# PR Review: copy_dirs 機能追加

- **日時**: 2026-02-17 00:31
- **対象**: myT-x 配下の未コミット変更（14ファイル、約515行）
- **レビュー方式**: 4並列エージェント（Go Backend / Go Test / Frontend / 設計・簡略化）

---

## 変更概要

worktree作成時に、リポジトリルートから指定ディレクトリを再帰コピーする `copy_dirs` 機能を追加。
既存の `copy_files` パターンを踏襲したフルスタック実装。

### 変更ファイル一覧

| カテゴリ | ファイル | 変更量 |
|---------|---------|--------|
| Go Backend | `app_worktree_api.go` | +204行 |
| Go Backend | `internal/config/config.go` | +15行 |
| Go Test | `app_worktree_api_test.go` | +212行 |
| Go Test | `internal/config/config_test.go` | +18行 |
| Frontend | `frontend/src/components/settings/SettingsModal.tsx` | +1行 |
| Frontend | `frontend/src/components/settings/WorktreeSettings.tsx` | +21行 |
| Frontend | `frontend/src/components/settings/settingsReducer.ts` | +4行 |
| Frontend | `frontend/src/components/settings/types.ts` | +1行 |
| Frontend | `frontend/src/hooks/useBackendSync.ts` | +15行 |
| Frontend | `frontend/src/types/tmux.ts` | +1行 |
| Frontend | `frontend/wailsjs/go/models.ts` | +3行 |
| Config | `config.yaml` | +1行 |
| Docs | `develop-README.md` | +19行 |

---

## レビュー結果サマリー

| 重要度 | 件数 |
|--------|------|
| Critical | 0 |
| Important | 5 |
| Suggestion | 12 |

---

## Critical (0件)

なし

---

## Important (5件)

### IMP-1: `os.ReadFile` による大ファイルのメモリ消費リスク

- **ファイル**: `app_worktree_api.go` (`copyFileInWalk`)
- **行**: L618-L640 付近

**指摘内容**:
`copyFileInWalk` は `os.ReadFile` でファイル全体をメモリに読み込んでから `os.WriteFile` で書き出している。
`copy_dirs` はディレクトリ再帰コピーであるため、大きなバイナリファイル（ビルド成果物など）が含まれる可能性がある。
既存の `copy_files` は個別ファイル指定のためユーザーに自覚があるが、`copy_dirs` ではサブディレクトリ内の想定外の大ファイルがコピー対象になりうる。

**推奨修正**:
`io.Copy` によるストリーミングコピーに変更する:
```go
srcFile, err := os.Open(path)
if err != nil { ... }
defer srcFile.Close()
dstFile, err := os.OpenFile(dst, os.O_CREATE|os.O_WRONLY|os.O_TRUNC, 0o600)
if err != nil { ... }
defer dstFile.Close()
if _, err := io.Copy(dstFile, srcFile); err != nil { ... }
```

---

### IMP-2: 大規模ディレクトリコピー時のサイズ・ファイル数制限なし

- **ファイル**: `app_worktree_api.go` (`copyConfigDirToWorktree`)
- **行**: L502-L540 付近

**指摘内容**:
`filepath.WalkDir` による再帰走査にファイル数・合計サイズの上限がない。
ユーザーが誤って巨大ディレクトリ（`node_modules`、`.git` 等）を指定した場合、worktree作成が長時間ブロックされるか、ディスクを圧迫する可能性がある。

**推奨修正**:
ファイル数カウンターと合計サイズカウンターを `WalkDir` コールバック内に追加し、閾値超過時に警告ログを出力して走査を中断する。例:
```go
const maxCopyFiles = 10000
const maxCopySize  = 500 * 1024 * 1024 // 500MB
var fileCount int
var totalSize int64
```
閾値超過時は `filepath.SkipAll` を返してエラーをログに記録。

---

### IMP-3: `handleSymlinkInWalk` / `copyFileInWalk` の単体テスト不足

- **ファイル**: `app_worktree_api_test.go`

**指摘内容**:
`handleSymlinkInWalk` と `copyFileInWalk` は `copyConfigDirToWorktree` から呼ばれる内部関数だが、個別のユニットテストがない。以下のケースが統合テストでカバーされていない：

1. **リポジトリ内シンボリックリンク（ファイルを指す）が正しくコピーされるケース**: Walk中にシンボリックリンクがリポジトリ内ファイルを指している場合、そのファイルの中身がコピーされることの検証
2. **WalkDir中のエラー発生時に `hadError=true` かつ残りが継続されるケース**: 一部ファイルでエラーが発生しても残りのファイルがコピーされ、かつ failures リストに含まれることの検証
3. **既存ファイルの上書きケース**: `validateCopyDestination` の上書きパスの `copyConfigDirToWorktree` における動作確認

**推奨修正**: 上記3ケースをテストとして追加する。

---

### IMP-4: `isZeroConfig` テストに `CopyDirs` ケースが不足

- **ファイル**: `internal/config/config_test.go` (`TestIsZeroConfig` 相当)

**指摘内容**:
`WorktreeConfig` に `CopyDirs` フィールドが追加されたが、`isZeroConfig` のテストにおいて `CopyDirs` のみが非ゼロの場合のテストケースがない。
`isZeroConfig` がフィールド追加に正しく追従しているか検証できていない。

**推奨修正**:
`TestIsZeroConfig` に以下のテストケースを追加:
```go
{
    name: "non-zero CopyDirs only",
    cfg: AppConfig{Worktree: WorktreeConfig{CopyDirs: []string{".vscode"}}},
    want: false,
},
```

---

### IMP-5: `TestDefaultConfigWorktreeDefaults` に `CopyDirs` 検証が不足

- **ファイル**: `internal/config/config_test.go` (`TestDefaultConfigWorktreeDefaults` 相当)

**指摘内容**:
`DefaultConfig()` で `CopyDirs: []string{}` が設定されているが、テストでこの値が正しく設定されていることを検証していない。

**推奨修正**:
`TestDefaultConfigWorktreeDefaults` に以下のアサーションを追加:
```go
if wt.CopyDirs == nil || len(wt.CopyDirs) != 0 {
    t.Errorf("CopyDirs: want non-nil empty slice, got %v", wt.CopyDirs)
}
```

---

## Suggestion (12件)

### SUG-1: `copyConfigFilesToWorktree` と `copyConfigDirsToWorktree` の構造的重複

- **ファイル**: `app_worktree_api.go` L430-L452, L478-L500

**指摘内容**:
両関数は以下の同一構造を持つ:
1. `resolveSymlinkEvaluatedBasePath(repoPath)` → 失敗時 `normalizeCopyFailures(items)` 返却
2. `resolveSymlinkEvaluatedBasePath(wtPath)` → 同上
3. `for _, item := range items` → 個別コピー関数呼び出し → failures収集

ログメッセージ文字列のみが異なり、約20行のボイラープレートが完全重複。

**推奨修正**:
高階関数で共通化する:
```go
func copyConfigEntriesToWorktree(
    repoPath, wtPath string,
    entries []string,
    label string,
    copyFn func(repoBase, wtBase, entry string) bool,
) []string { ... }
```
これにより約20行削減、将来の `copy_globs` 等への拡張ポイントも明確になる。

---

### SUG-2: `copyConfigFileToWorktree` と `copyConfigDirToWorktree` 冒頭のパス検証ロジック重複

- **ファイル**: `app_worktree_api.go` L454-L476, L502-L520

**指摘内容**:
両関数の冒頭で `filepath.Clean` → 絶対パス/`..`チェック → `filepath.Join` → `isPathWithinBase` の同一ロジックが繰り返されている。

**推奨修正**:
Rule of Three（3箇所以上で抽出）の観点から、現時点は2箇所のみのため即時対応不要。
将来3箇所目が出現した場合に `validateAndResolveCopyEntry()` ヘルパーとして抽出を検討。

---

### SUG-3: `hadError *bool` パターンのコメント追加

- **ファイル**: `app_worktree_api.go` L540-L560, L574-L615, L618-L640

**指摘内容**:
`copyConfigDirToWorktree` → `handleSymlinkInWalk` / `copyFileInWalk` 間で `*bool` ポインタを共有してエラー状態を伝搬している。
「一度trueになったら戻らない」という暗黙の不変条件がコメントなし。

**推奨修正**:
現状の設計は `WalkDir` コールバックの制約上妥当。コメントを1行追加してセマンティクスを明確にする:
```go
// hadError is a write-once flag: set to true on first error, never reverted.
hadError := false
```

---

### SUG-4: シンボリックリンクディレクトリの挙動をドキュメントに明記

- **ファイル**: `develop-README.md`

**指摘内容**:
`handleSymlinkInWalk` でシンボリックリンクがディレクトリを指す場合、空ディレクトリのみ作成する設計。循環参照防止として適切だが、ユーザーにとって予期しない動作になりうる。

**推奨修正**:
`develop-README.md` の `copy_dirs` セクションに「シンボリックリンクされたサブディレクトリは空ディレクトリとしてコピーされる（循環参照防止）」の一文を追加。

---

### SUG-5: TOCTOU に関するコメント追加

- **ファイル**: `app_worktree_api.go`

**指摘内容**:
ファイルの存在チェック(`os.Stat`) → 読み書き(`os.ReadFile`/`os.WriteFile`) 間のTOCTOU窓口が存在する。
ローカルデスクトップアプリかつ信頼された設定値が入力源であるため実質リスクなし（製品仕様に合致）だが、
セキュリティレビュー時の判断根拠として1行コメントがあるとよい。

**推奨修正**:
```go
// Note: TOCTOU window between stat and read/write is acceptable
// as source paths come from trusted configuration.
```

---

### SUG-6: destination symlink attack テスト（dir版）の追加

- **ファイル**: `app_worktree_api_test.go`

**指摘内容**:
`copyConfigFileToWorktree` には宛先シンボリックリンク攻撃テストがあるが、`copyConfigDirToWorktree` には対応するテストがない。
`validateCopyDestination` を共有しているため実質カバーされているが、dir版として明示テストがあると堅牢。

---

### SUG-7: 空ファイルコピーテストの追加

- **ファイル**: `app_worktree_api_test.go`

**指摘内容**:
ゼロバイトファイルのコピーテストがない。`os.ReadFile` / `io.Copy` の空ファイルエッジケース検証。

---

### SUG-8: 複数ディレクトリ部分失敗テストの追加

- **ファイル**: `app_worktree_api_test.go`

**指摘内容**:
複数のディレクトリを指定し、一部が失敗した場合に成功分は正しくコピーされ、失敗分のみfailuresリストに含まれることのテスト。

---

### SUG-9: `Save` ラウンドトリップでの `CopyDirs` 検証

- **ファイル**: `internal/config/config_test.go`

**指摘内容**:
`Save` → `Load` のラウンドトリップテストで `CopyDirs` フィールドが正しく永続化・復元されることの検証。

---

### SUG-10: フロントエンド `models.ts` の undefined リスク

- **ファイル**: `frontend/wailsjs/go/models.ts`

**指摘内容**:
`this.copy_dirs = source["copy_dirs"]` で、バックエンドから `copy_dirs` が欠落した場合 `undefined` になる。
ただし `settingsReducer` の `LOAD_CONFIG` で `wt?.copy_dirs || []` としてフォールバックしているため、実質問題なし。

---

### SUG-11: フロントエンドのラベルアクセシビリティ

- **ファイル**: `frontend/src/components/settings/WorktreeSettings.tsx`

**指摘内容**:
`label` と `DynamicStringList` 間の `htmlFor` / `id` 関連付けがないが、既存の `copy_files` セクションと同一パターンのため一貫性あり。UIリファクタリング時に一括対応。

---

### SUG-12: `WorktreeSettings.tsx` のインラインスタイル

- **ファイル**: `frontend/src/components/settings/WorktreeSettings.tsx`

**指摘内容**:
`style={{ marginTop: 10 }}` 等のインラインスタイルが散在。既存パターン踏襲のため一貫性はあるが、CSSクラスへの統一が望ましい。UIリファクタリング時に一括対応。

---

## 確認済み（問題なし）

| 項目 | 結果 |
|------|------|
| フルスタック型整合性（Go ↔ Wails ↔ TS ↔ FormState ↔ Reducer ↔ UI） | ✅ 全層で一致 |
| `Clone` / `DefaultConfig` / `applyDefaultsAndValidate` 更新漏れ | ✅ 3箇所とも漏れなし |
| イベント名一致（`worktree:copy-dirs-failed`）Go ↔ TS | ✅ 一致・クリーンアップ済み |
| `EventsOff` でのリスナークリーンアップ | ✅ 実装済み |
| `useBackendSync` ハンドラー品質（型ガード・フォールバック） | ✅ copy_filesと同一構造 |
| セキュリティ設計（トラバーサル・symlink・パーミッション・特殊ファイル・循環参照） | ✅ 多層防御 |
| `config.yaml` デフォルト設定 | ✅ `copy_dirs: []` |
| `develop-README.md` ドキュメント追加 | ✅ 使用例含む |
| `copy_files` / `copy_dirs` 直列実行 | ✅ 現時点で問題なし |

---

## 良い点

1. **既存パターンの忠実な踏襲**: `copy_files` の実装パターンをフルスタック全体で忠実に踏襲しており、コードの一貫性が非常に高い
2. **多層セキュリティ防御**: ディレクトリトラバーサル、シンボリックリンク脱出、宛先シンボリックリンク、特殊ファイルスキップ、循環参照防止と5層の防御が実装済み
3. **テストカバレッジ**: 12のテストケースで主要なエッジケース（絶対パス拒否、`..`トラバーサル、symlink脱出、空リスト等）を網羅
4. **エラー時の継続動作**: `WalkDir` 中のエラーで走査を中断せず、失敗したエントリのみfailuresリストに含める設計が堅実
5. **フロントエンドの既存コンポーネント再利用**: `DynamicStringList` の再利用で新規コンポーネント追加なし
6. **型整合性**: Go struct tags → Wails binding → TypeScript Pick type → FormState まで完全に一貫

---

## タスク一覧と並列作業可否

以下は、レビュー指摘事項を修正タスクとして整理したものです。

### 凡例

- **並列可能**: 他のタスクと同時に作業しても競合しない
- **並列不可**: 先行タスクの完了を待つ必要がある
- **依存先**: そのタスクが依存する先行タスク

### タスク表

| # | タスク | 重要度 | 対象ファイル | 並列 | 依存先 | 備考 |
|---|--------|--------|-------------|------|--------|------|
| T1 | `copyFileInWalk` を `io.Copy` ストリーミングに変更 | IMP | `app_worktree_api.go` | ✅ 可 | なし | 単一関数内の変更 |
| T2 | `WalkDir` にファイル数・サイズ上限を追加 | IMP | `app_worktree_api.go` | ✅ 可 | なし | T1と別関数のため並列可 |
| T3 | `handleSymlinkInWalk` / `copyFileInWalk` 単体テスト追加 | IMP | `app_worktree_api_test.go` | ⚠️ 条件付 | T1, T2 | T1/T2の変更後のAPIに合わせる必要あり |
| T4 | `isZeroConfig` テストに `CopyDirs` ケース追加 | IMP | `internal/config/config_test.go` | ✅ 可 | なし | 独立したテストファイル |
| T5 | `TestDefaultConfigWorktreeDefaults` に `CopyDirs` 検証追加 | IMP | `internal/config/config_test.go` | ✅ 可 | なし | T4と同ファイルだが別テスト関数 |
| T6 | top-level関数の構造的重複を共通ヘルパーに抽出 | SUG | `app_worktree_api.go` | ⚠️ 条件付 | T1, T2 | T1/T2完了後に着手推奨 |
| T7 | `hadError` パターンにコメント追加 | SUG | `app_worktree_api.go` | ✅ 可 | なし | コメント追加のみ |
| T8 | symlink挙動をドキュメントに明記 | SUG | `develop-README.md` | ✅ 可 | なし | ドキュメントのみ |
| T9 | TOCTOU コメント追加 | SUG | `app_worktree_api.go` | ✅ 可 | なし | コメント追加のみ |
| T10 | destination symlink attackテスト（dir版）追加 | SUG | `app_worktree_api_test.go` | ⚠️ 条件付 | T1, T2 | テスト対象の変更後に作成 |
| T11 | 空ファイルコピーテスト追加 | SUG | `app_worktree_api_test.go` | ⚠️ 条件付 | T1 | `io.Copy` 変更後のエッジケース |
| T12 | 複数ディレクトリ部分失敗テスト追加 | SUG | `app_worktree_api_test.go` | ⚠️ 条件付 | T2 | サイズ上限追加後のテスト |
| T13 | `Save` ラウンドトリップ `CopyDirs` テスト追加 | SUG | `internal/config/config_test.go` | ✅ 可 | なし | 独立したテストケース |

### 推奨作業順序

```
【フェーズ1: 並列実行可能】(全て同時着手OK)
  ├─ T1: io.Copy変更
  ├─ T2: WalkDirサイズ上限追加
  ├─ T4: isZeroConfigテスト追加
  ├─ T5: DefaultConfigテスト追加
  ├─ T7: hadErrorコメント追加
  ├─ T8: ドキュメント追記
  ├─ T9: TOCTOUコメント追加
  └─ T13: Saveラウンドトリップテスト追加

【フェーズ2: フェーズ1完了後】(並列実行可能)
  ├─ T3: handleSymlinkInWalk/copyFileInWalkテスト追加
  ├─ T6: 共通ヘルパー抽出
  ├─ T10: destination symlink attackテスト(dir版)
  ├─ T11: 空ファイルコピーテスト
  └─ T12: 複数ディレクトリ部分失敗テスト
```

### 並列作業の注意点

| 組み合わせ | 可否 | 理由 |
|-----------|------|------|
| T1 + T2 | ✅ | 別関数(`copyFileInWalk` vs `copyConfigDirToWorktree`)への変更 |
| T4 + T5 | ✅ | 同ファイルだが別テスト関数で競合なし |
| T7 + T9 | ✅ | 同ファイルだが別箇所へのコメント追加 |
| T1 + T6 | ❌ | T6は`copyFileInWalk`含むリファクタリングのためT1完了後 |
| T3 + T6 | ❌ | T6のリファクタリングでAPIが変わる可能性 |
| T1 + T3 | ❌ | T3はT1変更後のAPIでテストを書く必要あり |
| T4 + T13 | ✅ | 同ファイルだが完全に独立したテストケース |

---

## レビュー実行情報

| エージェント | 対象カテゴリ | 対象ファイル数 |
|-------------|-------------|---------------|
| Go Backend Review | Go実装コード | 2ファイル |
| Go Test Review | Goテストコード | 2ファイル |
| Frontend Review | React/TypeScript | 7ファイル |
| Design & Simplification Review | 全ファイル横断 | 14ファイル |
