# PR Review Summary — copy_dirs 機能追加

**レビュー日時**: 2026-02-17 07:28  
**レビュー対象**: コミット前差分（15ファイル, +963 / -37 行）  
**レビュー方式**: 5エージェント並列レビュー（Go Code / Frontend / Test Coverage / Error Handling / Security & Simplification）

---

## 変更概要

`copy_dirs` 設定を追加し、ワークツリー作成時にリポジトリからディレクトリを再帰的にコピーする機能を実装。
既存の `copy_files` パターンに対称的に追加されており、全レイヤー（Go struct / Config YAML / Frontend UI / Event System / Wails models）に変更が及ぶ。

### 変更ファイルカテゴリ

| カテゴリ | ファイル |
|---------|---------|
| **Go バックエンド** | `app_worktree_api.go` (+357行), `internal/config/config.go` (+8行) |
| **Go テスト** | `app_worktree_api_test.go` (+517行), `internal/config/config_test.go` (+44行) |
| **フロントエンド** | `WorktreeSettings.tsx`, `settingsReducer.ts`, `types.ts`, `SettingsModal.tsx`, `useBackendSync.ts`, `tmux.ts`, `models.ts` |
| **設定** | `config.yaml` |
| **その他** | `develop-README.md`, `.claude/settings.local.json` |

---

## Critical Issues (0 found)

重大なバグやセキュリティ脆弱性は発見されませんでした。

---

## Important Issues (2 found)

### I-1. [code] Budget制限がディレクトリごとに独立（グローバル制限として機能しない）

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api.go` — `copyConfigDirToWorktree` 関数冒頭 |
| 深刻度 | **Important** |
| 説明 | `copyConfigDirToWorktree` が呼ばれるたびに `budget := copyWalkBudget{}` で新規生成される。`copy_dirs: [".vscode", "vendor", "node_modules"]` のように複数ディレクトリが設定された場合、実効制限は `maxCopyDirsFileCount × N` ファイル、`maxCopyDirsTotalBytes × N` バイトとなる。変数名 `maxCopyDirsFileCount`（複数形Dirs）やコメント「copy_dirs guardrails」はグローバル制限を意図しているように見えるが、実装はディレクトリ単位。 |
| 対処案 | **A)** 意図通りなら変数名・コメントを「per-directory limit」に明確化。**B)** グローバル制限が必要なら `budget` を `copyConfigEntriesToWorktree` レベルで生成し `copyFn` へ渡す。 |

### I-2. [code] `copyFileByStreaming` コピー失敗時に不完全な宛先ファイルが残る

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api.go` — `copyFileByStreaming` 関数 |
| 深刻度 | **Important** |
| 説明 | `io.Copy` が途中で失敗した場合、`dstFile` は Close（defer経由）されるが、部分書き込みされたファイルがディスクに残る。呼び出し元（`copyFileInWalk`, `copyConfigFileToWorktree`）もクリーンアップしていない。best-effort操作であるためCriticalではないが、ワークツリーに壊れたファイルが残り得る。 |
| 対処案 | `copyFileByStreaming` 内で `retErr != nil` 時に `os.Remove(dstPath)` を追加（defer内またはエラーリターン前）。 |

---

## Suggestions (11 found)

### S-1. [code] `handleSymlinkInWalk` — リポジトリ外symlinkのログレベル不整合

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api.go` — `handleSymlinkInWalk` 関数 |
| 説明 | `WARN` レベルでログ出力しつつ `*hadError = true` を設定しない。コメントで「intentional symlink outside repo」とあるのに `WARN` は矛盾。`Info` or `Debug` に変更すべき。 |

### S-2. [code] `handleSymlinkInWalk` — symlink先の非正規ファイルタイプ未チェック

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api.go` — `handleSymlinkInWalk` 関数末尾 |
| 説明 | コメントは「regular file」と記述しているが、`linkInfo.Mode().IsRegular()` の確認がない。symlink先がソケット・パイプ等の場合もコピーを試みる。walk 本体では `d.Type().IsRegular()` で明示的にスキップしており一貫性がない。 |
| 対処案 | `linkInfo.IsDir()` チェックの後に `!linkInfo.Mode().IsRegular()` スキップを追加。 |

### S-3. [code] `copyConfigFileToWorktree` — TOCTOU間の `IsNotExist` が完全に無ログ

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api.go` — `copyConfigFileToWorktree` 関数 |
| 説明 | `EvalSymlinks` で存在確認済みファイルが `copyFileByStreaming` 時に消えた場合（TOCTOU競合）、完全にログ無しでスキップされる。`copyFileInWalk` では同じケースを `WARN` でログしつつ `hadError=true` にしている。一貫性なし。 |
| 対処案 | `DEBUG` レベルのログを追加（レース発生の痕跡追跡用）。 |

### S-4. [code] `copyFileByStreaming` に `dstFile.Sync()` がない

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api.go` — `copyFileByStreaming` 関数 |
| 説明 | 同プロジェクトの `atomicWrite`（config.go）では `tmpFile.Sync()` が呼ばれているが、`copyFileByStreaming` では未使用。worktreeコピーはbest-effort・再実行可能なのでリスクは低い。 |

### S-5. [code] Unsafe パスの `return false`（failure非計上）

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api.go` — `copyConfigDirToWorktree`, `copyConfigFileToWorktree` 冒頭 |
| 説明 | `filepath.IsAbs` や `..` で拒否されたパスが `false` を返す（failure扱いではない）。UIでユーザーにミス入力のフィードバックが伝わらない可能性がある。`return true` にして failures リストに入れた方がUI通知される。 |

### S-6. [code] 入口バリデーション重複

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api.go` — `copyConfigFileToWorktree` と `copyConfigDirToWorktree` |
| 説明 | 両関数の冒頭30行（`filepath.Clean` → `IsAbs` → `".."` → `isPathWithinBase` → `EvalSymlinks` → `isPathWithinBase`）が完全に同一。共通の `validateAndResolveSourceEntry` ヘルパーに抽出すれば約20行の重複削除と保守性向上が見込める。 |

### S-7. [tests] `copyFileByStreaming` の単独テストが存在しない

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api_test.go` |
| 説明 | コアコピーロジックの以下エラーパスが個別テストされていない: ソースファイル不存在、権限不足、宛先ファイル作成失敗、`io.Copy` 中のエラー、close エラー合流。 |

### S-8. [tests] `closeFileAndJoinError` の単独テストが存在しない

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api_test.go` |
| 説明 | エラー合流ロジックのテストがない。テストすべきケース: file==nil, Close成功, retErr==nil+Close失敗, retErr!=nil+Close失敗（errors.Join）。 |

### S-9. [tests] `reserveCopyWalkBudget` の境界値テスト不足

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api_test.go` |
| 説明 | ちょうど制限値（file count / total size）での動作、fileSize=0、fileSize<0 のケースが統合テスト経由のみ。単独のテーブル駆動テストがあると安全。 |

### S-10. [tests] `handleSymlinkInWalk` の追加シナリオ不足

| 項目 | 内容 |
|------|------|
| ファイル | `app_worktree_api_test.go` |
| 説明 | 現在のテストはファイルsymlinkの正常系のみ。壊れたsymlink、ディレクトリへのsymlink、リポジトリ外symlink、Stat失敗ケースが未テスト。 |

### S-11. [frontend] フロントエンド側でパス形式バリデーションなし

| 項目 | 内容 |
|------|------|
| ファイル | `WorktreeSettings.tsx` |
| 説明 | `copy_dirs` 入力でパストラバーサル（`..`）や絶対パス拒否をフロントエンドで行っていない。既存の `copy_files` も同様なので一貫性はあるが、UX改善としてフロントエンドバリデーションの追加を検討。バックエンド側のバリデーションは適切に実装済み。 |

---

## Positive Observations

1. **堅牢なセキュリティ設計**: 多層防御（静的パス検証 → 論理パス検証 → symlink解決後再検証 → walk内ターゲット検証）が適切に実装されている
2. **循環symlink保護**: ディレクトリsymlinkは空シェルのみ作成し再帰しない安全設計
3. **完全なパターン踏襲**: 全7フロントエンドファイルが `copy_files` パターンを正確にトレース、漏れなし
4. **適切なリソース管理**: `closeFileAndJoinError` による named return + deferred close + `errors.Join` は堅実
5. **テスタビリティ設計**: `walkDirFn`, `maxCopyDirsFileCount` 等をpackage-level varsにしてテストシーム確保
6. **プロジェクトルール準拠**: エラーはログに記録するが処理を止めない。ログ命名規則 `[WARN-GIT]`, `[DEBUG-GIT]` が統一
7. **十分なテストカバレッジ**: セキュリティケース、エッジケース(空リスト/nil/空ファイル)、budget制限、部分失敗を網羅
8. **フィールド数ガードテスト**: `WorktreeConfig` のフィールド数を5にガード更新済み
9. **イベントシステム**: subscribe/unsubscribeの確実なペアリング
10. **副作用なし**: 全関連モジュール（config API、config state、isZeroConfig、Clone）で適切に `CopyDirs` が伝播済み

---

## 並列作業可否表

以下のタスクは独立しているため、並列に修正可能です。

| No | タスク | 対象ファイル | 並列作業 | 依存関係 | 補足 |
|----|--------|-------------|---------|----------|------|
| 1 | I-1: Budget制限のスコープ明確化（コメント/変数名修正 or グローバル化） | `app_worktree_api.go` | ✅ 可能 | なし | コメント修正のみなら安全。グローバル化は S-6 と同時に行うと効率的 |
| 2 | I-2: コピー失敗時の不完全ファイル削除 | `app_worktree_api.go` | ✅ 可能 | なし | `copyFileByStreaming` 内の変更のみ |
| 3 | S-1: symlinkログレベル変更 | `app_worktree_api.go` | ✅ 可能 | なし | 1行変更 |
| 4 | S-2: symlink先の非正規ファイルチェック追加 | `app_worktree_api.go` | ✅ 可能 | なし | `handleSymlinkInWalk` 内の変更のみ |
| 5 | S-3: TOCTOU間のDEBUGログ追加 | `app_worktree_api.go` | ✅ 可能 | なし | 1行追加 |
| 6 | S-4: Sync追加検討 | `app_worktree_api.go` | ✅ 可能 | なし | 任意（best-effort操作のため） |
| 7 | S-5: unsafe パスの failure 報告 | `app_worktree_api.go` | ⚠️ 注意 | テスト修正必要 | `return false` → `return true` にすると既存テストの期待値変更が必要 |
| 8 | S-6: 入口バリデーション共通化 | `app_worktree_api.go` | ⚠️ 注意 | S-5 と依存 | S-5 完了後に着手が安全 |
| 9 | S-7: `copyFileByStreaming` テスト追加 | `app_worktree_api_test.go` | ✅ 可能 | なし | 新規テスト追加のみ |
| 10 | S-8: `closeFileAndJoinError` テスト追加 | `app_worktree_api_test.go` | ✅ 可能 | なし | 新規テスト追加のみ |
| 11 | S-9: `reserveCopyWalkBudget` 境界値テスト追加 | `app_worktree_api_test.go` | ✅ 可能 | なし | 新規テスト追加のみ |
| 12 | S-10: `handleSymlinkInWalk` 追加テスト | `app_worktree_api_test.go` | ✅ 可能 | なし | 新規テスト追加のみ |
| 13 | S-11: フロントエンドバリデーション追加 | `WorktreeSettings.tsx` | ✅ 可能 | なし | 独立したUI変更 |

### 並列作業グルーピング推奨

```
グループA（プロダクションコード修正 — app_worktree_api.go）:
  ├── 作業者1: I-1 + I-2 + S-4（budget/streaming関連）
  ├── 作業者2: S-1 + S-2 + S-3（symlink/ログ関連）
  └── 作業者3: S-5 + S-6（バリデーション共通化 — 順序依存あり）

グループB（テスト追加 — app_worktree_api_test.go）:
  ├── 作業者4: S-7 + S-8（streaming/close テスト）
  └── 作業者5: S-9 + S-10（budget/symlink テスト）

グループC（フロントエンド）:
  └── 作業者6: S-11（バリデーション追加）
```

**注意**: グループA の S-5（unsafe パスの failure 報告変更）を実施する場合、グループB の既存テスト期待値にも影響するため、A→B の順序を守ること。

---

## Recommended Action

1. **Important Issues（I-1, I-2）を優先対応** — I-1 は設計判断を確認の上、コメント/変数名を明確化するか実装を変更。I-2 は不完全ファイル削除を追加。
2. **Suggestion S-1〜S-6 を検討** — 特に S-2（symlink先の型チェック）は防御的コーディングとして効果的。
3. **テスト追加（S-7〜S-10）** — コアロジック（`copyFileByStreaming`, `closeFileAndJoinError`）の単独テストは品質保証に寄与。
4. **修正完了後に再レビュー実施** — テスト追加後に `go test ./...` で回帰なしを確認。
