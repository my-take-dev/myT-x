# PR Review Summary - copy_dirs 機能追加

**レビュー日時**: 2026-02-17 08:08  
**対象ブランチ**: HEAD (未コミット変更)  
**変更規模**: 16ファイル, +1,585行 / -70行

## 変更概要

worktree作成時にリポジトリルートから設定されたディレクトリを再帰的にコピーする `copy_dirs` 機能を追加。

### 変更ファイルカテゴリ

| カテゴリ | ファイル | 変更量 |
|---------|---------|--------|
| **Backend Go実装** | `app_worktree_api.go` | +450行 |
| **Backend Goテスト** | `app_worktree_api_test.go` | +1,002行 |
| **Config層** | `config.go`, `config_test.go`, `config.yaml` | +53行 |
| **Frontend** | `SettingsModal.tsx`, `WorktreeSettings.tsx`, `settingsReducer.ts`, `settingsValidation.ts`, `types.ts`, `useBackendSync.ts`, `tmux.ts`, `models.ts` | +117行 |
| **ドキュメント/設定** | `CLAUDE.md`, `develop-README.md`, `.claude/settings.local.json` | +31行 |

---

## レビュー結果一覧

### Critical Issues (0件)

重大な問題は検出されませんでした。

---

### Important Issues (6件)

#### IMP-1: `copyFileByStreaming` の defer 実行順序によるファイル誤削除リスク

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api.go` (`copyFileByStreaming` 関数) |
| **レビュー担当** | code-reviewer, silent-failure-hunter |
| **深刻度** | Important |
| **説明** | deferのLIFO実行順序により、`syncFileFn` 成功後に `dstFile.Close()` が失敗した場合、`retErr` が非nilとなり、正常にsyncされたファイルが `os.Remove(dstPath)` で削除される。Windows上ではアンチウイルスのロック等でclose失敗が起こりうる |
| **修正案** | sync成功フラグを導入し、sync済みファイルは削除しない |

```go
// 修正案:
func copyFileByStreaming(srcPath, dstPath string) (retErr error) {
    // ...省略...
    var synced bool
    defer func() {
        if retErr == nil || synced {
            return
        }
        if removeErr := os.Remove(dstPath); removeErr != nil && !os.IsNotExist(removeErr) {
            retErr = errors.Join(retErr, fmt.Errorf("remove partial destination file: %w", removeErr))
        }
    }()
    defer closeFileAndJoinError(dstFile, "destination file", &retErr)

    // ...copy...
    if syncErr := syncFileFn(dstFile); syncErr != nil {
        return fmt.Errorf("sync destination file: %w", syncErr)
    }
    synced = true
    return nil
}
```

---

#### IMP-2: `copyConfigDirToWorktree` が未使用のデッドコード

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api.go` (`copyConfigDirToWorktree` 関数) |
| **レビュー担当** | code-reviewer, test-analyzer, code-simplifier |
| **深刻度** | Important |
| **説明** | `copyConfigDirToWorktree` はローカルバジェットを作成して `copyConfigDirToWorktreeWithBudget` を呼ぶラッパーだが、プロダクションコード・テストコードのいずれからも呼び出されていない。`copyConfigDirsToWorktree` は直接 `copyConfigDirToWorktreeWithBudget` を呼んでいる |
| **修正案** | 関数を削除する |

---

#### IMP-3: `copyFileInWalk` で `os.IsNotExist` を未チェック — `copyConfigFileToWorktree` と不一致

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api.go` (`copyFileInWalk` 関数) |
| **レビュー担当** | silent-failure-hunter |
| **深刻度** | Important |
| **説明** | `copyConfigFileToWorktree` はコピー時の `os.IsNotExist` をサイレントスキップ（TOCTOU消失対応）するが、`copyFileInWalk` はすべてのエラーを `hadError = true` として扱う。Walk中にファイルが消えた場合にユーザーへ不要な通知が発生する |
| **修正案** | `copyFileInWalk` にも `os.IsNotExist` チェックを追加し、TOCTOU消失時はDEBUGログ + skip に統一する |

```go
// copyFileInWalk 内:
if copyErr := copyFileByStreaming(srcPath, dstPath); copyErr != nil {
    if os.IsNotExist(copyErr) {
        slog.Debug("[DEBUG-GIT] source file disappeared during copy_dirs walk, skipping",
            "src", srcPath, "dst", dstPath)
        return nil
    }
    slog.Warn("[WARN-GIT] failed to copy file in copy_dirs", ...)
    *hadError = true
}
```

---

#### IMP-4: フロントエンドの per-item バリデーションエラーキーがUIに表示されない

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/frontend/src/components/settings/settingsValidation.ts`, `WorktreeSettings.tsx` |
| **レビュー担当** | frontend-reviewer, silent-failure-hunter |
| **深刻度** | Important |
| **説明** | `validateWorktreeCopyPathSettings` は `wt_copy_files_0`, `wt_copy_dirs_1` のようなアイテム単位のエラーキーを生成するが、`WorktreeSettings.tsx` の `DynamicStringList` は個別エラーを表示するインターフェースを持たない。サマリーエラー（`wt_copy_files`, `wt_copy_dirs`）のみ表示され、どの行が不正かユーザーに伝わらない |
| **修正案** | A) `DynamicStringList` に per-item エラー表示 prop を追加 or B) per-item キー生成をやめてカウントだけ管理 |

---

#### IMP-5: テストカバレッジ不足 — `copyFileByStreaming` のソースopen権限エラーパス

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api_test.go` |
| **レビュー担当** | test-analyzer |
| **深刻度** | Important |
| **説明** | `copyFileByStreaming` で `os.Open` が `IsNotExist` **でない**エラー（パーミッションエラー等）を返す分岐がテストされていない。`fmt.Errorf("open source file: %w", openSrcErr)` のラップ |
| **修正案** | パーミッションエラーのテストケースを追加 |

---

#### IMP-6: テストカバレッジ不足 — `copyFileByStreaming` の部分ファイル削除失敗時の `errors.Join`

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api_test.go` |
| **レビュー担当** | test-analyzer |
| **深刻度** | Important |
| **説明** | defer 内で `os.Remove(dstPath)` が失敗した場合に `errors.Join` でエラーを結合するパスがテストされていない。エラー結合ロジックの正確性が検証不能 |
| **修正案** | テストを追加して `errors.Join` によるエラー結合を検証 |

---

### Suggestions (11件)

#### SUG-1: `reserveCopyWalkBudget` のint64オーバーフロー防御

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api.go` (`reserveCopyWalkBudget`) |
| **説明** | `nextTotalSize := budget.totalSize + fileSize` で理論上int64オーバーフローが発生しうる（実運用上は500MB上限で安全） |
| **修正案** | `if fileSize > maxCopyDirsTotalBytes-budget.totalSize` に変更 |

#### SUG-2: `handleSymlinkInWalk` でsymlinkedディレクトリのスキップログレベル向上

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api.go` (`handleSymlinkInWalk`) |
| **説明** | ディレクトリsymlinkの内容が空シェルのみ作成される事実が DEBUG レベルのため、問題切り分けが困難 |
| **修正案** | INFO レベルのログを追加 |

#### SUG-3: `hadError` コメントの修正

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api.go` |
| **説明** | `hadError is write-once` は不正確。実際は「単調増加（monotonically true）」 |
| **修正案** | コメントを `hadError tracks whether any error occurred during walk (monotonically set to true)` に修正 |

#### SUG-4: テスト — `validateAndResolveSourceEntry` の `cleaned == "."` ケース

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api_test.go` |
| **説明** | `copyConfigDirsToWorktree(repo, wt, []string{"."})` のテストがない |

#### SUG-5: テスト — `copyConfigDirToWorktreeWithBudget` の `budget == nil` 防御パス直接テスト

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api_test.go` |
| **説明** | nil budget フォールバックの直接テストが不足 |

#### SUG-6: テスト — `copyFileInWalk` のコピー失敗パス（hadError設定）

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api_test.go` |
| **説明** | `TestCopyFileInWalkOverwritesExistingDestinationFile` は成功パスのみ。失敗時の `*hadError = true` 設定テストが無い |

#### SUG-7: テスト — 共有サイズバジェットのディレクトリ間テスト

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api_test.go` |
| **説明** | ファイル数の共有バジェットテストはあるが、**サイズ**の共有バジェットテストがない |

#### SUG-8: テスト — `handleSymlinkInWalk` の非正規ファイル（device/socket）へのシムリンク

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api_test.go` |
| **説明** | `!linkInfo.Mode().IsRegular()` 分岐のテストがない |

#### SUG-9: テスト — `walkDirFn` オーバーライドテストの脆弱性

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/app_worktree_api_test.go` |
| **説明** | `marks failure when walk callback reports error` テストの `walkDirFn` モックが約50行と複雑で、walk順序に密結合 |

#### SUG-10: `isUnsafeWorktreeCopyPath` の false positive（`subdir/../other`）

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/frontend/src/components/settings/settingsValidation.ts` |
| **説明** | `subdir/../other` のような有効パスがフロントだけで弾かれる（バックエンドは `filepath.Clean` で正規化後チェック）。安全側の不整合なので実害なし |

#### SUG-11: `TestDefaultConfigWorktreeDefaults` のアサーション非対称性

| 項目 | 内容 |
|------|------|
| **ファイル** | `myT-x/internal/config/config_test.go` |
| **説明** | `CopyFiles` は `len()` のみだが、`CopyDirs` は `nil` + `len()` チェック。`CopyDirs` 側の方が正しいので、`CopyFiles`/`SetupScripts` も揃えると一貫性が向上 |

---

### Strengths（良い点）

1. **多層防御のセキュリティ設計**: パストラバーサル防御が5段構成（`filepath.Clean` → `IsAbs` → `".."` → `isPathWithinBase` → `EvalSymlinks` + 再検証）
2. **共通抽象化（`copyConfigEntriesToWorktree`）**: ファイル/ディレクトリのコピーロジックをコールバックパターンで適切に共通化（SOLID: OCP適合）
3. **バジェット制御**: 10,000ファイル / 500MBの上限をディレクトリ横断で共有管理し、リソース枯渇を防止
4. **ストリーミングコピー移行**: `os.ReadFile` + `os.WriteFile` → `io.Copy` でメモリ使用量 O(fileSize) → O(bufferSize) に改善
5. **テストシーム設計**: `walkDirFn`, `streamCopyFn`, `syncFileFn` のvar関数化でテスト容易性確保
6. **Config層の完全な伝播**: struct定義、DefaultConfig、Clone、applyDefaultsAndValidate、Save/Load、テスト、YAML、README更新 — 全箇所を漏れなくカバー
7. **フロントエンドの対称的な実装**: 既存 `copy_files` パターンを忠実に踏襲し、型・状態管理・イベント・バリデーション・クリーンアップが完備
8. **1,000行超のテスト**: セキュリティテスト、ロールバックテスト、テーブル駆動テスト、境界値テストが充実
9. **`errors.Join` パターン**: closeエラーがメインエラーをマスクしない堅実なGoイディオム
10. **不完全ファイルのクリーンアップ**: エラー時に壊れたファイルを残さないdefer設計

---

## 修正タスク一覧と並列作業可否

以下の表は、各タスクの独立性と並列作業の可否を示しています。

| No | タスクID | 内容 | 対象ファイル | 優先度 | 並列作業 | 依存関係 | 備考 |
|----|---------|------|------------|--------|---------|---------|------|
| 1 | IMP-1 | `copyFileByStreaming` のsync済みファイル誤削除防止 | `app_worktree_api.go` | 高 | ✅可 | なし | sync成功フラグ追加のみ。他の修正に影響しない |
| 2 | IMP-2 | 未使用 `copyConfigDirToWorktree` の削除 | `app_worktree_api.go` | 高 | ✅可 | なし | 関数削除のみ。呼び出し元がないため影響なし |
| 3 | IMP-3 | `copyFileInWalk` に `os.IsNotExist` チェック追加 | `app_worktree_api.go` | 高 | ✅可 | なし | copyFileInWalk内の分岐追加のみ |
| 4 | IMP-4 | per-item エラーの方針決定（表示 or 削除） | `settingsValidation.ts`, `WorktreeSettings.tsx` | 中 | ✅可 | なし | フロントエンドのみ。バックエンド修正と独立 |
| 5 | IMP-5 | テスト追加: ソースopen権限エラー | `app_worktree_api_test.go` | 中 | ✅可 | なし | 新テスト追加。既存コードに変更なし |
| 6 | IMP-6 | テスト追加: 部分ファイル削除失敗の`errors.Join` | `app_worktree_api_test.go` | 中 | ⚠️条件付き | IMP-1後推奨 | IMP-1の修正でdefer順序が変わる場合、テスト期待値に影響 |
| 7 | SUG-1 | int64オーバーフロー防御 | `app_worktree_api.go` | 低 | ✅可 | なし | 1行変更。他に影響なし |
| 8 | SUG-2 | symlinkedディレクトリのログレベル向上 | `app_worktree_api.go` | 低 | ✅可 | なし | ログ追加のみ |
| 9 | SUG-3 | `hadError` コメント修正 | `app_worktree_api.go` | 低 | ✅可 | なし | コメント変更のみ |
| 10 | SUG-4 | テスト追加: `"."` エントリ | `app_worktree_api_test.go` | 低 | ✅可 | なし | 新テスト追加 |
| 11 | SUG-5 | テスト追加: nil budget 直接テスト | `app_worktree_api_test.go` | 低 | ✅可 | なし | 新テスト追加 |
| 12 | SUG-6 | テスト追加: copyFileInWalk 失敗パス | `app_worktree_api_test.go` | 低 | ⚠️条件付き | IMP-3後推奨 | IMP-3のIsNotExist追加で期待動作が変わる |
| 13 | SUG-7 | テスト追加: 共有サイズバジェット | `app_worktree_api_test.go` | 低 | ✅可 | なし | 新テスト追加 |
| 14 | SUG-8 | テスト追加: 非正規symlink target | `app_worktree_api_test.go` | 低 | ✅可 | なし | 新テスト追加 |
| 15 | SUG-11 | テスト: DefaultConfig アサーション統一 | `config_test.go` | 低 | ✅可 | なし | テスト修正のみ |

### 並列作業グループ

```
グループA（バックエンド修正 — 並列OK）:
  ├── IMP-1: copyFileByStreaming sync済みフラグ
  ├── IMP-2: デッドコード削除
  ├── IMP-3: copyFileInWalk IsNotExist
  ├── SUG-1: int64オーバーフロー防御
  ├── SUG-2: ログレベル向上
  └── SUG-3: コメント修正

グループB（フロントエンド修正 — グループAと並列OK）:
  └── IMP-4: per-item エラー方針決定

グループC（テスト追加 — IMP-1, IMP-3 完了後）:
  ├── IMP-5: ソースopen権限エラーテスト
  ├── IMP-6: errors.Join テスト（IMP-1後）
  ├── SUG-4〜8: 各種テスト追加
  ├── SUG-11: DefaultConfig テスト統一
  └── SUG-6: copyFileInWalk失敗テスト（IMP-3後）
```

### 推奨作業順序

```
1. グループA + グループB を並列実行
2. グループA完了後、グループCを実行
```

---

## 最終結論

| 分類 | 件数 |
|------|------|
| Critical Issues | 0件 |
| Important Issues | 6件（実装3件 + テスト2件 + フロントエンド1件） |
| Suggestions | 11件（実装3件 + テスト6件 + フロントエンド1件 + Config1件） |
| Positive Observations | 10件 |

**総合判定**: 高品質な実装。セキュリティ、コード設計、テストカバレッジすべてにおいて水準が高い。ImportantレベルのIMP-1（sync済みファイル誤削除）は実質的リスクが最も高く、優先対応を推奨。IMP-2（デッドコード）は一目で判断・修正可能。IMP-3（TOCTOU一貫性）は動作上の不整合の修正。
