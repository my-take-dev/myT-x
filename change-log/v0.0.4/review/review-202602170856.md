# PR Review Summary — copy_dirs 機能追加

**レビュー日時**: 2026-02-17 08:56
**対象**: myT-x/ 配下の未コミット変更（17ファイル, +1941/-100行）
**機能概要**: worktree作成時にリポジトリからディレクトリを再帰的にコピーする `copy_dirs` 機能の追加

---

## 変更ファイル一覧

| カテゴリ | ファイル | 変更量 |
|---------|--------|-------|
| Backend Go (App層) | app_worktree_api.go | +461 |
| Backend Go (App層テスト) | app_worktree_api_test.go | +1262 |
| Backend Go (Config層) | internal/config/config.go | +8/-1 |
| Backend Go (Config層テスト) | internal/config/config_test.go | +52 |
| Frontend (設定UI) | frontend/src/components/SettingsModal.tsx | +10/-1 |
| Frontend (設定UI) | frontend/src/components/settings/DynamicStringList.tsx | +62 |
| Frontend (設定UI) | frontend/src/components/settings/WorktreeSettings.tsx | +45 |
| Frontend (設定UI) | frontend/src/components/settings/settingsReducer.ts | +2 |
| Frontend (設定UI) | frontend/src/components/settings/settingsValidation.ts | +76 |
| Frontend (設定UI) | frontend/src/components/settings/types.ts | +1 |
| Frontend (イベント) | frontend/src/hooks/useBackendSync.ts | +16 |
| Frontend (CSS) | frontend/src/styles/settings.css | +6 |
| Frontend (型定義) | frontend/src/types/tmux.ts | +1/-1 |
| Frontend (Wails生成) | frontend/wailsjs/go/models.ts | +7/-1 |
| Config | config.yaml | +1 |
| Docs | develop-README.md | +15 |

---

## Critical Issues（0件）

なし

---

## Important Issues（3件）

### I-1. ディレクトリ作成時のsymlink解決チェック欠如
- **対象**: [app_worktree_api.go](myT-x/app_worktree_api.go) — `copyConfigDirToWorktreeWithBudget` 内 `d.IsDir()` 分岐、および `handleSymlinkInWalk` 内ディレクトリシェル作成
- **内容**: walk中のディレクトリ作成で `os.MkdirAll(targetPath, 0o755)` を呼ぶ際、ファイルコピーパスで行われている `EvalSymlinks` + `isPathWithinBase` の事後検証が行われていない。worktree内の中間パスにsymlinkが存在する場合、`MkdirAll` がsymlinkを追跡してworktree外にディレクトリを作成する可能性がある。
- **影響**: worktreeは新規作成直後であり、configは信頼されたソースからのため実質リスクは低いが、ファイルコピーパスとの防御深度の不一致がある。
- **推奨修正**: `ensureDirWithinBase(targetPath, wtBase)` ヘルパーを作成し、`MkdirAll` → `EvalSymlinks` → `isPathWithinBase` のチェックを実行する。該当箇所は2箇所。

### I-2. validateCopyDestination の非正規・非symlinkノード処理
- **対象**: [app_worktree_api.go](myT-x/app_worktree_api.go) — `validateCopyDestination` 関数
- **内容**: 宛先が既存のディレクトリ（symlinkでも通常ファイルでもない）の場合、関数は `(true, false)` を返してコピーを続行する。`copyFileByStreaming` はOS レベルの "is a directory" エラーで失敗し、紛らわしいエラーメッセージになる。
- **推奨修正**: `info.IsDir()` のガードを追加し、ディレクトリが宛先に存在する場合は明確なWARNログを出力してスキップする。

### I-3. settingsValidation.ts のパス正規化関数にユニットテスト未作成
- **対象**: [settingsValidation.ts](myT-x/frontend/src/components/settings/settingsValidation.ts)
- **内容**: `normalizeRelativePath` と `isUnsafeWorktreeCopyPath` はセキュリティ関連のパスバリデーションロジックだが、エクスポートされておらず直接テストされていない。`foo/bar/../../..`, `./././../x`, `foo/..` 等のエッジケースのリグレッション検知が弱い。
- **推奨修正**: 関数をエクスポートするか、`validateWorktreeCopyPathSettings` を通じたテストケースで境界値パターンを網羅する。

---

## Suggestions（10件）

### S-1. 空エントリ時の早期リターン
- **対象**: [app_worktree_api.go](myT-x/app_worktree_api.go) — `copyConfigEntriesToWorktree`
- **内容**: `entries` が空/nilの場合でも `resolveSymlinkEvaluatedBasePath` が2回呼ばれる。`if len(entries) == 0 { return nil }` の早期リターンで不要なsyscallを削減可能。

### S-2. 戻り値の二重boolean を tri-state enum へ置換
- **対象**: [app_worktree_api.go](myT-x/app_worktree_api.go) — `validateAndResolveSourceEntry`, `validateCopyDestination`
- **内容**: `(canProcess, failed bool)` と `(canWrite, failed bool)` はtri-state（skip/ok/fail）を2つのboolで表現。呼び出し側で `if failed → if !canProcess` の2段チェックが必要で可読性が低い。
- **推奨**: `copyResult` 型（`copySkip`, `copyOK`, `copyFail`）で一元化。

### S-3. configKey/fieldKey をログコンテキスト構造体に統合
- **対象**: [app_worktree_api.go](myT-x/app_worktree_api.go) — 複数関数
- **内容**: `configKey` と `fieldKey` が3関数にわたってパラメータとして伝搬。常に固定ペア（`"copy_files","file"` or `"copy_dirs","dir"`）。構造体にまとめることで引数を削減。

### S-4. hadError と budget を walkState 構造体に統合
- **対象**: [app_worktree_api.go](myT-x/app_worktree_api.go) — `handleSymlinkInWalk`, `copyFileInWalk`, `reserveCopyWalkBudget`
- **内容**: `*bool` hadError パターンと `*copyWalkBudget` が常にセットで渡される。walkState構造体に統合すれば、nilガード不要、引数3つ削減。

### S-5. コピー先ファイルのパーミッションに関するコメント追加
- **対象**: [app_worktree_api.go](myT-x/app_worktree_api.go) — `copyFileByStreaming`
- **内容**: 宛先ファイルは常に `0o600` で作成。ソースの実行ビット等は保持されない。Windowsでは実質影響なしだが、将来のLinux/macOS対応を見据えたコメントがあると良い。

### S-6. テストseam変数の並列テスト非安全性に関するコメント
- **対象**: [app_worktree_api.go](myT-x/app_worktree_api.go) — パッケージレベルvar群
- **内容**: `walkDirFn`, `streamCopyFn` 等のグローバルtest seamは `t.Parallel()` と併用すると不安定。各テストの `t.Cleanup` で復元されているが、並列テスト禁止の明示コメントがあると安全。

### S-7. 重複パス検出の追加（Frontend）
- **対象**: [settingsValidation.ts](myT-x/frontend/src/components/settings/settingsValidation.ts)
- **内容**: copyFiles/copyDirs内の重複パスや両リスト間の重複を検出していない。バックエンドは重複を安全に処理するが、UX改善として警告表示が望ましい。

### S-8. 不足テスト: statFileInfoFn の非NotExistエラー
- **対象**: [app_worktree_api_test.go](myT-x/app_worktree_api_test.go)
- **内容**: `handleSymlinkInWalk` で `statFileInfoFn(resolvedLink)` がpermission deniedなど非NotExistエラーを返すケースのテストが未作成。

### S-9. 不足テスト: 単一大ファイルのバジェット超過
- **対象**: [app_worktree_api_test.go](myT-x/app_worktree_api_test.go)
- **内容**: 空のバジェットに対して `maxCopyDirsTotalBytes` を超える単一ファイルのテストケースがない。`reserveCopyWalkBudget` のテーブルテストで境界値は検証されているが、初回でexactly超過するパターンが欲しい。

### S-10. 不足テスト: フルパスの統合テスト（symlink in real walkDir）
- **対象**: [app_worktree_api_test.go](myT-x/app_worktree_api_test.go)
- **内容**: `handleSymlinkInWalk` は単体テストされているが、`copyConfigDirsToWorktree → walkDir → handleSymlinkInWalk` のフルパスを実際のsymlink付きディレクトリで検証する統合テストが不足。

---

## Positive Observations（強み）

### Backend Go
- **堅牢なバジェットシステム**: 共有 `copyWalkBudget` でファイル数（10,000）とバイトサイズ（500MB）の両面制限。pre-check-before-commitパターンで部分的な会計を防止。
- **正確なdeferスタック**: `copyFileByStreaming` のLIFO defer順序（close dst → cleanup partial → close src）と `synced` フラグの連携が正確。
- **多層セキュリティ**: パスクリーニング → `isPathWithinBase` → `EvalSymlinks` → 再containmentチェック。ソース・デスティネーション両方のsymlinkを個別に検証。
- **優雅な劣化**: ソースファイル消失はDebugレベル、walkエラーは残りのエントリを継続、コピー失敗はsetup scriptsをブロックしない。
- **validateCopyDestination のバグ修正**: symlinkエスケープ時の `(false, false)` → `(false, true)` が正しい方向の修正。

### Config Layer
- **完全なフィールド伝播**: DefaultConfig → Clone → applyDefaultsAndValidate → テストの全経路で `CopyDirs` が正しく追加。
- **フィールド数ガードテスト**: `WorktreeConfig` 4→5 更新済み。将来のフィールド追加漏れを自動検知。
- **既存config互換性**: YAML unmarshalは未知フィールドを無視し、欠落フィールドはデフォルト補完される。

### Frontend
- **一貫したイベントハンドラ**: `copy-dirs-failed` が既存 `copy-files-failed` と同一パターン。
- **型安全性**: FormState → settingsReducer → WorktreeSettings → SettingsModal → models.ts の全層で `copy_dirs`/`wtCopyDirs` が追加。
- **per-item エラー表示**: `DynamicStringList` にオプショナルな `itemErrors` propで個別エラー表示が追加、既存利用箇所は影響なし。

### テスト
- **高いカバレッジ**: 新規テスト約1262行。ディレクトリコピー、symlink処理、バジェット制限、streaming copy、closeFileAndJoinErrorの全パスを網羅。
- **適切な分離**: `t.TempDir()` で完全分離。グローバルtest seamは `t.Cleanup` で復元。
- **Symlink環境対応**: `t.Skipf` でsymlink非サポート環境をスキップ。

---

## タスク一覧と並列作業可否

以下に全指摘事項をタスクとして整理し、並列作業の可否を示します。

| # | 種別 | タスク概要 | 対象ファイル | 他タスクとの依存 | 並列作業 | 優先度 |
|---|------|-----------|-------------|----------------|---------|-------|
| I-1 | Important | MkdirAll後のsymlink解決チェック追加 | app_worktree_api.go | なし | ✅ 可能 | 高 |
| I-2 | Important | validateCopyDestination でディレクトリ宛先ガード追加 | app_worktree_api.go | I-1と同ファイルだが異なる関数 | ⚠️ I-1と同時編集注意 | 高 |
| I-3 | Important | パスバリデーション関数のテスト追加 | settingsValidation.ts + テストファイル | なし | ✅ 可能 | 高 |
| S-1 | Suggestion | 空エントリ早期リターン追加 | app_worktree_api.go | I-1,I-2と同ファイル | ⚠️ 同ファイル編集注意 | 低 |
| S-2 | Suggestion | 二重boolean を tri-state enum へ | app_worktree_api.go | I-1,I-2,S-1と同ファイル | ❌ S-3,S-4と順次 | 中 |
| S-3 | Suggestion | configKey/fieldKey を構造体に統合 | app_worktree_api.go | S-2の後推奨 | ❌ S-2の後 | 中 |
| S-4 | Suggestion | hadError+budget をwalkState構造体に統合 | app_worktree_api.go | S-2,S-3の後推奨 | ❌ S-2,S-3の後 | 中 |
| S-5 | Suggestion | 0o600パーミッションのコメント追加 | app_worktree_api.go | なし | ✅ 可能 | 低 |
| S-6 | Suggestion | test seam並列テスト非安全性コメント追加 | app_worktree_api.go | なし | ✅ 可能 | 低 |
| S-7 | Suggestion | 重複パス検出（Frontend） | settingsValidation.ts | I-3と同ファイル | ⚠️ I-3と同時編集注意 | 低 |
| S-8 | Suggestion | statFileInfoFn非NotExistエラーテスト追加 | app_worktree_api_test.go | なし | ✅ 可能 | 低 |
| S-9 | Suggestion | 単一大ファイルバジェット超過テスト追加 | app_worktree_api_test.go | S-8と同ファイル | ⚠️ S-8と同時編集注意 | 低 |
| S-10 | Suggestion | symlink統合テスト追加 | app_worktree_api_test.go | S-8,S-9と同ファイル | ⚠️ 同ファイル編集注意 | 低 |

### 並列作業グループの推奨

```
グループA（並列可）: I-1 + I-3
  → app_worktree_api.go と settingsValidation.ts で完全独立

グループB（グループA完了後）: I-2
  → I-1と同ファイルの別関数。I-1完了後に着手を推奨

グループC（並列可、任意タイミング）: S-5 + S-6 + S-8
  → コメント追加とテスト追加。他タスクと低依存

グループD（順次実行推奨）: S-2 → S-3 → S-4
  → リファクタリング連鎖。S-2が基盤で後続が依存

グループE（独立、任意タイミング）: S-1, S-7, S-9, S-10
  → 個別に実施可能だが、同ファイル編集タスクとの順序に注意
```

---

**レビュアー**: GitHub Copilot (Claude Opus 4.6)
**レビュー手法**: カテゴリ別並列レビュー（Backend Go error/security, テスト品質, Frontend, Config層, コード簡素化, 副作用/クロスモジュール影響）
