# PR Review Summary

**Date**: 2026-02-17 11:49
**Scope**: myT-x/ 配下のコミット前変更ファイル
**Reviewers**: code-reviewer, silent-failure-hunter, pr-test-analyzer, type-design-analyzer, code-simplifier, comment-analyzer

---

## 変更概要

| ファイル | 変更種別 | 概要 |
|---------|---------|------|
| `cmd/tmux-shim/spec.go` | 修正 | `select-pane` に `-T` フラグ追加、`attach-session` コマンド新規追加 |
| `internal/tmux/command_router.go` | 修正 | `attach-session` ハンドラ登録、アライメント変更 |
| `internal/tmux/command_router_handlers_pane.go` | 修正 | `handleSelectPane` に `-T`（タイトル設定）処理追加 |
| `internal/tmux/command_router_handlers_session.go` | 修正 | `handleAttachSession` 新規追加 |
| `cmd/tmux-shim/main_test.go` | 修正 | パーサーテスト追加（select-pane -T, attach-session） |
| `internal/tmux/command_router_handlers_session_test.go` | 新規 | ハンドラE2Eテスト（select-pane -T, attach-session） |

---

## Critical Issues (0件)

なし

---

## Important Issues (5件)

### I-1. テストファイル配置の不整合
- **指摘元**: pr-test-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_session_test.go`
- **内容**: `TestHandleSelectPaneTitle` は `handleSelectPane`（`command_router_handlers_pane.go` 定義）のテストだが、`command_router_handlers_session_test.go` に配置されている。`command_router_handlers_pane_test.go` が既に存在するため、そちらに移動すべき。
- **推奨修正**: `TestHandleSelectPaneTitle` を `command_router_handlers_pane_test.go` に移動する。

### I-2. ログプレフィックスの不統一
- **指摘元**: comment-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_pane.go` (L245)
- **内容**: `-T` フラグ失敗時のログが `[select-pane]` だが、プロジェクト全体では `[DEBUG-*]` プレフィックスで統一されている。`grep -r "\[DEBUG-"` で一括検索・削除可能にするために統一が必要。
- **推奨修正**: `[select-pane]` → `[DEBUG-SELECTPANE]` に変更。同ファイルL161の `[split-window]` も同様の問題あり（既存課題）。

### I-3. `tmux:pane-renamed` イベントのペイロード検証不足
- **指摘元**: pr-test-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_session_test.go`
- **内容**: `TestHandleSelectPaneTitle` で `tmux:pane-renamed` イベントの発行有無は検証しているが、ペイロード（`sessionName`, `paneId`, `title`）の値は検証していない。フロントエンド連携上、ペイロードの正当性検証が望ましい。
- **推奨修正**: イベントペイロードの各フィールド値をアサートするテストを追加。

### I-4. `tmux:pane-focused` イベントのアサーション不足
- **指摘元**: pr-test-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_session_test.go`
- **内容**: `handleSelectPane` は `-T` 処理後に常に `tmux:pane-focused` イベントも発行するが、テストではこのイベントの検証がない。特に empty title ケースでは `pane-renamed` なし・`pane-focused` のみの挙動検証が不足。
- **推奨修正**: `wantFocusEvent` フィールドを追加し、`tmux:pane-focused` の発行も検証する。

### I-5. `RenamePane` 失敗パスのテスト不足
- **指摘元**: pr-test-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_session_test.go`
- **内容**: `-T` フラグで `RenamePane` がエラーを返した場合（ベストエフォートでログのみ出力し、コマンドは成功を返す）のテストパスが存在しない。
- **推奨修正**: RenamePane失敗条件のテストケースを追加（例: 無効なペインIDへのRename）。

---

## Suggestions (11件)

### S-1. `handleAttachSession` にドキュメントコメント追加
- **指摘元**: code-simplifier, comment-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_session.go` (L132)
- **内容**: tmux本来の `attach-session` とは動作が大きく異なる（ターミナルアタッチではなくウィンドウアクティベーションのみ）。意図を明示するコメントがあると保守性が向上する。
- **改善案**: `// handleAttachSession activates the app window for the target session. Unlike tmux attach-session, it does not create a new client connection.`

### S-2. ログプレフィックスのカテゴリ整合性
- **指摘元**: comment-analyzer, silent-failure-hunter
- **ファイル**: `internal/tmux/command_router_handlers_session.go` (L141)
- **内容**: `handleAttachSession` の `[DEBUG-IPC]` は `handleActivateWindow`（window系）と同じだが、同ファイルの他ハンドラは `[DEBUG-SESSION]` を使用。セッション操作としてのドメイン的な一貫性を検討。
- **改善案**: `[DEBUG-IPC]` → `[DEBUG-SESSION]` に変更。

### S-3. `handleAttachSession` で `session:window` 形式のテスト
- **指摘元**: pr-test-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_session_test.go`
- **内容**: パーサーテストでは `"president:0"` 形式をテスト済みだが、ハンドラテストでは `session:window` 形式のターゲットでの `HasSession` 挙動テストがない。
- **改善案**: `target: "multiagent:0"` のテストケースを追加。

### S-4. `TestParseCommandAttachSession` に `-t` なしケース追加
- **指摘元**: pr-test-analyzer
- **ファイル**: `cmd/tmux-shim/main_test.go`
- **内容**: `attach-session` のパーサーテストに `-t` フラグなしの異常系がない。
- **改善案**: `{name: "attach-session without -t", args: []string{"attach-session"}, wantErr: true}` を追加。

### S-5. アライメントの統一
- **指摘元**: code-simplifier, code-reviewer
- **ファイル**: `internal/tmux/command_router.go` (L141-L146)
- **内容**: ハンドラマップで `display-message` 以降のアライメントが2スペースで、他エントリは4スペース。gofmt結果であれば受け入れ可。
- **改善案**: 全エントリのアライメントを揃える（longest key に合わせる or 全て1スペース）。

### S-6. `okResp("")` vs `okResp("ok\n")` の応答不整合
- **指摘元**: type-design-analyzer, comment-analyzer
- **ファイル**: `command_router_handlers_session.go` vs `command_router_handlers_window.go`
- **内容**: `handleAttachSession` は `okResp("")` 、`handleActivateWindow` は `okResp("ok\n")` 。同じ `app:activate-window` イベントを発行するが応答が異なる。tmux互換では `okResp("")` が正しいが、意図的な差異ならコメントで補足を。

### S-7. `-T` フラグの空白トリミングテスト
- **指摘元**: pr-test-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_session_test.go`
- **内容**: `RenamePane` 内部で `strings.TrimSpace(title)` が行われるが、前後空白付きタイトルの挙動テストがない。
- **改善案**: `{name: "whitespace-padded title", title: "  padded  ", wantTitle: "padded"}` を追加。

### S-8. `captureEmitter` のテストヘルパー配置
- **指摘元**: code-simplifier, pr-test-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_window_test.go`
- **内容**: `captureEmitter` は複数テストファイルから参照される共有ヘルパー。`testutil_test.go` への切り出しで所在を明確にできる。
- **改善案**: 現時点では2ファイルからの参照のみのため優先度低。テストファイルが増えた際に対応。

### S-9. `-T` フラグ処理で2回のスナップショットトリガー
- **指摘元**: type-design-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_pane.go`
- **内容**: `-T` 指定時に `tmux:pane-renamed` + `tmux:pane-focused` の2イベントが発行され、各々でスナップショット再発行がトリガーされる。2回目は差分なしで空振りになるため実害はないが、パフォーマンス面で軽微な無駄あり。
- **改善案**: 現時点ではシンプルさ優先で現状維持。パフォーマンス問題顕在化時に対応。

### S-10. `handleAttachSession` の Stderr 内容検証
- **指摘元**: pr-test-analyzer
- **ファイル**: `internal/tmux/command_router_handlers_session_test.go`
- **内容**: エラーケースで `ExitCode == 1` のみ検証。`Stderr` にエラーメッセージが含まれることの検証も追加すると堅牢。
- **改善案**: エラーケースに `wantStderr` フィールドを追加。

### S-11. TOCTOU窓（HasSession → Emit間）
- **指摘元**: silent-failure-hunter
- **ファイル**: `internal/tmux/command_router_handlers_session.go`
- **内容**: `HasSession` 確認後にイベント発行するまでの間にセッション削除される可能性（TOCTOU）。ただし `Emit("app:activate-window")` はウィンドウ活性化のみで冪等、実害なし。
- **改善案**: 現状維持で問題なし。

---

## Positive Observations (10件)

| # | 観点 | 内容 |
|---|------|------|
| P-1 | エラーハンドリング | `-T` の `RenamePane` 失敗時にログ出力のみでエラーにしない設計が tmux-shim ポリシー準拠 |
| P-2 | テスト設計 | 全テストがテーブル駆動パターンで正常系・異常系・Unicode対応を網羅 |
| P-3 | テスト多層化 | パーサーレベル（shim）とハンドラレベル（router）の2層でテスト |
| P-4 | イベント連携 | `tmux:pane-renamed` → `shouldEmitSnapshotForEvent` → スナップショット一元化のパスが完結 |
| P-5 | スナップショット伝播 | `TmuxPane.Title` → `PaneSnapshot.Title` → フロントエンド `PaneSnapshot.title` のデータパス貫通 |
| P-6 | アーキテクチャ | Clean Architecture準拠: `CommandRouter` → `SessionManager`(domain)、`EventEmitter`(interface) |
| P-7 | nil安全性 | `mustString(nil)` は空文字列を返しpanicしない。map未キー参照も安全 |
| P-8 | バリデーション | `handleAttachSession` のバリデーション（空チェック→存在確認→処理）がkillSession/hasSessionと一貫 |
| P-9 | spec整合性 | `commandSpecs` と `commandOrder` の両方に `attach-session` を追加済み |
| P-10 | ファイル分離 | ハンドラがsession/pane/window/displayにファイル分離されており責務が明確 |

---

## タスク一覧と並列作業可否

以下は指摘に基づく修正タスクを整理したものです。各タスクの依存関係と並列実行可否を示します。

### 修正タスク表

| # | 重要度 | タスク | 対象ファイル | 並列作業 | 依存関係 | 備考 |
|---|--------|-------|-------------|----------|---------|------|
| T-1 | Important | `TestHandleSelectPaneTitle` を `command_router_handlers_pane_test.go` に移動 | `*_session_test.go` → `*_pane_test.go` | **可** | なし | ファイル移動のみ。他タスクと独立 |
| T-2 | Important | ログプレフィックス `[select-pane]` → `[DEBUG-SELECTPANE]` に変更 | `command_router_handlers_pane.go` | **可** | なし | 1行の文字列置換。T-4・T-5と同一ファイルだが変更箇所は独立 |
| T-3 | Important | `tmux:pane-renamed` イベントのペイロード検証テスト追加 | `*_pane_test.go` (T-1移動後) | **T-1完了後** | T-1 | T-1でテスト関数がpane_testに移動した後に編集する |
| T-4 | Important | `tmux:pane-focused` イベントの検証をテストに追加 | `*_pane_test.go` (T-1移動後) | **T-1完了後** | T-1, T-3 | T-3と同じテスト関数を編集。T-3と同時編集可 |
| T-5 | Important | `RenamePane` 失敗パスのテストケース追加 | `*_pane_test.go` (T-1移動後) | **T-1完了後** | T-1 | T-1でテスト関数がpane_testに移動した後に編集する |
| T-6 | Suggestion | `handleAttachSession` にドキュメントコメント追加 | `command_router_handlers_session.go` | **可** | なし | 1行コメント追加のみ |
| T-7 | Suggestion | ログプレフィックス `[DEBUG-IPC]` → `[DEBUG-SESSION]` 統一 | `command_router_handlers_session.go` | **可** | T-6と同一ファイルだが箇所が異なり並列可 |
| T-8 | Suggestion | `session:window` 形式のターゲットテスト追加 | `command_router_handlers_session_test.go` | **可** | なし | テストケース追加のみ |
| T-9 | Suggestion | `attach-session` パーサーに `-t` なしテスト追加 | `cmd/tmux-shim/main_test.go` | **可** | なし | テストケース追加のみ |
| T-10 | Suggestion | アライメント統一 | `command_router.go` | **可** | なし | フォーマット変更のみ |
| T-11 | Suggestion | エラーケースの Stderr 検証追加 | `command_router_handlers_session_test.go` | **可** | T-8と同一ファイルだが箇所が異なり並列可 |

### 並列作業グループ

```
【グループA: 即時並列実行可能】
  T-1 (テスト移動)
  T-2 (ログプレフィックス修正)
  T-6 (コメント追加)
  T-7 (ログプレフィックス統一)
  T-8 (session:windowテスト)
  T-9 (パーサーテスト追加)
  T-10 (アライメント統一)
  T-11 (Stderr検証追加)

【グループB: T-1完了後に実行】
  T-3 (ペイロード検証)  ← T-1でファイル移動後
  T-4 (focused検証追加)  ← T-1でファイル移動後（T-3と並列可）
  T-5 (失敗パステスト)  ← T-1でファイル移動後（T-3,T-4と並列可）
```

### 作業優先度まとめ

| 優先度 | タスク | 理由 |
|--------|-------|------|
| **高** (Important) | T-1, T-2 | テスト配置の整合性とログ統一はプロジェクト規約違反 |
| **高** (Important) | T-3, T-4, T-5 | テスト品質向上。T-1の後に実施 |
| **中** (Suggestion) | T-6, T-7 | コメント・ログの保守性向上 |
| **低** (Suggestion) | T-8〜T-11 | テストカバレッジ拡充。余裕があれば対応 |

---

## Recommended Action

1. **Important (T-1, T-2)** を最優先で修正 — テスト配置とログプレフィックスの統一
2. **Important (T-3〜T-5)** を T-1 完了後に修正 — テストのアサーション強化
3. **Suggestion (T-6〜T-11)** は余裕があれば対応 — いずれも機能的バグではない
4. 修正完了後にレビューを再実行して検証
