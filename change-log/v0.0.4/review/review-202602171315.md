# PR Review Summary - 202602171315

## 対象コミット前差分

| ファイル | カテゴリ | 変更概要 |
|---------|---------|---------|
| `myT-x/cmd/tmux-shim/spec.go` | tmux-shim CLI | `select-pane -T` フラグ追加、`attach-session` コマンド追加 |
| `myT-x/cmd/tmux-shim/parse.go` | tmux-shim CLI | `attach-session` の `-t` 必須バリデーション追加 |
| `myT-x/cmd/tmux-shim/main_test.go` | テスト | `TestParseCommandSelectPaneWithTitle`, `TestParseCommandAttachSession` 追加 |
| `myT-x/internal/tmux/command_router.go` | コマンドルーター | `renamePane` フィールド追加、`attach-session` ハンドラ登録 |
| `myT-x/internal/tmux/command_router_handlers_pane.go` | ペインハンドラ | `handleSelectPane` に `-T` タイトル設定機能追加 |
| `myT-x/internal/tmux/command_router_handlers_session.go` | セッションハンドラ | `handleAttachSession` 新規追加 |
| `myT-x/internal/tmux/command_router_handlers_pane_test.go` | テスト | `TestHandleSelectPaneTitle` 追加（5ケース） |
| `myT-x/internal/tmux/command_router_handlers_window_test.go` | テスト | `captureEmitter` を共有ヘルパーに移動 |

**合計: 8ファイル, +289行 / -33行**

---

## レビュー観点

| # | 観点 | エージェント名 |
|---|------|--------------|
| 1 | 一般コード品質・アーキテクチャ・バグ | code-reviewer |
| 2 | テストカバレッジ・テスト品質 | pr-test-analyzer |
| 3 | サイレントフェイル・エラー処理 | silent-failure-hunter |
| 4 | tmux互換性 | tmux-compat-analyzer |
| 5 | コード簡素化・型設計 | code-simplifier / type-design-analyzer |

---

## Strengths（良い点）

1. **テスト容易性の設計**: `renamePane` を関数フィールドとして注入可能にし、テスト時にモック差し替えできる設計
2. **captureEmitter の共有ヘルパー化**: `command_router_test_helpers_test.go` への集約で重複排除
3. **tmux互換の振る舞い**: `attach-session` の stdout 無し、`HasSession` の `session:window` 形式パース対応
4. **DEBUGログ命名規約統一**: `[split-window]` → `[DEBUG-SPLIT]` で `[DEBUG-xxx]` パターンに統一
5. **エラー時の動作**: pane title 設定失敗時にログのみ出力して処理継続（CLAUDE.md 方針準拠）
6. **テストカバレッジ**: `handleAttachSession` は正常系・異常系4ケース、`handleSelectPane -T` は5ケースで網羅的
7. **サイレントフェイル無し**: 全エラーパスで適切にエラー応答 or ログ出力が確認された

---

## Critical Issues (0件)

重大な問題は検出されませんでした。

---

## Important Issues (4件)

### I-1. `select-pane -T` のみの場合にフォーカス変更が発生する
- **観点**: tmux互換性 / コード品質
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_pane.go` L209-L260
- **説明**: tmux では `select-pane -T "title"` を `-t` なしで呼んだ場合、現在のペインのタイトルを変更するだけでフォーカス変更は起こらない。現在の実装では `-t` が空の場合 `resolveDirectionalPane` に入り、方向フラグもなければエラーになる可能性がある。また `-T` のみでもペイン解決に成功すれば `SetActivePane` が呼ばれ、不要な `tmux:pane-focused` イベントが発行される。
- **リスク**: Claude Code が常に `-t` 付きで呼ぶなら実害なし。将来 `-T` 単独を受ける場合は問題になる。
- **修正案**: `-T` フラグのみ指定された場合は、カレントペインを対象としてタイトル変更のみ行い、`SetActivePane` と focused イベント emit をスキップする。

### I-2. `handleAttachSession` テストで `Stdout` が空文字列であることの検証が欠落
- **観点**: テスト品質
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_session_test.go`
- **説明**: 実装コメントに `tmux attach-session does not produce stdout on success` と明記しているが、成功ケースで `resp.Stdout == ""` のアサーションが無い。将来 `okResp` の引数が変更された場合に偽陽性が発生する。
- **修正案**: 成功ケース(`wantExitCode == 0`)に `if resp.Stdout != "" { t.Fatalf(...) }` を追加。

### I-3. `handleAttachSession` テストで空白のみの `-t` フラグのケースが欠落
- **観点**: テスト品質（境界値）
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_session_test.go`
- **説明**: 実装は `strings.TrimSpace` で空白を除去しているが、テストでは `""` のみテスト。`"   "` の入力が正しく `missing required flag` エラーになるかの検証が無い。
- **修正案**: テーブルに `{"whitespace-only target returns error", "multiagent", "   ", 1, "", "missing required flag: -t"}` を追加。

### I-4. `TestParseCommandAttachSession` で `-t` に空白のみを渡すケースが欠落
- **観点**: テスト品質（境界値）
- **ファイル**: `myT-x/cmd/tmux-shim/main_test.go`
- **説明**: `validateRequired` では `strings.TrimSpace` でチェックしているが、パーステストでは `attach-session -t "   "` が正しくバリデーションエラーになるかを検証していない。
- **修正案**: テーブルに `{"attach-session with whitespace-only -t", []string{"attach-session", "-t", "   "}, "", true}` を追加。

---

## Suggestions (8件)

### S-1. `renamePane` フィールドは不要な間接参照（簡素化）
- **ファイル**: `myT-x/internal/tmux/command_router.go` L52, L135
- **説明**: `renamePane` 関数フィールドは `sessions.RenamePane` の間接参照。既に `sessions` フィールドから直接呼べるため冗長。テスト時の差し替え用途だが、nilフォールバックにより `NewCommandRouter` 経由では nil にならない。関数フィールド増殖のリスクもある。
- **修正案**: フィールド削除し `r.sessions.RenamePane(...)` を直接呼ぶ。テスト差し替えは `SessionManager` のモックで対応。

### S-2. `handleAttachSession` と `handleActivateWindow` の応答値の不統一
- **ファイル**: `command_router_handlers_session.go`, `command_router_handlers_window.go`
- **説明**: `handleActivateWindow` → `okResp("ok\n")`、`handleAttachSession` → `okResp("")`。同じイベントを emit するが stdout 形式が異なる。
- **修正案**: 意図的な差異ならコメントで明記。そうでなければ統一。

### S-3. `handleAttachSession` のセッション解決ログ不足
- **ファイル**: `command_router_handlers_session.go` L143
- **説明**: `session:window` 形式の target 渡し時に正規化後のセッション名がログに出ない。
- **修正案**: `slog.Debug` に resolvedSession 情報を追加。

### S-4. `select-pane -T` 処理のメソッド抽出による可読性向上
- **ファイル**: `command_router_handlers_pane.go` L244-L258
- **説明**: `-T` フラグ処理（rename + emit）が13行あり、select-pane の主ロジック中に挟まっている。
- **修正案**: `applyPaneTitle(req, pane, ctx)` のようなメソッドに抽出。

### S-5. `TestHandleSelectPaneTitle` で「-T に明示的空文字列」ケース欠落
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_pane_test.go`
- **説明**: `tt.title == ""` の場合は `flags["-T"]` を設定しない実装。`flags["-T"] = ""` を明示的にセットするケースが未テスト。
- **修正案**: `setEmptyTitle bool` フィールドを追加し、明示的空文字列のケースを追加。

### S-6. イベント発行順序の明示的検証がない
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_pane_test.go`
- **説明**: `rename` → `focus` の順序が実装上重要だが、テストは存在・個数のみ検証。順序入れ替わりを検出できない。
- **修正案**: `captureEmitter` に `EventNames()` ヘルパーを追加し順序を検証。

### S-7. `attach-session` ターゲット `session:window.pane` 形式が未テスト
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_session_test.go`
- **説明**: `multiagent:0` はテスト済みだが `multiagent:0.0` は未テスト。
- **修正案**: テーブルにケース追加。

### S-8. `attach-session` に `-d` フラグが未実装
- **ファイル**: `myT-x/cmd/tmux-shim/spec.go` L107-L113
- **説明**: tmux の `attach-session -d` は他クライアントをデタッチ。Windows シングルウィンドウアプリでは不要だが、Claude Code が `-d` 付きで呼んだ場合パースエラーになる。
- **修正案**: 必要になった場合に追加。現状は低優先度。

---

## テスト実行結果

```
ok  myT-x/cmd/tmux-shim     0.644s
ok  myT-x/internal/tmux     2.335s
```

全テスト通過。

---

## タスク整理表

以下の表は、修正タスクの優先度順に並べたものです。「並列作業可否」は他タスクとの依存関係がなく同時に着手できるかを示します。

| # | 優先度 | タスク概要 | 対象ファイル | 並列作業 | 依存関係 | 備考 |
|---|--------|-----------|-------------|---------|---------|------|
| I-1 | Important | `select-pane -T` 単独使用時のフォーカス変更回避 | `command_router_handlers_pane.go` | ⚠️ 条件付き | S-1, S-4 と関連 | S-1(renamePane削除)と同時着手可能だが、S-4(メソッド抽出)と合わせて行うとコンフリクトの可能性あり |
| I-2 | Important | `handleAttachSession` テストに Stdout 空文字列検証を追加 | `command_router_handlers_session_test.go` | ✅ 可能 | なし | 1行追加のみ |
| I-3 | Important | `handleAttachSession` テストに空白のみ `-t` ケース追加 | `command_router_handlers_session_test.go` | ✅ 可能 | I-2 と同ファイルだが独立セクション | I-2 と同時に着手可能 |
| I-4 | Important | パーステストに空白のみ `-t` ケース追加 | `main_test.go` | ✅ 可能 | なし | 別パッケージ |
| S-1 | Suggestion | `renamePane` フィールド削除（簡素化） | `command_router.go`, `command_router_handlers_pane.go` | ⚠️ 条件付き | I-1 と同時着手でコンフリクト | I-1 と合わせて実施推奨 |
| S-2 | Suggestion | `handleAttachSession` / `handleActivateWindow` 応答値の統一 or コメント追加 | `command_router_handlers_session.go`, `command_router_handlers_window.go` | ✅ 可能 | なし | |
| S-3 | Suggestion | `handleAttachSession` ログに解決済みセッション名を追加 | `command_router_handlers_session.go` | ✅ 可能 | なし | S-2 と同ファイルだが独立箇所 |
| S-4 | Suggestion | `-T` 処理のメソッド抽出 | `command_router_handlers_pane.go` | ⚠️ 条件付き | I-1, S-1 と関連 | I-1 + S-1 完了後に実施推奨 |
| S-5 | Suggestion | テストに明示的空文字列 `-T` ケース追加 | `command_router_handlers_pane_test.go` | ✅ 可能 | なし | |
| S-6 | Suggestion | イベント発行順序の明示的テスト追加 | `command_router_handlers_pane_test.go` | ✅ 可能 | S-5 と同ファイルだが独立 | |
| S-7 | Suggestion | `attach-session` に `session:window.pane` テスト追加 | `command_router_handlers_session_test.go` | ✅ 可能 | I-2, I-3 と同ファイルだが独立 | |
| S-8 | Suggestion | `attach-session -d` フラグ対応検討 | `spec.go` | ✅ 可能 | なし | 将来対応で可 |

### 並列作業グループ

| グループ | タスク | 理由 |
|----------|--------|------|
| **A: pane handler リファクタ** | I-1 + S-1 + S-4 | 同一ファイル・同一関数への変更で、順次作業が安全 |
| **B: session テスト補強** | I-2 + I-3 + S-7 | 同一ファイルだがテーブル内の独立ケース追加。並列可能 |
| **C: shim パーステスト補強** | I-4 | 独立ファイル。他グループと完全に並列可能 |
| **D: session handler 改善** | S-2 + S-3 | ログ・コメント追加のみ。他グループと完全に並列可能 |
| **E: pane テスト補強** | S-5 + S-6 | 同一テストファイル。A グループ完了後が安全 |
| **F: 将来対応** | S-8 | 必要に応じて実施 |

### 推奨作業順序

```
[並列可能] グループ B (I-2, I-3, S-7) + グループ C (I-4) + グループ D (S-2, S-3)
    ↓
[順次推奨] グループ A (I-1 → S-1 → S-4)
    ↓
[並列可能] グループ E (S-5, S-6)
    ↓
[将来] グループ F (S-8)
```
