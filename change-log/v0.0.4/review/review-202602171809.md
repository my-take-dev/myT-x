# PR Review Summary — 2026-02-17 18:09

**対象**: `myT-x/` 配下のコミット前変更（38ファイル、+2,704 / -88 行）

**レビュー方式**: 6並列エージェントによるカテゴリ別レビュー

| カテゴリ | 対象ファイル数 | レビュー観点 |
|---------|:---:|------------|
| App層 (events/snapshot/status) | 8 | コード品質・バグ・設計 |
| tmux-shim (cmd/tmux-shim) | 3 | コード品質・バグ・shim仕様適合 |
| Frontend (React/TypeScript/CSS) | 9 | React設計・型安全・CSS |
| Router & Handlers | 6 | ハンドラ一貫性・TOCTOU・バグ |
| Format/KeyTable/SessionManager | 13 | 並行処理・設計・網羅性 |
| テスト品質・サイレントエラー | 横断 | テスト網羅性・エラーハンドリング |

---

## Critical Issues（1件）

### C-1: [Frontend] state updater 内での副作用（API呼び出し）
- **ファイル**: `myT-x/frontend/src/components/SessionView.tsx` L120付近
- **問題**: `commitWindowRename` の `setRenamingWindowId` state updater 内で `api.RenameWindow` API呼び出し（副作用）を実行している。React 18 StrictMode では updater が2回呼ばれるため、開発モードで API が二重実行される。
- **修正提案**: API 呼び出しを updater の外に移動する。

```tsx
// Before (問題あり): state updater 内で副作用
setRenamingWindowId((prev) => {
  if (prev !== w.id) return prev;
  // API call inside updater — BAD
  const newName = renameValueRef.current.trim();
  if (newName && newName !== w.name) {
    void api.RenameWindow(sessionName, w.id, newName).catch(...);
  }
  return null;
});

// After (修正後): API 呼び出しを外に移動
const commitWindowRename = useCallback((w: WindowSnapshot) => {
  const currentId = renamingWindowId; // or use ref
  if (currentId !== w.id) return;
  setRenamingWindowId(null);
  const newName = renameValueRef.current.trim();
  if (newName && newName !== w.name) {
    void api.RenameWindow(sessionName, w.id, newName).catch(...);
  }
}, [sessionName, renamingWindowId]);
```

---

## Important Issues（13件）

### I-1: [Router] resolveWindowFromRequest のポインタ比較による不安定性
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go` L40付近
- **問題**: `resolveWindowFromRequest` が `w == window` でポインタ比較を使用し、windowスライスインデックスを特定。`ResolveTarget` が返す `*TmuxPane` のポインタが別コピーの場合、ループが一致しない可能性がある。
- **修正提案**: `w.ID == window.ID` のID比較に変更する。

### I-2: [Router] HasSession → GetSession の TOCTOU パターン（複数箇所）
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go` L105, L181付近
- **問題**: `HasSession` → `GetSession` を二段階で呼んでおり、間に `RemoveSession` が介入する可能性（TOCTOU）。
- **修正提案**: `HasSession` を削除し `GetSession` のみで判定する。

### I-3: [Router] handleKillWindow の windowIdx ずれリスク
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go` L156付近
- **問題**: `resolveWindowFromRequest` が返す windowIdx はスライスインデックスだが、その後の `GetSession` とは別ロックスコープ。間に削除が入ると意図しない window を kill する可能性がある。
- **修正提案**: `windowID` ベースで `RemoveWindow` を実行するか、`resolveWindowFromRequest` 内で操作まで完結させる。

### I-4: [Router] splitWindowResolved のロールバック時の競合
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_pane.go` L94付近
- **問題**: `paneLayoutSnapshot` 失敗時の `KillPane` ロールバックで、既に `attachTerminal` 成功済みのため readLoop goroutine との競合が起こりうる。
- **修正提案**: レイアウト取得失敗はログだけにして pane 作成結果を返す方が shim 契約に合致する可能性あり。

### I-5: [Router] handleKillSession のターゲット解析不統一
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_session.go` L107付近
- **問題**: `handleKillSession` が `parseSessionName` を呼ばず target をそのまま `RemoveSession` に渡している。他ハンドラは `parseSessionName` 経由。
- **修正提案**: `handleKillSession` でも `parseSessionName(target)` を通すか統一する。

### I-6: [SessionManager] UnsetSessionEnv の不要なキャッシュ無効化
- **ファイル**: `myT-x/internal/tmux/session_manager_env.go` L111付近
- **問題**: `UnsetSessionEnv` が対象キーの存在有無を確認せず常に `markStateMutationLocked()` を呼ぶ。高頻度呼び出し時に不要なスナップショットキャッシュ無効化が発生。
- **修正提案**: delete 前に存在確認し、存在する場合のみ mutation マーク。

### I-7: [SessionManager] ResolveSessionTarget の内部ポインタ露出
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go` L74付近
- **問題**: 内部の `*TmuxSession` ポインタを RLock 保持中に返し、ロック解放後も外部がアクセス可能。フィールド変更されるとデータ競合リスク。
- **修正提案**: 読み取り専用用途にはクローンを返す方針を検討。

### I-8: [SessionManager] activeWindowInSession のフォールバック時の自己修復なし
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go` L147付近
- **問題**: `ActiveWindowID` に一致するウィンドウが見つからない場合、先頭ウィンドウを返すが `ActiveWindowID` を修正しない。以降の呼び出しで毎回2パスのリニアサーチが発生し続ける。
- **修正提案**: フォールバック時に `session.ActiveWindowID = window.ID` で自己修復する。

### I-9: [SessionManager] SetRootPath の TrimSpace 非対称性
- **ファイル**: `myT-x/internal/tmux/session_manager_env.go` L175付近
- **問題**: `SetRootPath` は TrimSpace せずに格納するが、`GetPaneContextSnapshot` は読み取り時に TrimSpace する。SetWorktreeInfo は `normalizeSessionWorktreeInfo` で入力正規化しているのに不統一。
- **修正提案**: `SetRootPath` 内で `rootPath = strings.TrimSpace(rootPath)` を格納前に適用。

### I-10: [SessionManager] SwapPanes の swapPaneIDsInLayout nil 戻り値未処理
- **ファイル**: `myT-x/internal/tmux/session_manager_pane_lifecycle.go` L65付近
- **問題**: `swapPaneIDsInLayout` の戻り値が nil になる可能性がある。nil が `window.Layout` に代入されると後続スナップショットで問題が起きる。
- **修正提案**: `KillPane` の `killPaneLocked` と同様に `rebuildLayoutFromPaneOrder` へフォールバック。

### I-11: [Frontend] onRemoveWindow に確認ダイアログなし
- **ファイル**: `myT-x/frontend/src/components/SessionView.tsx` L97付近
- **問題**: ウィンドウ削除は全ペインを破棄する破壊的操作だが、確認ステップがない。
- **修正提案**: `window.confirm()` 等の確認ダイアログを追加。

### I-12: [Frontend] models.ts の `?? []` フォールバック削除
- **ファイル**: `myT-x/frontend/wailsjs/go/models.ts` L67付近
- **問題**: `WorktreeConfig` コンストラクタから `?? []` フォールバックが削除された。バックエンドが null 返却時に `setup_scripts`, `copy_files`, `copy_dirs` が undefined になり、`.map()` 等で実行時エラー。
- **修正提案**: auto-generated の場合は Go 側で `omitempty` を調整。手動編集なら `?? []` を復元。

### I-13: [Frontend] App.tsx の `window` 変数名がグローバルをシャドウ
- **ファイル**: `myT-x/frontend/src/App.tsx` L20付近
- **問題**: 変数名 `window` が `globalThis.window` をシャドウしている。
- **修正提案**: `targetWindow` や `activeWindow` に改名。

---

## Suggestions（30件）

### App層

| # | ファイル | 行 | 内容 |
|---|---------|:---:|------|
| S-1 | `app_snapshot_metrics.go` | 68 | `estimateSessionSnapshotSize` のベースサイズ定数 `84` が `ActiveWindowID` 追加分を含んでいない。推定精度に影響。 |
| S-2 | `app_status_test.go` | 123 | `resolveActiveWindowSnapshot` の空スライス入力テスト不足。 |
| S-3 | `app_events.go` | 86 | `shouldEmitSnapshotForEvent` のイベント名列挙順がカテゴリ別に整理されていない。session→window→pane順にグルーピング推奨。 |
| S-4 | `app_snapshot_metrics.go` | 67 | ベースサイズの算出根拠をコメント計算式として残すと保守性向上。 |

### tmux-shim

| # | ファイル | 行 | 内容 |
|---|---------|:---:|------|
| S-5 | `cmd/tmux-shim/spec.go` | 94 | `commandSpecs` と `commandOrder` の同期テスト追加推奨。 |
| S-6 | `cmd/tmux-shim/spec.go` | 162 | `new-window` に `-l` フラグが未定義。使用パターン次第で追加検討。 |
| S-7 | `cmd/tmux-shim/parse.go` | 87 | `kill-window`, `select-window` で `-t` 必須バリデーションなし。設計判断次第。 |
| S-8 | `cmd/tmux-shim/spec.go` | 6 | `commandSpec.name` と map キーの二重化（冗長）。 |
| S-9 | `cmd/tmux-shim/spec.go` | 113 | `resize-pane` に `-U/-D/-L/-R` (方向)、`-Z` (zoom) フラグ未定義。 |
| S-10 | `cmd/tmux-shim/main_test.go` | 1291 | テストに `t.Parallel()` 未使用（純粋関数なので並列化可能）。 |
| S-11 | `cmd/tmux-shim/main_test.go` | 1373 | `rename-session` の空文字リテラル `""` テストケース不足。 |
| S-12 | `cmd/tmux-shim/parse.go` | 30 | `parseCommand` に空スライス防御なし（呼び出し元で保証済みだがテスト用に追加検討）。 |

### Frontend

| # | ファイル | 行 | 内容 |
|---|---------|:---:|------|
| S-13 | `App.tsx` / `SessionView.tsx` | - | アクティブウィンドウ検索ロジックが2ファイルで重複。ユーティリティ関数抽出推奨。 |
| S-14 | `SessionView.tsx` | 113 | `requestAnimationFrame` より callback ref の方が堅実。 |
| S-15 | `layout.css` | 354 | `.window-tab-label` の `max-width: 100px` がハードコード。flex ベースに変更推奨。 |
| S-16 | `SessionView.tsx` | 85 | `onSelectWindow` の依存配列が空。他コールバック (`[sessionName]`) と不統一。 |
| S-17 | `api.ts` / `layout.css` / `tmux.ts` | - | CRLF/LF 改行コード不統一。`.gitattributes` 設定推奨。 |

### Router & Handlers

| # | ファイル | 行 | 内容 |
|---|---------|:---:|------|
| S-18 | `command_router_handlers_window.go` | 96 | `handleNewWindow` で `-t` なし時にカレントセッション解決のフォールバック追加検討。 |
| S-19 | `command_router_handlers_window.go` | 195 | `handleSelectWindow` で `sessionName` 空文字のまま emit 可能。 |
| S-20 | `command_router_handlers_pane.go` | 130 | `handleSplitWindow` と `handleNewWindow` の `-P` なしデフォルト出力の不統一。 |
| S-21 | `command_router_handlers_pane.go` | 297 | `handleListPanes` のソートロジックをヘルパー関数に抽出推奨。 |
| S-22 | `command_router_handlers_session.go` | 55 | `CLAUDE_CODE_AGENT_TYPE` が空文字でも Agent 扱いになる。 |

### テスト品質

| # | ファイル | 行 | 内容 |
|---|---------|:---:|------|
| S-23 | `command_router_handlers_pane_test.go` | - | `handleSendKeys`, `handleListPanes` のテスト未作成。 |
| S-24 | `command_router_handlers_window_test.go` | - | `handleNewWindow` のテスト未作成（ロールバック・`-d/-P` フラグ・send-keys 失敗）。 |
| S-25 | `key_table_test.go` | - | `Tab`, `Escape`, `BSpace` のテスト未作成。 |
| S-26 | `format_test.go` | - | nil pane 入力時の lookupFormatVariable フォールバック未テスト。 |
| S-27 | `session_manager_pane_lifecycle.go` | - | `SwapPanes` のテスト未作成。 |
| S-28 | `session_manager_env_test.go` | - | `SetSessionEnv` / `UnsetSessionEnv` の並行アクセステスト未作成。 |
| S-29 | `app_snapshot_delta_test.go` / `app_snapshot_metrics_test.go` | - | `TmuxSession` フィールド数期待値 `11` が2ファイルで重複定義。 |
| S-30 | `command_router_handlers_pane_test.go` | 97 | 方向フラグ + `-T` フラグの組み合わせテスト未作成。 |

---

## Strengths（良い点）

- **フィールド数ガードテスト**: `TestSnapshotFieldCounts`, `TestSnapshotMetricsFieldCounts` でフィールド追加漏れを自動検知する優れた仕組み
- **コピーセマンティクスの徹底**: `copyEnvMap`, `cloneLayout`, `GetWorktreeInfo`, `cloneSessionForRead` による内部状態の外部漏洩防止
- **ロールバック処理の一貫性**: `rollbackSession`, `rollbackWindow`, `splitWindowResolved` 各所でリソースクリーンアップが確実
- **3層generationトラッキング**: `generation` / `topologyGeneration` / `snapshotGeneration` による細粒度キャッシュ無効化
- **デバッグログ規約統一**: `[DEBUG-*]` プレフィックス統一で開発完了後の一括削除が容易
- **テーブル駆動テストの一貫性**: 全テストファイルで統一されたテーブル駆動テスト構造
- **shim契約の遵守**: send-keys の bootstrap 失敗を best-effort 扱いにし、pane/session 作成を止めない
- **EventEmitter 設計**: `noopEmitter` フォールバック + `captureEmitter` テストヘルパーの優秀な設計
- **Terminal.Close() のロック外実行**: デッドロック回避パターンが全箇所で統一
- **copy-on-write paneEnvView**: パフォーマンスと安全性を両立

---

## Recommended Action

### 1. 最優先修正（Critical — 1件）
- [ ] C-1: `SessionView.tsx` の state updater 内副作用を外部に移動

### 2. 重要修正（Important — 13件）
- [ ] I-1: `resolveWindowFromRequest` をID比較に変更
- [ ] I-2: `HasSession` → `GetSession` の二段階呼び出し統一（2箇所）
- [ ] I-3: `handleKillWindow` を windowID ベースに変更
- [ ] I-4: `splitWindowResolved` ロールバック方針見直し
- [ ] I-5: `handleKillSession` のターゲット解析統一
- [ ] I-6: `UnsetSessionEnv` の存在確認追加
- [ ] I-7: `ResolveSessionTarget` のクローン返却検討
- [ ] I-8: `activeWindowInSession` フォールバック時の自己修復
- [ ] I-9: `SetRootPath` TrimSpace 追加
- [ ] I-10: `SwapPanes` swapPaneIDsInLayout nil 対応
- [ ] I-11: `onRemoveWindow` 確認ダイアログ追加
- [ ] I-12: `models.ts` の `?? []` フォールバック復元確認
- [ ] I-13: App.tsx `window` 変数のリネーム

### 3. テスト追加（Suggestions — テスト系 8件）
- [ ] S-23: handleSendKeys / handleListPanes テスト追加
- [ ] S-24: handleNewWindow テスト追加
- [ ] S-25: Tab / Escape / BSpace テスト追加
- [ ] S-26: nil pane lookupFormatVariable テスト追加
- [ ] S-27: SwapPanes テスト追加
- [ ] S-28: SessionEnv 並行テスト追加
- [ ] S-29: フィールド数期待値の重複解消
- [ ] S-30: 方向フラグ + -T 組み合わせテスト追加

### 4. コード改善（Suggestions — 残り 22件）
- 上記 S-1〜S-22 を優先度に応じて対応

---

## タスク並列作業可否表

以下の表は、各修正タスクを並列で作業する場合に競合が発生するかどうかを示します。

| タスクID | 内容（概要） | 対象ファイル | 並列作業 | 備考 |
|:---:|------|------|:---:|------|
| **C-1** | state updater 内副作用修正 | `SessionView.tsx` | ✅ 可 | フロントエンド単独作業 |
| **I-1** | resolveWindowFromRequest ID比較化 | `command_router_handlers_window.go` | ⚠️ I-2,I-3と同時不可 | 同一ファイル・同一関数周辺を変更するため |
| **I-2** | HasSession→GetSession統一 | `command_router_handlers_window.go`, `..._session.go` | ⚠️ I-1,I-3と同時不可 | window.go は I-1 と競合 |
| **I-3** | handleKillWindow windowIDベース化 | `command_router_handlers_window.go` | ⚠️ I-1,I-2と同時不可 | I-1 の変更に依存 |
| **I-4** | splitWindowResolved ロールバック見直し | `command_router_handlers_pane.go` | ✅ 可 | pane ハンドラのみ |
| **I-5** | handleKillSession ターゲット解析統一 | `command_router_handlers_session.go` | ✅ 可 | session ハンドラのみ |
| **I-6** | UnsetSessionEnv 存在確認追加 | `session_manager_env.go` | ⚠️ I-9と同時不可 | 同一ファイル |
| **I-7** | ResolveSessionTarget クローン返却 | `session_manager_targets.go` | ⚠️ I-8と同時不可 | 同一ファイル |
| **I-8** | activeWindowInSession 自己修復 | `session_manager_targets.go` | ⚠️ I-7と同時不可 | 同一ファイル |
| **I-9** | SetRootPath TrimSpace追加 | `session_manager_env.go` | ⚠️ I-6と同時不可 | 同一ファイル |
| **I-10** | SwapPanes nil対応 | `session_manager_pane_lifecycle.go` | ✅ 可 | 独立ファイル |
| **I-11** | onRemoveWindow 確認ダイアログ | `SessionView.tsx` | ⚠️ C-1と同時不可 | 同一ファイル |
| **I-12** | models.ts ?? [] フォールバック確認 | `models.ts` | ✅ 可 | auto-generated 確認 |
| **I-13** | App.tsx window変数リネーム | `App.tsx` | ✅ 可 | フロントエンド単独 |
| **S-23** | handleSendKeys/ListPanes テスト | `..._pane_test.go` | ✅ 可 | テスト追加のみ |
| **S-24** | handleNewWindow テスト | `..._window_test.go` | ✅ 可 | テスト追加のみ |
| **S-25** | Tab/Escape/BSpace テスト | `key_table_test.go` | ✅ 可 | テスト追加のみ |
| **S-26** | nil pane format テスト | `format_test.go` | ✅ 可 | テスト追加のみ |
| **S-27** | SwapPanes テスト | `..._lifecycle_test.go` | ✅ 可 | テスト追加のみ |
| **S-28** | SessionEnv 並行テスト | `..._env_test.go` | ✅ 可 | テスト追加のみ |
| **S-29** | フィールド数重複解消 | `delta_test.go` + `metrics_test.go` | ✅ 可 | 定数抽出 |
| **S-30** | 方向+-T 組み合わせテスト | `..._pane_test.go` | ⚠️ S-23と同時不可 | 同一テストファイル |

### 推奨並列作業グループ

作業者が複数いる場合、以下のグループ分けで並列作業が可能です。

| グループ | タスク | 担当する領域 |
|:---:|------|------|
| **A** | C-1, I-11 | `SessionView.tsx` — 順序実行 |
| **B** | I-1, I-2, I-3 | `command_router_handlers_window.go` — 順序実行 |
| **C** | I-4 | `command_router_handlers_pane.go` — 単独 |
| **D** | I-5 | `command_router_handlers_session.go` — 単独 |
| **E** | I-6, I-9 | `session_manager_env.go` — 順序実行 |
| **F** | I-7, I-8 | `session_manager_targets.go` — 順序実行 |
| **G** | I-10 | `session_manager_pane_lifecycle.go` — 単独 |
| **H** | I-12, I-13 | フロントエンド（別ファイル）— 並列可 |
| **T** | S-23〜S-30 | テスト追加 — ファイル重複なければ並列可 |

> **グループ A〜H は全て互いに並列実行可能です。**
> グループ内のタスクは順序実行が必要です。
