# PR Review Summary — 2026-02-17 19:30

**対象**: `myT-x/` 配下の全変更ファイル（39ファイル、+2952行 / -116行）  
**主な変更内容**: マルチウィンドウ対応（`ActiveWindowID`導入、ウィンドウ操作ハンドラー追加、フロントエンドタブバーUI）

---

## レビューカテゴリ

| カテゴリ | レビュー担当 | 対象ファイル数 |
|---------|------------|-------------|
| Backend Go App層 | code-reviewer | 8 |
| Internal tmux (command_router) | code-reviewer | 6 |
| Internal tmux (session_manager/format/key_table) | code-reviewer | 14 |
| Frontend (React/TS/CSS) | frontend-reviewer | 6 |
| tmux-shim (CLI) | frontend-reviewer | 3 |
| テストカバレッジ | test-analyzer | 11 |
| エラーハンドリング | silent-failure-hunter | 全ファイル |
| コード簡素化・コメント | code-simplifier | 全ファイル |

---

## Critical Issues（3件）— マージ前に要修正

### C1. `killPaneLocked` の `ActiveWindowID` 再計算で nil ガード不足
- **ファイル**: [session_manager_pane_lifecycle.go](myT-x/internal/tmux/session_manager_pane_lifecycle.go)
- **箇所**: `killPaneLocked` 内、ウィンドウ削除後の `ActiveWindowID` 再設定
- **問題**: 
```go
if !activeWindowStillExists {
    session.ActiveWindowID = session.Windows[0].ID
}
```
`session.Windows[0]` が `nil` の場合に panic する。`removeWindowAtIndexLocked` では `nil` チェック付きのより堅牢な再設定ロジック（隣接ウィンドウへのフォールバック）が実装されており、`killPaneLocked` だけガードが欠けている。
- **修正案**: `removeWindowAtIndexLocked` のパターンに合わせて nil チェックを追加するか、共通ヘルパーに抽出する。

### C2. セッションハンドラー4関数のテスト不在
- **ファイル**: [command_router_handlers_session.go](myT-x/internal/tmux/command_router_handlers_session.go)
- **問題**: 以下の4つの新規パブリックIPCハンドラーにテストが一切存在しない：
  - `handleRenameSession` — 正常系（リネーム成功＋イベント発火）、引数なし、`-t`未指定、存在しないセッション
  - `handleAttachSession` — 正常系（`app:activate-window`イベント発火）、`-t`未指定、存在しないセッション
  - `handleShowEnvironment` — `-g`フラグ、個別変数取得、存在しない変数、全変数ソート出力
  - `handleSetEnvironment` — 変数設定成功、`-u`による削除、`-g`フラグno-op、変数名未指定
- **影響**: これらは全てIPCエンドポイントで、tmux-shimからのリクエストを処理する。リグレッション検知が不可。

### C3. `handleNewWindow` のテスト不在
- **ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go)
- **問題**: 複雑なロールバックロジック（`rollbackWindow`クロージャ）を持つ最重要ハンドラーだが、テストが存在しない。`attachTerminal`がConPTYを必要とするため統合テストが困難な面はあるが、少なくとも以下をモックベースでカバーすべき：
  - セッション未存在のエラー
  - `-n` でウィンドウ名指定
  - `-t` 未指定のエラー

---

## Important Issues（12件）— 修正推奨

### I1. `handleKillWindow` で `layout-changed` イベント未発行
- **ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go)
- **問題**: セッションが残る場合、`tmux:window-destroyed` は発行されるが `tmux:layout-changed` が発行されない。`handleKillPane` では `emitLayoutChangedForSession` を呼んでおり一貫性がない。フロントエンドがレイアウト再構築できない可能性。

### I2. `handleNewWindow` で `layout-changed` イベント不足
- **ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go)
- **問題**: `tmux:window-created` イベントは発行されるが、`tmux:layout-changed` は発行されない。`handleSplitWindow` では両方発行する一貫したパターンがある。

### I3. `handleSelectWindow` で `sessionName` が空文字列になる可能性
- **ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go)
- **問題**: `target.Window` または `target.Window.Session` が nil の場合、空文字列の `sessionName` でイベントが発行される。`handleSelectPane` では `GetPaneContextSnapshot` で常にセッション名を解決しており、パターンが不統一。

### I4. `activeWindowInSession` と `activeWindowInSessionLocked` のコード重複
- **ファイル**: [session_manager_targets.go](myT-x/internal/tmux/session_manager_targets.go)
- **問題**: ルックアップロジックがほぼ同一の2関数が存在。修復の有無のみが差分。片方を変更して他方を忘れるリスク。
- **修正案**: `findWindowByID(windows, activeWindowID) (window, fallback)` という共通ヘルパーに抽出。

### I5. `ListPanesByWindowTarget` / `ResolveTarget` のロック昇格理由未記載
- **ファイル**: [session_manager_pane_io.go](myT-x/internal/tmux/session_manager_pane_io.go), [session_manager_targets.go](myT-x/internal/tmux/session_manager_targets.go)
- **問題**: `RLock` → `Lock` に変更されているが、理由（`activeWindowInSessionLocked` のauto-repairがwriteを発生しうるため）がコメントに記載されていない。読み取り専用パス（ペインID直接解決等）でも排他ロックを取得する副作用がある。

### I6. フロントエンド: セッション切替時にリネーム状態がリセットされない
- **ファイル**: [SessionView.tsx](myT-x/frontend/src/components/SessionView.tsx)
- **問題**: `renamingWindowId` はセッション切替時にクリアされない。前セッションのウィンドウIDが新セッションと偶然一致した場合、誤ったウィンドウにリネーム入力が表示される。
- **修正案**: `props.session?.name` の変更時にリネーム状態をリセットする `useEffect` を追加。

### I7. フロントエンド: App.tsx と SessionView.tsx のウィンドウ検索ロジック重複
- **ファイル**: [App.tsx](myT-x/frontend/src/App.tsx), [SessionView.tsx](myT-x/frontend/src/components/SessionView.tsx)
- **問題**: `active_window_id` → pane fallback → `windows[0]` の3段フォールバックロジックが2箇所に重複。片方のみ修正される事故リスク。

### I8. `spec.go`: `send-keys` に `-l` フラグが未定義
- **ファイル**: [spec.go](myT-x/cmd/tmux-shim/spec.go)
- **問題**: Claude Code Agent Teamsが `send-keys -l` を使用する可能性。現状ではパースエラーとなり、`-t` の解決等が行われない。tmux-shim方針「失敗時は原文転送」で致命的ではないが、本来のコマンド処理が行われない。

### I9. `parse.go`: 空 args のパニック防止なし
- **ファイル**: [parse.go](myT-x/cmd/tmux-shim/parse.go)
- **問題**: `parseCommand(args)` で `args` が空スライスなら `args[0]` でパニック。上位で防御されている可能性はあるが、関数自体の防御性が不足。

### I10. テスト: `resolveActiveWindowSnapshot` の空配列境界ケース不足
- **ファイル**: [app_status_test.go](myT-x/app_status_test.go)
- **問題**: 空の `windows` 配列で `nil` を返すケースのテストがない。

### I11. テスト: `handleSelectWindow` で `ActiveWindowID` 更新の直接検証なし
- **ファイル**: [command_router_handlers_window_test.go](myT-x/internal/tmux/command_router_handlers_window_test.go)
- **問題**: イベント発火確認のみで、セッションの `ActiveWindowID` が実際に更新されたことを検証していない。

### I12. `commandOrder` と `commandSpecs` の同期リスク
- **ファイル**: [spec.go](myT-x/cmd/tmux-shim/spec.go)
- **問題**: 2つの並列データ構造を手動で同期維持する必要があり、片方の追加忘れがサイレントバグになる。
- **修正案**: `init()` で整合性を検証するか、テストで確認。

---

## Suggestions（10件）— あれば良い改善

### S1. `resolveWindowFromRequest` のコメント不正確
- **ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go)
- **問題**: コメントに `"session"`, `"session:windowIdx"` のみ記載だが、実際は `%paneID` 形式も受け付ける。

### S2. `activeWindowInSession` (standalone版) にドキュメント追加
- **ファイル**: [session_manager_targets.go](myT-x/internal/tmux/session_manager_targets.go)
- **提案**: 「read-only use on cloned/snapshot sessions; does NOT auto-repair ActiveWindowID」と明記。

### S3. フロントエンド: `window-tab-bar` に ARIA属性追加
- **ファイル**: [SessionView.tsx](myT-x/frontend/src/components/SessionView.tsx)
- **提案**: `role="tablist"` / `role="tab"` / `aria-selected` を追加してアクセシビリティ向上。

### S4. `sendKeysTable` と `parseControlKey` の重複エントリに補足コメント
- **ファイル**: [key_table.go](myT-x/internal/tmux/key_table.go)
- **提案**: `C-c`, `C-d`, `C-z` がテーブルにも `parseControlKey` でも処理可能だが、テーブル優先の理由を明記。

### S5. `resolveActiveWindowSnapshot` のフォールバック意図をコメントで明記
- **ファイル**: [app_status.go](myT-x/app_status.go)
- **提案**: `// Falls back to first window if no match (snapshot slices contain no nil entries).`

### S6. フロントエンド: 冗長な useEffect 削除可能
- **ファイル**: [SessionView.tsx](myT-x/frontend/src/components/SessionView.tsx)
- **問題**: `setRenamingWindow(null)` 時点で ref も null 設定済みのため、同期用 `useEffect` が冗長。

### S7. `spec.go` の `commandSpec.name` フィールドの冗長性確認
- **ファイル**: [spec.go](myT-x/cmd/tmux-shim/spec.go)
- **提案**: `name` フィールドはマップキーと同一。使用箇所がなければ削除して構造を簡素化。

### S8. `resize-pane` に `-U`/`-D`/`-L`/`-R` フラグ未定義
- **ファイル**: [spec.go](myT-x/cmd/tmux-shim/spec.go)
- **提案**: tmux互換の方向指定リサイズフラグ。現時点で不使用なら備考として。

### S9. テスト: `session_manager_env_test.go` に存在しないセッション名テスト追加
- **ファイル**: [session_manager_env_test.go](myT-x/internal/tmux/session_manager_env_test.go)
- **提案**: `SetSessionEnv` / `UnsetSessionEnv` に存在しないセッション名のエラーテスト追加。

### S10. テスト: `handleKillWindow` で3ウィンドウ中の中間削除テスト
- **ファイル**: [command_router_handlers_window_test.go](myT-x/internal/tmux/command_router_handlers_window_test.go)
- **提案**: アクティブウィンドウ自体の削除後のActiveWindowID遷移挙動を検証。

---

## Strengths（良い点）

1. **`ActiveWindowID` の一貫した伝播**: `TmuxSession`, `SessionSnapshot`, `cloneSessionForRead`, `Snapshot()`, `sessionSnapshotEqual`, `estimateSessionSnapshotSize` の全てに漏れなく追加。フィールド数ガードテストも正確に更新。

2. **ロールバックパターンの一貫性**: `handleNewWindow` と `handleNewSession` の両方で `rollbackXxx` クロージャを使い、作成→アタッチ失敗時のリソースリークを防止。

3. **ロック外でのターミナルクローズ**: `killPaneLocked` → `KillPane`、`handleKillWindow`、`RemoveSession` いずれもロック内で `closeTargets` を収集しロック外で `Close()` を呼ぶ設計が統一。デッドロック防止の優れたパターン。

4. **デバッグログの統一命名**: `[DEBUG-WINDOW]`, `[DEBUG-SESSION]`, `[DEBUG-SPLIT]`, `[DEBUG-PANE]` 等が一貫。

5. **key_table の `parseControlKey`**: 静的テーブル拡張を動的パターンで補完する設計。コメントも正確。

6. **フロントエンドのリネーム状態管理**: `requestAnimationFrame` と ref を組み合わせた React 非同期 state 更新との競合回避が適切。メモリリーク防止の cleanup も完備。

7. **XSS 安全性**: ウィンドウ名は JSX テキストノードとして描画、`dangerouslySetInnerHTML` 不使用。

8. **テストの品質**: テーブル駆動テスト、`captureEmitter` によるイベント検証、ロールバックのステージ別テストなど、テスト設計の品質が高い。

9. **コピーによるデータ保護**: `cloneSessionForRead` はウィンドウ・ペインまで含む深いクローンを行い、ロック外での安全な利用を保証。

---

## 修正タスク一覧と並列作業可否

以下の表は、修正作業者が効率的に作業するための整理です。「並列OK」は他タスクと同時に作業しても競合しないことを意味します。

| # | 重要度 | タスク | 対象ファイル | 並列OK | 備考 |
|---|--------|--------|------------|--------|------|
| C1 | Critical | `killPaneLocked` の `ActiveWindowID` 再設定に nil ガード追加 | `session_manager_pane_lifecycle.go` | ✅ 可 | 単独編集で完結 |
| C2 | Critical | セッションハンドラー4関数のテスト追加 | 新規 `command_router_handlers_session_test.go` | ✅ 可 | テストファイル新規作成 |
| C3 | Critical | `handleNewWindow` のテスト追加 | `command_router_handlers_window_test.go` | ✅ 可 | 既存テストファイルに追記 |
| I1 | Important | `handleKillWindow` に `layout-changed` イベント追加 | `command_router_handlers_window.go` | ⚠️ 注意 | I2と同ファイル。I2と同時作業する場合は担当者を統一 |
| I2 | Important | `handleNewWindow` に `layout-changed` イベント追加 | `command_router_handlers_window.go` | ⚠️ 注意 | I1と同ファイル。I1と同時作業する場合は担当者を統一 |
| I3 | Important | `handleSelectWindow` のセッション名解決改善 | `command_router_handlers_window.go` | ⚠️ 注意 | I1,I2と同ファイル |
| I4 | Important | `activeWindowInSession` 重複を共通ヘルパーに抽出 | `session_manager_targets.go` | ✅ 可 | 単独編集で完結。I5と関連するが別箇所 |
| I5 | Important | `ListPanesByWindowTarget`/`ResolveTarget` のロック昇格理由コメント追加 | `session_manager_pane_io.go`, `session_manager_targets.go` | ✅ 可 | コメント追加のみ |
| I6 | Important | セッション切替時にリネーム状態をリセット | `SessionView.tsx` | ✅ 可 | フロントエンド独立 |
| I7 | Important | ウィンドウ検索ロジックの共通化 | `App.tsx`, `SessionView.tsx` | ⚠️ 注意 | I6 と同ファイル（SessionView.tsx）。I6と同時作業する場合は担当者を統一 |
| I8 | Important | `send-keys` に `-l` フラグ追加 | `spec.go` | ✅ 可 | tmux-shim独立 |
| I9 | Important | `parseCommand` に空args ガード追加 | `parse.go` | ✅ 可 | tmux-shim独立 |
| I10 | Important | `resolveActiveWindowSnapshot` 空配列テスト追加 | `app_status_test.go` | ✅ 可 | テストファイル独立 |
| I11 | Important | `handleSelectWindow` テストで `ActiveWindowID` 検証追加 | `command_router_handlers_window_test.go` | ⚠️ 注意 | C3 と同ファイル |
| I12 | Important | `commandOrder`/`commandSpecs` 同期ガード追加 | `spec.go` or テストファイル | ✅ 可 | tmux-shim独立 |

### 並列作業グループ分け（推奨）

| グループ | タスク | 同時作業 |
|---------|--------|---------|
| **A: command_router_handlers_window.go** | I1, I2, I3 | ❌ 同一ファイルの為、1人で順次 |
| **B: session_manager系** | C1, I4, I5 | ✅ 各ファイル独立 |
| **C: テスト追加** | C2, C3, I10, I11 | ⚠️ C3とI11は同ファイル。他は並列OK |
| **D: フロントエンド** | I6, I7 | ⚠️ SessionView.tsx共通のため1人で順次 |
| **E: tmux-shim** | I8, I9, I12 | ✅ 各ファイル独立 |

**最効率の並列パターン**: グループ A, B, C(C2のみ), D, E を5人で並列実行 → その後 C3+I11, I10 を追加。
