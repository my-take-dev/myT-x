# PR Review Summary — 2026-02-17 23:33

**対象**: myT-x 配下の未コミット差分（43ファイル、+3418 / -144 行）
**レビュー方式**: 6カテゴリ並列レビュー

---

## カテゴリ別ファイル分類

| カテゴリ | 対象ファイル |
|---|---|
| A. App層 (Go) | app_events.go, app_snapshot_delta.go, app_snapshot_metrics.go, app_status.go + tests |
| B. tmux-shim | cmd/tmux-shim/parse.go, spec.go, main_test.go |
| C. フロントエンド (TS/React) | App.tsx, api.ts, SessionView.tsx, usePrefixKeyMode.ts, layout.css, types/tmux.ts, utils/session.ts, wailsjs/* |
| D. コマンドルーター (Go) | command_router.go, command_router_handlers_pane.go, _session.go, _window.go, _terminal.go + tests |
| E. セッションマネージャー (Go) | session_manager*.go + tests |
| F. ユーティリティ (Go) | format.go, key_table.go + tests |

---

## Critical Issues（0件）

致命的なバグは検出されませんでした。

---

## Important Issues（14件）

### I-01. [App層] `testSnapshot` ヘルパーに `ActiveWindowID` 変化の delta 検出テストがない

**ファイル**: `myT-x/app_snapshot_delta_test.go`

`ActiveWindowID` フィールドが追加されたが、`testSnapshot` ヘルパーではゼロ値のまま。`TestSnapshotDeltaDetects*` シリーズに `ActiveWindowID` 変化で delta を検出するケースが存在しない。`sessionSnapshotEqual` に追加された比較ロジックの動作確認が不足。

---

### I-02. [tmux-shim] `resize-pane` / `new-session` の `-x` `-y` が負の値を受け入れる

**ファイル**: `myT-x/cmd/tmux-shim/parse.go` (L71-77)

`strconv.Atoi` は負数をパースできるため、`-x -1` がエラーにならない。サイズ指定に負の値は無効。shimの方針（サーバー側で拒否可）を考慮し、shimで弾く場合は `value < 0` ガードが必要。テストにも負値ケースがない。

---

### I-03. [tmux-shim] `rename-window` の空白 new-name テストが欠落

**ファイル**: `myT-x/cmd/tmux-shim/main_test.go`

`rename-session` には空白only new-name テストがあるが、`rename-window` には対応テストがない。`validateRequired` で同一ケース処理だがテスト対称性が不足。

---

### I-04. [tmux-shim] `flagEnv` のキー名に前後の空白が保持される

**ファイル**: `myT-x/cmd/tmux-shim/parse.go` (L80-87)

`-e " MY_VAR =value"` の場合、キーが `" MY_VAR "` として保存される。格納前に `strings.TrimSpace(key)` を適用すべき。

---

### I-05. [フロントエンド] ウィンドウ識別子の不一致（confirm ダイアログ vs タブ表示）

**ファイル**: `myT-x/frontend/src/components/SessionView.tsx` (L97, L171)

タブ表示では配列インデックス `i` をフォールバック、`window.confirm` では `w.id`（数値ID）を使用。ユーザーに表示される識別子が不一致。

---

### I-06. [フロントエンド] `window` パラメータ名によるグローバル `window` のシャドウイング

**ファイル**: `myT-x/frontend/src/utils/session.ts` (L5-7)

`find` コールバックのパラメータ名 `window` がグローバル `window` を隠蔽。`w` や `win` に変更すべき。

---

### I-07. [ルーター] `emitLayoutChangedForSession` でクローン由来のpaneを使用（Terminal=nil）

**ファイル**: `myT-x/internal/tmux/command_router_handlers_pane.go` (L303-325)

`GetSession` はクローンを返すため `Terminal` フィールドが nil。`survivingPane.ID` のみを使用するので実害はないが、将来的にポインタ操作が加わると罠になる。コメントで明記すべき。

---

### I-08. [ルーター] `handleKillWindow` で削除済み `windowID` を `preferredWindowID` として渡す

**ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go` (L254-258)

`paneForLayoutSnapshot` が削除済みIDを探し見つからず `firstPaneInSession` にフォールバック。実害はないが意図が不明瞭。`-1` を渡すか、削除前にフォールバック先を計算すべき。

---

### I-09. [ルーター] `handleShowEnvironment` / `handleSetEnvironment` で `parseSessionName` 未適用

**ファイル**: `myT-x/internal/tmux/command_router_handlers_session.go` (L113-141)

内部で `getSessionByNameLocked` → `parseSessionName` が呼ばれるため実害はないが、他のハンドラ（`handleKillSession`, `handleRenameSession`）ではハンドラ側で明示的に呼んでおり一貫性が不統一。

---

### I-10. [ルーター] `handleSelectWindow` が `pane-focused` イベントのみ発行

**ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go` (L273-298)

`select-window` はウィンドウフォーカス変更だが `pane-focused` イベントを発行。SetActivePane が ActiveWindowID を更新するためSnapshot経由で検知可能だが、将来的にウィンドウタブUIでイベント区別が必要になる可能性がある。

---

### I-11. [セッションマネージャー] `killPaneLocked` の `fallbackWindowIDNearIndex` で常にindex 0

**ファイル**: `myT-x/internal/tmux/session_manager_pane_lifecycle.go` (L118-121)

削除されたウィンドウの元のインデックス位置を考慮せず、常に `preferredIdx=0` にフォールバック。`removeWindowAtIndexLocked` では元位置を渡す設計と非対称。

---

### I-12. [セッションマネージャー] テストで `manager.generation` をロックなしでアクセス

**ファイル**: `myT-x/internal/tmux/session_manager_env_test.go` (L70, L118)

`generation` は `mu` で保護されるべきフィールド。シングルゴルーチンテストで実害は低いが、将来的な問題の種。

---

### I-13. [ユーティリティ] `window_active` が nil pane 時に `"0"` ではなく `""` を返す

**ファイル**: `myT-x/internal/tmux/format.go` (L77-85)

`lookupFormatVariable` の nil pane ガードで `window_active` が数値系リストに含まれず空文字を返す。消費側が `"0"`/`"1"` 比較している場合に不整合。

---

### I-14. [ユーティリティ] `parseControlKey` が `C-[` を拒否する明示テストがない

**ファイル**: `myT-x/internal/tmux/key_table_test.go`

`C-[` は `sendKeysTable` で ESC にマッピングされるが、`parseControlKey` の拒否テストがない。テーブル委譲の前提が保護されていない。

---

## Suggestions（17件）

### S-01. [App層] バックエンドとフロントエンドの `resolveActiveWindow` フォールバック戦略差異

バックエンド (`app_status.go`): ID一致 → windows[0]
フロントエンド (`session.ts`): ID一致 → active pane持つwindow → windows[0]

ステータスラインは表示のみなので重大ではないが、ロジック対称性を意識。

### S-02. [App層] `windowIdx` 変数名が実際にはwindow IDを保持

`app_status.go` L58: `windowIdx = activeWindow.ID` — `windowID` に改名推奨。

### S-03. [tmux-shim] `resize-pane` に `-Z` (zoom toggle) フラグ未定義

### S-04. [tmux-shim] `new-window` spec に `-k` フラグがない

### S-05. [tmux-shim] `select-pane` に `-m`/`-M` フラグがない

### S-06. [tmux-shim] `send-keys` の `-l` と `split-window` の `-l` の型不一致コメント推奨

### S-07. [tmux-shim] `--` セパレータの網羅テスト不足

### S-08. [tmux-shim] `set-environment -gu` 結合boolフラグのテスト不足

### S-09. [tmux-shim] `validateCommandSpecConsistency` にフラグ型妥当性チェック追加

### S-10. [フロントエンド] 冗長な `useEffect` によるRef同期

`SessionView.tsx` L131-135: `setRenamingWindow` が既に ref を同期更新しているため、この effect は削除可能。

### S-11. [フロントエンド] タブバーのキーボードナビゲーション不足

ARIA tabsパターンの矢印キーナビゲーション、tabIndex管理、tabpanel未実装。

### S-12. [ルーター] `resolveWindowFromRequest` がデッドコードの可能性

呼び出し箇所が見つからない。未使用であれば削除検討。

### S-13. [セッションマネージャー] `AddWindow` が `ActiveWindowID` を更新しない

`CreateSession` では更新するが `AddWindow` では更新しない。呼び出し側に委ねている場合はコメント明記。

### S-14. [セッションマネージャー] `findWindowByID` の戻り値セマンティクスをgodocで明確化

### S-15. [セッションマネージャー] `activePaneInSession`（free function）が未使用の可能性

### S-16. [ユーティリティ] `formatWindowLine` のエッジケーステスト不足

window==nil, customFormat==""、ActivePN範囲外のフォールバックテスト。

### S-17. [ユーティリティ] `sendKeysTable` と `parseControlKey` の重複エントリの明確化

C-c, C-d, C-z がテーブルとジェネリック関数の両方で定義。意図をコメントで明記推奨。

---

## Strengths（良い点）

1. **フィールドカウントガードテスト**: リフレクションベースのフィールド数チェックにより、フィールド追加漏れを自動検出する優れた設計
2. **イベント名の一貫性**: 4つの新規イベントが emitter/handler/test で完全一致
3. **ロールバック設計**: `handleNewWindow` の段階的ロールバック（IndexInSession→RemoveWindow→Terminal.Close）が丁寧
4. **locked/unlocked バリアント分離**: `activeWindowInSessionLocked` と `activeWindowInSession` の明確な分離
5. **自動修復設計**: stale `ActiveWindowID` の自動修復が堅実で mutation type も適切
6. **テストカバレッジ**: エッジケース（stale ID修復、nilウィンドウ、レイアウト再構築、クローン独立性）を網羅
7. **二重コミット防止**: React の `renamingWindowIdRef` による stale closure 対策が堅実
8. **ユーティリティ関数抽出**: `utils/session.ts` で3コンポーネントのロジック重複を排除
9. **`parseControlKey` の3段防御**: 長さ→プレフィックス→文字範囲チェック
10. **UnsetSessionEnv の mutation skip**: 不存在キーのunsetでgeneration変更を回避

---

## タスク修正一覧と並列修正可否

以下の表は、レビューで検出された修正タスクを並列作業の可否とともに整理したものです。

### Important タスク

| # | カテゴリ | 修正内容 | 対象ファイル | 並列修正 | 備考 |
|---|---------|---------|------------|---------|------|
| I-01 | App層 | `ActiveWindowID` 変化の delta 検出テスト追加 | app_snapshot_delta_test.go | ✅ 可 | 他タスクと独立 |
| I-02 | shim | `-x`/`-y` 負値ガード追加 | cmd/tmux-shim/parse.go, main_test.go | ✅ 可 | shim単独で完結 |
| I-03 | shim | `rename-window` 空白 new-name テスト追加 | cmd/tmux-shim/main_test.go | ✅ 可 | I-02 と同ファイルだが独立箇所 |
| I-04 | shim | envキーの TrimSpace 適用 | cmd/tmux-shim/parse.go | ✅ 可 | I-02 と同ファイルだが独立箇所 |
| I-05 | FE | confirm ダイアログの識別子統一 | SessionView.tsx | ✅ 可 | FE単独 |
| I-06 | FE | `window` パラメータ名変更 | utils/session.ts | ✅ 可 | FE単独 |
| I-07 | ルーター | `emitLayoutChangedForSession` にコメント追加 | command_router_handlers_pane.go | ✅ 可 | コメントのみ |
| I-08 | ルーター | `handleKillWindow` の preferredWindowID 改善 | command_router_handlers_window.go | ✅ 可 | ルーター単独 |
| I-09 | ルーター | `parseSessionName` 呼び出し一貫性統一 | command_router_handlers_session.go | ✅ 可 | ルーター単独 |
| I-10 | ルーター | select-window イベント設計検討 | command_router_handlers_window.go | ⚠️ 要確認 | FE側との連動あり、設計判断が必要 |
| I-11 | SM | `killPaneLocked` のfallback index修正 | session_manager_pane_lifecycle.go | ✅ 可 | SM単独 |
| I-12 | SM | テストのgeneration直接アクセス修正 | session_manager_env_test.go | ✅ 可 | テストのみ |
| I-13 | Util | `window_active` の nil pane 時 `"0"` 返却 | format.go, format_test.go | ✅ 可 | ユーティリティ単独 |
| I-14 | Util | `parseControlKey` の `C-[` 拒否テスト追加 | key_table_test.go | ✅ 可 | テストのみ |

### Suggestion タスク

| # | カテゴリ | 修正内容 | 対象ファイル | 並列修正 | 備考 |
|---|---------|---------|------------|---------|------|
| S-01 | App層 | フォールバック戦略差異のコメント追加 | app_status.go | ✅ 可 | コメントのみ |
| S-02 | App層 | `windowIdx` → `windowID` 変数名変更 | app_status.go | ✅ 可 | S-01 と同ファイルだが独立箇所 |
| S-03 | shim | `-Z` フラグ追加検討 | cmd/tmux-shim/spec.go | ✅ 可 | 設計判断含む |
| S-04 | shim | `-k` フラグ追加検討 | cmd/tmux-shim/spec.go | ✅ 可 | S-03 と同ファイル、独立 |
| S-05 | shim | `-m`/`-M` フラグ追加検討 | cmd/tmux-shim/spec.go | ✅ 可 | S-03 と同ファイル、独立 |
| S-06 | shim | `-l` 型不一致コメント追加 | cmd/tmux-shim/spec.go | ✅ 可 | コメントのみ |
| S-07 | shim | `--` セパレータテスト追加 | cmd/tmux-shim/main_test.go | ✅ 可 | テストのみ |
| S-08 | shim | `-gu` 結合フラグテスト追加 | cmd/tmux-shim/main_test.go | ✅ 可 | テストのみ |
| S-09 | shim | フラグ型妥当性チェック追加 | cmd/tmux-shim/spec.go | ✅ 可 | 独立検証ロジック |
| S-10 | FE | 冗長 useEffect 削除 | SessionView.tsx | ✅ 可 | I-05 と同ファイルだが独立箇所 |
| S-11 | FE | タブバー ARIA 改善 | SessionView.tsx | ✅ 可 | I-05 / S-10 と同ファイルだが独立箇所 |
| S-12 | ルーター | デッドコード `resolveWindowFromRequest` 削除 | command_router_handlers_window.go | ⚠️ 要確認 | 他ファイルからの参照要確認 |
| S-13 | SM | `AddWindow` の ActiveWindowID コメント追加 | session_manager_windows.go | ✅ 可 | コメントのみ |
| S-14 | SM | `findWindowByID` godoc追加 | session_manager_targets.go | ✅ 可 | コメントのみ |
| S-15 | SM | `activePaneInSession` 未使用確認 | session_manager_targets.go | ⚠️ 要確認 | 他ファイルからの参照要確認 |
| S-16 | Util | `formatWindowLine` エッジケーステスト追加 | format_test.go | ✅ 可 | テストのみ |
| S-17 | Util | sendKeysTable 重複コメント追加 | key_table.go | ✅ 可 | コメントのみ |

### 並列修正グループ分け（推奨）

同一ファイルへの同時編集を避け、以下のグループで並列作業が可能です。

| グループ | タスク | 主な対象ファイル |
|---------|--------|---------------|
| **G1: App層** | I-01, S-01, S-02 | app_snapshot_delta_test.go, app_status.go |
| **G2: tmux-shim** | I-02, I-03, I-04, S-03〜S-09 | cmd/tmux-shim/parse.go, spec.go, main_test.go |
| **G3: フロントエンド** | I-05, I-06, S-10, S-11 | SessionView.tsx, utils/session.ts |
| **G4: コマンドルーター** | I-07, I-08, I-09, I-10, S-12 | command_router_handlers_*.go |
| **G5: セッションマネージャー** | I-11, I-12, S-13, S-14, S-15 | session_manager_*.go |
| **G6: ユーティリティ** | I-13, I-14, S-16, S-17 | format.go, key_table.go + tests |

> ⚠️ G1〜G6 は互いに独立しているため、**6グループ全てを並列で修正可能**です。
> ⚠️ 同一グループ内のタスクは、対象ファイルが重複する場合があるため**順次作業推奨**です（ただし独立箇所であれば同時可）。

---

## Recommended Action

1. **Important の I-01〜I-14 を優先修正**（全て並列修正可能）
2. **Suggestion は優先度に応じて対応**
3. **I-10 (select-window イベント設計) と S-12 (デッドコード確認) は設計判断が必要**なため、確認後に対応
4. 修正後にテスト実行で回帰確認
