# PR Review Summary — Window管理機能追加

**レビュー日時**: 2026-02-18 07:31  
**対象**: myT-x 配下 43ファイル (3829行追加, 167行削除)  
**レビュー方式**: 6エージェント並列レビュー（App層, tmux-shim, Frontend, command_router, session_manager, クロスカッティング）

---

## Critical Issues (3件)

### C-1: `ApplyLayoutPreset` の `windowIdx: 0` ハードコード — マルチウィンドウで破綻
- **ファイル**: `app_pane_api.go:199`
- **カテゴリ**: コードレビュー / クロスカッティング
- **詳細**: `sessions.ApplyLayoutPreset(sessionName, 0, tmux.LayoutPreset(preset))` でウィンドウインデックスが常に `0` にハードコードされている。マルチウィンドウ対応後、アクティブウィンドウが2番目以降の場合、**意図しないウィンドウにレイアウトが適用される**。
- **修正案**: アクティブウィンドウのインデックスを解決するか、`ApplyLayoutPreset` の API に window ID ベースのメソッドを追加する。

### C-2: `App.AddWindow` / `RemoveWindow` / `RenameWindow` でイベント発行/スナップショット発行パターンが不統一
- **ファイル**: `app_window_api.go:12-108`
- **カテゴリ**: App層コードレビュー / クロスカッティング
- **詳細**: 
  - `KillSession` → `a.requestSnapshot(true)` を明示呼出し
  - `RenameSession` → `a.requestSnapshot(true)` を明示呼出し
  - **`AddWindow` / `RemoveWindow` / `RenameWindow`** → `executeRouterRequestFn` 経由のrouter内 `emitter.Emit` に暗黙依存
  - パターンが不一致。特に `executeRouterRequestFn` のテストモック時にemitが発生しない場合、テストでスナップショットが更新されないリスクがある。
- **補足**: router内部で `emitter.Emit` → `shouldEmitSnapshotForEvent` → snapshot発行 というパスが機能していれば実際には通知される。ただしApp層で明示的に `emitBackendEvent` / `requestSnapshot` を呼ぶパターンとの不一致は保守性の問題。
- **修正案**: 他のApp層APIと同様に、成功後に `a.emitBackendEvent` または `a.requestSnapshot(true)` を明示呼出しに統一する。

### C-3: `RemoveWindow` の二重クリーンアップとレースコンディション
- **ファイル**: `app_window_api.go:42-68`
- **カテゴリ**: App層コードレビュー
- **詳細**: 
  ```go
  beforePanes := sessions.ActivePaneIDs()   // ← kill-window前に取得
  // ... kill-window 実行 (router内でTerminal.Close()も実行)
  remainingPanes := sessions.ActivePaneIDs()
  for _, paneID := range removedPaneIDs(beforePanes, remainingPanes) {
      a.stopOutputBuffer(paneID)             // ← 明示的に停止
  }
  a.cleanupDetachedPaneStates(a.detachStaleOutputBuffers(remainingPanes))  // ← さらにstale cleanup
  ```
  1. `beforePanes → kill-window` 間に別goroutineがpane追加する可能性(TOCTOU)
  2. `stopOutputBuffer` と `detachStaleOutputBuffers` で二重クリーンアップ
  3. `KillSession` では `kill-session` **後**にのみ `ActivePaneIDs()` → `detachStaleOutputBuffers` を呼んでおりパターン不一致
- **修正案**: `KillSession` と同パターンに統一:
  ```go
  existingPanes := sessions.ActivePaneIDs()
  a.cleanupDetachedPaneStates(a.detachStaleOutputBuffers(existingPanes))
  ```

---

## Important Issues (11件)

### I-1: `usePrefixKeyMode` にウィンドウ切替キーバインドが未実装
- **ファイル**: `frontend/src/hooks/usePrefixKeyMode.ts`
- **カテゴリ**: クロスカッティング / Frontend
- **詳細**: tmux標準の `Ctrl-b n`(次のウィンドウ)、`Ctrl-b p`(前のウィンドウ)、`Ctrl-b c`(新規ウィンドウ)のキーバインドが未実装。ウィンドウタブバーのUI操作のみに依存しており、キーボードだけではウィンドウ切替ができない。
- **修正案**: `key_table.go` には既にウィンドウ操作のキーバインドが定義されているので、`usePrefixKeyMode` 側でもこれらを処理する。

### I-2: `handleNewWindow` — `-d` フラグなし時に `tmux:pane-focused` イベント未発行
- **ファイル**: `internal/tmux/command_router_handlers_window.go:157-161`
- **カテゴリ**: command_router
- **詳細**: `-d` 指定なしの場合 `SetActivePane` でアクティブウィンドウも変更されるが、`tmux:pane-focused` イベントが発行されていない。`handleSelectWindow` や `handleSelectPane` では発行している。
- **修正案**: snapshot deltaから導出する設計意図ならコメントで明記。そうでなければイベント発行を追加。

### I-3: `ResolveTarget` で `@id` 形式のウィンドウターゲットが解決できない
- **ファイル**: `internal/tmux/session_manager_targets.go:54-60`
- **カテゴリ**: session_manager
- **詳細**: `ResolveTarget` はウィンドウ部分を `strconv.Atoi(windowPart)` でパースしているが、`@<windowID>` 形式はサポートしていない。`handleSelectWindow` が `resolveTargetFromRequest` 経由でこのメソッドを呼ぶため、安定ID指定による選択が機能しない場合がある。
- **修正案**: `@N` 形式のサポートを追加、またはサポート対象外であることをドキュメントに明記。

### I-4: `models.ts` の `WorktreeConfig` 配列フィールドの null安全性喪失
- **ファイル**: `frontend/wailsjs/go/models.ts:66-68`
- **カテゴリ**: Frontend
- **詳細**: `setup_scripts`, `copy_files`, `copy_dirs` から `?? []` ガードが削除された。Go側でnil sliceが `null` として送信された場合、TypeScript型 `string[]` なのに実行時の値が `null`/`undefined` になる。
- **修正案**: Wails自動生成ファイルのため、Go側でnil slice → 空slice `[]` 保証を追加。

### I-5: `select-window` / `kill-window` に `-t` 必須バリデーションがない
- **ファイル**: `cmd/tmux-shim/parse.go:90-107`
- **カテゴリ**: tmux-shim
- **詳細**: `kill-session`, `has-session`, `attach-session` は `-t` を必須バリデーションしているが、`select-window` と `kill-window` にはない。ターゲットなしでは意味のある動作にならない可能性が高い。
- **修正案**: 意図的かどうか確認の上、バリデーション追加を検討。

### I-6: `set-environment` の位置引数(KEY, VALUE)バリデーションが不在
- **ファイル**: `cmd/tmux-shim/parse.go:90-107`
- **カテゴリ**: tmux-shim
- **詳細**: `set-environment` は最低限KEY引数が必須だが、`validateRequired` でバリデーションされていない。

### I-7: Terminal.Close() のパターン不統一
- **ファイル**: `internal/tmux/command_router_handlers_window.go:195-202` / `session_manager_pane_lifecycle.go`
- **カテゴリ**: command_router
- **詳細**: `KillPane` はSessionManager内でTerminalをCloseするが、`RemoveWindowByID`/`RemoveWindow` はCaller側でCloseする。2つの異なるパターンが存在し、将来的なバグの温床。

### I-8: `removeWindowAtIndexLocked` の冗長な条件分岐（デッドコード）
- **ファイル**: `internal/tmux/session_manager_windows.go:115-120`
- **カテゴリ**: session_manager
- **詳細**: `activeWindow == nil || (removedWindowID >= 0 && session.ActiveWindowID == removedWindowID)` — 削除後のスライスで `findWindowByID` を呼んでいるため、削除したウィンドウが見つかることはなく `activeWindow == nil` が常にtrue。`||` 以降は到達不能。
- **修正案**: 条件を整理して可読性を向上。

### I-9: テスト不足: `RemoveWindow`/`RenameWindow` の negative windowID ケース
- **ファイル**: `app_window_api_test.go`
- **カテゴリ**: App層テスト
- **詳細**: `RemoveWindow` は `windowID < 0` でエラーを返すが、テストケースにネガティブ値のケースがない。同様に `RenameWindow` の `windowID < 0` テストも不足。
- **修正案**: テーブル駆動テストにネガティブ値ケースを追加。

### I-10: `SessionView.tsx` の `confirmRemoveWindow` が `useCallback` 未使用
- **ファイル**: `frontend/src/components/SessionView.tsx:148-157`
- **カテゴリ**: Frontend
- **詳細**: `onRemoveWindow`, `onAddWindow` 等は `useCallback` でラップされているのに、`confirmRemoveWindow` だけインラインで毎回再生成。一貫性に欠ける。

### I-11: `usePrefixKeyMode` の `Prefix+x` でペイン閉じ時に `ConfirmDialog` が表示されない
- **ファイル**: `frontend/src/hooks/usePrefixKeyMode.ts:97-101`
- **カテゴリ**: Frontend
- **詳細**: `TerminalPane.tsx` では `window.confirm` → `ConfirmDialog` に変更されたが、`usePrefixKeyMode` の `Prefix+x` では確認なしでペインが閉じられる。UI操作とキーバインドで挙動が異なる。

---

## Suggestions (17件)

### S-1: `resize-pane` に `-U`, `-D`, `-L`, `-R` 方向フラグが未定義
- **ファイル**: `cmd/tmux-shim/spec.go:94-100`
- **詳細**: tmux標準の方向指定リサイズフラグが未定義。

### S-2: `kill-pane` に `-a` フラグが未定義
- **ファイル**: `cmd/tmux-shim/spec.go:89-93`
- **詳細**: `kill-pane -a -t %0`（対象以外を全て閉じる）が未定義。

### S-3: `init()` panic のメッセージにプレフィックス追加推奨
- **ファイル**: `cmd/tmux-shim/spec.go:162-165`
- **修正案**: `panic("tmux-shim: command spec inconsistency: " + err.Error())`

### S-4: テスト未カバーパターン (tmux-shim)
- `resize-pane` の `-x 0` / `-y 0` 境界値テスト
- `select-pane -T ""` 空文字タイトルテスト
- `show-environment` フラグなし（引数なし）の正常系
- `new-window` の `-e` + 空白キーのエッジケース

### S-5: CSS変数 `--bg` が `:root` に未定義
- **ファイル**: `frontend/src/styles/layout.css:287`
- **詳細**: `.window-tab-rename-input` で `var(--bg, #1e1e2e)` を使用しているが、`--bg` は未定義（`--bg-panel`, `--bg-elev` のみ）。フォールバック値 `#1e1e2e` が `--bg-panel: #101928` と不一致。
- **修正案**: `var(--bg-panel)` に変更。

### S-6: CSS変数 `--danger` フォールバック値不一致
- **ファイル**: `frontend/src/styles/layout.css:311`
- **詳細**: `var(--danger, #f38ba8)` フォールバック値が実定義値 `#ff6b6b` と異なる。

### S-7: 最後のウィンドウ削除時のUI保護
- **ファイル**: `frontend/src/components/SessionView.tsx:96-99`
- **詳細**: ウィンドウ数が1の場合に×ボタンを disabled にするか確認メッセージを変更すると良い。

### S-8: `stableWindowTarget` のフォーマット意図をコメント明示
- **ファイル**: `app_window_api.go:111-113`
- **詳細**: `@` プレフィックスが tmux のウィンドウID構文であることのコメント追加推奨。

### S-9: `removedPaneIDs` の結果順序不定
- **ファイル**: `app_window_api.go:122-132`
- **詳細**: map イテレーション結果のため順序不定。ログ出力の安定性のため `sort.Strings` 推奨。

### S-10: `TestAddWindow` 成功ケースでwindow増加の検証不足
- **ファイル**: `app_window_api_test.go:27-35`
- **詳細**: `err == nil` のみ検証。`sessions.Snapshot()` でwindow数増加の確認推奨。

### S-11: `ActivePaneIDs` の命名改善
- **ファイル**: `internal/tmux/session_manager_snapshot.go:60-72`
- **詳細**: 実際には「全ての管理対象pane」のID集合を返すが、名前から「アクティブ状態のpane」と誤読される。`ManagedPaneIDs` や `AllPaneIDs` が明確。

### S-12: `format.go` の `window_index` が安定IDを返す
- **ファイル**: `internal/tmux/format.go:117`
- **詳細**: tmuxの `#{window_index}` は0-based表示順序だが、ここでは `window.ID`（安定ID）を返す。設計意図をコメントに明記推奨。

### S-13: `handleSelectWindow` で `-t` 未指定時のエラーメッセージが "no sessions"
- **ファイル**: `internal/tmux/command_router_handlers_window.go:217-220`
- **詳細**: `-t` が空の場合 `resolveTargetFromRequest` に委譲されるが、空セッション時は "no sessions" エラー。"missing required flag: -t" の方が明確。

### S-14: `AddWindow` に `windowName` パラメータ不足
- **ファイル**: `app_window_api.go:13-32`
- **詳細**: ウィンドウ名を作成時に指定できない。将来の拡張性を考慮すると改善すべき。

### S-15: テスト不足 — `AddWindow` 後の `ActiveWindowID` 不変性検証
- **ファイル**: `internal/tmux/session_manager_test.go`
- **詳細**: `AddWindow` 後に `ActiveWindowID` が変更されないことの確認テストがない。

### S-16: ConfirmDialog の英語テキスト混在
- **ファイル**: `frontend/src/components/SessionView.tsx:228-240`
- **詳細**: タブの×ボタンtitleは「ウィンドウを閉じる」(日本語) だが ConfirmDialog は英語。

### S-17: `windowLabel` fallback が安定IDを数値表示
- **ファイル**: `frontend/src/components/SessionView.tsx:93-99`
- **詳細**: ウィンドウ名が空の場合に内部安定IDをラベル表示。ユーザーに見えるインデックスとの乖離が生じうる。

---

## Strengths (良い点)

### P-1: `ActiveWindowID` のフィールド伝播が完全
SessionManager → SessionSnapshot → Delta比較 → Metrics推定 → フロントエンド型 → フィールド数ガードテスト — 全レイヤーで正しく更新されている。

### P-2: 安定IDベースのウィンドウアドレッシング設計
`stableWindowTarget` (`session:@windowID`) + `parseStableWindowIDTarget` でindex-baseのTOCTOU問題を回避する優れた設計。

### P-3: イベントシステムの網羅性
`tmux:window-created`, `tmux:window-destroyed`, `tmux:window-renamed`, `tmux:session-renamed` の4イベントが `shouldEmitSnapshotForEvent` と `shouldBypassSnapshotDebounceForEvent` の両方に正しく追加。対応テストも対称的。

### P-4: `resolveActiveWindow` の3段フォールバック
Frontend側の `resolveActiveWindow` が `active_window_id → active pane → 先頭window → null` の3段フォールバックで堅牢。バックエンド不整合時にも崩れない。

### P-5: ロック戦略の一貫性
全公開メソッドが `defer m.mu.Unlock()` パターンを使用。`killPaneLocked` がTerminal Close をロック外で実行する分離設計。

### P-6: generation カウンタの3層設計
`generation` / `topologyGeneration` / `snapshotGeneration` の3層で変更追跡し、不要な再構築を回避。

### P-7: `validateCommandSpecConsistency` + `init()` パターン
`commandOrder` と `commandSpecs` の双方向整合性チェックを起動時に自動実行。新コマンド追加時の不整合を確実に検出。

### P-8: テストの充実度
テーブル駆動テストの一貫した使用、イベント発行の検証（回数・ペイロード・順序）、フィールド数ガードテスト、コピー返却の安全性検証など、多層的なテストカバレッジ。

### P-9: ConfirmDialog への移行
`window.confirm` → `ConfirmDialog` コンポーネントへの移行でアプリ内UI一貫性が向上。

### P-10: 環境変数の冪等更新
`SetSessionEnv` / `UnsetSessionEnv` が同値再設定・欠落キー削除で `generation` を上げないことで、不要なスナップショット再構築を防止。

---

## Recommended Action

### 1. Critical修正（最優先）
1. **C-1**: `ApplyLayoutPreset` の `windowIdx: 0` → アクティブウィンドウIDベースに変更
2. **C-2**: `App.AddWindow`/`RemoveWindow`/`RenameWindow` のイベント/スナップショット発行パターン統一
3. **C-3**: `RemoveWindow` のクリーンアップ二重実行 → `KillSession` パターンに統一

### 2. Important修正
- I-1〜I-11 を抽出順に対応

### 3. Suggestion検討
- S-1〜S-17 を対応可能なものから実施

### 4. 修正後に対象レビューを再実行して検証

---

## 修正タスク一覧と並列作業可否

作業者が効率よく修正に当たれるよう、各タスクの依存関係と並列作業の可否を整理しました。

| # | タスク | 重要度 | 対象ファイル | 並列可否 | 備考 |
|---|--------|--------|-------------|---------|------|
| T-1 | `ApplyLayoutPreset` の windowIdx=0 ハードコード修正 | Critical | `app_pane_api.go` | ✅ 独立作業可 | 他タスクと依存なし |
| T-2 | `AddWindow`/`RemoveWindow`/`RenameWindow` のイベント発行パターン統一 | Critical | `app_window_api.go` | ✅ 独立作業可 | T-3 と同一ファイルだが修正箇所が異なる |
| T-3 | `RemoveWindow` の二重クリーンアップ → KillSession パターン統一 | Critical | `app_window_api.go` | ⚠️ T-2 と同時は注意 | T-2 と同一ファイル。同時に修正すると衝突の可能性。T-2 の後に適用推奨 |
| T-4 | `usePrefixKeyMode` にウィンドウ切替キーバインド追加 | Important | `usePrefixKeyMode.ts` | ✅ 独立作業可 | Frontend のみ |
| T-5 | `handleNewWindow` の `-d` なし時のイベント発行/コメント追加 | Important | `command_router_handlers_window.go` | ✅ 独立作業可 | Backend のみ |
| T-6 | `ResolveTarget` の `@id` 形式サポート or ドキュメント追加 | Important | `session_manager_targets.go` | ✅ 独立作業可 | Backend のみ |
| T-7 | `models.ts` の配列null安全性（Go側でnil→空slice保証） | Important | Go側の Worktree Config 型 | ✅ 独立作業可 | 自動生成ファイルのため Go 側修正 |
| T-8 | `select-window`/`kill-window` の `-t` 必須バリデーション追加 | Important | `cmd/tmux-shim/parse.go` | ✅ 独立作業可 | shim パーサーのみ |
| T-9 | `set-environment` の KEY 引数バリデーション追加 | Important | `cmd/tmux-shim/parse.go` | ⚠️ T-8 と同一ファイル | T-8 と同時修正推奨 |
| T-10 | Terminal.Close() パターン統一検討 | Important | `command_router_handlers_window.go`, `session_manager` | ⚠️ T-5 と関連 | 設計判断が必要。議論の上で実施 |
| T-11 | `removeWindowAtIndexLocked` のデッドコード整理 | Important | `session_manager_windows.go` | ✅ 独立作業可 | 小規模修正 |
| T-12 | `RemoveWindow`/`RenameWindow` の negative windowID テスト追加 | Important | `app_window_api_test.go` | ✅ 独立作業可 | テスト追加のみ |
| T-13 | `confirmRemoveWindow` の `useCallback` ラップ | Important | `SessionView.tsx` | ✅ 独立作業可 | Frontend のみ |
| T-14 | `Prefix+x` ペイン閉じの ConfirmDialog 有無検討 | Important | `usePrefixKeyMode.ts` | ⚠️ T-4 と同一ファイル | T-4 と同時修正推奨 |
| T-15 | CSS変数 `--bg` → `--bg-panel` 修正 | Suggestion | `layout.css` | ✅ 独立作業可 | 1行修正 |
| T-16 | CSS変数 `--danger` フォールバック値修正 | Suggestion | `layout.css` | ✅ T-15 と同時可 | 1行修正 |
| T-17 | テスト追加(shim): 境界値・エッジケース | Suggestion | `main_test.go` | ✅ 独立作業可 | テスト追加のみ |
| T-18 | `stableWindowTarget` のコメント追加 | Suggestion | `app_window_api.go` | ✅ 独立作業可 | コメントのみ |
| T-19 | `format.go` `window_index` のコメント追加 | Suggestion | `format.go` | ✅ 独立作業可 | コメントのみ |
| T-20 | `ActivePaneIDs` → `AllPaneIDs` 命名変更検討 | Suggestion | 複数ファイル | ⚠️ 広範囲 | IDE rename refactoring 推奨 |

### 並列作業グループの推奨

| グループ | 含まれるタスク | 理由 |
|---------|-------------|------|
| **Group A (Critical)** | T-1, T-2+T-3 | T-1 は独立。T-2 と T-3 は同一ファイルなので順次実施 |
| **Group B (Backend)** | T-5, T-6, T-11 | 全て異なる Go ファイルで独立 |
| **Group C (shim)** | T-8+T-9 | 同一ファイルなのでまとめて実施 |
| **Group D (Frontend)** | T-4+T-14, T-13, T-15+T-16 | T-4とT-14は同一ファイル。他は独立 |
| **Group E (テスト)** | T-12, T-17 | テスト追加のみで独立 |
| **Group F (設計判断)** | T-7, T-10, T-20 | 設計議論・広範囲影響のため個別判断 |

**Group A → B, C, D, E は並列実行可能。Group F は別途判断。**
