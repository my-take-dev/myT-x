# PR Review Summary - 2026/02/18 07:55

**レビュー対象:** myT-x配下の未コミット変更（56ファイル, +4751/-1350行）

## レビューカテゴリ別ファイル分類

| カテゴリ | ファイル群 |
|---------|-----------|
| Cat1: App Events/Snapshot/Status | `app_events.go`, `app_events_test.go`, `app_snapshot_delta.go`, `app_snapshot_delta_test.go`, `app_snapshot_metrics.go`, `app_snapshot_metrics_test.go`, `app_status.go`, `app_status_test.go` |
| Cat2: Window API (新規) | `app_window_api.go` (new), `app_window_api_test.go` (new) |
| Cat3: tmux-shim CLI | `cmd/tmux-shim/parse.go`, `cmd/tmux-shim/spec.go`, `cmd/tmux-shim/main_test.go` |
| Cat4: Frontend | `frontend/src/App.tsx`, `frontend/src/api.ts`, `frontend/src/components/SessionView.tsx`, `frontend/src/components/TerminalPane.tsx`, `frontend/src/hooks/usePrefixKeyMode.ts`, `frontend/src/styles/layout.css`, `frontend/src/types/tmux.ts`, `frontend/src/utils/session.ts` (new), `frontend/wailsjs/go/**` |
| Cat5: Command Router | `internal/tmux/command_router*.go`, `internal/tmux/command_router*_test.go` |
| Cat6: Session Manager | `internal/tmux/session_manager*.go`, `internal/tmux/session_manager*_test.go` |
| Cat7: Format/KeyTable | `internal/tmux/format.go`, `internal/tmux/format_test.go`, `internal/tmux/key_table.go`, `internal/tmux/key_table_test.go` |

---

## Critical Issues（7件 — 修正必須）

### [C-1] Window API: `requestSnapshot` / イベント通知が全関数で欠落
- **ファイル:** `app_window_api.go` L14, L36, L82
- **問題:** `AddWindow`, `RemoveWindow`, `RenameWindow` のいずれも `requestSnapshot(true)` やフロントエンドイベント (`emitBackendEvent`) を呼び出していない。既存の全ミューテーション API（`CreateSession`, `KillSession`, `RenameSession`, `KillPane`, `FocusPane`, `SwapPanes`）はすべてスナップショット通知を行っており、パターンに矛盾。**フロントエンドがウィンドウ操作を検知できない。**
- **修正案:** 各関数の `return nil` の前に `a.requestSnapshot(true)` を追加。

### [C-2] Window API: `RemoveWindow` で pane state が二重クリーンアップ
- **ファイル:** `app_window_api.go` L67-L72
- **問題:** `stopOutputBuffer(paneID)` は内部で `flusher.RemovePane` **と** `paneStates.RemovePane` の両方を呼び出す。その直後の `cleanupDetachedPaneStates(detachStaleOutputBuffers(...))` が再び `paneStates.RemovePane` を呼ぶため、同 paneID に対して2回実行。`KillSession` のパターン（`detachStaleOutputBuffers` + `cleanupDetachedPaneStates` のみ）と一貫していない。
- **修正案:** `stopOutputBuffer` ループを削除し、`KillSession` と同じパターンに統一。

### [C-3] Command Router: `handleNewWindow` ロールバック時の TOCTOU リスク
- **ファイル:** `internal/tmux/command_router_handlers_window.go` L83-L97
- **問題:** `rollbackWindow` 内で `WindowIndexInSession(sessionName, window.ID)` によりインデックスを再計算してから `RemoveWindow` を呼んでいるが、並行的な window 追加があった場合にインデックスがシフトし、間違った window が削除される可能性がある。
- **修正案:** `RemoveWindowByID` を使用するか、AddWindow のリターン値から直接インデックスを保持してロールバックに使用。

### [C-4] Session Manager: `Snapshot()` キャッシュが共有可変ポインタを返す
- **ファイル:** `internal/tmux/session_manager_snapshot.go` L7-L15
- **問題:** キャッシュヒット時に `SessionSnapshot` 内の `Worktree *SessionWorktreeInfo` と `WindowSnapshot.Layout *LayoutNode` がポインタのため、呼び出し元がこれらを変更するとキャッシュ汚染が発生する。ドキュメントに「read-only」とあるがコンパイラが強制しない。
- **修正案:** キャッシュヒット時にもポインタフィールドの shallow copy を返す。

### [C-5] Session Manager: 公開メソッドが内部 `*TmuxPane` / `*TmuxSession` ポインタを返す
- **ファイル:** `session_manager_sessions.go` L52-L80, `session_manager_pane_io.go` L17, `session_manager_targets.go` L8, `session_manager_panes.go` L8
- **問題:** `CreateSession`, `ListPanesByWindowTarget`, `ResolveTarget`, `SplitPane` が SessionManager 内部のポインタをそのまま返す。呼び出し元がロックなしでフィールドを変更し、同時に `Snapshot()` 等が読み取るとデータレースになる。テストコードでも無ロック変更が散見される。
- **修正案:** 短期: テストで直接変更を公開API経由に統一。長期: 返却型を value 型 or clone に変更。

### [C-6] Frontend: `TerminalPane` の `pendingFontSize` と `term.options.fontSize` の競合
- **ファイル:** `frontend/src/components/TerminalPane.tsx` L265
- **問題:** `handleWheel` クロージャ内で `pendingFontSize` をローカル変数として管理。`setFontSize` が呼ばれた結果、別の `useEffect` が `term.options.fontSize` を更新するため、高速ホイール中に `pendingFontSize` と実際の `term.options.fontSize` が不一致になり得る。
- **修正案:** `handleWheel` 内で `current` を `term.options.fontSize` から直接読むように統一。

### [C-7] Frontend: `useBackendSync` の `EventsOff` が全リスナーを解除する
- **ファイル:** `frontend/src/hooks/useBackendSync.ts` L151-L163
- **問題:** `EventsOff("tmux:snapshot")` はそのイベント名の**全リスナーを解除**する。`StatusBar` も同名イベントを購読している場合、`useBackendSync` のクリーンアップで `StatusBar` のリスナーも巻き添えで解除される。
- **修正案:** `EventsOn` の戻り値（cleanup関数）を使ってリスナー単位でクリーンアップする。

---

## Important Issues（25件 — 修正推奨）

### Cat1: App Events/Snapshot/Status

| # | 問題 | ファイル | 概要 |
|---|------|---------|------|
| I-1 | debounce 戦略のコメント不足 | `app_events.go` L247-L251 | leading-edge fixed-window debounce を使用。trailing-edge と異なる動作をコメントで明示すべき |
| I-2 | マジックナンバー | `app_events.go` L120-L121 | `16ms`, `8*1024` を名前付き定数に切り出す |
| I-3 | `snapshotDelta` の防御ガードコメント不足 | `app_snapshot_delta.go` L166 | 到達条件の説明がない |
| I-4 | フィールド数テストの重複 | `app_snapshot_delta_test.go` / `app_snapshot_metrics_test.go` | 2ファイルに完全重複のフィールド数テスト |
| I-5 | `resolvePaneTitle` のエッジケーステスト不足 | `app_status_test.go` | 空panes、activePN不一致、Active=trueのテスト欠落 |
| I-6 | `syncPaneStates` の直接テスト不在 | `app_events_test.go` | `EnsurePane`, `SetActivePanes`, `RetainPanes` が正しく呼ばれることの検証なし |

### Cat2: Window API

| # | 問題 | ファイル | 概要 |
|---|------|---------|------|
| I-7 | `requireRouter` と `requireSessions` 別々呼び出し | `app_window_api.go` L47-L53 | `requireSessionsAndRouter()` に統一すべき |
| I-8 | 負の `windowID` バリデーションテスト欠落 | `app_window_api_test.go` | `windowID: -1` のテストケースなし |
| I-9 | 複数ウィンドウ存在時の `RemoveWindow` テスト欠落 | `app_window_api_test.go` | セッション存続ケース未テスト |
| I-10 | `removedPaneIDs` ヘルパーのユニットテスト欠落 | `app_window_api.go` L124-L135 | 差分計算ロジックの直接テストなし |

### Cat3: tmux-shim

| # | 問題 | ファイル | 概要 |
|---|------|---------|------|
| I-11 | `new-window` が shell transform 対象外 | `cmd/tmux-shim/command_transform.go` L24-25 | `split-window` と同構造だが変換スコープ外 |
| I-12 | `new-window` が model transform 対象外 | `cmd/tmux-shim/model_transform.go` L23-27 | `modelTransformCommands` マップに未登録 |

### Cat4: Frontend

| # | 問題 | ファイル | 概要 |
|---|------|---------|------|
| I-13 | Ctrl+V ペースト処理が不完全 | `TerminalPane.tsx` L219-222 | WebView2環境でネイティブpasteが動作しない可能性 |
| I-14 | `confirmRemoveWindow` 毎レンダリング再生成 | `SessionView.tsx` L156-165 | `useCallback` でメモ化すべき |
| I-15 | Prefix+x が確認なしでペインkill | `usePrefixKeyMode.ts` L97-102 | UIボタンでは `ConfirmDialog` あり、キーボードにはなし |
| I-16 | `SearchBar` 再開時に前回クエリ残存 | `SearchBar.tsx` L11 | `open` 時に `setQuery("")` すべき |
| I-17 | `useFileDrop` の `activePaneId` stale closure | `useFileDrop.ts` L22-29 | `useRef` パターンに変更すべき |

### Cat5: Command Router

| # | 問題 | ファイル | 概要 |
|---|------|---------|------|
| I-18 | `handleListPanes` のポインタ等価比較 | `command_router_handlers_pane.go` L302-326 | clone返却時に正しくソートされない。ID比較に変更すべき |
| I-19 | `handleSelectWindow` での `paneCtxErr` フォールバック時の TOCTOU | `command_router_handlers_window.go` L217-226 | ロック解放後の内部ポインタアクセス |
| I-20 | `handleNewSession` で `-d` 時の不要な2回目スナップショット取得 | `command_router_handlers_session.go` L66-76 | 意図をコメントで明記すべき |
| I-21 | `append(req.Args, "Enter")` のスライス汚染リスク | `command_router_handlers_pane.go` L108-109 他3箇所 | 防御的にコピーすべき |

### Cat6: Session Manager

| # | 問題 | ファイル | 概要 |
|---|------|---------|------|
| I-22 | `renameWindowByIndexLocked` で nil ウィンドウ未防御 | `session_manager_windows.go` L148-157 | `removeWindowAtIndexLocked` は nil チェックあるが本関数にはない |
| I-23 | `WriteToPane` が RLock 保持中に I/O ブロッキング | `session_manager_pane_io.go` L84-98 | バッファフル時にレイテンシスパイク発生リスク（設計トレードオフとして記録） |
| I-24 | テストが `CreateSession` 返却ポインタを無ロック直接変更 | `session_manager_env_test.go` L286-296 | 公開API経由で設定すべき |

### Cat7: Format/KeyTable

| # | 問題 | ファイル | 概要 |
|---|------|---------|------|
| I-25 | `session_created_human` の nil フォールバックフォーマット不一致 | `format.go` L148-152 | nil時にRFC3339、正常時にhuman-readableで不統一 |

---

## Suggestions（24件 — 改善提案）

### Cat1

| # | 提案 | ファイル |
|---|------|---------|
| S-1 | `emitBackendEvent` TODOにマイルストーン追記 | `app_events.go` L56-57 |
| S-2 | `payloadSizeBytes` default ケースのログを `slog.Debug` に変更 | `app_snapshot_metrics.go` L34-36 |
| S-3 | `estimateStringSize` にWindows パスのバックスラッシュエスケープ考慮 | `app_snapshot_metrics.go` L152-155 |
| S-4 | `BuildStatusLine` で `time.Now()` を1回取得に統一 | `app_status.go` L60-72 |

### Cat2

| # | 提案 | ファイル |
|---|------|---------|
| S-5 | `routerCommandError` を `app_helpers.go` へ移動して汎用化 | `app_window_api.go` L116 |
| S-6 | `stableWindowTarget` のユニットテスト追加 | `app_window_api.go` L112-114 |
| S-7 | スナップショットイベント発行の検証テスト追加（C-1修正後） | `app_window_api_test.go` |

### Cat3

| # | 提案 | ファイル |
|---|------|---------|
| S-8 | `display-message` の `-p` 必須制約にコメント追加 | `cmd/tmux-shim/parse.go` L105-107 |
| S-9 | テストで `wantFlags: nil` 時にフラグ数ゼロアサーション追加 | `cmd/tmux-shim/main_test.go` L1434-1711 |

### Cat4

| # | 提案 | ファイル |
|---|------|---------|
| S-10 | `api.ts` の型安全性向上（`as` キャスト排除） | `frontend/src/api.ts` L47 |
| S-11 | `TerminalPane` のuseEffect分割（210行→3カスタムhook） | `TerminalPane.tsx` L89-296 |
| S-12 | `SessionView` のwindow rename ロジックをカスタムhook分離 | `SessionView.tsx` L98-143 |
| S-13 | CSS変数 `--fg-dim` のフォールバック値統一 | `layout.css` L282/L305 |

### Cat5

| # | 提案 | ファイル |
|---|------|---------|
| S-14 | `captureEmitter` に `Reset()` メソッド追加 | `command_router_test_helpers_test.go` |
| S-15 | `handleAttachSession` で `GetSession` 1回のみパターンに統一 | `command_router_handlers_session.go` L161 |
| S-16 | `handleDisplayMessage` のテスト追加 | テスト未作成 |
| S-17 | `handleAttachSession` テストに `session:nonexistentWindow` ケース追加 | `command_router_handlers_session_test.go` |

### Cat6

| # | 提案 | ファイル |
|---|------|---------|
| S-18 | `WriteToPanesInWindow` のエラーを `errors.Join` で集約 | `session_manager_pane_io.go` L103-118 |
| S-19 | `RenameWindow` で変更前後の名前が同じ場合に mutation スキップ | `session_manager_windows.go` L152-157 |
| S-20 | 並行処理テスト追加（Snapshot concurrent read/mutation等） | `session_manager_test.go` |

### Cat7

| # | 提案 | ファイル |
|---|------|---------|
| S-21 | `formatWindowLine` のnilテストとデフォルトフォーマットテスト追加 | `format_test.go` |
| S-22 | `BSpace`, `Escape`, `Tab` のテストケース追加 | `key_table_test.go` |
| S-23 | 未知キー名のパススルーテスト追加 | `key_table_test.go` |
| S-24 | `session_created_human` の二重展開を一元化 | `format.go` L24-26 / L148-152 |

---

## Strengths（良い点）

### 全体設計
- **ロック設計**: Lock ordering ドキュメントが明確。`snapshotDeltaMu` と `snapshotMu` の分離でホットパスのロック保持時間を最小化
- **3段階 mutation tracking**: `markStateMutationLocked`, `markTopologyMutationLocked`, `markSessionMapMutationLocked` による粒度の細かいキャッシュ無効化
- **ロック-クローズ分離パターン**: `KillPane`, `RemoveSession`, `Close` で一貫してロック内収集→ロック外クローズ

### バックエンド
- **nil ガード**: 起動/シャットダウン境界での nil チェックが一貫して適用
- **フィールド数ガードテスト**: struct フィールド追加時の更新漏れを自動検出
- **paneOutputEventFromPayload**: 値型/ポインタ型/nilポインタの全パターンを正しくハンドル
- **`init()` での仕様整合性チェック**: `commandSpecs` と `commandOrder` の双方向整合性チェック
- **rollback パターンの一貫性**: `handleNewSession`, `splitWindowResolved`, `handleNewWindow` すべてで失敗時ロールバック
- **send-keys の best-effort 設計**: 失敗してもセッション生成を止めない
- **環境変数サニタイゼーション**: blocklist、null byte除去、値長制限が適切

### フロントエンド
- **IME処理**: `isImeTransitionalEvent` が全キーボードハンドラで一貫適用
- **Zustand store**: 個々のセレクタで購読、不要なre-render最小化
- **イベントクリーンアップの網羅性**: 全タイマー、リスナー、observer、addon、IMEリスナーが漏れなく解放
- **`utils/session.ts` ユーティリティ分離**: 複数コンポーネントから再利用

### テスト
- **テストの網羅性**: 全新規コマンドにテーブル駆動テスト（正常系+異常系）
- **並行呼び出し安定性テスト**: `TestSnapshotDeltaConcurrentCallsRemainStable`
- **ベンチマーク**: `BenchmarkSnapshotDelta` でパフォーマンス回帰検出可能
- **テストヘルパー分離**: `captureEmitter` 等の共通化

---

## 統計サマリ

| 重要度 | 件数 |
|--------|------|
| **Critical** | **7** |
| **Important** | **25** |
| **Suggestion** | **24** |
| **Strength** | 多数 |

---

## Recommended Action

1. **Critical Issues を最優先で修正** — 特にC-1（Window API通知欠落）とC-3（ロールバックTOCTOU）は実運用で即座に問題になる
2. **Important Issues を対応** — テスト補強系（I-5,I-6,I-8,I-9,I-10）はまとめて対応可能
3. **Suggestions は時間があれば対応** — リファクタリング系は後回しで可
4. **修正後に再レビュー**

---

## タスク整理 — 並列作業可否表

以下のタスクを修正する際の並列作業安全性を示します。

| タスクID | 修正対象 | 修正概要 | 並列作業 | 理由 |
|---------|---------|---------|:--------:|------|
| C-1 | `app_window_api.go` | `requestSnapshot(true)` 追加 | ✅ 可 | Window API ファイル内で完結 |
| C-2 | `app_window_api.go` | 二重クリーンアップ修正 | ⚠️ C-1と同時 | 同一ファイル内だがC-1とは異なる関数 |
| C-3 | `command_router_handlers_window.go` | `RemoveWindowByID` 使用 | ✅ 可 | Command Router 層で独立 |
| C-4 | `session_manager_snapshot.go` | キャッシュの shallow copy | ⚠️ C-5検討後 | C-5の方針によって copy 範囲が変わる |
| C-5 | `session_manager_*.go` | 内部ポインタ漏洩防止 | ❌ 単独 | 広範囲のAPI変更、他作業と競合しやすい |
| C-6 | `TerminalPane.tsx` | `pendingFontSize` 修正 | ✅ 可 | Frontend 内で独立 |
| C-7 | `useBackendSync.ts` | `EventsOff` → cleanup関数 | ✅ 可 | Frontend 内で独立 |
| I-1〜I-6 | `app_events*.go`, `app_snapshot_*.go`, `app_status*.go` | コメント・テスト補強 | ✅ 可 | 他カテゴリと非依存 |
| I-7〜I-10 | `app_window_api*.go` | テスト補強・パターン統一 | ⚠️ C-1,C-2後 | C-1,C-2の修正後にテストを追加すべき |
| I-11〜I-12 | `cmd/tmux-shim/*.go` | transform スコープ拡張 | ✅ 可 | shim 層で独立 |
| I-13〜I-17 | `frontend/src/**` | Frontend各種修正 | ✅ 可 | 各ファイル独立（ただしI-13,I-14は同時編集注意） |
| I-18〜I-21 | `internal/tmux/command_router*.go` | Router修正 | ✅ 可 | C-3とは異なるハンドラ |
| I-22〜I-24 | `internal/tmux/session_manager*.go` | nil防御・テスト修正 | ⚠️ C-4,C-5検討後 | Session Manager の構造変更と競合しうる |
| I-25 | `internal/tmux/format.go` | フォーマット不一致修正 | ✅ 可 | Format 層で独立 |

### 並列作業グループ提案

効率的に修正するための推奨グループ分け：

| グループ | タスク | 担当範囲 | 前提条件 |
|---------|--------|---------|---------|
| **A: Window API** | C-1, C-2, I-7〜I-10 | `app_window_api*.go` | なし |
| **B: Command Router** | C-3, I-18〜I-21 | `internal/tmux/command_router*.go` | なし |
| **C: Frontend** | C-6, C-7, I-13〜I-17 | `frontend/src/**` | なし |
| **D: tmux-shim** | I-11, I-12 | `cmd/tmux-shim/*.go` | なし |
| **E: Format/KeyTable** | I-25, S-21〜S-24 | `internal/tmux/format*.go`, `key_table*.go` | なし |
| **F: App Events/Snapshot** | I-1〜I-6, S-1〜S-4 | `app_events*.go`, `app_snapshot_*.go`, `app_status*.go` | なし |
| **G: Session Manager** | C-4, C-5, I-22〜I-24 | `internal/tmux/session_manager*.go` | **単独作業推奨**（広範囲変更） |

> **グループ A〜F は全て並列実行可能。グループ G は他グループ完了後に単独で実施推奨。**

### 優先度別作業順序

```
Phase 1（並列）: グループ A + B + C + D + E + F
    ↓
Phase 2（単独）: グループ G（Session Manager 構造改善）
    ↓
Phase 3: 再レビュー
```
