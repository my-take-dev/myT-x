# PR Review Summary — 2026-02-18 18:10

## レビュー概要

| カテゴリ | 対象ファイル数 | Critical | Important | Suggestions |
|---|---|---|---|---|
| 1. App Layer | 8 | 0 | 1 | 5 |
| 2. tmux-shim | 3 | 0 | 3 | 5 |
| 3. Frontend | 11 | 2 | 5 | 7 |
| 4. tmux internal (command_router, format, key_table) | 11 | 0 | 4 | 7 |
| 5. session_manager | 10 | 0 | 4 | 5 |
| 6. Cross-Cutting (モジュール横断) | — | 1 | 4 | 5 |
| **合計** | **43** | **3** | **21** | **34** |

---

## Critical Issues (3件 — 必ず修正)

### C-1. [app_pane_api.go:198] `ApplyLayoutPreset` が `windowIdx: 0` をハードコード（横断レビュー）

`sessions.ApplyLayoutPreset(sessionName, 0, ...)` でウィンドウインデックスが常に `0` 固定。マルチウィンドウ対応後、ユーザーが2番目以降のウィンドウでレイアウトプリセットを適用すると、**常にウィンドウ0のレイアウトが変更される**。

- **影響**: フロントエンドの `LayoutPresetSelector` はアクティブウィンドウのペイン数を表示しているが、バックエンドは常にwindow[0]を変更するため、UIの見た目と実際の操作対象が不一致になる。
- **修正案**: `ActiveWindowID` をベースに window index を解決するか、`ApplyLayoutPresetByWindowID(sessionName, windowID, preset)` メソッドを追加する。

### C-2. [SessionView.tsx:194-212] `confirmRemoveWindow` が早期return後に定義されている

`confirmRemoveWindow` は `return` の直前で通常関数として定義されている。この関数は早期returnガード（`!props.session`, `windows.length === 0`, `!activeWindow`）の**後に**定義されている。`ConfirmDialog` の `open={true}` の状態で `props.session` が null になった場合、コンポーネントが早期returnしてダイアログが消滅し、ユーザー操作が中断される。`pendingRemoveWindowID` のstateは残ったままになる。

- **修正案**: 早期returnの前に `pendingRemoveWindowID !== null` の場合のガード処理を追加するか、`ConfirmDialog` を早期returnの影響を受けない位置に移動する。

### C-3. [SessionView.tsx:118-121] `renameInputRef` が複数のウィンドウタブで共有される

`renameInputRef` は1つの `useRef<HTMLInputElement>` だが、`.map()` 内でリネーム中のタブの `<input>` に `ref={renameInputRef}` を設定している。現状は同時に1つのタブしかリネームモードにならないため問題は表面化しないが、将来的なリファクタリングで意図せず複数のinputに同一refが割り当てられるリスクがある。

- **修正案**: `callback ref` パターンに変更するか、コメントで「同時に1つのみリネーム可能」を明記する。

---

## Important Issues (21件 — 修正推奨)

### Category 1: App Layer

#### I-1-1. [app_snapshot_metrics.go:68] `estimateSessionSnapshotSize` のベースサイズ定数 `84` が `ActiveWindowID` 追加後に未更新

コメントのJSONテンプレートに `active_window_id` が追加されているにもかかわらず `size := 84` が据え置き。ベース定数を `84 + 19 = 103` 程度に更新すべき。メトリクス用途のみで機能への影響はないが、フィールド追加時にベース定数を更新する運用が漏れている。

---

### Category 2: tmux-shim

#### I-2-1. [spec.go / command_transform.go] `new-window` に対する shell/model transform が未実装

`applyShellTransform` は `new-session` と `split-window` のみ対象。今回 `new-window` が spec に追加され `-c`, `-e`, `--` 引数をサポートしているが、Windows環境でのUnixコマンド変換が適用されない。`applyShellTransform` の `case` に `"new-window"` を追加すべき。

#### I-2-2. [parse.go:100] `rename-session` の `-t` バリデーション欠落

サーバー側 `handleRenameSession` では `-t` を要求しているが、shim側の `validateRequired` で `rename-session` が `-t` 必須のケースに含まれていない。IPC往復後に分かりにくいエラーになる。

#### I-2-3. [parse.go:96-99] `validateNonNegativeSizeFlags` の呼び出し順序

`validateRequired` の先頭で `validateNonNegativeSizeFlags` を呼んでいるため、例えば `resize-pane -x -1`（`-t` なし）で `-x` のエラーが先に返される。ユーザーにとっては `-t` 不足のエラーの方が有用。バリデーション順序を変更すべき。

---

### Category 3: Frontend

#### I-3-1. [SessionView.tsx:152-155] `renamingWindowIdRef` の二重同期が冗長

`setRenamingWindow` 内で `renamingWindowIdRef.current = id` を設定済みなのに、`useEffect` で再度 `null` 設定している。`setRenamingWindowId` が直接呼ばれるケースは存在しないため、この effect は冗長でロジック意図が不明瞭。

#### I-3-2. [SessionView.tsx:85-92] `onSelectWindow` が `FocusPane` APIのみでウィンドウ切替

ウィンドウ切替を `FocusPane` で行っているが、バックエンドの `FocusPane` → `SetActivePane` が内部的に `ActiveWindowID` を更新する前提。バックエンドの実装は正しく動作するが、この暗黙的な依存関係をコメントで明記すべき。

#### I-3-3. [models.ts:67-69] `?? []` のフォールバック削除

`setup_scripts`, `copy_files`, `copy_dirs` から `?? []` フォールバックが削除された。Go側で `omitempty` が設定されている場合、TypeScript側で `.map()` や `.length` 呼出でランタイムエラーの可能性。バックエンドのJSON出力を確認し、null可能性がある場合は `?? []` を維持すべき。

#### I-3-4. [SessionView.tsx:100-106] `windowLabel` が `useCallback` で空の依存配列だがメモ化の意味が薄い

純粋関数であり外部stateに依存しない。コンポーネント外のヘルパー関数として抽出する方が明確。

#### I-3-5. [App.tsx:35] `lastSyncedSessionRef` の定義位置

`useRef` が `usePrefixKeyMode` と `useFileDrop` の後に呼ばれている。フックの慣例として先頭にまとめるべき。

---

### Category 4: tmux internal

#### I-4-1. [command_router_terminal.go:40-45] `attachPaneTerminal` のnil分岐がデッドコード

`NewCommandRouter` が常に `router.attachTerminalFn = router.attachTerminal` を設定するため、nil分岐は到達不能。削除するか防御的コードであることをコメントで明記すべき。

#### I-4-2. [command_router_handlers_window.go:119-122] `defaultWindowListFormat` の `#{window_index}` がtmuxと異なるセマンティクス

`window_index` は `window.ID`（安定ID）を返すが、tmux では位置ベースのインデックス。`list-windows` の出力で非連続番号になる可能性がある。変数名を `window_id` に変更するか、コメントでtmuxとの差異を明記すべき。

#### I-4-3. [command_router_handlers_window.go:289-296] `handleSelectWindow` のフォールバックで `target.Window.Session.Name` がロック外アクセス

`GetPaneContextSnapshot` 失敗時のフォールバックで生ポインタのフィールドを参照。`resolveTargetFromRequest` 直後に `sessionName` を取得しておくべき。

#### I-4-4. [key_table.go:30-38] `parseControlKey` が `C-@`（NUL）等の特殊制御文字に非対応

tmux では `C-@` は NUL (0x00)、`C-]` (0x1D)、`C-\` (0x1C)、`C-^` (0x1E)、`C-_` (0x1F) が使用可能。テーブルに追加するか `parseControlKey` を拡張すべき。

---

### Category 5: session_manager

#### I-5-1. `TmuxSession` / `SessionSnapshot` のフィールド数ガードテストが不在

`TmuxSession` (11フィールド) / `SessionSnapshot` (9フィールド) のフィールド追加検知テストがない。`RouterOptions` には同種のガードが存在しており同パターンを適用すべき。

#### I-5-2. [session_manager_windows.go:125-131] `removeWindowAtIndexLocked` のデッドコード条件

`session.ActiveWindowID == removedWindowID` チェックは、削除済みIDが `findWindowByID` で見つからず `activeWindow == nil` となるため常にデッドコード。`killPaneLocked` と一貫性がない。

#### I-5-3. [session_manager_panes.go:73] `SetActivePane` の `ActiveWindowID` 更新テストが不足

`SetActivePane` で別ウィンドウのペインをアクティブにした際に `ActiveWindowID` が切り替わることを検証するテストがない。

#### I-5-4. [session_manager_pane_lifecycle.go:129-187] `removedWindowIdx` セマンティクスが不正確

`removedWindowIdx` は元スライスのインデックスだが、`nextWindows` に対する `fallbackWindowIDNearIndex` に渡される。実害はないがコメントで「空間的ヒントとして使用」を明記すべき。

---

### Category 6: Cross-Cutting (横断)

#### I-6-1. [app_window_api.go, command_router_handlers_window.go] `AddWindow` 後の `ActiveWindowID` 更新フローのドキュメント不足

`AddWindow` は「`ActiveWindowID` を変更しない」とコメントにあるが、呼出元 `handleNewWindow` が `-d` 無しで `SetActivePane` を呼ぶことで間接的に更新される。この設計判断をより明確にドキュメントすべき。

#### I-6-2. [app_session_api.go:111] `RenameSession` (App層) が `tmux:session-renamed` イベントを発行しない

コマンドルーター経由のリネームでは `tmux:session-renamed` が emit されるが、App層直接呼出では `requestSnapshot(true)` のみ。二重パスの存在が保守リスク。

#### I-6-3. `SetActivePane` がイベントを発行しないため `handleNewWindow` / `handleSelectWindow` でのイベント順序が非直感的

`tmux:window-created` が emit されるが `tmux:pane-focused` は emit されない。スナップショットベースの同期で吸収されているが、直感に反する。

#### I-6-4. [session_manager_env.go] `SessionSnapshot` に `Env` フィールドがない

`SetSessionEnv` は `markStateMutationLocked()` でキャッシュ無効化するが、スナップショットに `Env` が含まれずフロントエンドに伝播しない。将来UI表示が必要になった場合の設計課題。

---

## Suggestions (34件 — 改善推奨)

### Category 1: App Layer

| # | ファイル | 内容 |
|---|---|---|
| S-1-1 | app_events.go:102-108 | `shouldBypassSnapshotDebounceForEvent` と `shouldEmitSnapshotForEvent` のイベントリスト差分を意図的であることを示すコメント追加 |
| S-1-2 | app_status.go:56-66 | `resolveActiveWindowSnapshot` フォールバック時のデバッグログ追加 |
| S-1-3 | app_snapshot_delta_test.go:126-155 | `TestSnapshotDeltaDetectsActiveWindowIDChange` で `testSnapshot` ヘルパーを使用 |
| S-1-4 | app_status_test.go | `BuildStatusLine` で `ActiveWindowID` が非0の場合のテスト追加 |
| S-1-5 | app_snapshot_metrics.go:68 | コメント行の分割（可読性改善） |

### Category 2: tmux-shim

| # | ファイル | 内容 |
|---|---|---|
| S-2-1 | spec.go:189-193 | `init()` の `panic` を将来的にgraceful degradationへ変更検討 |
| S-2-2 | main_test.go | `rename-session` 引数完全なしのテストケース追加 |
| S-2-3 | main_test.go | `new-window` の `-t` 省略時テストケース追加 |
| S-2-4 | main_test.go | `kill-pane without flags succeeds` で `Flags`/`Args`/`Env` が空であることを明示検証 |
| S-2-5 | spec.go | `commandSpec.name` フィールドの冗長性検討（mapキーとの二重管理） |

### Category 3: Frontend

| # | ファイル | 内容 |
|---|---|---|
| S-3-1 | SessionView.tsx 全体 | ウィンドウタブバーロジックをカスタムフック `useWindowTabs` に抽出（コンポーネント肥大化対策） |
| S-3-2 | SessionView.tsx:233-294 | ウィンドウタブバーのキーボードナビゲーション（WAI-ARIA Tabs パターン）追加 |
| S-3-3 | TerminalPane.tsx:617-630 | `ConfirmDialog` が `.terminal-pane`（`overflow: hidden`）内のため Portal使用検討 |
| S-3-4 | layout.css:332-335 | `.window-tab-bar` のスクロールバースタイル追加（他と一貫性） |
| S-3-5 | layout.css:362 | `.window-tab-label` の `max-width: 100px` ハードコード → CSS変数化 |
| S-3-6 | SessionView.tsx:135-143 | `commitWindowRename` のstale closure対策（race condition可能性） |
| S-3-7 | usePrefixKeyMode.ts | Prefix + n/p キーバインド（ウィンドウ切替）の追加検討 |

### Category 4: tmux internal

| # | ファイル | 内容 |
|---|---|---|
| S-4-1 | command_router_handlers_window_test.go | `handleNewWindow` の `-P`/`-F` フラグテスト追加 |
| S-4-2 | command_router_handlers_window_test.go | `handleNewWindow` の `-d` フラグテスト追加 |
| S-4-3 | command_router_handlers_window_test.go:353-361 | `TestHandleKillWindow` エラー時のセッション存続検証追加 |
| S-4-4 | format.go:52-62 | `firstPaneInSession` を `activePaneInSession` に統合検討 |
| S-4-5 | key_table.go:5-10 | `sendKeysTable` の `C-c`/`C-d`/`C-z` が `parseControlKey` と冗長であることを明記 |
| S-4-6 | command_router_handlers_window.go:208-210 | `GetActivePaneDimensions` 専用メソッド追加（クローンコスト削減） |
| S-4-7 | command_router_handlers_window_test.go | `TestHandleSelectWindow` でイベントペイロードに `windowId` 含有検証 |

### Category 5: session_manager

| # | ファイル | 内容 |
|---|---|---|
| S-5-1 | session_manager_targets.go:176-180 | `activeWindowInSessionLocked` の条件が常にtrueであることのコメント追加 |
| S-5-2 | session_manager_snapshot.go | `Snapshot()` での `ActiveWindowID` 整合性バリデーション検討 |
| S-5-3 | session_manager_env_test.go:9-13 | `generationForTest` ヘルパーの配置を `testutil_test.go` に集約 |
| S-5-4 | session_manager_env.go | `UnsetSessionEnv` で `Env == nil` 時のサイレント動作のコメント追加 |
| S-5-5 | session_manager_pane_io.go:82-88 | `ListPanesByWindowTarget` で `@windowID` 形式非対応の制約コメント追加 |

### Category 6: Cross-Cutting

| # | 関連ファイル | 内容 |
|---|---|---|
| S-6-1 | useBackendSync.ts | 将来的にウィンドウ操作のトースト通知等が必要な場合に個別イベント購読の追加 |
| S-6-2 | app_window_api_test.go | ウィンドウ操作後のスナップショット `active_window_id` 伝播テスト追加 |
| S-6-3 | types/tmux.ts, models.ts | TypeScript型定義の二重管理解消（自動生成型から derive） |

---

## Strengths（良い点）

- **`ActiveWindowID` の全レイヤー一貫した追加**: Go型定義 → SessionSnapshot → delta検知 → メトリクス → ステータスライン → TypeScript型 → フロントエンドUI のすべてが正しく更新されている
- **フィールド数ガードテスト**: `reflect.NumField()` による安全ネットが `TmuxSession`(11), `SessionSnapshot`(9) に正しく更新（app_snapshot_delta_test, app_snapshot_metrics_test）
- **テーブル駆動テストの徹底**: 全カテゴリでテーブル駆動テストが一貫して使用され、正常系・異常系を体系的にカバー
- **イベントフローの完全性**: 6つの新ウィンドウイベント全てに対して `shouldEmitSnapshotForEvent` / `shouldBypassSnapshotDebounceForEvent` が正しく設定
- **ロック設計の適切性**: 新メソッドのRLock/Lock使い分け、ロック外でのターミナルクローズ、自動修復パスのWrite Lock昇格がすべて正しい
- **`resolveActiveWindow` / `resolveActivePane` のフロントエンドユーティリティ**: 3段階フォールバック（ID → active → [0]）が堅牢
- **`validateCommandSpecConsistency` + `init()` のspec整合性ガード**: コマンド追加漏れを起動時に検出
- **防御的フォールバック設計**: `firstPaneInSession` のアクティブペイン解決、`removeWindowAtIndexLocked` の近傍ウィンドウフォールバック、`ResolveSessionTarget` のクローン返却

---

## Data Flow Verification

| データフロー | 状態 | 説明 |
|---|---|---|
| ActiveWindowID: Go → Snapshot → Frontend | ✅ | 完全に伝播 |
| ActiveWindowID: Delta検知 | ✅ | `sessionSnapshotEqual` で比較、テスト有り |
| FocusPane → ActiveWindowID更新 | ✅ | `SetActivePane` → `ActiveWindowID` 更新 → snapshot |
| select-window → ActiveWindowID | ✅ | `SetActivePane(target.ID)` → 更新 |
| new-window → 全レイヤー | ✅ | shim → router → manager → event → snapshot → frontend |
| kill-window → 全レイヤー | ✅ | fallbackロジックで `ActiveWindowID` 修復 |
| rename-window → 全レイヤー | ✅ | イベント → snapshot → frontend |
| list-windows → shim | ✅ | format出力正常 |
| set-environment → shim | ✅ | `SetSessionEnv` / `UnsetSessionEnv` 正常 |
| Window Tab UI → Backend | ✅ | 操作→API→変更→snapshot |
| **ApplyLayoutPreset** | **❌** | **常に window index 0 を対象にする（C-1参照）** |
| Lock consistency | ✅ | 全メソッド適切なロック使用 |
| Command Router Registration | ✅ | 6コマンド全て登録済み |
| 型の整合性 (Go ↔ TS) | ✅ | フィールド一致 |

---

## Recommended Action

1. **Critical Issues (C-1 ~ C-3) を最優先で修正** — 特にC-1は既存機能の破損
2. **Important Issues のうち機能バグに関するもの (I-2-1, I-3-3) を修正**
3. **残りの Important Issues を修正**
4. **Suggestions は優先度順に対応**
5. **修正後に再レビュー実行**

---

## タスク整理 — 並列作業可否テーブル

以下は修正作業を並列で実施する際の依存関係と安全性を整理したものです。

### 凡例
- ✅ 並列可能: 他のタスクと独立して作業可能
- ⚠️ 条件付き: 特定のタスクとの同時編集を避ける
- ❌ 順次作業: 先行タスクの完了後に実施

### Critical Issues

| タスクID | ファイル | 内容 | 並列可否 | 依存・注意事項 |
|---|---|---|---|---|
| C-1 | app_pane_api.go, session_manager | `ApplyLayoutPreset` の windowIdx 修正 | ⚠️ | session_manager にメソッド追加する場合は I-5-1 と同時編集注意 |
| C-2 | SessionView.tsx | `confirmRemoveWindow` の早期return問題修正 | ✅ | Frontend のみの修正で独立 |
| C-3 | SessionView.tsx | `renameInputRef` の callback ref 化 | ⚠️ | C-2 と同一ファイル。C-2 と合わせて作業推奨 |

### Important Issues

| タスクID | ファイル | 内容 | 並列可否 | 依存・注意事項 |
|---|---|---|---|---|
| I-1-1 | app_snapshot_metrics.go | ベースサイズ定数の更新 | ✅ | 独立した1行修正 |
| I-2-1 | cmd/tmux-shim/command_transform.go | `new-window` の shell transform 追加 | ✅ | shim 内で完結 |
| I-2-2 | cmd/tmux-shim/parse.go | `rename-session` の `-t` バリデーション追加 | ⚠️ | I-2-3 と同一ファイル。合わせて作業推奨 |
| I-2-3 | cmd/tmux-shim/parse.go | バリデーション順序変更 | ⚠️ | I-2-2 と同一ファイル。合わせて作業推奨 |
| I-3-1 | SessionView.tsx | renamingWindowIdRef の冗長 useEffect 削除 | ⚠️ | C-2, C-3 と同一ファイル。合わせて作業推奨 |
| I-3-2 | SessionView.tsx | onSelectWindow のコメント追加 | ⚠️ | C-2, C-3 と同一ファイル |
| I-3-3 | frontend/wailsjs/go/models.ts | `?? []` フォールバック復元 | ✅ | 独立した修正 |
| I-3-4 | SessionView.tsx | windowLabel のヘルパー関数化 | ⚠️ | C-2, C-3 と同一ファイル |
| I-3-5 | App.tsx | useRef の定義位置移動 | ✅ | 独立した修正 |
| I-4-1 | command_router_terminal.go | nil分岐のコメント/削除 | ✅ | 独立した修正 |
| I-4-2 | command_router_handlers_window.go | defaultWindowListFormat のコメント追加 | ⚠️ | I-4-3 と同一ファイル |
| I-4-3 | command_router_handlers_window.go | handleSelectWindow のロック外ポインタ修正 | ⚠️ | I-4-2 と同一ファイル。合わせて作業推奨 |
| I-4-4 | key_table.go | parseControlKey の特殊制御文字対応 | ✅ | 独立した修正 |
| I-5-1 | session_manager_test.go | フィールド数ガードテスト追加 | ✅ | テストファイルのみ |
| I-5-2 | session_manager_windows.go | デッドコード条件の削除 | ✅ | 独立した修正 |
| I-5-3 | session_manager_panes.go のテスト | SetActivePane の ActiveWindowID テスト追加 | ✅ | テストファイルのみ |
| I-5-4 | session_manager_pane_lifecycle.go | removedWindowIdx のコメント追加 | ✅ | 独立した修正 |
| I-6-1 | session_manager_windows.go | AddWindow のドキュメント改善 | ⚠️ | I-5-2 と同一ファイル。合わせて作業推奨 |
| I-6-2 | app_session_api.go | RenameSession のイベント発行追加 | ✅ | 独立した修正 |
| I-6-3 | command_router_handlers_window.go | イベント発行パターンのドキュメント | ⚠️ | I-4-2, I-4-3 と同一ファイル |
| I-6-4 | session_manager_env.go | Env のスナップショット設計の検討 (将来課題) | ✅ | 設計検討のみ、現時点で修正不要 |

### 推奨作業グループ（同一ファイルをまとめて効率的に修正）

| グループ | タスク | ファイル |
|---|---|---|
| **A: SessionView.tsx** | C-2, C-3, I-3-1, I-3-2, I-3-4 | SessionView.tsx |
| **B: parse.go** | I-2-2, I-2-3 | cmd/tmux-shim/parse.go |
| **C: command_router_handlers_window.go** | I-4-2, I-4-3, I-6-3 | internal/tmux/command_router_handlers_window.go |
| **D: session_manager_windows.go** | I-5-2, I-6-1 | internal/tmux/session_manager_windows.go |
| **E: 独立タスク（全て並列OK）** | C-1, I-1-1, I-2-1, I-3-3, I-3-5, I-4-1, I-4-4, I-5-1, I-5-3, I-5-4, I-6-2 | 各ファイル独立 |

### 並列作業フロー図

```
フェーズ1（並列実行可能）:
  ├── グループA: SessionView.tsx (C-2, C-3, I-3-1, I-3-2, I-3-4)
  ├── グループB: parse.go (I-2-2, I-2-3)
  ├── グループC: handlers_window.go (I-4-2, I-4-3, I-6-3)
  ├── グループD: session_manager_windows.go (I-5-2, I-6-1)
  ├── E-1: C-1 (app_pane_api.go + session_manager)
  ├── E-2: I-1-1 (app_snapshot_metrics.go)
  ├── E-3: I-2-1 (command_transform.go)
  ├── E-4: I-3-3 (models.ts)
  ├── E-5: I-3-5 (App.tsx)
  ├── E-6: I-4-1 (command_router_terminal.go)
  ├── E-7: I-4-4 (key_table.go)
  ├── E-8: I-5-1 (session_manager_test.go)
  ├── E-9: I-5-3 (session_manager_panes test)
  ├── E-10: I-5-4 (session_manager_pane_lifecycle.go)
  └── E-11: I-6-2 (app_session_api.go)

フェーズ2（フェーズ1完了後）:
  └── テスト実行 & 再レビュー
```

> **結論**: フェーズ1の全タスクは並列作業可能です。同一ファイルへの修正はグループ（A～D）にまとめて1人が担当することで、マージコンフリクトと二重編集を防止できます。
