# レビュー指摘 対応状況確認 — 2026-02-18 18:30

対象レビュー:
- `review-202602180755.md` (以下 R1)
- `review-202602181810.md` (以下 R2)

## 凡例
- ✅ 対応済み
- ❌ 未対応
- ⚠️ 部分対応 / 軽微
- ➖ 該当なし（コード変更により不要）

---

## Critical Issues

### R1 Critical Issues

| ID | 概要 | 状態 | 根拠 |
|----|------|:----:|------|
| R1-C1 | Window API: `requestSnapshot(true)` / イベント通知が欠落 | ✅ | `app_window_api.go` の `AddWindow`, `RemoveWindow`, `RenameWindow` 全てに `a.requestSnapshot(true)` が追加済み |
| R1-C2 | `RemoveWindow` で pane state が二重クリーンアップ | ✅ | `stopOutputBuffer` ループは削除済み。`KillSession` と同パターン（`detachStaleOutputBuffers` + `cleanupDetachedPaneStates`）に統一済み |
| R1-C3 | `handleNewWindow` ロールバック時の TOCTOU リスク | ✅ | `RemoveWindowByID` メソッドが追加され、ロールバック時に安定ID指定で削除。`command_router_handlers_window.go` L253で `r.sessions.RemoveWindowByID(sessionName, window.ID)` を使用 |
| R1-C4 | `Snapshot()` キャッシュが共有可変ポインタを返す | ✅ | `session_manager_snapshot.go` でキャッシュヒット時も `cloneSessionSnapshots()` を呼んでクローンを返却。`Worktree` と `Layout` のポインタも `cloneLayout()` で deep copy |
| R1-C5 | 公開メソッドが内部ポインタを返す | ✅ | `GetSession` は `cloneSessionForRead(session)` でクローンを返却。`ListSessions` も同様。`ResolveSessionTarget` も `cloneSessionForRead` 使用 |
| R1-C6 | `TerminalPane` の `pendingFontSize` と `term.options.fontSize` の競合 | ❌ | `TerminalPane.tsx` L264: `pendingFontSize` は依然ローカル変数で管理。`term.options.fontSize` と同期せず、高速ホイール中に不一致になる可能性が残存 |
| R1-C7 | `useBackendSync` の `EventsOff` が全リスナーを解除する | ✅ | `useBackendSync.ts` で `EventsOn` の戻り値（cleanup関数）を `cleanupFns` 配列に格納し、クリーンアップ時に個別解除。`EventsOff` は使用していない |

### R2 Critical Issues

| ID | 概要 | 状態 | 根拠 |
|----|------|:----:|------|
| R2-C1 | `ApplyLayoutPreset` が `windowIdx: 0` をハードコード | ✅ | `app_pane_api.go` で `session.ActiveWindowID` を使用し `ApplyLayoutPresetByWindowID` を呼び出し。`session_manager_panes.go` に `ApplyLayoutPresetByWindowID` メソッドが追加済み |
| R2-C2 | `confirmRemoveWindow` が早期return後に定義されている | ✅ | `SessionView.tsx` で `ConfirmDialog` は `renderSessionContent()` の外に配置。早期returnガードの影響を受けない位置（コンポーネントのreturn JSX直下）に移動済み |
| R2-C3 | `renameInputRef` が複数のウィンドウタブで共有される | ✅ | `registerRenameInput` が callback ref パターンに変更済み。`renamingWindowId` と一致する場合のみ ref を設定 |

---

## Important Issues

### R1 Important Issues

| ID | 概要 | 状態 | 根拠 |
|----|------|:----:|------|
| R1-I1 | debounce 戦略のコメント不足 | ❌ | `app_events.go` L247-251付近: leading-edge fixed-window debounce の動作説明コメントが依然として不足 |
| R1-I2 | マジックナンバー `16ms`, `8*1024` | ❌ | `app_events.go` L120-121: 名前付き定数への切り出し未実施 |
| R1-I3 | `snapshotDelta` の防御ガードコメント不足 | ❌ | `app_snapshot_delta.go` L166付近: ガード条件の到達条件説明コメントなし |
| R1-I4 | フィールド数テストの重複 | ⚠️ | `app_snapshot_delta_test.go` と `app_snapshot_metrics_test.go` に5つの型で重複テストあり。目的が異なるため意図的な可能性あるが重複は事実 |
| R1-I5 | `resolvePaneTitle` のエッジケーステスト不足 | ❌ | `app_status_test.go`: activePN不一致、Active=trueフォールバックのテストが欠落 |
| R1-I6 | `syncPaneStates` の直接テスト不在 | ❌ | `app_events_test.go`: `syncPaneStates` が EnsurePane/SetActivePanes/RetainPanes を正しく呼ぶ統合テストなし |
| R1-I7 | `requireRouter` と `requireSessions` 別々呼び出し | ✅ | `app_window_api.go`: `requireSessionsAndRouter()` に統一済み |
| R1-I8 | 負の `windowID` バリデーションテスト欠落 | ✅ | `app_window_api_test.go`: `windowID: -1` のテストケースが `RemoveWindow` と `RenameWindow` の両方に存在 |
| R1-I9 | 複数ウィンドウ存在時の `RemoveWindow` テスト欠落 | ❌ | テストは1ウィンドウのセッション削除ケースのみ。複数ウィンドウでセッション存続ケースのテストなし |
| R1-I10 | `removedPaneIDs` ヘルパーのユニットテスト欠落 | ➖ | 関数自体がコードに存在しない。コード変更により不要 |
| R1-I11 | `new-window` が shell transform 対象外 | ✅ | `command_transform.go` の `applyShellTransform` に `"new-window"` が追加済み |
| R1-I12 | `new-window` が model transform 対象外 | ✅ | `model_transform.go` の `modelTransformCommands` に `"new-window"` が登録済み |
| R1-I13 | Ctrl+V ペースト処理が不完全 | ⚠️ | `TerminalPane.tsx` L219-222: `return false` でブラウザのネイティブ paste イベントパスを維持。WebView2 環境では別途 `ClipboardGetText` で対応 |
| R1-I14 | `confirmRemoveWindow` 毎レンダリング再生成 | ✅ | `SessionView.tsx`: `confirmRemoveWindow` は通常関数として定義されているが、`ConfirmDialog` の `onAction` 内で直接呼び出しており、メモ化の必要性は低い設計に変更済み |
| R1-I15 | Prefix+x が確認なしでペイン kill | ✅ | `usePrefixKeyMode.ts`: `setPendingPrefixKillPaneId` で pending 状態にし、`App.tsx` の `ConfirmDialog` で確認を挟む仕組みに変更済み |
| R1-I16 | `SearchBar` 再開時に前回クエリ残存 | ❌ | `SearchBar.tsx`: `open` 時に `setQuery("")` が呼ばれておらず、前回の検索文字列が残る |
| R1-I17 | `useFileDrop` の `activePaneId` stale closure | ✅ | `useFileDrop.ts`: `useEffect` の依存配列に `activePaneId` が含まれ、変更時に再登録される |
| R1-I18 | `handleListPanes` のポインタ等価比較 | ⚠️ | clone 返却後もソート関数内で `pi.Window == pj.Window` 等のポインタ比較を使用。ただしコメントで意図的な設計であることを示唆 |
| R1-I19 | `handleSelectWindow` での `paneCtxErr` フォールバック時の TOCTOU | ✅ | `command_router_handlers_window.go` L289: `handleSelectWindow` でフォールバックパスを使用せず、`resolveWindowIDFromRequest` で事前にセッション名を取得 |
| R1-I20 | `handleNewSession` で `-d` 時の不要な2回目スナップショット取得 | ⚠️ | `-d` 無し時のみ `GetPaneContextSnapshot` を再取得。意図的な設計だがコメント不足 |
| R1-I21 | `append(req.Args, "Enter")` のスライス汚染リスク | ❌ | `command_router_handlers_pane.go` L117: `append(args, "Enter")` で防御的コピーなし。元スライスの backing array を汚染するリスクが残存 |
| R1-I22 | `renameWindowByIndexLocked` で nil ウィンドウ未防御 | ⚠️ | `session_manager_windows.go`: インデックス範囲チェックはあるが `session.Windows[windowIdx]` の nil チェックなし。ただし nil window が入ることは通常ない |
| R1-I23 | `WriteToPane` が RLock 保持中に I/O ブロッキング | ⚠️ | 設計トレードオフとして認識。変更なし |
| R1-I24 | テストが `CreateSession` 返却ポインタを無ロック直接変更 | ❌ | `session_manager_env_test.go`: `pane.Env["FOO"] = "bar"` / `pane.Title = "editor"` をロック無しで直接変更するテストが残存 |
| R1-I25 | `session_created_human` の nil フォールバックフォーマット不一致 | ❌ | `format.go`: nil 時に `time.Unix(0, 0).Format(time.RFC3339)` (RFC3339)、正常時に `"Mon Jan _2 15:04:05 2006"` (human-readable) で不統一 |

### R2 Important Issues

| ID | 概要 | 状態 | 根拠 |
|----|------|:----:|------|
| R2-I1-1 | `estimateSessionSnapshotSize` のベースサイズ定数 `84` 未更新 | ✅ | `app_snapshot_metrics.go` L68: `size := 103` に更新済み |
| R2-I2-1 | `new-window` に対する shell/model transform が未実装 | ✅ | R1-I11/I12 と同一。対応済み |
| R2-I2-2 | `rename-session` の `-t` バリデーション欠落 | ✅ | `parse.go` L99-100: `validateRequired` の `case "rename-session", "rename-window":` に `-t` 必須チェック含む |
| R2-I2-3 | `validateNonNegativeSizeFlags` の呼び出し順序 | ✅ | `parse.go` L116: `validateNonNegativeSizeFlags` は `validateRequired` の**末尾**で呼ばれるように修正済み |
| R2-I3-1 | `renamingWindowIdRef` の二重同期が冗長 | ⚠️ | `SessionView.tsx`: `renamingWindowIdRef` は削除されている。`useState` のみで管理。問題そのものが解消 |
| R2-I3-2 | `onSelectWindow` が `FocusPane` APIのみでウィンドウ切替（コメント不足） | ❌ | `SessionView.tsx` L85-92: 暗黙的な依存関係のコメントが依然として不足 |
| R2-I3-3 | `?? []` のフォールバック削除 | ❌ | `models.ts`: `setup_scripts`, `copy_files`, `copy_dirs` に `?? []` フォールバックなし。Go側 `omitempty` の場合にランタイムエラーの可能性 |
| R2-I3-4 | `windowLabel` が `useCallback` で空の依存配列 | ⚠️ | `SessionView.tsx` L100: `useCallback([], [])` のまま。コンポーネント外ヘルパーへの移動は未実施だが機能問題なし |
| R2-I3-5 | `lastSyncedSessionRef` の定義位置 | ✅ | `App.tsx` L24: フック宣言ブロック先頭付近に配置済み |
| R2-I4-1 | `attachPaneTerminal` のnil分岐がデッドコード | ⚠️ | `command_router_terminal.go` L40: nil分岐は防御的コードとして残存。コメント追加なし |
| R2-I4-2 | `defaultWindowListFormat` の `#{window_index}` がtmuxと異なるセマンティクス | ❌ | `format.go`: `window_index` が `window.ID` を返す仕様のまま。tmux との差異コメントなし |
| R2-I4-3 | `handleSelectWindow` のフォールバックで `target.Window.Session.Name` がロック外アクセス | ✅ | `command_router_handlers_window.go`: `resolveWindowIDFromRequest` で事前にセッション名を取得するパターンに変更済み |
| R2-I4-4 | `parseControlKey` が `C-@` 等の特殊制御文字に非対応 | ✅ | `key_table.go`: `parseControlKey` に `C-@` (0x00), `C-\` (0x1c), `C-]` (0x1d), `C-^` (0x1e), `C-_` (0x1f) の全特殊制御文字を追加済み |
| R2-I5-1 | `TmuxSession` / `SessionSnapshot` のフィールド数ガードテスト不在 | ⚠️ | `app_snapshot_delta_test.go` に `TmuxSession(11)` のフィールド数テストあり。`SessionSnapshot(9)` も検査済み。ただし `session_manager_test.go` には未追加 |
| R2-I5-2 | `removeWindowAtIndexLocked` のデッドコード条件 | ❌ | `session_manager_windows.go` L130: `session.ActiveWindowID == removedWindowID` は依然として到達不能。デッドコード削除 or コメント追加なし |
| R2-I5-3 | `SetActivePane` の `ActiveWindowID` 更新テスト不足 | ✅ | `session_manager_test.go`: `TestSetActivePaneUpdatesActiveWindowID` テスト追加済み |
| R2-I5-4 | `removedWindowIdx` セマンティクスが不正確 | ❌ | `session_manager_pane_lifecycle.go`: `removedWindowIdx` のコメントに「空間的ヒントとして使用」の説明なし |
| R2-I6-1 | `AddWindow` 後の `ActiveWindowID` 更新フローのドキュメント不足 | ⚠️ | `session_manager_windows.go`: `// Keep ActiveWindowID unchanged; focus changes are controlled by callers.` コメントあり。ただし呼出元での間接更新フローは文書化なし |
| R2-I6-2 | `RenameSession` (App層) が `tmux:session-renamed` イベントを発行しない | ✅ | `app_session_api.go`: `emitBackendEvent("tmux:session-renamed", ...)` が追加済み |
| R2-I6-3 | `SetActivePane` がイベントを発行しない | ⚠️ | 設計判断として認識。スナップショットベースの同期で吸収される設計。変更なし |
| R2-I6-4 | `SessionSnapshot` に `Env` フィールドがない | ⚠️ | 将来課題として認識。現時点でフロントエンド表示不要のため変更なし |

---

## 未対応サマリ（修正必要な項目）

### Critical（1件）

| ID | 概要 | 優先度 |
|----|------|--------|
| R1-C6 | `TerminalPane` の `pendingFontSize` と `term.options.fontSize` の競合 | Critical |

### Important（12件）

| ID | 概要 | カテゴリ |
|----|------|----------|
| R1-I1 | debounce 戦略のコメント不足 | App Events |
| R1-I2 | マジックナンバー `16ms`, `8*1024` | App Events |
| R1-I3 | `snapshotDelta` の防御ガードコメント不足 | App Snapshot |
| R1-I5 | `resolvePaneTitle` のエッジケーステスト不足 | App Status |
| R1-I6 | `syncPaneStates` の直接テスト不在 | App Events |
| R1-I9 | 複数ウィンドウ RemoveWindow テスト欠落 | Window API |
| R1-I16 | `SearchBar` 再開時に前回クエリ残存 | Frontend |
| R1-I21 | `append(req.Args, "Enter")` のスライス汚染リスク | Command Router |
| R1-I24 | テストが `CreateSession` 返却ポインタを無ロック直接変更 | Session Manager |
| R1-I25 | `session_created_human` の nil フォールバックフォーマット不一致 | Format |
| R2-I3-2 | `onSelectWindow` の暗黙的依存コメント不足 | Frontend |
| R2-I3-3 | `models.ts` の `?? []` フォールバック削除 | Frontend |
| R2-I4-2 | `window_index` / tmux差異コメント不足 | Format |
| R2-I5-2 | `removeWindowAtIndexLocked` のデッドコード条件 | Session Manager |
| R2-I5-4 | `removedWindowIdx` セマンティクスコメント不足 | Session Manager |

---

## 統計

| 重要度 | 合計 | 対応済み | 未対応 | 部分/該当なし |
|--------|:----:|:--------:|:------:|:------------:|
| Critical (R1+R2) | 10 | 9 | 1 | 0 |
| Important (R1+R2) | 46 | 22 | 15 | 9 |
