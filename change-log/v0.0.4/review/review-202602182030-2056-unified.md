# 統合レビュー — 2026/02/18 (20:30 + 20:53 + 20:56)

**対象**: myT-x/ 配下の変更ファイル (63ファイル, +6716/-2455行)
**統合元**: 3件のレビュー結果を重複排除し、ファイル単位で修正しやすいよう整理

---

## 目次

1. [Critical Issues (2件)](#critical-issues)
2. [Important Issues — コード修正 (22件)](#important-issues--コード修正)
3. [Important Issues — テスト追加/修正 (10件)](#important-issues--テスト追加修正)
4. [Suggestions (25件)](#suggestions)
5. [Strengths (良い点)](#strengths)
6. [並列作業グループ表](#並列作業グループ表)

---

## Critical Issues

実害のあるバグ。マージ前に必ず修正。

### C-1: `removeWindowAtIndexLocked` で Terminal 参照を nil 化後に返却 → ConPTY リーク

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/session_manager_windows.go` L134-153 |
| **検出元** | 全3レビューで検出 |

`removeWindowAtIndexLocked` が `pane.Terminal = nil` を設定した後に同じ `*TmuxPane` ポインタを `removedPanes` として返却。呼び出し元は Terminal が既に nil のため Close をスキップし、**ConPTY ハンドルが解放されない**。

**影響箇所:**
- `command_router_handlers_window.go` `handleKillWindow` — `removedPanes` の Terminal Close が常にスキップ（デッドコード化）
- `command_router_handlers_window.go` `handleNewWindow` ロールバック — attach-terminal 失敗時のロールバックで同様のリーク
- `session_manager_windows.go` `RemoveWindow` — インデックス指定削除でも同一コードパス

**対比:** `killPaneLocked`（`session_manager_pane_lifecycle.go` L102-104）は Terminal 参照を `result.closeTargets` に退避してから nil 化しており正しいパターン。

**修正案:** `killPaneLocked` と同様に Terminal 参照をロック内で別途退避し、`closeTargets` として返す。

---

### C-2: `copyPaneSlice` が Env map を浅いコピー → データ競合リスク

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/session_manager_pane_io.go` L113-126 |
| **検出元** | review-2053 |

`copied := *pane` は shallow copy のため `copied.Env` は内部 `pane.Env` と同一 map を共有。ロック外で返却された `TmuxPane` の `Env` を通じて内部状態変更可能。

**同一パターン:** L41-49 `allInSession` パスのインラインコピーも同様。

**対比:** `cloneSessionForRead` は `copyEnvMap(pane.Env)` で深いコピーしており正しい。

**修正案:** `copied.Env = copyEnvMap(pane.Env)` を追加。

---

## Important Issues — コード修正

ファイル単位でグループ化。同一ファイルの修正は一括で実施可能。

---

### ■ `app_session_api.go`

#### I-1: `RenameSession` の NOTE コメントが実動作と矛盾

| 項目 | 内容 |
|------|------|
| **検出元** | 全3レビューで検出 |

コメントに「スナップショット不要」と記載だが、`snapshotEventPolicies` に `tmux:session-renamed` が `{trigger: true, bypassDebounce: true}` で登録されており、実際にはスナップショットが即時トリガーされる。

**修正案:** コメントを実動作に合わせて修正。

---

### ■ `app_events.go`

#### I-2: `snapshotEventPolicies` の可変性リスク

| 項目 | 内容 |
|------|------|
| **検出元** | review-2030 |

`var` として宣言されたマップ。現在ランタイムでの変更はないが、意図しない変更のリスクがある。

**修正案:** `// Treat as immutable after init` コメントの追加。

---

### ■ `app_pane_api.go`

#### I-3: `SplitPane` だけバリデーションパターンが未統一

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053, review-2030 (S-3) |

他7メソッドは `requireSessionsWithPaneID` で統一。`SplitPane` だけ手動の TrimSpace + empty check。

**修正案:** paneID バリデーションヘルパーを切り出すか、コメントで意図明示。

---

### ■ `cmd/tmux-shim/model_transform.go`

#### I-4: `applyFromToReplacement` に空値ガードが欠如

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |

`applyModelOverride` には空値ガードがあるが `applyFromToReplacement` にはない。`newModelTransformer` のガードで到達しないため実害なしだが一貫性欠如。

**修正案:** 同様のガードを追加するか、コメントで意図的省略を明記。

#### I-5: `slog.Warn` と `debugLog` の二重出力

| 項目 | 内容 |
|------|------|
| **検出元** | review-2030, review-2053 |
| **箇所** | L65-68 付近 / L93-95 付近 |

shim 全体で `debugLog` に統一されているのにここだけ `slog.Warn` も使用。stderr がオペレータに漏れる可能性。

**修正案:** `slog.Warn` を削除し `debugLog` のみに統一。

---

### ■ `cmd/tmux-shim/command_transform_test.go`

#### I-6: nil Env map への書き込みパニック可能性

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |
| **箇所** | L168-178 |

`Env: nil` で `applyNewProcessTransform` を直接呼ぶテスト。`parsed.ExtraEnv` が非空の場合、nil map への書き込みで panic。

**修正案:** `Env: map[string]string{}` に変更するか、関数冒頭で nil map ガード追加。

#### I-7: `wantChanged` 検証が片方向のみ

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |
| **箇所** | L166-199 |

`if tt.wantChanged && !changed` のみチェック。`!tt.wantChanged && changed` は検出されない。

**修正案:** 双方向チェックに変更。

---

### ■ `internal/tmux/session_manager_targets.go`

#### I-8: `resolveTargetWriteLocked` が `needsRepair` を無視

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |

write Lock 配下で `resolveWindowPaneTarget` を呼び出した際に `needsRepair` を `_` で捨てている。現時点で常に `false` を返すため実害なしだが、将来変更時にサイレントバグの温床。

**修正案:** コメントで意図を明記するか、write Lock 用バリアントを分離。

#### I-9: `ResolveTarget` 返却ポインタの安全性

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053, review-2056 |

`ResolveTarget` は `*TmuxPane` を返却するが Lock 解放後は dangling ポインタになりうる。現在の呼出し元はペイン ID のみ使用しているため実害なし。

**修正案:** 返却値の read-only 前提をコメントで明記し、ポインタ追跡禁止をドキュメント化。

#### I-10: `sortedSessionNamesLocked` / `getSessionByNameLocked` の命名が「Write Lock 必須」の実態と矛盾

| 項目 | 内容 |
|------|------|
| **検出元** | 全3レビューで検出 |

命名規約で `Locked` = Write Lock と定義されているが、実際は読み取り専用で RLock でも使用。`WindowIndexInSession` が `RLock()` で `getSessionByNameLocked` を呼ぶなど矛盾。

**同一パターン:**
- `session_manager_env.go` L65-70 (`GetSessionEnv`)
- `session_manager_targets.go` (`ResolveSessionTarget`)

**修正案:** `*RLocked` にリネームするか、中立的名称に変更。

#### I-11: `resolveTargetRLocked` と `resolveTargetWriteLocked` のロジック重複

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 |

`SessionToUse` 判定、`findWindowByID`、`paneForTargetWindowLocked` 呼出しのロジックがほぼ同一。

**修正案:** 共通ヘルパーを抽出して DRY にする（I-8, I-9, I-10 の修正と合わせて実施推奨）。

---

### ■ `internal/tmux/command_router.go`

#### I-12: `paneEnvView` の Copy-on-Write 契約が脆弱

| 項目 | 内容 |
|------|------|
| **検出元** | review-2030 |

`paneEnvView` が `RLock` 下で `r.opts.PaneEnv` への生参照を返す。安全性は `UpdatePaneEnv` が CoW する非文書化慣習に依存。

**修正案:** Copy-on-Write 契約をコメントとして明文化。

---

### ■ `internal/tmux/command_router_handlers_pane.go`

#### I-13: `splitWindowResolved` の `extraEnv` が `sanitizeCustomEnvironmentEntry` をバイパス

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |

`buildPaneEnv` は `sanitizeCustomEnvironmentEntry` 経由だが、`splitWindowResolved` の `extraEnv` は直接 `env[k] = v` でマージ。`blockedEnvironmentKeys` をバイパス。

**修正案:** `buildPaneEnv` に統合するか、`sanitizeCustomEnvironmentEntry` を通す。

#### I-14: `handleListPanes` の `formatPaneLine` で Window/Session 情報が常に空

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |

`ListPanesByWindowTarget` の値コピーで `Window=nil`。`formatPaneLine` → `expandFormat` → `lookupFormatVariable` は `window_name`, `session_name` 等を参照するが常にデフォルト値。

**修正案:** 値コピー時にスカラー値を追加フィールドとして保持するか、format 処理で別途解決。設計検討が必要。

---

### ■ `internal/tmux/command_router_handlers_window.go`

#### I-15: `handleKillWindow` の TOCTOU

| 項目 | 内容 |
|------|------|
| **検出元** | review-2030 |

`fallbackWindowIDAfterRemoval` がクローン上で計算され、`RemoveWindowByID` が live データ上で独立に計算。2 操作間で Window の追加/削除が起きると不一致。影響はスナップショット通知時のウィンドウ選択（見た目のみ）。

**修正案:** `RemoveWindowByID` 戻り値に fallback WindowID を含める。

---

### ■ `internal/tmux/session_manager_pane_io.go`

#### I-16: `ListPanesByWindowTarget` が `@stableID` を未サポート

| 項目 | 内容 |
|------|------|
| **検出元** | review-2030 |

`windowIdx` パースが `strconv.Atoi` のみで、`resolveWindowPaneTarget` が対応している `@stableID` 方式が使えない。`list-panes -t session:@5` が失敗する。

**修正案:** `resolveWindowPaneTarget` のパターンで stableID 対応を追加。

---

### ■ `internal/tmux/session_manager_sessions.go`

#### I-17: `CreateSession` / `AddWindow` のデフォルト寸法がハードコード

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |
| **箇所** | L67-73, `session_manager_windows.go` L25-30 |

ハンドラ側は `DefaultTerminalCols`/`DefaultTerminalRows` 定数に統一されたが、SessionManager 内は `120`, `40` のままハードコード。

**修正案:** 定数を使用。

#### I-18: `cloneSessionForRead` で nil スキップ時に `ActivePN` が不正になる可能性

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |

nil pane スキップ後のスライスではインデックスがずれるため、`ActivePN` が誤った pane を指す可能性。

**修正案:** nil pane スキップ時に `ActivePN` を再計算。

---

### ■ `internal/install/shim_cleanup_windows.go`

#### I-19: ログプレフィックス `[WARN-SHIM]` が不統一

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |
| **箇所** | L232 |

1箇所だけ `[WARN-SHIM]` で他は全て `[DEBUG-SHIM]`。プロジェクト規約「ログ名統一して削除しやすく」に違反。

**修正案:** `[DEBUG-SHIM]` に統一。

#### I-20: `cleanupStalePathEntries` のパスマッチがケースセンシティブ

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |
| **箇所** | L191 |

Windows パスは大文字小文字を区別しないが `strings.Contains` で比較。`\TEMP\` が大文字の場合にマッチしない。

**修正案:** `strings.ToLower` で比較。

#### I-21: `removeLegacyDirectory` が `LOCALAPPDATA` を再取得

| 項目 | 内容 |
|------|------|
| **検出元** | review-2030, review-2056 |

呼び出し元で検証済みの `LOCALAPPDATA` を再度 `os.Getenv` で取得。DRY 違反、環境変数が中途変更されるエッジケースで不整合。

**修正案:** 検証済み値をパラメータとして渡す。

#### I-22: Walk-up ループにルート到達ガードがない

| 項目 | 内容 |
|------|------|
| **検出元** | review-2030, review-2056 |

`filepath.Dir()` はルートで自身を返すため無限ループにはならないが、`os.Remove(C:\)` が呼ばれる可能性（パーミッションで失敗するため実害なし）。

**修正案:** `current == filepath.Dir(current)` のルート検出を追加。

---

### ■ `internal/ipc/protocol.go`

#### I-23 (軽微): Flags コメントの型情報が不正確

| 項目 | 内容 |
|------|------|
| **検出元** | review-2030, review-2053 |
| **箇所** | L21 |

コメントに `int` とあるが、Go の `json.Unmarshal` → `map[string]any` では JSON 数値は `float64` になる。

**修正案:** コメント修正。

---

### ■ `frontend/src/hooks/useTerminalSetup.ts`

#### I-24: `GetPaneReplay` で disposed チェックがない

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 |
| **箇所** | L130-140 |

Terminal dispose 後に Promise 解決すると、disposed 済みインスタンスへの `term.write(replay)` で例外発生の可能性。

**修正案:** `disposed` フラグでガード。

#### I-25: `fontSize` がセットアップ effect で stale closure になるリスク

| 項目 | 内容 |
|------|------|
| **検出元** | review-2030 |
| **箇所** | L56 |

`fontSize` がパラメータとして渡されるが effect は `[paneId]` のみに依存。`useTerminalFontSize` で後から適用されるため実害は低いが暗黙的結合が脆弱。

**修正案:** `useTmuxStore.getState().fontSize` で直接取得を推奨。

---

### ■ `frontend/src/hooks/useTerminalResize.ts` + `useTerminalEvents.ts`

#### I-26: IME composition 状態の二重管理

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053, review-2056 |

同じ `term.textarea` に対して2セットの `compositionstart`/`compositionend` リスナーが登録される（旧3個 → 新6個）。

**修正案:** 共通の `isComposingRef` を共有するか、IME 追跡を専用フックに分離。

---

### ■ `frontend/src/hooks/useTerminalFontSize.ts`

#### I-27: eslint-disable 理由説明不足

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 |
| **箇所** | L62 |

`containerRef`, `fontSizeRef`, `setFontSize` を依存配列から除外している eslint-disable コメントに理由説明がない。他フックには説明が付与されており不統一。

**修正案:** 除外理由コメントを追加。

---

### ■ `frontend/src/hooks/useBackendSync.ts`

#### I-28: `BackendEventMap` の全ペイロード型が `unknown`

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 |
| **箇所** | L15-29 |

全エントリが `unknown` 型で型安全の恩恵がない。runtime 型ガードで安全性は確保されているが段階的に具体型を定義すると効果的。

**修正案:** 段階的に具体型を定義。低優先度。

---

## Important Issues — テスト追加/修正

### ■ `internal/tmux/session_manager_targets_test.go` (新規)

#### T-1: `ResolveDirectionalPane` の直接テストが存在しない

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 (I-11), review-2056 (C-2) |

新規公開メソッドで方向ナビゲーション、境界クランプ、nil ペインガード等の非自明ロジックを含むがテストなし。

**推奨ケース:** DirPrev 先頭クランプ / DirNext 末尾クランプ / DirNone / callerPaneID<0 / ウィンドウなし / nil ペインエントリ

#### T-2: `ResolveTarget` RLock→Lock アップグレードパスのテストがない

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 (C-3) |

`activePaneInSessionRLocked` が `needsRepair=true` を返すケース（ActiveWindowID 陳腐化）は自動修復をトリガーする重要経路だがテストなし。

---

### ■ `internal/tmux/command_router_test.go`

#### T-3: `bestEffortSendKeys` / `buildPaneEnv` のテストがない

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 (C-4) |

`bestEffortSendKeys` はエラー握りつぶし設計だが正常系・エラー発生時の動作パス検証がない。`buildPaneEnv` はペイン環境変数構築の新規ヘルパーだがテストなし。

---

### ■ `internal/tmux/session_manager_pane_io_test.go`

#### T-4: `copyPaneSlice` の直接テストがない

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 (I-11) |

コピーへの変更が元データに影響しないことを検証すべき。C-2 の修正後にテスト追加。

---

### ■ `internal/tmux/session_manager_windows_test.go`

#### T-5: `removeWindowAtIndexLocked` の Terminal nil 化がテスト未検証

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 (I-12) |

`TestRemoveWindowActiveWindowIDAutoTransition` は ActiveWindowID 遷移のみ検証。返却された `removedPanes` の Terminal 状態は検証なし。C-1 修正後にテスト追加。

#### T-6: `WindowIndexInSession` の nil ウィンドウガードが未テスト

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 (I-13) |

`if w != nil && w.ID == windowID` の nil チェックが追加されたがテストなし。

---

### ■ `app_lifecycle_test.go`

#### T-7: `t.Parallel()` 制限コメントがない

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 (I-14) |

他テストファイル（`app_events_test.go`, `app_pane_api_test.go`）には警告が付与されているが、同様にパッケージレベル変数を差し替える `app_lifecycle_test.go` にはない。

---

### ■ `cmd/tmux-shim/model_transform_test.go`

#### T-8: `TestApplyModelTransformSkipsOnLoaderError` でログ出力の検証がない

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 (I-15) |

エラー握りつぶし（原文返却）のみ検証。CLAUDE.md 仕様「エラーはログにだけ出力しておくこと」を考慮し、ログ出力検証も追加すべき。

---

### ■ `frontend/src/tests/hooks/` (新規)

#### T-9: フロントエンド新規カスタムフック5つにテスト未追加

| 項目 | 内容 |
|------|------|
| **検出元** | review-2056 (I-10) |

`useTerminalSetup`, `useTerminalEvents`, `useTerminalResize`, `useTerminalFontSize`, `useWindowRename` にテストなし。特に `useWindowRename` の二重実行ガード（`inflightWindowIdRef`）はテスト推奨。

---

### ■ `internal/install/shim_cleanup_windows_test.go`

#### T-10: `t.Setenv` を使うべき (6-8箇所)

| 項目 | 内容 |
|------|------|
| **検出元** | review-2053 (S-19), review-2030 (S-22) |

`os.Getenv/os.Setenv/t.Cleanup` パターンを `t.Setenv()` (Go 1.17+) に統一可能。L99-103, L116, L130 等。

---

## Suggestions

改善提案。余力があれば対応。

### App 層

| # | ファイル | 内容 | 検出元 |
|---|---------|------|--------|
| S-1 | `app_guards.go` | `requireSessionsWithPaneID` のポインタ引数パターン → 値返却パターンが Go 慣用的 | 2056 |
| S-2 | `app_events.go` | `snapshotEventPolicies` の `trigger` が全エントリで `true`（冗長）。マップの意味をドキュメント化 | 2053, 2056 |
| S-3 | `app_events.go` | `handleLegacyMapPaneOutput` のログに `rawData` 値を追加 | 2053 |
| S-4 | `app_status.go` | `resolveActiveWindowSnapshot` のフォールバックログを INFO レベルに昇格検討 | 2053 |
| S-5 | `app_events_test.go` | テストタイムアウト `2*time.Second` の定数化 (3箇所) | 2053 |
| S-6 | `app_pane_api_test.go` L606-625 | テストケース名「session has no windows」が実態と乖離 → `"session removed after killing last pane"` 等 | 2053 |
| S-7 | `app_pane_api_test.go` | `ResizePane` が pane 実在時の境界値テスト（0, 負値）になっていない | 2053, 2056 |
| S-8 | `app_snapshot_delta.go` | Removed のみソートする理由を Why コメントで補足 | 2030 |

### tmux-shim

| # | ファイル | 内容 | 検出元 |
|---|---------|------|--------|
| S-9 | `cmd/tmux-shim/model_transform.go` | `matchAll` と `modelPattern` の排他性をコメントで明記 | 2053 |
| S-10 | `cmd/tmux-shim/model_transform_test.go` | `resetModelConfigCache` の不要なエイリアス | 2053 |
| S-11 | `cmd/tmux-shim/spec.go` | `select-pane -Z` (ズーム) 未定義。`new-session -t` フラグ未定義 | 2056, 2030 |
| S-12 | `cmd/tmux-shim/command_transform_test.go` | `resize-pane` 方向パーステスト不足 / 値側スペースケース未テスト / `wantChanged: true` ケース追加 | 2053, 2056, 2030 |

### internal/tmux

| # | ファイル | 内容 | 検出元 |
|---|---------|------|--------|
| S-13 | `internal/tmux/command_router.go` | `bestEffortSendKeys` の `appendEnter` が全呼出しで `true` / ログタグを structured logging に | 2053 |
| S-14 | `internal/tmux/format.go` | `session_created_human` の二段展開 → `expandFormat` に統合で簡潔化 | 2053, 2030 |
| S-15 | `internal/tmux/command_router_test.go` | `expectedCommands` リストの自動同期化 | 2053 |
| S-16 | `internal/tmux/command_router_handlers_pane.go` | `handleListPanes` のコメント「already in correct order」が不正確 / `emitLayoutChangedForSession` の Warn ログがノイズの原因 | 2053 |
| S-17 | `internal/tmux/session_manager_targets.go` | `ResolveDirectionalPane` が DirNone で write Lock 取得（RLock で十分） | 2053 |
| S-18 | `internal/tmux/session_manager_snapshot.go` | `SessionSnapshot.Clone()` 単体テスト不足 | 2053 |
| S-19 | `internal/tmux/session_manager_panes.go` | `ApplyLayoutPresetToActiveWindow` の SessionManager 層直接テスト | 2056 |
| S-20 | `internal/tmux/format_test.go` | fixture 重複削減 (builder パターン) / 空 Panes スライスケース追加 | 2053, 2056 |

### Frontend

| # | ファイル | 内容 | 検出元 |
|---|---------|------|--------|
| S-21 | `frontend/src/components/TerminalPane.tsx` | 不要な `fontSize` ストア購読 → 全ペイン再レンダリング / `areTerminalPanePropsEqual` の比較不足 / 未使用 `onDetach` prop 削除 | 2053, 2030 |
| S-22 | `frontend/src/components/ConfirmDialog.tsx` | `role="dialog"` と `aria-modal="true"` 追加 | 2030, 2056 |
| S-23 | `frontend/src/stores/tmuxStore.ts` | `activeWindowId`/`setActiveWindowId` 未使用 / `activeWindowId` が `string|null` vs `WindowSnapshot.id` が `number` の型不一致 / セッション rename delta 処理の契約ドキュメント | 2053, 2030 |
| S-24 | `frontend/src/hooks/useTerminalEvents.ts` | `useMemo` で `paneEvent` メモ化が不要 / ESLint suppress の stale リスク | 2056, 2030 |
| S-25 | `frontend/src/types/tmux.ts` | Go types との DRIFT RISK 検出自動化 / `PaneSnapshot.id: string` vs `WindowSnapshot.active_pane: number` 型不整合 | 2056, 2030 |

---

## Strengths (良い点)

### アーキテクチャ・設計
- **`snapshotEventPolicies` マップ統合**: 2つの switch 文をデータドリブンなマップに統一。`TestSnapshotEventPolicyConsistency` による不変条件検証付き
- **`requireSessionsWithPaneID`**: 7メソッドのバリデーションボイラープレートを DRY 化、テストカバー済み
- **RLock ファストパス + Lock スローパスの ResolveTarget**: 読取主体の呼出しでロック競合を削減する最適化。double-check locking のギャップを安全に処理
- **TOCTOU 修正**: `resolveDirectionalPane` の3段階ロック→単一ロック統合
- **`bestEffortSendKeys` / `buildPaneEnv` 共通化**: 3箇所に散在したロジックを統一
- **TerminalPane フック分割**: 662行モノリスを4フック(setup/events/resize/fontSize)に単一責任分離、依存方向が単方向

### 防御的コーディング
- **`copySnapshotCache`**: shallow copy が安全な理由を詳細論証、将来の deep copy 必要条件も IMPORTANT で明記
- **`cloneSessionForRead`**: nil 除去によるインデックスベース panic を防止
- **ロック順序ドキュメント**: `snapshotDeltaMu -> snapshotMu` の順序を明確にドキュメント化
- **`killPaneLocked` のターミナルクローズパターンが模範的**: nil 化前に参照保存、ロック外でクローズ
- **`safeAddonOp`**: disposed SearchAddon への安全な操作パターン
- **一貫したロールバックパターン**: `handleNewSession`, `splitWindowResolved`, `handleNewWindow` で partial failure 時の適切な巻き戻し
- **環境変数ブロックリスト**: `command_router_terminal.go` の defense-in-depth
- **フィールド数ガードコメント**: equality 関数に `IMPORTANT: update when fields change` + テスト参照

### テスト
- **テストカバレッジ大幅強化**: format 変数全網羅、キーテーブル全文字、ポリシー整合性、型ミスマッチ等
- **テーブル駆動テスト一貫使用**: `TestFallbackWindowIDNearIndex`（11ケース）等
- **`TestCommandRouterHandlerMapHasNoDuplicateKeys`**: ハンドラマップの重複キー検出
- **`cloneTransformRequest` フィールド数ガードテスト**: struct フィールド追加時の clone 更新漏れをキャッチ
- **`validateCommandSpecConsistency()` init チェック**: spec と commandOrder の同期チェックを起動時に検出
- **`t.Parallel()` 制限の明示的コメント**: データレースリスクを一貫して警告
- **冪等で安全なクリーンアップ設計**: `CleanupLegacyShimInstalls` のテスト網羅

### tmux-shim
- **`runTransformSafe` パニック回復**: snapshot/restore でトランスフォーム失敗時も原文転送を保証
- **ALL ワイルドカード対応**: `ModelFrom: "ALL"` でテストケース充実
- **モデル config キャッシュ（エラー非キャッシュ）**: 一時的な読み込み失敗からの回復設計

### Frontend
- **`EventsOn` 返り値による個別解除**: cancel 関数ベースで複数ペイン共存時の誤解除リスク解消
- **IME 対応の手厚さ**: 日本語入力時の二重入力防止
- **`useWindowRename` の double-commit ガード**: Enter → onBlur 二重発火を防御
- **`useBackendSync`**: `Promise.allSettled` による堅牢な並行初期化
- **`usePrefixKeyMode` の `getState()` 直接参照**: Stale closure 問題を Zustand 公式パターンで解消
- **WebGL フォールバック**: module-level フラグで再試行回避

---

## 並列作業グループ表

修正タスクを**同一ファイルの競合を回避**しつつ効率的に並列実行するためのグループ分け。

### グループ一覧

| グループ | タスク | 対象ファイル | グループ内の順序 |
|---------|--------|-------------|----------------|
| **A: session_manager_windows** | C-1, I-17(定数化), T-5, T-6 | `session_manager_windows.go`, `session_manager_sessions.go` | C-1 → T-5 → T-6, I-17は並列可 |
| **B: session_manager_pane_io** | C-2, I-16, T-4 | `session_manager_pane_io.go` | C-2 → T-4, I-16は並列可 |
| **C: session_manager_targets** | I-8, I-9, I-10, I-11, T-1, T-2 | `session_manager_targets.go` | I-8 → I-9 → I-10 → I-11（同一ファイル順次）, T-1/T-2は新規テストファイルで最後 |
| **D: command_router** | I-12, I-15, T-3 | `command_router.go`, `command_router_handlers_window.go` | I-12 ∥ I-15, T-3は最後 |
| **E: command_router_handlers_pane** | I-13, I-14 | `command_router_handlers_pane.go` | I-13 → I-14（設計検討要） |
| **F: App 層** | I-1, I-2, I-3, T-7 | `app_session_api.go`, `app_events.go`, `app_pane_api.go`, `app_lifecycle_test.go` | 全て別ファイル、並列可 |
| **G: tmux-shim** | I-4+I-5, I-6+I-7, T-8 | `model_transform.go`, `command_transform_test.go`, `model_transform_test.go` | I-4+I-5同一ファイル、I-6+I-7同一ファイル、T-8別ファイル |
| **H: install** | I-19, I-20, I-21, I-22, T-10 | `shim_cleanup_windows.go`, `shim_cleanup_windows_test.go` | 同一ファイル順次: I-19 → I-20 → I-21 → I-22 |
| **I: Frontend hooks** | I-24, I-25, I-26, I-27, I-28 | `useTerminalSetup.ts`, `useTerminalResize.ts`, `useTerminalEvents.ts`, `useTerminalFontSize.ts`, `useBackendSync.ts` | 全て別ファイル、並列可 |
| **J: session_manager_sessions** | I-17, I-18 | `session_manager_sessions.go` | I-17 → I-18（同一ファイル順次） |
| **K: 軽微コメント修正** | I-23 | `protocol.go` | 単独作業可 |

### グループ間の並列実行マップ

```
グループ A ──────────────────────► 完了
グループ B ──────────────────────► 完了
グループ C ──────────────────────────────► 完了（タスク数多）
グループ D ──────────────────────► 完了
グループ E ──────────────────────► 完了
グループ F ──────────────────────► 完了
グループ G ──────────────────────► 完了
グループ H ──────────────────────► 完了
グループ I ──────────────────────► 完了
グループ J ──────────────────────► 完了
グループ K ─► 完了

↑ 全グループを同時並列実行可能。グループ内の順序制約のみ注意。
```

### 推奨実行優先度

| 優先度 | グループ | 理由 |
|--------|---------|------|
| **1 (最優先)** | **A** (C-1) | ConPTY リソースリーク。実害あり |
| **1 (最優先)** | **B** (C-2) | データ競合リスク。実害あり |
| **2 (高)** | **C** (I-8〜I-11, T-1,T-2) | session_manager_targets の設計改善+テスト |
| **2 (高)** | **D** (I-12, I-15, T-3) | TOCTOU + テスト |
| **2 (高)** | **J** (I-17, I-18) | ハードコード定数 + ActivePN 不正 |
| **3 (中)** | **E, F, G, H** | Important コード修正 |
| **3 (中)** | **I** | Frontend 改善 |
| **4 (低)** | **K** | コメント修正のみ |

### 修正の全体サマリ

| 重要度 | 件数 | 内訳 |
|--------|------|------|
| Critical（コード修正） | 2 | C-1, C-2 |
| Important（コード修正） | 22 | I-1〜I-28 (I-23含む軽微込み) |
| Important（テスト追加） | 10 | T-1〜T-10 |
| Suggestions | 25 | S-1〜S-25 |
| **合計** | **59** | 重複排除済み |
