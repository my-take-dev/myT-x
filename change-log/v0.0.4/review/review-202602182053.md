# PR Review Summary — 2026/02/18 20:53

**対象**: myT-x/ 配下の変更ファイル (63ファイル, +6716/-2455行)

**レビュー方式**: 6カテゴリに分割した並列レビュー

| カテゴリ | ファイル数 | レビュー観点 |
|---------|-----------|------------|
| Cat1: App層 (app_*.go) | 14 | コード品質・エラー処理・テスト・コメント |
| Cat2: tmux-shim (cmd/tmux-shim/) | 7 | コード品質・エラー処理・型設計・テスト |
| Cat3a: internal/tmux (router/format/key) | 12 | コード品質・TOCTOU・エラー処理・テスト |
| Cat3b: internal/tmux (session_manager) | 8 | コード品質・並行処理・リーク・型設計 |
| Cat4: other internal (config/install/ipc) | 5 | コード品質・エラー処理・TestパターンN |
| Cat5: Frontend (React/TS) | 16 | フック設計・メモリリーク・型安全性 |

---

## Critical Issues (4件)

### C-1: `removeWindowAtIndexLocked` でTerminal参照をnil化後に返却 → ConPTYリーク
- **カテゴリ**: Cat3b (session_manager)
- **ファイル**: `myT-x/internal/tmux/session_manager_windows.go` L140-153
- **詳細**: `killPaneLocked` はTerminal参照を `result.closeTargets` に退避してから `pane.Terminal = nil` としているが、`removeWindowAtIndexLocked` では退避せずに直接nil化。返却される `removedPanes` は同一ポインタだが全て `Terminal==nil`。
- **影響箇所**:
  - `command_router_handlers_window.go` `handleKillWindow` — `removedPanes` のTerminal Close常にスキップ
  - `command_router_handlers_window.go` `handleNewWindow` ロールバック — 同様にClose不能
- **修正案**: `killPaneLocked` と同様にTerminal参照をロック内で別途退避し、`closeTargets` として返す

### C-2: `copyPaneSlice` が Env mapを浅いコピー → データ競合リスク
- **カテゴリ**: Cat3b (session_manager)
- **ファイル**: `myT-x/internal/tmux/session_manager_pane_io.go` L113-126
- **詳細**: `copied := *pane` は shallow copy のため `copied.Env` は内部 `pane.Env` と同一mapを共有。ロック外で返却された `TmuxPane` の `Env` を通じて内部状態変更可能。`cloneSessionForRead` は `copyEnvMap(pane.Env)` で深いコピーだが、`copyPaneSlice` では行っていない。
- **同一パターン**: `session_manager_pane_io.go` L41-49 `allInSession` パスのインラインコピーも同様
- **修正案**: `copied.Env = copyEnvMap(pane.Env)` を追加

### C-3: `resolveTargetWriteLocked` が `resolveWindowPaneTarget` の `needsRepair` を無視
- **カテゴリ**: Cat3a (tmux router)
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go` (`resolveTargetWriteLocked` 内)
- **詳細**: write Lock配下で `resolveWindowPaneTarget` を呼び出した際に `needsRepair` を `_` で捨てている。現時点では `resolveWindowPaneTarget` は常に `needsRepair=false` を返すため実害はないが、将来変更時にサイレントバグの温床。
- **修正案**: コメントで意図を明記するか、`resolveWindowPaneTarget` の write Lock用バリアントを分離

### C-4: `ResolveTarget` の RLock→Lock間でのポインタ安全性
- **カテゴリ**: Cat3a (tmux router)
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go` (`ResolveTarget`)
- **詳細**: `resolveTargetRLocked` が内部 `m.panes[id]` のポインタを直接返しており、RLock解放後の dangling ポインタになりうる。`ResolveTarget` は `needsRepair=false` 時のみ使用し、通常パスでは問題にならないが設計上の時限爆弾。
- **修正案**: 返される `*TmuxPane` は read-only使用の前提をコメントで明記

---

## Important Issues (17件)

### I-1: `RenameSession` のコメントがスナップショット発行の実態と矛盾
- **カテゴリ**: Cat1 (App層)
- **ファイル**: `myT-x/app_session_api.go` L133-138
- **詳細**: コメントで「periodic delta mechanism で検出」と記載だが、`emitBackendEvent("tmux:session-renamed", ...)` 経由で即時スナップショットが実際には発行される。`snapshotEventPolicies` で `{trigger: true, bypassDebounce: true}` 指定済み。
- **修正案**: コメントを実際の動作に合わせて修正

### I-2: テストケース名「session has no windows」が実態と乖離
- **カテゴリ**: Cat1 (App層)
- **ファイル**: `myT-x/app_pane_api_test.go` L606-625
- **詳細**: KillPaneでセッション自体が削除されるため、実際は「存在しないセッション」のテスト。`wantErr` も `"session not found"`。
- **修正案**: テストケース名を `"session removed after killing last pane"` 等に変更

### I-3: `SplitPane` だけがバリデーションボイラープレートが未統一
- **カテゴリ**: Cat1 (App層)
- **ファイル**: `myT-x/app_pane_api.go` L10-17
- **詳細**: 他7メソッドは `requireSessionsWithPaneID` で統一。`SplitPane` だけ手動の TrimSpace+empty check。
- **修正案**: paneIDバリデーションヘルパーを切り出すか、コメントで意図明示

### I-4: `applyFromToReplacement` に `--model=` 空値ガードが欠如
- **カテゴリ**: Cat2 (tmux-shim)
- **ファイル**: `myT-x/cmd/tmux-shim/model_transform.go` L240-259
- **詳細**: `applyModelOverride` には空値ガードがあるが、`applyFromToReplacement` にはない。`newModelTransformer` のガードで到達しないため現時点で実害はないが、防御的一貫性が欠如。
- **修正案**: 同様のガードを追加するか、コメントで意図的省略を明記

### I-5: テスト `TestApplyNewProcessTransformDirectCases` — nil Env mapへの書き込みパニック可能性
- **カテゴリ**: Cat2 (tmux-shim)
- **ファイル**: `myT-x/cmd/tmux-shim/command_transform_test.go` L168-178
- **詳細**: `Env: nil` で `applyNewProcessTransform` を直接呼ぶテスト。`parsed.ExtraEnv` が非空の場合、nil mapへの書き込みでpanic。
- **修正案**: `Env: map[string]string{}` に変更するか、関数冒頭でnil mapガード追加

### I-6: `wantChanged` 検証が片方向のみ
- **カテゴリ**: Cat2 (tmux-shim)
- **ファイル**: `myT-x/cmd/tmux-shim/command_transform_test.go` L166-199
- **詳細**: `if tt.wantChanged && !changed` のみチェック。`!tt.wantChanged && changed` は検出されない。
- **修正案**: 双方向チェックに変更

### I-7: `applyModelTransform` で `slog.Warn` と `debugLog` が二重出力
- **カテゴリ**: Cat2 (tmux-shim)
- **ファイル**: `myT-x/cmd/tmux-shim/model_transform.go` L65-68
- **詳細**: shim全体で `debugLog` に統一されているのにここだけ `slog.Warn` も使用。stderrが呼び出し元に漏れる可能性。
- **修正案**: `slog.Warn` を削除し `debugLog` のみに統一

### I-8: `splitWindowResolved` の `extraEnv` が `sanitizeCustomEnvironmentEntry` をバイパス
- **カテゴリ**: Cat3a (tmux router)
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_pane.go` L86-91
- **詳細**: `buildPaneEnv` は `sanitizeCustomEnvironmentEntry` 経由だが、`splitWindowResolved` の `extraEnv` は直接 `env[k] = v` でマージ。`blockedEnvironmentKeys` をバイパス。
- **修正案**: `buildPaneEnv` に統合するか、`sanitizeCustomEnvironmentEntry` を通す

### I-9: `handleListPanes` の `formatPaneLine` で Window/Session 情報が常に空
- **カテゴリ**: Cat3a (tmux router) / Cat3b (session_manager)
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_pane.go` L397-409
- **詳細**: `ListPanesByWindowTarget` の値コピーで `Window=nil`。`formatPaneLine` → `expandFormat` → `lookupFormatVariable` は `window_name`, `session_name` 等を参照するが、常にデフォルト値（空文字列/0）になる。
- **修正案**: 値コピー時にスカラー値を追加フィールドとして保持するか、format処理で別途解決

### I-10: `resolveSessionTargetLocked` の命名が「RLock可」の実態と矛盾
- **カテゴリ**: Cat3b (session_manager)
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go`
- **詳細**: 命名規約で `Locked = write lock` と定義されているが、実際は読み取り専用でRLockでも使用。
- **修正案**: 命名規約を統一するか、関数名を中立的名称に変更

### I-11: `ResolveDirectionalPane` のユニットテストが不足
- **カテゴリ**: Cat3b (session_manager)
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go`
- **詳細**: TOCTOU修正の中核メソッドだがユニットテストがない。境界ケース(1ペインwindow、先頭/末尾クランプ、DirNone等)のテーブル駆動テストが必要。
- **修正案**: テスト追加

### I-12: `CreateSession` / `AddWindow` のデフォルト寸法がハードコード
- **カテゴリ**: Cat3b (session_manager)
- **ファイル**: `myT-x/internal/tmux/session_manager_sessions.go` L67-73, `session_manager_windows.go` L25-30
- **詳細**: ハンドラ側は `DefaultTerminalCols`/`DefaultTerminalRows` 定数に統一されたが、SessionManager内は `120`, `40` のままハードコード。
- **修正案**: 定数を使用

### I-13: `cloneSessionForRead` でnilスキップ時にActivePNが不正になる可能性
- **カテゴリ**: Cat3b (session_manager)
- **ファイル**: `myT-x/internal/tmux/session_manager_sessions.go`
- **詳細**: nil paneスキップ後のスライスではインデックスがずれるため、`ActivePN` が誤った pane を指す可能性。
- **修正案**: nil paneスキップ時に `ActivePN` を再計算

### I-14: ログプレフィックスの不統一 `[WARN-SHIM]` vs `[DEBUG-SHIM]`
- **カテゴリ**: Cat4 (install)
- **ファイル**: `myT-x/internal/install/shim_cleanup_windows.go` L232
- **詳細**: 1箇所だけ `[WARN-SHIM]` で他は全て `[DEBUG-SHIM]`。プロジェクト規約「ログ名統一して削除しやすく」に違反。
- **修正案**: `[DEBUG-SHIM]` に統一

### I-15: `cleanupStalePathEntries` のパスマッチがケースセンシティブ
- **カテゴリ**: Cat4 (install)
- **ファイル**: `myT-x/internal/install/shim_cleanup_windows.go` L191
- **詳細**: Windowsパスは大文字小文字を区別しないが、`strings.Contains` で比較。`\TEMP\` が大文字の場合にマッチしない。
- **修正案**: `strings.ToLower` で比較

### I-16: `useTerminalSetup` で GetPaneReplay に disposed チェックがない
- **カテゴリ**: Cat5 (Frontend)
- **ファイル**: `myT-x/frontend/src/hooks/useTerminalSetup.ts` L130-140
- **詳細**: Terminal dispose後にPromise解決すると、disposed済みインスタンスへの `term.write(replay)` で例外発生の可能性。
- **修正案**: `disposed` フラグでガード

### I-17: `useTerminalResize` / `useTerminalEvents` で IME リスナーが二重登録
- **カテゴリ**: Cat5 (Frontend)
- **ファイル**: `myT-x/frontend/src/hooks/useTerminalResize.ts` L72-95, `useTerminalEvents.ts` L64-82
- **詳細**: 両フックが同じ `term.textarea` に対して独立に `compositionstart`/`compositionend`/`blur` リスナー登録。旧モノリスは3個、新コードは6個。
- **修正案**: 共通の `isComposingRef` を共有するか、IME追跡を専用フックに分離

---

## Suggestions (23件)

### S-1: `snapshotEventPolicies` の `trigger` フィールドが全エントリで `true` (冗長)
- **ファイル**: `myT-x/app_events.go` L109-120
- 現状は不変条件テストで保護されているため許容範囲

### S-2: `handleLegacyMapPaneOutput` のログに `rawData` 値自体を追加すると有用
- **ファイル**: `myT-x/app_events.go` L95-101

### S-3: `resolveActiveWindowSnapshot` のフォールバックログを INFO レベルに昇格検討
- **ファイル**: `myT-x/app_status.go` L80-84

### S-4: テストタイムアウト `2*time.Second` の定数化
- **ファイル**: `myT-x/app_events_test.go` L478, L522, L567 (3箇所)

### S-5: `TestResizePaneBoundaryValues` が pane実在時の境界値テストになっていない
- **ファイル**: `myT-x/app_pane_api_test.go` L668-694

### S-6: `resetModelConfigCache` — `resetModelConfigLoadState` の不要なエイリアス
- **ファイル**: `myT-x/cmd/tmux-shim/model_transform_test.go` L684-688

### S-7: 「value with spaces around =」テストケースで値側スペースケースが未テスト
- **ファイル**: `myT-x/cmd/tmux-shim/main_test.go`

### S-8: `matchAll` と `modelPattern` の排他性をコメントで明記
- **ファイル**: `myT-x/cmd/tmux-shim/model_transform.go` L128-136

### S-9: テスト fixture 作成の重複削減 (builder パターン)
- **ファイル**: `myT-x/internal/tmux/format_test.go`

### S-10: `bestEffortSendKeys` のログタグが文字列連結 → structured logging属性
- **ファイル**: `myT-x/internal/tmux/command_router.go` L176-215

### S-11: `formatSessionLine` の `session_created_human` 二重展開
- **ファイル**: `myT-x/internal/tmux/format.go` L17-23
- `expandFormat` に統合で簡潔化可能

### S-12: `command_router_test.go` の `expectedCommands` リストの自動同期化
- **ファイル**: `myT-x/internal/tmux/command_router_test.go`

### S-13: `SessionSnapshot.Clone()` 単体テスト不足
- **ファイル**: `myT-x/internal/tmux/session_manager_snapshot.go`

### S-14: `bestEffortSendKeys` の `appendEnter` が全呼び出しで `true`
- **ファイル**: `myT-x/internal/tmux/command_router.go`

### S-15: `emitLayoutChangedForSession` のWarnログがノイズの原因になりうる
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_pane.go` L293-307

### S-16: `handleListPanes` のコメント「already in correct order」が不正確
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_pane.go`

### S-17: `resolveTargetWriteLocked` と `resolveTargetRLocked` のロジック重複
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go`

### S-18: `ResolveDirectionalPane` が DirNone で write Lock取得（RLockで十分）
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go`

### S-19: テストで `t.Setenv` を使うべき (8箇所)
- **ファイル**: `myT-x/internal/install/shim_cleanup_windows_test.go` L101-103, L116, L130, L145, L163, L175, L189, L207

### S-20: `removeLegacyDirectory` が LOCALAPPDATA を再取得 (パラメータで受取推奨)
- **ファイル**: `myT-x/internal/install/shim_cleanup_windows.go` L113

### S-21: ipc/protocol.go の Flags コメント `int` は JSON では `float64`
- **ファイル**: `myT-x/internal/ipc/protocol.go` L21

### S-22: `TerminalPaneComponent` の不要な `fontSize` ストア購読 → 全ペイン再レンダリング
- **ファイル**: `myT-x/frontend/src/components/TerminalPane.tsx` L30

### S-23: `tmuxStore` の `activeWindowId` / `setActiveWindowId` が未使用
- **ファイル**: `myT-x/frontend/src/stores/tmuxStore.ts` L56-57

---

## Strengths (良い点)

### アーキテクチャ・設計
- **snapshotEventPolicies**: データドリブンなマップベース設計でイベントポリシーを宣言的管理。整合性テスト付き
- **requireSessionsWithPaneID**: 7メソッドのバリデーションボイラープレートをDRY化
- **TOCTOU修正**: `resolveDirectionalPane` の3段階ロック→単一ロック統合、`ResolveTarget` のRLock最適化
- **bestEffortSendKeys / buildPaneEnv**: 3箇所に散在したロジックを共通化
- **TerminalPane フック分割**: 662行モノリスを4フック(setup/events/resize/fontSize)に単一責任分離

### 防御的コーディング
- **copySnapshotCache**: shallow copyが安全な理由を詳細論証、将来のdeep copy必要条件もIMPORTANTで明記
- **cloneSessionForRead**: nil除去によるインデックスベースpanicを防止
- **ロック順序ドキュメント**: `snapshotDeltaMu -> snapshotMu` の順序を明確にドキュメント化
- **safeAddonOp**: disposed SearchAddon への安全な操作パターン

### テスト
- **テストカバレッジ大幅強化**: format変数全網羅テスト、キーテーブル全文字テスト、ポリシー整合性テスト、型ミスマッチテスト等
- **テーブル駆動テスト一貫使用**、`t.Parallel()` 禁止の明示コメント、デバウンスタイムアウト拡大によるflaky test対策
- **冪等で安全なクリーンアップ設計**: `CleanupLegacyShimInstalls` のテスト網羅

### その他
- **shim仕様への忠実な準拠**: config読み込み失敗時に原文転送、エラーで停止しない
- **トラッキングID付きコメント**: I-11, I-13, S-42等で設計根拠を追跡可能
- **useBackendSync**: `Promise.allSettled` による堅牢な並行初期化

---

## タスク一覧・並列作業可否表

修正タスクを優先度順に整理し、**並列作業の可否**を明示します。

### 凡例
- **並列OK**: 他のタスクに依存せず、独立して修正可能
- **順序あり**: 先行タスクの完了後に着手推奨
- **同一ファイル**: 同一ファイルを複数タスクが変更するため、同時編集に注意

### Critical修正タスク

| # | タスクID | 対象ファイル | 修正内容 | 並列作業 | 備考 |
|---|---------|-------------|---------|---------|------|
| 1 | C-1 | `internal/tmux/session_manager_windows.go` | `removeWindowAtIndexLocked` でTerminal退避してからnil化 | **並列OK** | ConPTYリーク防止 |
| 2 | C-2 | `internal/tmux/session_manager_pane_io.go` | `copyPaneSlice` と `allInSession` パスで `copyEnvMap` 追加 | **並列OK** | データ競合防止 |
| 3 | C-3 | `internal/tmux/session_manager_targets.go` | `resolveTargetWriteLocked` に `needsRepair` 無視の意図コメント追加 | **同一ファイル(C-4)** | C-4と同一ファイル、順次推奨 |
| 4 | C-4 | `internal/tmux/session_manager_targets.go` | `ResolveTarget` 返却ポインタのread-only前提コメント追加 | **同一ファイル(C-3)** | C-3と同一ファイル、順次推奨 |

### Important修正タスク

| # | タスクID | 対象ファイル | 修正内容 | 並列作業 | 備考 |
|---|---------|-------------|---------|---------|------|
| 5 | I-1 | `app_session_api.go` | コメント修正（スナップショット発行経路の正確な記述） | **並列OK** | コメントのみ |
| 6 | I-2 | `app_pane_api_test.go` | テストケース名を実態に合わせて修正 | **並列OK** | テストのみ |
| 7 | I-3 | `app_pane_api.go` | `SplitPane` のpaneIDバリデーション共通化 or コメント | **並列OK** | |
| 8 | I-4 | `cmd/tmux-shim/model_transform.go` | `applyFromToReplacement` に空値ガード追加 | **並列OK** | shim独立モジュール |
| 9 | I-5 | `cmd/tmux-shim/command_transform_test.go` | nil Env → `map[string]string{}` に変更 | **同一ファイル(I-6)** | I-6と同一ファイル |
| 10 | I-6 | `cmd/tmux-shim/command_transform_test.go` | `wantChanged` の双方向チェック | **同一ファイル(I-5)** | I-5と同一ファイル |
| 11 | I-7 | `cmd/tmux-shim/model_transform.go` | `slog.Warn` 削除、`debugLog` に統一 | **同一ファイル(I-4)** | I-4と同一ファイル |
| 12 | I-8 | `internal/tmux/command_router_handlers_pane.go` | `splitWindowResolved` の `extraEnv` に sanitize 適用 | **同一ファイル(I-9)** | I-9と同一ファイル |
| 13 | I-9 | `internal/tmux/command_router_handlers_pane.go` | `handleListPanes` でWindow/Session情報を値コピーに含める | **同一ファイル(I-8)** | I-8と同一ファイル。設計検討要 |
| 14 | I-10 | `internal/tmux/session_manager_targets.go` | 命名規約の統一（`Locked` サフィックスの意味） | **同一ファイル(C-3,C-4)** | C-3,C-4と同一ファイル |
| 15 | I-11 | `internal/tmux/session_manager_*_test.go` | `ResolveDirectionalPane` のテスト追加 | **並列OK** | 新規テストファイル可 |
| 16 | I-12 | `internal/tmux/session_manager_sessions.go`, `session_manager_windows.go` | マジックナンバー `120`, `40` → 定数化 | **並列OK** | |
| 17 | I-13 | `internal/tmux/session_manager_sessions.go` | `cloneSessionForRead` の `ActivePN` 再計算 | **同一ファイル(I-12)** | I-12と同一ファイル |
| 18 | I-14 | `internal/install/shim_cleanup_windows.go` | `[WARN-SHIM]` → `[DEBUG-SHIM]` に統一 | **同一ファイル(I-15)** | I-15と同一ファイル |
| 19 | I-15 | `internal/install/shim_cleanup_windows.go` | `strings.Contains` → 大文字小文字無視比較 | **同一ファイル(I-14)** | I-14と同一ファイル |
| 20 | I-16 | `frontend/src/hooks/useTerminalSetup.ts` | `disposed` チェック追加 | **並列OK** | Frontend独立 |
| 21 | I-17 | `frontend/src/hooks/useTerminalResize.ts`, `useTerminalEvents.ts` | IMEリスナー共有化 | **並列OK** | Frontend独立。設計検討要 |

### 並列作業グループ表

効率的に修正するため、**同時に作業可能なグループ**を以下にまとめます。

| グループ | タスク | 作業者 | 備考 |
|---------|--------|--------|------|
| **A: session_manager_windows** | C-1 | 1人目 | 独立作業可 |
| **B: session_manager_pane_io** | C-2 | 2人目 | 独立作業可 |
| **C: session_manager_targets** | C-3 → C-4 → I-10 | 3人目 | 同一ファイル、順次作業 |
| **D: App層** | I-1, I-2, I-3 | 4人目 | 全て別ファイル、並列可 |
| **E: tmux-shim** | I-4+I-7, I-5+I-6 | 5人目 | 2ファイル、各内部は順次 |
| **F: command_router_handlers_pane** | I-8 → I-9 | 6人目 | 同一ファイル、順次。I-9は設計検討要 |
| **G: session_manager その他** | I-11, I-12+I-13 | 7人目 | I-12とI-13は同一ファイル |
| **H: install** | I-14 + I-15 | 8人目 | 同一ファイル、一括修正可 |
| **I: Frontend** | I-16, I-17 | 9人目 | 別ファイル、並列可 |

**→ グループ A〜I は全て並列作業可能です。各グループ内の順序制約のみ注意してください。**
