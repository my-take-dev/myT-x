# PR Review Summary — review-202602182149

**対象:** `myT-x/` 配下の未コミット変更 (64ファイル, +7098/-2513)  
**レビュー方式:** 7つの専門レビューエージェントによる並列レビュー  
**レビュー観点:** コード品質(App層), コード品質(tmux-shim/internal), テストカバレッジ, エラーハンドリング, 型設計/API, フロントエンド+インフラ, コード簡素化

---

## 総合評価

| 重要度 | 件数 |
|--------|------|
| Critical | 1 |
| Important | 13 |
| Test Issue | 9 |
| Suggestion | 17 |

全体として整理された設計変更であり、特にスナップショットデルタ比較、イベントポリシーマップ化、tmux-shimの型安全性向上は良い改善。
ただし、1件のCritical（ゼロ値問題）と、エラーハンドリング・テスト網羅性に改善の余地あり。

---

## Critical (1件)

### C-01: `DirectionalPaneDirection` のゼロ値が `DirPrev` になっている

**ファイル:** `myT-x/internal/tmux/session_manager_targets.go`  
**重要度:** Critical  

**問題:** `DirectionalPaneDirection` の iota 定義で `DirPrev` が 0 になっている。Go のゼロ値は 0 であるため、未初期化の変数が暗黙的に「前のペインへ移動」として動作する。

```go
const (
    DirPrev DirectionalPaneDirection = iota // = 0 ← ゼロ値
    DirNext
    DirUp
    DirDown
    DirLeft
    DirRight
)
```

**修正案:** `DirNone` をゼロ値として先頭に追加し、`ResolveDirectionalPane` で `DirNone` を受け取った場合にエラーを返す。

```go
const (
    DirNone DirectionalPaneDirection = iota // zero value = invalid
    DirPrev
    DirNext
    DirUp
    DirDown
    DirLeft
    DirRight
)
```

---

## Important (13件)

### I-01: `emitWorktreeCleanupFailure` の `context.Background()` フォールバック

**ファイル:** `myT-x/app_events.go`  
**重要度:** Important  

**問題:** Wails はフロントエンドへのイベント送信に実際のコンテキストを必要とする。`context.Background()` によるフォールバックでは、Wails ランタイムに到達せずフロントエンドにイベントが届かない可能性がある。

**修正案:** ctx が nil の場合はイベント発行をスキップし、ログ出力のみとする。

---

### I-02: `snapshotEventPolicies` が `var` マップで実行時変更可能

**ファイル:** `myT-x/app_events.go`  
**重要度:** Important  

**問題:** `snapshotEventPolicies` は `var` で宣言された map であり、実行時に変更される可能性がある。テストで意図せず変更されるリスクもある。

**修正案:** 現状のアプローチは許容可能だが、`init()` でフリーズするか、関数内で毎回生成するか、少なくともコメントで immutable intent を明記すべき。

---

### I-03: `ResolveDirectionalPane` のフォールバック `panes[0]` が nil の可能性

**ファイル:** `myT-x/internal/tmux/session_manager_targets.go`  
**重要度:** Important  

**問題:** `ResolveDirectionalPane` で方向解決に失敗した場合のフォールバックで `panes[0]` を返すが、ペインリストが空の場合に nil ポインタ参照が発生する可能性がある。

**修正案:** `len(panes) == 0` の事前チェックを追加し、空の場合はエラーを返す。

---

### I-04: `RemoveWindowByID` の 4 戻り値パターン

**ファイル:** `myT-x/internal/tmux/session_manager_windows.go`  
**重要度:** Important  

**問題:** `([]*TmuxPane, bool, int, error)` の 4 戻り値は認知負荷が高い。呼び出し側で `removedPanes, removedSession, survivingWindowID, removeErr` と展開する必要がある。

**修正案:** `WindowRemovalResult` 構造体を導入する。ただし呼び出し箇所が 2 箇所のみのため、次の戻り値追加時に構造体化するのも合理的。

```go
type WindowRemovalResult struct {
    RemovedPanes      []*TmuxPane
    SessionRemoved    bool
    SurvivingWindowID int
}
```

---

### I-05: `ListPanesByWindowTarget` が Write Lock を使用

**ファイル:** `myT-x/internal/tmux/session_manager_targets.go`  
**重要度:** Important  

**問題:** 読み取り専用操作である `ListPanesByWindowTarget` が `mu.Lock()` (Write Lock) を使用している。`mu.RLock()` で十分な可能性がある。

**修正案:** 内部で auto-repair (`activeWindowInSessionLocked`) が呼ばれる場合は Write Lock が必要。呼ばれないコードパスでは `RLock` に変更可能か確認。

---

### I-06: `applyModelOverride` の空 model= ガード

**ファイル:** `myT-x/cmd/tmux-shim/command_transform.go`  
**重要度:** Important  

**問題:** `--model` フラグの値が空文字列の場合の挙動が仕様書で明確でない。空文字列を受け入れるとモデルが空に上書きされる可能性がある。

**修正案:** 空文字列チェックを追加し、空の場合は変換をスキップして debugLog で記録。

---

### I-07: `handleSelectWindow` の TOCTOU ギャップ

**ファイル:** `myT-x/internal/tmux/command_router_handlers.go`  
**重要度:** Important  

**問題:** `GetSession` でセッション取得後、`SetActivePane` までの間に他の操作でウィンドウが削除される可能性がある（TOCTOU: Time-of-Check-Time-of-Use）。

**修正案:** デスクトップアプリで並行操作が限定的であるため、実害リスクは低い。ただしロック粒度を見直し、アトミックな操作として実装することが望ましい。

---

### I-08: `handleNewWindow` のクローン時の古いペインサイズ

**ファイル:** `myT-x/internal/tmux/command_router_handlers.go`  
**重要度:** Important  

**問題:** 新しいウィンドウ作成時にクローン元のペインサイズをそのまま使用しているが、ウィンドウサイズが異なる場合にペインサイズが不整合になる可能性がある。

**修正案:** 新ウィンドウのデフォルトサイズを使用するか、レイアウト再計算を行う。

---

### I-09: `CleanupLegacyShimInstalls` が常に nil を返す

**ファイル:** `myT-x/internal/install/shim_cleanup_windows.go`  
**重要度:** Important  

**問題:** 関数が常に `nil` を返すため、呼び出し側の `if err != nil` チェックがデッドコードとなっている。

**修正案:** 関数シグネチャを `error` なしに変更するか、実際のエラーを集約して返す。デッドコードが混乱を招くため、どちらかに統一すべき。

---

### I-10: `activeWindowInSessionLocked` の状態変更ログが Debug レベル

**ファイル:** `myT-x/internal/tmux/session_manager_targets.go`  
**重要度:** Important  

**問題:** アクティブウィンドウの自動修復（状態変更）は重要な副作用であるにもかかわらず、Debug レベルでログ出力されている。調査時に見落としやすい。

**修正案:** `slog.Info` に昇格し、自動修復が発生したことを運用ログに残す。

---

### I-11: `handleLegacyMapPaneOutput` の型不一致ログが Debug レベル

**ファイル:** `myT-x/internal/tmux/command_router_handlers.go`  
**重要度:** Important  

**問題:** レガシーのペイン出力マッピングで型不一致が発生した場合、`slog.Debug` でのみログ出力。これはデータ整合性の問題を示す可能性があり、Warn レベルが適切。

**修正案:** `slog.Warn` に変更。

---

### I-12: `useTerminalSetup` で初期 `ResizePane` 呼び出しが欠落

**ファイル:** `myT-x/frontend/src/hooks/useTerminalSetup.ts`  
**重要度:** Important  

**問題:** `fitAddon.fit()` 実行後に `ResizePane` API をバックエンドへ呼び出していない。初期表示時にバックエンドが正しいペインサイズを知らない可能性がある。

**修正案:** `fitAddon.fit()` 直後に `ResizePane` を呼び出し、バックエンドとフロントエンドのサイズを同期する。

---

### I-13: `cleanupStalePathEntries` が毎起動時に実行

**ファイル:** `myT-x/internal/install/shim_cleanup_windows.go`  
**重要度:** Important  

**問題:** システム PATH のレジストリスキャンが毎回起動時に実行される。パフォーマンス影響は小さいが、起動コストとして不必要な場合がある。

**修正案:** フラグファイルによるスキップ、または初回インストール/アップデート時のみ実行するロジックを検討。

---

## Test Issues (9件)

### T-01: `TestLegacyMapPaneOutputTypeMismatchLog` の共有 slog バッファ競合リスク

**ファイル:** `myT-x/cmd/tmux-shim/command_transform_test.go`  
**重要度:** Important  

**問題:** テストが共有の `bytes.Buffer` を `slog.Handler` に使用しており、`t.Parallel()` が追加された場合にデータ競合が発生する。現状はシリアル実行のため安全だが、将来の並列化で壊れる。

**修正案:** 各テストケースで独立した `bytes.Buffer` を生成。または明示的にコメントで並列化不可を記載。

---

### T-02: `TestApplyModelTransformSkipsOnLoaderError` の環境依存パス

**ファイル:** `myT-x/cmd/tmux-shim/model_transform_test.go`  
**重要度:** Important  

**問題:** デバッグログのパス表現がテスト環境に依存する可能性がある。

**修正案:** パス比較部分を正規表現マッチまたは `strings.Contains` に変更。

---

### T-03: `TestApplyLayoutPresetErrorPaths` のテスト名と動作の不一致

**ファイル:** `myT-x/app_pane_api_test.go`  
**重要度:** Important  

**問題:** テスト名が "ErrorPaths" だが、実際にはエラーパスだけでなく正常パスも含んでいる。テストの意図が名前から読み取れない。

**修正案:** テスト名を `TestApplyLayoutPreset_VariousPaths` に変更するか、エラーケースと正常ケースを分離。

---

### T-04: `waitForCondition` のタイムアウト増加に根拠コメントなし

**ファイル:** `myT-x/app_events_test.go`, `myT-x/app_lifecycle_test.go`  
**重要度:** Suggestion  

**問題:** `waitForCondition` のタイムアウト値が変更されているが、変更理由のコメントがない。

**修正案:** タイムアウト変更の理由（例: CI 環境での遅延対策）をコメントで記載。

---

### T-05: `TestResizePaneBoundaryValues` のテスト範囲が限定的

**ファイル:** `myT-x/app_pane_api_test.go`  
**重要度:** Important  

**問題:** 存在しないペインのリサイズのみをテストし、実際のサイズ境界値（0, 負値, 最大値）をテストしていない。

**修正案:** 境界値テストケースを追加: `cols=0`, `rows=0`, `cols=-1`, `rows=MaxInt` 等。

---

### T-06: `TestEmitSnapshot` でデルタペイロードの内容未検証

**ファイル:** `myT-x/app_events_test.go`  
**重要度:** Important  

**問題:** スナップショット発行テストでイベントの発行有無のみ確認し、ペイロードの内容（セッション数、ペイン情報等）を検証していない。

**修正案:** ペイロードをデコードし、送信されたセッション名とペインIDの一致を検証。

---

### T-07: `requireSessionsWithPaneID` の副作用（TrimSpace）がテストされていない

**ファイル:** `myT-x/app_guards.go`  
**重要度:** Important  

**問題:** ポインタ引数経由で入力値を TrimSpace して書き戻す副作用があるが、テストでこの動作が確認されていない。

**修正案:** `" pane-1 "` を渡して返却後に `"pane-1"` になっていることを検証するテストを追加。

---

### T-08: tmux-shim のデバッグログパターン境界テストが不足

**ファイル:** `myT-x/cmd/tmux-shim/`  
**重要度:** Suggestion  

**問題:** shim-debug ログの出力パターン（特にエッジケース: 空文字列、特殊文字含むモデル名等）のテストが不足。

**修正案:** 空文字列モデル名、Unicode 文字含むモデル名等の境界テストを追加。

---

### T-09: `TestCloneSessionSnapshotsIndependence` で Layout ツリーの再帰テスト欠落

**ファイル:** `myT-x/app_snapshot_delta_test.go`  
**重要度:** Important  

**問題:** スナップショットのクローン独立性テストで Layout の再帰ツリー構造（Children）の独立性が検証されていない。

**修正案:** 子ノードを持つ Layout ツリーをクローンし、クローン側の Children 変更が元に影響しないことを確認。

---

## Suggestion (17件)

### S-01: `snapshotEventPolicy` の `trigger` フィールドが常に true — 冗長

**ファイル:** `myT-x/app_events.go`  

マップに存在すること自体が trigger=true を意味するため、`trigger` フィールドは不要。`map[string]bool`（値=bypassDebounce）で十分。

---

### S-02: `requireSessionsWithPaneID(*string)` — ポインタ引数が非慣用的

**ファイル:** `myT-x/app_guards.go`  

`*string` 引数による in-place mutation は Go では非慣用的。戻り値パターン `(string, *SessionManager, error)` への変更で可読性向上。ただし 7 箇所の呼び出し変更が必要。

---

### S-03: `shutdown()` の `snapshotMu` / `snapshotDeltaMu` ロック順序

**ファイル:** `myT-x/app_lifecycle.go`  

`shutdown()` で `snapshotMu` のみ取得し `snapshotDeltaMu` は取得しない。防御的な再チェックで安全だが、ロック順序の意図をコメントで明記すべき。

---

### S-04: `estimateLayoutNodeSize` の固定長 Children アクセス

**ファイル:** `myT-x/app_snapshot_metrics.go`  

現状安全だが、Layout ツリーの Children が将来的に可変長になった場合のリスクを注記。

---

### S-05: IMPORTANT コメント x4 がテスト担保済みで冗長

**ファイル:** `myT-x/app_snapshot_delta.go`  

`TestSnapshotFieldCounts` が自動検出するため、各関数での 3 行 IMPORTANT コメントは 1 行に縮小可能。

---

### S-06: `snapshotMetrics` 定数のドキュメント過剰

**ファイル:** `myT-x/app_snapshot_metrics.go`  

3 定数に 13 行のコメント。`snapshotPayloadSampleEvery` のサンプリング率説明は有用だが、他 2 つは名前から自明。

---

### S-07: `resolvePaneTitle` の Priority コメント二重記載

**ファイル:** `myT-x/app_status.go`  

関数 doc に 6 段階の優先度表があり、さらに関数内に `// Priority N:` インラインコメント。どちらか一方で十分。

---

### S-08: `isAllModelFrom` — 許容範囲（変更不要）

**ファイル:** `myT-x/cmd/tmux-shim/model_transform.go`  

1 行ヘルパーだが、テスト有り・概念の名前付けとして適切。変更不要。

---

### S-09: `validateTargetFlag` — 効果薄い抽出

**ファイル:** `myT-x/cmd/tmux-shim/parse.go`  

2 箇所の case 節からの 3 行関数抽出。行数削減にならず、インラインのままでも可。

---

### S-10: spec.go の `name` フィールド削除 — 良い簡素化 ✓

**ファイル:** `myT-x/cmd/tmux-shim/spec.go`  

マップキーと重複する `name` フィールドの削除は正しい簡素化。変更不要。

---

### S-11: RLock/Lock アップグレードパターン — 開発フェーズには過剰

**ファイル:** `myT-x/internal/tmux/session_manager_targets.go`  

`resolveTargetRLocked` + `resolveTargetWriteLocked` + `needsRepair` の 3 段階バブルアップは複雑。デスクトップアプリでは常に Lock で十分であり、約 100 行削減可能。パフォーマンス要件が出た段階で再導入。

---

### S-12: `copySnapshotCache` のコメント過剰

**ファイル:** `myT-x/app_snapshot_delta.go`  

4 行の関数本体に 11 行のコメント。YAGNI な将来変更への防御コメントは `TestSnapshotFieldCounts` で代替可能。

---

### S-13: `applyFromToReplacement` の空ガードに debugLog なし

**ファイル:** `myT-x/cmd/tmux-shim/command_transform.go`  

空文字列によるスキップ時にデバッグログがない。調査時に役立つ。

---

### S-14: `resolveActiveWindowSnapshot` フォールバックのログレベル

**ファイル:** `myT-x/app_snapshot_delta.go`  

フォールバック実行時のログが Debug。Info にすることで運用時の可視性向上。

---

### S-15: kill-pane の "session not found" Warn がノイズの可能性

**ファイル:** `myT-x/internal/tmux/command_router_handlers.go`  

正常なセッション終了フローで最後のペイン kill 時にセッション未発見の Warn が出力される。正常遷移では Info で十分。

---

### S-16: ConfirmDialog の focus trap に `panelRef` 依存配列欠落

**ファイル:** `myT-x/frontend/src/components/ConfirmDialog.tsx`  

React の `useEffect` 依存配列に `panelRef` が含まれていない可能性。通常 ref は安定しているため実害は低い。

---

### S-17: `activeWindowId` in tmuxStore が未使用の可能性

**ファイル:** `myT-x/frontend/src/stores/tmuxStore.ts`  

ストアに `activeWindowId` フィールドがあるが、コンポーネントからの参照が確認できない。不要であれば削除。

---

## 良い改善点（Strengths）

1. **スナップショットデルタ比較の導入** — フィールド単位の比較で不要な再描画を抑制。`TestSnapshotFieldCounts` によるフィールド数ガードも適切。
2. **snapshotEventPolicies のマップ化** — switch 文から宣言的マップへの移行で、イベント追加時の変更箇所が明確化。
3. **tmux-shim の型安全性向上** — `commandSpec` の構造化、`validateTargetFlag` の抽出。
4. **model_transform の設計** — `ModelTransformer` インターフェースと `newModelTransformer` ファクトリで、テスト容易性と拡張性を確保。
5. **フロントエンド hooks の分離** — `useTerminalSetup` / `useTerminalEvents` / `useTerminalCleanup` の責務分離。
6. **レジストリクリーンアップ** — レガシー shim のクリーンアップ処理が defensive に実装されており、エラーでアプリが停止しない。
7. **spec.go の `name` フィールド削除** — マップキーとの重複排除。

---

## タスク整理表（並列作業可否）

作業者が効率よく修正にあたれるよう、ファイル競合・依存関係を基準に並列作業可否を整理しました。

### 凡例
- **並列OK**: 他タスクと同時に別の作業者が着手可能（ファイル競合なし）
- **並列注意**: 同一ファイルを触る他タスクと同時作業は避ける
- **順序依存**: 先行タスクの完了後に着手

### グループ A: 独立タスク（全て並列OK）

| # | タスク | 対象ファイル | 重要度 | 推定規模 | 並列 |
|---|--------|-------------|--------|---------|------|
| A-1 | `DirectionalPaneDirection` にゼロ値 `DirNone` を追加 | `internal/tmux/session_manager_targets.go` | Critical | 小 | OK |
| A-2 | `CleanupLegacyShimInstalls` の戻り値修正 | `internal/install/shim_cleanup_windows.go` | Important | 小 | OK |
| A-3 | `handleLegacyMapPaneOutput` ログレベル Warn へ | `internal/tmux/command_router_handlers.go` | Important | 小 | OK |
| A-4 | `applyModelOverride` 空 model= ガード追加 | `cmd/tmux-shim/command_transform.go` | Important | 小 | OK |
| A-5 | `useTerminalSetup` 初期 ResizePane 呼び出し追加 | `frontend/src/hooks/useTerminalSetup.ts` | Important | 小 | OK |
| A-6 | テスト名 `TestApplyLayoutPresetErrorPaths` 修正 | `app_pane_api_test.go` | Test | 小 | OK |
| A-7 | テスト `TestResizePaneBoundaryValues` 境界値追加 | `app_pane_api_test.go` | Test | 中 | **A-6 と注意** |
| A-8 | テスト共有 slog バッファ独立化 | `cmd/tmux-shim/command_transform_test.go` | Test | 小 | OK |
| A-9 | `activeWindowId` 未使用確認と削除 | `frontend/src/stores/tmuxStore.ts` | Suggestion | 小 | OK |

### グループ B: 同一ファイル競合あり（グループ内は順次、グループ間は並列OK）

#### B-1: `app_events.go` 関連（2タスク — 順次作業）

| # | タスク | 重要度 | 推定規模 |
|---|--------|--------|---------|
| B-1a | `emitWorktreeCleanupFailure` ctx nil 時にログのみ | Important | 小 |
| B-1b | `snapshotEventPolicy` → `map[string]bool` 簡素化 | Suggestion | 中 |

#### B-2: `session_manager_targets.go` 関連（3タスク — C-01完了後に着手）

| # | タスク | 重要度 | 推定規模 | 順序 |
|---|--------|--------|---------|------|
| B-2a | (= A-1) `DirNone` ゼロ値追加 | Critical | 小 | **最優先** |
| B-2b | `activeWindowInSessionLocked` ログレベル Info へ | Important | 小 | B-2a 後 |
| B-2c | `ListPanesByWindowTarget` Lock→RLock 検討 | Important | 中 | B-2a 後 |

#### B-3: `app_snapshot_delta.go` 関連（2タスク — 順次作業）

| # | タスク | 重要度 | 推定規模 |
|---|--------|--------|---------|
| B-3a | IMPORTANT コメント x4 縮小 | Suggestion | 小 |
| B-3b | `copySnapshotCache` コメント縮小 | Suggestion | 小 |

### グループ C: 設計判断が必要（他タスク完了後に検討）

| # | タスク | 対象ファイル | 重要度 | 判断ポイント |
|---|--------|-------------|--------|-------------|
| C-1 | `RemoveWindowByID` 4戻り値 → 構造体化 | `session_manager_windows.go` + 呼び出し側 2箇所 | Important | 次の戻り値追加タイミングで実施する選択肢あり |
| C-2 | `requireSessionsWithPaneID` ポインタ → 戻り値パターン | `app_guards.go` + 呼び出し側 7箇所 | Suggestion | 7箇所の一括変更が必要。リファクタリング専用ブランチ推奨 |
| C-3 | RLock/Lock アップグレードパターン簡素化 | `session_manager_targets.go` 約100行 | Suggestion | パフォーマンス要件確認後に判断 |
| C-4 | `handleSelectWindow` TOCTOU ギャップ対策 | `command_router_handlers.go` | Important | デスクトップアプリでの実害リスク評価 |
| C-5 | `handleNewWindow` クローン時ペインサイズ | `command_router_handlers.go` | Important | レイアウト再計算ロジックとの整合確認 |
| C-6 | `cleanupStalePathEntries` 毎起動実行の最適化 | `shim_cleanup_windows.go` | Important | フラグファイル方式 or 初回のみ実行の設計 |

### グループ D: テスト強化（全て並列OK、既存テスト完了後に追加）

| # | タスク | 対象ファイル | 重要度 |
|---|--------|-------------|--------|
| D-1 | `TestEmitSnapshot` デルタペイロード内容検証追加 | `app_events_test.go` | Test |
| D-2 | `requireSessionsWithPaneID` TrimSpace 副作用テスト | `app_guards.go` のテスト | Test |
| D-3 | `TestCloneSessionSnapshotsIndependence` Layout ツリー再帰テスト | `app_snapshot_delta_test.go` | Test |
| D-4 | tmux-shim デバッグログ境界テスト追加 | `cmd/tmux-shim/*_test.go` | Test |
| D-5 | `TestApplyModelTransformSkipsOnLoaderError` 環境非依存化 | `cmd/tmux-shim/model_transform_test.go` | Test |

---

### 推奨作業順序

```
Phase 1（最優先・並列可）:
  ├── A-1 (Critical: DirNone)
  ├── A-2 (CleanupLegacyShimInstalls)
  ├── A-3 (ログレベル修正)
  ├── A-4 (空model=ガード)
  ├── A-5 (ResizePane初期呼出)
  └── B-1a (ctx nil ガード)

Phase 2（Phase 1 完了後・並列可）:
  ├── B-2b, B-2c (targets.go 追加修正)
  ├── B-1b (snapshotEventPolicy簡素化)
  ├── A-6, A-7 (テスト名・境界値)
  ├── A-8 (slogバッファ)
  └── A-9 (未使用フィールド削除)

Phase 3（テスト強化・全並列OK）:
  ├── D-1 〜 D-5

Phase 4（設計判断後）:
  └── C-1 〜 C-6（ユーザー判断待ち）
```

---

*Generated by parallel review agents at 2025-02-18 21:49*
