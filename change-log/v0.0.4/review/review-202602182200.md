# PR Review Summary — 2026/02/18 22:00

**対象**: `myT-x/` 配下の全変更ファイル（64ファイル, +7098/-2513行）
**レビュー方式**: 6並列エージェントによる包括レビュー

---

## レビューカテゴリ

| # | カテゴリ | 対象ファイル数 | レビュー観点 |
|---|---------|-------------|------------|
| 1 | Go App Layer | 14 | エラー処理, 並行安全性, API設計, イベントパターン |
| 2 | Internal tmux | 21 | 並行安全性, ロック順序, TOCTOU, リソース管理 |
| 3 | Shim/Config/Install | 12 | コマンド変換, パース安全性, プラットフォームコード |
| 4 | Frontend (React/TS) | 16 | Hooks, メモリリーク, 状態管理, xterm.js統合 |
| 5 | テスト品質 | 17 | カバレッジ, テストパターン, エッジケース |
| 6 | 横断的関心事 | 全体 | Backend-Frontend契約, ロック順序, IPC整合性 |

---

## Critical Issues（0件）

クリティカルなバグやセキュリティ上の問題は検出されませんでした。

---

## Important Issues（15件）

### I-01: [tmux] `handleSelectWindow` の TOCTOU — クローン経由のペインIDで `SetActivePane` を呼び出し
- **ファイル**: `internal/tmux/command_router_handlers_window.go` L280-L310
- **内容**: `GetSession()` が返すクローン上で `findWindowByID → activePaneInWindow → pane.ID` を取得し、そのIDで `SetActivePane` を呼ぶ。クローン取得と `SetActivePane` の間にwindow削除やpane入替が発生すると、削除済みIDに対して操作が実行されるレースコンディション。
- **影響**: ウィンドウ高速切替時にペインフォーカスが不正になる可能性
- **推奨**: `SetActivePaneByWindowID(sessionName, windowID)` のようなアトミック操作を導入

### I-02: [tmux] `bestEffortSendKeys` がロック外で `pane.Terminal` を読む
- **ファイル**: `internal/tmux/command_router.go` L164-L204
- **内容**: `ResolveTarget` が返すライブポインタから直接 `pane.Terminal` を参照。`handleNewSession`, `splitWindowResolved`, `handleNewWindow` から呼ばれる。作成直後のpaneなので実際には安全だが、安全性がコード構造ではなく暗黙の前提に依存。
- **推奨**: docコメントに「呼び出し元は pane.Terminal のセットアップ完了を保証すること」という前提条件を明記

### I-03: [tmux] `splitWindowResolved` が `target.Window.Session` をロック外でデリファレンス
- **ファイル**: `internal/tmux/command_router_handlers_pane.go` L37-L39
- **内容**: `ResolveTarget` 後のライブポインタから複数フィールドを参照。kill-pane が並行実行されると nil pointer dereference のリスク。
- **推奨**: 冒頭で即座に snapshot を取り、以降は snapshot のみ参照する形に統一

### I-04: [tmux] `handleListWindows` のデフォルトセッション解決で live pointer 経由のフィールドアクセス
- **ファイル**: `internal/tmux/command_router_handlers_window.go` L144-L154
- **内容**: `ResolveTarget` のライブポインタから `Window.Session.Name` を辿る。kill-session 並行実行時に不正参照。
- **推奨**: `GetPaneContextSnapshot` から `SessionName` を取得するパスに変更

### I-05: [tmux] `handleResizePane` がライブポインタの `target.Width`/`target.Height` をデフォルト値として使用
- **ファイル**: `internal/tmux/command_router_handlers_pane.go` L299-L300
- **内容**: ロック外のライブポインタから int 値を読取。Go のメモリモデル上はデータレースに該当。
- **推奨**: snapshot 経由で値を取得、または `ResizePane` 内でフラグ未指定時の処理を行う

### I-06: [tmux] `handleSendKeys` でのライブポインタ `target.Terminal` アクセス
- **ファイル**: `internal/tmux/command_router_handlers_pane.go` L188-L192
- **内容**: `ResolveTarget` 後にロック外で `target.Terminal` を読み書き。kill-pane 並行実行時に nil pointer dereference のリスク。
- **推奨**: `WriteToPaneByTarget` のようなアトミック操作を検討、またはリスクの acknowledged をドキュメント化

### I-07: [tmux] `KillPane` 後の `pane.Terminal.Close()` 未呼び出し — Terminal リーク
- **ファイル**: `internal/tmux/command_router_handlers_pane.go` (`handleKillPane`)
- **内容**: `KillPane` は pane をマップから削除するが Terminal.Close() を呼ばない。`handleKillPane` 側でも Close を呼んでいない。`handleKillWindow` は明示的に Close する設計と不整合。
- **推奨**: `handleKillPane` に Terminal.Close() を追加するか、`KillPane` の戻り値に removed pane を含める

### I-08: [tmux] `Snapshot()` の RLock 内で `cloneSessionSnapshots` を実行
- **ファイル**: `internal/tmux/session_manager_snapshot.go` L11-L27
- **内容**: RLock 保持中にクローンコストが読み取りロック保持時間を増大。COW パターンのためロック外でクローン可能。
- **推奨**: RLock 内ではキャッシュ参照のみ保持し、ロック解放後にクローン

### I-09: [app] `requireSessionsWithPaneID` の `*string` ポインタ引数 — 暗黙的な副作用
- **ファイル**: `myT-x/app_guards.go` L31-L37
- **内容**: `paneID *string` を受け取り呼び出し元の変数を直接変更。Go では文字列ポインタの in-place 変更は珍しいパターンで副作用が不明瞭。nil pointer dereference のリスクもある（現在の呼び出し元は安全）。
- **推奨**: nil ガード追加、または doc comment で nil 非許容を明示

### I-10: [frontend] `useTerminalEvents.ts` — Post-cleanup イベント配信で disposed terminal に書き込む可能性
- **ファイル**: `frontend/src/hooks/useTerminalEvents.ts` L148-L155
- **内容**: `enqueuePendingWrite` に `disposed` ガードがない。Wails イベントがクリーンアップ後に配信されると、disposed な Terminal に `term.write()` が呼ばれる。
- **推奨**: `enqueuePendingWrite` 冒頭に `if (disposed) return;` を追加

### I-11: [frontend] `TerminalPane.tsx` — `searchAddonRef.current` が stale/null の可能性
- **ファイル**: `frontend/src/components/TerminalPane.tsx` L140-L142
- **内容**: `searchAddon={searchAddonRef.current}` はレンダー時点の値を渡す。setup hook の effect 完了前だと null。`safeAddonOp` の null check で緩和されているが構造的に脆弱。
- **推奨**: state ベースのアプローチ（`setSearchAddon(addon)`）でリレンダーを保証

### I-12: [cross-cutting] `SessionSnapshotDelta.removed` が session names を含むことのドキュメント不足
- **ファイル**: `myT-x/app_snapshot_delta.go`, `frontend/src/types/tmux.ts`
- **内容**: `removed` フィールドが session ID ではなく session name を含む。型名からは判別困難で、型ドリフトリスクがある。
- **推奨**: フィールド名を `removedSessionNames` にするか、コメントで明記

### I-13: [cross-cutting] `snapshotMu` が `shouldSyncPaneStates` で `snapshotDeltaMu` 外で独立取得
- **ファイル**: `myT-x/app_snapshot_delta.go`
- **内容**: `snapshotDeltaMu → snapshotMu` のロック順序がドキュメント化されているが、`shouldSyncPaneStates` では `snapshotMu` が単独で取得される。ロック順序コメントに未記載。
- **推奨**: ロック順序ドキュメントに単独取得パスも記載

### I-14: [shim] `model_transform.go` — `matchAll` + override miss で冗長なダブルスキャン
- **ファイル**: `cmd/tmux-shim/model_transform.go` L162-L165
- **内容**: `findOverrideModel` が OK だが `applyModelOverride` が失敗した場合、`matchAll` ブロックで再度全引数をスキャン。正しさに問題はないが冗長。
- **推奨**: 早期に`--model`フラグの有無を判定してスキャンを1回に最適化

### I-15: [test] `applyNewProcessTransform` と `applySendKeysTransform` のテスト欠如
- **ファイル**: `cmd/tmux-shim/command_transform.go`
- **内容**: shim の主要変換関数にテストがない。カバレッジの穴が大きい。
- **推奨**: テーブル駆動テストで正常系・異常系を網羅

---

## Suggestions（20件）

### S-01: [app] `snapshotEventPolicies` の `trigger` フィールド — 全て `true` で冗長
- **ファイル**: `myT-x/app_events.go` L123-L134
- **内容**: 全10エントリが `trigger: true`。マップ存在有無で判定可能。
- **推奨**: `trigger` フィールド削除検討、または `trigger: false` のユースケースをコメントで明示

### S-02: [app] `handleLegacyMapPaneOutput` の TODO トラッキング
- **ファイル**: `myT-x/app_events.go` L88
- **推奨**: TODO を Issue 化して追跡

### S-03: [app] `paneOutputEventFromPayload` の型スイッチ — 値型/ポインタ型の両方を受け入れる理由のコメント
- **ファイル**: `myT-x/app_events.go` L148-L160

### S-04: [app] `SplitPane` の NOTE コメントの正確性向上
- **ファイル**: `myT-x/app_pane_api.go` L12-L14

### S-05: [tmux] `resolveDirectionalPane` — 将来の2次元レイアウト対応の TODO コメント追加
- **ファイル**: `internal/tmux/command_router_handlers_display.go` L47-L56

### S-06: [tmux] `cloneSessionForRead` の nil window/pane フィルタリング — invariant assertion 検討
- **ファイル**: `internal/tmux/session_manager_sessions.go` L226-L260

### S-07: [tmux] `handleAttachSession` のコメント矛盾修正
- **ファイル**: `internal/tmux/command_router_handlers_session.go` L201-L203

### S-08: [tmux] テストカバレッジ — `handleAttachSession` / `handleShowEnvironment` / `handleSetEnvironment` のテスト追加
- **ファイル**: `internal/tmux/command_router_handlers_session.go`

### S-09: [tmux] format string のデフォルト値を定数化
- **ファイル**: 各 `handleListXxx` ハンドラ

### S-10: [shim] `stalePathSubstring` のテスト関数名依存をコメントで文書化
- **ファイル**: `internal/install/shim_cleanup_windows.go` L22

### S-11: [shim] `strings.ToLower(stalePathSubstring)` のループ外事前計算
- **ファイル**: `internal/install/shim_cleanup_windows.go` L190

### S-12: [shim] `resetModelConfigCache` エイリアスの削除検討
- **ファイル**: `cmd/tmux-shim/model_transform_test.go` L703-L706

### S-13: [shim] `resize-pane` spec に `-a` (adjustment) フラグ追加検討
- **ファイル**: `cmd/tmux-shim/spec.go` L118

### S-14: [frontend] `useBackendSync.ts` — `BackendEventMap` のペイロード型を具体化
- **ファイル**: `frontend/src/hooks/useBackendSync.ts` L14-L27
- **推奨**: 高頻度ペイロード（snapshot, config:updated 等）に型を付与して `asObject<>` キャストを排除

### S-15: [frontend] `ConfirmDialog.tsx` — Escape ハンドラに `e.stopPropagation()` 追加
- **ファイル**: `frontend/src/components/ConfirmDialog.tsx` L26-L29

### S-16: [frontend] `useTerminalEvents.ts` — eslint-disable コメントに除外 deps を全て列挙
- **ファイル**: `frontend/src/hooks/useTerminalEvents.ts` L169

### S-17: [frontend] `useTerminalFontSize.ts` — deps 配列から安定 ref を除去
- **ファイル**: `frontend/src/hooks/useTerminalFontSize.ts` L72-L80

### S-18: [frontend] `usePrefixKeyMode.ts` — `currentIndex === -1` 時の挙動コメント追加
- **ファイル**: `frontend/src/hooks/usePrefixKeyMode.ts` L106-L116

### S-19: [frontend] `SearchBar.tsx` — インデント 2スペースをプロジェクト規約(4スペース)に統一
- **ファイル**: `frontend/src/components/SearchBar.tsx`

### S-20: [test] パッケージレベル変数モッキングにより `t.Parallel()` 不可の箇所がある
- **ファイル**: 複数テストファイル
- **推奨**: DI パターンへの移行検討

---

## Missing Test Coverage

| # | ファイル | 関数/パス | 内容 |
|---|---------|----------|------|
| M-01 | `cmd/tmux-shim/command_transform.go` | `applyNewProcessTransform` | 主要変換関数のテスト欠如 |
| M-02 | `cmd/tmux-shim/command_transform.go` | `applySendKeysTransform` | 主要変換関数のテスト欠如 |
| M-03 | `internal/tmux/command_router_handlers_session.go` | `handleAttachSession` | session ハンドラのテスト未確認 |
| M-04 | `internal/tmux/command_router_handlers_session.go` | `handleShowEnvironment` | `-g` フラグパスのテスト |
| M-05 | `internal/tmux/command_router_handlers_session.go` | `handleSetEnvironment` | `-g` フラグパスのテスト |
| M-06 | `internal/tmux/session_manager_snapshot.go` | `copySnapshotCache` | 独立性テスト |
| M-07 | `myT-x/app_session_api.go` | `DetachSession` | 正常パステスト |
| M-08 | `cmd/tmux-shim/parse.go` | バリデーション | 境界値テスト |

---

## Strengths（好評点）

### アーキテクチャ・設計
- **TOCTOU修正**: `ApplyLayoutPreset` → `ApplyLayoutPresetToActiveWindow` のアトミック操作化。ウィンドウ破棄とのレース条件を構造的に排除
- **`snapshotEventPolicies` データ駆動リファクタ**: switch文からマップベースへ。新イベント追加が1行で済む保守性向上
- **`requireSessionsWithPaneID` DRY化**: 6つのpane APIから共通パターンを抽出
- **ジェネレーションベースキャッシュ**: `generation` / `topologyGeneration` / `snapshotGeneration` の3層管理で不要な再構築を回避
- **ロック順序ドキュメント**: `snapshotDeltaMu → snapshotMu` の明確な文書化

### フロントエンド
- **Hook分離が優秀**: `useTerminalSetup`, `useTerminalEvents`, `useTerminalResize`, `useTerminalFontSize` の単一責任分割
- **Zustand活用**: `useTmuxStore.getState()` によるstale closure回避パターン
- **メモリリーク防止**: 全 `useEffect` に包括的 cleanup。EventsOn cancel を個別管理
- **`useWindowRename` 二重発火ガード**: `inflightWindowIdRef` + microtask reset パターン
- **Promise.allSettled による初期化**: 非決定的状態書き込みを排除

### テスト
- **テーブル駆動テストの徹底**: 全テストファイルで一貫したパターン
- **structフィールドカウントガード**: struct変更時の更新漏れを自動検出
- **パストラバーサル・symlink escape テスト**: セキュリティ観点の防御テストが充実
- **ロールバック検証**: コピーエラー時のロールバック動作テスト

### Shim
- **変換失敗時の原文転送**: spec準拠の堅牢な設計
- **"ALL" ワイルドカード設計**: override優先度が正確に維持
- **set-environment 空VALUE修正**: `set-environment KEY ""` を正しく許可
- **レガシーPATHクリーンアップ**: allowlist + 境界チェック + 冪等性

---

## タスク修正の並列作業可否一覧

以下の表は、各指摘事項を修正する際に**他のタスクと並列で作業できるか**を示します。

### 凡例
- **✅ 並列OK**: 他のタスクと独立して修正可能。別ファイル・別モジュールのため競合なし
- **⚠️ 条件付き並列**: 同一ファイルの別箇所を触るため、マージ時に注意が必要
- **❌ 順序依存**: 先行タスクの完了を待つ必要がある

| ID | 概要 | 対象ファイル/モジュール | 修正規模 | 並列可否 | 依存関係・注意事項 |
|----|------|----------------------|---------|---------|------------------|
| **I-01** | `handleSelectWindow` TOCTOU修正 | `command_router_handlers_window.go`, `session_manager` | 中 | ⚠️ | I-04と同ファイル。SessionManagerに新メソッド追加が必要 |
| **I-02** | `bestEffortSendKeys` docコメント追加 | `command_router.go` | 小 | ✅ | コメント追加のみ、他タスクと競合なし |
| **I-03** | `splitWindowResolved` snapshot化 | `command_router_handlers_pane.go` | 中 | ⚠️ | I-05, I-06と同ファイル。snapshot取得パターンの統一が望ましい |
| **I-04** | `handleListWindows` snapshot化 | `command_router_handlers_window.go` | 中 | ⚠️ | I-01と同ファイル |
| **I-05** | `handleResizePane` snapshot化 | `command_router_handlers_pane.go` | 中 | ⚠️ | I-03, I-06と同ファイル |
| **I-06** | `handleSendKeys` アトミック化 | `command_router_handlers_pane.go` | 中 | ⚠️ | I-03, I-05と同ファイル |
| **I-07** | `KillPane` Terminal.Close() 追加 | `command_router_handlers_pane.go` | 小 | ⚠️ | I-03, I-05, I-06と同ファイル |
| **I-08** | `Snapshot()` RLock最適化 | `session_manager_snapshot.go` | 小 | ✅ | 独立ファイル |
| **I-09** | `requireSessionsWithPaneID` nilガード | `app_guards.go` | 小 | ✅ | 独立ファイル |
| **I-10** | `enqueuePendingWrite` disposedガード | `useTerminalEvents.ts` | 小 | ✅ | フロントエンド独立 |
| **I-11** | `searchAddon` state化 | `TerminalPane.tsx`, `useTerminalSetup.ts` | 中 | ✅ | バックエンドと独立 |
| **I-12** | `removed` フィールド名/コメント明確化 | `app_snapshot_delta.go`, `tmux.ts` | 小 | ✅ | 型名変更はFE/BE同時に行う |
| **I-13** | ロック順序ドキュメント更新 | `app_snapshot_delta.go` | 小 | ⚠️ | I-12と同ファイル |
| **I-14** | model_transform ダブルスキャン最適化 | `model_transform.go` | 小 | ✅ | 独立ファイル |
| **I-15** | command_transform テスト追加 | `command_transform_test.go` | 中 | ✅ | テストファイル新規作成/追記 |

### 推奨作業グループ（並列実行可能な単位）

| グループ | タスク | 作業者 | 備考 |
|---------|--------|--------|------|
| **A: tmux ハンドラ統一修正** | I-01, I-03, I-04, I-05, I-06, I-07 | 1名 | 同一ファイル群を触るため1名で実施が安全。snapshot化パターンの統一がゴール |
| **B: tmux 基盤改善** | I-02, I-08 | 1名 | Aと別ファイル。独立して実施可能 |
| **C: App層修正** | I-09, I-12, I-13 | 1名 | `app_guards.go` と `app_snapshot_delta.go` が対象 |
| **D: フロントエンド修正** | I-10, I-11 | 1名 | バックエンドと完全独立 |
| **E: Shim改善** | I-14, I-15 | 1名 | 独立モジュール |

**グループ A〜E は全て並列実行可能です。**

### Suggestions の並列作業可否

| ID | 概要 | 並列可否 | 備考 |
|----|------|---------|------|
| S-01〜S-04 | App層のコメント/設計改善 | ✅ | I-09完了後が望ましいが独立可 |
| S-05〜S-09 | tmux層の改善 | ⚠️ | グループA完了後に実施推奨 |
| S-10〜S-13 | Shim改善 | ✅ | グループEと同時可能 |
| S-14〜S-19 | フロントエンド改善 | ✅ | グループDと同時可能 |
| S-20 | テスト並列化改善 | ✅ | 独立して実施可能 |
| M-01〜M-08 | テストカバレッジ追加 | ✅ | 全て独立して並列実施可能 |

---

## Recommended Action（推奨アクション）

1. **まず Important Issues (I-01〜I-15) を修正** — 5グループに分けて並列実施可能
2. **Missing Test Coverage (M-01〜M-08) を追加** — 全て独立して並列実施可能
3. **Suggestions は優先度を判断して適宜対応** — S-14（型安全性向上）は早期対応推奨
4. **修正後にレビューを再実行して検証**
