# PR Review Summary — 2026-02-18 23:09:00

## 概要

| 項目 | 値 |
|------|-----|
| 対象 | `myT-x/` 配下の未コミット変更 |
| 変更ファイル数 | 66 |
| 差分行数 | +7,285 / -2,535 (約12,000行) |
| レビュー方式 | 6カテゴリ並列レビュー |

### カテゴリ分類

| # | カテゴリ | ファイル数 | 差分量 |
|---|---------|----------|--------|
| 1 | App層実装 (app*.go) | 9 | ~54KB |
| 2 | App層テスト (app_*_test.go) | 5 | ~54KB |
| 3 | tmux-shim (cmd/tmux-shim/) | 8 | ~89KB |
| 4 | internal/tmux | 22 | ~250KB |
| 5 | フロントエンド (frontend/src/) | 16 | ~382KB |
| 6 | internal/config + install + ipc | 5 | ~35KB |

---

## Critical Issues (1件)

### C-1: [internal/tmux] `handleKillPane` における Terminal の二重 Close
- **ファイル**: `internal/tmux/command_router_handlers_pane.go:260-282`
- **深刻度**: Critical（リソースリーク・パニックの可能性）
- **説明**: `handleKillPane` で `terminal := target.Terminal` をキャプチャした後に `r.sessions.KillPane(paneID)` を呼んでいるが、`KillPane` 内部で既にターミナルを Close している。`killPaneLocked` で `pane.Terminal` を `closeTargets` に追加し nil にセットした後、`KillPane` が `closeTargets` を全て Close する。その後 `handleKillPane` がキャプチャした同一 Terminal オブジェクトに対して再度 `Close()` を呼ぶため、ConPTY の `Close()` が冪等でない場合にリソースリークまたはパニックの原因となる。
- **修正案**: `handleKillPane` での `terminal.Close()` を削除し、`KillPane` が既にロック外でのClose を担当していることに統一する。

---

## Important Issues (10件)

### I-1: [App層] `handleLegacyMapPaneOutput` でデバッグログが二重出力される
- **ファイル**: `app_events.go:100-110`
- **説明**: `chunk == nil && rawData != nil` の場合に「unsupported data field type」のログを出した後、そのまま次の `if paneID == "" || len(chunk) == 0` の条件にも該当し「skip empty pane-output payload」ログも出力される。1つのイベントに対してデバッグログが2回出力されノイズになる。
- **修正案**: 型ミスマッチのログ後に `return` で早期リターンする。

### I-2: [internal/tmux] `cloneSessionForRead` で `idString` フィールドが未コピー
- **ファイル**: `internal/tmux/session_manager_sessions.go:180-192`
- **説明**: ペインの手動コピー時に `idString` が列挙されていない。`IDString()` はフォールバックで `fmt.Sprintf("%%%d", p.ID)` を返すため機能上は問題ないが、`GetSession`/`ListSessions`/`Snapshot` 等の高頻度パスでクローンされるペインに対して不要なアロケーションが毎回発生する。`copyPaneSlice` は struct copy で `idString` は自動コピーされるため、一貫性もない。
- **修正案**: `paneCopy` に `idString: pane.idString` を追加する。

### I-3: [internal/tmux] `ResolveDirectionalPane` の境界動作が tmux と異なる
- **ファイル**: `internal/tmux/session_manager_targets.go:232-240`
- **説明**: 境界に達した際にクランプ（同じペインに留まる）しているが、実tmuxの `select-pane -U/-D/-L/-R` はラップアラウンド動作をする。意図的な設計か確認が必要。
- **修正案**: tmux互換を目指す場合はラップアラウンドに変更。意図的なら設計メモをコメントに追記。

### I-4: [internal/tmux] `handleResizePane` での `target.Width`/`target.Height` のロック外読み取り
- **ファイル**: `internal/tmux/command_router_handlers_pane.go:295-297`
- **説明**: コメントで「Stale reads are acceptable」と説明されているが、Go のメモリモデル上、ロック外読み取りは技術的にはデータレースとなる。現実的には int 値の読み取りなので壊れないが、注意が必要。

### I-5: [tmux-shim] `applyModelOverride` で override マッチ + `--model`フラグ無しの tokenized テストが不足
- **ファイル**: `cmd/tmux-shim/model_transform.go:158-165`
- **説明**: tokenized形式（`args` が複数要素）で override が見つかる + `--model` フラグ無しのテストケースがない。
- **修正案**: `TestApplyModelTransformOverrideAndFallback` にケース追加。

### I-6: [フロントエンド] `useTerminalResize` — IME composition 中の保留リサイズがフラッシュされない
- **ファイル**: `frontend/src/hooks/useTerminalResize.ts:60-78`
- **説明**: `scheduleResize()` が `isComposingRef.current === true` の時に呼ばれると `pendingResize = true` を設定してタイマーを起動せずに早期リターンする。composition 終了後に新たな ResizeObserver イベントが発火しなければ、保留されたリサイズは永久にフラッシュされない。
- **修正案**: `useTerminalEvents` の `finishComposition()` でコールバックを呼ぶか、composition 終了時のフラッシュ機構を追加する。

### I-7: [フロントエンド] `BackendEventMap` の全ペイロード型が `unknown` のまま
- **ファイル**: `frontend/src/hooks/useBackendSync.ts:13-26`
- **説明**: `onEvent<K>` のジェネリック型パラメータによりイベント名のタイポは防げるが、ペイロードは実質 `unknown` 。型安全なイベント登録の意図が完全には達成されていない。
- **修正案**: 高頻度イベントから段階的に具体的なペイロード型を定義していく。

### I-8: [フロントエンド] `useWindowRename.commitWindowRename` が頻繁に再生成される
- **ファイル**: `frontend/src/hooks/useWindowRename.ts:97-133`
- **説明**: `renamingWindowId` が依存配列に含まれ、rename 開始→完了のたびに `null ↔ number` と変化し `commitWindowRename` が毎回再生成される。`inflightWindowIdRef` ガードがあるため実害は防がれているが、Guard 1 のクロージャが古い値をキャプチャしうる。
- **修正案**: `renamingWindowId` を deps から外して ref で管理するか、Guard 1 を `inflightWindowIdRef` のみに統合する。

### I-9: [internal/install] `filterPathEntries` に空文字列 `removeDir` が渡された場合の防御がない
- **ファイル**: `internal/install/shim_cleanup_windows.go:100-112`
- **説明**: `filepath.Clean("")` は Go で `"."` を返すため、空文字列が渡された場合 PATH 内の `.` エントリが意図せず削除される可能性がある。現在のコールサイトでは安全だが、将来の呼び出し元に備えて早期リターンを追加すべき。
- **修正案**: `normalizedRemove == "."` の場合に `return pathValue` で早期リターン。

### I-10: [internal/install] `cleanupStalePathEntries` がプロセスPATHをクリーンアップしない
- **ファイル**: `internal/install/shim_cleanup_windows.go:165-215`
- **説明**: legacy エントリについてはレジストリとプロセスPATH両方を更新するが、`cleanupStalePathEntries` はレジストリのみ更新し、プロセスPATH から stale エントリを除去しない。一貫性のためプロセスPATHも同様にフィルタリングすべき。

---

## Suggestions (20件)

### App層実装

| # | ファイル | 提案 |
|---|---------|------|
| S-1 | `app_events.go:69-78` | typed `PaneOutputEvent` パスにも empty payload のデバッグログを追加（legacy パスとの一貫性） |
| S-2 | `app_pane_feed.go:63` | `startPaneFeedWorker` にリトライ上限を追加（`startIdleMonitor` と同じ `maxPanicRestartRetries` パターン）|
| S-3 | `app_guards.go:26-31` | `requireSessionsWithPaneID` のポインタ引数パターンを3値リターンパターンに変更検討（現状でも実用上問題なし）|
| S-4 | `app_snapshot_metrics.go:75` | `estimateSessionSnapshotSize` の固定オーバーヘッド103のマジックナンバーを分解・テスト検証 |
| S-5 | `app_status.go:74-78` | `resolveActiveWindowSnapshot` のフォールバックログで `windows[0].ID` アクセスとreturnの距離に注意 |

### App層テスト

| # | ファイル | 提案 |
|---|---------|------|
| S-6 | `app_helpers.go` | `toString()`/`toBytes()` ヘルパーの専用テーブル駆動テスト追加 |
| S-7 | `app_pane_api_test.go:645-681` | `TestResizePaneBoundaryValues` に実ペイン存在時の境界値テスト追加 |
| S-8 | `app_events_test.go:699` | `TestEmitSnapshot` のテーブル駆動部で `tt.name` 文字列の一致比較を `wantPayloadCheck` フィールドに変更 |
| S-9 | `app_lifecycle_test.go:447-458` | `configureGlobalHotkey` の正常系テスト追加 |

### tmux-shim

| # | ファイル | 提案 |
|---|---------|------|
| S-10 | `cmd/tmux-shim/model_transform.go:200-207` | `applyModelOverride` の `isLikelyOptionToken` スキップパスにデバッグログ追加 |
| S-11 | `cmd/tmux-shim/command_transform.go:35-41` | `applyNewProcessTransform` の nil map 初期化が `applyShellTransform` と重複 — コメントで意図を明示 |
| S-12 | `cmd/tmux-shim/main.go:150-151` | コメント中の文字化け `窶・` を ASCII に修正 (`-- handled below.`) |
| S-13 | `cmd/tmux-shim/model_transform.go:174` | `applyFromToReplacement` にも `applyModelOverride` と同様の empty value ガードの対称性を検討 |

### internal/tmux

| # | ファイル | 提案 |
|---|---------|------|
| S-14 | `internal/tmux/command_router.go:165-166` | `bestEffortSendKeys` の `pane.Terminal` ロック外読み取りに safety note コメント追加 |
| S-15 | `internal/tmux/session_manager_windows.go:114-118` | `removeWindowAtIndexLocked` の `removedPanes` 初期化の重複を整理 |
| S-16 | `internal/tmux/session_manager_snapshot.go:9-16` | `Snapshot()` の `RUnlock` を defer パターンに変更 |

### フロントエンド

| # | ファイル | 提案 |
|---|---------|------|
| S-17 | `frontend/src/hooks/useTerminalFontSize.ts:97` | 第2 useEffect の依存配列から不要な ref を除去し `[fontSize, paneId]` のみに |
| S-18 | `frontend/src/hooks/useWindowRename.ts:80-89` | `getRenameInputRef` の `useCallback` が内側関数の安定化に寄与しない点をコメント明記 |
| S-19 | `frontend/src/styles/layout.css` | `.window-tab-close:focus-within` を `:focus-visible` に変更（キーボードアクセシビリティ） |

### internal/config + install + ipc

| # | ファイル | 提案 |
|---|---------|------|
| S-20 | `internal/config/config_test.go` | `TestLoadAgentModel` に "ALL" ワイルドカードの Load 統合テストケース追加 |

---

## Positive Observations（良い点）

### 設計・アーキテクチャ
- **`snapshotEventPolicies` によるデータ駆動設計** (app_events.go) — switch文の重複 case リストから struct マップに移行。Open-Closed原則に沿った優れたリファクタリング。
- **`requireSessionsWithPaneID` によるボイラープレート統合** (app_guards.go) — 7つの pane API メソッドで繰り返された3行パターンを1つのヘルパーに集約し約40行削減。
- **ロック順序の体系的ドキュメント** (app.go) — `snapshotDeltaMu -> snapshotMu` の依存関係を明示的な順序付けで文書化。
- **TerminalPane のフック分解** (frontend) — 662行→298行に縮減。4つのカスタムフックへの分解は単一責任原則を徹底。
- **resolveSessionState ヘルパーの抽出** (tmuxStore.ts) — 重複ロジックを共通化しバグの温床を排除。

### 安全性・堅牢性
- **TOCTOU修正の品質が高い** — `ApplyLayoutPresetToActiveWindow` のアトミック化、`ResolveDirectionalPane` のsingle-lock化、`RemoveWindowByID` の `survivingWindowID` アトミック返却。
- **`snapshotDelta` の防御的再チェック** — shutdown/test teardown による `snapshotPrimed` リセットを検知しフルスナップショットにフォールバック。
- **shim の `runTransformSafe`** — shell/model 双方の transform に対して統一的な panic recovery + request rollback。
- **二重呼び出しガード** (useWindowRename) — `inflightWindowIdRef` による Enter + onBlur 競合防止。Promise microtask 排出後のリセットが巧妙。

### テスト品質
- **テーブル駆動テストの徹底的な活用** — 全カテゴリで一貫して Go 慣用パターンが適用。
- **構造体フィールド数ガードテスト** — struct にフィールドが追加された際にテスト更新を強制する仕組み。
- **スナップショットポリシー整合性テスト** — `bypassDebounce=true && trigger=false` という矛盾した設定を自動検出する invariant テスト。
- **セキュリティテスト** — パストラバーサル攻撃パターン検証、symlink検証、ファイル数/サイズ上限テスト。
- **EventsOn cancel パターンの採用** (frontend) — 同名イベントの他リスナーを巻き込まない安全な解除。

---

## テストカバレッジギャップ

| 対象 | カバレッジ状態 | 優先度 |
|------|-------------|--------|
| `handleKillPane` Terminal 二重Close | テストなし — mock Terminal で Close 呼び出し回数を検証すべき | **高** |
| `bestEffortSendKeys` | 間接テストのみ — nil pane/terminal の直接テスト推奨 | 中 |
| `buildPaneEnv` | 間接テストのみ — blocked key フィルタリングの直接テスト推奨 | 中 |
| `ResizePane` 実ペイン + 境界値 | ペインなしでの非パニック確認のみ | 中 |
| `toString()` / `toBytes()` 全分岐 | 間接テストのみ、専用テストなし | 低 |
| `configureGlobalHotkey` 正常系 | テストなし（OS依存の可能性） | 低 |
| `cleanupStalePathEntries` 直接テスト | 間接テストのみ | 低 |
| `ensureOutputFlusher` 並行呼び出し | テストなし | 低 |
| tokenized override + no --model flag | テストケース不足 | 低 |

---

## タスク一覧と並列作業可否

以下は、指摘された問題の修正タスク一覧です。各タスクの独立性を分析し、並列作業の可否を示します。

### 凡例
- **並列OK**: 他のタスクと同時に修正可能（ファイルが異なる or 同一ファイルでも変更箇所が独立）
- **並列注意**: 同一ファイルの近接箇所を変更するため、マージ時に競合の可能性あり
- **順序あり**: 先行タスクの完了を待つ必要がある

### Critical / Important タスク

| タスクID | 重要度 | カテゴリ | 対象ファイル | 修正内容 | 並列作業 | 備考 |
|---------|--------|---------|------------|---------|---------|------|
| T-C1 | Critical | internal/tmux | `command_router_handlers_pane.go` | `handleKillPane` の Terminal 二重 Close 除去 | **並列OK** | 単独ファイルの数行変更 |
| T-I1 | Important | App層 | `app_events.go` | `handleLegacyMapPaneOutput` のログ二重出力修正（早期return追加） | **並列OK** | 単独ファイルの数行変更 |
| T-I2 | Important | internal/tmux | `session_manager_sessions.go` | `cloneSessionForRead` に `idString` フィールド追加 | **並列OK** | 単独ファイルの1行追加 |
| T-I3 | Important | internal/tmux | `session_manager_targets.go` | `ResolveDirectionalPane` の境界動作確認・コメント追記 | **並列OK** | 設計判断が必要 — ラップアラウンドにするか確認 |
| T-I4 | Important | internal/tmux | `command_router_handlers_pane.go` | `handleResizePane` ロック外読み取りの安全性コメント追加 | **並列注意** | T-C1 と同一ファイル — 変更箇所は離れているが注意 |
| T-I5 | Important | tmux-shim | `model_transform_test.go` | tokenized override + no --model flag テストケース追加 | **並列OK** | テストファイルのみ |
| T-I6 | Important | フロントエンド | `useTerminalResize.ts` | IME composition 終了後のリサイズフラッシュ機構追加 | **並列注意** | `useTerminalEvents.ts` にもコールバック追加が必要 |
| T-I7 | Important | フロントエンド | `useBackendSync.ts` | `BackendEventMap` の型をunknownから具体型に段階的に変更 | **並列OK** | 単独ファイルの型定義変更 |
| T-I8 | Important | フロントエンド | `useWindowRename.ts` | `commitWindowRename` の依存配列最適化 | **並列OK** | 単独ファイル |
| T-I9 | Important | internal/install | `shim_cleanup_windows.go` | `filterPathEntries` の空文字列防御追加 | **並列注意** | T-I10 と同一ファイル |
| T-I10 | Important | internal/install | `shim_cleanup_windows.go` | `cleanupStalePathEntries` にプロセスPATHクリーンアップ追加 | **並列注意** | T-I9 と同一ファイル |

### Suggestion タスク

| タスクID | カテゴリ | 対象ファイル | 修正内容 | 並列作業 | 備考 |
|---------|---------|------------|---------|---------|------|
| T-S1 | App層 | `app_events.go` | typed パスに empty payload のデバッグログ追加 | **並列注意** | T-I1 と同一ファイル |
| T-S2 | App層 | `app_pane_feed.go` | リトライ上限追加 | **並列OK** | 単独ファイル |
| T-S3 | App層 | `app_snapshot_metrics.go` | マジックナンバー103の分解 | **並列OK** | 単独ファイル |
| T-S4 | App層テスト | `app_helpers_test.go`（新規） | `toString`/`toBytes` 専用テスト作成 | **並列OK** | 新規ファイル |
| T-S5 | App層テスト | `app_pane_api_test.go` | 実ペイン境界値テスト追加 | **並列OK** | 単独ファイル |
| T-S6 | App層テスト | `app_events_test.go` | テーブル内 `tt.name` 比較をフィールドに変更 | **並列OK** | 単独ファイル |
| T-S7 | App層テスト | `app_lifecycle_test.go` | `configureGlobalHotkey` 正常系テスト | **並列OK** | 単独ファイル |
| T-S8 | tmux-shim | `model_transform.go` | `isLikelyOptionToken` スキップパスにデバッグログ追加 | **並列OK** | 単独ファイル |
| T-S9 | tmux-shim | `command_transform.go` | nil map 初期化重複のコメント追加 | **並列OK** | 単独ファイル |
| T-S10 | tmux-shim | `main.go` | コメント文字化け修正 | **並列OK** | 単独ファイル |
| T-S11 | internal/tmux | `command_router.go` | `bestEffortSendKeys` safety note コメント追加 | **並列OK** | 単独ファイル |
| T-S12 | internal/tmux | `session_manager_windows.go` | `removedPanes` 初期化の重複整理 | **並列OK** | 単独ファイル |
| T-S13 | internal/tmux | `session_manager_snapshot.go` | `Snapshot()` の defer パターン変更 | **並列OK** | 単独ファイル |
| T-S14 | フロントエンド | `useTerminalFontSize.ts` | useEffect 依存配列から不要 ref 除去 | **並列OK** | 単独ファイル |
| T-S15 | フロントエンド | `useWindowRename.ts` | `getRenameInputRef` コメント追加 | **並列注意** | T-I8 と同一ファイル |
| T-S16 | フロントエンド | `layout.css` | `:focus-within` → `:focus-visible` 変更 | **並列OK** | 単独ファイル |
| T-S17 | internal/config | `config_test.go` | "ALL" ワイルドカード統合テストケース追加 | **並列OK** | 単独ファイル |

### 並列作業グルーピング（推奨バッチ）

効率的な並列修正のため、以下のグループに分けて同時作業が可能です。

#### バッチ1: Critical + 独立 Important （最優先）
同時作業可能な独立タスク群:

| 作業者 | タスク | 対象 |
|--------|-------|------|
| A | T-C1 + T-I4 | `command_router_handlers_pane.go`（同一ファイルだが箇所は離れている） |
| B | T-I1 + T-S1 | `app_events.go`（同一ファイル — まとめて修正） |
| C | T-I2 | `session_manager_sessions.go` |
| D | T-I5 | `model_transform_test.go` |
| E | T-I9 + T-I10 | `shim_cleanup_windows.go`（同一ファイル — まとめて修正） |

#### バッチ2: フロントエンド Important
| 作業者 | タスク | 対象 |
|--------|-------|------|
| F | T-I6 | `useTerminalResize.ts` + `useTerminalEvents.ts` |
| G | T-I7 | `useBackendSync.ts` |
| H | T-I8 + T-S15 | `useWindowRename.ts`（まとめて修正） |

#### バッチ3: Suggestion（余裕があれば）
全て独立しているため、各自が別ファイルを担当すれば自由に並列作業可能。

---

## Recommended Action

1. **T-C1 を最優先で修正** — Terminal 二重 Close はランタイムでのパニック/リソースリークに直結する可能性
2. **バッチ1 の Important Issues を並列で修正**
3. **バッチ2 のフロントエンド Important を修正**
4. **テストカバレッジギャップの高優先度項目を追加**
5. **Suggestions は開発の余裕に応じて順次対応**
6. **修正後に再レビューを実行して解消を確認**
