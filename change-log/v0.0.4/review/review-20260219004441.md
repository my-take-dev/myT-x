# PR Review Summary — 2026-02-19 00:44

**対象**: `myT-x/` 配下の全変更ファイル (74ファイル, +7,745 / -2,712 行)
**レビュー方式**: 6カテゴリ並列レビュー (Go App Layer / tmux-shim / Internal tmux / Internal other / Frontend Components / Frontend Logic)

---

## Critical Issues (2件: マージ前に修正必須)

### C-1. [internal/tmux] `resolveTargetRLocked` と `resolveTargetWriteLocked` のロジック重複 (~50行)
- **ファイル**: `internal/tmux/session_manager_targets.go` (L148-L193)
- **内容**: `resolveTargetWriteLocked` は `resolveTargetRLocked` とほぼ同一のターゲット解析・pane lookup・session lookupロジックを持つ。Double-check lockingパターン上の必要性はあるが、バグ修正時に片方だけ修正するリスクが高い。
- **修正案**: 共通のロジック（ターゲットパース→pane検索→session検索）を内部ヘルパー関数 `resolveTargetCore(target string) (*TmuxPane, bool, error)` に抽出し、両メソッドから呼び出す。
- **影響**: 単体ファイル内の修正。他ファイルへの影響なし。

### C-2. [internal/tmux] TOCTOU既知制約の文書化不足
- **ファイル**: `internal/tmux/session_manager_targets.go`, `command_router_handlers_pane.go` (L181)
- **内容**: `resolveTargetRLocked` が返すライブポインタ (`*TmuxPane`) は RLock 解放後に呼び出し元で使用される。コメントで「実用上安全」と記載されているが、Go memory model上はデータレース。`go test -race` はプロジェクト方針上不使用のため現時点では許容されるが、`develop-README.md` に既知の制約として文書化すべき。
- **修正案**: `develop-README.md` に "Known Concurrency Constraints" セクションを追加し、RLock外でのライブポインタ使用パターンとその安全性条件を明記。
- **影響**: ドキュメントのみ。コード変更なし。

---

## Important Issues (12件: 修正推奨)

### I-1. [internal/tmux] `handleResizePane` のレース (DATA RACE TOLERANCE)
- **ファイル**: `internal/tmux/command_router_handlers_pane.go` (L401-L404付近)
- **内容**: `target.Width` / `target.Height` をロック外で読む。コメントで「stale acceptable」と説明あるが、`GetPaneContextSnapshot` を使えばレース排除可能。
- **修正案**: ResizePane呼び出し前にスナップショットからfallback値を取得。

### I-2. [internal/tmux] `handleDisplayMessage` にライブポインタで `expandFormat` 呼び出し
- **ファイル**: `internal/tmux/command_router_handlers_display.go`
- **内容**: `resolveTargetFromRequest` が返す `target` をそのまま `expandFormat` に渡し、`pane.Window.Session` チェーンをロック外で参照。
- **修正案**: クローンまたはスナップショット経由でformat解決。

### I-3. [internal/tmux] `handleSplitWindow` の `-P` フラグ処理でライブポインタ
- **ファイル**: `internal/tmux/command_router_handlers_pane.go` (L159)
- **内容**: `expandFormat(format, newPane)` の `newPane` がライブポインタ。Windowチェーンをロック外で参照。
- **修正案**: I-2と同様にスナップショット経由。

### I-4. [internal/tmux] `splitWindowResolved` が `buildPaneEnv` を使わず手動env構築
- **ファイル**: `internal/tmux/command_router_handlers_pane.go` (L88-L92)
- **内容**: new-session/new-window は共通の `buildPaneEnv` を使用するが、split-windowだけ独自のenv構築パス。一貫性の問題。
- **修正案**: `splitWindowResolved` でも `buildPaneEnv` を使用するよう統一。

### I-5. [internal/tmux] `ListPanesByWindowTarget` の nil ウィンドウチェック未実装
- **ファイル**: `internal/tmux/session_manager_pane_io.go` (L35付近、L111付近)
- **内容**: `session.Windows[i]` が nil の場合にpanic。`cloneSessionForRead` はnilスキップするが本メソッドはライブデータ操作。
- **修正案**: `window == nil` ガードを追加。

### I-6. [internal/tmux] `Snapshot()` ビルドループの nil pane ガード不足
- **ファイル**: `internal/tmux/session_manager_snapshot.go` (L56)
- **内容**: `pane.IDString()` が nil pane で panic する。他メソッド (`cloneSessionForRead`, `copyPaneSlice`) では nil チェック済み。
- **修正案**: nil pane を skip する `continue` ガードを追加。

### I-7. [internal/tmux] `handleNewSession` の `-P` フラグでライブポインタformat展開
- **ファイル**: `internal/tmux/command_router_handlers_session.go` (L79)
- **内容**: I-2, I-3 と同一パターン。

### I-8. [internal/tmux] `WriteToPanesInWindow` の sibling nil チェック不足
- **ファイル**: `internal/tmux/session_manager_pane_io.go` (L178付近)
- **内容**: `sibling.Terminal` の nil チェックはあるが `sibling` 自体の nil チェックがない。

### I-9. [internal/install] `removeProcessPathEntry` のテスト並列安全性
- **ファイル**: `internal/install/shim_cleanup_windows.go` (L228-236)
- **内容**: テスト内で `t.Setenv("PATH", ...)` を使用しており、`t.Parallel()` 追加時に競合する。テストに「並列実行不可」のコメントまたはシリアル化を追加すべき。

### I-10. [internal/ipc] コメント内の非ASCII矢印記号
- **ファイル**: `internal/ipc/protocol.go` (L88-93)
- **内容**: `Flags → empty map` 等の矢印 `→` がUTF-8で正常だが、AGENTS.md規約「ファイルへの書き込みは全て英語」に沿い `->`(ASCII) に置換推奨。

### I-11. [frontend/stores] `setActiveSession` が `activeWindowId` を未更新
- **ファイル**: `frontend/src/stores/tmuxStore.ts` (L116)
- **内容**: セッション切替時に `activeWindowId` が旧セッションの値で残る。次の snapshot/delta イベントまでステール。
- **修正案**: `setActiveSession` 内でも `sessions` から `activeWindowId` を再導出する。

### I-12. [frontend/hooks] `useTerminalFontSize` の依存配列に不要な安定ref
- **ファイル**: `frontend/src/hooks/useTerminalFontSize.ts` (L95-99)
- **内容**: `terminalRef`, `fitAddonRef`, `fontSizeRef` は MutableRefObject で identity 不変。依存配列に含めても実行制御に寄与しない。`[fontSize, paneId]` で十分。

---

## Suggestions (25件: 改善提案)

### S-1. [app_events.go:62-64] `handlePaneOutputEvent` の空チャンク時ログ出力漏れ
構造化payload側で空チャンクのデバッグログが記録されない。legacy mapパスとの一貫性のためデバッグログ追加を検討。

### S-2. [app_pane_feed.go:112] pane-feed-worker の maxPanicRestartRetries 超過後の通知
致命的状態（ワーカー永久停止）を示すが、ユーザーへの通知イベント発行がない。`tmux:worker-panic` のmax-retriesバリアントの発行を検討。

### S-3. [app_events_test.go:475-477] テストのタイムアウト `2*time.Second` はCIジッター対策として妥当だが、50msに対して大きなマージン
CI安定後の再調整を推奨。

### S-4. [model_transform.go:221-226] `applyModelOverride` の2段階フォールスルーの理由コメント不足
`anyModelFlagPattern` で `--model=` 空値がマッチしない理由と `splitModelEqualsArg` へのフォールスルーの意図をコメント化。

### S-5. [model_transform.go:253-265] `applyFromToReplacement` の `splitModelEqualsArg` パスが実質デッドコード化の可能性
regex パスで先にキャプチャされるため到達困難。defense-in-depth として妥当だが、到達パスのテスト追加を推奨。

### S-6. [spec.go] `commandSpec` の `name` フィールド削除は良いが `commandOrder` との二重管理は残存
マップキーからソート生成する方法も検討可。

### S-7. [command_transform_test.go:165-173] `wantChanged` のGoゼロ値依存
`wantChanged: false` を明示設定すると意図が明確に。

### S-8. [model_transform.go:35-38] `matchAll` フィールドの導出可能性
`isAllModelFrom(t.modelFrom)` を都度呼ぶ方法もあるが、パフォーマンス最適化として妥当。

### S-9. [session_manager_targets.go] `resolveTargetRLocked` が pane ではなく needsRepair フラグのみ返すとより明快
修復不要な大多数のケースで使い捨てられるpaneの無駄を省ける。

### S-10. [command_router.go] `bestEffortSendKeys` の `appendEnter` が常に true
YAGNIの観点から常にEnter付加の単純化も検討可。

### S-11. [command_router_test.go] expectedCommands のハードコード管理
新コマンド追加時の忘れリスク。テスト内でもmap build するか注意コメント推奨。

### S-12. [session_manager_windows.go] `removeWindowAtIndexLocked` の戻り値4つ
構造体でまとめると可読性向上。

### S-13. [format_test.go] `newTestFixture` の creation time ハードコード
テスト定数化の検討。

### S-14. [command_router_handlers_pane.go:296] `emitLayoutChangedForSession` の slog.Info レベル確認
高頻度の並行 kill 時にログノイズの可能性。Debug レベル維持が妥当か再検討。

### S-15. [command_router_terminal.go] `mergeEnvironment` のソート
デバッグ一貫性には有用だが、大量 env key 時の計算負荷。必要性確認。

### S-16. [shim_cleanup_windows.go:166-170] `removeLegacyDirectory` の Glob エラー時ログ出力
`filepath.Glob` の `ErrBadPattern` はほぼ起こらないが、ログ出力があると調査容易。

### S-17. [shim_cleanup_windows_test.go] stale path cleanup のテストカバレッジ不足
stale パターンに一致する PATH エントリの挿入→除去テストが無い。

### S-18. [config_test.go:843-868] `ALL` ワイルドカードが実装側で明示されていない
`From == "ALL"` の特別なセマンティクスを実装側にもコメント化推奨。

### S-19. [ConfirmDialog.tsx:L38-L55] フォーカストラップの堅牢化
`aria-modal="true"` / `inert` 属性の追加検討。

### S-20. [useTerminalResize.ts:L81-L102] `compositionend` の二重登録
useTerminalEvents と useTerminalResize の両方が登録。コメントで連携関係を明記推奨。

### S-21. [ConfirmDialog.tsx:L75] WAI-ARIA ダイアログパターン準拠
`role="dialog"` `aria-modal="true"` `aria-labelledby` の追加。

### S-22. [useBackendSync.ts:14-26] `BackendEventMap` の value を具体型に
将来的にペイロード型を定義すればキャスト削減。

### S-23. [useTerminalResize.ts:104-107] hook 呼び出し順序への暗黙依存
「useTerminalSetup の後に呼ぶこと」のコメント明記推奨。

### S-24. [useTerminalEvents.ts:48] `paneEvent` の `useMemo` は不要
同一 `paneId` で常に値一致するため、useMemoを除去しても再実行頻度不変。

### S-25. [layout.css] 2-space → 4-space の一括変更
git blame が全行書き換え。`.editorconfig` / Prettier 設定で統一推奨。

---

## Strengths (良い点)

### Go Backend App Layer
- **`snapshotEventPolicies` テーブル化**: switch→マップでOCP準拠。新イベント追加が1箇所変更で完結。整合性自動検証テスト付き。
- **`requireSessionsWithPaneID` ヘルパー導入**: 7箇所の重複を集約。DRY原則遵守。
- **`handlePaneOutputEvent` の責務分離**: 巨大分岐→3メソッド分割で可読性・テスタビリティ向上。
- **`ApplyLayoutPreset` のTOCTOU修正**: SessionManager側にアトミック操作を委譲する正しいアーキテクチャ判断。
- **リトライ上限追加**: panic-restart無限ループ排除。シャットダウン時の不要リスタート防止。
- **テストカバレッジ充実**: delta検証、フィールドカウントガード、境界値テスト等が網羅的。

### Go tmux-shim
- **CLAUDE.md仕様の忠実な実装**: 設定読込失敗時にエラーを飲み込み原文転送。ログ出力も遵守。
- **防御的コーディング**: nil マップ初期化、空値ガード、空 from/to ガードが一貫。
- **テストカバレッジ**: ALL ワイルドカード12ケース、`--model=` 空値、`=`結合形式等の境界値テスト。
- **`runTransformSafe` のpanic recovery + snapshot rollback**: shimの堅牢性保証。

### Go Internal tmux
- **TOCTOU修正の体系性**: `ResolveDirectionalPane` のsingle-lock-scope化、`handleKillPane` のスナップショット導入等。
- **copy-on-write戦略の徹底**: `ListPanesByWindowTarget` の値コピー返却、`copyPaneSlice` によるnullification。
- **`buildPaneEnv` のDRY化**: 3箇所の重複ロジックを共通メソッドに抽出。
- **RLock fast-path**: write lock contentionの大幅削減。

### Go Internal Other
- **冪等性設計**: `CleanupLegacyShimInstalls` がエラーを返さず起動を止めない設計。
- **PATH操作の安全性**: 空文字列・whitespace-only・`filepath.Clean(".")` の全ガード。
- **`decodeRequest` のnil初期化**: 呼び出し側の防御チェック削減。

### Frontend Components
- **TerminalPane の大規模リファクタリング**: 662行の巨大 useEffect → 4カスタムフック分離。保守性大幅向上。
- **EventsOn cancel 関数パターン**: 個別リスナー解除で誤解除リスク排除。
- **`useWindowRename` の二重呼び出しガード**: Enter→onBlur の二重 commit を2段防御。

### Frontend Logic
- **`resolveSessionState` ヘルパー抽出**: DRY原則準拠。
- **`BackendEventMap` による型安全**: イベント名typoのコンパイル時検出。
- **IME composition の cross-hook 連携**: 書き込み・リサイズ間の正確な連携。
- **disposed フラグ + try-catch の一貫性**: 全フックで非同期コールバック競合窓を防御。

---

## タスク一覧 / 並列作業可否表

下記表は修正タスクを一覧化し、各タスク間の依存関係と並列作業の可否を整理したものです。

| # | 重要度 | タスク概要 | 対象ファイル | 推定影響範囲 | 並列作業 | 備考 |
|---|--------|-----------|------------|------------|---------|------|
| C-1 | **Critical** | resolveTarget共通ロジック抽出 | `session_manager_targets.go` | 単体ファイル | ✅ 可 | I-1, I-2, I-3, I-7 とは独立だが、修正方針として先行推奨 |
| C-2 | **Critical** | TOCTOU既知制約の文書化 | `develop-README.md` | ドキュメントのみ | ✅ 可 | コード変更なし。任意のタスクと並列可 |
| I-1 | Important | handleResizePane レース修正 | `command_router_handlers_pane.go` | 同ファイル内 | ⚠️ I-4 と同一ファイル | I-4 と同時編集注意。順序推奨: I-1 → I-4 |
| I-2 | Important | handleDisplayMessage ライブポインタ修正 | `command_router_handlers_display.go` | 単体ファイル | ✅ 可 | I-3, I-7 と同一パターンだが異なるファイル |
| I-3 | Important | handleSplitWindow `-P` ライブポインタ修正 | `command_router_handlers_pane.go` | 同ファイル内 | ⚠️ I-1, I-4 と同一ファイル | I-1, I-4 との同時編集注意 |
| I-4 | Important | splitWindowResolved の buildPaneEnv 統一 | `command_router_handlers_pane.go` | 同ファイル内 | ⚠️ I-1, I-3 と同一ファイル | I-1, I-3 との同時編集注意 |
| I-5 | Important | ListPanesByWindowTarget nil window ガード | `session_manager_pane_io.go` | I-8 と同一ファイル | ⚠️ I-8 と同一ファイル | I-8 と一括修正推奨 |
| I-6 | Important | Snapshot() nil pane ガード | `session_manager_snapshot.go` | 単体ファイル | ✅ 可 | |
| I-7 | Important | handleNewSession `-P` ライブポインタ修正 | `command_router_handlers_session.go` | 単体ファイル | ✅ 可 | I-2 と同一パターン |
| I-8 | Important | WriteToPanesInWindow sibling nil ガード | `session_manager_pane_io.go` | I-5 と同一ファイル | ⚠️ I-5 と同一ファイル | I-5 と一括修正推奨 |
| I-9 | Important | テスト並列安全性コメント追加 | `shim_cleanup_windows.go` テスト | テストのみ | ✅ 可 | |
| I-10 | Important | protocol.go 非ASCII矢印をASCII化 | `internal/ipc/protocol.go` | 単体ファイル | ✅ 可 | |
| I-11 | Important | setActiveSession の activeWindowId 更新 | `stores/tmuxStore.ts` | フロントエンド | ✅ 可 | バックエンドと独立 |
| I-12 | Important | useTerminalFontSize 依存配列修正 | `hooks/useTerminalFontSize.ts` | フロントエンド | ✅ 可 | |

### 推奨作業順序グループ

並列作業を最大化するため、以下のグループ分けで進めることを推奨します:

#### グループ A: 並列実行可能 (独立ファイル)
以下は全て独立して同時作業可能:

| タスク | 担当ファイル |
|--------|------------|
| C-2 | `develop-README.md` |
| C-1 | `session_manager_targets.go` |
| I-2 | `command_router_handlers_display.go` |
| I-6 | `session_manager_snapshot.go` |
| I-7 | `command_router_handlers_session.go` |
| I-9 | `shim_cleanup_windows_test.go` |
| I-10 | `internal/ipc/protocol.go` |
| I-11 | `stores/tmuxStore.ts` |
| I-12 | `hooks/useTerminalFontSize.ts` |

#### グループ B: 同一ファイル内の逐次作業 (command_router_handlers_pane.go)
I-1 → I-3 → I-4 の順序で1人が担当:

| 順序 | タスク | 内容 |
|------|--------|------|
| 1 | I-1 | handleResizePane レース修正 |
| 2 | I-3 | handleSplitWindow ライブポインタ修正 |
| 3 | I-4 | splitWindowResolved buildPaneEnv 統一 |

#### グループ C: 同一ファイル内の逐次作業 (session_manager_pane_io.go)
I-5 + I-8 を一括修正:

| 順序 | タスク | 内容 |
|------|--------|------|
| 1 | I-5 | ListPanesByWindowTarget nil window ガード |
| 2 | I-8 | WriteToPanesInWindow sibling nil ガード |

### 作業の依存関係図

```
グループ A (並列実行)          グループ B (逐次)      グループ C (逐次)
┌─────────────────┐          ┌──────────┐         ┌──────────┐
│ C-1, C-2        │          │ I-1      │         │ I-5      │
│ I-2, I-6, I-7   │ ── 全て  │   ↓      │         │   ↓      │
│ I-9, I-10       │    並列  │ I-3      │         │ I-8      │
│ I-11, I-12      │    可能  │   ↓      │         └──────────┘
└─────────────────┘          │ I-4      │
                             └──────────┘
```

**グループ A, B, C は互いに独立して並列実行可能です。**

---

## Recommended Action

1. **Critical (C-1, C-2) を最優先で修正** — C-1 は将来のバグ混入リスク低減、C-2 はチーム知識共有
2. **Important のグループ A を並列着手** — 9タスクが独立して同時作業可能
3. **Important のグループ B, C を各1名で逐次着手** — ファイル競合を避ける
4. **Suggestions は次回スプリントで対応検討** — 現時点で動作に影響なし
5. **修正後に本レビューを再実行** — 指摘事項の解消確認
