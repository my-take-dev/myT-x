# Code Review Report

**Date**: 2026-02-19 01:10  
**Scope**: `myT-x/` 配下の全変更ファイル（74ファイル, +7745 / -2712 行）  
**Reviewer**: AI Parallel Review (6 agents)

---

## Review Categories

| Category | Files | Insertions | Agent |
|----------|-------|------------|-------|
| Backend Core (app_*.go) | 11 | ~1200 | Agent 1 |
| Backend Tests (app_*_test.go) | 8+ | ~700 | Agent 6 |
| tmux-shim (cmd/tmux-shim/) | 7 | ~1800 | Agent 2 |
| Frontend (frontend/) | 17 | ~1500 | Agent 3 |
| internal/tmux | 24 | ~2000 | Agent 4 |
| internal/config,install,ipc | 8 | ~500 | Agent 5 |

---

## Critical Issues

**該当なし**

全カテゴリにおいてクリティカルな問題は検出されなかった。

---

## Important Issues

### I-01: `resize-pane` 方向フラグがハンドラで未処理（tmux-shim → internal/tmux）

**ファイル**: `cmd/tmux-shim/spec.go`, `internal/tmux/command_router_handlers_pane.go`  
**内容**: shim の `spec.go` で `-U`, `-D`, `-L`, `-R`, `-Z` フラグがパース対象として追加されているが、バックエンド側の `handleResizePane` ハンドラではこれらの方向フラグを処理するロジックが存在しない。パースされたフラグは静かに無視される。  
**影響**: `resize-pane -L 5` のようなコマンドが送信されても方向が適用されず、デフォルト動作（下方向？）になる。  
**推奨**: ハンドラ側で方向フラグを参照するか、未実装であれば明示的に警告ログを出力する。

### I-02: `ResolveDirectionalPane` のテストが不在（internal/tmux）

**ファイル**: `internal/tmux/session_manager_targets.go`  
**内容**: `ResolveDirectionalPane`（+309行の一部）は `select-pane -L/-R/-U/-D` のコアロジックだが、単体テストが存在しない。`command_router_handlers_pane_test.go` は `-T` フラグのみカバー。  
**影響**: 方向パネル移動のリグレッションを検出できない。  
**推奨**: 正常系（2x2レイアウト等）、単一ペイン時の自身返却、無効方向のエラー処理のテストを追加する。

### I-03: Effect cleanup 順序リスク（Frontend）

**ファイル**: `frontend/src/components/TerminalPane.tsx`, `useTerminalSetup.ts`, `useTerminalEvents.ts`  
**内容**: `useTerminalSetup` は `Terminal` インスタンスの dispose を行い、`useTerminalEvents` は Terminal の `onData`/`onResize` 等の disposable を cleanup する。React の Effect cleanup 順序は宣言の逆順であるため、`useTerminalEvents`（後に宣言）の cleanup が先に実行され正しい順序となるが、hook の呼出し順が変わると Terminal が先に dispose される可能性がある。  
**影響**: hook の順序変更時に cleanup エラーが発生しうる。  
**推奨**: `disposed` フラグパターンが既に導入されているため、現状は安全。ただし hook 間の依存関係をコメントで明記することを推奨。

### I-04: `commitPaneTitle` のエラーハンドリングが不完全（Frontend）

**ファイル**: `frontend/src/components/hooks/useWindowRename.ts`  
**内容**: `commitPaneTitle` の `.catch()` 内に `console.warn` が含まれていない。他の全API呼び出し（`SetPaneTitle`, `SelectPane`, `ResizePane` 等）は `.catch(console.warn)` パターンを使用している。  
**影響**: エラー時にブラウザコンソールにログが出ず、デバッグが困難。  
**推奨**: `.catch(console.warn)` を追加して他のAPIコールと統一する。

### I-05: `types/tmux.ts` と `models.ts` 間の型ドリフト（Frontend）

**ファイル**: `frontend/src/types/tmux.ts`, `frontend/wailsjs/go/models.ts`  
**内容**: `types/tmux.ts` の `PaneInfo.created_at` は `string` 型、`models.ts` の `PaneInfo.created_at` は `any` 型。同一概念に対して2つの型定義が異なる値を持つ。`wailsjs/go/models.ts` は自動生成ファイルだが、手動の `types/tmux.ts` との乖離が拡大する恐れがある。  
**影響**: ランタイム型エラーの潜在リスク。  
**推奨**: `types/tmux.ts` を中長期的に `models.ts` から自動生成するか、型の一致を検証する仕組みを導入する。

### I-06: `ListPanesByWindowTarget` 整数インデックスパスの nil ガード不足（internal/tmux）

**ファイル**: `internal/tmux/session_manager_targets.go`  
**内容**: `ListPanesByWindowTarget` の整数インデックスによるウィンドウ解決パスで、`windows[normalizeIndex(...)]` がnilになりうるケースのガードがない。`@stableID` パスにはnilガードがあるが、integer indexパスには欠けている。  
**影響**: 不正なインデックスでパニックが発生する可能性。  
**推奨**: `normalizeIndex` の結果に対して範囲チェックまたは nil ガードを追加する。

### I-07: `Snapshot()` キャッシュ再構築時の pane nil チェック不足（internal/tmux）

**ファイル**: `internal/tmux/session_snapshot_delta.go`  
**内容**: `Snapshot()` メソッドのキャッシュ再構築ループで `copyPaneSlice` は nil pane をスキップするが、`Snapshot()` 自体のループには同等のチェックがない。  
**影響**: nil pane エントリが存在する場合にパニック。  
**推奨**: `copyPaneSlice` と同様の nil ガードを追加するか、pane スライスから nil が混入しないことの不変条件を明記する。

### I-08: `registry.CreateKey` の使用（internal/install）

**ファイル**: `internal/install/shim_cleanup_windows.go`  
**内容**: レジストリからのPATH読取・クリーンアップ処理で `registry.CreateKey` が使用されている。読取・更新のみの操作であれば `registry.OpenKey` の方が意図が明確。`CreateKey` はキーが存在しない場合に作成する副作用がある。  
**影響**: 存在しないレジストリキーが意図せず作成される可能性（極めて低い）。  
**推奨**: `registry.OpenKey` に変更し、キーが存在しない場合は早期リターンする。

### I-09: `os.IsNotExist` の使用（internal/install）

**ファイル**: `internal/install/shim_cleanup_windows.go`  
**内容**: `os.IsNotExist(err)` が使用されているが、Go 1.13+ では `errors.Is(err, os.ErrNotExist)` が推奨。ラップされたエラーで `os.IsNotExist` が false を返すケースがある。  
**影響**: 特定のエラーラッピングパターンでファイル不存在を検出できない可能性。  
**推奨**: `errors.Is(err, os.ErrNotExist)` に置換する。

### I-10: バウンドリトライ上限テストの不在（Backend Tests）

**ファイル**: `myT-x/app_pane_feed.go`, `myT-x/app_pane_feed_test.go`  
**内容**: `startPaneFeedWorker` の `maxPanicRestartRetries` による再起動回数制限ロジックのテストがない。`TestRecoverBackgroundPanic` と `TestNextPanicRestartBackoff` は個々の関数をテストしているが、リトライ上限到達時にgoroutineが正しく終了するかは未検証。  
**影響**: 無限ループ防止メカニズムの信頼性が未保証。  
**推奨**: リトライ上限到達時の終了動作をテストする。

### I-11: `anyModelFlagPattern` の正規表現が貪欲（tmux-shim）

**ファイル**: `cmd/tmux-shim/model_transform.go`  
**内容**: `anyModelFlagPattern` の `\S+` が貪欲マッチを行うため、モデル名に続く他のフラグまで消費する可能性がある。例: `--model=claude-3 --flag` で `claude-3 --flag` 全体がマッチしないかの確認が必要。  
**影響**: 正規表現の仕様上 `\S+` は空白で停止するため実質的な問題は低いが、`--model=value1 --model=value2` のようなケースでの挙動を確認すべき。  
**推奨**: テストで複数フラグ共存ケースが網羅されていることを確認する。

### I-12: `applyFromToReplacement` の空値ガード非対称（tmux-shim）

**ファイル**: `cmd/tmux-shim/model_transform.go`  
**内容**: `applyModelOverride` には `--model=` （空値）のガードが実装されているが、`applyFromToReplacement` には同等のガードがない。ModelFrom/ModelTo の設定値が空文字列の場合の防御が非対称。  
**影響**: 空の ModelTo が設定された場合に `--model=` （値なし）が生成される可能性。  
**推奨**: `applyFromToReplacement` にも空値チェックを追加するか、Config 読み込み時にバリデーションで防止する。

### I-13: `emitWorktreeCleanupFailure` のイベント消失（Backend Core）

**ファイル**: `myT-x/app_session_api.go`  
**内容**: `runtimeContext()` が nil の場合、イベント発行を完全にスキップする設計に変更された（以前は `context.Background()` にフォールバック）。これにより、shutdown 中のworktree cleanup 失敗がフロントエンドに通知されなくなる。  
**影響**: ユーザーがworktree cleanupの失敗を認識できないケースが発生しうる。ただし shutdown 中のイベントは受け手がいない可能性が高く、合理的な設計判断とも言える。  
**推奨**: shutdown 中のイベント消失が意図的であることをコメントで明記する。

---

## Suggestions（改善提案）

### S-01: `snapshotEventPolicies` マップの不変性保証

**ファイル**: `myT-x/app_events.go`  
**内容**: `snapshotEventPolicies` はパッケージレベル変数で `init()` 後は読み取り専用だが、コンパイル時の不変性保証がない。  
**推奨**: コメントで `// immutable after init` を明記するか、`sync.OnceValue` パターンでの遅延初期化を検討。

### S-02: `requireSessionsWithPaneID` のポインタ引数

**ファイル**: `myT-x/app_guards.go`  
**内容**: `requireSessionsWithPaneID(paneID *string)` はポインタ引数を取り、内部で正規化（空文字→ActivePaneID置換）して呼び出し元の変数を書き換える。Go では非慣用的だが、複数箇所での正規化ロジック重複を排除する目的で合理的。  
**推奨**: 関数コメントにポインタ引数の副作用（in-place mutation）を明記する。

### S-03: `getRenameInputRef` のレンダリング毎生成

**ファイル**: `frontend/src/components/hooks/useWindowRename.ts`  
**内容**: `getRenameInputRef` がレンダリング毎に新しい関数参照を生成する。`useCallback` でメモ化可能。  
**推奨**: パフォーマンス影響は軽微だが、他のコールバックとの一貫性のため `useCallback` でラップすることを推奨。

### S-04: `paneEnvView()` のコピーオンライト契約

**ファイル**: `internal/tmux/session_manager_env.go`  
**内容**: `paneEnvView()` はロック内で env マップの参照を返し、変更が必要な場合のみコピーを作成する契約だが、コンパイル時の強制がない。  
**推奨**: 関数コメントに契約条件を明記し、`copyOnWriteEnv()` ヘルパーの使用を推奨するコメントを追加。

### S-05: イベントヘルパーの共通テストヘルパー化

**ファイル**: 複数テストファイル  
**内容**: `captureEmitter` パターンが `command_router_handlers_pane_test.go` にハードコード。同パターンが複数テストで繰り返されている。  
**推奨**: `testutil` パッケージに共通テストヘルパーとして抽出。

### S-06: フロントエンドの `layout.css` インデント変更

**ファイル**: `frontend/src/components/layout.css`  
**内容**: 2→4スペースへの純粋なインデント変更が多数。実質変更は `.window-tab-close:focus-within` の追加のみ。  
**推奨**: フォーマッタ設定を統一し、今後のdiff ノイズを防止する。

### S-07: `model_transform_test.go` の `resetModelConfigLoadState` 呼出し不整合

**ファイル**: `cmd/tmux-shim/model_transform_test.go`  
**内容**: 一部テスト（`TestApplyModelTransformSkipsOnLoaderError`）で `resetModelConfigLoadState()` が呼ばれておらず、前のテストのキャッシュ状態に依存する可能性。  
**推奨**: 全テストケースで `t.Cleanup(resetModelConfigLoadState)` を統一的に使用する。

### S-08: `SaveTo` メソッドの直接テスト追加

**ファイル**: `internal/config/config.go`, `internal/config/config_test.go`  
**内容**: `SaveTo` メソッド（パス安全性チェック含む）の直接テストがない。`pathWithinDir` はテスト済みだが、実際の書き込みフローは未検証。  
**推奨**: tempdir を使った `SaveTo` の正常系・異常系テストを追加。

---

## Positive Observations（良好な点）

### Architecture & Design
- **P-01**: `snapshotEventPolicy` マップベースのアプローチにより `switch` 文の重複が排除され、イベントポリシーの一元管理が実現。新イベント追加時の修正漏れ防止にも寄与。
- **P-02**: `handlePaneOutputEvent` の抽出により、`handleSnapshotEvent` の責務が明確化。Single Responsibility Principle に適合。
- **P-03**: TerminalPane の 5 hook 分解（`useTerminalSetup`, `useTerminalEvents`, `useTerminalFontSize`, `useTerminalResize`, `useWindowRename`）は関心の分離として優秀。
- **P-04**: `RLock` fast path + `Lock` slow path パターンによるターゲット解決は、読み取り頻度の高い操作のパフォーマンスを最適化しつつ TOCTOU 問題を排除。
- **P-05**: `session_manager_targets.go` のターゲット解決リファクタリングにより、セッション/ウィンドウ/ペインの解決ロジックが集約化。

### Safety & Robustness
- **P-06**: `disposed` フラグパターンが全 hook に一貫して導入されており、unmount 後のイベントハンドリングが安全。
- **P-07**: `EventsOn` の cancel 関数パターンにより、イベントリスナーのリーク防止が体系化。
- **P-08**: `maxPanicRestartRetries` による無限リトライ防止。goroutine リークの根本対策。
- **P-09**: バウンドリトライ + 指数バックオフの組み合わせにより、障害時の安定性を確保。
- **P-10**: tmux-shim のパニック復帰 + スナップショットロールバック（`runTransformSafe`）は Defense-in-Depth の好例。

### Test Quality
- **P-11**: 構造的不変条件テスト（フィールド数ガード、ポリシー整合性チェック、コマンドスペック一貫性）が体系的に導入されており、構造変更時のリグレッション検出能力が極めて高い。
- **P-12**: クローン独立性テスト（`TestCopyPaneSliceDeepCopiesEnv`, `TestResolveSessionTargetReturnsClone` 等）がロック外への参照漏洩を防止。
- **P-13**: テーブル駆動テストが一貫して適用されており、組織的なテスト設計。
- **P-14**: セキュリティ関連テスト（null byte 拒否、相対パス拒否、パストラバーサル拒否、symlink エスケープ拒否）が充実。
- **P-15**: `t.Parallel()` の適切な回避がパッケージレベル変数を置換する全ファイルで一貫。
- **P-16**: tmux-shim のテストカバレッジ（800行超）が充実しており、ALL ワイルドカード、inline `=` フォーム、override 優先順位、部分変更ロールバックを網羅。

### Windows Integration
- **P-17**: `shim_cleanup_windows.go` の legacy shim クリーンアップがレジストリ PATH 操作を含む包括的な実装。startup ブロック禁止の設計ルールを遵守。
- **P-18**: `ensurePathMu` によるロック共有で、PATH 操作の並行安全性を確保。

---

## Summary

| Category     | Critical | Important | Suggestion | Positive |
|-------------|----------|-----------|------------|----------|
| Backend Core | 0 | 1 (I-13) | 2 (S-01, S-02) | 4 |
| Backend Tests | 0 | 1 (I-10) | 2 (S-07, S-08) | 6 |
| tmux-shim | 0 | 3 (I-01, I-11, I-12) | 0 | 2 |
| Frontend | 0 | 2 (I-03, I-04) | 2 (S-03, S-06) | 3 |
| Frontend Types | 0 | 1 (I-05) | 0 | 0 |
| internal/tmux | 0 | 3 (I-02, I-06, I-07) | 2 (S-04, S-05) | 5 |
| internal/install | 0 | 2 (I-08, I-09) | 0 | 2 |
| **Total** | **0** | **13** | **8** | **22** |

---

## Parallel Task Table（並列作業可能性マトリクス）

以下の表は、各 Issue の修正を **どの作業と並列で実施可能か** を示す。

| ID | Issue | File(s) | Estimated Effort | Parallel Group |
|----|-------|---------|-----------------|----------------|
| I-01 | resize-pane 方向フラグ未処理 | `cmd/tmux-shim/spec.go`, `internal/tmux/command_router_handlers_pane.go` | 中（ハンドラ実装 or 警告ログ追加） | **A** |
| I-02 | ResolveDirectionalPane テスト不在 | `internal/tmux/session_manager_targets_test.go` (新規) | 中（テスト3-5ケース作成） | **A** |
| I-03 | Effect cleanup 順序リスク | `frontend/src/components/TerminalPane.tsx` | 小（コメント追記） | **B** |
| I-04 | commitPaneTitle エラーハンドリング | `frontend/src/components/hooks/useWindowRename.ts` | 小（1行追加） | **B** |
| I-05 | types/tmux.ts 型ドリフト | `frontend/src/types/tmux.ts` | 中（型統一方針の決定） | **C** |
| I-06 | ListPanesByWindowTarget nil ガード | `internal/tmux/session_manager_targets.go` | 小（ガード1箇所追加） | **A** |
| I-07 | Snapshot() pane nil チェック | `internal/tmux/session_snapshot_delta.go` | 小（ガード or コメント追加） | **A** |
| I-08 | registry.CreateKey → OpenKey | `internal/install/shim_cleanup_windows.go` | 小（API変更+早期リターン） | **D** |
| I-09 | os.IsNotExist → errors.Is | `internal/install/shim_cleanup_windows.go` | 小（1行置換） | **D** |
| I-10 | バウンドリトライテスト追加 | `myT-x/app_pane_feed_test.go` | 中（テスト作成） | **E** |
| I-11 | anyModelFlagPattern 正規表現 | `cmd/tmux-shim/model_transform.go` | 小（テスト確認 or 正規表現修正） | **F** |
| I-12 | applyFromToReplacement 空値ガード | `cmd/tmux-shim/model_transform.go` | 小（ガード追加） | **F** |
| I-13 | emitWorktreeCleanupFailure コメント | `myT-x/app_session_api.go` | 小（コメント追記） | **E** |

### Parallel Groups（並列実行グループ）

```
  Group A                Group B              Group C             Group D              Group E              Group F
  ┌─────────┐           ┌─────────┐          ┌─────────┐        ┌─────────┐          ┌─────────┐          ┌─────────┐
  │ I-01    │           │ I-03    │          │ I-05    │        │ I-08    │          │ I-10    │          │ I-11    │
  │ I-02    │           │ I-04    │          │         │        │ I-09    │          │ I-13    │          │ I-12    │
  │ I-06    │           │         │          │         │        │         │          │         │          │         │
  │ I-07    │           │         │          │         │        │         │          │         │          │         │
  └─────────┘           └─────────┘          └─────────┘        └─────────┘          └─────────┘          └─────────┘
  internal/tmux         frontend/            frontend/types     internal/install     app_*.go             tmux-shim/
  + shim spec           hooks, components    型方針検討          レジストリ操作        テスト+コメント       model_transform
```

**全6グループは互いに独立しており、全て同時に並列作業可能。**

### 作業優先度の推奨順序

1. **Group A** (I-01, I-02, I-06, I-07) — 機能的に最も影響が大きい。resize-pane方向フラグの未処理とテスト不足を修正。
2. **Group F** (I-11, I-12) — tmux-shim の堅牢性向上。
3. **Group D** (I-08, I-09) — Go idiom 準拠。工数が小さい。
4. **Group B** (I-03, I-04) — Frontend の一貫性向上。工数が小さい。
5. **Group E** (I-10, I-13) — テスト追加とコメント。
6. **Group C** (I-05) — 型ドリフトは中長期課題として方針決定が先。

---

## Appendix: Suggestion Task Table

| ID | Suggestion | File(s) | Effort | Parallel OK |
|----|-----------|---------|--------|-------------|
| S-01 | snapshotEventPolicies 不変性コメント | `app_events.go` | 小 | Yes (any) |
| S-02 | requireSessionsWithPaneID コメント | `app_guards.go` | 小 | Yes (any) |
| S-03 | getRenameInputRef useCallback | `useWindowRename.ts` | 小 | Yes (Group B) |
| S-04 | paneEnvView() 契約コメント | `session_manager_env.go` | 小 | Yes (Group A) |
| S-05 | captureEmitter テストヘルパー化 | `testutil/` | 中 | Yes (any) |
| S-06 | layout.css フォーマッタ統一 | `frontend/` 設定 | 小 | Yes (any) |
| S-07 | resetModelConfigLoadState 統一 | `model_transform_test.go` | 小 | Yes (Group F) |
| S-08 | SaveTo 直接テスト追加 | `config_test.go` | 中 | Yes (any) |
