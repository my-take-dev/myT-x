# 統合コードレビュー報告書

**日付**: 2026-02-19 01:17  
**対象**: `myT-x/` 配下の全変更ファイル（63–74ファイル, +5,686–7,745 / -2,712 行）  
**ソース**: 3件のレビュー結果を統合・重複排除  
- `review-20260219004441.md` (6カテゴリ並列レビュー)  
- `review-20260219011042.md` (6エージェント並列レビュー)  
- `review-20260219011145.md` (7エージェント並列レビュー)

---

## サマリ

| 重要度 | 件数 | 概要 |
|--------|------|------|
| **Critical** | 3 | ロジック重複・再帰リスク・文書化 |
| **Important** | 31 | nil ガード、ライブポインタ、通知欠如、型安全性、設計課題 |
| **Suggestion** | 34 | コメント改善、可読性向上、テスト補強、コード簡素化 |

---

## Critical Issues (3件)

### C-01: `resolveTargetRLocked` と `resolveTargetWriteLocked` のロジック重複 (~50行)

- **ファイル**: `internal/tmux/session_manager_targets.go`
- **問題**: 両メソッドがほぼ同一のターゲット解析・pane lookup・session lookupロジックを持つ。Double-check lockingパターン上の必要性はあるが、バグ修正時に片方だけ修正するリスクが高い。
- **修正案**: 共通ロジックを `resolveTargetCore(target string) (*TmuxPane, bool, error)` に抽出し、両メソッドから呼び出す。

### C-02: TOCTOU 既知制約の文書化不足

- **ファイル**: `internal/tmux/session_manager_targets.go`, `command_router_handlers_pane.go`
- **問題**: `resolveTargetRLocked` が返すライブポインタ (`*TmuxPane`) は RLock 解放後に呼び出し元で使用される。Go memory model上はデータレース。`go test -race` はプロジェクト方針上不使用のため現時点では許容されるが、既知の制約として文書化すべき。
- **修正案**: `develop-README.md` に "Known Concurrency Constraints" セクションを追加。

### C-03: `pruneRotatedShimDebugLogs` 内の `debugLog` 再帰リスク

- **ファイル**: `cmd/tmux-shim/main.go`
- **問題**: `rotateShimDebugLogIfNeeded` → `pruneRotatedShimDebugLogs` → `debugLog` → `rotateShimDebugLogIfNeeded` の循環が理論上成立する。サイズ上限ちょうどのタイミングで無限再帰→スタックオーバーフローの可能性。
- **修正案**: `pruneRotatedShimDebugLogs` 内のログを `log.New(os.Stderr, ...)` に切り替え、循環を断ち切る。

---

## Important Issues (31件)

### internal/tmux (12件)

#### I-01: `resize-pane` 方向フラグがハンドラで未処理

- **ファイル**: `cmd/tmux-shim/spec.go`, `internal/tmux/command_router_handlers_pane.go`
- **問題**: shim で `-U`, `-D`, `-L`, `-R`, `-Z` フラグがパース対象として追加されているが、バックエンド `handleResizePane` では方向フラグを処理するロジックが存在しない。パースされたフラグは静かに無視される。
- **修正案**: ハンドラ側で方向フラグを参照するか、未実装であれば明示的に警告ログを出力。

#### I-02: `handleResizePane` のライブポインタ読み取りレース

- **ファイル**: `internal/tmux/command_router_handlers_pane.go`
- **問題**: `target.Width` / `target.Height` をロック外で読む。コメントで「stale acceptable」と説明あるが、`GetPaneContextSnapshot` を使えばレース排除可能。
- **修正案**: ResizePane 呼び出し前にスナップショットから fallback 値を取得。

#### I-03: format 展開時のライブポインタ使用（3ハンドラ共通）

- **ファイル**:
  - `internal/tmux/command_router_handlers_display.go` (`handleDisplayMessage`)
  - `internal/tmux/command_router_handlers_pane.go` (`handleSplitWindow` `-P`)
  - `internal/tmux/command_router_handlers_session.go` (`handleNewSession` `-P`)
- **問題**: `resolveTargetFromRequest` が返す `target` をそのまま `expandFormat` に渡し、`pane.Window.Session` チェーンをロック外で参照。3箇所で同一パターン。
- **修正案**: クローンまたはスナップショット経由で format 解決。

#### I-04: `splitWindowResolved` が `buildPaneEnv` を使わず手動 env 構築

- **ファイル**: `internal/tmux/command_router_handlers_pane.go`
- **問題**: new-session/new-window は共通の `buildPaneEnv` を使用するが、split-window だけ独自の env 構築パス。一貫性の問題。
- **修正案**: `splitWindowResolved` でも `buildPaneEnv` を使用するよう統一。

#### I-05: nil ガード不足（3箇所）

- **ファイル**:
  - `internal/tmux/session_manager_targets.go` — `ListPanesByWindowTarget` の整数インデックスパス
  - `internal/tmux/session_snapshot_delta.go` — `Snapshot()` ビルドループの pane nil
  - `internal/tmux/session_manager_pane_io.go` — `WriteToPanesInWindow` の sibling nil
- **問題**: `cloneSessionForRead` / `copyPaneSlice` では nil チェック済みだが、上記メソッドでは同等のガードが欠けている。
- **修正案**: 各箇所に nil ガードまたは `continue` スキップを追加。

#### I-06: `ResolveDirectionalPane` のテスト不在

- **ファイル**: `internal/tmux/session_manager_targets.go` (テスト新規作成)
- **問題**: 方向パネル移動のコアロジックだが、単体テストが存在しない。
- **必要テスト**: 2x2レイアウトの上下左右移動、単一ペイン時の自身返却、無効方向のエラー、3+ペインの中間ペイン選択。

#### I-07: ウィンドウインデックス検索パターンの重複（3箇所）

- **ファイル**: `internal/tmux/session_manager_windows.go`
- **問題**: `RemoveWindowByID`, `RenameWindowByID`, `WindowIndexInSession` で `for i, window := range session.Windows` + `window.ID == windowID` パターンが重複。
- **修正案**: `findWindowIndexByID(windows []*TmuxWindow, id int) int` ヘルパーを抽出。

#### I-08: `removeWindowAtIndexLocked` の Terminal.Close 責務委譲

- **ファイル**: `internal/tmux/session_manager_windows.go`
- **問題**: `removedPanes` を返し、呼び出し元が `Terminal.Close()` を行う設計。Close 忘れでリソースリーク。
- **修正案**: 呼び出し元で Close 漏れがないことを検証するテストケース追加。

---

### App 層 (10件)

#### I-09: ワーカー最大リトライ到達時にフロントエンド通知なし

- **ファイル**: `myT-x/app_pane_feed.go`, `myT-x/app_lifecycle.go`
- **問題**: `pane-feed-worker` と `idle-monitor` で `maxPanicRestartRetries`（10回）到達後、`slog.Error` のみでフロントエンドに通知されない。
- **修正案**: `tmux:worker-fatal` イベントを発行する。

#### I-10: ワーカーリトライループの共通化

- **ファイル**: `myT-x/app_pane_feed.go`, `myT-x/app_lifecycle.go`
- **問題**: `pane-feed-worker` と `idle-monitor` の panic recovery + retry ループが構造的に同一コード。片方だけ修正して不整合になるリスク。
- **修正案**: 共通の `runBackgroundWorker(ctx, name, fn)` ヘルパー抽出。または相互参照コメントの追加。

#### I-11: バウンドリトライ上限テストの不在

- **ファイル**: `myT-x/app_pane_feed_test.go`
- **問題**: `maxPanicRestartRetries` による再起動回数制限がテスト未検証。無限ループ防止メカニズムの信頼性が未保証。
- **修正案**: リトライ上限到達時の終了動作テストを追加。

#### I-12: `snapshotEventPolicies` の `trigger` フィールドが全て `true`

- **ファイル**: `myT-x/app_events.go`
- **問題**: 全エントリが `trigger: true`。将来 `trigger: false` を期待して追加した場合の誤解リスク。
- **修正案**: キー存在で判定する方式に変更するか、コメントで `trigger: false` の用途を記載。

#### I-13: `ensureShimReady` の `err` 変数上書き + `needsInstallBefore` 暗黙依存

- **ファイル**: `myT-x/app_lifecycle.go`
- **問題**: L143 と L168 の `needsShimInstallFn()` が同じ `err` 変数名。また `err != nil` 時の `needsInstallBefore = false` が暗黙的で、イベントが発行されない。
- **修正案**: L168 の変数名を `postCheckErr` に変更。意図をコメントで明記。

#### I-14: `pane-feed-worker` の `runtimeContext()` 二重呼び出し

- **ファイル**: `myT-x/app_pane_feed.go`
- **問題**: L92 で nil チェックし、L97 で再度呼び出す。シャットダウン中に2回目が nil になる可能性。
- **修正案**: L92 の取得値をローカル変数に保持して再利用。

#### I-15: `emitWorktreeCleanupFailure` のイベント消失

- **ファイル**: `myT-x/app_session_api.go`
- **問題**: `runtimeContext()` が nil の場合、イベント発行を完全にスキップ。shutdown 中は受け手がいない可能性が高く合理的だが、意図が不明。
- **修正案**: シャットダウン中のドロップが意図的であることをコメントに明記。

#### I-16: `getConfigInternalUnsafe` の本番利用箇所不明

- **ファイル**: `myT-x/app_config_state.go`
- **問題**: WARNING 付き最適化メソッド。本番コードからの呼び出し元が確認できない。
- **修正案**: 呼び出し元を確認し、本番未使用ならテストヘルパーに移動。

#### I-17: `requireSessionsWithPaneID` の nil ポインタ引数

- **ファイル**: `myT-x/app_guards.go`
- **問題**: `paneID *string` が nil の場合パニック。公開 API はフロントエンドからの呼び出しなので実害は薄いが、内部利用で nil を渡した場合に不親切。
- **修正案**: nil ガード追加、または godoc で非 nil 契約を明記。

#### I-18: `enqueuePaneStateFeed` のチャネルフル時順序コメント

- **ファイル**: `myT-x/app_pane_feed.go`
- **問題**: チャネルフル時のダイレクトフィードとワーカーの通常フィードの順序が保証されない。xterm.js バッファで実質問題ないが設計意図が不明。
- **修正案**: コメントで順序非保証の意図と許容理由を追記。

---

### Frontend (8件)

#### I-19: `setActiveSession` が `activeWindowId` を未更新

- **ファイル**: `frontend/src/stores/tmuxStore.ts`
- **問題**: `set({activeSession})` のみで `activeWindowId` を更新しない。`setSessions` / `applySessionDelta` は `resolveSessionState` 経由で再計算するが、`setActiveSession` 単体では stale 値が残る。
- **修正案**: `setActiveSession` 内でも `activeWindowId` を再計算。

#### I-20: `useTerminalFontSize` の依存配列に不要な安定 ref

- **ファイル**: `frontend/src/hooks/useTerminalFontSize.ts`
- **問題**: `terminalRef`, `fitAddonRef`, `fontSizeRef` は MutableRefObject で identity 不変。依存配列に含めても実行制御に寄与しない。
- **修正案**: `[fontSize, paneId]` に簡素化。

#### I-21: Effect cleanup 順序リスク

- **ファイル**: `frontend/src/components/TerminalPane.tsx`, `useTerminalSetup.ts`, `useTerminalEvents.ts`
- **問題**: hook の呼出し順が変わると Terminal が先に dispose される可能性。`disposed` フラグパターンが導入済みで現状は安全。
- **修正案**: hook 間の依存関係をコメントで明記。

#### I-22: `commitPaneTitle` のエラーハンドリング不完全

- **ファイル**: `frontend/src/components/hooks/useWindowRename.ts`
- **問題**: `.catch()` 内に `console.warn` がない。他の全 API 呼び出しは `.catch(console.warn)` パターン。
- **修正案**: `.catch(console.warn)` を追加して統一。

#### I-23: `types/tmux.ts` と `models.ts` の型ドリフト

- **ファイル**: `frontend/src/types/tmux.ts`, `frontend/wailsjs/go/models.ts`
- **問題**: 手動の `types/tmux.ts` と自動生成の `models.ts` で同一概念の型が異なる（`created_at`: `string` vs `any`）。
- **修正案**: 中長期的に型の一致検証の仕組みを導入。

#### I-24: `GetConfigAndFlushWarnings` catch 後の config 状態

- **ファイル**: `frontend/src/hooks/useBackendSync.ts`
- **問題**: `.catch` ブロックで `setConfig` を呼ばない。`config === null` のまま後続のイベントまで回復しない。
- **修正案**: 各コンポーネントの `config === null` ガードを確認するか、catch でデフォルト config を設定。

#### I-25: `applySessionDelta` の upserts ランタイム検証不足

- **ファイル**: `frontend/src/stores/tmuxStore.ts`
- **問題**: `upserts` 配列内の要素に null/undefined チェックがない。`session.name` が undefined の場合、Map キーが `"undefined"` 文字列になる。
- **修正案**: `upserts.filter(s => s && typeof s.name === "string")` のフィルタ追加。

#### I-26: `configEventVersionRef` による初回 API レスポンス棄却

- **ファイル**: `frontend/src/hooks/useBackendSync.ts`
- **問題**: `config:updated` イベントのパースに失敗した場合、API レスポンスが破棄されつつイベントも反映されず `config === null` のまま。
- **修正案**: コメントでこの動作を明記。

---

### tmux-shim (2件)

#### I-27: `anyModelFlagPattern` の正規表現が貪欲

- **ファイル**: `cmd/tmux-shim/model_transform.go`
- **問題**: `\S+` が貪欲マッチ。`--model=value1 --model=value2` ケースでの挙動確認が必要。
- **修正案**: テストで複数フラグ共存ケースの網羅を確認。

#### I-28: `applyFromToReplacement` の空値ガード非対称

- **ファイル**: `cmd/tmux-shim/model_transform.go`
- **問題**: `applyModelOverride` に `--model=` 空値ガードがあるが、`applyFromToReplacement` には同等のガードがない。
- **修正案**: 空値チェック追加、または Config 読み込み時にバリデーションで防止。

---

### internal/install (3件)

#### I-29: `registry.CreateKey` の使用

- **ファイル**: `internal/install/shim_cleanup_windows.go`
- **問題**: 読取・更新のみの操作に `CreateKey` を使用。キーが存在しない場合に作成する副作用あり。
- **修正案**: `registry.OpenKey` に変更し、キー不在時は早期リターン。

#### I-30: `os.IsNotExist` → `errors.Is`

- **ファイル**: `internal/install/shim_cleanup_windows.go`
- **問題**: Go 1.13+ では `errors.Is(err, os.ErrNotExist)` が推奨。ラップされたエラーで検出漏れの可能性。
- **修正案**: `errors.Is(err, os.ErrNotExist)` に置換。

#### I-31: テスト並列安全性

- **ファイル**: `internal/install/shim_cleanup_windows.go` テスト
- **問題**: `t.Setenv("PATH", ...)` 使用により `t.Parallel()` 追加時に競合。
- **修正案**: テストに「並列実行不可」のコメントまたはシリアル化追加。

---

### internal/ipc (2件)

#### I-32: `protocol.go` の非 ASCII 矢印記号

- **ファイル**: `internal/ipc/protocol.go`
- **問題**: `Flags → empty map` 等の矢印 `→` が AGENTS.md 規約「ファイルへの書き込みは全て英語」に抵触。
- **修正案**: `->` (ASCII) に置換。

#### I-33: `DefaultPipeName` の "unknown" フォールバック

- **ファイル**: `internal/ipc/protocol.go`
- **問題**: `USERNAME` 空 + `user.Current()` 失敗 → パイプ名 `\\.\pipe\myT-x-unknown` で衝突リスク（極めて稀）。
- **修正案**: コメントでフォールバック仕様と衝突リスクを明記。

---

## Suggestions (34件)

### コメント・ドキュメント改善 (12件)

| ID | 対象ファイル | 内容 |
|----|------------|------|
| S-01 | `app_events.go` | `snapshotEventPolicies` に `// immutable after init` コメント追加。新規イベント追加手順も明記 |
| S-02 | `app_snapshot_delta.go` | `copySnapshotCache` の deep copy 要件と CI 自動検出の提案 |
| S-03 | `app_helpers.go` | `toBytes` のサポート型 (nil/[]byte/string) を godoc で明記 |
| S-04 | `app_lifecycle.go` | `configureGlobalHotkey` の2つの early return の意図コメント |
| S-05 | `app_lifecycle.go` | `toggleQuakeWindow` CAS ガードの状態変化可能性コメント |
| S-06 | `app_panic_recovery.go` | `recoverBackgroundPanic` の「戻り値 = panic 発生有無」を godoc 化 |
| S-07 | `cmd/tmux-shim/model_transform.go` | `applyModelOverride` の2段階フォールスルーの理由コメント |
| S-08 | `frontend/src/hooks/useBackendSync.ts` | `parseConfigUpdatedPayload` の synthetic version 互換対応コメント |
| S-09 | `frontend/src/hooks/useTerminalResize.ts` | hook 呼び出し順序への暗黙依存コメント。`compositionend` の二重登録連携明記 |
| S-10 | `internal/install/shim_cleanup_windows.go` | `CleanupLegacyShimInstalls` が常に nil を返す設計意図（既にコメント済み、十分） |
| S-11 | `cmd/tmux-shim/main.go` | `debugLogFallbackMessage` の到達不能パスコメント |
| S-12 | `app_session_api.go` | `emitWorktreeCleanupFailure` の `err == nil` 時フォールバック防御コメント |

### コード改善 (11件)

| ID | 対象ファイル | 内容 |
|----|------------|------|
| S-13 | `frontend/src/hooks/useWindowRename.ts` | `getRenameInputRef` を `useCallback` でメモ化 |
| S-14 | `internal/tmux/session_manager_env.go` | `paneEnvView()` の copy-on-write 契約を関数コメントに明記 |
| S-15 | テスト共通 | `captureEmitter` パターンを `testutil` パッケージへ共通テストヘルパー化 |
| S-16 | `frontend/` 設定 | `layout.css` 2→4スペース変更。`.editorconfig`/Prettier 統一で diff ノイズ防止 |
| S-17 | `cmd/tmux-shim/model_transform_test.go` | 全テストで `t.Cleanup(resetModelConfigLoadState)` を統一 |
| S-18 | `frontend/src/stores/tmuxStore.ts` | `resolveSessionState` をテスト可能性のため export 検討 |
| S-19 | `frontend/src/hooks/useBackendSync.ts` | `BackendEventMap` の value を具体型に定義（キャスト削減） |
| S-20 | `frontend/src/hooks/useTerminalEvents.ts` | `paneEvent` の `useMemo` は同一 paneId で常に値一致のため除去可 |
| S-21 | `internal/tmux/session_manager_windows.go` | `removeWindowAtIndexLocked` の戻り値4つを構造体にまとめて可読性向上 |
| S-22 | `internal/tmux/command_router.go` | `bestEffortSendKeys` の `appendEnter` が常に true。YAGNI の観点で単純化検討 |
| S-23 | `cmd/tmux-shim/model_transform.go` | `applyFromToReplacement` の `splitModelEqualsArg` パスが実質デッドコード。defense-in-depth として妥当だがテスト追加推奨 |

### テスト補強 (7件)

| ID | 対象ファイル | 内容 |
|----|------------|------|
| S-24 | `internal/config/config_test.go` | `SaveTo` メソッドの直接テスト(tempdir 使用の正常系・異常系) |
| S-25 | `app_events_test.go` | 全登録イベントに対する `shouldEmitSnapshotForEvent` / `shouldBypassSnapshotDebounceForEvent` テスト |
| S-26 | `internal/tmux/session_manager_windows.go` テスト | `removeWindowAtIndexLocked` の境界テスト（survivingWindowID, 最終ウィンドウ削除） |
| S-27 | `internal/install/shim_cleanup_windows_test.go` | stale path cleanup テスト + レジストリ読取失敗時の graceful degradation |
| S-28 | `internal/tmux/session_manager_windows.go` テスト | `fallbackWindowIDNearIndex` の nil エントリスキップ・空配列・全 nil 配列テスト |
| S-29 | `app_session_api.go` テスト | `findAvailableSessionName` の `-2`, `-3` サフィックス上限・境界テスト |
| S-30 | `app_events_test.go` | タイムアウト `2*time.Second` は CI ジッター対策として妥当。CI 安定後に再調整を推奨 |

### Frontend アクセシビリティ (4件)

| ID | 対象ファイル | 内容 |
|----|------------|------|
| S-31 | `frontend/src/components/ConfirmDialog.tsx` | `aria-modal="true"` / `inert` 属性追加でフォーカストラップ堅牢化 |
| S-32 | `frontend/src/components/ConfirmDialog.tsx` | WAI-ARIA ダイアログパターン準拠 (`role="dialog"`, `aria-labelledby`) |
| S-33 | `internal/config/config_test.go` | `ALL` ワイルドカード特別セマンティクスを実装側にもコメント化 |
| S-34 | `internal/tmux/command_router_test.go` | `expectedCommands` のハードコード管理。新コマンド追加時の忘れリスク注意コメント |

---

## Positive Observations（良好な点）

### Architecture & Design
- `snapshotEventPolicy` マップベースで switch 重複排除。OCP 準拠で新イベント追加が1箇所変更で完結
- `handlePaneOutputEvent` の責務分離で Single Responsibility Principle 適合
- TerminalPane の 5 hook 分解は関心の分離として優秀（662行 → 4カスタムフック）
- `RLock` fast path + `Lock` slow path でパフォーマンス最適化しつつ TOCTOU 排除
- `session_manager_targets.go` のターゲット解決リファクタリングでロジック集約化
- `requireSessionsWithPaneID` ヘルパーで7箇所の重複を集約（DRY）
- `ApplyLayoutPreset` の TOCTOU 修正で SessionManager 側にアトミック操作を委譲

### Safety & Robustness
- `disposed` フラグパターンが全 hook に一貫導入。unmount 後のイベントハンドリング安全
- `EventsOn` cancel 関数パターンでリスナーリーク防止が体系化
- `maxPanicRestartRetries` + 指数バックオフで goroutine リーク根本対策
- tmux-shim の `runTransformSafe` による panic recovery + スナップショットロールバック
- `buildPaneEnv` の DRY 化で3箇所の重複ロジックを共通メソッドに抽出
- copy-on-write 戦略の徹底（`ListPanesByWindowTarget` 値コピー、`copyPaneSlice`）
- PATH 操作の安全性ガード（空文字列・whitespace-only・`filepath.Clean(".")`）

### Test Quality
- 構造的不変条件テスト（フィールド数ガード、ポリシー整合性、コマンドスペック一貫性）が体系的
- クローン独立性テストでロック外への参照漏洩を防止
- テーブル駆動テストが一貫適用。tmux-shim テスト 800行超で境界値を網羅
- セキュリティテスト（null byte, 相対パス, パストラバーサル, symlink エスケープ）充実

### Windows Integration
- `shim_cleanup_windows.go` の legacy shim クリーンアップがレジストリ PATH 操作含む包括実装
- `CleanupLegacyShimInstalls` の冪等性設計（エラーを返さず起動を止めない）

---

## 並列作業表

### タスク一覧

| ID | 重要度 | 対象ファイル | 修正内容 | 工数 |
|----|--------|-------------|----------|------|
| C-01 | Critical | `internal/tmux/session_manager_targets.go` | resolveTarget 共通ロジック抽出 | 中 |
| C-02 | Critical | `develop-README.md` | TOCTOU 既知制約の文書化 | 小 |
| C-03 | Critical | `cmd/tmux-shim/main.go` | debugLog 再帰断ち切り | 小 |
| I-01 | Important | `cmd/tmux-shim/spec.go` + `internal/tmux/command_router_handlers_pane.go` | resize-pane 方向フラグ処理 or 警告ログ | 中 |
| I-02 | Important | `internal/tmux/command_router_handlers_pane.go` | handleResizePane スナップショット化 | 小 |
| I-03 | Important | `handlers_display.go`, `handlers_pane.go`, `handlers_session.go` | format 展開ライブポインタ修正 (3箇所) | 中 |
| I-04 | Important | `internal/tmux/command_router_handlers_pane.go` | splitWindowResolved buildPaneEnv 統一 | 小 |
| I-05 | Important | `session_manager_targets.go`, `session_snapshot_delta.go`, `session_manager_pane_io.go` | nil ガード追加 (3箇所) | 小 |
| I-06 | Important | テスト新規作成 | ResolveDirectionalPane テスト | 中 |
| I-07 | Important | `internal/tmux/session_manager_windows.go` | findWindowIndexByID ヘルパー抽出 | 小 |
| I-08 | Important | `internal/tmux/session_manager_windows.go` テスト | removeWindowAtIndexLocked Close 検証テスト | 小 |
| I-09 | Important | `app_pane_feed.go`, `app_lifecycle.go` | ワーカー fatal イベント発行 | 小 |
| I-10 | Important | `app_pane_feed.go`, `app_lifecycle.go` | ワーカーリトライ共通化 or 相互参照コメント | 中 |
| I-11 | Important | `app_pane_feed_test.go` | リトライ上限テスト追加 | 中 |
| I-12 | Important | `app_events.go` | trigger フィールド整理 or コメント | 小 |
| I-13 | Important | `app_lifecycle.go` | ensureShimReady 変数名変更 + コメント | 小 |
| I-14 | Important | `app_pane_feed.go` | runtimeContext ローカル変数化 | 小 |
| I-15 | Important | `app_session_api.go` | emitWorktreeCleanupFailure コメント | 小 |
| I-16 | Important | `app_config_state.go` | getConfigInternalUnsafe 呼び出し元調査 | 小 |
| I-17 | Important | `app_guards.go` | requireSessionsWithPaneID nil ガード | 小 |
| I-18 | Important | `app_pane_feed.go` | enqueuePaneStateFeed 順序コメント | 小 |
| I-19 | Important | `frontend/src/stores/tmuxStore.ts` | setActiveSession activeWindowId 再計算 | 小 |
| I-20 | Important | `frontend/src/hooks/useTerminalFontSize.ts` | 依存配列簡素化 | 小 |
| I-21 | Important | `frontend/src/components/TerminalPane.tsx` 周辺 | hook 依存関係コメント | 小 |
| I-22 | Important | `frontend/src/components/hooks/useWindowRename.ts` | .catch(console.warn) 追加 | 小 |
| I-23 | Important | `frontend/src/types/tmux.ts` | 型ドリフト検証方針検討 | 中 |
| I-24 | Important | `frontend/src/hooks/useBackendSync.ts` | GetConfig catch 後の config 対応 | 小 |
| I-25 | Important | `frontend/src/stores/tmuxStore.ts` | upserts フィルタ追加 | 小 |
| I-26 | Important | `frontend/src/hooks/useBackendSync.ts` | configEventVersionRef コメント | 小 |
| I-27 | Important | `cmd/tmux-shim/model_transform.go` | 正規表現テスト確認 | 小 |
| I-28 | Important | `cmd/tmux-shim/model_transform.go` | applyFromToReplacement 空値ガード | 小 |
| I-29 | Important | `internal/install/shim_cleanup_windows.go` | registry.OpenKey へ変更 | 小 |
| I-30 | Important | `internal/install/shim_cleanup_windows.go` | errors.Is 置換 | 小 |
| I-31 | Important | `internal/install/shim_cleanup_windows_test.go` | 並列安全性コメント | 小 |
| I-32 | Important | `internal/ipc/protocol.go` | 非ASCII矢印をASCII化 | 小 |
| I-33 | Important | `internal/ipc/protocol.go` | DefaultPipeName コメント | 小 |

---

### 並列作業グループと依存関係

同一ファイルを編集するタスクはグループ内で**逐次実行**、グループ間は全て**並列実行可能**。

```
 Group A              Group B              Group C             Group D
 internal/tmux        internal/tmux        App層               App層
 handlers_pane.go     その他               pane_feed.go系      lifecycle.go系
 ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
 │ I-01 (方向)   │    │ C-01 (target)│    │ I-09 (通知)   │    │ I-13 (変数名) │
 │   ↓          │    │ I-05 (nil)   │    │ I-10 (共通化) │    │              │
 │ I-02 (レース) │    │ I-06 (テスト) │    │ I-14 (ctx)   │    └──────────────┘
 │   ↓          │    │ I-07 (helper)│    │ I-18 (コメント)│
 │ I-03 (format)│    │ I-08 (Closeテ)│   │ I-11 (テスト) │
 │   ↓          │    └──────────────┘    └──────────────┘
 │ I-04 (env)   │
 └──────────────┘

 Group E              Group F              Group G             Group H
 App層 その他         Frontend             Frontend            tmux-shim
                      tmuxStore.ts         useBackendSync.ts   model_transform.go
 ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
 │ I-12 (events)│    │ I-19 (winId) │    │ I-24 (catch) │    │ C-03 (再帰)  │
 │ I-15 (session)│   │ I-25 (upserts)│   │ I-26 (comment)│   │ I-27 (regex) │
 │ I-16 (unsafe)│    └──────────────┘    └──────────────┘    │ I-28 (空値)  │
 │ I-17 (guards)│                                            └──────────────┘
 └──────────────┘

 Group I              Group J              Group K             Group L
 Frontend その他      internal/install     internal/ipc        ドキュメント
 ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
 │ I-20 (font)  │    │ I-29 (regkey)│    │ I-32 (arrow) │    │ C-02 (README)│
 │ I-21 (hook)  │    │ I-30 (errIs) │    │ I-33 (pipe)  │    └──────────────┘
 │ I-22 (catch) │    │ I-31 (test)  │    └──────────────┘
 │ I-23 (型方針)│    └──────────────┘
 └──────────────┘
```

---

### 推奨作業フェーズ

優先度と工数のバランスを考慮した推奨順序。各フェーズ内のグループは全て並列実行可能。

#### Phase 1: Critical + 小工数 Important（最優先）

| 担当 | グループ | タスク | 工数合計 |
|------|----------|--------|----------|
| 担当1 | L | C-02 (TOCTOU文書化) | 小 |
| 担当2 | H | C-03 (debugLog再帰) | 小 |
| 担当3 | B | C-01 (resolveTarget抽出) | 中 |
| 担当4 | K | I-32, I-33 (ipc修正) | 小 |
| 担当5 | J | I-29, I-30, I-31 (install修正) | 小 |

#### Phase 2: 機能的影響が大きい Important

| 担当 | グループ | タスク | 工数合計 |
|------|----------|--------|----------|
| 担当1 | A | I-01→I-02→I-03→I-04 (handlers_pane.go) | 中 |
| 担当2 | B | I-05, I-06, I-07, I-08 (tmux nil+テスト) | 中 |
| 担当3 | C | I-09→I-10→I-14→I-18, I-11 (pane_feed系) | 中 |
| 担当4 | F + G | I-19, I-25 (tmuxStore) + I-24, I-26 (backendSync) | 小 |
| 担当5 | H | I-27, I-28 (model_transform) | 小 |

#### Phase 3: App 層その他 + Frontend

| 担当 | グループ | タスク | 工数合計 |
|------|----------|--------|----------|
| 担当1 | D | I-13 (lifecycle) | 小 |
| 担当2 | E | I-12, I-15, I-16, I-17 (app層その他) | 小 |
| 担当3 | I | I-20, I-21, I-22, I-23 (frontend) | 小〜中 |

#### Phase 4: Suggestions（次スプリント候補）

Suggestions は全てオプショナル。優先度の高いものから：
1. S-13〜S-23 (コード改善) — 保守性向上
2. S-24〜S-30 (テスト補強) — 品質向上
3. S-01〜S-12 (コメント改善) — 可読性向上
4. S-31〜S-34 (アクセシビリティ等) — 中長期

---

### ファイル競合マトリクス（同一ファイル編集の注意事項）

以下のファイルは複数タスクが同時に編集するため、**逐次実行が必須**：

| ファイル | 関連タスク | 推奨順序 |
|----------|-----------|----------|
| `command_router_handlers_pane.go` | I-01, I-02, I-03, I-04 | I-01→I-02→I-03→I-04 |
| `app_pane_feed.go` | I-09, I-10, I-14, I-18 | I-09→I-10→I-14→I-18 |
| `app_lifecycle.go` | I-09, I-10, I-13 | I-13 は独立。I-09/I-10 は pane_feed と同時変更 |
| `session_manager_targets.go` | C-01, I-05 (部分) | C-01→I-05 |
| `session_manager_windows.go` | I-07, I-08 | I-07→I-08 |
| `stores/tmuxStore.ts` | I-19, I-25 | 別関数のため並列可だが同ファイル注意 |
| `hooks/useBackendSync.ts` | I-24, I-26 | 別箇所のため並列可だが同ファイル注意 |
| `model_transform.go` | I-27, I-28 | 別関数のため並列可 |
| `shim_cleanup_windows.go` | I-29, I-30 | 同ファイル内で一括修正推奨 |
| `internal/ipc/protocol.go` | I-32, I-33 | 同ファイル内で一括修正推奨 |

---

## レビュー対象外（プロジェクト仕様に基づく）

- 内部 Web 通信の外部公開リスクとしての脆弱性（アプリケーション内部通信のため）
- `go test -race` の指摘（環境セットアップが困難なため）
- 後方互換性の破壊的変更（開発中のため不要）
- tmux-shim の変換失敗時のエラー伝播（原文転送仕様）
- md ファイルの内容レビュー
- オペレーターが直接 Shim を触る事を想定した対応
