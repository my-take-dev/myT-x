# コードレビュー結果

- **レビュー日時**: 2026-02-19 07:54
- **対象**: myT-x 配下の未コミット変更 (57ファイル, +2066/-295行)
- **レビュー方式**: カテゴリ別並列レビュー (6エージェント)

---

## サマリー

| 重要度 | 件数 |
|--------|------|
| Critical | 0 |
| Important | 14 |
| Suggestion | 22 |
| Strength | 20 |

---

## カテゴリ別レビュー結果

### Category 1: App Core (9ファイル, 288行)

対象: `app_config_state.go`, `app_events.go`, `app_guards.go`, `app_helpers.go`, `app_lifecycle.go`, `app_pane_feed.go`, `app_panic_recovery.go`, `app_session_api.go`, `app_snapshot_delta.go`

#### Important

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| AC-I-01 | app_lifecycle.go | retry ループの重複リスク | `startPanicRecoveryLoop` のretryロジック (`maxRetries=3`, `retryDelay=500ms`) がテストの `TestPanicRecoveryLoop_MaxRetriesExceeded` と同じ定数をハードコードしており、一方を変更するとドリフトする。定数を共有するか、テスト側でプロダクションコードの定数を参照すべき。 |

#### Suggestions

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| AC-S-01 | app_events.go | worker-fatal ハンドラのフロントエンド対応確認 | `worker-fatal` イベントを追加しているが、フロントエンド側に対応するハンドラ (`useBackendSync.ts` 等) があるか確認推奨。イベントだけ発行されてUIに反映されないリスク。 |
| AC-S-02 | app_guards.go | trigger=false 時のセマンティクス | `notifyPaneRemoved(trigger=false)` の意味が関数シグネチャから不明瞭。`skipSessionCleanup` 等の名前付き型にすると可読性が向上。 |
| AC-S-03 | app_pane_feed.go | toBytes の aliasing リスク | `toBytes(s string) []byte` が `unsafe.Slice` を使用している場合、返されたバイトスライスを変更すると元の string が破壊される。ConPTY に書き込む用途ならread-onlyのため問題ないが、godoc で注意を明記推奨。 |
| AC-S-04 | app_snapshot_delta.go | TestSnapshotFieldCounts の既存コメント | フィールド数ガードテストのコメントに「already exists」とあるが、テストフレームワーク上の意味が不明。 |

#### Strengths

| ID | タイトル |
|----|----------|
| AC-P-01 | TOCTOU修正 (runtimeContext nilチェック) が正確 |
| AC-P-02 | nilguard の追加が防御的コーディングとして適切 |
| AC-P-03 | worker-fatal イベントの対称的な設計 |

---

### Category 2: App Tests (5ファイル, 297行)

対象: `app_events_test.go`, `app_pane_api_test.go`, `app_panic_recovery_test.go`, `app_snapshot_delta_test.go`, `app_worktree_api_test.go`

#### Important

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| AT-I-01 | app_panic_recovery_test.go | retry定数のドリフトリスク | テストがプロダクションコードと同じ `maxRetries=3`, `retryDelay=500ms` をハードコード。AC-I-01と同一問題の対。 |
| AT-I-02 | app_panic_recovery_test.go | "fewer panics" テストのアサーション不明瞭 | `TestPanicRecoveryLoop_FewerPanics` のアサーション条件が何を検証しているか名前から不明。`TestPanicRecoveryLoop_RecoverAfterPartialPanics` 等に改名推奨。 |

#### Suggestions

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| AT-S-01 | app_panic_recovery_test.go | panicCount=0 のテストケース欠落 | パニックが一度も発生しないケース (正常系) のテストがない。 |
| AT-S-02 | app_events_test.go | trigger=false ポリシーのテスト | `notifyPaneRemoved(trigger=false)` のセッションクリーンアップ非実行を検証するテストケースがあると、AC-S-02の仕様が明文化される。 |
| AT-S-03 | app_pane_api_test.go | 特殊文字セッション名テスト | セッション名にコロン、ドット、`%`を含む場合のテストケースを追加するとターゲット解決のエッジケースカバレッジが向上。 |

#### Missing Tests

| ID | ファイル | タイトル |
|----|----------|----------|
| AT-M-01 | app_pane_api_test.go | whitespace-only paneID のバリデーションテスト |

#### Strengths

| ID | タイトル |
|----|----------|
| AT-P-01 | テーブル駆動テストパターンの一貫した使用 |
| AT-P-02 | PaneContextSnapshot 7→9 フィールド数の正確な更新 |
| AT-P-03 | 境界値テストのカバレッジが優秀 |

---

### Category 3: tmux-shim (4ファイル, 458行)

対象: `cmd/tmux-shim/main.go`, `cmd/tmux-shim/main_test.go`, `cmd/tmux-shim/model_transform.go`, `cmd/tmux-shim/model_transform_test.go`

#### Important

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| TS-I-01 | cmd/tmux-shim/model_transform.go | pruneLogWarning が呼び出し毎に log.New を生成 | `pruneLogWarning` が毎回 `log.New(os.Stderr, ...)` でロガーを生成している。高頻度呼び出しパスで不要なアロケーションが発生する。パッケージレベル変数にロガーを保持すべき。 |

#### Suggestions

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| TS-S-01 | cmd/tmux-shim/main.go | C-03再帰修正の正確性確認 | pruneLogWarning のスタック再帰を排除した修正 (C-03) は正しい。再帰が深くなりすぎる環境で安全。 |
| TS-S-02 | cmd/tmux-shim/model_transform.go | I-28 空値ガードの対称性 | 空文字列ガードが全 format 変数に対称的に適用されており、一貫性が高い。 |

#### Strengths

| ID | タイトル |
|----|----------|
| TS-P-01 | C-03 再帰修正が安全に実装されている |
| TS-P-02 | I-27 regex 分析パターンが正確 |
| TS-P-03 | S-07 の priority ロジックが明確 |
| TS-P-04 | shim仕様への準拠 (エラー時は原文転送) が維持されている |

---

### Category 4: Frontend (10ファイル, 422行)

対象: `ConfirmDialog.tsx`, `TerminalPane.tsx`, `useBackendSync.ts`, `useTerminalEvents.ts`, `useTerminalFontSize.ts`, `useTerminalResize.ts`, `useTerminalSetup.ts`, `useWindowRename.ts`, `tmuxStore.ts`, `types/tmux.ts`

#### Important

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| FE-I-01 | useTerminalFontSize.ts | eslint-disable コメント欠落 | useEffect の依存配列から意図的に除外している変数がある場合、`// eslint-disable-next-line react-hooks/exhaustive-deps` を明記すべき。意図的除外なのかバグなのか判別できない。 |
| FE-I-02 | tmuxStore.ts | activeWindowId 解決ロジックの重複 | `setActiveSession` と `resolveSessionState` で activeWindowId の解決ロジックが重複。一方を変更した場合にもう一方の更新を忘れるリスク。共通ヘルパー関数への抽出推奨。 |
| FE-I-03 | types/tmux.ts | BackendEventMap の型同期ドリフトリスク | Go側イベント名との手動同期が必要。Go側に `worker-fatal` イベントを追加した場合、`BackendEventMap` への追加を忘れるとTypeScript側で型安全性が失われる。CI検証 or コード生成の検討推奨。 |

#### Suggestions

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| FE-S-01 | TerminalPane.tsx | WAI-ARIA 属性の網羅性 | `aria-label` の追加は良いが、`role="region"` や `aria-live` の検討も推奨。ただしターミナルアプリの特性上、過剰な aria は逆効果の可能性あり。 |
| FE-S-02 | useTerminalSetup.ts | Hook 実行順序の INVARIANT コメント | Hook 間の依存関係が INVARIANTコメントで文書化されており優秀。ただし並び替えを防ぐ仕組み (lint rule等) が無いため、新規開発者が無意識に並び替えるリスクは残る。 |
| FE-S-03 | useBackendSync.ts | disposed パターンの統一 | フック内での `disposed` フラグによるクリーンアップが統一されている。`AbortController` パターンへの移行も今後検討可能だが、現状で問題なし。 |

#### Strengths

| ID | タイトル |
|----|----------|
| FE-P-01 | Hook 順序 INVARIANT ドキュメントが優秀 |
| FE-P-02 | disposed パターンがフック間で統一されている |
| FE-P-03 | WAI-ARIA 実装が適切 |
| FE-P-04 | BackendEventMap の型ナローイングが実用的 |

---

### Category 5: Internal Infra (10ファイル, 367行)

対象: `config/config.go`, `config/config_test.go`, `install/shim_cleanup_windows.go`, `install/shim_cleanup_windows_test.go`, `install/shim_installer_windows.go`, `install/shim_installer_windows_test.go`, `install/shim_source_windows.go`, `install/shim_source_windows_test.go`, `ipc/protocol.go`

#### Important

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| II-I-01 | config/config.go | os.IsNotExist → errors.Is 移行の不完全 | `install/` パッケージでは `errors.Is(err, os.ErrNotExist)` に統一されたが、`config/config.go` 内に `os.IsNotExist(err)` が3箇所残っている。同一プロジェクト内で混在するのは一貫性に欠ける。 |

#### Suggestions

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| II-S-01 | install/shim_installer_windows.go | CreateKey → OpenKey の最小権限原則への準拠 | レジストリ操作で `registry.CreateKey` から `registry.OpenKey` への変更は最小権限原則に合致しており適切。 |
| II-S-02 | config/config_test.go | テストカバレッジの網羅性 | config パースエラー時のデフォルトフォールバック動作テストが充実。 |
| II-S-03 | ipc/protocol.go | arrow 文字の ASCII 統一 | Unicode矢印 (`→`) を ASCII (`->`) に統一する変更が一貫して適用されている。 |

#### Strengths

| ID | タイトル |
|----|----------|
| II-P-01 | errors.Is 移行が install/ で完全に実施されている |
| II-P-02 | CreateKey → OpenKey が最小権限原則に準拠 |
| II-P-03 | テストカバレッジが包括的 |

---

### Category 6: Internal tmux (18ファイル, 1540行)

対象: `command_router.go`, `command_router_handlers_display.go`, `command_router_handlers_pane.go`, `command_router_handlers_session.go`, `command_router_handlers_window.go`, `command_router_test.go`, `format.go`, `session_manager_directional_test.go` (新規), `session_manager_env.go`, `session_manager_env_test.go`, `session_manager_pane_io.go`, `session_manager_panes.go`, `session_manager_sessions.go`, `session_manager_snapshot.go`, `session_manager_targets.go`, `session_manager_test.go`, `session_manager_window_test.go`, `session_manager_windows.go`

#### Important

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| IT-I-01 | session_manager_targets.go | resolveTargetCore: `(nil, true, nil, nil)` 戻り値の契約曖昧性 | `target==""` かつ `callerPaneID < 0` の場合、`needsSessionResolve=true` だが `session=nil`。呼び出し元は `defaultPane*Locked` にフォールバックするので動作は正しいが、将来の呼び出し元が `session!=nil` をアサートして panic する可能性。godocに明記するか戻りパターンを分離推奨。 |
| IT-I-02 | session_manager_panes.go | applyLayoutPresetToWindowLocked の nil ガード欠落 | 他の箇所に nil ガードを追加したが、`applyLayoutPresetToWindowLocked` 内の `for i, pane := range window.Panes { paneIDs[i] = pane.ID }` に nil ガードがない。`pane==nil` で panic する。**同パターンの適用漏れ**。 |
| IT-I-03 | session_manager_targets.go | ResolveDirectionalPane: defaultPaneLocked 後の Window==nil チェック欠落 | `callerPaneID < 0` でデフォルトペイン解決後、ペインの `Window` が nil の可能性をチェックしていない。他の nil ガードとの防御の一貫性が欠落。 |
| IT-I-04 | session_manager_targets.go | ResolveDirectionalPane: nil ペインのスキップ不足 | `panes` スライス内に nil エントリが存在した場合、インデックス操作で nil ペインに着地する可能性。最終行で `candidate==nil` チェックはあるがエラー返却のみ。nil をスキップして次の有効ペインに進むほうがロバスト。 |
| IT-I-05 | format.go | expandFormatSafe: GetPaneContextSnapshot → GetSession 間の micro-TOCTOU | 2つの RLock 間でセッション名が `RenameSession` で変更された場合、`GetSession` が元の名前で検索失敗し nil フォールバック。実害はフォーマット文字列の空文字列化のみ。コメント上「TOCTOU-safe」と標榜しているため、この micro-gap の存在を補足コメントで明記すべき。 |
| IT-I-06 | session_manager_pane_io.go | ListPanesByWindowTarget が resolveTargetCore を使っていない | resolveTargetCore (C-01) でターゲット解決を統一したが、`ListPanesByWindowTarget` は依然として独自実装。次のリファクタリング候補として記録推奨。 |

#### Suggestions

| ID | ファイル | タイトル | 詳細 |
|----|----------|----------|------|
| IT-S-01 | session_manager_windows.go | removeWindowResult の unexported 型名 | 現在は internal パッケージ内のみの使用なので問題ないが、将来外部から参照する場合は exported 化が必要。 |
| IT-S-02 | session_manager_directional_test.go | テスト内の mu.RLock 直接アクセス | テストが `manager.mu.RLock()` でライブポインタに直接アクセスしている。公開 API 経由の検証が望ましい。 |
| IT-S-03 | session_manager_directional_test.go | 複数ウィンドウ間のスコープ分離テスト欠落 | 異なるウィンドウのペインに対する方向ナビゲーションのスコープ分離テストがない。ウィンドウ内限定ナビゲーションの仕様明文化に有用。 |
| IT-S-04 | command_router_handlers_pane.go | buildPaneEnv 統一後の isBlockedEnvironmentKey 適用範囲変更 | 旧コードは extraEnv のみフィルタ、新コードは targetCtx.Env も含めてフィルタ。動作は正しいが意図的変更か確認推奨。 |
| IT-S-05 | session_manager_windows.go | findWindowIndexByID と findWindowByID の統合可能性 | 用途が異なるので分離は合理的だが、共通の内部イテレータでの統一余地あり。低優先度。 |
| IT-S-06 | command_router_handlers_pane.go | handleResizePane の postCtx セッション名変更ケース | pane ID は単調増加で再利用されないため実際には発生しない。コメント補足で十分。 |
| IT-S-07 | session_manager_env.go | PaneWidth/PaneHeight フィールドのテスト欠落 | `PaneContextSnapshot` に新フィールドが追加されたが、`session_manager_env_test.go` で検証するテストケースがない。handleResizePane が依存するフィールドなのでテスト追加推奨。 |

#### Strengths

| ID | タイトル |
|----|----------|
| IT-P-01 | resolveTargetCore 抽出 (C-01) が正確に等価変換されている |
| IT-P-02 | removeWindowResult の struct 化による API 可読性向上 |
| IT-P-03 | nil ガード追加パターンが一貫している (continue パターン統一) |
| IT-P-04 | expandFormatSafe の TOCTOU 対策パターンが適切 |
| IT-P-05 | buildPaneEnv 統一 (I-04) による env 構築の一貫性確保 |
| IT-P-06 | ResolveDirectionalPane テストの網羅性が高い |
| IT-P-07 | トラッキング ID 付きコメントの品質が優秀 |

---

## 横断的分析

### 1. nil ガード適用漏れ一覧

今回の差分で nil ガードが追加されたが、以下に適用漏れがある:

| ファイル | 箇所 | 対応状況 |
|----------|------|----------|
| session_manager_panes.go | `applyLayoutPresetToWindowLocked` の pane ループ | **未対応 (IT-I-02)** |
| session_manager_targets.go | `ResolveDirectionalPane` の Window nil チェック | **未対応 (IT-I-03)** |
| session_manager_targets.go | `ResolveDirectionalPane` の panes nil スキップ | **未対応 (IT-I-04)** |

### 2. 定数ドリフトリスク

| プロダクションコード | テストコード | リスク |
|---------------------|--------------|--------|
| `app_lifecycle.go` maxRetries=3, retryDelay=500ms | `app_panic_recovery_test.go` 同値ハードコード | **ドリフト (AC-I-01 / AT-I-01)** |

### 3. errors.Is 移行の不完全

| パッケージ | 移行状況 |
|-----------|----------|
| install/ | ✅ 完全移行 |
| config/ | ❌ os.IsNotExist 3箇所残存 (II-I-01) |

---

## タスク整理と並列作業可否

以下は指摘事項を修正タスクとして整理し、並列作業の可否を評価した表です。

### 修正タスク一覧

| # | タスクID | 対象ファイル | 修正内容 | 重要度 | 推定工数 |
|---|---------|-------------|----------|--------|---------|
| 1 | IT-I-02 | session_manager_panes.go | applyLayoutPresetToWindowLocked に nil ガード追加 | Important | 小 |
| 2 | IT-I-03 | session_manager_targets.go | ResolveDirectionalPane に Window nil チェック追加 | Important | 小 |
| 3 | IT-I-04 | session_manager_targets.go | ResolveDirectionalPane で nil ペインをスキップ | Important | 小 |
| 4 | IT-I-01 | session_manager_targets.go | resolveTargetCore の godoc コメント補強 | Important | 小 |
| 5 | IT-I-05 | format.go | expandFormatSafe のコメント micro-TOCTOU 補足 | Important | 小 |
| 6 | IT-I-06 | session_manager_pane_io.go | ListPanesByWindowTarget の resolveTargetCore 統一 (次期候補) | Important | 中 |
| 7 | II-I-01 | config/config.go | os.IsNotExist → errors.Is 3箇所修正 | Important | 小 |
| 8 | AC-I-01 / AT-I-01 | app_lifecycle.go, app_panic_recovery_test.go | retry 定数の共有化 | Important | 小 |
| 9 | FE-I-01 | useTerminalFontSize.ts | eslint-disable コメント追加 | Important | 小 |
| 10 | FE-I-02 | tmuxStore.ts | activeWindowId 解決ロジック共通化 | Important | 中 |
| 11 | FE-I-03 | types/tmux.ts | BackendEventMap 型同期のCI検討 (記録のみ) | Important | 大 |
| 12 | TS-I-01 | cmd/tmux-shim/model_transform.go | pruneLogWarning のロガーをパッケージ変数化 | Important | 小 |
| 13 | IT-S-07 | session_manager_env_test.go | PaneWidth/PaneHeight テスト追加 | Suggestion | 小 |
| 14 | IT-S-03 | session_manager_directional_test.go | 複数ウィンドウ方向ナビゲーションテスト追加 | Suggestion | 中 |
| 15 | AT-S-01 | app_panic_recovery_test.go | panicCount=0 テストケース追加 | Suggestion | 小 |
| 16 | AT-S-03 | app_pane_api_test.go | 特殊文字セッション名テスト追加 | Suggestion | 小 |

### 並列作業可否マトリクス

各タスクが同時に並列作業可能かを評価しました。  
**◯** = 並列作業OK (ファイル競合なし)  
**✕** = 並列作業NG (同一ファイル編集で競合)  
**△** = 条件付き並列可 (変更箇所が離れている場合のみ)

| 作業者 | タスク | 並列可能なタスク | 競合するタスク | 備考 |
|--------|-------|-----------------|---------------|------|
| A | #1 (panes.go nil ガード) | #4,#5,#6,#7,#8,#9,#10,#12,#13,#14,#15,#16 | **#2,#3** (同じtargets.go触るが別ファイル→◯) | 独立して作業可能 |
| B | #2+#3+#4 (targets.go 3件まとめ) | #1,#5,#6,#7,#8,#9,#10,#12,#13,#14,#15,#16 | なし | **同一ファイル3件はまとめて作業推奨** |
| C | #5 (format.go コメント) | #1,#2,#3,#4,#6,#7,#8,#9,#10,#12,#13,#14,#15,#16 | なし | 独立して作業可能 |
| D | #7 (config.go errors.Is) | #1,#2,#3,#4,#5,#6,#8,#9,#10,#12,#13,#14,#15,#16 | なし | 独立して作業可能 |
| E | #8 (retry定数共有) | #1,#2,#3,#4,#5,#6,#7,#9,#10,#12,#13,#14 | **#15** (同テストファイル) | #15も含めてまとめて作業推奨 |
| F | #9+#10 (Frontend 2件) | #1,#2,#3,#4,#5,#6,#7,#8,#12,#13,#14,#15,#16 | **#11** (types同ファイル群) | Frontend系はまとめて作業推奨 |
| G | #12 (shim ロガー) | #1,#2,#3,#4,#5,#6,#7,#8,#9,#10,#13,#14,#15,#16 | なし | 独立して作業可能 |
| H | #6 (pane_io.go リファクタ) | #1,#2,#3,#4,#5,#7,#8,#9,#10,#12,#15,#16 | **#13,#14** (テスト追加時の整合性) | 次期リファクタリング候補。今回は記録のみでもOK |
| I | #13+#14 (テスト追加) | #1,#5,#7,#8,#9,#10,#12,#15,#16 | **#2,#3,#4** (targets/env系のテスト) | targets.go修正(#2-4)完了後が安全 |

### 推奨作業グループ (最大並列度)

以下のグループは**全て同時に並列作業可能**です:

| グループ | タスク | 担当範囲 | 推定工数 |
|---------|-------|---------|---------|
| **G1** | #1 | session_manager_panes.go | 小 |
| **G2** | #2 + #3 + #4 | session_manager_targets.go (3件まとめ) | 小〜中 |
| **G3** | #5 | format.go | 小 |
| **G4** | #7 | config/config.go | 小 |
| **G5** | #8 + #15 | app_lifecycle.go + app_panic_recovery_test.go | 小 |
| **G6** | #9 + #10 | Frontend (useTerminalFontSize.ts + tmuxStore.ts) | 中 |
| **G7** | #12 | cmd/tmux-shim/model_transform.go | 小 |

**G1〜G7 は全て並列作業可能** (ファイル競合なし)

#### 順次作業が必要なもの

| 順序 | タスク | 理由 |
|------|-------|------|
| G2完了後 → | #13 + #14 (テスト追加) | targets.go の修正が完了してからテスト追加が安全 |
| 最後 → | #6 (pane_io リファクタ) | 他の修正が安定してから実施すべき中規模リファクタ |
| 記録のみ → | #11 (BackendEventMap CI) | 大規模対応。今回のスコープ外として記録 |

---

## 総評

### 良い点
- **TOCTOU修正パターン**が一貫しており、ライブポインタ→スナップショットへの置き換えが体系的
- **resolveTargetCore抽出 (C-01)** が正確な等価変換で、バグ修正の自動伝播が実現されている
- **removeWindowResult** のstruct化でAPI可読性が大幅に向上
- **nilガード追加**が防御的コーディングとして一貫している（1箇所の漏れあり）
- **ResolveDirectionalPaneテスト**の網羅性が高い
- **buildPaneEnv統一 (I-04)** でenv構築ロジックの散在が解消
- **トラッキングID付きコメント** (I-01, I-02, C-01等) が設計意図の追跡に有効
- **Hook順序INVARIANTドキュメント** (Frontend) が優秀

### 改善すべき点
- **nilガード適用漏れ** (`applyLayoutPresetToWindowLocked`) — 最優先対応
- **resolveTargetCore戻り値契約**の曖昧性 — godoc明記
- **errors.Is移行の不完全** (`config.go`) — 一貫性のため修正
- **retry定数の共有化** — テスト/プロダクション間のドリフト防止
- **expandFormatSafe** のコメント正確性 — micro-TOCTOU の存在明記
