# PR Review Summary — 2026-02-19

**対象**: myT-x 配下の全変更ファイル (57 files, +1742/-295)  
**レビュー方式**: カテゴリ別6エージェント並列レビュー + クロスカッティング検証  

## レビューカテゴリ

| # | カテゴリ | 対象ファイル数 | レビュー結果 |
|---|---------|-------------|------------|
| 1 | App層 Goコード | 10 | Critical: 0, Important: 2, Suggestion: 4 |
| 2 | tmux-shim | 4 | Critical: 0, Important: 0, Suggestion: 4 |
| 3 | フロントエンド (React/TS) | 9 | Critical: 0, Important: 3, Suggestion: 5 |
| 4 | Internal packages (config/install/ipc) | 12 | Critical: 0, Important: 3, Suggestion: 3 |
| 5 | Internal tmux | 12 | Critical: 0, Important: 3, Suggestion: 5 |
| 6 | クロスカッティング | 全体 | Critical: 0, Important: 3, Suggestion: 1 |

---

## Critical Issues (0件)

クリティカルなバグは検出されませんでした。

---

## Important Issues (10件)

### IMP-01: `tmux:worker-fatal` イベントがフロントエンドで未ハンドリング

**重要度**: ★★★  
**ファイル**: `myT-x/app_lifecycle.go` (L352), `myT-x/app_pane_feed.go` (L122), `myT-x/frontend/src/hooks/useBackendSync.ts`  
**カテゴリ**: クロスカッティング（バックエンド-フロントエンド連携）

**問題**: バックエンドで `tmux:worker-fatal` イベントが2箇所（idle-monitor, pane-feed-worker）で新規発行されているが、フロントエンドの `BackendEventMap` にエントリがなく、`EventsOn` による購読も存在しない。ワーカーが永続的に停止してもユーザーに通知されない。

**推奨対応**: `useBackendSync.ts` の `BackendEventMap` に `"tmux:worker-fatal": { worker?: string; maxRetries?: number }` を追加し、`onEvent("tmux:worker-fatal", ...)` でユーザーに「バックグラウンドワーカーが停止しました。アプリの再起動を推奨します」等の通知を表示する。

---

### IMP-02: `SwapPanes` の pane nil ガード欠落

**重要度**: ★★★  
**ファイル**: `myT-x/internal/tmux/session_manager_pane_lifecycle.go` (L46-65)  
**カテゴリ**: internal/tmux — nilガード一貫性

**問題**: 今回の差分で他の全 `range window.Panes` サイトに `if pane == nil { continue }` を追加しているが、`SwapPanes` の2つのループには適用されていない。`pane.ID`, `pane.Index`, `pane.Active` への直接アクセスがあり、nil pane が存在する場合にパニックする。

**推奨対応**: `SwapPanes` の両ループに `if pane == nil { continue }` を追加。

```go
// 1st loop (L46)
for i, pane := range window.Panes {
    if pane == nil { continue }  // ← 追加
    switch pane.ID {

// 2nd loop (L59)
for _, pane := range window.Panes {
    if pane == nil { continue }  // ← 追加
    pane.Index = idx
```

---

### IMP-03: `applyLayoutPresetToWindowLocked` の pane nil ガード欠落

**重要度**: ★★☆  
**ファイル**: `myT-x/internal/tmux/session_manager_panes.go` (L148)  
**カテゴリ**: internal/tmux — nilガード一貫性

**問題**: `applyLayoutPresetToWindowLocked` の `window.Panes` イテレーションで pane nil チェックがない。他の全サイトとの一貫性が欠けている。

**推奨対応**: `if pane == nil { continue }` を追加。

---

### IMP-04: `config.go` 内の `os.IsNotExist` が未移行

**重要度**: ★★☆  
**ファイル**: `myT-x/internal/config/config.go` (L189, L230, L351)  
**カテゴリ**: internal/config — errors.Is 一貫性

**問題**: `install/` パッケージでは `errors.Is(err, os.ErrNotExist)` への移行が完了しているが、`config.go` 内に `os.IsNotExist()` が3箇所残存。ラップされたエラーを正しく判定できない。

**推奨対応**: 3箇所を `errors.Is(err, os.ErrNotExist)` に統一。

---

### IMP-05: `useTerminalFontSize` の `eslint-disable` コメント欠落

**重要度**: ★★☆  
**ファイル**: `myT-x/frontend/src/hooks/useTerminalFontSize.ts` (L107)  
**カテゴリ**: フロントエンド — ESLint整合性

**問題**: 第2 `useEffect` の依存配列から `terminalRef`, `fitAddonRef`, `fontSizeRef` を除外しているが、`eslint-disable-next-line react-hooks/exhaustive-deps` が付いていない。除外理由は妥当（`useRef` の返り値は安定参照）だが、ESLintルール有効時に警告が発生する。同ファイルの第1 `useEffect` には付いている。

**推奨対応**: `eslint-disable-next-line react-hooks/exhaustive-deps` を追加。

---

### IMP-06: `BackendEventMap` の型絞り込みとランタイムガードの乖離リスク

**重要度**: ★★☆  
**ファイル**: `myT-x/frontend/src/hooks/useBackendSync.ts` (L19-31)  
**カテゴリ**: フロントエンド — 型安全性

**問題**: `BackendEventMap` でイベントペイロードの型が `unknown` から具体型に絞り込まれたが、`EventsOn` のランタイムペイロードは依然 `unknown`。現在は全ハンドラで `asObject`/`asArray` ガードが実装されているため安全だが、新イベント追加時に「静的型があるからランタイム検証不要」と誤解するリスクがある。

**推奨対応**: `BackendEventMap` または `onEvent` ヘルパーの直近に以下コメントを追加:
```typescript
// IMPORTANT: These types are compile-time documentation only.
// EventsOn delivers `unknown` at runtime — every handler MUST still
// validate with asObject/asArray before accessing properties.
```

---

### IMP-07: `handleListWindows` の window nil ガード不足

**重要度**: ★☆☆  
**ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go` (L153)  
**カテゴリ**: internal/tmux — nilガード一貫性

**問題**: `handleListWindows` の `range session.Windows` に明示的な `if window == nil { continue }` がない。`formatWindowLine` 内部でnilチェックされており実害はないが、他の全サイトとの一貫性が欠けている。

**推奨対応**: 一貫性のため `if window == nil { continue }` を追加。

---

### IMP-08: `emitWorktreeCleanupFailure` のコメント不正確

**重要度**: ★☆☆  
**ファイル**: `myT-x/app_session_api.go` (L326-328)  
**カテゴリ**: App層 — コメント正確性

**問題**: コメントに「The error is still logged **above** for post-mortem diagnostics」とあるが、実際にエラーを記録しているのは**下の** `slog.Warn` 行自体。関数上部に `err` をログ出力する処理は存在しない。

**推奨対応**: "above" → "in the slog.Warn below" に修正。

---

### IMP-09: `getRenameInputRef` のキャッシュ効果が限定的

**重要度**: ★☆☆  
**ファイル**: `myT-x/frontend/src/hooks/useWindowRename.ts` (L93-113)  
**カテゴリ**: フロントエンド — パフォーマンス

**問題**: `lastRefCallbackRef` は直前1件のみキャッシュ。ウィンドウリスト `[1,2,3]` のイテレーションで `getRenameInputRef(1)` → `getRenameInputRef(2)` → `getRenameInputRef(3)` と呼ばれるたびにキャッシュミスし、結局全ウィンドウで新関数が生成される。キャッシュの効果がほぼない。

**ステールクロージャのリスクはなし**（キャッシュキーに `renamingWindowId` を含み正しい）。ウィンドウ数が少ないデスクトップアプリのため実害は軽微。

**推奨対応**: `Map<number, fn>` ベースのキャッシュに変更するか、元のシンプルな実装に戻すか検討。現状でも機能に問題なし。

---

### IMP-10: `ensurePathContains` の `CreateKey` にコメント不足

**重要度**: ★☆☆  
**ファイル**: `myT-x/internal/install/shim_path_windows.go`  
**カテゴリ**: internal/install — ドキュメント一貫性

**問題**: cleanup系関数に `// OpenKey (not CreateKey): this is a read/update-only operation.` と明記された今、`ensurePathContains` の `CreateKey` にも対称的なコメントが欲しい。なぜ `OpenKey` ではなく `CreateKey` なのかを明記することで保守性が向上する。

**推奨対応**: コメント追加:
```go
// CreateKey (not OpenKey): this function may need to create the Environment
// key on fresh Windows installs where it doesn't exist yet.
```

---

## Suggestions (13件)

### SUG-01: ワーカーリカバリループの共通化検討

**ファイル**: `myT-x/app_lifecycle.go` (L281), `myT-x/app_pane_feed.go` (L67)

CROSS-REF コメントで「両方更新せよ」と注記しているが、ワーカーが3つ以上になった場合は `runWithPanicRecovery(ctx, worker, workerFunc)` への抽出を推奨。現フェーズではコメントで十分。

---

### SUG-02: `ensureShimReady` の変数名対称性

**ファイル**: `myT-x/app_lifecycle.go` (L195-210)

`err` → `preCheckErr` に変更すると、`postCheckErr` との対称性が向上し、コメント説明も不要になる。

---

### SUG-03: sentinel error の使用

**ファイル**: `myT-x/app_guards.go` (L37-39)

`requireSessionsWithPaneID` の nil ガードエラーをsentinel error (`var errNilPaneID = errors.New(...)`) にし、テストで `errors.Is()` を使うとGoらしいパターン。

---

### SUG-04: `copySnapshotCache` コメントの「Consider adding」修正

**ファイル**: `myT-x/app_snapshot_delta.go` (L259-261)

`TestSnapshotFieldCounts` は既に存在しているため、「Consider adding」→「See TestSnapshotFieldCounts which guards against this」に修正。

---

### SUG-05: レビュー指摘符号のマッピングテーブル

**ファイル**: コードベース全体

C-01, C-03, S-07, S-11, S-23, I-27, I-28 等の符号が多数使われているが、定義元のドキュメントがない。`develop-README.md` 等にマッピングテーブルを記載すると保守性向上。

---

### SUG-06: `pruneLogWarning` の `log.Logger` 毎回生成

**ファイル**: `myT-x/cmd/tmux-shim/main.go` (L422)

毎回 `log.New()` でロガーを生成している。短命プロセスのため実害はないが、パッケージレベル変数にする選択肢あり。

---

### SUG-07: `applySessionDelta` の `removed` 配列にもランタイムガード追加

**ファイル**: `myT-x/frontend/src/stores/tmuxStore.ts` (L84)

`upserts` にはガードがあるが `removed` 配列の要素には検証がない。`null` が混入した場合 `byName.delete(null)` は no-op だが、`undefined` は `"undefined"` キーとして動作する。

---

### SUG-08: `resolveTargetCore` 返値契約のドキュメント補強

**ファイル**: `myT-x/internal/tmux/session_manager_targets.go`

`needsSessionResolve == true` の場合 `pane` は常に nil であることをコメントに明記すべき。将来の呼び出し元が `pane` だけを使うリスクがある。

---

### SUG-09: `removeWindowResult.SurvivingWindowID` の zero value 安全性

**ファイル**: `myT-x/internal/tmux/session_manager_windows.go`

zero value `0` は ID=0 のウィンドウと区別不能。エラー時に `-1` を設定する設計は正しいが、認識しておくべき。

---

### SUG-10: `copy-on-read INVARIANT` コメントに `SetPaneEnv` の言及追加

**ファイル**: `myT-x/internal/tmux/session_manager_env.go`

invariant コメントは読み取り側の契約のみ言及。`SetPaneEnv` も `copyEnvMap(env)` で書き込み時コピーしていることを注記に含めると完全。

---

### SUG-11: Unicode矢印 `→` の ASCII `->` への統一

**ファイル**: `app_helpers.go`, `app_worktree_api.go`, `internal/tmux/parse.go`, `internal/panestate/manager.go` 等 (計10箇所)

diff内で一部 `→` → `->` 変更があるが、他に10箇所の `→` が残存。全てコメント内で実行時影響はないが、統一推奨。

---

### SUG-12: `app_events.go` の `syncPaneStates` に nil ガード追加

**ファイル**: `myT-x/app_events.go` (L305-306)

`range session.Windows` と `range window.Panes` に nil ガードがない。スナップショット（値型）を受け取るため nil が入る可能性は低いが、防御的には追加が望ましい。

---

### SUG-13: `os.IsNotExist` 残存箇所の統一移行

**ファイル**: `app_worktree_api.go` (8箇所), `cmd/tmux-shim/main.go` (4箇所), `internal/git/validation.go` (2箇所)

diff範囲外だが、`install/` での移行と一貫性を持たせるため、プロジェクト全体での `errors.Is(err, os.ErrNotExist)` 移行を推奨。

---

## Strengths (良い点)

1. **TOCTOU修正の的確さ**: `runtimeContext()` を一度変数に格納してからnilチェック・使用する修正が `startIdleMonitor` と `startPaneFeedWorker` の両方に一貫して適用。シャットダウン時の競合を正しく防止。

2. **`expandFormatSafe` の設計**: データ競合排除のために RLock-safe スナップショット → ディープクローン → クローン内検索 → 安全な展開という4段階パイプラインは堅実。

3. **`resolveTargetCore` のリファクタリング (C-01)**: 約50行の重複ロジックを統合し、バグ修正の伝播を保証。RLock/Lock の2パスで同一コアロジックを使用。

4. **`removeWindowResult` 構造体化**: 4値タプル `([]*TmuxPane, bool, int, error)` から名前付きフィールドへの移行で可読性が大幅向上。ownership contract コメントも適切。

5. **無限再帰修正 (C-03)**: `debugLog` → `pruneLogWarning` への分離で、ログローテーション時の再帰を安全に回避。

6. **WAI-ARIA ダイアログパターン**: `ConfirmDialog` の `useId()` + `role="dialog"` + `aria-modal` + `aria-labelledby`/`aria-describedby` は模範的実装。

7. **Hook呼び出し順序 INVARIANT の文書化**: `useTerminalSetup` → `useTerminalEvents` → `useTerminalResize` / `useTerminalFontSize` の暗黙的依存関係が各フックと親コンポーネントの両方に文書化。

8. **防御的コーディングの対称性 (I-28)**: `applyFromToReplacement` の空値ガードが `applyModelOverride` と対称的に実装。

9. **`CreateKey` → `OpenKey` の正確な使い分け**: cleanup系は読取/更新のみのため `OpenKey`、PATH追加の `ensurePathContains` は書き込み可能性のため `CreateKey` を維持。権限最小化原則に適合。

10. **テストカバレッジ**: `findWindowIndexByID` のテーブル駆動テスト、境界値テスト、ownership contract テスト等、テストの質と量が充実。

---

## タスク一覧と並列作業可否

以下は、指摘事項を修正する際の作業タスク一覧と、各タスク間の依存関係・並列作業の可否をまとめた表です。

### 凡例
- **並列可**: 他のタスクと同時に作業可能（ファイル・ロジックが独立）
- **並列不可**: 他タスクと依存があり、順序を守る必要あり
- **依存先**: そのタスクを先に完了する必要がある先行タスク

| タスクID | 概要 | 対象ファイル | 重要度 | 作業難度 | 並列可否 | 依存先 | 備考 |
|---------|------|-----------|--------|---------|---------|--------|------|
| T-01 | `tmux:worker-fatal` フロントエンドハンドラ追加 | `useBackendSync.ts` | ★★★ | 低 | **並列可** | なし | `tmux:worker-panic` の実装を参考に同パターンで追加 |
| T-02 | `SwapPanes` に pane nil ガード追加 | `session_manager_pane_lifecycle.go` | ★★★ | 低 | **並列可** | なし | 2箇所のループに `if pane == nil { continue }` |
| T-03 | `applyLayoutPresetToWindowLocked` に pane nil ガード追加 | `session_manager_panes.go` | ★★☆ | 低 | **並列可** | なし | 1箇所の追加 |
| T-04 | `config.go` の `os.IsNotExist` → `errors.Is` 移行 | `config.go` | ★★☆ | 低 | **並列可** | なし | 3箇所の置換 |
| T-05 | `useTerminalFontSize` に eslint-disable 追加 | `useTerminalFontSize.ts` | ★★☆ | 低 | **並列可** | なし | 1行のコメント追加 |
| T-06 | `BackendEventMap` に型ガード注意コメント追加 | `useBackendSync.ts` | ★★☆ | 低 | **並列不可** | T-01 | T-01と同ファイル修正のため順次作業推奨 |
| T-07 | `handleListWindows` に window nil ガード追加 | `command_router_handlers_window.go` | ★☆☆ | 低 | **並列可** | なし | 1箇所の追加 |
| T-08 | `emitWorktreeCleanupFailure` コメント修正 | `app_session_api.go` | ★☆☆ | 低 | **並列可** | なし | "above" → 適切な表現に変更 |
| T-09 | `ensurePathContains` の `CreateKey` コメント追加 | `shim_path_windows.go` | ★☆☆ | 低 | **並列可** | なし | コメント1行追加 |
| T-10 | `copySnapshotCache` コメント修正 | `app_snapshot_delta.go` | ★☆☆ | 低 | **並列可** | なし | "Consider adding" → "See TestSnapshotFieldCounts" |

### 推奨作業順序

```
Phase 1 (並列実行可能 — 全て独立):
  T-01, T-02, T-03, T-04, T-05, T-07, T-08, T-09, T-10

Phase 2 (Phase 1 の T-01 完了後):
  T-06
```

### 並列作業の依存関係図

```
T-02 ──┐
T-03 ──┤
T-04 ──┤
T-05 ──┤  (全て独立 — 並列OK)
T-07 ──┤
T-08 ──┤
T-09 ──┤
T-10 ──┘

T-01 ──→ T-06  (同一ファイル依存)
```

### 作業者向けガイド

| 区分 | タスク群 | 推定修正行数 | 特記事項 |
|------|---------|------------|---------|
| **Go バックエンド** | T-02, T-03, T-04, T-07, T-08, T-09, T-10 | ~20行 | 全て独立。1人で順次作業しても短時間。2人で分担する場合は tmux系(T-02,T-03,T-07) と app系(T-04,T-08,T-09,T-10) で分割 |
| **フロントエンド** | T-01, T-05, T-06 | ~15行 | T-01 → T-06 は依存。T-05 は独立 |

---

## 総評

本差分は以下の3カテゴリで構成される品質改善・防御的強化の変更セットです：

1. **TOCTOU修正・データ競合防止**: `runtimeContext()` のローカル変数化、`expandFormatSafe` のクローンベース設計
2. **防御的コーディング**: nil ガードの体系的追加、空値ガードの対称的実装、`CreateKey` → `OpenKey` の権限最小化
3. **可読性・保守性向上**: `removeWindowResult` 構造体化、`resolveTargetCore` のDRY化、WAI-ARIAパターン、Hook順序の文書化

**致命的なバグは検出されず**、指摘事項は主にnilガードの追加漏れ（一貫性）、フロントエンドイベントハンドラの未実装、コメントの正確性に関するものです。全体として高品質な変更セットであり、上記10件のImportant指摘を対応すれば安心してコミット可能です。
