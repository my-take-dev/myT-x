# Consolidated PR Review — 2026-02-19

**対象**: `myT-x/` 配下の全変更ファイル（57ファイル, +1742/-295行）  
**統合元**: review-20260219075431, review-20260219075958, review-20260219140000  
**レビュー方式**: 3回のカテゴリ別並列レビュー結果を重複排除して統合

---

## サマリー

| 重要度 | 件数 |
|--------|------|
| Critical | 0 |
| Important | 23 |
| Suggestion | 24 |

---

## Critical Issues（0件）

致命的なバグ、データ損失、クラッシュを引き起こす問題は検出されませんでした。

---

## Important Issues（23件）

### ■ カテゴリ A: Nil ガード漏れ（一貫性）

#### IMP-A01: `SwapPanes` の pane nil ガード欠落
- **ファイル**: `internal/tmux/session_manager_pane_lifecycle.go` L46-67
- **検出**: 3レビュー中2件で指摘（一致）
- **内容**: 今回の差分で他の全 `range window.Panes` サイトに `if pane == nil { continue }` を追加しているが、`SwapPanes` の2つのループには未適用。`pane.ID`, `pane.Index`, `pane.Active` への直接アクセスがあり、nil pane で panic する。
- **修正案**:
```go
// 1st loop (L46)
for i, pane := range window.Panes {
    if pane == nil { continue }
    switch pane.ID {
// 2nd loop (L59)
for _, pane := range window.Panes {
    if pane == nil { continue }
    pane.Index = idx
```

#### IMP-A02: `applyLayoutPresetToWindowLocked` の pane nil ガード欠落
- **ファイル**: `internal/tmux/session_manager_panes.go` L121-127
- **検出**: 3レビュー全てで指摘（最多検出）
- **内容**: `paneIDs[i] = pane.ID` で nil pane により panic。同ファイルの `SetActivePane` には追加済みで不整合。
- **修正案**: `pane == nil` → `continue` + `paneIDs` を `append` 方式に変更

#### IMP-A03: `handleListWindows` の window nil ガード不足
- **ファイル**: `internal/tmux/command_router_handlers_window.go` L146-153
- **検出**: 3レビュー中2件で指摘
- **内容**: `range session.Windows` に `if window == nil { continue }` がない。`formatWindowLine` 内部でnilチェックされており実害は低いが、他の全サイトとの一貫性が欠けている。

#### IMP-A04: `ResolveDirectionalPane` の Window nil チェック欠落
- **ファイル**: `internal/tmux/session_manager_targets.go`
- **検出**: 1レビューで指摘
- **内容**: `callerPaneID < 0` でデフォルトペイン解決後、ペインの `Window` が nil の可能性をチェックしていない。他の nil ガードとの防御の一貫性が欠落。

#### IMP-A05: `ResolveDirectionalPane` の nil ペインスキップ不足
- **ファイル**: `internal/tmux/session_manager_targets.go`
- **検出**: 1レビューで指摘
- **内容**: `panes` スライス内に nil エントリが存在した場合、インデックス操作で nil ペインに着地する可能性。最終行で `candidate==nil` チェックはあるがエラー返却のみ。nil をスキップして次の有効ペインに進むほうがロバスト。

---

### ■ カテゴリ B: フロントエンド

#### IMP-B01: `tmux:worker-fatal` イベントがフロントエンドで未ハンドリング
- **ファイル**: `app_lifecycle.go` (L352), `app_pane_feed.go` (L122), `frontend/src/hooks/useBackendSync.ts`
- **検出**: 3レビュー中2件で指摘
- **内容**: バックエンドで `tmux:worker-fatal` イベントが2箇所で新規発行されているが、フロントエンドの `BackendEventMap` にエントリがなく、`EventsOn` による購読も存在しない。ワーカー永続停止時にユーザーへ通知されない。
- **修正案**: `BackendEventMap` に `"tmux:worker-fatal": { worker?: string; maxRetries?: number }` を追加し、`onEvent` で通知表示。

#### IMP-B02: `useTerminalFontSize` の `eslint-disable` コメント欠落
- **ファイル**: `frontend/src/hooks/useTerminalFontSize.ts` (L107)
- **検出**: 3レビュー中2件で指摘
- **内容**: 第2 `useEffect` の依存配列から `terminalRef`, `fitAddonRef`, `fontSizeRef` を除外しているが、`eslint-disable-next-line` が付いていない。同ファイルの第1 `useEffect` には付いている。

#### IMP-B03: `BackendEventMap` の型ガード注意コメント欠如
- **ファイル**: `frontend/src/hooks/useBackendSync.ts` L19-31
- **検出**: 1レビューで指摘
- **内容**: `BackendEventMap` でペイロード型が具体型に絞り込まれたが、`EventsOn` のランタイムペイロードは `unknown` のまま。静的型があるからとランタイム検証を省略する誤解リスク。
- **修正案**: コメント追加:
```typescript
// IMPORTANT: These types are compile-time documentation only.
// EventsOn delivers `unknown` at runtime — every handler MUST still
// validate with asObject/asArray before accessing properties.
```

#### IMP-B04: `BackendEventMap` の `config:load-failed` 型が不正確
- **ファイル**: `frontend/src/hooks/useBackendSync.ts` L18
- **検出**: 1レビューで指摘
- **内容**: `{ message?: string }` と定義しているが、バックエンドは常に `message` を含む。`{ message: string }` が正確。

#### IMP-B05: `BackendEventMap` の `config:updated` 型が設計意図と乖離
- **ファイル**: `frontend/src/hooks/useBackendSync.ts` L24
- **検出**: 1レビューで指摘
- **内容**: `ParsedConfigUpdatedEvent | AppConfig` は型として不正確。バックエンド構造に合わせた型か `unknown` が適切。

#### IMP-B06: `setActiveSession` の `activeWindowId` 解決ロジック重複
- **ファイル**: `frontend/src/stores/tmuxStore.ts` L133-145
- **検出**: 3レビュー中2件で指摘
- **内容**: `resolveSessionState` と同じ `sessions.find → active_window_id` パターンが `setActiveSession` 内に重複。一方を変更した場合にもう一方の更新忘れリスク。
- **修正案**: `resolveActiveWindowId` ヘルパーを抽出して両方で再利用。

#### IMP-B07: `useWindowRename` のキャッシュが `renamingWindowId` 変更時に未クリア
- **ファイル**: `frontend/src/hooks/useWindowRename.ts` L89-106
- **検出**: 3レビュー中2件で指摘
- **内容**: `lastRefCallbackRef.current` がステイルなクロージャを保持し続ける可能性。キャッシュ判定で実害は出ないが、GC妨害の軽微なメモリリーク。
- **修正案**: `cancelWindowRename` で `lastRefCallbackRef.current = null` を追加。

---

### ■ カテゴリ C: Go バックエンド（コード品質）

#### IMP-C01: `config.go` 内の `os.IsNotExist` が未移行
- **ファイル**: `internal/config/config.go` (L189, L230, L351)
- **検出**: 3レビュー全てで指摘
- **内容**: `install/` パッケージでは `errors.Is(err, os.ErrNotExist)` への移行が完了しているが、`config.go` 内に `os.IsNotExist()` が3箇所残存。ラップされたエラーを正しく判定できない。

#### IMP-C02: `pruneLogWarning` が毎回 `log.New` で Logger を生成
- **ファイル**: `cmd/tmux-shim/main.go` L415-422
- **検出**: 3レビュー全てで指摘
- **内容**: 呼び出し毎に新しい `log.Logger` をアロケート。短命プロセスのため実害は少ないが不要。
- **修正案**: パッケージレベル変数に保持するか `fmt.Fprintf(os.Stderr, ...)` に統一。

#### IMP-C03: retry ループの定数ドリフトリスク
- **ファイル**: `app_lifecycle.go`, `app_panic_recovery_test.go`
- **検出**: 3レビュー中2件で指摘
- **内容**: `startPanicRecoveryLoop` の `maxRetries=3`, `retryDelay=500ms` がテストと同じ値をハードコード。一方を変更するとドリフトする。定数を共有するかテスト側でプロダクションコードの定数を参照すべき。

#### IMP-C04: `ListPanesByWindowTarget` が `resolveTargetCore` を使っていない
- **ファイル**: `internal/tmux/session_manager_pane_io.go`
- **検出**: 1レビューで指摘
- **内容**: `resolveTargetCore` (C-01) でターゲット解決を統一したが、`ListPanesByWindowTarget` は依然として独自実装。次のリファクタリング候補として記録推奨。

---

### ■ カテゴリ D: コメント・ドキュメント

#### IMP-D01: `resolveTargetCore` の戻り値契約ドキュメント不足
- **ファイル**: `internal/tmux/session_manager_targets.go` L69-70
- **検出**: 3レビュー全てで指摘
- **内容**: `target==""` かつ `callerPaneID < 0` の場合、`needsSessionResolve=true` だが `session=nil`。将来の呼び出し元が `session!=nil` をアサートして panic するリスク。ドキュメントに明記すべき。
- **修正案**: 「sessionがnilのときはdefaultPaneへのフォールバックを意味する」「`needsSessionResolve == true` の場合 `pane` は常に nil」を明記。

#### IMP-D02: `emitWorktreeCleanupFailure` のコメント不正確
- **ファイル**: `app_session_api.go` (L326-328)
- **検出**: 1レビューで指摘
- **内容**: コメントに「The error is still logged **above**」とあるが、実際にエラーを記録しているのは下の `slog.Warn` 行。
- **修正案**: "above" → "in the slog.Warn below" に修正。

#### IMP-D03: `expandFormatSafe` の micro-TOCTOU コメント補足
- **ファイル**: `internal/tmux/format.go` L213-230
- **検出**: 1レビューで指摘
- **内容**: 2つの RLock 間でセッション名が変更された場合に検索失敗する micro-gap が存在。コメント上「TOCTOU-safe」と標榜しているため、この制限事項を補足コメントで明記すべき。

#### IMP-D04: `copySnapshotCache` コメントの「Consider adding」が事実と矛盾
- **ファイル**: `app_snapshot_delta.go` (L259-261)
- **検出**: 3レビュー中2件で指摘
- **内容**: `TestSnapshotFieldCounts` は既に存在しているため、「Consider adding」→「See TestSnapshotFieldCounts which guards against this」に修正。

---

### ■ カテゴリ E: テスト品質

#### IMP-E01: `TestMaxPanicRestartRetriesLimit` のアサーションが弱い
- **ファイル**: `app_panic_recovery_test.go` L133-145
- **検出**: 1レビューで指摘
- **内容**: `gotAttempts > maxPanicRestartRetries` のみチェックし、正確な回数（`panicCount+1`）を検証していない。

#### IMP-E02: `TestMaxPanicRestartRetriesLimit` のコメントとbackoff実装の乖離
- **ファイル**: `app_panic_recovery_test.go` L148
- **検出**: 1レビューで指摘
- **内容**: 「Reproduce the exact retry-loop pattern」と記載しているが、`restartDelay = 0` でbackoffをスキップ。コメントの正確性が問題。

#### IMP-E03: `TestFilterPathEntries` がプロダクションロジックをコピーしている
- **ファイル**: `internal/install/shim_cleanup_windows_test.go` L233-296
- **検出**: 1レビューで指摘
- **内容**: stale filterロジックをテスト内に複製。本体側が変更されてもテストは通り続けるため回帰検出力が弱い。
- **修正案**: フィルタロジックをヘルパー関数に抽出し、テストはその関数を直接テスト。

---

## Suggestions（24件）

### Go バックエンド

| ID | ファイル | 内容 | 検出数 |
|----|----------|------|--------|
| SUG-01 | `app_lifecycle.go`, `app_pane_feed.go` | ワーカーリカバリループの共通化検討。現在 CROSS-REF コメントで対応。ワーカー3つ以上で `runWithPanicRecovery` 抽出推奨 | 1 |
| SUG-02 | `app_lifecycle.go` L195-210 | `ensureShimReady` の `err` → `preCheckErr` に変更で `postCheckErr` との対称性向上 | 1 |
| SUG-03 | `app_guards.go` L37-39 | `requireSessionsWithPaneID` の nil ガードエラーを sentinel error 化して `errors.Is()` テスト | 1 |
| SUG-04 | `app_guards.go` | `notifyPaneRemoved(trigger=false)` の意味が不明瞭。`skipSessionCleanup` 等の名前付き型推奨 | 1 |
| SUG-05 | `app_helpers.go` L26 | `toBytes` に「caller must copy before async use」注記。`unsafe.Slice` 使用の aliasing リスク明記 | 2 |
| SUG-06 | `app_events.go` L133-138 | `snapshotEventPolicies` の DESIGN コメントが将来仕様を過度に説明（YAGNI） | 1 |
| SUG-07 | `app_events.go` L305-306 | `syncPaneStates` の `range session.Windows` / `range window.Panes` に nil ガード追加 | 1 |
| SUG-08 | `internal/tmux/session_manager_windows.go` | `removeWindowResult.SurvivingWindowID` の zero value `0` が ID=0 と区別不能。エラー時 `-1` 設計は正しいが認識必要 | 1 |
| SUG-09 | `internal/tmux/session_manager_env.go` | `copy-on-read INVARIANT` コメントに `SetPaneEnv` の書き込み時コピーも注記 | 1 |
| SUG-10 | `internal/tmux/session_manager_targets.go` L120 | `resolveWindowPaneTarget` に REQUIRES コメント（ロック前提条件）を追記 | 1 |
| SUG-11 | `internal/tmux/format.go` L213-230 | `expandFormatSafe` のフォールバックが一律 nil pane。bare pane 構築で部分情報出力可能 | 1 |
| SUG-12 | `internal/install/shim_path_windows.go` L51-55 | `ensurePathContains` の `CreateKey` に「書き込み用に意図的に `CreateKey` を使用」コメント追加 | 2 |

### フロントエンド

| ID | ファイル | 内容 | 検出数 |
|----|----------|------|--------|
| SUG-13 | `frontend/src/stores/tmuxStore.ts` L84,102 | `applySessionDelta` の `removed` 配列にもランタイムガード追加。`undefined` が `"undefined"` キーとして動作するリスク | 2 |
| SUG-14 | `frontend/src/components/ConfirmDialog.tsx` | `inert` 属性による背景非活性化検討。Windowsデスクトップアプリなので不要の可能性 | 1 |
| SUG-15 | `frontend/src/types/tmux.ts` L32-34 | SYNC STRATEGY の `grep` コマンドがWindows非対応 | 1 |
| SUG-16 | `frontend/src/hooks/useTerminalSetup.ts` | Hook実行順序の INVARIANT コメントは優秀だが並び替えを防ぐ lint rule が無い | 1 |

### テスト

| ID | ファイル | 内容 | 検出数 |
|----|----------|------|--------|
| SUG-17 | `app_events_test.go` | テスト役割分担（`TestAllRegisteredEventsHaveSnapshotPolicyTests` と既存テスト）のコメント追記 | 1 |
| SUG-18 | `app_panic_recovery_test.go` | `panicCount=0` のテストケース（正常系）が欠落 | 1 |
| SUG-19 | `app_pane_api_test.go` | 特殊文字セッション名（コロン、ドット、`%`）のテストケース追加推奨 | 1 |
| SUG-20 | `internal/tmux/session_manager_env_test.go` | `PaneWidth/PaneHeight` フィールドのテスト追加推奨 | 1 |
| SUG-21 | `internal/tmux/session_manager_directional_test.go` | 複数ウィンドウ間のスコープ分離テスト追加推奨 | 1 |

### 全体

| ID | ファイル | 内容 | 検出数 |
|----|----------|------|--------|
| SUG-22 | 全体（26箇所） | Unicode矢印 `→` の ASCII `->` への統一方針決定。全てコメント内で実害なし | 2 |
| SUG-23 | 全体（37箇所） | `os.IsNotExist` → `errors.Is(err, os.ErrNotExist)` の全体移行。`config.go`(3), `app_worktree_api.go`(8), `cmd/tmux-shim/main.go`(4), `internal/git/validation.go`(2) 等 | 2 |
| SUG-24 | コードベース全体 | C-01, C-03, S-07, I-27 等のレビュー指摘符号のマッピングテーブルを `develop-README.md` に記載 | 1 |

---

## Strengths（良い点）

### 設計・アーキテクチャ
- **resolveTargetCore 抽出 (C-01)**: RLock/Lock 両パスの~50行重複を統合。動作等価性が正しく保たれている
- **removeWindowResult 構造体化**: 4値タプル → 名前付きフィールドで可読性大幅向上。所有権契約ドキュメントが優秀
- **expandFormatSafe**: TOCTOU-safe clone パターンが明確。3段階クローンで live pointer chain の並行変異を確実に排除
- **buildPaneEnv 統一 (I-04)**: 手動3段階 → 1関数に統合、3つのハンドラで一貫性確保
- **トラッキングID付きコメント** (I-01, I-02, C-01等) が設計意図の追跡に有効

### 並行性・安全性
- **TOCTOU修正パターンの一貫性**: `runtimeContext()` の nil チェック + 利用を `rtCtx` ローカル変数に統一
- **Variable Shadowing修正**: `err` → `postCheckErr` リネームで外側変数との干渉を排除
- **handleResizePane の pre/post snapshot**: live pointer 参照を完全に排除し、fallback も安全に設計

### テスト品質
- **テーブル駆動テストパターンの一貫した使用**
- **boundary テストの網羅性**: `findWindowIndexByID`(7ケース), `removeWindowResult`(S-26a~e), `MultiPaneTerminalPreservation`(I-08)
- **モデル変換テスト**: I-27(6ケース), I-28(6ケース), S-23(5ケース)で dead code パスまで検証
- **C-03 再帰防止テスト**: 無限再帰が実際に発生しないことをスタックオーバーフロー不在で実証
- **PaneContextSnapshot 7→9 フィールド数の正確な更新**

### フロントエンド
- **WAI-ARIA パターン**: `useId()` による stable ID、`role="dialog"` + `aria-modal` + `aria-labelledby/describedby` が模範的
- **Hook順序の明示的文書化**: INVARIANT ブロックによる暗黙依存の可視化
- **disposed パターンがフック間で統一**
- **useMemo の適切な削除**: trivial計算での useMemo 除去は正しい判断

### 防御的コーディング
- **nilガード体系的適用**: 5ファイルに渡る一貫した適用（漏れは数箇所のみ）
- **空値ガード対称性**: `applyModelOverride` / `applyFromToReplacement` の4パス全てで完全対称
- **CreateKey → OpenKey**: 最小権限の原則に基づく適切な変更
- **errors.Is 移行が `install/` で完全に実施**
- **shim仕様への準拠**: エラー時は原文転送が維持されている

---

## 修正タスク一覧と並列作業表

### タスク一覧

| タスクID | 概要 | 対象ファイル | 重要度 | 難度 |
|:--------:|:-----|:------------|:------:|:----:|
| T-01 | `SwapPanes` に pane nil ガード追加（2箇所） | `session_manager_pane_lifecycle.go` | ★★★ | 低 |
| T-02 | `applyLayoutPresetToWindowLocked` に pane nil ガード追加 | `session_manager_panes.go` | ★★★ | 低 |
| T-03 | `handleListWindows` に window nil ガード追加 | `command_router_handlers_window.go` | ★★☆ | 低 |
| T-04 | `ResolveDirectionalPane` の Window nil チェック + nil ペインスキップ | `session_manager_targets.go` | ★★☆ | 低 |
| T-05 | `resolveTargetCore` の戻り値契約ドキュメント強化 | `session_manager_targets.go` | ★★☆ | 低 |
| T-06 | `resolveWindowPaneTarget` REQUIRES コメント追記 | `session_manager_targets.go` | ☆ | 低 |
| T-07 | `tmux:worker-fatal` フロントエンドハンドラ追加 | `useBackendSync.ts` | ★★★ | 低 |
| T-08 | `BackendEventMap` 型ガード注意コメント追加 | `useBackendSync.ts` | ★★☆ | 低 |
| T-09 | `BackendEventMap` の `config:load-failed` 型修正 | `useBackendSync.ts` | ★★☆ | 低 |
| T-10 | `BackendEventMap` の `config:updated` 型修正 | `useBackendSync.ts` | ★★☆ | 低 |
| T-11 | `useTerminalFontSize` に eslint-disable 追加 | `useTerminalFontSize.ts` | ★★☆ | 低 |
| T-12 | `setActiveSession` の activeWindowId 解決ロジック共通化 | `tmuxStore.ts` | ★★☆ | 中 |
| T-13 | `useWindowRename` キャッシュクリア追加 | `useWindowRename.ts` | ★☆☆ | 低 |
| T-14 | `config.go` の `os.IsNotExist` → `errors.Is` 移行（3箇所） | `config/config.go` | ★★☆ | 低 |
| T-15 | `pruneLogWarning` の Logger 生成最適化 | `cmd/tmux-shim/main.go` | ★☆☆ | 低 |
| T-16 | retry定数の共有化 | `app_lifecycle.go`, `app_panic_recovery_test.go` | ★★☆ | 低 |
| T-17 | `emitWorktreeCleanupFailure` コメント修正 | `app_session_api.go` | ★☆☆ | 低 |
| T-18 | `expandFormatSafe` micro-TOCTOU コメント補足 | `format.go` | ★☆☆ | 低 |
| T-19 | `copySnapshotCache` コメント事実反映 | `app_snapshot_delta.go` | ★☆☆ | 低 |
| T-20 | `ensurePathContains` CreateKey コメント追加 | `shim_path_windows.go` | ★☆☆ | 低 |
| T-21 | `TestMaxPanicRestartRetriesLimit` アサーション強化 + コメント修正 | `app_panic_recovery_test.go` | ★☆☆ | 低 |
| T-22 | `TestFilterPathEntries` ロジック重複解消 | `shim_cleanup_windows_test.go` | ★☆☆ | 中 |
| T-23 | `ListPanesByWindowTarget` の resolveTargetCore 統一（次期候補） | `session_manager_pane_io.go` | ★☆☆ | 中 |

### 並列作業グループ

同一ファイル・同一パッケージのタスクをグループ化し、並列実行可能な単位を整理しました。

```
グループ間は全て並列作業可能（ファイル競合なし）
グループ内は順次作業（同一ファイルまたは依存あり）
```

| グループ | タスク | 対象ファイル | 合計修正行 | 備考 |
|:--------:|:-------|:------------|:---------:|:-----|
| **G1** | T-01 | `session_manager_pane_lifecycle.go` | ~4行 | nilガード2箇所 |
| **G2** | T-02 | `session_manager_panes.go` | ~4行 | nilガード + append方式 |
| **G3** | T-03 | `command_router_handlers_window.go` | ~2行 | nilガード1箇所 |
| **G4** | T-04 → T-05 → T-06 | `session_manager_targets.go` | ~15行 | 同一ファイル3件。コードとコメントを順次修正 |
| **G5** | T-07 → T-08 → T-09 → T-10 | `useBackendSync.ts` | ~15行 | 同一ファイル4件。T-07のイベント追加後にT-08〜10 |
| **G6** | T-11 | `useTerminalFontSize.ts` | ~1行 | eslint-disable1行 |
| **G7** | T-12 | `tmuxStore.ts` | ~10行 | ヘルパー抽出 |
| **G8** | T-13 | `useWindowRename.ts` | ~2行 | キャッシュクリア |
| **G9** | T-14 | `config/config.go` | ~3行 | errors.Is置換3箇所 |
| **G10** | T-15 | `cmd/tmux-shim/main.go` | ~5行 | Logger変数化 |
| **G11** | T-16 → T-21 | `app_lifecycle.go` + `app_panic_recovery_test.go` | ~10行 | 同パッケージ定数共有 + テスト修正 |
| **G12** | T-17 | `app_session_api.go` | ~1行 | コメント修正 |
| **G13** | T-18 | `format.go` | ~3行 | コメント補足 |
| **G14** | T-19 | `app_snapshot_delta.go` | ~1行 | コメント修正 |
| **G15** | T-20 | `shim_path_windows.go` | ~2行 | コメント追加 |
| **G16** | T-22 | `shim_cleanup_windows_test.go` | ~15行 | テストリファクタ |
| **G17** | T-23 | `session_manager_pane_io.go` | ~20行 | 次期リファクタ候補 |

### 並列実行ダイアグラム

```
Phase 1（全て同時並列実行可能 — 17グループ全て独立）:

  G1  ─── T-01 (SwapPanes nilガード)
  G2  ─── T-02 (applyLayout nilガード)
  G3  ─── T-03 (handleListWindows nilガード)
  G4  ─── T-04 → T-05 → T-06 (targets.go 3件)
  G5  ─── T-07 → T-08 → T-09 → T-10 (useBackendSync.ts 4件)
  G6  ─── T-11 (eslint-disable)
  G7  ─── T-12 (activeWindowId共通化)
  G8  ─── T-13 (キャッシュクリア)
  G9  ─── T-14 (errors.Is移行)
  G10 ─── T-15 (Logger最適化)
  G11 ─── T-16 → T-21 (retry定数 + テスト修正)
  G12 ─── T-17 (コメント修正)
  G13 ─── T-18 (micro-TOCTOUコメント)
  G14 ─── T-19 (copySnapshotCacheコメント)
  G15 ─── T-20 (CreateKeyコメント)
  G16 ─── T-22 (テストリファクタ)
  G17 ─── T-23 (次期リファクタ候補 — 後回しOK)
```

### 担当分割の推奨パターン

| 担当 | グループ | 作業内容 | 備考 |
|:----:|:--------:|:---------|:-----|
| **担当A: Go nilガード** | G1, G2, G3, G4 | Internal tmux の nilガード + ドキュメント | 全て `internal/tmux/` 内。一人でまとめて対応が効率的 |
| **担当B: Frontend** | G5, G6, G7, G8 | BackendEventMap, eslint, Store改善 | 全て `frontend/src/` 内 |
| **担当C: Go バックエンド** | G9, G10, G11, G12, G13, G14, G15 | errors.Is, Logger, コメント修正群 | 小粒タスクが多く一人で順次処理可能 |
| **担当D: テスト品質** | G16, G17 | テストリファクタ + 次期リファクタ | G17は記録のみでもOK |

### 優先順位ガイド

```
最優先（★★★ — nilガードとイベントハンドラ欠落）:
  T-01, T-02, T-07

高優先（★★☆ — 一貫性・型安全性）:
  T-03, T-04, T-05, T-08, T-09, T-10, T-11, T-12, T-14, T-16

通常（★☆☆ — コメント・テスト品質）:
  T-06, T-13, T-15, T-17, T-18, T-19, T-20, T-21, T-22

記録のみ（次期候補）:
  T-23
```

---

## 総評

本差分は以下の3カテゴリで構成される品質改善・防御的強化の変更セットです：

1. **TOCTOU修正・データ競合防止**: `runtimeContext()` のローカル変数化、`expandFormatSafe` のクローンベース設計
2. **防御的コーディング**: nil ガードの体系的追加、空値ガードの対称的実装、`CreateKey` → `OpenKey` の権限最小化
3. **可読性・保守性向上**: `removeWindowResult` 構造体化、`resolveTargetCore` のDRY化、WAI-ARIAパターン、Hook順序の文書化

**致命的なバグは検出されず**、指摘事項は主に以下に集約されます：
- **nilガードの追加漏れ**（一貫性）— 3レビュー全てで検出、最優先
- **フロントエンドイベントハンドラの未実装** — `worker-fatal` の通知欠如
- **型の正確性** — `BackendEventMap` の型定義
- **コメント・ドキュメントの正確性** — 事実との乖離修正

全体として高品質な変更セットであり、上記タスクを対応すれば安心してコミット可能です。
