# PR Review Summary — 2026-02-19

**対象**: `myT-x/` 配下の全変更ファイル（57ファイル, +1742/-295行）  
**レビュー方式**: 5カテゴリに分類し並列レビュー + クロスカッティング分析

---

## カテゴリ分類

| # | カテゴリ | ファイル数 | 主な変更内容 |
|---|---------|----------|------------|
| 1 | App層 (Go) | 14 | TOCTOU修正, worker-fatal, nilガード, テスト追加 |
| 2 | tmux-shim (Go) | 4 | 無限再帰防止, 空値ガード, モデル変換テスト |
| 3 | Frontend (TS/React) | 10 | WAI-ARIA, Hook順序文書化, 型narrowing, Zustand改善 |
| 4 | Internal packages (Go) | 10 | CreateKey→OpenKey, errors.Is移行, テスト追加 |
| 5 | Internal tmux (Go) | 17 | resolveTargetCore抽出, removeWindowResult, expandFormatSafe, nilガード |

---

## Critical Issues（0件）

致命的なバグ、データ損失、クラッシュを引き起こす問題は検出されませんでした。

---

## Important Issues（13件）

### ■ [IMP-01] nilガード漏れ: `applyLayoutPresetToWindowLocked`
- **カテゴリ**: Internal tmux
- **ファイル**: `myT-x/internal/tmux/session_manager_panes.go` L121-127
- **内容**: `window.Panes` イテレーションで `pane` の nilガードが欠落。同ファイル差分内の `SetActivePane` には追加済みで不整合。
```go
paneIDs := make([]int, len(window.Panes))
for i, pane := range window.Panes {
    paneIDs[i] = pane.ID  // pane が nil なら panic
}
```
- **修正案**: `pane == nil` 時に `continue` + `paneIDs` を `append` 方式に変更

### ■ [IMP-02] nilガード漏れ: `swapPaneLocked` (2箇所)
- **カテゴリ**: Internal tmux
- **ファイル**: `myT-x/internal/tmux/session_manager_pane_lifecycle.go` L49-56, L62-67
- **内容**: `SwapPanes` 内の2つの `window.Panes` ループで `pane` nilガードが欠落。
```go
// L49: switch pane.ID   — nilでpanic
// L62: pane.Index = idx — nilでpanic
```

### ■ [IMP-03] nilガード漏れ: `handleListWindows`
- **カテゴリ**: Internal tmux
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go` L146-150
- **内容**: `session.Windows` イテレーションで `window` の nilガードが未適用。`GetSession` はクローンを返すため到達可能性は低いが、他の似た箇所にガードが入っており不整合。

### ■ [IMP-04] `setActiveSession` の `activeWindowId` 解決ロジックが `resolveSessionState` と重複
- **カテゴリ**: Frontend
- **ファイル**: `myT-x/frontend/src/stores/tmuxStore.ts` L133-145
- **内容**: I-36で共通化した `resolveSessionState` と同じ `sessions.find → active_window_id` パターンが `setActiveSession` 内に重複。将来の乖離リスク。
- **修正案**: `resolveActiveWindowId` ヘルパーを抽出して両方で再利用

### ■ [IMP-05] `BackendEventMap` の `config:load-failed` 型が不正確
- **カテゴリ**: Frontend
- **ファイル**: `myT-x/frontend/src/hooks/useBackendSync.ts` L18
- **内容**: `{ message?: string }` と定義しているが、バックエンドは `map[string]string{"message": warning}` で常に message を含む。`{ message: string }` が正確。

### ■ [IMP-06] `BackendEventMap` の `config:updated` 型が設計意図と乖離
- **カテゴリ**: Frontend
- **ファイル**: `myT-x/frontend/src/hooks/useBackendSync.ts` L24
- **内容**: `ParsedConfigUpdatedEvent | AppConfig` は型として不正確。パーサーが全検証を担うため、バックエンド構造に合わせた型か `unknown` が適切。

### ■ [IMP-07] `useWindowRename` のキャッシュが `renamingWindowId` 変更時に明示クリアされない
- **カテゴリ**: Frontend
- **ファイル**: `myT-x/frontend/src/hooks/useWindowRename.ts` L89-106
- **内容**: `lastRefCallbackRef.current` がステイルなクロージャを保持し続ける可能性。キャッシュ判定で実害は出ないが、GC妨害の軽微なメモリリーク。
- **修正案**: `cancelWindowRename` で `lastRefCallbackRef.current = null` を追加

### ■ [IMP-08] `TestMaxPanicRestartRetriesLimit` の "fewer panics" ケースでアサーションが弱い
- **カテゴリ**: App層
- **ファイル**: `myT-x/app_panic_recovery_test.go` L133-145
- **内容**: `gotAttempts > maxPanicRestartRetries` のみチェックし、正確な回数（`panicCount+1`）を検証していない。テストとしては通るが、ロジック正当性の検証が不十分。

### ■ [IMP-09] `TestMaxPanicRestartRetriesLimit` のコメントとbackoff実装の乖離
- **カテゴリ**: App層
- **ファイル**: `myT-x/app_panic_recovery_test.go` L148
- **内容**: 「Reproduce the exact retry-loop pattern」と記載しているが、`restartDelay = 0` でbackoffをスキップ。コメントの正確性が問題。

### ■ [IMP-10] `TestFilterPathEntries` がプロダクションロジックをコピーしている
- **カテゴリ**: Internal packages
- **ファイル**: `myT-x/internal/install/shim_cleanup_windows_test.go` L233-296
- **内容**: stale filterロジックをテスト内に複製。本体側が変更されてもテストは通り続けるため回帰検出力が弱い。
- **修正案**: フィルタロジックをヘルパー関数に抽出し、テストはその関数を直接テスト

### ■ [IMP-11] `pruneLogWarning` が毎回 `log.New` で Logger を生成
- **カテゴリ**: tmux-shim
- **ファイル**: `myT-x/cmd/tmux-shim/main.go` L415-419
- **内容**: 呼び出し毎に新しい `log.Logger` をアロケート。呼び出し頻度は低いが不要。
- **修正案**: パッケージレベル変数に保持するか `fmt.Fprintf(os.Stderr, ...)` に統一

### ■ [IMP-12] `TestPruneRotatedShimDebugLogs` の再帰防止検証が間接的
- **カテゴリ**: tmux-shim
- **ファイル**: `myT-x/cmd/tmux-shim/main_test.go` L1979-2013
- **内容**: 「スタックオーバーフローせずに返る」ことで再帰不在を証明しているが、テスト環境ではログローテーションが発動しないため、将来 `debugLog` に戻してもテストが通ってしまう可能性。

### ■ [IMP-13] `resolveTargetCore` の `session=nil, needsSessionResolve=true` のドキュメント不足
- **カテゴリ**: Internal tmux
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go` L69-70
- **内容**: ドキュメントコメントに「sessionがnilのときはdefaultPaneへのフォールバックを意味する」を明記すべき。

---

## Suggestions（12件）

### ■ [SUG-01] `snapshotEventPolicies` の DESIGN コメントが将来仕様を過度に説明（YAGNI）
- **ファイル**: `myT-x/app_events.go` L133-138

### ■ [SUG-02] `TestAllRegisteredEventsHaveSnapshotPolicyTests` と既存テストの役割分担を明記
- **ファイル**: `myT-x/app_events_test.go`

### ■ [SUG-03] `copySnapshotCache` コメントが「CI check検討を提案」段階だが既に `TestSnapshotFieldCounts` が存在
- **ファイル**: `myT-x/app_snapshot_delta.go`
- **修正案**: 「Consider adding」を「TestSnapshotFieldCounts guards this」に更新

### ■ [SUG-04] `ConfirmDialog` の `inert` 属性による背景非活性化
- **ファイル**: `myT-x/frontend/src/components/ConfirmDialog.tsx`
- **備考**: Windowsデスクトップアプリなのでスクリーンリーダー利用が想定外なら不要

### ■ [SUG-05] `types/tmux.ts` の SYNC STRATEGY の `grep` コマンドがWindows非対応
- **ファイル**: `myT-x/frontend/src/types/tmux.ts` L32-34

### ■ [SUG-06] `→` 文字の `->` への統一方針が未確定（26箇所残存）
- **対象**: `myT-x/` 配下のGoソースファイル全般（全てコメント内）
- **実害**: なし（コメントのみ）。統一するなら一括置換、しないなら差分内での部分的置換をやめる

### ■ [SUG-07] `os.IsNotExist` → `errors.Is` 移行が `internal/install` 以外未完了（37箇所残存）
- **対象**: `internal/config/config.go`(3箇所), `internal/git/validation.go`(2箇所), `internal/git/worktree_test.go`(4箇所), `app_worktree_api.go`(8箇所), `cmd/tmux-shim/main.go`(4箇所) 他
- **備考**: 今回の差分スコープ外だが、プロジェクト全体の一貫性として今後対応推奨

### ■ [SUG-08] `expandFormatSafe` のフォールバックが一律 nil pane
- **ファイル**: `myT-x/internal/tmux/format.go` L213-230
- **備考**: snapshotからスカラー値のみで bare pane を構築すれば部分情報を出力可能。「転送優先」方針とは矛盾しない

### ■ [SUG-09] `resolveWindowPaneTarget` に REQUIRES コメントなし
- **ファイル**: `myT-x/internal/tmux/session_manager_targets.go` L120
- **備考**: `resolveTargetCore` から呼ばれるが独自のロック前提条件ドキュメントがない

### ■ [SUG-10] `toBytes` のコメントで「no copy」明記だが呼び出し元に注意喚起なし
- **ファイル**: `myT-x/app_helpers.go` L26
- **備考**: 現行は安全だが「caller must copy before async use」の注記があると将来のミスを防止

### ■ [SUG-11] `shim_path_windows.go` の `registry.CreateKey` 残存が意図的であることのコメント追加
- **ファイル**: `myT-x/internal/install/shim_path_windows.go` L51-55
- **備考**: read-only箇所はOpenKeyに変更済みだが、書き込み用のCreateKeyが正しく残っていることを明記

### ■ [SUG-12] `applySessionDelta` のnullガードがTypeScript型 `SessionSnapshot[]` と矛盾
- **ファイル**: `myT-x/frontend/src/stores/tmuxStore.ts` L102-106
- **備考**: ランタイムガードとしては正しい。I-25コメントで理由は説明済み

---

## Strengths（主な良い点）

### 設計・アーキテクチャ
- **resolveTargetCore 抽出 (C-01)**: RLock/Lock 両パスの~50行重複を統合。動作等価性が正しく保たれている
- **removeWindowResult 構造体**: 4値タプル → 名前付きフィールドで可読性大幅向上。所有権契約ドキュメントが優秀
- **expandFormatSafe**: TOCTOU-safe clone パターンが明確。3段階クローンで live pointer chain の並行変異を確実に排除
- **buildPaneEnv 統一 (I-04)**: 手動3段階 → 1関数に統合、3つのハンドラで一貫性確保

### 並行性・安全性
- **TOCTOU修正パターンの一貫性**: `runtimeContext()` の nil チェック + 利用を `rtCtx` ローカル変数に統一（app_lifecycle, app_pane_feed）
- **Variable Shadowing修正**: `err` → `postCheckErr` リネームで外側変数との干渉を排除、意図をコメントで明記
- **handleResizePane の pre/post snapshot**: live pointer 参照を完全に排除し、fallback も安全に設計

### テスト品質
- **boundary テストの網羅性**: findWindowIndexByID(7ケース), removeWindowResult(S-26a~e), MultiPaneTerminalPreservation(I-08)
- **モデル変換テスト**: I-27(6ケース), I-28(6ケース), S-23(5ケース)で dead code パスまで検証
- **C-03 再帰防止テスト**: 無限再帰が実際に発生しないことをスタックオーバーフロー不在で実証

### フロントエンド
- **WAI-ARIA パターン**: useId()によるstable ID、role="dialog" + aria-modal + aria-labelledby/describedby が教科書的
- **Hook順序の明示的文書化**: INVARIANT ブロックによる暗黙依存の可視化、各フックに対応コメント
- **useMemo の適切な削除**: trivial計算でのuseMemo除去は正しい判断
- **worker-fatal イベント**: リトライ上限到達時のフロントエンド通知で可観測性を向上

### 防御的コーディング
- **nilガード体系的適用**: 5ファイルに渡る一貫した適用（漏れは3箇所のみ）
- **空値ガード対称性**: applyModelOverride/applyFromToReplacement の4パス全てで完全対称
- **CreateKey → OpenKey**: 最小権限の原則に基づく適切な変更、ErrNotExist ガード追加

---

## 修正タスク一覧 — 並列作業可否マトリクス

各タスクを修正する際に、他のタスクと並列で作業可能かどうかを整理しました。

| タスクID | 内容 | 対象ファイル | 重要度 | 並列作業 | 補足 |
|:--------:|:-----|:------------|:------:|:--------:|:-----|
| IMP-01 | `applyLayoutPresetToWindowLocked` nilガード追加 | `session_manager_panes.go` | Important | ✅ 可能 | IMP-02と独立 |
| IMP-02 | `swapPaneLocked` nilガード追加 (2箇所) | `session_manager_pane_lifecycle.go` | Important | ✅ 可能 | IMP-01と独立 |
| IMP-03 | `handleListWindows` windowのnilガード追加 | `command_router_handlers_window.go` | Important | ✅ 可能 | IMP-01,02と独立 |
| IMP-04 | `setActiveSession` のactiveWindowId解決ロジック重複解消 | `tmuxStore.ts` | Important | ✅ 可能 | FE単独作業 |
| IMP-05 | `BackendEventMap` の `config:load-failed` 型修正 | `useBackendSync.ts` | Important | ⚠️ IMP-06と同一ファイル | IMP-06と同時修正推奨 |
| IMP-06 | `BackendEventMap` の `config:updated` 型修正 | `useBackendSync.ts` | Important | ⚠️ IMP-05と同一ファイル | IMP-05と同時修正推奨 |
| IMP-07 | `useWindowRename` キャッシュクリア追加 | `useWindowRename.ts` | Important | ✅ 可能 | FE単独作業 |
| IMP-08 | `TestMaxPanicRestartRetriesLimit` アサーション強化 | `app_panic_recovery_test.go` | Important | ⚠️ IMP-09と同一ファイル | IMP-09と同時修正推奨 |
| IMP-09 | `TestMaxPanicRestartRetriesLimit` コメント修正 | `app_panic_recovery_test.go` | Important | ⚠️ IMP-08と同一ファイル | IMP-08と同時修正推奨 |
| IMP-10 | `TestFilterPathEntries` のロジック重複解消 | `shim_cleanup_windows_test.go` | Important | ✅ 可能 | install pkg単独 |
| IMP-11 | `pruneLogWarning` の Logger 生成最適化 | `cmd/tmux-shim/main.go` | Important | ⚠️ IMP-12と同一ファイル | IMP-12と同時修正推奨 |
| IMP-12 | `TestPruneRotatedShimDebugLogs` 検証強化 | `cmd/tmux-shim/main_test.go` | Important | ⚠️ IMP-11と同一パッケージ | IMP-11と同時修正推奨 |
| IMP-13 | `resolveTargetCore` のドキュメント強化 | `session_manager_targets.go` | Important | ✅ 可能 | コメントのみ |
| SUG-01 | `snapshotEventPolicies` DESIGNコメント簡潔化 | `app_events.go` | Suggestion | ✅ 可能 | コメントのみ |
| SUG-02 | テスト役割分担コメント追記 | `app_events_test.go` | Suggestion | ✅ 可能 | コメントのみ |
| SUG-03 | `copySnapshotCache` コメント事実反映 | `app_snapshot_delta.go` | Suggestion | ✅ 可能 | コメントのみ |
| SUG-06 | `→` → `->` 統一方針決定 | 全体（26箇所） | Suggestion | ✅ 可能 | 一括置換 |
| SUG-07 | `os.IsNotExist` → `errors.Is` 全体移行 | 全体（37箇所） | Suggestion | ✅ 可能 | 一括置換 |
| SUG-09 | `resolveWindowPaneTarget` REQUIRES追記 | `session_manager_targets.go` | Suggestion | ⚠️ IMP-13と同一ファイル | IMP-13と同時推奨 |
| SUG-10 | `toBytes` コメントに使用注意追記 | `app_helpers.go` | Suggestion | ✅ 可能 | コメントのみ |
| SUG-11 | `registry.CreateKey` 残存の意図コメント | `shim_path_windows.go` | Suggestion | ✅ 可能 | コメントのみ |

### 並列作業グループ（効率的な同時修正の推奨組み合わせ）

```
グループA（Go nilガード — 全て独立して修正可能）:
  IMP-01 + IMP-02 + IMP-03 + IMP-13 + SUG-09

グループB（Frontend — useBackendSync.ts は一括修正）:
  IMP-04 + IMP-05&06 + IMP-07

グループC（App層テスト）:
  IMP-08&09

グループD（tmux-shim）:
  IMP-10 + IMP-11&12

グループE（コメント一括 — 全て独立） ※ 他グループと並列可:
  SUG-01 + SUG-02 + SUG-03 + SUG-10 + SUG-11

グループF（全体一括置換 — 他グループと独立） ※ 他と並列可:
  SUG-06 + SUG-07
```

**推奨実行順序:**
1. グループA + B + C + D を**並列**実行（各グループ内で同一ファイルは順次）
2. グループE + F を**並列**実行（コメント修正は他と干渉なし）

---

## Recommended Action

1. **Critical Issues**: なし — ブロッカーは存在しない
2. **IMP-01〜03 (nilガード漏れ)**: 同じ差分で他の全箇所にnilガードを追加した以上、整合性のために修正推奨
3. **IMP-04〜07 (Frontend型精度)**: 型ドキュメントの正確性。実害は少ないが保守性向上のため対応推奨
4. **IMP-08〜13**: テスト品質とコメント精度の改善。時間があれば対応
5. **SUG-06, SUG-07**: プロジェクト全体の一貫性。方針を決定してから一括対応
