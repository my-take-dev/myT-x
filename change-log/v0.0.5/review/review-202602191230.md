# Consolidated PR Review — 2026-02-19 12:30

**レビュー対象**: `myT-x/` 配下のコミット前変更 (56-57ファイル, +732/-167行)

**統合元レビュー**:
- `review-20260219115801.md` (11:58)
- `review-20260219122305.md` (12:23)
- `review-20260219122418.md` (12:24)

**レビューカテゴリ**: App Layer / tmux Session Management / Internal Libraries / tmux-shim / Frontend / テスト横断 / nil安全性監査

---

## Critical Issues（7件）

### C-01: `rebuildLayoutFromPaneOrder` がnilペインでpanicする

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/session_manager_pane_lifecycle.go` L170付近 |
| **並列修正** | ✅ 可（T-03と同一ファイル — 同Workerで実施） |
| **検出元** | 12:23 IMP-01, 12:24 C-01 |

`panes[0].ID` および `panes[i].ID` へのアクセスにnilチェックがない。`SwapPanes` のフォールバックパスで nil エントリを含むスライスが渡された場合、nil pointer dereference が発生する。

**修正案:**
```go
func rebuildLayoutFromPaneOrder(panes []*TmuxPane) *LayoutNode {
    var root *LayoutNode
    for _, p := range panes {
        if p == nil {
            continue
        }
        leaf := newLeafLayout(p.ID)
        if root == nil {
            root = leaf
        } else {
            root = &LayoutNode{
                Type: LayoutSplit, Direction: SplitHorizontal, Ratio: 0.5,
                Children: [2]*LayoutNode{root, leaf},
            }
        }
    }
    return root
}
```

---

### C-02: `renameWindowByIndexLocked` でnilチェック欠落

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/session_manager_windows.go` L196 |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 C-5, 12:24 C-02 |

インデックス範囲チェック後に `session.Windows[windowIdx].Name = newName` を実行するが、要素自体のnilチェックがない。同ファイル内の `removeWindowAtIndexLocked` は正しくガード済。

**修正案:**
```go
window := session.Windows[windowIdx]
if window == nil {
    return fmt.Errorf("window at index %d is nil", windowIdx)
}
window.Name = newName
```

---

### C-03: `m.panes[id]` nilガード不整合 — 7箇所でパニックリスク

| 項目 | 内容 |
|------|------|
| **ファイル** | 複数ファイル（下表参照） |
| **並列修正** | ⚠️ 複数ファイルにまたがる — 一括対応推奨 |
| **検出元** | 11:58 C-4 |

`session_manager_env.go` では完全な3段ガード `!ok || pane == nil || pane.Window == nil` を使用しているが、以下7箇所では `pane == nil` チェックが欠落。

| # | ファイル | メソッド | 現在のチェック | 欠落 |
|---|---|---|---|---|
| 1 | `session_manager_pane_io.go` | `ListPanesByWindowTarget` (allInSession) | `!ok \|\| pane.Window == nil \|\| ...` | `pane == nil` |
| 2 | `session_manager_pane_io.go` | `ListPanesByWindowTarget` (空target) | `!ok \|\| pane.Window == nil` | `pane == nil` |
| 3 | `session_manager_pane_lifecycle.go` | `killPaneLocked` | `!ok` のみ | `pane == nil` |
| 4 | `session_manager_panes.go` | `SplitPane` | `!ok` のみ | `target == nil` |
| 5 | `session_manager_panes.go` | `SetActivePane` | `!ok` のみ | `pane == nil` |
| 6 | `session_manager_targets.go` | `resolveTargetCore` (%paneID) | `!ok` のみ | `pane == nil` |
| 7 | `session_manager_targets.go` | `ResolveDirectionalPane` | `!ok` のみ | `current == nil` |

**修正案:** 全箇所を最低限 `!ok || pane == nil` に統一。

---

### C-04: `resolveTargetCore` が nil pane をエラーなしで返却

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/session_manager_targets.go` |
| **並列修正** | ⚠️ C-03 #6 と同一ファイル — C-03と同時対応 |
| **検出元** | 11:58 C-6 |

`m.panes[callerPaneID]` が `ok=true, value=nil` を返した場合、nil pane を error=nil で返却。全呼び出し元は `error == nil` なら pane は非nil と仮定して `pane.ID` 等にアクセスし、パニックする。

**修正案:**
```go
if callerPaneID >= 0 {
    if p, ok := m.panes[callerPaneID]; ok {
        if p == nil {
            return nil, false, nil, fmt.Errorf("pane is nil: %%%d", callerPaneID)
        }
        return p, false, nil, nil
    }
}
```

---

### C-05: `WriteToPanesInWindow` テストカバレッジ完全欠如

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/session_manager_pane_io.go` / テスト追加先: `session_manager_pane_io_test.go` |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 C-1 |

エラー集約ロジック（一部ペイン書き込み失敗時にログ出力して続行）を含むが、直接テストが存在しない。

**推奨テスト**: 正常系（複数ペイン一括書込み）、異常系（1ペイン失敗/全ペイン失敗）、境界値（0ペイン）

---

### C-06: `ApplyLayoutPresetByWindowID` テストカバレッジ完全欠如

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/session_manager_panes.go` / テスト追加先: `session_manager_panes_test.go` |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 C-2 |

`ApplyLayoutPresetToActiveWindow()` はテスト済みだが、`ByWindowID` はwindow ID解決→レイアウト適用の独自パスを持つ。ID不一致や存在しないwindow IDのエラーパスが未検証。

---

### C-07: `toString()` / `toBytes()` 直接ユニットテスト欠如

| 項目 | 内容 |
|------|------|
| **ファイル** | `app_helpers.go` / テスト追加先: `app_helpers_test.go` (新規) |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 C-3 |

`toBytes()` のWARNINGコメントで明記されたエイリアシング動作（`[]byte` 入力時にコピーせず原本を返す）がテストで保証されていない。テーブル駆動テストで `nil`, `[]byte`, `string`, 未対応型 + エイリアシング検証が必要。

---

## Important Issues（16件）

### I-01: `killPaneLocked` reindex/activeループのnilチェック欠落

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/session_manager_pane_lifecycle.go` L106, L113 |
| **並列修正** | ⚠️ C-01, C-03#3 と同一ファイル — 同Workerで実施 |
| **検出元** | 12:24 I-01 |

直前のfilteringで `nextPanes` からnilは除外済みのため実質安全だが、周囲の全ループにnilチェックがあり一貫性に欠ける。`if candidate == nil { continue }` を追加。

---

### I-02: `formatWindowLine` のfallback `window.Panes[0]` がnil可能性

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/format.go` L37-44 |
| **並列修正** | ✅ 可 |
| **検出元** | 12:23 SUG-11, 12:24 I-02 |

`ActivePN` 位置のpaneがnilの場合のfallbackで `window.Panes[0]` を使っているが、これもnil可能性あり。最初の非nilペインを探すべき。

**修正案:**
```go
if pane == nil {
    for _, p := range window.Panes {
        if p != nil {
            pane = p
            break
        }
    }
}
```

---

### I-03: `filterStalePathEntries` に空substring引数ガード欠落

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/install/shim_cleanup_windows.go` |
| **並列修正** | ✅ 可（I-12テストと同Workerで実施推奨） |
| **検出元** | 12:23 SUG-06 (一部), 12:24 I-03 |

`substring` が空文字列の場合、`strings.Contains(x, "")` は常にtrueを返し全PATH項目が削除される。定数呼びのため現時点で実害なしだが防御的にガード追加。

---

### I-04: `useBackendSync.ts` — 部分デルタが拒否される

| 項目 | 内容 |
|------|------|
| **ファイル** | `frontend/src/hooks/useBackendSync.ts` L176-183 |
| **並列修正** | ✅ 可（I-06と同一ファイル — 同Worker推奨） |
| **検出元** | 12:24 I-04 |

`upserts` と `removed` の両方が配列でない場合に早期リターン。「削除のみ」や「追加のみ」の有効なデルタが無視される。

**修正案:** `?? []` でデフォルト化し、両方空の場合のみ早期リターン。

---

### I-05: `useWindowRename.ts` — cancelとsession変更時のref/stateクリア漏れ

| 項目 | 内容 |
|------|------|
| **ファイル** | `frontend/src/hooks/useWindowRename.ts` |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 I-1, 12:24 I-05 |

2つの問題を含む:
1. `cancelWindowRename` で `renameValueRef.current` がクリアされない
2. sessionId変更時のリセットeffectで `lastRefCallbackRef.current = null` が欠如

---

### I-06: `useBackendSync.ts` — `BackendEventMap` と実際のハンドラーの型不整合

| 項目 | 内容 |
|------|------|
| **ファイル** | `frontend/src/hooks/useBackendSync.ts` L23, L141 |
| **並列修正** | ⚠️ I-04と同一ファイル — 同Worker推奨 |
| **検出元** | 11:58 I-2 |

`"config:load-failed"` の `message` を型定義で `string`（必須）に変更したが、ハンドラーでは optional のまま。いずれかに統一が必要。

---

### I-07: `pruneLogWarning` のタイムスタンプ消失

| 項目 | 内容 |
|------|------|
| **ファイル** | `cmd/tmux-shim/main.go` |
| **並列修正** | ✅ 可 |
| **検出元** | 12:23 IMP-02 |

`log.New(..., log.LstdFlags)` から `fmt.Fprintf` への変更でタイムスタンプが消失。`debugLogFallbackMessage` は依然 `log.LstdFlags` を使用しており、同一プレフィックスでフォーマット不統一。

**修正案:**
```go
func pruneLogWarning(format string, args ...any) {
    msg := fmt.Sprintf(format, args...)
    now := time.Now().Format("2006/01/02 15:04:05")
    fmt.Fprintf(os.Stderr, "[DEBUG-SHIM] %s %s\n", now, msg)
}
```

---

### I-08: `useTerminalFontSize.ts` に hook ordering WARNING コメント欠落

| 項目 | 内容 |
|------|------|
| **ファイル** | `frontend/src/hooks/useTerminalFontSize.ts` |
| **並列修正** | ✅ 可 |
| **検出元** | 12:23 IMP-03 |

他の3フック（`useTerminalSetup`, `useTerminalEvents`, `useTerminalResize`）全てに追加されている「WARNING: Hook call order matters」コメントがこのフックにだけ欠落。

---

### I-09: `app_guards.go` — センチネルエラー化の不整合

| 項目 | 内容 |
|------|------|
| **ファイル** | `app_guards.go` |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 I-3, 12:23 SUG-01, 12:24 S-02 |

`errSessionNotInitialized` のみセンチネルエラー化されているが、`requireRouter()` は `errors.New("router is unavailable")` のままインライン生成。同一ファイル内でガードパターンが不統一。`errRouterNotInitialized` を定義して統一、または `errors.Is()` 不要の旨コメント記載。

---

### I-10: `app_panic_recovery_test.go` — `wantAttempts` 値が偶然一致で誤解を招く

| 項目 | 内容 |
|------|------|
| **ファイル** | `app_panic_recovery_test.go` L113 |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 I-4, 12:23 SUG-04 |

`panicCount = maxPanicRestartRetries - 1` のケースで `wantAttempts: maxPanicRestartRetries` は数値的に正しいが、`wantExhausted: true` のケースと同じ値になり区別困難。`tt.panicCount + 1` のような式で意図を明確化。

---

### I-11: `putFeedBuffer(nil)` nilガードのテスト欠如

| 項目 | 内容 |
|------|------|
| **ファイル** | `app_pane_feed.go` → テスト: `app_pane_feed_test.go` |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 I-5 |

プロジェクトルール「nilガード追加時はテスト必須」に違反。`putFeedBuffer(nil)` がpanicしないことの確認テスト追加。

---

### I-12: `filterStalePathEntries` エッジケーステスト不足

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/install/shim_cleanup_windows_test.go` |
| **並列修正** | ⚠️ I-03と同Workerで実施推奨 |
| **検出元** | 12:23 SUG-06, 12:24 I-07 |

不足テスト: 空 `pathValue`、空 `substring`（全エントリ削除）、複数staleエントリ、大文字小文字混在、セミコロンのみの `pathValue`。

---

### I-13: `tmuxStore.ts` — `resolveActiveWindowId` の JSDoc が日本語

| 項目 | 内容 |
|------|------|
| **ファイル** | `frontend/src/stores/tmuxStore.ts` L68 |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 I-6 |

新規追加関数のJSDocが日本語。AGENTS.md「ファイルへの書き込みは全て英語」ルール違反。

---

### I-14: `syncPaneStates` snapshot内 window nilチェック欠落

| 項目 | 内容 |
|------|------|
| **ファイル** | `app_events.go` L277-290 |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 I-8, 12:23 SUG-05 |

`window.Panes == nil` チェックはあるが `window` 自体のnilチェックがない。Goではnil rangeは安全だが、他の全ループではwindow nilチェックを行っており一貫性に欠ける。`if window == nil || window.Panes == nil` に変更。

---

### I-15: `ResolveDirectionalPane` nilペインスキップテスト不足

| 項目 | 内容 |
|------|------|
| **ファイル** | `internal/tmux/session_manager_directional_test.go` |
| **並列修正** | ✅ 可 |
| **検出元** | 12:24 I-06 |

nil paneスキップロジックが追加されたが、Panesスライスにnilエントリが混在するケースのテストがない。

---

### I-16: `paneOutputEventFromPayload` — Data `[]byte` エイリアシング

| 項目 | 内容 |
|------|------|
| **ファイル** | `app_events.go` L130-132 |
| **並列修正** | ✅ 可 |
| **検出元** | 11:58 I-9 |

`copied := event` で struct copy するが `Data []byte` のバッキング配列は共有。実際の producer (ConPTY) は Read ごとに新バッファ割当のため実害なしだが、明示的 deep copy (`append([]byte(nil), event.Data...)`) を検討。

---

## Suggestions（23件）

### SUG-01: `buildPaneEnvSkipDefaults` と `buildPaneEnv` のコード重複

- **ファイル**: `internal/tmux/command_router.go`
- **検出元**: 11:58 S-1, 12:23 SUG-03, 12:24 S-01
- 共通ヘルパー抽出でDRY化可能。現時点はコメントで意図が明確なため許容。

### SUG-02: `errSessionNotInitialized` の使用箇所なし

- **ファイル**: `app_guards.go`
- **検出元**: 12:23 SUG-02
- コメント「enables callers to use errors.Is()」だが実使用なし。テスト追加 or コメント修正。

### SUG-03: `errSessionNotInitialized` の `errors.Is` テスト不足

- **ファイル**: `app_guards.go` テスト
- **検出元**: 12:23 SUG-10
- sentinel エラーの判定可能性テストがない。

### SUG-04: `buildPaneEnvSkipDefaults` のblocked keyテスト不足

- **ファイル**: `internal/tmux/command_router_pane_env_test.go`
- **検出元**: 12:23 SUG-09, 12:24 S-07
- `PATH`, `COMSPEC` 等のblocked keyを `reqEnv` に含めた場合の除外テスト不足。

### SUG-05: `reqEnv` TMUX系キー上書きテスト不足

- **ファイル**: `internal/tmux/command_router_pane_env_test.go`
- **検出元**: 12:23 SUG-12
- `reqEnv["TMUX"] = "user-value"` 設定時に `addTmuxEnvironment` で正しく上書きされるかの検証なし。

### SUG-06: `resolveActiveWindowId` ヘルパーの部分的適用

- **ファイル**: `frontend/src/stores/tmuxStore.ts`, `frontend/src/utils/session.ts`
- **検出元**: 12:23 SUG-07
- `utils/session.ts` の `resolveActiveWindow` が `session.active_window_id` を直接使用。実害なしだがロジック一貫性検討。

### SUG-07: `resolveActiveWindowId` の単体テスト不足

- **ファイル**: `frontend/tests/`
- **検出元**: 12:23 SUG-08
- `0` (有効ID, falsy), `undefined`, `null` の各パターンテストがない。

### SUG-08: `ResolveDirectionalPane` DirNone分岐統合

- **ファイル**: `internal/tmux/session_manager_targets.go`
- **検出元**: 11:58 S-2
- DirNoneチェックをWindow nilチェックの前に移動するとロジック簡素化可能。

### SUG-09: `SurvivingWindowID` のゼロ値曖昧性

- **ファイル**: `internal/tmux/session_manager_windows.go`
- **検出元**: 12:24 S-03
- `*int` やフラグフィールドで排除可能だが、`SessionRemoved` チェックで対処可能なため現状維持OK。

### SUG-10: WARNING コメント3ファイル重複 → DRY化

- **ファイル**: `useTerminalEvents.ts`, `useTerminalResize.ts`, `useTerminalSetup.ts`
- **検出元**: 12:24 S-04
- `TerminalPane.tsx` に正式な契約コメントを置き、各フックから参照する方がDRY。

### SUG-11: `modelTransformer` のレシーバ名 `t` が `testing.T` と紛らわしい

- **ファイル**: `cmd/tmux-shim/model_transform.go`
- **検出元**: 12:24 S-05
- `mt` や `tr` が望ましい。

### SUG-12: `applyShellTransform` の `strings.ToLower` 防御的コメント追加

- **ファイル**: `cmd/tmux-shim/command_transform.go`
- **検出元**: 12:24 S-06

### SUG-13: `applyLayoutPresetToWindowLocked` 全nil paneケーステスト

- **ファイル**: テスト対象: `internal/tmux/session_manager_panes.go`
- **検出元**: 12:24 S-08
- 全paneがnilの場合の `"window has no valid panes"` エラー返却パスのテストがない。

### SUG-14: `window_panes` フォーマット変数がnil要素含むカウントを返す

- **ファイル**: `internal/tmux/format.go`
- **検出元**: 12:24 S-09
- `len(window.Panes)` はnil要素含むカウント。前提をコメントで明示すべき。

### SUG-15: `ConfirmDialog.tsx` の `inert` attr不使用理由コメントが長い

- **ファイル**: `frontend/src/components/ConfirmDialog.tsx`
- **検出元**: 12:24 S-10
- 6行のインラインコメントを要約可能。

### SUG-16: `→` → `->` 残存確認

- **検出元**: 11:58 S-4
- 変更対象外ファイルに `→` が残存していないか一括確認推奨。

### SUG-17: `workerName` サニタイズ検討

- **ファイル**: `frontend/src/hooks/useBackendSync.ts`
- **検出元**: 11:58 S-5
- Wailsデスクトップアプリのテキスト表示のためXSSリスクなし。UIがHTMLレンダリングに変更される場合は要注意。

### SUG-18: `captureEmitter` テストヘルパー共通化

- **検出元**: 11:58 S-6
- 複数テストファイルで独立定義。`testutil_test.go` へ共通化検討。

### SUG-19: `copyPaneSlice` 空スライス境界値テスト

- **ファイル**: `internal/tmux/session_manager_pane_io_test.go`
- **検出元**: 11:58 S-7
- 空スライス `[]*TmuxPane{}` 入力時の動作が未テスト。

### SUG-20: `GetPaneContextSnapshot` の `SetEnvironment` 同時実行テスト

- **ファイル**: `internal/tmux/session_manager_env_test.go`
- **検出元**: 11:58 S-8

### SUG-21: TODOにチケット番号追加

- **ファイル**: `app_lifecycle.go`, `app_pane_feed.go`
- **検出元**: 11:58 S-9, 12:24関連
- 忘れられがちなTODOにIssue番号を含めると追跡しやすい。

### SUG-22: `waitWithTimeout` 関数名変更検討

- **ファイル**: `app_lifecycle.go`
- **検出元**: 11:58 S-11
- コメントで使用制限を明記しているが、`waitWithTimeoutForShutdown` 等への改名で型レベル制約を検討。

### SUG-23: `resolveWindowPaneTarget` nilチェック位置のコメント追加

- **ファイル**: `internal/tmux/session_manager_targets.go`
- **検出元**: 11:58 S-13
- index解決後のnilチェック遅延の意図をコメントで明確化。

---

## Strengths（良い点）

1. **`os.IsNotExist` → `errors.Is(err, os.ErrNotExist)` の網羅的移行完了**: 本番コード8箇所・テストコード10箇所が一括修正。Go 1.13以降のイディオムに完全準拠
2. **防御的nilガードの体系的強化**: `SwapPanes`, `applyLayoutPresetToWindowLocked`, `handleListWindows`, `ResolveDirectionalPane` 等に一貫してnilガード追加
3. **設計判断のドキュメント化**: `format.go` のmicro-TOCTOU許容理由、nil paneフォールバック戦略のDESIGNコメント、`removeWindowResult.SurvivingWindowID` のゼロ値曖昧性注記
4. **pane_env 適用範囲の明確化**: `buildPaneEnvSkipDefaults` 導入で初期ペインと追加ペインの環境変数適用を分離
5. **filterStalePathEntries の関数抽出**: テスタビリティ向上の良いリファクタリング
6. **テスト品質が全体的に高水準**: テーブル駆動テスト、structフィールドカウントガード、deep copy検証、セキュリティテスト（パストラバーサル攻撃）
7. **`resolveActiveWindowId` の共通化**: DRY原則に沿った良いリファクタリング
8. **Unicode矢印 `→` → ASCII `->` の統一**: クロスプラットフォーム互換性向上
9. **Copy-on-Write ドキュメント追加**: `session_manager_env.go` のCOW契約の明示化
10. **Hook呼び出し順序のWARNINGコメント**: React hook間の暗黙的依存関係を明示化
11. **panic リカバリー定数のドキュメント化**: 各定数にコメント追加、テストも厳密検証追加

---

## テストカバレッジ概要

| プロダクションファイル | テストファイル | 評価 | 備考 |
|---|---|---|---|
| `app_events.go` | `app_events_test.go` | ◎ | テーブル駆動、nilガード、debounce全網羅 |
| `app_guards.go` | (間接) | ○ | `requireSessionsWithPaneID` 直接テスト有 |
| `app_helpers.go` | なし | **✗** | toString/toBytes 直接テスト無し (C-07) |
| `app_pane_feed.go` | `app_pane_feed_test.go` | ○ | nilガード一部未テスト (I-11) |
| `app_panic_recovery.go` | `app_panic_recovery_test.go` | ◎ | バックオフ全段階+最大リトライ検証 |
| `app_pane_api.go` | `app_pane_api_test.go` | ◎ | |
| `app_session_api.go` | `app_session_api_test.go` | ◎ | |
| `app_worktree_api.go` | `app_worktree_api_test.go` | ◎ | |
| `app_snapshot_delta.go` | `app_snapshot_delta_test.go` | ◎ | |
| `cmd/tmux-shim/*.go` | `*_test.go` | ◎ | |
| `internal/tmux/session_manager_pane_io.go` | test | **△** | WriteToPanesInWindow欠如 (C-05) |
| `internal/tmux/session_manager_panes.go` | (間接) | **△** | ApplyLayoutPresetByWindowID欠如 (C-06) |
| `internal/tmux/format.go` | `format_test.go` | ◎ | |
| `internal/tmux/session_manager_env.go` | test | ◎ | 並行アクセス、deep copy |
| `internal/install/shim_cleanup_windows.go` | test | ○ | エッジケース不足 (I-12) |

**凡例**: ◎ 優秀 / ○ 良好 / △ 不足 / ✗ 欠如

---

## クロスモジュール副作用分析

| 変更 | 副作用リスク | 判定 |
|------|-------------|------|
| `buildPaneEnvSkipDefaults` in handleNewSession | 全セッション作成パスが `handleNewSession` 経由 | **安全** |
| `errSessionNotInitialized` sentinel | 文字列未変更。フロントエンド未受信 | **安全** |
| nil ペインガード | 通常操作では nil ペインは生成されない | **安全** |
| `pruneLogWarning` フォーマット | 外部ツール依存なし | **安全**（TS消失を除く） |
| `resolveActiveWindowId` ヘルパー | `utils/session.ts` 未使用だがフォールバックあり | **実害なし** |
| UI ラベル変更 | 単一箇所で完結 | **安全** |
| `config:updated` 型簡素化 | バックエンドは常にラッパー構造体を送信 | **安全** |

---

## 並列作業表

### 修正タスク一覧

| # | ID | 深刻度 | 対象ファイル | 修正内容 | 推定工数 |
|---|-----|--------|-------------|----------|---------|
| 1 | C-01 | **Critical** | `internal/tmux/session_manager_pane_lifecycle.go` | `rebuildLayoutFromPaneOrder` nilペインスキップ | 小 |
| 2 | C-02 | **Critical** | `internal/tmux/session_manager_windows.go` | `renameWindowByIndexLocked` nilチェック | 小 |
| 3 | C-03 | **Critical** | 複数ファイル (7箇所) | `m.panes[id]` nilガード統一 | 中 |
| 4 | C-04 | **Critical** | `internal/tmux/session_manager_targets.go` | `resolveTargetCore` nil pane返却防止 | 小 |
| 5 | C-05 | **Critical** | `internal/tmux/session_manager_pane_io_test.go` | `WriteToPanesInWindow` テスト追加 | 中 |
| 6 | C-06 | **Critical** | `internal/tmux/session_manager_panes_test.go` | `ApplyLayoutPresetByWindowID` テスト追加 | 中 |
| 7 | C-07 | **Critical** | `app_helpers_test.go` (新規) | `toString`/`toBytes` テスト追加 | 小 |
| 8 | I-01 | Important | `internal/tmux/session_manager_pane_lifecycle.go` | `killPaneLocked` reindexループ nilチェック | 小 |
| 9 | I-02 | Important | `internal/tmux/format.go` | `formatWindowLine` fallback nil安全化 | 小 |
| 10 | I-03 | Important | `internal/install/shim_cleanup_windows.go` | `filterStalePathEntries` 空substring ガード | 小 |
| 11 | I-04 | Important | `frontend/src/hooks/useBackendSync.ts` | 部分デルタ許容修正 | 小 |
| 12 | I-05 | Important | `frontend/src/hooks/useWindowRename.ts` | cancel + session変更時のrefクリア | 小 |
| 13 | I-06 | Important | `frontend/src/hooks/useBackendSync.ts` | `BackendEventMap` 型整合性統一 | 小 |
| 14 | I-07 | Important | `cmd/tmux-shim/main.go` | `pruneLogWarning` タイムスタンプ復元 | 小 |
| 15 | I-08 | Important | `frontend/src/hooks/useTerminalFontSize.ts` | hook ordering WARNING コメント | 小 |
| 16 | I-09 | Important | `app_guards.go` | `requireRouter` センチネルエラー統一 | 小 |
| 17 | I-10 | Important | `app_panic_recovery_test.go` | `wantAttempts` 表記改善 | 小 |
| 18 | I-11 | Important | `app_pane_feed_test.go` | `putFeedBuffer(nil)` テスト追加 | 小 |
| 19 | I-12 | Important | `internal/install/shim_cleanup_windows_test.go` | `filterStalePathEntries` エッジケーステスト | 中 |
| 20 | I-13 | Important | `frontend/src/stores/tmuxStore.ts` | JSDoc 英語化 | 小 |
| 21 | I-14 | Important | `app_events.go` | `syncPaneStates` window nilチェック | 小 |
| 22 | I-15 | Important | `internal/tmux/session_manager_directional_test.go` | nilペインスキップテスト追加 | 中 |
| 23 | I-16 | Important | `app_events.go` | `paneOutputEventFromPayload` Data deep copy検討 | 小 |

### 並列作業グループ

全タスクを依存関係とファイル競合に基づきグループ化。**各グループは完全に独立しており、全グループ並列実行可能。**

```
┌──────────────────────────────────────────────────────────────────────────┐
│ Worker A: Go backend — session_manager nilガード一括修正               │
│                                                                          │
│  ① C-01: rebuildLayoutFromPaneOrder nilスキップ                        │
│  ② I-01: killPaneLocked reindexループ nilチェック                      │
│     ↑ ①②は同一ファイル (session_manager_pane_lifecycle.go) — 順次実施  │
│                                                                          │
│  ③ C-03#3: killPaneLocked m.panes[id] nilガード                       │
│     ↑ ②と同一メソッド — ②に含めて実施                                  │
│                                                                          │
│  ④ C-03#4,#5: SplitPane / SetActivePane nilガード                     │
│     (session_manager_panes.go)                                           │
│                                                                          │
│  ⑤ C-03#6,#7 + C-04: resolveTargetCore / ResolveDirectionalPane       │
│     (session_manager_targets.go)                                         │
│                                                                          │
│  ⑥ C-03#1,#2: ListPanesByWindowTarget nilガード                       │
│     (session_manager_pane_io.go)                                         │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ Worker B: Go backend — 個別ファイル修正                                │
│                                                                          │
│  ① C-02: renameWindowByIndexLocked nilチェック                         │
│     (session_manager_windows.go)                                         │
│                                                                          │
│  ② I-02: formatWindowLine fallback nil安全化                           │
│     (format.go)                                                          │
│                                                                          │
│  ③ I-14: syncPaneStates window nilチェック                             │
│     (app_events.go)                                                      │
│                                                                          │
│  ④ I-16: paneOutputEventFromPayload Data deep copy検討                 │
│     (app_events.go — ③と同一ファイル、順次実施)                         │
│                                                                          │
│  ⑤ I-09: requireRouter センチネルエラー統一                            │
│     (app_guards.go)                                                      │
│                                                                          │
│  ⑥ I-07: pruneLogWarning タイムスタンプ復元                            │
│     (cmd/tmux-shim/main.go)                                              │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ Worker C: Go backend — install / filterStalePathEntries                │
│                                                                          │
│  ① I-03: 空substring ガード追加                                        │
│     (shim_cleanup_windows.go)                                            │
│                                                                          │
│  ② I-12: エッジケーステスト追加                                         │
│     (shim_cleanup_windows_test.go)                                       │
│     ↑ ①②は本体+テストの対 — 同Worker内で順次実施                       │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ Worker D: Go テスト追加（新規テストのみ・プロダクションコード変更なし） │
│                                                                          │
│  ① C-05: WriteToPanesInWindow テスト追加                               │
│     (session_manager_pane_io_test.go)                                    │
│                                                                          │
│  ② C-06: ApplyLayoutPresetByWindowID テスト追加                        │
│     (session_manager_panes_test.go)                                      │
│                                                                          │
│  ③ C-07: toString/toBytes テスト追加                                   │
│     (app_helpers_test.go — 新規)                                         │
│                                                                          │
│  ④ I-10: wantAttempts 表記改善                                          │
│     (app_panic_recovery_test.go)                                         │
│                                                                          │
│  ⑤ I-11: putFeedBuffer(nil) テスト追加                                 │
│     (app_pane_feed_test.go)                                              │
│                                                                          │
│  ⑥ I-15: ResolveDirectionalPane nilペインテスト追加                    │
│     (session_manager_directional_test.go)                                │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ Worker E: Frontend 修正                                                 │
│                                                                          │
│  ① I-04 + I-06: useBackendSync.ts 部分デルタ + 型整合性                │
│     ↑ 同一ファイル — 同時実施                                           │
│                                                                          │
│  ② I-05: useWindowRename.ts cancel + session変更時refクリア            │
│                                                                          │
│  ③ I-08: useTerminalFontSize.ts WARNINGコメント追加                    │
│                                                                          │
│  ④ I-13: tmuxStore.ts JSDoc 英語化                                     │
└──────────────────────────────────────────────────────────────────────────┘
```

### 作業順序の推奨

```
Phase 1 (最優先 — 全Worker並列実行)
├── Worker A: C-01 + C-03 + C-04 + I-01  (nilガード一括)
├── Worker B: C-02 + I-02 + I-09 + I-07 + I-14 + I-16
├── Worker C: I-03 + I-12
├── Worker D: C-05 + C-06 + C-07 + I-10 + I-11 + I-15
└── Worker E: I-04 + I-05 + I-06 + I-08 + I-13

Phase 2 (Phase 1 完了後 — 余裕があれば)
└── Suggestions (SUG-01 ～ SUG-23) を優先度に応じて対応
```

### Worker間の依存関係図

```
Worker A ──→ 完了後 Worker D ⑥ (I-15) のテスト対象コードが確定
             （ただし Worker D は先行してテスト構造を準備可能）

Worker C ──→ I-03 完了後 I-12 テスト実施

その他のWorker間依存は なし → 全て並列実行OK
```
