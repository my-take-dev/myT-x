# 統合レビュー — ClaudeEnv / PaneEnv 環境変数制御機能

**統合日時**: 2026-02-19 16:00  
**統合元**: review-20260219152000.md, review-20260219152007.md, review-20260219152754.md  
**対象**: `myT-x/` 配下のコミット前変更（約32ファイル, +1,000〜2,000行の差分）  
**レビュー方式**: 5つの専門レビューエージェントによる3回の並列レビューを統合  

---

## 変更概要

既存の `PaneEnv`（ペイン環境変数）機能に加え、`ClaudeEnv`（Claude Code 環境変数）を新規追加。
セッション作成時に `useClaudeEnv` / `usePaneEnv` フラグで適用を制御し、追加ペイン作成時には
`buildPaneEnvForSession()` による5層マージロジックで環境変数を合成する。

---

## レビュー対象ファイル

### Backend Go — Config & tmux層
| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | `internal/config/config.go` | `ClaudeEnvConfig`構造体追加、`sanitizeClaudeEnv`、Clone対応、PaneEnvDefaultEnabled追加 |
| 2 | `internal/config/config_test.go` | ClaudeEnv関連テスト追加（Clone, sanitize, Load/Save, フィールド数ガード） |
| 3 | `internal/tmux/command_router.go` | `UpdateClaudeEnv`, `claudeEnvView`, `ClaudeEnvSnapshot`, `buildPaneEnvForSession` |
| 4 | `internal/tmux/command_router_handlers_pane.go` | splitWindowResolved: セッションレベルenv制御対応 |
| 5 | `internal/tmux/command_router_handlers_window.go` | handleNewWindow: セッションレベルenv制御対応 |
| 6 | `internal/tmux/command_router_options_test.go` | RouterOptionsフィールド数 5→6 |
| 7 | `internal/tmux/session_manager.go` | TmuxSession: UseClaudeEnv/UsePaneEnv追加 |
| 8 | `internal/tmux/session_manager_env.go` | SetUseClaudeEnv/SetUsePaneEnv |
| 9 | `internal/tmux/session_manager_helpers.go` | copyBoolPtr |
| 10 | `internal/tmux/session_manager_sessions.go` | cloneSessionForRead: UseClaudeEnv/UsePaneEnvコピー |

### Backend Go — App層
| # | ファイル | 変更内容 |
|---|---------|---------|
| 11 | `app.go` | claudeEnvUpdateMuロック追加、claudeEnvAppliedVersion追加 |
| 12 | `app_claude_env_descriptions.go` | Claude Code環境変数の説明マップ（新規） |
| 13 | `app_config_api.go` | applyRuntimeClaudeEnvUpdate、GetClaudeEnvVarDescriptions |
| 14 | `app_lifecycle.go` | startup時のClaudeEnv初期化 |
| 15 | `app_session_api.go` | CreateSession: useClaudeEnv/usePaneEnv引数追加 |
| 16 | `app_session_api_test.go` | 引数追加対応 |
| 17 | `app_snapshot_delta_test.go` | TmuxSessionフィールド数 11→13 |
| 18 | `app_worktree_api.go` | createSessionForDirectory: claude_envマージ、WorktreeSessionOptions拡張 |
| 19 | `app_worktree_api_test.go` | WorktreeSessionOptionsフィールド数 4→6 |

### Frontend — TypeScript/React
| # | ファイル | 変更内容 |
|---|---------|---------|
| 20 | `frontend/src/api.ts` | GetClaudeEnvVarDescriptions API追加 |
| 21 | `frontend/src/components/NewSessionModal.tsx` | useClaudeEnv/usePaneEnvチェックボックス、GetConfig連携 |
| 22 | `frontend/src/components/SettingsModal.tsx` | claude-envタブ追加、handleSave拡張 |
| 23 | `frontend/src/components/settings/ClaudeEnvSettings.tsx` | 新規コンポーネント |
| 24 | `frontend/src/components/settings/PaneEnvSettings.tsx` | defaultEnabledチェックボックス追加 |
| 25 | `frontend/src/components/settings/settingsReducer.ts` | Claude Envアクション追加 |
| 26 | `frontend/src/components/settings/settingsValidation.ts` | validateClaudeEnvSettings追加 |
| 27 | `frontend/src/components/settings/types.ts` | ClaudeEnvEntry、FormState拡張 |
| 28 | `frontend/src/types/tmux.ts` | AppConfigClaudeEnv型追加 |

### 自動生成・設定
| # | ファイル | 変更内容 |
|---|---------|---------|
| 29 | `frontend/wailsjs/go/main/App.d.ts` | 自動生成 |
| 30 | `frontend/wailsjs/go/main/App.js` | 自動生成 |
| 31 | `frontend/wailsjs/go/models.ts` | 自動生成 |
| 32 | `config.yaml` | claude_env設定例追加 |

---

## Critical Issues（0件）

致命的な問題は検出されませんでした（3レビュー共通）。

---

## Important Issues（23件）

### ■ コード重複・共通化

#### I-01: `sanitizePaneEnv` と `sanitizeClaudeEnv` のコード重複（~130行）+ 空map正規化不一致
- **ファイル**: `internal/config/config.go` L549-L690
- **種別**: 保守性
- **指摘**: 2関数のバリデーションループ本体（約45行）が完全に同一。差分はログプレフィックスと入出力のマップ参照先のみ。加えて、`sanitizeClaudeEnv` は空マップを `nil` に正規化するが、`sanitizePaneEnv` は空mapをそのまま残す不一致がある。
- **リスク**: 一方に修正を加えた際にもう一方への反映漏れ（ショットガン・サージェリ）。YAML `omitempty` の挙動差異。
- **推奨**: 共通ヘルパー `sanitizeEnvMap(entries map[string]string, logPrefix string) map[string]string` を抽出。空map正規化も統一する。

#### I-10: 3箇所のセッション作成でフラグ設定パターンが重複
- **ファイル**: `app_session_api.go` L63-L68, `app_worktree_api.go` L139-L144, L1401-L1406
- **種別**: 保守性
- **指摘**: `SetUseClaudeEnv` / `SetUsePaneEnv` の呼び出しパターンが3箇所で完全に同一。フラグ追加時に修正漏れリスク。
- **推奨**: ヘルパー関数 `applySessionEnvFlags(sessions, name, useClaudeEnv, usePaneEnv)` に抽出。

#### I-11: handler内のレガシー/新パス条件分岐の重複
- **ファイル**: `command_router_handlers_pane.go` L75-L87, `command_router_handlers_window.go` L153-L163
- **種別**: 保守性
- **指摘**: 2箇所で同一の `UseClaudeEnv != nil || UsePaneEnv != nil` 条件分岐パターンが存在。
- **推奨**: `resolveEnvForPaneCreation(sessionName, ...)` ヘルパーに抽出。

#### I-16: TS側 `validatePaneEnvSettings` と `validateClaudeEnvSettings` のバリデーション重複
- **ファイル**: `frontend/src/components/settings/settingsValidation.ts` L51-L119
- **種別**: 保守性
- **指摘**: 2関数のエントリ検証ループが完全同一。差分はプレフィックスキーと `EFFORT_LEVEL_KEY` チェックの有無のみ。
- **推奨**: 共通の `validateEnvEntries(entries, keyPrefix, options?)` を抽出。

### ■ 一貫性・設計

#### I-02: `NewCommandRouter` で PaneEnv がディープコピーされていない
- **ファイル**: `internal/tmux/command_router.go` L196-L268
- **種別**: 一貫性・データ安全性
- **指摘**: `ClaudeEnv` はディープコピーされているが、`PaneEnv` には同等の処理がない。呼び出し元がマップを変更するとデータ競合のリスク。
- **推奨**: `ClaudeEnv` と同様のディープコピーを追加。

#### I-03: `claudeEnvView()` と `paneEnvView()` のロック解放スタイル不統一
- **ファイル**: `internal/tmux/command_router.go` L115-L137
- **種別**: 一貫性・可読性
- **指摘**: `paneEnvView()` は `defer r.paneEnvMu.RUnlock()` を使用、`claudeEnvView()` は手動 Unlock。同じ copy-on-write 契約のためスタイル統一すべき。
- **推奨**: `claudeEnvView()` も `defer` に変更。

#### I-04: `createSessionForDirectory` の claude_env マージパスが追加ペインパスと異なる
- **ファイル**: `app_worktree_api.go` L186-L201
- **種別**: 保守性・一貫性
- **指摘**: 初期ペインでは `cfg.ClaudeEnv.Vars` を直接読んで fill-only マージ、追加ペインでは `claudeEnvView()` 経由で取得し overwrite マージ。2つのコードパスが独立しているため、将来のマージルール変更時に不整合リスク。
- **推奨**: コメントで意図的な差異を明記するか、共通マージヘルパーに統一。

#### I-12: `createSessionForDirectory` の `usePaneEnv` パラメータが未使用
- **ファイル**: `app_worktree_api.go` L240
- **種別**: コード品質
- **指摘**: シグネチャに `usePaneEnv bool` が追加されているが、関数本体で一切参照されていない。
- **推奨**: 設計意図（initial paneにはpane_envを適用しない）であればパラメータ削除かコメント明記。

#### I-17: `buildPaneEnvForSession` 内の blocked key フィルタリング不一致
- **ファイル**: `internal/tmux/command_router.go` L196-L236
- **種別**: 一貫性
- **指摘**: Layer 2/4 では `isBlockedEnvironmentKey` フィルタあり、Layer 1/3 では無い。下流で最終フィルタされるため実害はないが一貫性に欠ける。
- **推奨**: 全レイヤーで一貫化、または下流任せの旨をコメント追記。

#### I-18: `AppConfigClaudeEnv` 型が手動定義（Wails生成型と非同期リスク）
- **ファイル**: `frontend/src/types/tmux.ts` L49-L64
- **種別**: 型ドリフトリスク
- **指摘**: 他の型は `Pick<wailsConfig.XXX, ...>` で自動生成モデルと同期を取っているが、`AppConfigClaudeEnv` だけが手動定義。Go構造体変更時にサイレントに乖離する。`pane_env_default_enabled` の型定義も同様に `Pick<>` パターンに含めるべき。
- **推奨**: `Pick<wailsConfig.ClaudeEnvConfig, "default_enabled" | "vars">` に変更。

#### I-19: `GetClaudeEnvVarDescriptions` がグローバル map への直接参照を返す
- **ファイル**: `app_config_api.go` L147-L149
- **種別**: 安全性
- **指摘**: パッケージレベルの `claudeEnvVarDescriptions` map への直接参照を返している。Wails バインディング経由では JSON シリアライズされるため影響は限定的だが、Go 側から直接呼ばれた場合にグローバル状態を破壊可能。
- **推奨**: shallow copy を返す。

#### I-20: 片方のフラグのみ設定時の暗黙的デフォルト値
- **ファイル**: `command_router_handlers_pane.go` L89-L93, `command_router_handlers_window.go` L252-L256
- **種別**: ロジック
- **指摘**: `UseClaudeEnv` のみ明示設定し `UsePaneEnv` を設定しなかった場合、OR条件により新パスに入るが `usePaneEnv = false` となり、pane_env が fill-only すら適用されない。レガシーパスでは常に fill-only 適用される。
- **推奨**: 仕様通りならコメント明記。そうでなければ nil 時のデフォルトを fill-only に。

#### I-21: `handleNewWindow` で `GetSession` が2回呼ばれている
- **ファイル**: `internal/tmux/command_router_handlers_window.go`
- **種別**: パフォーマンス
- **指摘**: 1回目（寸法取得）と2回目（フラグ取得）で `GetSession` が呼ばれ、deep clone が2回走る。
- **推奨**: 1回目の結果を再利用する。

### ■ フロントエンド品質

#### I-05: `ClaudeEnvSettings.tsx` の useEffect に cleanup がない
- **ファイル**: `frontend/src/components/settings/ClaudeEnvSettings.tsx` L14-L21
- **種別**: React ベストプラクティス
- **指摘**: `api.GetClaudeEnvVarDescriptions()` の Promise 解決前にアンマウントされた場合、unmounted コンポーネントへの state 更新が発生する。
- **推奨**: `let cancelled = false` + cleanup 関数パターンを追加。

#### I-06: datalist が使用済みキーをフィルタしていない
- **ファイル**: `frontend/src/components/settings/ClaudeEnvSettings.tsx` L55-L59
- **種別**: UX
- **指摘**: 全 `knownKeys` が常に表示され、追加済みキーを選択するとバリデーションエラーになる。
- **推奨**: `usedKeys` セットで既存キーを除外。

#### I-09: `GetConfig` 失敗時に `useClaudeEnv`/`usePaneEnv` が false のままユーザー通知なし
- **ファイル**: `frontend/src/components/NewSessionModal.tsx`
- **種別**: UX
- **指摘**: `GetConfig()` 失敗時にデフォルト値 `false` のまま。`default_enabled: true` 設定済みユーザーは意図せず OFF でセッション作成し得る。
- **推奨**: 失敗時にトースト通知か「設定読込失敗」表示を追加。

### ■ テスト

#### I-07: `BLOCKED_ENV_KEYS` のフロントエンド/バックエンド整合性にガードテストがない
- **ファイル**: `frontend/src/components/settings/settingsValidation.ts` L5-L9
- **種別**: テスト・保守性
- **指摘**: フロントエンドの `BLOCKED_ENV_KEYS` とバックエンドの `blockedEnvironmentKeys` が独立定義。片方だけ変更時に不整合。
- **推奨**: API でブロックキー一覧を返すか、整合テストを追加。

#### I-13: `ClaudeEnvConfig` フィールド数ガードテスト欠落
- **ファイル**: `internal/config/config_test.go`
- **種別**: テスト
- **指摘**: `Config(10)`, `RouterOptions(6)`, `TmuxSession(13)` にはガードテストがあるが、`ClaudeEnvConfig(2)` にはない。
- **推奨**: `TestConfigStructFieldCounts` に追加。

#### I-14: 新規公開関数8件のテストカバレッジが0%
- **ファイル**: 複数
- **種別**: テストカバレッジ
- **指摘**: 以下の新規 public 関数に専用テストが存在しない：

| 関数 | ファイル | 重要度 |
|------|---------|--------|
| `buildPaneEnvForSession` | `command_router.go` | **最高**（5層マージの優先順位検証必須） |
| `UpdateClaudeEnv` | `command_router.go` | 高（nil/empty/normal） |
| `ClaudeEnvSnapshot` | `command_router.go` | 高（deep copy検証） |
| `claudeEnvView` | `command_router.go` | 高 |
| `SetUseClaudeEnv` | `session_manager_env.go` | 高（flag設定/取得、セッション未存在時） |
| `SetUsePaneEnv` | `session_manager_env.go` | 高 |
| `copyBoolPtr` | `session_manager_helpers.go` | 中（nil/true/false、ポインタ独立性） |
| `applyRuntimeClaudeEnvUpdate` | `app_config_api.go` | 高（バージョンゲート検証） |

#### I-15: `useClaudeEnv=true` パスのテストが完全に欠落
- **ファイル**: `app_session_api_test.go`, `app_worktree_api_test.go`
- **種別**: テストカバレッジ
- **指摘**: 全テストケースで `useClaudeEnv=false, usePaneEnv=false` のみ。`true` パスの動作検証が一切ない。
- **推奨**: テーブル駆動テストで以下を検証:
  - `useClaudeEnv=true, ClaudeEnv=nil` → envマージなし
  - `useClaudeEnv=true, ClaudeEnv.Vars={"KEY":"val"}` → マージされる
  - `useClaudeEnv=true, enableAgentTeam=true` → agent team envが優先

#### I-22: テストケース名とデータの認知的不一致
- **ファイル**: `internal/config/config_test.go` (TestSanitizeClaudeEnv)
- **種別**: テスト可読性
- **指摘**: "case insensitive dedup keeps first" テストで `"key": "first"` が排除され `"KEY": "second"` が残る。値名がソート順の結果と矛盾。
- **推奨**: 値名を `"lower"` / `"upper"` に変更。

### ■ 設定

#### I-23: `config.yaml` に `claude_env` 設定テンプレートが未追記
- **ファイル**: `config.yaml`
- **種別**: プロジェクトルール準拠
- **指摘**: CLAUDE.md「設定が追加となった場合には、現在使っている設定ファイルへの追記とREADMD.mdの更新を行う」ルールに該当。
- **推奨**: テンプレートを追記。

### ■ エラーハンドリング

#### I-08: `SetUseClaudeEnv`/`SetUsePaneEnv` 失敗時が Warn ログのみ
- **ファイル**: `app_worktree_api.go` L140-L145, L466-L471
- **種別**: エラーハンドリング
- **指摘**: 失敗時にフラグ未設定のまま追加ペインが作成されるとレガシーパスにフォールバック。
- **補足**: 失敗ケースはセッション名不一致のみ（直前に作成成功しているため極めて稀）。現実リスクは低い。

---

## Suggestions（21件）

### ■ Go Backend

| # | 内容 | ファイル | 備考 |
|---|------|---------|------|
| S-01 | `PaneEnvDefaultEnabled` の配置非対称（`Config`直下 vs `ClaudeEnvConfig`内ネスト）統一 | `config.go` 他 | 次回リファクタ時。影響範囲大 |
| S-02 | `UpdatePaneEnv`(nil→空map) vs `UpdateClaudeEnv`(nil→nil保持) のnil扱い不一致コメント | `command_router.go` | 意図が異なるならコメント明記 |
| S-03 | `SessionSnapshot` に `UseClaudeEnv`/`UsePaneEnv` 追加の確認 | `session_manager.go` | 意図的省略なら問題なし |
| S-04 | `CreateSession` のシグネチャが5引数（bool 3連続）で可読性低下 | `app_session_api.go` | options struct 導入を検討 |
| S-05 | `app_claude_env_descriptions.go` にClaude Codeバージョン情報を追記 | `app_claude_env_descriptions.go` | 87個の環境変数がハードコード |
| S-06 | `applyRuntimePaneEnvUpdate` と `applyRuntimeClaudeEnvUpdate` の構造重複 | `app_config_api.go` | 3つ目のenv種別追加時に検討 |
| S-07 | `SetUseClaudeEnv`/`SetUsePaneEnv` のメソッド完全重複 | `session_manager_env.go` | フラグ3つ以上時に検討 |
| S-08 | `findSessionByRootPath` のログレベル `Debug`→`Warn` 昇格 | `app_session_api.go` | 同一ディレクトリで複数セッション作成リスク |
| S-09 | セッション作成とフラグ設定の間の競合ウィンドウ | `app_worktree_api.go` | 実質発生しないが`NewSession`内で同時設定が理想 |
| S-10 | `claudeEnvView` の INVARIANT コメントを `paneEnvView` と同等に拡充 | `command_router.go` | |
| S-11 | `buildPaneEnvForSession` の map 容量ヒント追加 | `command_router.go` | allocation効率改善 |
| S-12 | `createSessionForDirectory` での TOCTOU — config snapshot を引数で渡す | `app_worktree_api.go` | 実害はほぼないが一貫性向上 |
| S-13 | ログプレフィックスの統一（`[DEBUG-CLAUDE-ENV]` 等） | 複数 | フィルタ容易性 |

### ■ Frontend

| # | 内容 | ファイル | 備考 |
|---|------|---------|------|
| S-14 | 削除ボタンが index ベースのフィルタ → `entry.id` ベースに | `ClaudeEnvSettings.tsx` | React バッチ更新でのズレ防止 |
| S-15 | `descriptions` フェッチがタブ切替時に毎回再実行 → 親でまとめてフェッチ | `ClaudeEnvSettings.tsx` | `SettingsModal` の `LOAD_CONFIG` で統合 |
| S-16 | `NewSessionModal` の `GetConfig` + `IsAgentTeamsAvailable` を `Promise.all` で並列化 | `NewSessionModal.tsx` | |
| S-17 | `NewSessionModal` チェックボックスにツールチップ追加 | `NewSessionModal.tsx` | 初見ユーザー向け |
| S-18 | `handleSubmit` の `useCallback` 依存配列が13個 → `useReducer` 検討 | `NewSessionModal.tsx` | 保守性 |
| S-19 | `ClaudeEnvEntry` と `PaneEnvEntry` の型が同一構造 → 共通の `EnvEntry` 型 | `types.ts` | 優先度低 |
| S-20 | バリデーション順序: ブロックキーチェックが「値必須」の後 | `settingsValidation.ts` | 修正するなら両関数同時に |
| S-21 | `pane_env_default_enabled` の `AppConfig` 型が optional だが `models.ts` では必須 | `tmux.ts` | I-18 と同時対応推奨 |

---

## Strengths（良い点）

### 設計・アーキテクチャ
- **`*bool` ポインタセマンティクス**: `UseClaudeEnv`/`UsePaneEnv` を nil（レガシー/未設定）・true・false の三値で区別する設計は適切
- **独立 mutex の分離設計**: `shimMu`/`paneEnvMu`/`claudeEnvMu` を独立させ「同時保持なし」と明記
- **レガシー互換フォールバック**: IPC経由セッションでは従来の `buildPaneEnv` を使用し後方互換維持
- **copy-on-write 契約のドキュメント**: INVARIANT コメントで並行安全性の根拠が追跡可能
- **バージョン順序制御**: `applyRuntimeClaudeEnvUpdate` が既存パターンと完全対称
- **ロック順序ドキュメント**: `app.go` に `claudeEnvUpdateMu -> claudeEnvMu` を明記

### テスト
- **フィールド数ガードテスト**: `Config(10)`, `RouterOptions(6)`, `TmuxSession(13)` で漏れ自動検知
- **sanitizeClaudeEnv テスト**: 8ケースで網羅的カバー
- **Clone 独立性テスト**: nil, deep copy 独立性, nil vars の3パターン
- **Load/Save round-trip**: YAML 永続化の往復検証3パターン

### フロントエンド
- **一貫したパターン踏襲**: ClaudeEnvSettings が PaneEnvSettings と同じ構造・命名規則
- **型安全な Reducer 設計**: `never` による exhaustive check が機能
- **API 整合性**: Wails 生成型定義と Go バックエンドのシグネチャが完全一致
- **datalist 入力補完**: 変数名候補・説明表示の UX 品質が高い
- **アクセシビリティ**: 新規 UI 要素に `id/htmlFor`, `aria-label` が適切に設定

### エラーハンドリング
- **二重バリデーション**: `BLOCKED_ENV_KEYS`, `ENV_VAR_NAME_PATTERN` がフロント・バック両側で一致
- **ロールバック統一**: 3つのセッション作成パスで一貫した defer + rollback
- **tmux-shim 契約遵守**: エラーで動作を停止せず Warn ログのみ

---

## 総合評価

| 観点 | 評価 | 備考 |
|------|------|------|
| 設計・アーキテクチャ | ⭐⭐⭐⭐ | ポインタセマンティクス、ロック設計、レガシー互換が優秀 |
| コード品質 | ⭐⭐⭐ | 重複が多いが、致命的バグなし |
| テストカバレッジ | ⭐⭐ | Config 層は高品質だが、Runtime 層が著しく不足 |
| エラーハンドリング | ⭐⭐⭐⭐ | 二重バリデーション、ロールバック統一が優秀 |
| フロントエンド品質 | ⭐⭐⭐⭐ | 型安全な Reducer、一貫したコンポーネント設計 |
| 一貫性 | ⭐⭐⭐ | パターン踏襲は良いが、重複の共通化が課題 |

**総括**: 既存パターンを忠実に踏襲した堅実な実装。主な改善点は **コード重複の共通化** と **ランタイム層のテスト追加**。致命的問題はなく、Important Issues 対応後にマージ可能。

---

## 修正タスク一覧と並列作業表

### タスク一覧

| ID | 指摘 | 修正概要 | 対象ファイル | 工数 | 優先度 |
|----|------|---------|-------------|------|--------|
| T-01 | I-01 | sanitize 共通ヘルパー抽出 + 空map正規化統一 | `config.go` | 中 | 高 |
| T-02 | I-02 | PaneEnv ディープコピー追加 | `command_router.go` | 小 | 高 |
| T-03 | I-03, S-10 | claudeEnvView defer 統一 + INVARIANT コメント拡充 | `command_router.go` | 小 | 中 |
| T-04 | I-17, S-11 | blockedKey フィルタ一貫性 + map 容量ヒント | `command_router.go` | 小 | 中 |
| T-05 | I-04 | 初期ペインマージパスのコメント追記 or 統一 | `app_worktree_api.go` | 小 | 中 |
| T-06 | I-12 | createSessionForDirectory usePaneEnv 対応 | `app_worktree_api.go` | 小 | 中 |
| T-07 | I-10 | セッションフラグ設定ヘルパー抽出 | `app_session_api.go`, `app_worktree_api.go` | 中 | 中 |
| T-08 | I-11 | handler レガシー/新パス分岐ヘルパー抽出 | `handlers_pane.go`, `handlers_window.go` | 中 | 中 |
| T-09 | I-20 | 片方フラグのみ設定時のデフォルト値対応 | `handlers_pane.go`, `handlers_window.go` | 小 | 高 |
| T-10 | I-21 | handleNewWindow GetSession 二重呼び出し排除 | `handlers_window.go` | 小 | 中 |
| T-11 | I-13 | ClaudeEnvConfig フィールド数ガードテスト追加 | `config_test.go` | 小 | 高 |
| T-12 | I-22 | テストケースの値名修正 | `config_test.go` | 小 | 低 |
| T-13 | I-19 | GetClaudeEnvVarDescriptions shallow copy 化 | `app_config_api.go` | 小 | 高 |
| T-14 | I-23 | config.yaml claude_env テンプレート追記 | `config.yaml` | 小 | 高 |
| T-15 | I-05 | useEffect cleanup 追加 | `ClaudeEnvSettings.tsx` | 小 | 高 |
| T-16 | I-06 | datalist 使用済みキーフィルタ | `ClaudeEnvSettings.tsx` | 小 | 中 |
| T-17 | S-14 | 削除ボタン id ベース化 | `ClaudeEnvSettings.tsx` | 小 | 低 |
| T-18 | I-16 | TS バリデーション共通化 | `settingsValidation.ts` | 小 | 中 |
| T-19 | I-18, S-21 | AppConfigClaudeEnv Pick 化 + 型整合 | `tmux.ts` | 小 | 中 |
| T-20 | I-09 | GetConfig 失敗時 UX 改善 | `NewSessionModal.tsx` | 小 | 中 |
| T-21 | I-07 | BLOCKED_ENV_KEYS 整合テスト追加 | テストファイル（新規） | 中 | 中 |
| T-22 | I-14 | 新規公開関数8件のテスト追加 | 複数テストファイル | 大 | 高 |
| T-23 | I-15 | useClaudeEnv=true パスのテスト追加 | `app_*_test.go` | 中 | 高 |
| T-24 | I-08 | SetUseClaudeEnv/SetUsePaneEnv 失敗時対応 | `app_worktree_api.go` | 小 | 低 |

---

### 並列作業マトリクス

◯ = 並列OK　× = 同一ファイル競合あり

|      | T-02 | T-03 | T-04 | T-05 | T-06 | T-07 | T-08 | T-09 | T-10 | T-15 | T-16 | T-17 |
|------|------|------|------|------|------|------|------|------|------|------|------|------|
| **T-02** | -  | ×  | ×  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  |
| **T-03** | ×  | -  | ×  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  |
| **T-04** | ×  | ×  | -  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  |
| **T-05** | ◯  | ◯  | ◯  | -  | ×  | ×  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  |
| **T-06** | ◯  | ◯  | ◯  | ×  | -  | ×  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  |
| **T-07** | ◯  | ◯  | ◯  | ×  | ×  | -  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  |
| **T-08** | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | -  | ×  | ×  | ◯  | ◯  | ◯  |
| **T-09** | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ×  | -  | ×  | ◯  | ◯  | ◯  |
| **T-10** | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ×  | ×  | -  | ◯  | ◯  | ◯  |
| **T-15** | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | -  | ×  | ×  |
| **T-16** | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ×  | -  | ×  |
| **T-17** | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ◯  | ×  | ×  | -  |

※ T-01, T-11〜T-14, T-18〜T-24 は上記すべてと並列OK（◯）のため省略

### 競合理由

| 競合ペア | 理由 |
|---------|------|
| T-02 × T-03 × T-04 | 同一ファイル `command_router.go` |
| T-05 × T-06 × T-07 | 同一ファイル `app_worktree_api.go` |
| T-08 × T-09 × T-10 | 同一ファイル `handlers_pane.go` / `handlers_window.go` |
| T-15 × T-16 × T-17 | 同一ファイル `ClaudeEnvSettings.tsx` |

---

### 推奨作業グループ

```
┌──────────────────────────────────────────────────────────────┐
│  グループA（Go Config層）⭕ 全て並列作業OK                      │
│                                                              │
│  T-01: sanitize共通ヘルパー抽出           config.go       中/高  │
│  T-11: ClaudeEnvConfigガードテスト追加     config_test.go  小/高  │
│  T-12: テストケース値名修正               config_test.go  小/低  │
│  T-13: shallow copy化                    app_config_api  小/高  │
│  T-14: config.yaml テンプレート追記       config.yaml     小/高  │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  グループB（Go Router層）⚠️ グループ内は順次推奨                 │
│                                                              │
│  T-02: PaneEnvディープコピー       → 先に   command_router 小/高  │
│  T-03: defer統一 + コメント拡充    → 次に   command_router 小/中  │
│  T-04: blockedKey一貫性 + 容量ヒント → 最後  command_router 小/中  │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  グループC（Go Handler層）⚠️ グループ内は順次推奨                │
│                                                              │
│  T-09: 片方フラグ設定時デフォルト値  → 先に  handlers_*    小/高  │
│  T-08: レガシーパス分岐ヘルパー抽出  → 次に  handlers_*    中/中  │
│  T-10: GetSession二重呼び出し排除   → 最後  handlers_win  小/中  │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  グループD（Go App層）⚠️ グループ内は順次推奨                    │
│                                                              │
│  T-05: 初期ペインマージコメント      → 先に  worktree_api  小/中  │
│  T-06: usePaneEnv未使用パラメータ    → 次に  worktree_api  小/中  │
│  T-07: フラグ設定ヘルパー抽出        → 次に  session/work  中/中  │
│  T-24: SetUse失敗時対応             → 最後  worktree_api  小/低  │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  グループE（Frontend ClaudeEnvSettings）⚠️ 順次推奨             │
│                                                              │
│  T-15: useEffect cleanup追加         → 先に                小/高  │
│  T-16: datalist使用済みキーフィルタ   → 次に                小/中  │
│  T-17: 削除ボタンidベース化          → 最後                小/低  │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  グループF（Frontend その他）⭕ 全て並列作業OK                   │
│                                                              │
│  T-18: TSバリデーション共通化     settingsValidation.ts   小/中  │
│  T-19: AppConfigClaudeEnv Pick化  tmux.ts                 小/中  │
│  T-20: GetConfig失敗時UX改善     NewSessionModal.tsx      小/中  │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  グループG（テスト追加）⭕ 全て並列作業OK                        │
│  ※ グループB,C,D完了後に実施推奨（リファクタ後のテスト作成）      │
│                                                              │
│  T-21: BLOCKED_ENV_KEYS整合テスト               テスト新規  中/中  │
│  T-22: 新規公開関数8件テスト（最重要）           テスト新規  大/高  │
│  T-23: useClaudeEnv=trueパスのテスト             テスト既存  中/高  │
└──────────────────────────────────────────────────────────────┘
```

### グループ間の依存関係

```
グループA ──→ 独立（いつでも実施可）
グループB ──→ 独立（いつでも実施可）
グループC ──→ 独立（いつでも実施可）
グループD ──→ 独立（いつでも実施可）
グループE ──→ 独立（いつでも実施可）
グループF ──→ 独立（いつでも実施可）
グループG ──→ グループ B, C, D 完了後が望ましい（実装変更後にテスト作成）
```

### 推奨実施順序

```
Phase 1（並列実施）: A + B + C + D + E + F
    ↓
Phase 2（Phase 1 完了後）: G
```

### 優先度別サマリ

| 優先度 | タスク | 件数 |
|--------|--------|------|
| **高** | T-01, T-02, T-09, T-11, T-13, T-14, T-15, T-22, T-23 | 9件 |
| **中** | T-03, T-04, T-05, T-06, T-07, T-08, T-10, T-16, T-18, T-19, T-20, T-21 | 12件 |
| **低** | T-12, T-17, T-24 | 3件 |

---

## 統合元レビューのトレーサビリティ

各 Important Issue がどのレビューで検出されたかの対応表：

| 統合ID | review-152000 | review-152007 | review-152754 |
|--------|---------------|---------------|---------------|
| I-01 | I-01 | I-04, S-03 | I-01 |
| I-02 | I-08 | — | I-02 |
| I-03 | I-02 | — | S-02 |
| I-04 | I-03 | — | — |
| I-05 | I-04 | — | — |
| I-06 | I-05 | — | — |
| I-07 | I-06 | — | — |
| I-08 | I-07 | — | — |
| I-09 | I-09 | — | S-12 |
| I-10 | — | S-01 | I-03 |
| I-11 | — | S-02 | I-04 |
| I-12 | — | — | I-05 |
| I-13 | — | I-03 | I-06 |
| I-14 | S-01,02,04,05 | T-01〜06 | I-07 |
| I-15 | S-03 | T-04 | I-08 |
| I-16 | S-06 | — | I-09 |
| I-17 | I-10 | — | I-10 |
| I-18 | — | I-05 | I-11 |
| I-19 | S-08 | I-01 | I-12 |
| I-20 | — | I-02 | — |
| I-21 | — | I-06 | — |
| I-22 | — | I-07 | — |
| I-23 | — | I-08 | — |
