# PR Review 統合: Claude Code 環境変数管理機能（claude_env）

**統合日時**: 2026-02-19 18:30  
**元レビュー**: review-20260219180013 / review-20260219180255 / review-20260219180806  
**対象**: myT-x/ 配下の全変更ファイル (37ファイル, +3038/-818行)  
**レビュー方式**: 3回のレビュー（5+5+7エージェント並列 + 手動テスト実行）を統合・重複排除

---

## 変更概要

Claude Code 向け環境変数管理機能の実装。5層環境変数マージシステム、セッション単位の env flag 制御（`UseClaudeEnv` / `UsePaneEnv`）、フロントエンド設定 UI を追加。

### カテゴリ別ファイル一覧

| カテゴリ | ファイル数 | 主な変更 |
|---------|-----------|---------|
| Config | 3 | `ClaudeEnvConfig` struct 追加, `sanitizeEnvMap` 共通リファクタ, `Clone` 更新 |
| Tmux | 10 | `resolveEnvForPaneCreation`, `buildPaneEnvForSession`, Session env flags |
| App | 10 | `claudeEnvUpdateMu`, env descriptions, API signature 変更, worktree env merge |
| Frontend | 13 | `ClaudeEnvSettings.tsx` (新規), `NewSessionModal` checkbox, reducer/validation |
| テスト | 複数 | 新規テスト多数追加, フィールド数ガード更新 |

---

## 統合結果サマリ

| カテゴリ | 件数 |
|---------|------|
| **CRITICAL (P0)** | 2 |
| **IMPORTANT (P1)** | 10 |
| **MEDIUM (M)** | 7 |
| **SUGGESTION (S)** | 14 |

---

## CRITICAL (P0) — 2件

### P0-1: テスト内 `sanitizeEnvMap` が本番コードと動作が異なり、テスト失敗を確認

**ファイル**: `internal/tmux/command_router_env_test.go` (L830-870 付近)  
**状態**: **テスト実行で失敗を確認済み**  
**検出レビュー**: 全3レビュー (Review 1: I-04, Review 2: P0-1, Review 3: P0-1)

テストファイル末尾にローカル定義された `sanitizeEnvMap` ヘルパーが、本番の `config.sanitizeEnvMap` と**決定的に異なる実装**になっている。

**本番コードとの差異:**

| 項目 | 本番 `config.sanitizeEnvMap` | テスト版ヘルパー |
|------|---------------------------|----------------|
| キーソート | `sort.Strings` で決定論的 | ソートなし（Go map ランダム反復） |
| 重複解決 | アルファベット順で最初のキーが勝つ | 非決定的（反復順次第で変動） |
| blocked key | `warnOnlyBlockedKeys` で事前警告 | 警告なし（拒否扱い） |
| value 長警告 | `maxCustomEnvValueBytes` 超過で警告 | 警告なし |
| バリデーション | 直接実装 | `sanitizeCustomEnvironmentEntry` 経由 |
| seen map 型 | `map[string]string` | `map[string]bool` |

**実際のテスト失敗ログ:**
```
=== RUN   TestSanitizeEnvMap/case-insensitive_duplicate_detection_windows-style
    command_router_env_test.go:863: sanitizeEnvMap() = map[key:second], want map[KEY:first]
--- FAIL: TestSanitizeEnvMap
```

**修正案**: テストヘルパーを削除し、本番の `config.SanitizeEnvMap` を export して直接テストする。または `config_test.go` にテストを移動する。

---

### P0-2: テスト内 `applySessionEnvFlags` が本番コードと異なるシグネチャ・挙動

**ファイル**: `internal/tmux/command_router_env_test.go` (L890-905 付近)  
**状態**: テストはパスするが、本番動作を検証していない  
**検出レビュー**: 全3レビュー (Review 1: S-06, Review 2: P0-2, Review 3: P0-2)

テスト内ヘルパー `applySessionEnvFlags` は `error` を返すが、本番の `app_worktree_api.go` 内の同名関数は `void`（`slog.Warn` 出力 + 継続）。

```go
// テスト版: error を返す
func applySessionEnvFlags(...) error { ... return err }

// 本番: void (ログ出力のみ)
func applySessionEnvFlags(...) { ... slog.Warn(...) }
```

**影響**: テストの "session not found" ケースが `wantErr` をチェックしているが、本番ではエラーは返されず警告ログのみ。テストがパスしても本番動作の正しさが保証されない。

**修正案**: テストヘルパーを削除し、本番関数のシグネチャに合わせるか、`app_worktree_api_test.go` に本番関数を直接テストするテストを追加する。

---

## IMPORTANT (P1) — 10件

### P1-1: `splitWindowResolved` が `sessionSnap=nil` を渡して冗長な deep clone 発生

**ファイル**: `internal/tmux/command_router_handlers_pane.go`  
**検出レビュー**: 全3レビュー (Review 1: S-09, Review 2: P1-1, Review 3: P1-1)

`splitWindowResolved` は `resolveEnvForPaneCreation(nil, ...)` と sessionSnap=nil を渡しているため、内部で再度 `GetSession()` による deep clone が実行される。対比として `handleNewWindow` は事前取得した snapshot を正しく渡している。

**修正案**: `splitWindowResolved` でも事前に session snapshot を取得して渡す。

---

### P1-2: `resolveEnvForPaneCreation` でセッション未発見時の silent fallback

**ファイル**: `internal/tmux/command_router.go` (`resolveEnvForPaneCreation` 関数)  
**検出レビュー**: Review 2: P1-2, Review 3: P1-2

```go
if !ok {
    sessionSnap = nil  // ← ログ出力なし
}
```

セッションが見つからない場合、legacy path にサイレントにフォールバックする。デバッグ困難。

**修正案**: セッション未発見時に `slog.Warn` 追加。
```go
if !ok {
    slog.Warn("[DEBUG-ENV] resolveEnvForPaneCreation: session not found, falling back to legacy path",
        "session", sessionName)
    sessionSnap = nil
}
```

---

### P1-3: `buildPaneEnvForSession` の Layer 1/3 コメントが不正確

**ファイル**: `internal/tmux/command_router.go` (`buildPaneEnvForSession` 関数)  
**検出レビュー**: 全3レビュー (Review 1: I-02, Review 2: P1-3, Review 3: P1-3)

Layer 1 と Layer 3 のコメントに「Layer 5 が blocked keys を保護する」とあるが、`addTmuxEnvironment` が上書きするのは `TMUX`, `TMUX_PANE` 等の tmux 固有キーのみ。`PATH`, `SYSTEMROOT` 等の blocked system keys は Layer 2/4 の `isBlockedEnvironmentKey()` チェック、および下流の `mergeEnvironment → sanitizeCustomEnvironmentEntry` で行われる。

**修正案**:
```go
// Layer 1: claude_env from config (fill base)
// NOTE: blocked-key filtering is intentionally omitted here; claude_env is
// admin-controlled config. Blocked system keys (PATH, SYSTEMROOT, etc.)
// are enforced by Layers 2/4 (isBlockedEnvironmentKey) and downstream
// mergeEnvironment → sanitizeCustomEnvironmentEntry. Layer 5
// (addTmuxEnvironment) unconditionally overwrites tmux-internal keys only.
```

---

### P1-4: `buildPaneEnvForSession` 内の `claudeEnvView()` 二重呼び出し

**ファイル**: `internal/tmux/command_router.go` (`buildPaneEnvForSession` 関数)  
**検出レビュー**: Review 1: I-01, Review 3: P1-6

```go
capacity := len(inheritedEnv)
if useClaudeEnv {
    capacity += len(r.claudeEnvView())  // ← 1回目 (RLock/RUnlock)
}
env := make(map[string]string, capacity)
if useClaudeEnv {
    for k, v := range r.claudeEnvView() {  // ← 2回目 (RLock/RUnlock)
        env[k] = v
    }
}
```

copy-on-write 契約により動作上の問題はないが、2回の呼び出し間に `UpdateClaudeEnv` が介入すると capacity hint と実データが不整合になる可能性がある（性能影響は無視可能）。

**修正案**: ローカル変数にキャッシュしてロック取得を1回にする。
```go
var claudeVars map[string]string
if useClaudeEnv {
    claudeVars = r.claudeEnvView()
    capacity += len(claudeVars)
}
// ... Layer 1 ループでは claudeVars を使う
```

---

### P1-5: `CreateSession` の連続 bool 引数（可読性リスク）

**ファイル**: `app_session_api.go`, `app_worktree_api.go`  
**検出レビュー**: 全3レビュー (Review 1: S-01, Review 2: P1-4, Review 3: P1-4)

```go
CreateSession(rootPath, sessionName, enableAgentTeam, useClaudeEnv, usePaneEnv)
```

3つの連続 `bool` 引数は呼び出し側で順序を間違えやすい。Wails 生成型定義でも `arg3:boolean, arg4:boolean, arg5:boolean` となり混同リスクがある。

**修正案**: Options struct パターンの導入を検討。
```go
type CreateSessionOptions struct {
    EnableAgentTeam bool
    UseClaudeEnv    bool
    UsePaneEnv      bool
}
```

---

### P1-6: テストカバレッジのギャップ

**検出レビュー**: Review 2: P1-5, Review 3: P1-5, Review 1: I-05

以下のロジックパスにテストが不足:

| 対象 | 不足テストケース |
|------|----------------|
| `createSessionForDirectory` | `useClaudeEnv=true` + `enableAgentTeam=true` 時の fill-only 優先度テスト |
| `resolveEnvForPaneCreation` | 事前取得 snapshot パス (non-nil sessionSnap) のテスト |
| `buildPaneEnvForSession` | `claudeEnv` が nil の場合の挙動テスト |
| `GetClaudeEnvVarDescriptions` | 返却値の mutation safety テスト |
| `UpdatePaneEnv` | ディープコピー独立性テスト（`UpdateClaudeEnv` と対称のテスト不在） |
| `handleSetEnvironment` | blocked key のフィルタリングテスト |

---

### P1-7: `applySessionEnvFlags` の配置場所が不適切

**ファイル**: `app_worktree_api.go`  
**検出レビュー**: Review 1: I-03

`applySessionEnvFlags` は free function として `app_worktree_api.go` に定義されているが、呼び出し元は3箇所（うち1箇所は `app_session_api.go`）。この関数はセッション作成全般の共通ヘルパーであり、worktree 固有ではない。

**修正案**: `app_session_api.go` に移動して凝集度を高める。

---

### P1-8: `claudeEnvVarDescriptions` が exported `var` で宣言されている

**ファイル**: `app_claude_env_descriptions.go`  
**検出レビュー**: Review 1: I-06

イミュータブルとして使用される静的マップが `var` で宣言されており、パッケージ内の他のコードから意図せず変更される可能性がある。`GetClaudeEnvVarDescriptions()` がシャローコピーを返しているのは正しい対策だが、直接アクセスのリスクは残る。

**修正案**: unexported (`claudeEnvVarDescriptions`) にリネームし、exported getter のみ公開。

---

### P1-9: `SettingsModal.handleSave` の `claude_env` ペイロード — 空 vars + false default の扱い

**ファイル**: `frontend/src/components/SettingsModal.tsx`  
**検出レビュー**: Review 1: I-07

`claudeEnvDefaultEnabled=false` かつ vars 空の場合、`claude_env` 自体が `undefined`（Go 側で `nil`）になるため、以前 YAML に保存された `claude_env` 設定が残り続ける可能性がある。Go 側の `SaveConfig` が全体上書き保存なら問題なし。

**修正案**: Go 側の `SaveConfig` が全体上書き保存であることを確認。マージ保存の場合は、明示的に `claude_env: null` を送信して削除を示す必要あり。

---

### P1-10: `buildPaneEnvForSession` の capacity 計算に pane_env サイズ未加算

**ファイル**: `internal/tmux/command_router.go`  
**検出レビュー**: Review 1: S-02

capacity 計算で `claudeEnvView()` のサイズは加算しているが、`paneEnvView()` のサイズは含まれていない。pane_env エントリ数が多い場合、マップの再ハッシュが発生する。

**修正案**: P1-4 の修正時に pane_env サイズも capacity に追加。

---

## MEDIUM (M) — 7件

### M-1: `PaneEnvDefaultEnabled` と `ClaudeEnvConfig` の YAML 設計非対称

**ファイル**: `internal/config/config.go`  
**検出レビュー**: Review 2: M-1, Review 3: M-1

`PaneEnv` はフラット設計（`PaneEnv map` + `PaneEnvDefaultEnabled bool`）、`ClaudeEnv` は構造体設計（`ClaudeEnvConfig { DefaultEnabled, Vars }`）。機能的に問題はないが、YAML スキーマの一貫性が欠ける。

**現時点対応不要** — 開発フェーズのため、将来の統一で対応可能。

---

### M-2: フロントエンドのインデント不統一（2sp → 4sp 混在）

**ファイル**: `NewSessionModal.tsx`, `modals.css`, `settingsValidation.ts`  
**検出レビュー**: Review 2: M-2, Review 3: M-2

一部ファイルが 2 スペースから 4 スペースにリフォーマットされているが、他のフロントエンドファイルは 2 スペースのまま。

**修正案**: プロジェクト全体で統一するか、変更を元に戻す。

---

### M-3: `ClaudeEnvSettings` の descriptions 取得タイミング・失敗時 UI 通知

**ファイル**: `frontend/src/components/settings/ClaudeEnvSettings.tsx`  
**検出レビュー**: Review 2: M-3, Review 3: M-3

- `useEffect([], ...)` で1回だけ `GetClaudeEnvVarDescriptions()` を取得しており、タブ切替のたびに再マウントされる場合は毎回 API 呼び出しが発生する。descriptions は静的データのため、親コンポーネントでキャッシュすべき。
- 失敗時は `console.error` のみでユーザーへの通知がない（補助情報のため致命的ではない）。

---

### M-4: `NewSessionModal` の configLoadFailed 時のデフォルト値

**ファイル**: `frontend/src/components/NewSessionModal.tsx`  
**検出レビュー**: Review 2: M-4, Review 3: M-4

設定読込失敗時、`useClaudeEnv` / `usePaneEnv` が `false` にフォールバックする。ユーザーが `default_enabled: true` を設定していた場合、期待と異なる挙動になる可能性がある（保守的フォールバックとしては妥当）。

---

### M-5: フロントエンド blocked keys の同期テスト

**ファイル**: `internal/tmux/command_router_env_test.go` / `command_router_terminal_test.go`  
**検出レビュー**: Review 1: S-04, Review 2: M-5, Review 3: M-5

フロントエンドの `BLOCKED_ENV_KEYS` がテスト内に12個ハードコードされている。フロントエンド側の変更時にテストの手動更新が必要でドリフトリスクがある。

**修正案**: 共有定義ファイルの導入、または CI にフロントエンドキー数チェックスクリプト追加。

---

### M-6: レガシーパスと新パスの二重構造

**ファイル**: `internal/tmux/command_router.go`  
**検出レビュー**: Review 3: M-6

`resolveEnvForPaneCreation` が session flags の有無で新パス / レガシーパスに分岐する。`buildPaneEnv`（旧）と `buildPaneEnvForSession`（新）の2系統が並存している。

全セッションに env flags が設定される移行完了後に `buildPaneEnv` を削除できる。

**修正案**: `buildPaneEnv` に TODO コメント追加:
```go
// TODO: Remove legacy buildPaneEnv when all sessions have explicit env flags.
```

---

### M-7: TypeScript `EnvEntry` 型の定義散在

**ファイル**: `frontend/src/components/settings/types.ts`, `settingsValidation.ts`  
**検出レビュー**: Review 3: M-7

`EnvEntry` 型が `types.ts` で定義されているが、バリデーションロジック内にも同様のインターフェース参照がある。型の一元管理を検討。

---

## SUGGESTIONS (S) — 14件

### Config 層

| # | 提案 | ファイル | 検出元 |
|---|------|---------|--------|
| S-1 | `sanitizeEnvMap` の `logPrefix` テスト追加 | `config_test.go` | Review 1, 2 |
| S-2 | `Clone` の claudeEnv/paneEnv クロスコンタミネーション独立性テスト | `config_test.go` | Review 2, 3 |
| S-3 | `TestSanitizeClaudeEnv` の case-insensitive dedup テストに sort 順依存コメント追記 | `config_test.go` | Review 1: S-12 |

### Tmux 層

| # | 提案 | ファイル | 検出元 |
|---|------|---------|--------|
| S-4 | `claudeEnvView`/`paneEnvView` の eventual consistency をコメントで文書化 | `command_router.go` | Review 2, 3 |
| S-5 | Layer 2 blocked key フィルタの直接テスト追加 | `command_router_env_test.go` | Review 2, 3 |
| S-6 | `UpdatePaneEnv` と `UpdateClaudeEnv` の nil ハンドリング非対称性をコメントで明記 | `command_router.go` | Review 1: S-03 |
| S-7 | `handleSetEnvironment` に blocked key チェック追加（防御的） | `command_router.go` | Review 2: S-9, Review 3: S-10 |

### App 層

| # | 提案 | ファイル | 検出元 |
|---|------|---------|--------|
| S-8 | `GetClaudeEnvVarDescriptions` 返却値の mutation safety テスト | `app_config_api_test.go` | Review 2: S-7, Review 3: S-7 |
| S-9 | DESIGN NOTE コメントの整理（リリース前対応） | `app_worktree_api.go` | Review 1: S-11 |

### Frontend

| # | 提案 | ファイル | 検出元 |
|---|------|---------|--------|
| S-10 | `ClaudeEnvSettings` の descriptions キャッシュを親コンポーネントに移動 | `SettingsModal.tsx` | Review 3: S-9 |
| S-11 | `claude_env` と `pane_env` 間のキー重複バリデーション（仕様確認が先） | `settingsValidation.ts` | Review 1: S-07 |
| S-12 | `NewSessionModal` の `reset()` で `shimAvailable` リセット追加 | `NewSessionModal.tsx` | Review 1: S-08 |
| S-13 | `validatePaneEnvSettings` の空文字 effortLevel 許容に意図コメント追加 | `settingsValidation.ts` | Review 1: S-10 |

### テスト

| # | 提案 | ファイル | 検出元 |
|---|------|---------|--------|
| S-14 | `TestSetUseClaudeEnv`/`TestSetUsePaneEnv` のテーブル構造改善（成功ケース追加） | `command_router_env_test.go` | Review 1: S-05 |

---

## 横断整合性チェック結果

全13チェック領域を横断検証し、**全項目パス**（Review 3: Agent 7 による検証）。

| # | チェック領域 | 結果 | 備考 |
|---|------------|------|------|
| 1 | Snapshot/Delta システム | ✅ PASS | `UseClaudeEnv`/`UsePaneEnv` は意図的に `SessionSnapshot` から除外 |
| 2 | フロントエンド呼び出し整合 | ✅ PASS | 全3つの作成 API で useClaudeEnv/usePaneEnv を渡している |
| 3 | Wails バインディング | ✅ PASS | `App.d.ts`, `App.js`, `models.ts` 全て更新済み |
| 4 | JSON シリアライゼーション | ✅ PASS | `omitempty` タグ整合、nil/non-nil の区別が正しい |
| 5 | ロック順序 | ✅ PASS | `claudeEnvUpdateMu → claudeEnvMu` が文書化済み、独立ロックセット内 |
| 6 | Copy-on-write 契約 | ✅ PASS | `UpdateClaudeEnv` / `claudeEnvView` / `ClaudeEnvSnapshot` 全て正しいパターン |
| 7 | Deep clone 独立性 | ✅ PASS | `cloneSessionForRead` に `copyBoolPtr` 追加済み |
| 8 | フィールド数ガードテスト | ✅ PASS | struct 変更時の全テスト更新確認済み |
| 9 | Config 保存フロー | ✅ PASS | `SettingsModal.handleSave` で `claude_env` 正しく含まれている |
| 10 | バージョンガードパターン | ✅ PASS | `paneEnvAppliedVersion` と完全に同じパターン |
| 11 | 後方互換 | ✅ PASS | レガシーセッション（flags=nil）は既存動作を維持 |
| 12 | イベント発行 | ✅ PASS | `config:updated` イベントで ClaudeEnv 変更が伝播 |
| 13 | CLAUDE.md 準拠 | ✅ PASS | パースエラー→ログ+デフォルト継続、shim 失敗→原文転送 |

---

## 評価: 良い点

| # | 内容 |
|---|------|
| 1 | **ロック設計**: Lock ordering が `app.go` コメントで文書化されており正確。`claudeEnvUpdateMu` が独立ロックセットに正しく配置 |
| 2 | **Copy-on-write 契約**: `UpdateClaudeEnv` / `claudeEnvView` の INVARIANT コメントが優秀。契約違反リスクが明示されている |
| 3 | **Deep copy の独立性**: `Clone`, `copyBoolPtr`, `cloneSessionForRead` による安全な状態管理 |
| 4 | **sanitizeEnvMap 共通化**: DRY 原則を遵守したリファクタリング |
| 5 | **フィールド数ガードテスト**: struct 変更時の全テスト更新が適切に実施 |
| 6 | **多層防御**: env vars に対して フロントエンドバリデーション → config sanitize → buildPaneEnv filter → mergeEnvironment 最終防衛の4段階防御 |
| 7 | **フロントエンド**: cancel-on-unmount パターンが `ClaudeEnvSettings` で正しく実装 |
| 8 | **アクセシビリティ**: aria-label, htmlFor/id, WAI-ARIA タブ対応 |
| 9 | **Reducer**: exhaustive チェック (`never` パターン) |
| 10 | **レガシー互換**: `resolveEnvForPaneCreation` が flags=nil のセッションに対して既存動作を完全に維持 |
| 11 | **DESIGN NOTE コメント**: `createSessionForDirectory` 内の initial pane vs additional pane の設計意図が丁寧に文書化 |
| 12 | **テスト網羅性**: `TestBuildPaneEnvForSession` が5層全ての優先度を個別にテスト（Layer 1-5） |
| 13 | **バージョンベースの陳腐化防止パターン**: 既存パターンと対称的に実装 |
| 14 | **Wails バインディング整合**: 全 API 変更を正しく反映 |
| 15 | **BLOCKED_ENV_KEYS**: フロントエンド・バックエンド・tmux 層で3層一貫した保護 |
| 16 | **snapshot delta**: `UseClaudeEnv`/`UsePaneEnv` が意図的に除外された正しい設計判断 |

---

## 修正タスク一覧 & 並列作業可否テーブル

### 凡例
- ✅ 並列OK: 他タスクと独立して作業可能
- ⚠️ 条件付き: 記載の依存タスクと同時作業は避ける
- ❌ 単独作業: 他タスクとの同時作業は避ける

| タスクID | 重要度 | 修正内容 | 対象ファイル | 並列可否 | 依存・注意事項 |
|---------|--------|---------|-------------|---------|--------------|
| T-P0-1 | **CRITICAL** | テスト内 `sanitizeEnvMap` ヘルパー削除 → 本番 `config.SanitizeEnvMap` を直接テスト | `command_router_env_test.go` | ⚠️ T-P0-2 と同一ファイル | **テスト失敗中** — 最優先。`config` パッケージの export 要否を検討 |
| T-P0-2 | **CRITICAL** | テスト内 `applySessionEnvFlags` ヘルパー削除 → 本番関数（void 型）の動作をテスト | `command_router_env_test.go` | ⚠️ T-P0-1 と同一ファイル | `app_worktree_api_test.go` への移動も選択肢 |
| T-P1-1 | IMPORTANT | `splitWindowResolved` で session snapshot を事前取得して渡す | `command_router_handlers_pane.go` | ✅ 並列OK | `handleNewWindow` のパターンに合わせる |
| T-P1-2 | IMPORTANT | `resolveEnvForPaneCreation` でセッション未発見時に `slog.Warn` 追加 | `command_router.go` | ✅ 並列OK | 変更箇所が他と異なるため並列可 |
| T-P1-3 | IMPORTANT | `buildPaneEnvForSession` の Layer 1/3 コメントを正確な表現に修正 | `command_router.go` | ✅ 並列OK | コメントのみ |
| T-P1-4 | IMPORTANT | `claudeEnvView()` 二重呼び出し → ローカル変数キャッシュ + pane_env capacity 加算 | `command_router.go` | ✅ 並列OK | P1-2, P1-3 と同一ファイルだが変更箇所が異なる |
| T-P1-5 | IMPORTANT | `CreateSession` 等の連続 bool 引数を Options struct パターンに変更 | `app_session_api.go`, `app_worktree_api.go`, Frontend | ❌ 単独作業 | API signature 変更のため影響範囲が広い |
| T-P1-6 | IMPORTANT | テストカバレッジ追加（P1-6 の6項目） | `*_test.go` 各種 | ⚠️ P0 完了後 | env_test.go は P0 修正後に作業 |
| T-P1-7 | IMPORTANT | `applySessionEnvFlags` を `app_worktree_api.go` → `app_session_api.go` に移動 | `app_worktree_api.go`, `app_session_api.go` | ✅ 並列OK | 関数移動のみ |
| T-P1-8 | IMPORTANT | `claudeEnvVarDescriptions` を unexported にリネーム | `app_claude_env_descriptions.go` | ✅ 並列OK | 参照元も同パッケージ |
| T-P1-9 | IMPORTANT | `handleSave` の claude_env ペイロード — SaveConfig が全体上書きか確認 | `SettingsModal.tsx` | ✅ 並列OK | Go 側仕様確認が先 |
| T-P1-10 | IMPORTANT | capacity 計算に pane_env サイズ加算 | `command_router.go` | ✅ 並列OK | T-P1-4 と同時対応推奨 |
| T-M-1 | MEDIUM | PaneEnv/ClaudeEnv YAML 設計統一 | `config.go`, `config.yaml` | — | **現時点対応不要** |
| T-M-2 | MEDIUM | フロントエンドインデント統一 | `NewSessionModal.tsx`, `settingsValidation.ts`, `modals.css` | ✅ 並列OK | フロントエンドのみ |
| T-M-3 | MEDIUM | `ClaudeEnvSettings` descriptions キャッシュ改善 + 失敗時 UI 通知 | `ClaudeEnvSettings.tsx`, `SettingsModal.tsx` | ✅ 並列OK | フロントエンド |
| T-M-4 | MEDIUM | `NewSessionModal` configLoadFailed 時デフォルト値のコメント補足 | `NewSessionModal.tsx` | ✅ 並列OK | フロントエンド |
| T-M-5 | MEDIUM | blocked keys 同期テスト自動化検討 | `command_router_env_test.go` | ⚠️ P0 完了後 | P0 修正完了後に実施 |
| T-M-6 | MEDIUM | レガシー `buildPaneEnv` に TODO コメント追加 | `command_router.go` | ✅ 並列OK | コメントのみ |
| T-M-7 | MEDIUM | TypeScript `EnvEntry` 型の一元管理 | `types.ts`, `settingsValidation.ts` | ✅ 並列OK | フロントエンドのみ |

---

### 並列作業グループ

| グループ | タスク | 対象ファイル | 備考 |
|---------|--------|------------|------|
| **A: CRITICAL（最優先）** | T-P0-1, T-P0-2 | `command_router_env_test.go` | 同一ファイル — 順番に実施。**テスト失敗中** |
| **B: command_router.go** | T-P1-2, T-P1-3, T-P1-4, T-P1-10, T-M-6 | `command_router.go` | 変更箇所は異なるが同一ファイル。1人でまとめて実施推奨 |
| **C: App 層リファクタ** | T-P1-7, T-P1-8 | `app_worktree_api.go`, `app_session_api.go`, `app_claude_env_descriptions.go` | 異なるファイル。並列可能 |
| **D: handlers_pane** | T-P1-1 | `command_router_handlers_pane.go` | 単独ファイル。他と完全独立 |
| **E: Frontend** | T-M-2, T-M-3, T-M-4, T-M-7, T-P1-9 | Frontend 各種 | バックエンドと完全独立。いつでも着手可能 |
| **F: テスト追加** | T-P1-6, T-M-5 | `*_test.go` 各種 | **グループ A 完了後** に実施 |
| **G: API 変更（単独）** | T-P1-5 | 複数ファイル | ❌ 影響範囲が広い。他タスク完了後に単独実施 |

---

### 推奨作業順序

```
【Phase 1 — CRITICAL（最優先・テスト失敗修正）】
  T-P0-1 → T-P0-2 (同一ファイル、順番に)
  ※ TestSanitizeEnvMap が失敗中のためコミット前に必須

【Phase 2 — IMPORTANT（並列可能グループ）】
  ├─ 作業者A: グループB  T-P1-2 + T-P1-3 + T-P1-4 + T-P1-10 + T-M-6  (command_router.go)
  ├─ 作業者B: グループC  T-P1-7 + T-P1-8  (App層リファクタ)
  ├─ 作業者C: グループD  T-P1-1  (handlers_pane.go snapshot)
  └─ 作業者D: グループE  T-M-2 + T-M-3 + T-M-4 + T-M-7 + T-P1-9  (Frontend)

【Phase 3 — テスト追加（Phase 1 完了後）】
  └─ グループF: T-P1-6 + T-M-5  (テストカバレッジ拡充)

【Phase 4 — API 変更（単独作業・広範囲）】
  └─ グループG: T-P1-5  (CreateSession Options struct — 影響範囲確認後に実施)

【保留】
  └─ T-M-1: PaneEnv/ClaudeEnv YAML 設計統一 — 現時点対応不要
```

---

### 作業者向け補足

- **Phase 1 が緊急**: `TestSanitizeEnvMap` が実際に FAIL しているため、コミット前に修正必須
- **フロントエンド作業は完全独立**: グループ E はバックエンド作業と競合せず、いつでも着手可能
- **グループ B は1人でまとめて**: `command_router.go` への5つの変更は変更箇所が異なるが、マージ競合を避けるため1人で実施推奨
- **T-P1-5 は影響範囲確認後に実施**: 呼び出し箇所の洗い出しが必要。開発フェーズのため後方互換は不要だが、変更箇所が多いため単独作業推奨
- **T-M-1 は現時点では対応不要**: 機能的に問題なく、将来の設計統一で対応可能
