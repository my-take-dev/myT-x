# 統合レビュー — 2026-02-19 21:56

## レビュー対象

myT-x 配下のコミット前差分（25ファイル, +2143/-1325行）

**統合元:**
- review-20260219214136.md（3エージェント並列レビュー）
- review-20260219214958.md（PRレビューサマリ）

### 変更カテゴリ

| カテゴリ | ファイル数 | 主な変更内容 |
|---------|-----------|------------|
| Backend App層 (Go) | 7 | `CreateSessionOptions` struct導入、`applySessionEnvFlags` 移動、unexport化 |
| Backend Internal層 (Go) | 7 | env merge層ドキュメント改善、session snapshot事前取得、テスト追加・移動 |
| Frontend (React/TS/CSS) | 11 | API呼び出しオブジェクト化、2-spaceインデント統一、Wailsバインディング更新 |

---

## Critical Issues (1件)

### C-1. `fetchedRef` パターンが React.StrictMode で壊れる

**ファイル:** `frontend/src/components/settings/ClaudeEnvSettings.tsx:22-48`

**問題:** `fetchedRef` + `cancelled` パターンが React.StrictMode（`main.tsx:11` で有効）の二重effect呼び出しで正しく動作しない。

1. 初回: `fetchedRef.current = false` → fetch開始 → `fetchedRef.current = true`
2. クリーンアップ: `cancelled = true` → APIレスポンス無視
3. 再実行: `fetchedRef.current === true` → early return（fetchしない）
4. **結果:** `cachedDescriptions` が設定されず、開発モードで説明が表示されない

**推奨修正:** `fetchedRef` を削除し、`cachedDescriptions` + `cancelled` のみに依存:

```tsx
useEffect(() => {
  if (cachedDescriptions !== null) {
    setDescriptions(cachedDescriptions);
    return;
  }

  let cancelled = false;
  api.GetClaudeEnvVarDescriptions()
    .then((result) => {
      if (!cancelled) {
        cachedDescriptions = result;
        setDescriptions(result);
      }
    })
    .catch((err) => {
      if (!cancelled) {
        console.warn("[ClaudeEnvSettings] failed to load descriptions", err);
        setDescriptionLoadFailed(true);
      }
    });
  return () => {
    cancelled = true;
  };
}, []);
```

---

## Important Issues (5件)

### I-1. `CreateSessionOptions` のフィールド数ガードテストが欠落

**ファイル:** `app_session_api_test.go`（新規追加が必要）

**問題:** プロジェクト内では `configUpdatedEvent`, `ValidationRules`, `WorktreeSessionOptions`, `Config`, `ClaudeEnvConfig`, `RouterOptions`, `TmuxRequest` など重要structに `reflect.TypeOf(...).NumField()` ガードテストが一貫して存在する。`CreateSessionOptions` はフロントエンド契約に直結する公開structであり、フィールド追加時に以下の更新漏れリスクがある:

- `WorktreeSessionOptions` → `CreateSessionOptions` マッピング（`app_worktree_api.go:153-157`）
- フロントエンドの `models.ts` の `CreateSessionOptions` クラス
- 全テストの `CreateSessionOptions{}` ゼロ値呼び出し

**推奨修正:**

```go
func TestCreateSessionOptionsFieldCountGuard(t *testing.T) {
    const expectedFieldCount = 3
    if got := reflect.TypeOf(CreateSessionOptions{}).NumField(); got != expectedFieldCount {
        t.Fatalf("CreateSessionOptions field count = %d, want %d; update WorktreeSessionOptions mapping, tests, and frontend models.ts", got, expectedFieldCount)
    }
}
```

---

### I-2. `splitWindowResolved` の `GetSession` エラー情報がサイレントに破棄

**ファイル:** `internal/tmux/command_router_handlers_pane.go:87-89`

**問題:**
```go
sessionSnap, _ := r.sessions.GetSession(targetCtx.SessionName)
```

`ok` を破棄しているため、`GetSession` が `(nil, false)` を返した場合にサイレント。`resolveEnvForPaneCreation` 内で再度 `GetSession` が呼ばれるフォールバックは正しく動作するが、プロジェクトガイドライン「Error handling: explicit, no silent ignoring」に反する。`handleNewWindow` では同パターンで `if !ok { return errResp(...) }` と明示チェックしており（`command_router_handlers_window.go:34` 参照）、一貫性に欠ける。

**推奨修正（ログ追加）:**
```go
sessionSnap, ok := r.sessions.GetSession(targetCtx.SessionName)
if !ok {
    slog.Debug("[DEBUG-SPLIT] session not found for snapshot, using fallback",
        "session", targetCtx.SessionName)
}
```

---

### I-3. `WorktreeSessionOptions` と `CreateSessionOptions` のフィールド重複

**ファイル:** `app_worktree_api.go:48-56`, `app_session_api.go:18-22`

**問題:** `EnableAgentTeam`, `UseClaudeEnv`, `UsePaneEnv` の3フィールドが両structで完全に重複。フィールド追加時に両struct + マッピングコード（`app_worktree_api.go:153-157`）の3箇所を同期する必要があり、変更漏れリスクが存在。

**推奨修正:** `WorktreeSessionOptions` に `CreateSessionOptions` を埋め込む:

```go
type WorktreeSessionOptions struct {
    BranchName           string `json:"branch_name"`
    BaseBranch           string `json:"base_branch"`
    PullBeforeCreate     bool   `json:"pull_before_create"`
    CreateSessionOptions        // embedded
}
```

**注意:** Wails v2のTypeScriptバインディング生成器が埋め込みstructを正しくフラット化するか実機確認が必要。問題があれば現状維持 + I-1のフィールド数ガードテストで対処可。

---

### I-4. `applySessionEnvFlags` の共有テスト不足

**ファイル:** `app_session_api.go`, `app_worktree_api.go`

**問題:** `applySessionEnvFlags` は `CreateSession` と `CreateSessionWithNewWorktree` の両方から呼ばれるが、両パスで同一入力に対して同一結果を返すことを検証するテストが存在しない。シグネチャ変更時に片方の呼び出しサイトの更新漏れリスクがある。

**推奨修正:** 共有テストヘルパーまたは統合テストで、両パスを `{UseClaudeEnv: true, UsePaneEnv: true}` で実行し、セッションマネージャの状態が同一であることを検証する。

---

### I-5. `executeRouterRequestFn` のパッケージレベル置換による並列テスト干渉リスク

**ファイル:** `app_session_api.go`（定義箇所）, `app_session_api_test.go`（使用箇所）

**問題:** テスト用にパッケージレベル関数変数を置換するパターンは、2つのテストが並行実行で同時に置換すると干渉する。

**推奨修正:** `t.Cleanup` で元関数を復元し、`t.Parallel()` を使用しないか、App structのインターフェースフィールドに変更する。

---

## Suggestions (10件)

### S-1. `TestPaneEnvSnapshotIndependence` に empty map ケースが欠落

**ファイル:** `internal/tmux/command_router_pane_env_test.go:83-150`

対称テスト `TestClaudeEnvSnapshot` は4ケース（nil, empty, single, multiple）だが、`TestPaneEnvSnapshotIndependence` は3ケース（nil, single, multiple）で **empty map** (`map[string]string{}`) が欠落。

---

### S-2. `applySessionEnvFlags` のログプレフィックス不一致

**ファイル:** `app_session_api.go:376-379`

`slog.Warn` に `[DEBUG-ENV]` プレフィックスを使用。プロジェクト慣例は Warn レベルには `[WARN-*]` プレフィックス。開発フェーズ完了後に `[WARN-ENV]` への変更を検討。

---

### S-3. テストモック重複パターンの抽出

**ファイル:** `app_session_api_test.go` 全体

`executeRouterRequestFn` のモック設定が複数テストで同一パターンで繰り返されている。テストヘルパーに抽出すると保守性が向上。

---

### S-4. フロントエンドのフォーマット変更は別コミットが望ましい

4-space → 2-space のインデント変更は機能変更と混在すると差分レビューのノイズになる。別コミットで `git blame` 汚染も防げる。

---

### S-5. `claudeEnvVarDescriptions` の非空初期化テスト

**ファイル:** `app_claude_env_descriptions_test.go`（新規）

unexport化は良い判断。初期化時にマップが非空であることを検証するテストを追加すると、誤ったクリアを検出できる。

---

### S-6. `PaneEnvSettings.tsx` JSXテキストインデント不一致

**ファイル:** `frontend/src/components/settings/PaneEnvSettings.tsx:14-17`

2sp再フォーマット後、`<span>` 要素内のテキストインデントが親要素と不一致。

---

### S-7. `expectedCount = 12` にブロックキー一覧コメント追加

**ファイル:** `internal/config/config_test.go`

`TestSanitizeEnvMap` のマジックナンバー12に、ブロック対象のキー一覧コメントを追加すると可読性向上。

---

### S-8. `buildPaneEnvForSession` のスナップショット一貫性コメント

**ファイル:** `internal/tmux/command_router.go`

事前取得スナップショット最適化のロック動作（単一RLockによるアトミック性保証）について簡潔なコメントを追加すると、将来のレビュアーに有益。

---

### S-9. `UsePaneEnv` テストカバレッジの対称性

**ファイル:** `app_session_api_test.go`

`{false, true}` ケース（pane envのみ）のアサーション深度が `{true, false}` より浅い。対称的なカバレッジを確保すべき。

---

### S-10. モジュールレベルキャッシュのテストリセット

**ファイル:** `frontend/src/components/settings/ClaudeEnvSettings.tsx`

`cachedDescriptions` がテスト間で状態をリークする可能性。テスト環境用に `__resetCache()` の公開を検討。

---

## Positive Observations (8件)

1. **`CreateSessionOptions` struct導入は優れた設計判断** — 連続するboolパラメータ3つを構造体に置き換え、引数順序の取り違えリスクを構造的に排除。jsonタグもフロントエンド契約と完全一致。
2. **`applySessionEnvFlags` の移動先が適切** — `app_worktree_api.go` → `app_session_api.go` への移動は、CreateSession と CreateSessionWithExistingWorktree の両方から呼ばれるため論理的に正しい配置。
3. **テストカバレッジが包括的** — fill-only優先順位5ケース、フルパイプラインE2Eテスト16ケース、nil安全性検証4ケース、スナップショットパス検証5ケース、deep copy独立性テスト、フィールドカウントガード、防御的コピー検証。
4. **`sanitizeEnvMap` テストの適切な移動** — tmuxパッケージのテストヘルパー（本番コード複製）から、configパッケージの本番関数を直接テストする形に改善。
5. **env merge多層防御が堅牢** — Layer 1/3 → Layer 2/4 → `mergeEnvironment` → `sanitizeCustomEnvironmentEntry` の3段構え。
6. **スナップショット最適化** — `buildPaneEnvForSession` で単一RLock下でenvスナップショットを事前取得し、ロック競合を削減。
7. **エラーハンドリングが一貫** — `applySessionEnvFlags` の非致命的エラー処理はコメントで理由が丁寧に記載。
8. **コメント言語規約を遵守** — 新規追加コメントは全て英語。既存の日本語コメントは変更なし。

---

## クロスモジュール影響分析

| # | 項目 | 影響 | 状態 |
|---|------|------|------|
| 1 | `claudeEnvVarDescriptions` unexport | なし | diff内で対応済 |
| 2 | `CreateSessionOptions` 追加 | なし | diff内で対応済 |
| 3 | `App.CreateSession` シグネチャ | なし | 全呼び出し更新済 |
| 4 | `CreateSessionWithExistingWorktree` シグネチャ | なし | 全呼び出し更新済 |
| 5 | `createSessionForDirectory` の `UsePaneEnv` 未使用 | なし | 意図的設計（初期ペインにpane_env適用しない仕様） |
| 6 | `applySessionEnvFlags` 移動 | なし | 同一パッケージ内 |
| 7 | Wails bindings | なし | diff内で更新済 |
| 8 | `splitWindowResolved` スナップショット | なし | パフォーマンス改善のみ |

---

## タスク整理表（統合・並列作業ガイド付き）

| # | ID | 指摘 | タスク | 修正対象ファイル | 優先度 |
|---|-----|------|--------|-----------------|--------|
| 1 | T1 | C-1 | `fetchedRef` StrictMode修正 | `ClaudeEnvSettings.tsx` | **Critical** |
| 2 | T2 | I-1 | `CreateSessionOptions` フィールド数ガードテスト追加 | `app_session_api_test.go` | Important |
| 3 | T3 | I-2 | `splitWindowResolved` の `GetSession` ログ追加 | `internal/tmux/command_router_handlers_pane.go` | Important |
| 4 | T4 | I-3 | `WorktreeSessionOptions` に `CreateSessionOptions` 埋め込み | `app_worktree_api.go`, `models.ts` | Important |
| 5 | T5 | I-4 | 共有envフラグ動作テスト追加 | `app_session_api_test.go` | Important |
| 6 | T6 | I-5 | `executeRouterRequestFn` 並列テスト安全性 | `app_session_api_test.go` | Important |
| 7 | T7 | S-1 | empty mapテストケース追加 | `internal/tmux/command_router_pane_env_test.go` | Low |
| 8 | T8 | S-2 | ログプレフィックス `[WARN-ENV]` 修正 | `app_session_api.go` | Low |
| 9 | T9 | S-3 | テストモック重複パターン抽出 | `app_session_api_test.go` | Low |
| 10 | T10 | S-5 | `claudeEnvVarDescriptions` 非空テスト追加 | `app_claude_env_descriptions_test.go` (新規) | Low |
| 11 | T11 | S-6 | `PaneEnvSettings.tsx` インデント修正 | `PaneEnvSettings.tsx` | Low |
| 12 | T12 | S-7 | `expectedCount = 12` コメント追加 | `internal/config/config_test.go` | Low |
| 13 | T13 | S-8 | スナップショット一貫性コメント追加 | `internal/tmux/command_router.go` | Low |

**除外タスク:**
- S-4（フォーマット別コミット分離）→ git操作が必要、現時点では不対応
- S-9, S-10 → 影響度が低く、機能的問題なし

---

## 並列作業計画

### Phase 1: Critical + 独立Important（同時着手可能）

```
┌──────────────────────────────────────────────────────────────────┐
│ Worker A (Frontend)                                              │
│   T1  [C-1] fetchedRef StrictMode修正 (ClaudeEnvSettings.tsx)    │
│   T11 [S-6] PaneEnvSettings.tsx インデント修正                     │
├──────────────────────────────────────────────────────────────────┤
│ Worker B (Backend Internal)                                      │
│   T3  [I-2] GetSession ログ追加 (command_router_handlers_pane.go)│
│   T7  [S-1] empty mapテストケース (command_router_pane_env_test) │
│   T12 [S-7] expectedCount コメント (config_test.go)              │
│   T13 [S-8] スナップショットコメント (command_router.go)           │
├──────────────────────────────────────────────────────────────────┤
│ Worker C (Backend App - 独立タスク)                               │
│   T8  [S-2] ログプレフィックス修正 (app_session_api.go)           │
│   T10 [S-5] claudeEnvVarDescriptions テスト (新規ファイル)        │
└──────────────────────────────────────────────────────────────────┘
```

### Phase 2: struct変更（Phase 1完了後）

```
┌──────────────────────────────────────────────────────────────────┐
│ Worker D (Refactor - 単独推奨)                                    │
│   T4  [I-3] WorktreeSessionOptions 埋め込み                       │
│         → Wailsバインディング生成器の挙動を先に検証                  │
│         → 問題あれば現状維持 + T2のガードテストで対処                 │
└──────────────────────────────────────────────────────────────────┘
```

### Phase 3: テスト系（Phase 2完了後 = フィールド数確定後）

```
┌──────────────────────────────────────────────────────────────────┐
│ Worker E (Test - 順次実行推奨)                                    │
│   T2  [I-1] フィールド数ガードテスト (T4の結果でフィールド数決定)    │
│   T5  [I-4] 共有envフラグ動作テスト                                │
│   T6  [I-5] executeRouterRequestFn 並列安全性                     │
│   T9  [S-3] テストモック抽出 (テスト全体に影響)                     │
└──────────────────────────────────────────────────────────────────┘
```

### 競合・依存関係マトリクス

| 競合グループ | タスク | 理由 | 解決策 |
|------------|--------|------|--------|
| Group-A | T4 → T2 | T4で埋め込み採用時にフィールド数が変わる | T4完了後にT2のexpected countを決定 |
| Group-B | T5 → T6 → T9 | 全て `app_session_api_test.go` を変更 | 順次実行 |
| Group-C | T4 → Wails検証 | 埋め込みstructのバインディング生成確認が先 | 検証失敗時は現状維持 + T2で対処 |

---

## レビュー結論

| 優先度 | 件数 | 要約 |
|--------|------|------|
| Critical | 1 | C-1: `fetchedRef` — 開発モードでClaudeEnv説明が非表示 |
| Important | 5 | I-1〜I-5: フィールドガード、サイレントエラー、struct重複、テスト安全性 |
| Suggestion | 10 | テスト改善、コメント追加、スタイル修正 |

**最優先:** C-1 の `fetchedRef` 修正（開発モードでの機能欠損バグ）。修正は `fetchedRef` 削除のみで簡潔。

**構造改善:** I-1 + I-3 の組み合わせ。`CreateSessionOptions` にフィールド追加時のマッピング漏れ防止が重要。埋め込みまたはガードテストで対処。
