# コミット前レビュー結果（統合版）

- **日時**: 2026-02-20 17:26
- **対象**: `myT-x/` 配下の変更ファイル
- **変更規模**: 71ファイル, +877行, -1430行
- **レビュー方式**: 6エージェント並列レビュー（3回分の結果を統合・重複排除）
- **統合元**: review-20260220170811.md, review-20260220172004.md, review-20260220172030.md

---

## 変更概要

| カテゴリ | ファイル数 | 主な変更内容 |
|----------|-----------|-------------|
| 新規: `internal/wsserver/` | 2 | WebSocket Hub（バイナリペインデータストリーミング）hub.go, protocol.go |
| 新規: `internal/workerutil/` | 1 | パニック回復 + exponential backoff 共通化 recovery.go |
| 新規: `paneDataStream.ts` | 1 | フロントエンドWebSocketクライアント（シングルトン） |
| App Core | 8 | WebSocket Hub導入, workerutil抽出, panic recovery移行 |
| App Tests | 11 | Go 1.26モダン化, WS↔IPCフォールバックテスト追加 |
| Internal Infra | ~20 | config/git/ipc/panestate/shell/terminal の Go 1.26移行 |
| tmux | ~10 | maps.Copy, min/max, CutPrefix 等のモダン化 |
| tmux-shim | 5 | maps.Copy, range int, SplitSeq 等のモダン化 |
| Frontend | 4 | paneDataStream.ts新規, Dual-listener (WS+IPC) 実装 |

---

## レビュー結果

### Critical Issues: なし

---

### Important Issues

#### I-01: `IsShutdown` コールバックが実質的にデッドコード
- **ファイル**: `app_lifecycle.go` — `defaultRecoveryOptions()`
- **カテゴリ**: App層 / 設計
- **詳細**: `IsShutdown` は `a.runtimeContext() == nil` を返すが、`shutdown()` は `setRuntimeContext(nil)` を呼ばない。従って shutdown 中でも `runtimeContext()` は nil にならず、常に false を返す。Context の cancel で停止するため動作上の問題はないが、コードが誤解を招く。
- **修正案**: コールバック内を `a.shuttingDown.Load()` に変更するか、`IsShutdown` を使用しない場合は nil にする。

#### I-02: `defaultRecoveryOptions()` のテストが存在しない
- **ファイル**: `app_lifecycle.go` L339-L360
- **カテゴリ**: テスト
- **詳細**: すべてのワーカーのリカバリ設定を決める重要な関数だが、テストが存在しない。コールバック関数の動作（`OnPanic`, `OnFatal`, `IsShutdown`）が正しいことを検証するテストが必要。
- **修正案**: テーブル駆動テストの追加

#### I-03: `waitWithTimeout` の Timer ドレインが Go 1.26 では不要
- **ファイル**: `app_lifecycle.go` L374-390
- **カテゴリ**: Go 1.26移行
- **詳細**: `Timer.Stop()` 後に手動チャネルドレイン（`select { case <-timer.C: default: }`）を行っているが、Go 1.23 以降は `Timer.Stop()` がチャネルの残留値を保証しない。同プロジェクトの `recovery.go` L179 では正しくドレインを省略している。
- **修正案**: `defer timer.Stop()` に簡素化

#### I-04: ロック順序コメントが実装と矛盾
- **ファイル**: `internal/wsserver/hub.go` L68-69
- **カテゴリ**: wsserver / ドキュメント
- **詳細**: Hub構造体のコメントに `Lock ordering: mu -> writeMu` と記載されているが、実際の実装では `writeMu -> mu` の順で取得。`writeMu` フィールドのコメント（L81: `never hold mu when acquiring writeMu`）は正しいが、構造体レベルのコメントと矛盾。
- **修正案**: `mu -> writeMu` を `writeMu -> mu` に修正

#### I-05: `BroadcastPaneData` の TOCTOU ウィンドウ
- **ファイル**: `internal/wsserver/hub.go` — `BroadcastPaneData()`
- **カテゴリ**: wsserver / 設計
- **詳細**: RLock 解放 → writeMu.Lock 取得の間に接続が置換される可能性がある。古い接続への書き込みは WebSocket の Close 済みエラーで処理されるため致命的ではないが、置換直後のフレーム欠損は原理的に発生する。
- **修正案**: writeMu 取得後に `h.conn` を再チェックするか、設計判断としてコメントを維持し許容。

#### I-06: `pingLoop` のパニックリカバリが接続クリーンアップしない
- **ファイル**: `internal/wsserver/hub.go` (pingLoop内)
- **カテゴリ**: wsserver / エラーハンドリング
- **詳細**: `defer func() { recover() }` でパニックを捕捉するが、その後接続がクリーンアップされず、ゴルーチンが静かに終了する。接続は開いたまま・ping不在の状態になる。
- **修正案**: パニック時に `clearIfCurrent` を呼んで接続をクリアする

#### I-07: 空 paneID フレーム処理の Go/TS 間不一致
- **ファイル**: `internal/wsserver/hub.go`, `frontend/src/hooks/useTerminalEvents.ts`
- **カテゴリ**: プロトコル / 設計
- **詳細**: Go側 `EncodePaneData` は空 paneID を受け入れ `[0x00][data]` フレームを生成するが、TS側は `paneIdLen === 0` のケースを特別扱いしていない。空 paneID フレームが送信された場合、TS側でルーティング不能。
- **修正案**: `EncodePaneData` に空 paneID ガードを追加、またはTS側に防御ロジックを追加

#### I-08: `sendError` vs `BroadcastPaneData` の接続クリーンアップポリシー不一致
- **ファイル**: `internal/wsserver/hub.go`
- **カテゴリ**: wsserver / 設計
- **詳細**: `sendError` と `BroadcastPaneData` の両方がエラー時に `clearIfCurrent` を呼んでおり一貫しているが、エラー応答送信失敗とデータストリーミング書き込み失敗で同じクリーンアップ動作をすることの妥当性確認。
- **修正案**: コメントでポリシーを明文化

#### I-09: `GetWebSocketURL` 失敗が本番環境で不可視
- **ファイル**: `app.go` — `GetWebSocketURL`
- **カテゴリ**: App層 / ログ
- **詳細**: `wsHub` が nil の場合に空文字を返すが、本番環境ではログ出力なし。WebSocket接続が確立できない原因調査が困難。
- **修正案**: `slog.Warn` でフォールバック理由をログに残す

#### I-10: `SendInput`/`SendSyncInput` 失敗が本番環境で不可視
- **ファイル**: `app_pane_api.go`
- **カテゴリ**: App層 / ログ
- **詳細**: 入力送信の失敗が本番環境で確認できない。
- **修正案**: デバッグログレベルで失敗をログに残す

#### I-11: `Start()` メソッドのスレッドセーフティ
- **ファイル**: `internal/wsserver/hub.go` — `Start()`
- **カテゴリ**: wsserver / 設計
- **詳細**: `h.server != nil` のチェックがミューテックスなしで行われている。起動シーケンスで1回のみ呼ばれる設計のため実害なし。
- **修正案**: `sync.Once` で保護するか、コメントで単一呼び出しの前提を明記

#### I-12: `subscribed` マップの購読数上限なし
- **ファイル**: `internal/wsserver/hub.go`
- **カテゴリ**: wsserver / リソース管理
- **詳細**: クライアントが大量の paneID を subscribe してもメモリ制限がない。デスクトップアプリのためリスクは低いが、バグで蓄積する可能性あり。
- **修正案**: 現状許容。将来的に上限を設ける場合はログ警告を追加。

#### I-13: `RecoveryOptions.MaxRetries = 0` の曖昧性
- **ファイル**: `internal/workerutil/recovery.go`
- **カテゴリ**: workerutil / 型設計
- **詳細**: `MaxRetries` のゼロ値が「デフォルト適用」を意味するが、「リトライなし」を意図して `0` を設定したいケースと区別できない。
- **修正案**: `-1` を「無限リトライ」とし、`0` を「リトライなし」に再定義するか、ドキュメントで明示

#### I-14: `RunWithPanicRecovery` のDocコメントが古い `wg.Add` APIを参照
- **ファイル**: `internal/workerutil/recovery.go` L100-112
- **カテゴリ**: workerutil / ドキュメント
- **詳細**: Docコメントに `wg.Add(1) is called synchronously` / `wg.Add must happen in the calling goroutine` と記載されているが、実装は Go 1.24+ の `wg.Go()` を使用しており、`wg.Add`/`wg.Done` は自動管理。
- **修正案**: コメントを `wg.Go` の仕組みに合わせて更新

#### I-15: `subscribeMsg.Action` が string 型で無効な状態を許容
- **ファイル**: `internal/wsserver/hub.go` (subscribeMsg構造体)
- **カテゴリ**: wsserver / 型設計
- **詳細**: `Action` フィールドが素の `string` 型で、`"subscribe"` / `"unsubscribe"` 以外の任意文字列も受け付ける。
- **修正案**: 定数定義の追加（機能影響は軽微）

#### I-16: `Hub.Start()` リスナー失敗パスのテスト不足
- **ファイル**: `internal/wsserver/hub_test.go`
- **カテゴリ**: テスト
- **詳細**: 使用中のポートで `Start()` を呼んだ場合のエラーパスがテストされていない。
- **修正案**: ポート競合テストケース追加

#### I-17: `pingLoop` テスト不足
- **ファイル**: `internal/wsserver/hub_test.go`
- **カテゴリ**: テスト
- **詳細**: ping送信成功とエラー系（接続断）のテストが不足。
- **修正案**: pingLoop統合テストの追加

#### I-18: paneDataStream.ts + useTerminalEvents.ts: WebSocket再接続時のTextDecoder残存バッファ
- **ファイル**: `frontend/src/hooks/useTerminalEvents.ts` (paneTextDecoder)
- **カテゴリ**: フロントエンド / バグ（低確率）
- **詳細**: `paneTextDecoder` は `stream: true` で使用されており、WebSocketが切断→再接続された場合、同じインスタンスが再利用される。旧ストリームの末尾で不完全だったバイト列が新ストリームの先頭データと結合され、文字化け（U+FFFD）が1文字発生する可能性。
- **修正案**: `paneDataStream.ts` の `onopen` 内にリセットコールバック(`onReconnect`)を追加し、`paneTextDecoder.decode()` フラッシュを実行

#### I-19: WS接続済み・未subscribe期間のデータロスト
- **ファイル**: `app_events.go`, `paneDataStream.ts`
- **カテゴリ**: フロントエンド / 設計
- **詳細**: `HasActiveConnection()` が `true` だが `subscribe` メッセージがサーバー未到達の場合、`BroadcastPaneData` は `subscribed` チェックで `return` し、IPCフォールバックも通らない。`GetPaneReplay` で軽減されるが、高速出力中のリロードでは数フレーム欠落する可能性。
- **修正案**: バックエンドでsubscription未登録時にIPCフォールバックするか、フロントエンドで `onopen` 後に `GetPaneReplay` を再取得

#### I-20: `wsActive` フラグのリセットタイミング
- **ファイル**: `frontend/src/hooks/useTerminalEvents.ts`
- **カテゴリ**: フロントエンド / ロバストネス
- **詳細**: `wsActive` のリセットはIPCイベント受信時にのみ行われる。出力がないpaneでは `wsActive` が `true` のまま残り続ける。実害は薄いが、WebSocket接続状態変化を検知するメカニズムがあるとより堅牢。

#### I-21: `console.warn` の DEV ガード不統一
- **ファイル**: `frontend/src/services/paneDataStream.ts`
- **カテゴリ**: フロントエンド / 品質
- **詳細**: `useBackendSync.ts` では全ての `console.warn/error` を `import.meta.env.DEV` で囲んでいるが、`paneDataStream.ts` ではガード無しで出力。本番ビルドでもコンソール出力が残る。
- **修正案**: `paneDataStream.ts` 内の `console.warn`/`console.error` を `if (import.meta.env.DEV)` で囲む

#### I-22: HMR 時のモジュール状態リーク
- **ファイル**: `frontend/src/services/paneDataStream.ts`
- **カテゴリ**: フロントエンド / 開発体験
- **詳細**: モジュールスコープに WebSocket 接続を保持しているが、HMR リロード時に `import.meta.hot.dispose()` でクリーンアップがない。開発中のホットリロードで古いWS接続が残る。
- **修正案**: `if (import.meta.hot) { import.meta.hot.dispose(() => disconnect()); }` を追加

#### I-23: `TestEnsureOutputFlusherWebSocketPath` で `time.Sleep` ベースの待機
- **ファイル**: `app_events_test.go`
- **カテゴリ**: テスト安定性
- **詳細**: 購読メッセージ送信後に `time.Sleep(50ms)` で待機。同ファイル内の他テストではポーリングベース `waitForCondition` を使用。CI環境で不安定になりうる。
- **修正案**: ポーリングベースの待機に変更

#### I-24: `TestEnsureOutputFlusherWebSocketPath` の IPC 非発行検証のレース条件
- **ファイル**: `app_events_test.go`
- **カテゴリ**: テスト安定性
- **詳細**: WebSocket読み取り直後にIPCイベントの不在を検証しているが、flush ロジックの非同期タイミングにより遅延発行の可能性がゼロではない。
- **修正案**: WS読み取り成功後に短い待機を挿入してからIPC不在を検証

#### I-25: `testExponentialBackoffDoubling` のタイミング tolerance
- **ファイル**: `internal/workerutil/recovery_test.go`
- **カテゴリ**: テスト安定性
- **詳細**: Windows タイマー精度を考慮してtolerance 80msだが、`initialBackoff=50ms` と短い。CI高負荷時に失敗リスク。
- **修正案**: `initialBackoff` を100msに引き上げるか、割合ベース（±50%）の tolerance に変更

#### I-26: `slog.SetDefault` のテスト間干渉リスク
- **ファイル**: `app_events_test.go`
- **カテゴリ**: テスト（軽度）
- **詳細**: 複数テストで `slog.SetDefault` を変更し `t.Cleanup` で復元。`t.Parallel()` 使用禁止コメントあり。現状は許容。

#### I-27: `app_snapshot_delta_test.go`: `reflect.TypeOf` 未移行
- **ファイル**: `app_snapshot_delta_test.go`:176付近
- **カテゴリ**: Go 1.26移行の不統一
- **詳細**: `TestSnapshotFieldCounts` で `reflect.TypeOf(tt.typ).NumField()` を使用。同プロジェクト内の他14箇所は全て `reflect.TypeFor[T]()` に移行済み。
- **修正案**: `reflect.TypeFor[]` に統一

#### I-28: `app_snapshot_metrics_test.go`: `reflect.TypeOf` 未移行
- **ファイル**: `app_snapshot_metrics_test.go`:100付近
- **カテゴリ**: Go 1.26移行の不統一
- **詳細**: I-27と同一パターン。
- **修正案**: `reflect.TypeFor[]` に統一

---

### Suggestions

#### S-01: `BroadcastPaneData` で空データのショートカット
- **ファイル**: `internal/wsserver/hub.go`
- **詳細**: 呼び出し元で `len(flushed) == 0` ガードがあるが、`BroadcastPaneData` 自体には空データチェックがない。`if len(data) == 0 { return }` を追加。

#### S-02: `ListWorktreesWithInfo` コメント追加
- **ファイル**: `internal/git/worktree.go`
- **詳細**: `ListWorktrees` は `SplitSeq` でイテレータベース、`ListWorktreesWithInfo` は `Split` でスライスベース。後者はステートフルなパースが必要なため `Split` が適切。意図を明示するコメント追加。

#### S-03: `panestate/manager_test.go`: `wg.Go` と `wg.Add/go func` の混在
- **ファイル**: `internal/panestate/manager_test.go`
- **詳細**: 同一ファイル内で新旧パターンが混在。`wg.Go` に統一推奨。

#### S-04: `app_session_api_test.go`: `ptrBool` パターンの不統一
- **ファイル**: `app_session_api_test.go`:68-90付近
- **詳細**: `func() *bool { v := true; return &v }()` という旧パターンと `new(true)` が混在。`new(true)` に統一。

#### S-05: ベンチマーク `b.Loop()` 未移行
- **ファイル**: `app_pane_feed_test.go`:317, `app_snapshot_delta_test.go`:571,590
- **詳細**: `for i := 0; i < b.N; i++` を使用。`protocol_test.go` では既に `b.Loop()` に移行済み。`for b.Loop() {` に置換。

#### S-06: `wg.Go` 未移行
- **ファイル**: `app_config_state_test.go`:61, `app_context_test.go`:32
- **詳細**: `wg.Add(1); go func() { defer wg.Done() ... }` という旧パターン。`wg.Go(func() { ... })` に統一。

#### S-07: テストヘルパー `waitForCondition` の重複
- **ファイル**: `app_pane_feed_test.go`:15, `internal/wsserver/hub_test.go`:20
- **詳細**: 異なるパッケージで2つの `waitForCondition` が定義。シグネチャも異なる。将来的には `testutil` パッケージへの統合を検討。

#### S-08: `hub_test.go`: `waitForCondition` のビジーループ
- **ファイル**: `internal/wsserver/hub_test.go`
- **詳細**: `time.Sleep(10ms)` のビジーループ。`app_pane_feed_test.go` 版のように `time.NewTicker` + `select` パターンの方が堅牢。

#### S-09: `paneDataStream.ts`: `textDecoder` の用途コメント / 変数名明確化
- **ファイル**: `frontend/src/services/paneDataStream.ts`
- **詳細**: モジュールスコープの `textDecoder` がpaneIDデコード専用で `stream:true` を意図的に使っていない理由がコメント未記載。また `paneIdDecoder` / `dataDecoder` のように命名すると可読性向上。

#### S-10: 再接続バックオフのジッター
- **ファイル**: `frontend/src/services/paneDataStream.ts`:201付近
- **詳細**: シングルクライアント・デスクトップアプリのため thundering herd の問題は発生しないが、ジッター追加でリトライの周期的失敗を分散可能。優先度低。

#### S-11: `ptrBool` ヘルパーと `new(true)` の共存
- **ファイル**: `command_router_env_test.go`, `app_session_api_test.go`
- **詳細**: `ptrBool` ヘルパー関数がまだ残存。移行完了後は削除して `new(true)` / `new(false)` に統一。

#### S-12: `hub_test.go` のカスタム `containsSubstring` を `strings.Contains` に置換
- **ファイル**: `internal/wsserver/hub_test.go`
- **詳細**: `containsSubstring` は `strings.Contains` のラッパーに過ぎない。標準ライブラリを直接使うべき。

#### S-13: `paneDataStream.ts` のログ不一致（slog vs console.warn）
- **ファイル**: `frontend/src/services/paneDataStream.ts`
- **詳細**: 一部で `slog.warn` を使い、一部で `console.warn` を使っている。統一すべき。

#### S-14: `BroadcastPaneData` のレースウィンドウをドキュメント化
- **ファイル**: `internal/wsserver/hub.go` L250-261
- **詳細**: `mu.RUnlock` → `writeMu.Lock` の間に接続置換が可能。設計上許容されており後段のエラーハンドリングで対処済み。NOTEコメントでの明文化を確認。

#### S-15: `validateWebSocketPort` のログレベル
- **ファイル**: `internal/config/config.go`
- **詳細**: 不正ポート番号のログレベルが `slog.Warn` だが、より具体的なメッセージが望ましい。

#### S-16: `closeExisting` のエラー黙殺
- **ファイル**: `internal/wsserver/hub.go`
- **詳細**: 既存接続クローズ時のエラーがログに出力されない。デバッグ時に有用なためログ出力推奨。

#### S-17: `BroadcastPaneData` 失敗時のデータ損失
- **ファイル**: `internal/wsserver/hub.go`
- **詳細**: WebSocket書き込み失敗時にデータチャンクが失われる。再接続時にフル再送される設計か確認が必要。

#### S-18: `EncodePaneData` に空 paneID ガードの追加
- **ファイル**: `internal/wsserver/protocol.go`
- **詳細**: `len(paneID) > 255` はチェックしているが `len(paneID) == 0` はチェックしていない。

#### S-19: `applyDefaults` の補正がプログラム的に検出不能
- **ファイル**: `internal/workerutil/recovery.go`
- **詳細**: 不正な値が黙ってデフォルト値に補正されるが、呼び出し側に通知がない。ログ出力する案。

#### S-20: 空 paneID の `enqueuePaneOutput` テスト追加
- **ファイル**: `app_pane_feed_test.go`

#### S-21: `DecodePaneData` nil フレーム / エラーメッセージ検証テスト追加
- **ファイル**: `internal/wsserver/protocol_test.go`
- **詳細**: エラー返却は検証しているが "empty frame" vs "frame too short" の区別をテストしていない。`wantErrSubstr` フィールド追加を推奨。

#### S-22: `RunWithPanicRecovery` 並行実行テスト追加
- **ファイル**: `internal/workerutil/recovery_test.go`

#### S-23: `WebSocketPort` の Save ラウンドトリップテスト追加
- **ファイル**: `internal/config/config_test.go`

#### S-24: `disconnect` ハンドラクリアリングテスト追加
- **ファイル**: `frontend/tests/`

#### S-25: `Hub.closeOnce` による再利用不可の文書化
- **ファイル**: `internal/wsserver/hub.go`
- **詳細**: `sync.Once` 使用のため、`Stop()` 後の `Start()` 再呼び出しが不可。コメントで明記。

#### S-26: `EncodePaneData`/`DecodePaneData` のプロトコル仕様コメント統合
- **ファイル**: `internal/wsserver/protocol.go`
- **詳細**: プロトコルバイトレイアウトのドキュメントが `hub.go` と `protocol.go` に分散。`protocol.go` にパッケージDocとして集約。

#### S-27: `paneHandlers` Map のペインあたり単一ハンドラ制約の文書化
- **ファイル**: `frontend/src/services/paneDataStream.ts`

#### S-28: `HubOptions` 単一フィールドの妥当性
- **ファイル**: `internal/wsserver/hub.go`
- **詳細**: `HubOptions` 構造体に `URL` フィールドしかなく、構造体である必要があるかは疑問。将来の拡張を見込んでの設計であれば妥当。

#### S-29: DEV ガード反復パターンのヘルパー関数化
- **ファイル**: `frontend/src/hooks/useBackendSync.ts`
- **詳細**: `if (import.meta.env.DEV) { console.warn(...) }` が15箇所以上。`devWarn()` ヘルパーで簡素化可能。Vite の tree-shaking 最適化との兼ね合いを確認。

#### S-30: `defaultRecoveryOptions` Docコメントの将来拡張記述
- **ファイル**: `app_lifecycle.go` L340-341
- **詳細**: 「Worker-specific overrides can be set on the returned struct」と記載があるが、現時点で未使用。`currently unused` 注記追加検討。

#### S-31: pane-feed-worker パニック時のプールバッファリーク
- **ファイル**: `app_pane_feed.go`
- **詳細**: `FeedTrimmed` がパニックした場合、`putFeedBuffer` が呼ばれずプールバッファが1つリークする理論的可能性。GCが回収するため実害軽微。

#### S-32: `DecodePaneData` のゼロコピースライス
- **ファイル**: `internal/wsserver/protocol.go`
- **詳細**: 戻り値が入力 `frame` のバッファを共有。呼び出し元がフレームバッファを再利用する場合、データ破損のリスク。現在の使用パターンでは問題ないがドキュメントに明記。

#### S-33: `tsconfig.json` の末尾改行なし
- **ファイル**: `frontend/tsconfig.json`
- **詳細**: POSIX 準拠のため末尾改行を追加。

#### S-34: `handleSubscription` の空 paneID 拒否テストなし
- **ファイル**: `internal/wsserver/hub_test.go`
- **詳細**: 実装に `id == ""` ガードがあるが、空文字列 paneID を含む subscribe リクエストの拒否テストがない。

#### S-35: `TestNewHubDefaultAddr` のハードコード
- **ファイル**: `internal/wsserver/hub_test.go`
- **詳細**: `"127.0.0.1:0"` がハードコード。実装側で定数化すると乖離を防げる。

#### S-36: startup 時の理論的レース（パイプサーバ起動 → wsHub 代入）
- **ファイル**: `app_lifecycle.go`
- **詳細**: パイプサーバが先に起動し wsHub 代入前にリクエストが来る理論的可能性。実際にはセッション未存在のため不到達。コメントで意図を記載推奨。

#### S-37: デュアルリスナーの初期フレーム重複
- **ファイル**: `frontend/src/hooks/useTerminalEvents.ts`
- **詳細**: `wsActive=false` のウィンドウで WS と IPC の両方が初期フレームを処理する可能性。設計上のトレードオフとして受容。

#### S-38: `TestConnectionReplacement` が `hub.conn` に直接アクセス
- **ファイル**: `internal/wsserver/hub_test.go`
- **詳細**: テストパッケージ内なので可能だが実装詳細に依存。許容。

---

### Positive（高評価ポイント）

| # | 対象 | 内容 |
|---|------|------|
| P-01 | wsserver全般 | lock ordering 明文化、単一接続モデルのデスクトップアプリへの適合性、sync.Pool活用 |
| P-02 | wsserver/hub_test.go | ライフサイクル・接続置換・subscribe/unsubscribe・エラーハンドリング・abrupt disconnection・graceful shutdown 網羅 |
| P-03 | workerutil/recovery_test.go | 12サブテスト＋nextBackoff単体テスト |
| P-04 | protocol_test.go | `b.Loop()`・`t.Parallel()`・`testing.AllocsPerRun` 活用 |
| P-05 | app_events_test.go WS↔IPC | Hub nil→IPC、Hub有り接続なし→IPC、Hub有り接続あり→WS の3状態カバー |
| P-06 | paneDataStream.ts closeExisting | `ws=null` → `close()` 順序による二重保護パターン |
| P-07 | paneDataStream.ts onopen | 全登録ハンドラ再subscribeで接続順序問題を安全にハンドル |
| P-08 | useTerminalEvents.ts Dual-listener | wsActive + isWsConnected() の組合せで4状態を正しくカバー |
| P-09 | Go 1.26移行全般 | strings.SplitSeq, errors.AsType, wg.Go, maps.Copy, min/max, range int 全て正確 |
| P-10 | maps.Copy nil安全性 | 全使用箇所でdstが事前割り当て済み |
| P-11 | config WebSocketPort | バリデーション・テスト・Clone対応・フィールドガード完備 |
| P-12 | tmux-shim 原文転送 | 失敗時の原文転送ポリシーを正しく遵守 |
| P-13 | paneDataStream.test.ts | プロトコルエッジケース網羅、stale onclose 競合条件の正確な再現 |
| P-14 | フィールドカウントガード | 7構造体のフィールド数ガードテスト完備 |
| P-15 | SnapshotEventPolicy | 構造的不変条件の自動検証設計 |
| P-16 | バイナリプロトコル設計 | `[1byte:paneIDLen][paneID][data]` の軽量フレーム、アロケーションフリー |
| P-17 | `clearIfCurrent` パターン | ステイルconnection問題を安全に処理、3箇所で再利用（DRY） |
| P-18 | `nextBackoff` オーバーフローガード | `time.Duration` が `int64` である点を考慮した防御 |
| P-19 | `applyDefaults` イミュータブルコピー | 元の `RecoveryOptions` を変更せずコピーにデフォルト適用 |
| P-20 | 統一デバッグログ `[DEBUG-*]` | 検索・削除が容易な命名規則 |

---

## 総合評価

| 評価軸 | 評点 | コメント |
|--------|------|---------|
| 設計/アーキテクチャ | ★★★★☆ | lock ordering明文化、責務分離優秀。Hub単一接続モデルはデスクトップアプリに適切 |
| 競合安全性 | ★★★★☆ | TOCTOU窓口は認識済みで許容範囲 |
| エラーハンドリング | ★★★★★ | ログ出力・動作継続・graceful degradation が一貫 |
| テスト品質 | ★★★★★ | wsserver, workerutil の新規テストは模範的。フィールドガード完備 |
| コード品質 | ★★★★☆ | コメントが丁寧で意図明確。一部Go 1.26移行の不統一あり |
| パフォーマンス | ★★★★☆ | sync.Pool, binary protocol, lock外encode等の適切な最適化 |
| Go 1.26移行 | ★★★★☆ | 全API正確。一部テストファイルに旧パターン残存 |
| フロントエンド | ★★★★★ | WebSocket管理のstale eventガード・テストが高品質 |

**総評**: 変更全体は**高品質**でコミット可能な状態。Critical な問題はなく、Important レベルの指摘も主に予防的な改善提案。WebSocket ストリーミングの追加は設計・実装ともに堅牢で、Go 1.26 モダン化も正確に適用。テストカバレッジも十分。

---

## 並列作業表

### タスク一覧（優先度・並列可否）

| # | ID | 対象ファイル | 修正内容 | 優先度 | 並列可否 | 備考 |
|---|-----|-------------|---------|:------:|:-------:|------|
| 1 | I-01 | `app_lifecycle.go` | `IsShutdown` を `shuttingDown.Load()` に変更 | 高 | ✅ | 一箇所変更 |
| 2 | I-03 | `app_lifecycle.go` | `waitWithTimeout` Timer ドレイン簡素化 | 中 | ⚠️ | I-01と同一ファイル |
| 3 | I-02 | `app_lifecycle_test.go` (新規) | `defaultRecoveryOptions` テスト追加 | 中 | ✅ | 新規テスト |
| 4 | I-04 | `wsserver/hub.go` | ロック順序コメント修正 | 高 | ⚠️ | hub.go内の他タスクと順次 |
| 5 | I-05 | `wsserver/hub.go` | `BroadcastPaneData` TOCTOU対策 or コメント維持 | 中 | ⚠️ | 同上 |
| 6 | I-06 | `wsserver/hub.go` | `pingLoop` パニック時の接続クリーンアップ | 高 | ⚠️ | 同上 |
| 7 | I-07 | `wsserver/protocol.go` + `useTerminalEvents.ts` | 空paneIDフレーム防御 | 高 | ✅ | Go/TS分担可能 |
| 8 | I-08 | `wsserver/hub.go` | クリーンアップポリシーコメント明文化 | 低 | ⚠️ | hub.goグループ |
| 9 | I-09 | `app.go` | `GetWebSocketURL` nilチェックログ追加 | 低 | ✅ | 1行追加 |
| 10 | I-10 | `app_pane_api.go` | `SendInput` 失敗ログ追加 | 低 | ✅ | 独立変更 |
| 11 | I-11 | `wsserver/hub.go` | `Start()` sync.Once or コメント | 低 | ⚠️ | hub.goグループ |
| 12 | I-13 | `workerutil/recovery.go` | `MaxRetries=0` ドキュメント明確化 | 低 | ⚠️ | recovery.goグループ |
| 13 | I-14 | `workerutil/recovery.go` | `wg.Add` コメント → `wg.Go` 更新 | 中 | ⚠️ | 同上 |
| 14 | I-15 | `wsserver/hub.go` | `subscribeMsg.Action` 定数定義 | 低 | ⚠️ | hub.goグループ |
| 15 | I-16 | `wsserver/hub_test.go` | ポート競合テスト追加 | 中 | ⚠️ | hub_test.goグループ |
| 16 | I-17 | `wsserver/hub_test.go` | `pingLoop` テスト追加 | 中 | ⚠️ | 同上 |
| 17 | I-18 | `paneDataStream.ts` + `useTerminalEvents.ts` | TextDecoder再接続リセット | 中 | ⚠️ | フロントエンドWSグループ |
| 18 | I-19 | `app_events.go` or `paneDataStream.ts` | WS未subscribe期間フォールバック | 中 | ⚠️ | 設計判断必要 |
| 19 | I-20 | `useTerminalEvents.ts` | `wsActive` リセットメカニズム | 低 | ⚠️ | I-18完了後推奨 |
| 20 | I-21 | `paneDataStream.ts` | `console.warn` DEVガード統一 | 高 | ⚠️ | paneDataStreamグループ |
| 21 | I-22 | `paneDataStream.ts` | HMR `dispose` 追加 | 中 | ⚠️ | 同上 |
| 22 | I-23 | `app_events_test.go` | `time.Sleep` → ポーリング | 中 | ⚠️ | events_testグループ |
| 23 | I-24 | `app_events_test.go` | IPC不在検証タイミング改善 | 中 | ⚠️ | 同上 |
| 24 | I-25 | `recovery_test.go` | initialBackoff 100ms に変更 | 低 | ✅ | テスト単独 |
| 25 | I-27 | `app_snapshot_delta_test.go` | `reflect.TypeFor` 移行 | 中 | ✅ | テスト単独 |
| 26 | I-28 | `app_snapshot_metrics_test.go` | `reflect.TypeFor` 移行 | 中 | ✅ | テスト単独 |
| 27 | S-01 | `wsserver/hub.go` | 空データガード追加 | 低 | ⚠️ | hub.goグループ |
| 28 | S-03 | `panestate/manager_test.go` | `wg.Go` 統一 | 低 | ✅ | テスト単独 |
| 29 | S-04 | `app_session_api_test.go` | `ptrBool` → `new(true)` | 低 | ✅ | テスト単独 |
| 30 | S-05 | `app_pane_feed_test.go`, `app_snapshot_delta_test.go` | `b.Loop()` 移行 | 低 | ✅ | テスト、他と依存なし |
| 31 | S-06 | `app_config_state_test.go`, `app_context_test.go` | `wg.Go` 統一 | 低 | ✅ | テスト単独 |
| 32 | S-07 | testutil/, hub_test.go, app_pane_feed_test.go | `waitForCondition` 統合 | 低 | ❌ | 複数パッケージ横断、別途計画 |
| 33 | S-08 | `hub_test.go` | `waitForCondition` ビジーループ改善 | 低 | ⚠️ | hub_test.goグループ |
| 34 | S-11 | `command_router_env_test.go` 等 | `ptrBool` ヘルパー削除 | 低 | ✅ | S-04完了後 |
| 35 | S-12 | `hub_test.go` | `containsSubstring` → `strings.Contains` | 低 | ⚠️ | hub_test.goグループ |
| 36 | S-33 | `tsconfig.json` | 末尾改行追加 | 低 | ✅ | 独立 |

### 並列実行グループ

グループ間は**完全に並列実行可能**。グループ内は**同一ファイルのため順次実行**。

| グループ | タスク | 対象ファイル群 | 推奨順序 |
|---------|--------|-------------|---------|
| **A: app_lifecycle.go** | I-01 → I-03, S-30, S-36 | `app_lifecycle.go` | I-01(コードfix) → I-03(簡素化) → コメント系 |
| **B: wsserver/hub.go** | I-04 → I-06 → I-05 → I-08 → I-11 → I-15, S-01, S-14, S-16, S-25, S-28 | `wsserver/hub.go` | I-04(コメント) → I-06(実装) → I-05(設計判断) → 残り |
| **C: workerutil/recovery.go** | I-14 → I-13, S-19 | `workerutil/recovery.go` | I-14(コメント) → I-13(Doc) → S-19 |
| **D: wsserver/protocol.go** | I-07(Go側), S-18, S-26, S-32 | `wsserver/protocol.go` | I-07 → S-18 → S-26 → S-32 |
| **E: paneDataStream.ts** | I-21 → I-22, S-09, S-10, S-13, S-27 | `paneDataStream.ts` | I-21(DEVガード) → I-22(HMR) → コメント系 |
| **F: useTerminalEvents.ts** | I-18 → I-20, I-07(TS側), S-37 | `useTerminalEvents.ts` | I-18(TextDecoder) → I-20(wsActive) |
| **G: wsserver/hub_test.go** | I-16, I-17, S-08, S-12, S-34, S-35, S-38 | `wsserver/hub_test.go` | I-16 → I-17 → S-08 → S-12 → 残り |
| **H: app_events_test.go** | I-23 → I-24, I-26 | `app_events_test.go` | I-23(ポーリング化) → I-24(待機追加) |
| **I: Go テスト統一（独立ファイル群）** | I-27, I-28, S-03, S-04, S-05, S-06, I-25 | 各テストファイル | **全て並列OK** |
| **J: 独立修正** | I-09, I-10, S-33 | `app.go`, `app_pane_api.go`, `tsconfig.json` | **全て並列OK** |
| **K: 新規テスト** | I-02, S-20, S-21, S-22, S-23, S-24 | 各テストファイル（新規/追記） | **全て並列OK** |
| **L: クリーンアップ** | S-11, S-31 | `command_router_env_test.go`, `app_pane_feed.go` | S-04完了後に S-11 実施 |
| **別途計画** | S-07 | 複数パッケージ横断 | 単独リファクタリング作業 |

### 推奨作業フロー

```
作業者1: Group A (app_lifecycle.go) + Group J (独立修正)
作業者2: Group B (hub.go 修正一式)
作業者3: Group C (recovery.go) + Group K (新規テスト追加)
作業者4: Group D (protocol.go) + Group I (Goテスト統一 — 全並列OK）
作業者5: Group E (paneDataStream.ts) + Group F (useTerminalEvents.ts)
作業者6: Group G (hub_test.go) + Group H (app_events_test.go)

→ 全作業者完了後: Group L (クリーンアップ) → S-07 (別途計画)
```

### 優先度マトリクス

| 優先度 | タスク | 理由 |
|--------|--------|------|
| **高** | I-01, I-04, I-06, I-07, I-21 | コード正確性・本番品質に直接影響 |
| **中** | I-02, I-03, I-05, I-14, I-16, I-17, I-18, I-19, I-22, I-23, I-24, I-27, I-28 | テスト安定性・コード品質・一貫性の改善 |
| **低** | I-08〜I-13, I-15, I-20, I-25, I-26, S-01〜S-38 | 防御的改善・ドキュメント・命名・リファクタリング |

> **推奨アクション**: 高優先度5件（I-01, I-04, I-06, I-07, I-21）を修正後にコミット。中優先度は同一コミットまたは後続コミットで対応。低優先度は後続コミットで順次対応可。
