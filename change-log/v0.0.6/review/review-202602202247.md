@d:\myT-x\dev-myT-x\CLAUDE.md

# PR Review Summary: DevPanel Viewer System (統合版)

**レビュー日時**: 2026-02-20 22:47
**対象**: `myT-x/` 配下のコミット前ファイル
**概要**: 過去の複数回のレビュー結果（ディレクトリ・ファイル操作、Git履歴解析、Viewer UI等）の指摘事項を重複なく統合し、修正作業を効率化するための包括的レポートです。

---

## 🚨 Critical Issues (致命的な問題 - マージ前に必ず修正)

### C-1. `app_session_api_test.go`: コンパイルエラー (`new(true)`)
- **詳細**: `wantUseClaudeEnv: new(true)` はGoの文法において不正です。テストがビルドできなくなります。
- **対応**: `ptrBool(true)` のような専用関数、または変数を定義してアドレスを取得するように修正。

### C-2. `DevPanelReadFile`: 全ファイル一括読み取りによる OOM リーク
- **対象**: `app_devpanel_api.go`
- **詳細**: `os.ReadFile` で全データメモリ読み込み後、サイズ超過をトリミングしているため、数GBのファイルを開いた際にOOMでクラッシュします。
- **対応**: `os.Stat`の `info.Size()` を用いた事前判定と、`io.LimitReader` / `io.ReadFull` などを利用して制限バッファ内で読み取るように変更。

### C-3. `DevPanelGitStatus`: `line[3:]` でのパニック
- **対象**: `app_devpanel_api.go`
- **詳細**: ガード条件が `len(line) < 2` の状態で `line[3:]` へアクセスしており、長さ2の行が来た際に「index out of bounds」パニックが発生します。
- **対応**: ガード条件を `len(line) < 4` に修正。

### C-4. 非同期フェッチ競合およびクリーンアップ不足 (Race Condition / Memory Leak)
- **対象**: `useFileTree.ts`, `useGitGraph.ts`
- **詳細**: Promise解決前のコンポーネントマウント判定がなく、アンマウント時の `AbortController` キャンセルや、セッション切替時の stale response guard が実装されていません。(ファイルA→Bと素早く遷移時、Aで上書きされる恐れ等)
- **対応**: API非同期処理内でのセッションIDの一致チェックやクリーンアップ処理の追加。

---

## ⚠️ Important Issues (重要な問題・修正推奨)

### 【Backend & Git CLI】

- **I-1. コマンドインジェクション・パストラバーサル対策**:
  - `internal/git/command.go`: `RunGitCLIPublic` 層で任意の引数によるインジェクションリスクを減らすために入力検証・エスケープ対応推奨（`--` の強要等）。
  - `app_devpanel_api.go`: `HasPrefix("..")` ではなく `filepath.IsLocal` を使った堅牢なパス検証への移行。
- **I-2. Gitハッシュの衝突リスク及び `%h` 関連の修正**:
  - `DevPanelGitLog` や `selectCommit` (`useGitGraph.ts`) にて短縮ハッシュ(7文字)で判定を行っているため、大規模リポジトリ特有の衝突リスクがあります。`%p` の利用、あるいはフルハッシュ(`%H`) の利用・連携に修正。
- **I-3. `diff-tree` での ROOT コミットの差分表示バグ**:
  - `app_devpanel_api.go` (`DevPanelCommitDiff`): 親コミットが存在しない初回コミットにおいて、`--root` オプションがないと差分が取れません。
- **I-4. ロジック・クオリティの最適化**:
  - `app_devpanel_api.go`: `fmt.Sprintf` にフォーマット引数なしでの乱用削除 (`%%`のエスケープ用に使用されている)。
  - `app_devpanel_api.go`: `resolveSessionWorkDir` / `resolveSessionRepoDir` 間の冗長なコード重複の共通化。
  - `app_devpanel_api.go` (`DevPanelGitStatus`): `fmt.Sscanf` に失敗した際のエラー戻り値を無視している処理に最低でもログ出力を追加。
- **I-5. テスト・バリデーション**:
  - `app_devpanel_api_test.go`: Git操作テストとユニットテストの追加、およびStructフィールド数だけに頼らない安全なテスト（JSONシリアライザテスト等）の追加。

### 【Frontend Components & React Hooks】

- **I-6. 自動生成コードの直接変更禁止**:
  - `api.ts`, `models.ts`: Wails自動生成コードへの直接修正が混入しています（`wails generate module` の未実行等に注意）。
- **I-7. `react-window` 仮想リストのパフォーマンス最適化**:
  - `FileTreeSidebar.tsx`, `CommitGraph.tsx`: `selectedPath` や `selectedHash` が変化する度 `itemData` が変わりリスト全体が不必要に再描画されます。Zustand管理かメモ化分割へ。
  - 同時に、高さが固定でリサイズされないため `ResizeObserver` の導入が必須。
- **I-8. `FileContentViewer.tsx` の各種改善**:
  - メモリ負荷軽減のため `lines` 分割結果の `useMemo` によるメモ化。
  - `handleCopyPath` 後の `setTimeout` クリーンアップ漏れ修正。
  - コピー失敗時にユーザへ通知するUI (Toastエラー) の追加。
- **I-9. Escapeキーモーダル同時閉じバグ**:
  - `ViewerSystem.tsx`: `window` に設定した keyDown イベントにて `e.defaultPrevented` のチェック処理を追加すべし。
- **I-10. カスタムフックの依存最適化**:
  - `useFileTree.ts`: `toggleDir` が `childrenCache` に依存して毎回再生成されているため、`useRef` に避難。

### 【Style & CSS】

- **I-11. ハードコード設定のCSS変数（Theme）管理への移行**:
  - `viewer.css`, `base.css`: `z-index` (50, 40等)、`left: 280px`、`margin-right: 36px`、および8箇所以上に散らばる `rgba()` カラー値をすべてモダンな CSS カスタムプロパティ（例: `var(--git-ahead)`）へ切り出し、保守性を向上。

---

## 🛠 タスク並列作業テーブル

| タスクID | 優先度 | 対象モジュール・ファイル | タスク概要 | 並列可否 | 備考・依存関係 |
| :--- | :--- | :--- | :--- | :---: | :--- |
| **T-1** | **CRITICAL** | Backend<br>`app_session_api_test.go` | テストコンパイルエラー(`new(true)`)修正 | ◎ 非依存 | 最優先。他への影響なし |
| **T-2** | **CRITICAL** | Backend<br>`app_devpanel_api.go` | `DevPanelReadFile` の OOM 修正（`io.LimitReader` 等） | ◎ 非依存 | バックエンド内単独作業 |
| **T-3** | **CRITICAL** | Backend<br>`app_devpanel_api.go` | `DevPanelGitStatus` の `line[3:]` index-out-of-bounds パニックの修正 | ◎ 非依存 | T-2と同ファイルだが関数が独立 |
| **T-4** | **CRITICAL** | Frontend (Hooks)<br>`useFileTree.ts`<br>`useGitGraph.ts` | 複数非同期APIの競合・メモリリーク修正（AbortControllerやstale stateガード追加） | ◎ 非依存 | セッション切替バグも同時に解消する。**フロントエンド最優先** |
| **T-5** | Important | Backend<br>`internal/git/command.go`<br>`app_devpanel_api.go` | コマンドインジェクション及びパストラバーサル(`filepath.IsLocal`) のセキュリティ対策 | 〇 注意 | T-2/T-3とマージ競合の可能性があるため留意 |
| **T-6** | Important | Backend (Git CLI関連)<br>`app_devpanel_api.go` | フルハッシュ(%P)連携、`--root` 差分修正、ログ改善と重複除去等のクオリティ最適化 | 〇 注意 | Frontend(T-7)側での `commit.full_hash` 指定修正と連動するため注意 |
| **T-7** | Important | Frontend (Components)<br>`FileTreeSidebar.tsx`<br>`CommitGraph.tsx`<br>`ViewerSystem.tsx` | react-window再レンダー抑制、ResizeObserver導入、Escape二重発火抑止 | 〇 | フロントエンドUI側の独立タスク。T-6対応時は full_hash 連動を実施 |
| **T-8** | Important | Frontend (Viewer)<br>`FileContentViewer.tsx`<br>`useFileTree.ts` | linesのuseMemo化、setTimeoutクリーンアップ、toggleDirのRef化 | 〇 | フック周りとコンポーネント計算の微修正 |
| **T-9** | Important | Styles & CSS<br>`viewer.css`<br>`base.css` | z-index設計の変数化、margin/left の固定値排除、rgba 色値のCSS変数移行 | ◎ 非依存 | CSSのみの修正のため、他機能と全くコンフリクトせず作業可能 |
| **T-10** | Suggestion | Tests<br>`app_devpanel_api_test.go` | Git走査等にまつわるユニットテスト追加、各種バリデーション | △ 後続 | 実装の修正対応が終わったあとに着手することを推奨 |

> **💡 おすすめの作業進行**
> - **Agent 1 (Backend 主担当)**: T-1 → T-2 → T-3 を連続で実施し、そのまま T-5, T-6 へ。
> - **Agent 2 (Frontend 主担当)**: T-4 を最優先で実施。完了後、T-7, T-8 へシフト（バックエンド設計 T-6 と一部ハッシュ定義のすり合わせ要）。
> - **Agent 3 (UI/CSS 主担当)**: T-9 を単独で実施。(誰とも競合しない)
