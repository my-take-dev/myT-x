# PR Review Summary — AddWindow削除 & handleNewWindow子セッション化（統合版）

**レビュー日時**: 2026-02-21 11:34  
**統合元**: `review-20260221103006.md`, `review-20260221105710.md`  
**対象**: myT-x/ 配下の未コミット変更  
**変更規模**: 23ファイル, +310行 / -1,626行（主に削除）  
**レビュー方式**: 6エージェント並列レビュー（code / tests / errors / types+comments / simplify / side-effects）

---

## 変更概要

`AddWindow` 機能を完全に削除し、`handleNewWindow` を「既存セッションにウィンドウ追加」から「子セッション新規作成」に変更する大規模リファクタリング。  
全体的に **「複数ウィンドウ運用から、１セッション１ウィンドウ運用への移行」** が目的であり、その移行に伴う「削除漏れ（デッドコード）」と「Tmuxインターフェースの後方互換性の破壊」が主な指摘点。

### カテゴリ別変更ファイル

| カテゴリ | ファイル | 変更内容 |
|---------|---------|---------|
| **Go実装(App層)** | `app_devpanel_api.go` | `max()` ビルトイン活用（軽微） |
| | `app_events.go` | `tmux:window-created` イベント削除 |
| | `app_window_api.go` | `AddWindow`, `SelectWindow` API削除 |
| **Go実装(tmux内部)** | `command_router_handlers_window.go` | `handleNewWindow` 完全書き換え |
| | `session_manager_windows.go` | `AddWindow` メソッド削除 |
| **Goテスト(App層)** | `app_events_test.go` | イベントポリシーテスト調整 |
| | `app_pane_api_test.go` | マルチウィンドウテスト削除 |
| | `app_session_api_test.go` | マルチウィンドウテスト削除 |
| | `app_window_api_test.go` | `AddWindow`/`SelectWindow`テスト削除 |
| **Goテスト(tmux内部)** | `command_router_env_test.go` | 環境変数テスト調整 |
| | `command_router_handlers_window_test.go` | `handleNewWindow`テスト完全書き換え |
| | `session_manager_directional_test.go` | マルチウィンドウ方向ナビテスト削除 |
| | `session_manager_pane_io_test.go` | StableIDテスト削除 |
| | `session_manager_test.go` | マルチウィンドウ関連テスト大量削除 |
| | `session_manager_window_test.go` | ウィンドウ削除・遷移テスト大量削除 |
| **フロントエンド** | `SessionView.tsx` | ウィンドウタブバーUI完全削除 |
| | `usePrefixKeyMode.ts` | Prefix+c無効化 |
| | `useWindowRename.ts` | ファイル完全削除 |
| | `api.ts` | `RemoveWindow`/`RenameWindow` import削除 |
| | `layout.css` | ウィンドウタブCSS削除 |
| **Wailsバインディング** | `App.d.ts` / `App.js` | 自動生成ファイル（Go側に依存） |

---

## Critical Issues (3件)

### C-1. [side-effects] `handleNewWindow` の `-n` 必須化による後方互換性の破壊

**ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go#L195-L197)

**問題**: `handleNewWindow` は `-n`（子セッション名）を必須パラメータとして追加。旧実装では `-t` のみで動作していた。tmux-shimの `parse.go` は `-t` のバリデーションのみ行い、`-n` のバリデーションは未追加。存在しない場合は `fmt.Errorf("new-window requires -n with new session name")` とエラーを返し失敗する。既存のシェルスクリプトやプラグインが `-n` 無しで `tmux new-window` を呼び出すケースですべてエラーとなる。

**影響**: Claude Code Agent Teams が `-n`なしで `new-window` を呼ぶ場合に破壊的変更。ただしAgent Teamsは通常 `-t parent -n child` 形式で呼び出すため、実運用リスクは低い。

**推奨修正**:
1. shimの `parse.go` に `-n` 必須バリデーション追加（エラーメッセージ改善）
2. shimテスト `new-window with -t and command arg` に `-n` なしケースの期待エラー追加
3. `-n` がない場合のフォールバック: `SessionManager` の `nextAutoSessionNameLocked()` 等を用いてセッション名を自動生成する代替案も検討

### C-2. [side-effects] `new-window` セマンティクスの完全変更

**ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go#L186-L298)

**問題**: `new-window` の意味が「既存セッションにウィンドウ追加」→「子セッション作成」に完全変更。tmux互換レイヤーとしてのコマンドセマンティクスが標準tmuxと大きく乖離する。

**影響**: CLAUDE.md「オペレータが直接shimを呼び出す事は無い」かつ「開発中で後方互換不要」の方針を考慮すると、方針上は問題なし。ただし、外部ツールやドキュメントが旧セマンティクスを前提としていないか確認が必要。

**推奨アクション**: 方針上承認であれば、shimのspec.goにセマンティクス変更のコメントを追記。

### C-3. [code-reviewer/simplify] ウィンドウ操作APIの削除漏れ（バックエンド側の不整合）

**ファイル**: `myT-x/app_window_api.go` および `myT-x/frontend/wailsjs/go/main/App.d.ts`

**問題**: フロントエンドの UI (`SessionView.tsx`, `api.ts`) 全体からウィンドウタブや `AddWindow` 等の概念を完全に削除しているにも関わらず、`app_window_api.go` には `RemoveWindow` と `RenameWindow` がそのまま残存。これらは呼び出し元がなく完全なデッドコードとなっており、Wais バインディングも生成され続けている。

**推奨修正**: `app_window_api.go` 内の該当メソッド群を削除し、`wails generate module` 等でバインディングをクリーンアップ。付随する `app_window_api_test.go` も削除または大幅削減が必要。

---

## Important Issues (6件)

### I-1. [code-reviewer/ux] `-d` 未指定時のフォーカス移動の欠如 & `tmux:pane-focused` イベント未emit

**ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go#L270-L278)

**問題**: `new-window`（新セッション化）実行時に `-d` フラグが無い場合、`SetActivePane(pane.ID)` を呼び出しているが:
1. アプリケーション全体の「アクティブセッション」そのものを切り替える処理が不足。ユーザーのUI表示は元の古いセッションのまま。
2. `handleSelectWindow` や `handleSelectPane` では `SetActivePane` 成功後に `tmux:pane-focused` をemitしているが、`handleNewWindow` ではemitしていない。パターン不整合。

**推奨修正**:
1. フロントエンドにフォーカス移動を促すイベント（例: `app:activate-session`）をEmitするか、`ActiveSessionName` を更新
2. `SetActivePane` 成功時に `tmux:pane-focused` をemit:
```go
if !mustBool(req.Flags["-d"]) {
    if setErr := r.sessions.SetActivePane(pane.ID); setErr != nil {
        slog.Debug(...)
    } else {
        r.emitter.Emit("tmux:pane-focused", map[string]any{
            "sessionName": newSessionName,
            "paneId":      pane.IDString(),
        })
    }
}
```

### I-2. [errors] `handleNewSession` のrollback関数が `rmErr` をラップしていない

**ファイル**: `command_router_handlers_session.go` (diff外)

**問題**: `handleNewWindow` のrollback関数は `fmt.Errorf("%w (rollback failed: %v)", originalErr, rmErr)` でラップしているが、`handleNewSession` は `return errResp(originalErr)` のみ。`handleNewWindow` で改善されたパターンを `handleNewSession` にもバックポートすべき。

**推奨修正**: `handleNewSession` のrollback関数を `handleNewWindow` と同じパターンに統一。

### I-3. [tests] `RemoveWindowByID` の複数ウィンドウテスト欠落

**ファイル**: [session_manager_window_test.go](myT-x/internal/tmux/session_manager_window_test.go)

**問題**: `removeWindowAtIndexLocked` は複数ウィンドウ対応ロジック（`fallbackWindowIDNearIndex`、`SurvivingWindowID`、Terminal保持）を保持しているが、テストが全て削除された。以下のカバレッジが失われている:

1. `ActiveWindowID` 自動遷移（アクティブウィンドウ削除時）
2. 非アクティブウィンドウ削除時の `ActiveWindowID` 維持
3. `SurvivingWindowID` の返却値の妥当性
4. `RemovedPanes` の `Terminal` 保持（ConPTYリーク防止）
5. グローバル `panes` mapからのアンレジスタ

**推奨修正**: テスト用ヘルパーで `session.Windows` に直接ウィンドウを追加しテスト維持。または、1ウィンドウモデルではこのロジックが不要であればコードを簡素化。

### I-4. [code] セッション名重複チェックと `CreateSession` 間のTOCTOU

**ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go#L207-L214)

**問題**: ステップ4の `GetSession(newSessionName)` 重複チェック後、ステップ6の `CreateSession` 呼び出しまでにレースウィンドウがある。`CreateSession` 内部で原子的にチェック+作成しているなら問題なし。

**推奨修正**: `CreateSession` が内部で重複チェック済みであることをコメントに明記。

### I-5. [types] `tmux:window-destroyed` / `tmux:window-renamed` イベントが到達不能コード化

**ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go#L336-L342), [app_events.go](myT-x/app_events.go#L143)

**問題**:
1. `AddWindow` 削除により各セッションは1ウィンドウのみ。`handleKillWindow` の `!result.SessionRemoved` ブランチ（`tmux:window-destroyed` emit + `emitLayoutChangedForSession`）は到達不能。
2. `snapshotEventPolicies` に `tmux:window-destroyed` と `tmux:window-renamed` が `trigger: true` のまま残存。ウィンドウ概念がUIから消滅しているため無意味。

**推奨修正**: 到達不能であることをコメントで明示し、セッション側のイベントに統合を検討。

### I-6. [tests] 古いアーキテクチャに依存したテストコードの残存

**ファイル**: `myT-x/app_window_api_test.go`

**問題**: 内部的に複数ウィンドウを持つことを前提とした `RemoveWindow` や `RenameWindow` 用のテストが多数残存。機能自体が廃止されるため不要。

**推奨修正**: C-3のAPI削除と合わせてテストを削除。

---

## Suggestions (10件)

### S-1. [errors] `SetActivePane` 失敗時のログレベルを `slog.Warn` に引上げ

**ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go#L276)

`slog.Debug` → `slog.Warn` にすることで、本番環境でも問題検出が可能になる。

### S-2. [errors] `activePaneInSession` 失敗時のデバッグログ追加

**ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go#L217-L220)

```go
} else {
    slog.Debug("[DEBUG-WINDOW] using default terminal size, parent active pane unavailable",
        "parent", parentSessionName, "error", activePaneErr)
}
```

### S-3. [code] `resolveEnvForPaneCreation` のnil引数理由をdocstringにも明記

**ファイル**: [command_router.go](myT-x/internal/tmux/command_router.go#L201)

`inheritedEnv` が `nil` の場合の挙動を関数docstringにも記載すると可読性向上。

### S-4. [simplify] `RemoveWindow(sessionName, windowIdx)` index版がデッドコード

**ファイル**: [session_manager_windows.go](myT-x/internal/tmux/session_manager_windows.go#L35-L46)

本番コードからの呼び出し元なし（テストのみ）。削除候補。

### S-5. [simplify] `RenameWindow(sessionName, windowIdx)` index版がデッドコード

**ファイル**: [session_manager_windows.go](myT-x/internal/tmux/session_manager_windows.go#L160-L175)

本番コードからの呼び出し元なし。`RenameWindowByID` のみ使用。

### S-6. [simplify] `WindowIndexInSession` がデッドコード

**ファイル**: [session_manager_windows.go](myT-x/internal/tmux/session_manager_windows.go#L189-L200)

テストコードからのみ呼ばれている。本番コード呼び出し元なし。

### S-7. [simplify] `removeWindowResult` / `SurvivingWindowID` 構造体の過剰設計

1ウィンドウモデルでは `SurvivingWindowID` は常に -1。型の簡素化余地あり。

### S-8. [frontend] Prefix+c のコメント表記改善

**ファイル**: [usePrefixKeyMode.ts](myT-x/frontend/src/hooks/usePrefixKeyMode.ts#L99-L100)

「新セッション作成」は tmux 標準では `new-window`。myT-xでは `new-window` = 子セッション作成であり正確だが、混乱を避けるため補足コメント追加を推奨。

### S-9. [errors] `DevPanelGitStatus` の `branchErr` にデバッグログ追加

**ファイル**: [app_devpanel_api.go](myT-x/app_devpanel_api.go)

detached HEAD等で `branchErr` 発生時、原因追跡用に `slog.Debug` 追加推奨。

### S-10. [comments] `command_router_handlers_session.go` L52 のコメント精度

「additional panes only (split-window, new-window)」の `new-window` は既に子セッション作成に変更されたが、pane_envが適用される点は正しい。注記を追加すると読み手の混乱を防げる。

---

## Positive Observations (14件)

| # | 観察 | 詳細 |
|---|------|------|
| P-1 | TOCTOU排除パターンの一貫適用 | `GetSession` deep cloneで `HasSession` + `GetSession` 分離を回避 |
| P-2 | ロールバックパターンの堅牢性 | セッション作成後の各ステップで失敗時ロールバック実行。`RemoveSession` 内部で `Terminal.Close()` をイテレートしConPTYリーク等を確実防止 |
| P-3 | `AddWindow` の完全削除 | Go プロダクションコードから参照完全除去 |
| P-4 | イベントモデルの整合性 | `tmux:window-created` を `snapshotEventPolicies` から削除、テストで `want: false` 検証 |
| P-5 | `expandFormatSafe` による安全なフォーマット展開 | deep clone経由でTOCTOU-safe |
| P-6 | 親セッションからのフラグ継承 | `IsAgentTeam`, `UseClaudeEnv`, `UsePaneEnv` の3フラグをnil-safeにコピー |
| P-7 | `emitCtx` フォールバック設計 | snapshot取得失敗時、前回取得値にフォールバック。イベント欠損防止 |
| P-8 | `bestEffortSendKeys` のベストエフォート設計 | 失敗時もログ出力のみで処理続行 |
| P-9 | フロントエンドの完全クリーンアップ | `useWindowRename`、CSS、API import全てのダングリング参照解消 |
| P-10 | `SessionView.tsx` の適切な簡素化 | アクティブウィンドウのペインレイアウト表示に専念する明確な設計 |
| P-11 | Prefix+n / Prefix+p ナビゲーション維持 | ウィンドウナビゲーションキーバインドが引き続き動作 |
| P-12 | アクロバティックコード不在 | シンプルなGoイディオムで書かれ、可読性が高い |
| P-13 | Go標準機能の活用 | `max(devPanelMaxFileSize-int64(probeN), 0)` で冗長なif分岐を簡素化（Go 1.21） |
| P-14 | 安全なリソースロールバック | `RemoveSession` で複数ターミナルのFDリークを確実防止する堅牢設計 |

---

## 統合タスク整理・並列作業可否表

以下の表は、両レビューの全指摘事項を統合し、重複を排除した修正タスクの一覧です。

### 凡例
- **並列OK**: 他のタスクと独立して同時に修正可能
- **順次**: 他のタスクとの依存関係があり、順番に実施が必要
- **依存先**: 順次の場合の前提タスク

| # | タスク | ファイル | 重要度 | 指摘ID | 並列可否 | 依存先 | 作業内容 |
|---|--------|---------|--------|--------|---------|--------|---------|
| T-1 | shim `-n` バリデーション追加 | `cmd/tmux-shim/parse.go` | CRITICAL | C-1 | **並列OK** | — | `new-window` の `validateRequired` に `-n` チェック追加。または `-n` 省略時に自動連番フォールバック |
| T-2 | shimテスト更新 | `cmd/tmux-shim/main_test.go` | CRITICAL | C-1 | **順次** | T-1 | `-n` なし `new-window` ケースの期待エラー追加 |
| T-3 | shimセマンティクス変更コメント | `cmd/tmux-shim/spec.go` | CRITICAL | C-2 | **並列OK** | — | `new-window` = 子セッション作成であることをspec.goに追記 |
| T-4 | Backend Window API削除 | `app_window_api.go`, `app_window_api_test.go` | CRITICAL | C-3, I-6 | **並列OK** | — | `RemoveWindow`, `RenameWindow` メソッドおよびテスト完全削除 |
| T-5 | Wails バインディング再生成 | `App.d.ts`, `App.js` | CRITICAL | C-3 | **順次** | T-4 | `wails generate module` でバインディング再生成・クリーンアップ |
| T-6 | `pane-focused` emit + フォーカス移動 | `command_router_handlers_window.go` | IMPORTANT | I-1 | **並列OK** | — | `SetActivePane` 成功時に `tmux:pane-focused` emit。アプリレベルのアクティブセッション切替追加 |
| T-7 | `handleNewSession` rollback統一 | `command_router_handlers_session.go` | IMPORTANT | I-2 | **並列OK** | — | rollback関数で `rmErr` をラップするパターンに統一 |
| T-8 | `RemoveWindowByID` テスト補強 | `session_manager_window_test.go` | IMPORTANT | I-3 | **並列OK** | — | テストヘルパーで複数ウィンドウ状態構築しテスト追加。または不要ロジック簡素化 |
| T-9 | TOCTOU コメント追記 | `command_router_handlers_window.go` | IMPORTANT | I-4 | **順次** | T-6 | `CreateSession` がロック内で重複チェックすることをコメント明記 |
| T-10 | 到達不能イベントコード整理 | `command_router_handlers_window.go`, `app_events.go` | IMPORTANT | I-5 | **順次** | T-6 | `window-destroyed`/`window-renamed` emit分岐に到達不能コメント追加。`snapshotEventPolicies` 整理 |
| T-11 | ログレベル調整 | `command_router_handlers_window.go` | SUGGESTION | S-1 | **順次** | T-6 | `SetActivePane` 失敗を `slog.Warn` に変更 |
| T-12 | `activePaneInSession` ログ追加 | `command_router_handlers_window.go` | SUGGESTION | S-2 | **順次** | T-6 | デフォルトサイズフォールバック時のデバッグログ |
| T-13 | `resolveEnvForPaneCreation` docstring | `command_router.go` | SUGGESTION | S-3 | **並列OK** | — | nil引数の挙動をdocstringに記載 |
| T-14 | index版 `RemoveWindow` 削除 | `session_manager_windows.go` | SUGGESTION | S-4 | **並列OK** | — | デッドコード削除 |
| T-15 | index版 `RenameWindow` 削除 | `session_manager_windows.go` | SUGGESTION | S-5 | **順次** | T-14 | 同ファイル内の連続デッドコード削除 |
| T-16 | `WindowIndexInSession` 削除 | `session_manager_windows.go` | SUGGESTION | S-6 | **順次** | T-14, T-15 | 同ファイル内連続、テスト側も修正必要 |
| T-17 | `removeWindowResult` 簡素化 | `session_manager_windows.go` | SUGGESTION | S-7 | **順次** | T-14, T-15, T-16 | `SurvivingWindowID` 常に -1 のため型簡素化 |
| T-18 | Prefix+c コメント改善 | `usePrefixKeyMode.ts` | SUGGESTION | S-8 | **並列OK** | — | 補足コメント追加 |
| T-19 | `branchErr` ログ追加 | `app_devpanel_api.go` | SUGGESTION | S-9 | **並列OK** | — | `slog.Debug` 追加 |
| T-20 | pane_env コメント補足 | `command_router_handlers_session.go` | SUGGESTION | S-10 | **順次** | T-7 | 同ファイル修正時にまとめて対応 |

---

### 推奨作業順序

```
Phase 1 (並列一括実施可能):
  T-1  shim -n バリデーション追加
  T-3  shimセマンティクス変更コメント
  T-4  Backend Window API削除
  T-6  pane-focused emit + フォーカス移動
  T-7  handleNewSession rollback統一
  T-8  RemoveWindowByID テスト補強
  T-13 resolveEnvForPaneCreation docstring
  T-14 index版 RemoveWindow 削除
  T-18 Prefix+c コメント改善
  T-19 branchErr ログ追加

Phase 2 (Phase 1 依存):
  T-2  shimテスト更新（T-1完了後）
  T-5  Wails バインディング再生成（T-4完了後）
  T-9  TOCTOU コメント追記（T-6完了後）
  T-10 到達不能イベントコード整理（T-6完了後）
  T-15 index版 RenameWindow 削除（T-14完了後）
  T-20 pane_env コメント補足（T-7完了後）

Phase 3 (Phase 2 依存):
  T-11 ログレベル調整（T-6完了後）
  T-16 WindowIndexInSession 削除（T-15完了後）

Phase 4:
  T-12 activePaneInSession ログ追加（T-11完了後）
  T-17 removeWindowResult 簡素化（T-16完了後）
```

---

### 作業グループ別並列可能性マトリクス

| グループ | 担当タスク | 対象ファイル | グループ内作業順 | 他グループとの競合 |
|---------|-----------|-------------|----------------|------------------|
| **shimグループ** | T-1, T-2, T-3 | `parse.go`, `main_test.go`, `spec.go` | T-1→T-2 (順次), T-3 (独立) | なし |
| **Backend API クリーンアップ** | T-4, T-5 | `app_window_api.go`, `app_window_api_test.go`, `App.d.ts`, `App.js` | T-4→T-5 (順次) | なし |
| **windowハンドラグループ** | T-6, T-9, T-10, T-11, T-12 | `command_router_handlers_window.go`, `app_events.go` | T-6→T-9→T-10→T-11→T-12 (順次) | T-10がapp_events.goに触れる |
| **sessionハンドラグループ** | T-7, T-20 | `command_router_handlers_session.go` | T-7→T-20 (順次) | なし |
| **session_managerグループ** | T-8, T-14, T-15, T-16, T-17 | `session_manager_windows.go`, `*_test.go` | T-14→T-15→T-16→T-17 (順次), T-8 (独立) | なし |
| **独立グループ** | T-13, T-18, T-19 | `command_router.go`, `usePrefixKeyMode.ts`, `app_devpanel_api.go` | 全て並列OK | なし |

---

### 作業者向けの進行のコツ

最も効率的な分担は以下の **4エージェント並列体制**:

| エージェント | 担当グループ | Phase 1 タスク |
|-------------|-------------|---------------|
| **Agent A** | shimグループ + 独立フロントエンド | T-1, T-3, T-18 |
| **Agent B** | Backend APIクリーンアップ + 独立バックエンド | T-4, T-13, T-19 |
| **Agent C** | windowハンドラ + イベント | T-6 |
| **Agent D** | sessionハンドラ + session_manager | T-7, T-8, T-14 |

Phase 1 完了後、各エージェントが担当グループ内の依存タスクを順次処理することで、ファイル競合なく安全に並列作業が進められます。

---

## Recommended Action

1. **CRITICAL 3件の方針判断**: C-1 (shimバリデーション or フォールバック)、C-2 (セマンティクス変更承認)、C-3 (API削除実行)
2. **Phase 1 の並列修正**: 4エージェント体制でCRITICAL/IMPORTANT修正を並列実施
3. **Phase 2-4**: 順次対応
4. **実施後**: テスト実行（`go test ./...`）で回帰確認
