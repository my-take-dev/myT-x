# プレコミット コードレビューレポート

本レビューは `review-pr-para.prompt.md` のガイドラインに準拠し、未コミットの変更差分（HEADからのdiffおよび新規追加ファイル）に対する網羅的かつ深掘りしたレビュー結果をまとめたものです。類似処理の指摘漏れを防ぐため、カテゴリごとに一括で修正・管理できる構造としています。

---

## 1. カテゴリ別の包括的レビュー結果

### 1-1. Core / ロギング基盤 (Session Log)
**対象ファイル:** `app_lifecycle.go`, `app.go`, `app_session_log.go`, `internal/sessionlog/*`

- **【Important】 TeeHandler のグローバル適用による副作用の懸念**
  - `app_lifecycle.go` にて `slog.SetDefault(slog.New(teeHandler))` を適用していますが、グローバルなロガーをフックすることで、全コンポーネント（連携する外部パッケージ含む）のログが TeeHandler を経由します。予期せぬロック競合やオーバヘッドが生じていないか、または特定モジュールからの大量の Warn/Error が想定以上のメモリ圧迫（`sessionLogEntries` の頻繁な更新）を引き起こさないか留意してください。
- **【Important】 直近エラー欠損のリスク (fsync漏れ)**
  - `app_session_log.go` の `writeSessionLogEntry` にてファイルに対して `Write` を行っていますが、明示的なフラッシュ (`f.Sync()`) が実装されていません。パニックや不慮のクラッシュ発生時、直近の重要なエラーログほどOSバッファ上に残りディスクへ書き込まれないリスクがあります。エラーレベルに応じた Sync() の呼び出しや、定期的なバッファフラッシュの実装を強く推奨します。
- **【Suggestion】 ロングラン稼働時のログローテーションの考慮**
  - 現在、ファイルのクリーンアップ (`cleanupOldSessionLogs`) を起動時および生成時に行っていると考えられますが、アプリが長時間稼働し続けた際にディレクトリ内のファイル肥大化（最大数・容量）に対して適切にアプローチできているかの確認を推奨します。

### 1-2. Tmux / ライフサイクル & イベント管理
**対象ファイル:** `app_events.go`, `app_window_api.go` (完全削除), `internal/tmux/*`

- **【Critical】 ウィンドウ操作APIの削除とSide Effects (他モジュールへの影響)**
  - 「1セッション = 1ウィンドウ」の仕様変更に基づき `app_window_api.go` とテストがごっそりと削除されています。Go側のWailsバインディングからメソッドが消えたことで、Frontendの既存コード呼び出し(`RenameWindow`, `AddWindow` など)がデッドリンクになりパニックや沈黙の失敗(Silent Failure)を引き起こす危険性があります。フロントエンドの全APIコール箇所で完全に削除または移行が済んでいるか、整合性をチェックしてください。
- **【Important】 残存するウィンドウイベントに対する類似処理のクリーンアップ漏れ**
  - `app_events.go` の注釈には `tmux:window-destroyed` などのトリガーを拡張（マルチウィンドウモデルへの布石）に備えて残すと書かれていますが、これを受け取るハンドラ (`command_router_handlers_window.go`) や `Snapshot` にウィンドウ依存のステートが中途半端に残っていないか確認してください。類似の概念混在はバグの温床になります。

### 1-3. Frontend / UI サブシステム
**対象ファイル:** `Frontend` 関連ファイル (`SessionView.tsx`, `ErrorLogView.tsx`, `useErrorLog.ts`, etc.)

- **【Critical】 UI状態の不整合 (レースコンディションとマウント前イベントの取りこぼし)**
  - 新設された ErrorLogView およびストア (`store/errorLogStore.ts`, `useErrorLog.ts`) において、コンポーネントのマウント後に Wails のイベント (`app:error-logged`) サブスクライブを開始するだけだと、アプリ起動当初〜UIマウント完了前に発生した致命的エラーの表示漏れが発生します。
  - **対策案**: 初期化マウント直後に `GetSessionErrorLog()` API を呼び出し、Backend側の `a.sessionLogEntries` の状態（初期フェッチ）と同期させたうえで、後続のイベントを Listen するガードレール処理を実装して、沈黙の失敗（表示漏れ）を防いでください。

### 1-4. ツール設定・その他
**対象ファイル:** `.claude/settings.local.json`, `api.ts`, `prompts/review.md`

- **【Suggestion】** `.claude/settings.local.json` において `Bash(test:*)` が許可リスト化されましたが、無限ループや環境依存エラーによるフリーズ対応のため、コンテキストタイムアウトや強制終了の仕組みが担保されているか改めて確認してください。

---

## 2. タスク整理と並列作業計画

ファイル群の依存関係から、以下の通りのカテゴリに分割し、複数のサブエージェントが効率的に並列レビュー＆修正を行えるように整理しました。表の通り、基本的には並列作業が可能ですが、最後に自動生成（Wails）を挟む直列作業が存在します。作業者視点でわかりやすく示します。

| タスクID | 作業対象カテゴリと詳細 | 対象ファイル群 | 並列作業の可否 | 注意点・依存関係 |
|:---:|:---|:---|:---:|:---|
| **TASK-1** | **【Core Backend】ロギング基盤の堅牢化**<br>・`TeeHandler`のパフォーマンス検証<br>・`f.Sync()`の導入・クラッシュ耐性の強化 | `app.go`<br>`app_session_log.go`<br>`app_lifecycle.go` | **⭕️ 可能** | アプリ全体の基盤となるため、他と並行して早期に着手する。ファイルIOの競合に注意。 |
| **TASK-2** | **【Rm API & Tmux】不要コードの消込**<br>・ウィンドウ操作系コードの残存確認とクリーンアップ<br>・イベントルーティング周りの一貫性確認 | `app_events.go`<br>`internal/tmux/*`<br>`app_pane_api_test.go` | **⭕️ 可能** | TASK-1と完全に独立して作業可能。ロジックの縮小がメイン。 |
| **TASK-3** | **【Frontend】UIと状態同期の修正**<br>・`GetSessionErrorLog`を活用した初期フェッチ実装<br>・Wailsイベント購読漏れとRace Condition修正<br>・Wails JS API呼び出しのデッドリンク解消 | `useErrorLog.ts`<br>`errorLogStore.ts`<br>`SessionView.tsx`<br>`api.ts` | **🔺 条件付き可能** | フロントエンドの作業。TASK-2の「APIメソッドの削除」仕様の確定を前提とするため、定義を見ながら進めること。 |
| **TASK-4** | **【Integration】Wailsバインディングの再生成**<br>・バックエンドのIF変更をTSに反映<br>・コンパイルチェック | `frontend/wailsjs/*` | **❌ 不可 (直列)** | **TASK-1〜3 がすべて完了した後に、直列で最後に実行する。** `wails generate module` の実行とTSチェック。 |

### 今後のアクションプラン (推奨)
1. **Critical** に設定した問題（特に Frontend の表示漏れと、API削除に伴うデッドコード解決）を最優先で対応してください。
2. 上記の `TASK-1`〜`TASK-3` をサブエージェント（または開発チームメンバー）に割り当て、並行して作業を開始します。
3. すべての並列作業がリポジトリ上で統合作業に入ったのち、`TASK-4` を実行し、Wails の自動生成ファイルの一貫性を担保してコミット (Commit) してください。
