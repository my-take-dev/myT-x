# PR Review Summary — 2026-02-21 13:34:22

## レビュー概要

今回の変更は大きく **2つの機能変更** と **付随するリファクタリング** で構成される：

1. **1-Window モデルへの移行**: `new-window` コマンドのセマンティクスを「既存セッション内でウィンドウ追加」→「子セッション（child session）作成」に変更。マルチウィンドウ関連 API（`AddWindow`, `RemoveWindow`, `RenameWindow`, `useWindowRename`）を削除
2. **Session Error Log 機能追加**: バックエンド（Go）にセッションログ (`app_session_log.go`, `internal/sessionlog/handler.go`) を実装し、フロントエンド（React）に Error Log ビュー (`ErrorLogView.tsx`, `errorLogStore.ts`) を追加
3. **Go 1.26 モダン化**: `ptrBool(b) → new(b)` への `go fix` 適用、`max()` ビルトイン使用

---

## レビュー対象ファイル（5カテゴリ）

| カテゴリ | ファイル数 | 差分量 |
|---------|----------|-------|
| A: Session Log（Go backend + internal） | 5 | 42KB |
| B: App Core（app.go, lifecycle, events, window API 削除） | 10 | 27KB |
| C: Tmux Internal（command_router, session_manager） | 10 | 68KB |
| D: Tmux Shim（parse, spec, test） | 3 | 5KB |
| E: Frontend（React, CSS, Wails bindings） | 17 | 52KB |

---

## Critical Issues（0件）

重大な問題は検出されませんでした。

---

## Important Issues（7件）

### IMP-1: `writeSessionLogEntry` での全エントリイベント発行（パフォーマンス懸念）
- **ファイル**: `myT-x/app_session_log.go:127`
- **カテゴリ**: A（Session Log）
- **内容**: `writeSessionLogEntry` は毎回 `a.emitRuntimeEvent("app:error-logged", entry)` を呼び出す。高頻度の warn/error が発生した場合、Wails IPC 経由のイベント発行がボトルネックになる可能性がある。
- **提案**: debounce またはバッチ送信の検討。もしくは `emitRuntimeEvent` 前に unread count が一定以上になったらスロットリングする仕組みの導入。

### IMP-2: `errorLogStore` の `addEntry` でスプレッド演算子による配列再生成
- **ファイル**: `myT-x/frontend/src/stores/errorLogStore.ts:13-17`
- **カテゴリ**: E（Frontend）
- **内容**: `addEntry` で `entries: [...state.entries, entry]` としているため、エントリ数が増加すると O(n) メモリコピーが毎回発生する。Go 側の `sessionLogMaxEntries = 10000` を考慮すると、フロントエンドでもエントリ数に上限を設けるべき。
- **提案**: フロントエンド側にも最大エントリ数制限を追加（例: `const MAX_ENTRIES = 10000; entries: [...state.entries, entry].slice(-MAX_ENTRIES)`）。

### IMP-3: `setEntries` が `unreadCount` をリセットしない
- **ファイル**: `myT-x/frontend/src/stores/errorLogStore.ts:18-19`
- **カテゴリ**: E（Frontend）
- **内容**: `setEntries` でバックエンドから初期ロード時に `unreadCount` がリセットされない。初期ロードした全エントリが暗黙的に「既読」として扱われるため、ユーザーがビューを開いた際にバッジが未読0件となる想定と一致するか要確認。ただし `useErrorLog.ts:674` でマウント時に `setEntries` → 直後に `markAllRead()` が呼ばれるため、ErrorLogView を開いた場合は問題ない。**ErrorLogView を開かずにバックエンドイベントが先に到着した場合**、`setEntries` で上書きされた際に `unreadCount` が加算済みの値のまま残る可能性がある。
- **提案**: `setEntries` でも `unreadCount` を適切にリセットするか、初期ロードかリアルタイム追加かを区別するロジックを追加。

### IMP-4: `handleNewSession` のロールバック関数で `return` 抜け修正の影響範囲
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_session.go:30`
- **カテゴリ**: C（Tmux Internal）
- **内容**: rollback 失敗時に `return errResp(...)` を追加している。これは正しい修正だが、**既存の `handleNewSession` での全ての `rollbackSession(...)` 呼び出し箇所**で、ロールバック失敗時の戻り値を使用側で正しくハンドリングしていることを確認する必要がある。追加された行の下に `return errResp(originalErr)` が残っているため、ロールバック成功時は次の行で正しく `return` される。
- **影響度**: 既存動作への回帰リスクは低いが、テストでロールバック失敗パスを検証すべき。

### IMP-5: `handleNewWindow` の TOCTOU 事前チェック（行187-189）
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go:187-189` (差分行番号)
- **カテゴリ**: C（Tmux Internal）
- **内容**: `GetSession(newSessionName)` で存在チェックし、その後 `CreateSession` するが、コメントに TOCTOU の認識が記載されている。`CreateSession` 内部で重複チェックが行われるため現時点で問題ないが、明示的なテストケースの追加が望ましい。テスト `"duplicate session name returns error"` は追加済み。
- **提案**: 問題なし（情報共有目的）。

### IMP-6: `app_session_log_test.go` のテストヘルパー `formatIndexAsTimestamp` で月跨ぎ不正確
- **ファイル**: `myT-x/app_session_log_test.go:946-954`
- **カテゴリ**: A（Session Log）
- **内容**: `formatIndexAsTimestamp` ヘルパーは簡易的な月跨ぎ計算を行っており、31+28 = 59 を超えるインデックスでは不正な日付を生成する可能性がある。テストでは最大 `sessionLogMaxEntries + 100 = 10100` エントリを生成するため、110日分以上の秒数をカバーする必要があるが、この関数は最大2ヶ月分しか正しく生成しない。
- **提案**: テストでは各ファイルのタイムスタンプによるソート順が重要なため、ファイル名のソート順が保証される形式（例: 連番ゼロ埋め）でのファイル名生成に変更を推奨。なお `TestWriteSessionLogEntry_CapsInMemory` では `writeSessionLogEntry` へのメッセージにタイムスタンプを使わないため、このヘルパーの不正確さは `TestCleanupOldSessionLogs_*` のみに影響する。cleanupテストは 110 ファイル（= 110秒）しか作らないため、実際には問題なし。

### IMP-7: コメント文字化け
- **ファイル**: `myT-x/cmd/tmux-shim/spec.go:120` (差分行番号), `myT-x/app_session_log.go:118`
- **カテゴリ**: D（Shim）, A（Session Log）
- **内容**: `spec.go` の `new-window` コメント（行120-123）が文字化けしている（`繧ｻ繝槭Φ繝・ぅ繧ｯ繧ｹ` 等）。同様に `app_session_log.go:118` でも `竊・` のような文字化けが見られる。これは UTF-8 BOM なし規約の下で Shift_JIS エンコードされた可能性がある。
- **提案**: CLAUDE.md の「全て UTF8 で BOM 無し」規約に従い、正しい UTF-8 日本語コメントに修正すべき。

---

## Suggestions（12件）

### SUG-1: `GetSessionLogFilePath` のスレッドセーフティ
- **ファイル**: `myT-x/app_session_log.go:163-165`
- **カテゴリ**: A（Session Log）
- **内容**: `GetSessionLogFilePath()` は `sessionLogPath` を直接読むが、`sessionLogMu` で保護されていない。`sessionLogPath` は `initSessionLog()` でのみ書き込まれ、以降変更されないため実質的に安全だが、一貫性のために mutex で保護することを推奨。
- **重要度**: 低（実用上問題なし）

### SUG-2: `cleanupOldSessionLogs` でファイル削除のエラーログを `continue` で継続
- **ファイル**: `myT-x/app_session_log.go:79-81`
- **カテゴリ**: A（Session Log）
- **内容**: 適切に `continue` で継続しており防御的。コメントが英語で書かれているが問題なし。

### SUG-3: テストヘルパー関数 `ensureSequentialFiles` / `copyFile` / `readJSONLFile` が未使用
- **ファイル**: `myT-x/app_session_log_test.go:965-1029`
- **カテゴリ**: A（Session Log）
- **内容**: テストファイル末尾に3つのヘルパー関数 (`ensureSequentialFiles`, `copyFile`, `readJSONLFile`) が定義されているが、現在のテストコードで使用されていない。将来のテスト追加を見越した定義と思われるが、現時点では `unused function` として Go vet / linter で警告が出る可能性がある。
- **提案**: 未使用関数は削除するか、使用するテストを追加する。

### SUG-4: `useErrorLog.ts` の `isMountedRef` パターン
- **ファイル**: `myT-x/frontend/src/components/viewer/views/error-log/useErrorLog.ts:66-85`
- **カテゴリ**: E（Frontend）
- **内容**: `isMountedRef` で非同期コールバックのマウント後チェックを実装しており適切。React 18 の StrictMode で二重マウントされる場合のケアもされている。

### SUG-5: `ErrorLogView.tsx` の copy-on-select と Ctrl+C 二重処理
- **ファイル**: `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx`
- **カテゴリ**: E（Frontend）
- **内容**: copy-on-select（selectionchange イベント）と Ctrl+C（keydown イベント）の両方でクリップボード書き込みを行っている。copy-on-select が有効な場合、Ctrl+C は冗長になる可能性があるが、ユーザー操作の確実性のために両方実装するのは合理的。

### SUG-6: `viewer-strip-badge` の CSS `position: absolute` 親要素確認
- **ファイル**: `myT-x/frontend/src/styles/viewer.css:1141-1151`
- **カテゴリ**: E（Frontend）
- **内容**: `.viewer-strip-badge` に `position: absolute` が指定されているが、親の `button.viewer-strip-btn` に `position: relative` が設定されていることを確認する必要がある。既存の `viewer.css` 内で `.viewer-strip-btn` に `position: relative` が既に設定されていれば問題なし。
- **提案**: 既存 CSS で `position: relative` の設定を確認。

### SUG-7: `app_window_api.go` / `app_window_api_test.go` の空ファイル
- **ファイル**: `myT-x/app_window_api.go`, `myT-x/app_window_api_test.go`
- **カテゴリ**: B（App Core）
- **内容**: 両ファイルは `package main` のみの空ファイルになっている。ファイル自体を削除するか、残すならコメントで理由を記載すべき。
- **提案**: 空ファイルの削除を推奨。1行のみの `package main` はビルドに影響しないが、開発者に混乱を与える可能性がある。現在 `stableWindowTarget` や `routerCommandError` も削除されているが、これらの利用箇所が他にないか確認が必要。

### SUG-8: `ptrBool` の `go:fix inline` ディレクティブ重複
- **ファイル**: `myT-x/app_session_api_test.go:1879-1880`
- **カテゴリ**: B（App Core）
- **内容**: `ptrBool` 関数に `//go:fix inline` が2行連続で記載されている。1行で十分。
- **提案**: 重複の `//go:fix inline` を削除。

### SUG-9: `app_events.go` の `tmux:window-created` ポリシー削除の影響
- **ファイル**: `myT-x/app_events.go:140-149`
- **カテゴリ**: B（App Core）
- **内容**: `snapshotEventPolicies` マップから `tmux:window-created` が削除されている。`handleNewWindow` は `tmux:session-created` を emit するようになったため、`snapshotEventPolicies` に `tmux:session-created` が既に含まれていることを確認。
- **提案**: `tmux:session-created` は L135 の `"tmux:session-created": {trigger: true, bypassDebounce: true}` で既に定義済みであることを確認。→ 確認不能（差分外）。念のためソース確認推奨。

### SUG-10: `TestApplyLayoutPresetTargetsActiveWindow` の削除
- **ファイル**: `myT-x/app_pane_api_test.go:173-221`（削除部分）
- **カテゴリ**: B（App Core）
- **内容**: マルチウィンドウを前提としたテストを削除。`ApplyLayoutPreset` 自体はまだ残っているため、1ウィンドウモデルでの動作テストが必要。
- **提案**: 1セッション1ウィンドウモデルでの `ApplyLayoutPreset` テストを追加。

### SUG-11: `handleNewWindow` でのフラグ継承順序
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go:236-254` (差分行番号)
- **カテゴリ**: C（Tmux Internal）
- **内容**: `IsAgentTeam`, `UseClaudeEnv`, `UsePaneEnv` の3フラグを親セッションから個別にコピーしている。将来フラグが追加された場合にコピー漏れが発生するリスクがある。
- **提案**: `copySessionFlags(parentSession, newSessionName)` のようなヘルパーを作成し、フィールド追加時の変更伝播リスクを低減させる。structフィールド追加時は CLAUDE.md チェックリスト（L136-137）に従って全参照箇所を確認すること。

### SUG-12: `usePrefixKeyMode` の Prefix+c 無効化
- **ファイル**: `myT-x/frontend/src/hooks/usePrefixKeyMode.ts:120-128`
- **カテゴリ**: E（Frontend）
- **内容**: Prefix+c のハンドラ内で `api.AddWindow` 呼び出しが削除され、空の `return` のみになっている。ユーザーへのフィードバックがないためキー入力が「飲み込まれる」状態になる。
- **提案**: コメントに記載の通り NewSessionModal からの操作に誘導するか、Prefix+c 自体のキーバインドを削除してフォールスルーさせるか検討。現在はコメントで説明されているため許容範囲。

---

## Strengths（良い点）

1. **堅牢なロールバック設計**: `handleNewWindow` のセッション作成ロールバック処理が `handleNewSession` と統一されたパターンで実装されており、一貫性が高い
2. **デッドロック回避の考慮**: `writeSessionLogEntry` で `sessionLogMu` をロック中に `slog.Warn/Error` を呼ばない設計。TeeHandler → slog → writeSessionLogEntry の再帰的デッドロックを明確に設計段階で回避している
3. **テストの充実**: 新規 Session Log 機能に対して境界条件（空、上限、独立コピー）を網羅するテーブル駆動テストが実装済み
4. **マルチウィンドウ関連コード削除の徹底**: API, テスト, CSS, フック, Wails バインディングまで一貫して削除されており、デッドコードを残していない
5. **防御的プログラミング**: `GetSessionErrorLog` が nil ではなく空スライスを返す設計、`writeSessionLogEntry` がファイル未初期化でもメモリには書き込む設計
6. **`go fix` によるモダン化**: `ptrBool → new(bool)`, `max()` ビルトインの使用

---

## Recommended Action

1. **IMP-7（文字化けコメント）を優先修正** — コード品質に直接影響
2. **IMP-2, IMP-3（Frontend ストアの制限と未読カウント）を修正** — ユーザー体験に影響
3. **SUG-3（未使用テストヘルパー）, SUG-7（空ファイル）, SUG-8（重複ディレクティブ）を整理** — コード衛生
4. **SUG-9（`tmux:session-created` ポリシー確認）** を確認
5. 残りの Suggestion は次回以降のリファクタリング時に対応

---

## 並列作業可否テーブル

以下の表は、各修正タスクを**並列で同時に作業できるか**を整理したものです。「並列OK」のタスク群は互いに依存がないため同時に着手できます。

| No. | タスクID | 対象ファイル | タスク内容 | 重要度 | 並列OK | 依存先 | 備考 |
|-----|---------|-------------|----------|--------|--------|--------|------|
| 1 | IMP-1 | `app_session_log.go` | イベント発行のスロットリング検討 | Important | ✅ | なし | 他ファイルに影響なし |
| 2 | IMP-2 | `errorLogStore.ts` | エントリ数上限追加 | Important | ✅ | なし | フロントエンドのみ |
| 3 | IMP-3 | `errorLogStore.ts` | `setEntries` で unreadCount リセット | Important | ⚠️ | IMP-2 | IMP-2 と同ファイルのため**直列推奨** |
| 4 | IMP-4 | `command_router_handlers_session.go` | ロールバック失敗テスト追加 | Important | ✅ | なし | テスト追加のみ |
| 5 | IMP-5 | （確認のみ） | TOCTOU 事前チェック確認 | Important | — | — | 情報共有のみ、対応不要 |
| 6 | IMP-6 | `app_session_log_test.go` | `formatIndexAsTimestamp` 改善 | Important | ✅ | なし | テストヘルパーのみ |
| 7 | IMP-7 | `spec.go`, `app_session_log.go` | 文字化けコメント修正 | Important | ✅ | なし | コメントのみの修正 |
| 8 | SUG-1 | `app_session_log.go` | `GetSessionLogFilePath` mutex 保護 | Suggestion | ⚠️ | IMP-1 | IMP-1 と同ファイルのため**直列推奨** |
| 9 | SUG-3 | `app_session_log_test.go` | 未使用ヘルパー関数削除 | Suggestion | ⚠️ | IMP-6 | IMP-6 と同ファイルのため**直列推奨** |
| 10 | SUG-6 | `viewer.css` | `position: relative` 確認 | Suggestion | ✅ | なし | CSS のみ |
| 11 | SUG-7 | `app_window_api.go`, `app_window_api_test.go` | 空ファイル削除 | Suggestion | ✅ | なし | 単独で実施可能 |
| 12 | SUG-8 | `app_session_api_test.go` | `go:fix inline` 重複削除 | Suggestion | ✅ | なし | テストファイルのみ |
| 13 | SUG-9 | `app_events.go` | `tmux:session-created` ポリシー確認 | Suggestion | ✅ | なし | ソース確認のみ |
| 14 | SUG-10 | `app_pane_api_test.go` | 1ウィンドウモデル用テスト追加 | Suggestion | ✅ | なし | テスト追加のみ |
| 15 | SUG-11 | `command_router_handlers_window.go` | フラグ継承ヘルパー作成 | Suggestion | ✅ | なし | リファクタリング |
| 16 | SUG-12 | `usePrefixKeyMode.ts` | Prefix+c のUX改善 | Suggestion | ✅ | なし | フロントエンドのみ |

### 並列作業グループ

以下のグループは**互いに独立**しているため、同時に作業可能です：

| グループ | タスク群 | 対象領域 |
|---------|---------|---------|
| **G1** | IMP-1, SUG-1 | Go: `app_session_log.go`（直列で実施） |
| **G2** | IMP-2, IMP-3 | Frontend: `errorLogStore.ts`（直列で実施） |
| **G3** | IMP-4 | Go: `command_router_handlers_session.go` |
| **G4** | IMP-6, SUG-3 | Go: `app_session_log_test.go`（直列で実施） |
| **G5** | IMP-7 | Go: `spec.go`, `app_session_log.go` コメント修正 |
| **G6** | SUG-7 | Go: 空ファイル削除 |
| **G7** | SUG-8 | Go: `app_session_api_test.go` |
| **G8** | SUG-9, SUG-10 | Go: `app_events.go`, `app_pane_api_test.go`（確認 + テスト追加） |
| **G9** | SUG-11 | Go: `command_router_handlers_window.go` |
| **G10** | SUG-12 | Frontend: `usePrefixKeyMode.ts` |
| **G11** | SUG-6 | Frontend: `viewer.css` |

> **G1〜G11 の全グループは互いに並列実行可能**です。各グループ内のタスクのみ直列で実施してください。
