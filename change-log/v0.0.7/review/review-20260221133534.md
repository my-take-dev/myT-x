# PR Review Summary — 2026-02-21 13:35:34

## レビュー対象

`git diff` による未コミット変更ファイル（myT-x配下）。全43ファイル、+6,072 / -2,154 行。

### カテゴリ別ファイル一覧

| カテゴリ | ファイル |
|----------|--------|
| **App バックエンド** | `app.go`, `app_devpanel_api.go`, `app_events.go`, `app_lifecycle.go`, `app_session_log.go`, `app_session_log_types.go`, `app_window_api.go` |
| **App テスト** | `app_events_test.go`, `app_lifecycle_test.go`, `app_pane_api_test.go`, `app_session_api_test.go`, `app_session_log_test.go`, `app_window_api_test.go` |
| **tmux内部パッケージ** | `internal/tmux/command_router.go`, `command_router_handlers_session.go`, `command_router_handlers_window.go`, `session_manager_windows.go` |
| **tmuxテスト** | `command_router_env_test.go`, `command_router_handlers_window_test.go`, `session_manager_directional_test.go`, `session_manager_pane_io_test.go`, `session_manager_test.go`, `session_manager_window_test.go` |
| **tmux-shim** | `cmd/tmux-shim/parse.go`, `cmd/tmux-shim/spec.go`, `cmd/tmux-shim/main_test.go` |
| **sessionlog** | `internal/sessionlog/handler_test.go` |
| **フロントエンド** | `frontend/src/api.ts`, `SessionView.tsx`, `ActivityStrip.tsx`, `ViewerSystem.tsx`, `ErrorLogView.tsx`, `useBackendSync.ts`, `usePrefixKeyMode.ts`, `useWindowRename.ts`(削除), `layout.css`, `viewer.css` |
| **Wails生成** | `App.d.ts`, `App.js`, `models.ts` |

---

## レビュー実施体制

6つの専門レビューエージェントを並列実行:
1. **code-reviewer** — App バックエンド全般
2. **test-analyzer** — テストカバレッジ・品質
3. **silent-failure-hunter** — エラーハンドリング・サイレント障害
4. **comment-analyzer** — コメント品質・正確性
5. **tmux-reviewer** — tmux内部パッケージ + shim
6. **code-simplifier** — コード簡素化・不要な複雑性

---

## Critical Issues（0件）

なし。

---

## Important Issues（12件）

### I-01 [code-reviewer] `app.go` — import文の順序違反
- **ファイル**: [app.go#L10](myT-x/app.go#L10)
- **内容**: `"os"` が標準ライブラリブロックの後に単独ブロックとして配置されている。Go の慣例（goimports）では標準ライブラリは1つのブロックにまとめるべき。
- **修正**: `"os"` を `"sync/atomic"` と `"time"` の間に移動する。

### I-02 [code-reviewer] 空ファイルの残存
- **ファイル**: [app_window_api.go](myT-x/app_window_api.go), [app_window_api_test.go](myT-x/app_window_api_test.go)
- **内容**: 両ファイルとも `package main` のみ。関数がすべて `SessionManager` に移行済みで、呼び出し元も0件。開発フェーズで後方互換不要のため、削除すべき。

### I-03 [test-analyzer] `ApplyLayoutPreset` の正常系テストが削除されカバレッジ欠落
- **ファイル**: [app_pane_api_test.go](myT-x/app_pane_api_test.go) (削除箇所)
- **内容**: `TestApplyLayoutPresetTargetsActiveWindow` が丸ごと削除されたが、`ApplyLayoutPreset` 関数自体は [app_pane_api.go](myT-x/app_pane_api.go) に健在。1-windowモデル用の正常系成功パス（レイアウト変更が実際に適用されること）のテストが欠落。
- **修正**: 1-windowモデル向けの `ApplyLayoutPreset` 正常系テストを追加する。

### I-04 [test-analyzer] `TestHandleNewWindow` のテスト名文字列マッチ依存
- **ファイル**: [command_router_handlers_window_test.go](myT-x/internal/tmux/command_router_handlers_window_test.go)
- **内容**: `if tt.name == "inherits IsAgentTeam from parent"` のようにテスト名の文字列マッチで検証分岐している。テスト名をリネームすると検証がサイレントにスキップされるアンチパターン。
- **修正**: テスト構造体に `wantAgentTeam bool` 等のフィールドを追加し、テスト名に依存しない形に改善する。

### I-05 [test-analyzer] テストヘルパー関数が未使用（デッドコード）
- **ファイル**: [app_session_log_test.go#L794-L858](myT-x/app_session_log_test.go#L794)
- **内容**: `ensureSequentialFiles`, `copyFile`, `readJSONLFile` の3関数が定義されているがテストコードからは呼ばれていない。
- **修正**: 不要なら削除するか、テスト内で使用する。

### I-06 [test-analyzer] `RenameWindowByID` のユニットテストが不足
- **ファイル**: [session_manager_windows.go](myT-x/internal/tmux/session_manager_windows.go)
- **内容**: `RenameWindowByID` が存在するが、旧テスト削除後に `SessionManager` レベルのユニットテストが見当たらない。`TestHandleRenameWindow` はルーターハンドラ経由のインテグレーションテストのみ。
- **修正**: `SessionManager.RenameWindowByID` の直接ユニットテストを追加する。

### I-07 [test-analyzer] `readJSONLFile` ヘルパーが最終行を破棄する可能性
- **ファイル**: [app_session_log_test.go#L838-L858](myT-x/app_session_log_test.go#L838)
- **内容**: `bytes.Buffer.ReadString('\n')` は `io.EOF` と共に最終行データを返す場合があるが、`err == io.EOF` で即 `break` するため、改行なしの最終行を破棄する。現時点では未使用関数のため実害なし。
- **修正**: `bufio.Scanner` を使用するか、EOF時にも `line != ""` なら処理する。

### I-08 [test-analyzer] `//go:fix inline` ディレクティブの重複
- **ファイル**: [app_session_api_test.go](myT-x/app_session_api_test.go)
- **内容**: `ptrBool` 関数に `//go:fix inline` が2行重複して記載されている。

### I-09 [frontend-reviewer] Error Log 初期フェッチとイベント購読の競合
- **ファイル**: [useBackendSync.ts](myT-x/frontend/src/hooks/useBackendSync.ts), ErrorLogView の useErrorLog
- **内容**: `useBackendSync` が `addEntry` でイベントを蓄積する一方、ErrorLogビュー初回表示時に `setEntries` で初期データを上書きする。初期フェッチ中にイベント到着 → `setEntries` で前回追加分が消失するレースが存在する。
- **修正**: 初期フェッチを `useBackendSync` に一本化するか、`setEntries` をマージロジック（重複排除付き）に変更する。

### I-10 [frontend-reviewer] `setEntries` が `unreadCount` をリセットしない
- **ファイル**: [errorLogStore.ts](myT-x/frontend/src/stores/errorLogStore.ts#L27)
- **内容**: `setEntries` は `unreadCount` を更新しない。初期ロード後に `addEntry` で加算された `unreadCount` がそのまま残り、ActivityStrip のバッジ表示が不正確になる。
- **修正**: `setEntries` 時に `unreadCount: 0` を同時にセットするか、エントリ数から再計算する。

### I-11 [frontend-reviewer] Error Log エントリに上限がない（メモリリーク）
- **ファイル**: [errorLogStore.ts](myT-x/frontend/src/stores/errorLogStore.ts#L21-L25)
- **内容**: 長時間稼働セッションでエラーが多発した場合、`entries` 配列が際限なく増大する。スプレッド構文が毎回全配列コピーを生成するためパフォーマンスにも影響。
- **修正**: 上限値（例: 1000件）を設けて先頭エントリを切り捨てる。バックエンドの `sessionLogMaxEntries` と合わせる。

### I-12 [code-simplifier] `validateRequired` の `-t` バリデーション重複
- **ファイル**: [parse.go](myT-x/cmd/tmux-shim/parse.go#L105-L117)
- **内容**: `new-window` ケースの `validateTargetFlag` 呼び出しは直前のケース群と完全に重複。統合して `-n` の追加チェックだけ分離すべき。
- **修正例**:
```go
case "has-session", "kill-session", "attach-session", "select-window", "kill-window", "new-window":
    if err := validateTargetFlag(command, req.Flags); err != nil {
        return err
    }
    if command == "new-window" {
        if strings.TrimSpace(asString(req.Flags["-n"])) == "" {
            return fmt.Errorf("%s requires -n", command)
        }
    }
```

---

## Suggestions（16件）

### S-01 [code-reviewer] `initSessionLog` 内でのロック不足
- **ファイル**: [app_session_log.go](myT-x/app_session_log.go)
- **内容**: `initSessionLog()` は `startup()` の単一ゴルーチン内でのみ呼ばれるためロック不要だが、防御的には `sessionLogMu` で保護するのが望ましい。

### S-02 [comment-analyzer] `app.go` のコメントが不正確
- **ファイル**: [app.go#L85](myT-x/app.go#L85)
- **内容**: `// Session error log state.` だが実装は Warn レベルも含む。`// Session log state (captures Warn/Error level records).` が適切。

### S-03 [comment-analyzer] `handleNewWindow` のGodocステップ数不一致
- **ファイル**: [command_router_handlers_window.go](myT-x/internal/tmux/command_router_handlers_window.go)
- **内容**: Godocは9ステップだが、実コード内は13ステップ。ステップ変更のたびにGodocも更新が必要でコメント腐敗リスクが高い。主要フェーズに抽象化することを検討。

### S-04 [comment-analyzer] `[DEBUG-WS]` プレフィックスが `slog.Warn` レベルで使用されている
- **ファイル**: [app.go](myT-x/app.go)
- **内容**: `slog.Warn("[DEBUG-WS] wsHub is nil ...")` — `Debug` レベルと `[DEBUG-*]` プレフィックスを対にするのが命名規則として一貫。

### S-05 [silent-failure-hunter] ファイル書き込み失敗時もイベントが発行される
- **ファイル**: [app_session_log.go#L100](myT-x/app_session_log.go#L100)
- **内容**: `writeErr != nil` でもファイルに永続化されていないエントリが `emitRuntimeEvent` で発行され、ユーザーが永続化成功と誤認する可能性。エントリに `persisted: false` フラグを追加するか、ファイル書き込み失敗自体を別イベントで通知することを検討。

### S-06 [silent-failure-hunter] `TeeHandler` がslog属性をコールバックに伝播しない
- **ファイル**: [handler.go](myT-x/internal/sessionlog/handler.go)
- **内容**: コールバックは `message` と `group` のみ受け取り、`"error"` 等のキー・バリュー属性が欠落。stderr には base handler 経由で出力されるためデータ喪失はないが、DevPanel上での情報不足となる可能性。

### S-07 [silent-failure-hunter] `handleNewWindow` の `SetActivePane` 失敗後にロールバックなし
- **ファイル**: [command_router_handlers_window.go#L284-L290](myT-x/internal/tmux/command_router_handlers_window.go#L284)
- **内容**: ステップ11で `SetActivePane` 失敗時もセッション・ターミナルは作成済み。`slog.Warn` でログは出るが `tmux:pane-focused` は emit されない。フロントエンドはスナップショット差分で復旧するため実害は低いが、認識しておくべき。

### S-08 [test-analyzer] 1テストケースだけのテーブル駆動テストが複数存在
- **ファイル**: [app_session_log_test.go](myT-x/app_session_log_test.go)
- **内容**: `TestCloseSessionLog_ClosesFile`, `TestGetSessionLogFilePath_ReturnsCorrectPath`, `TestWriteSessionLogEntry_WithoutInitializedFile` — テーブルにそれぞれ1ケースしかない。将来のケース追加を見込むなら許容だが、現時点ではオーバーエンジニアリング。

### S-09 [test-analyzer] `TestGetSessionErrorLog_EmptyReturnsEmptySlice` のテストケースが冗長
- **ファイル**: [app_session_log_test.go](myT-x/app_session_log_test.go)
- **内容**: 2つのサブテストが同一のsetup・assertionで、テスト名が異なるだけ。

### S-10 [test-analyzer] `TestCleanupOldSessionLogs_DeletesOldest` の期待値が定数
- **ファイル**: [app_session_log_test.go](myT-x/app_session_log_test.go)
- **内容**: `expectDeleted: []int{0,1,...,9}` は `sessionLogMaxFiles` から算出すべき。定数変更時にテストがサイレントに壊れる。

### S-11 [test-analyzer] テストのエントリ Message に制御文字が使用されている
- **ファイル**: [app_session_log_test.go](myT-x/app_session_log_test.go)
- **内容**: `"entry " + string(rune(i))` で `i=0` は NULL文字（`\x00`）。`fmt.Sprintf("entry %d", i)` が適切。

### S-12 [test-analyzer] `filepath` 変数名がパッケージ名をシャドーイング
- **ファイル**: [app_session_log_test.go](myT-x/app_session_log_test.go)
- **内容**: `filepath := filepath.Join(...)` でパッケージ `path/filepath` をローカル変数でシャドーイング。Go のスコープ規則により動作するが可読性が極めて低い。`filePath` 等への変更を推奨。

### S-13 [code-simplifier] `session_manager_windows.go` のマルチウィンドウ複雑性
- **ファイル**: [session_manager_windows.go](myT-x/internal/tmux/session_manager_windows.go)
- **内容**: 1-windowモデルでは `fallbackWindowIDNearIndex`, `SurvivingWindowID`, `removeWindowAtIndexLocked` のウィンドウ残存ブランチが到達不能。マルチウィンドウ拡張の将来計画次第で判断。

### S-14 [frontend-reviewer] `ErrorLogView.tsx` の key にインデックスを含む
- **ファイル**: [ErrorLogView.tsx](myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx)
- **内容**: `key={entry.ts}-${i}}` — `ts` はタイムスタンプで重複可能性あり。`i`（連番）含むため実質ユニークだが、一意IDの方が安全。

### S-15 [frontend-reviewer] `viewer.css` のカラー変数の意味的不一致
- **ファイル**: [viewer.css](myT-x/frontend/src/styles/viewer.css)
- **内容**: `.error-log-level.warn` に `--accent` を使用。warn 専用のカラー変数（`--warn`）を定義した方が安全。

### S-16 [comment-analyzer] TeeHandler サイクルコメント内の `handlerWriter` はGoの内部型名
- **ファイル**: [app_lifecycle.go#L128-L131](myT-x/app_lifecycle.go#L128)
- **内容**: `handlerWriter` はGoの `log/slog` 内部実装詳細であり、バージョン更新で名前変更される可能性がある。`(internal bridge)` 程度の補足が安全。

---

## Strengths（良い点）

### P-01 デッドロック修正の設計品質
`TeeHandler → slog → writeSessionLogEntry` の再帰デッドロック問題に対して、`fmt.Fprintf(os.Stderr, ...)` によるバイパスパターンは適切。コメントで再帰パスも明示。

### P-02 TeeHandler の SOLID 準拠
`slog.Handler` インターフェースを忠実に実装。Single Responsibility（ベースハンドラ委譲＋閾値フィルタ付きコールバック）が明確。

### P-03 削除が安全に実行されている
`app_window_api.go` の関数削除は呼び出し元0件確認済み。フロントエンドの `useWindowRename.ts`, `addWindow`/`removeWindow`/`renameWindow` も孤立参照なく完全にクリーンアップ。

### P-04 イベントモデルの整合性
`tmux:window-created` を `snapshotEventPolicies` から削除し、テストで `want: false` 確認済み。1-window model では CreateSession が window 作成を包含するため正しい。

### P-05 ロック順序のドキュメンテーション維持
`app.go` のロック順序コメントが更新済み。`sessionLogMu` は独立ロックセットとして扱われ、既存の階層に干渉しない。

### P-06 `handleNewWindow` のロールバック堅牢性
`rollbackSession` クロージャが `handleNewSession` と同一パターンで実装。各ステップでロールバック呼び出しが網羅。

### P-07 フラグ継承の nil 安全性
`UseClaudeEnv`/`UsePaneEnv` の nil pointer dereference 防止が正しい。

### P-08 shim バリデーション完備
`-t` に加え `-n` の必須チェック、空文字列トリムも実施。テストも正常系＋3パターンの異常系を網羅。

### P-09 SessionView の簡素化
マルチウィンドウの痕跡がほぼ除去。`resolveActiveWindow → LayoutRenderer` の直線的なフローで可読性が高い。

### P-10 Error Log ビューの操作性
copy-on-select, Ctrl+C コピー, 全件コピーボタン, コピー済みフィードバック, auto-scroll が丁寧に実装。

---

## タスク一覧・並列作業可否

以下は修正タスクを優先度順に整理し、並列作業の可否を示した表です。

### 凡例
- **並列作業**: 他のタスクと独立して同時に作業可能か
  - ○ = 並列作業可能（他タスクと依存関係なし）
  - △ = 条件付きで並列可能（同一ファイル内だが変更箇所が離れている）
  - × = 順序依存（先行タスクの完了を待つ必要あり）

### Important タスク

| # | ID | タスク | 対象ファイル | 工数 | 並列 | 備考 |
|---|-----|-------|------------|------|------|------|
| 1 | I-01 | import文の順序修正 (`os` を標準ライブラリブロックへ移動) | `app.go` | 極小 | ○ | `goimports` で自動修正可 |
| 2 | I-02 | 空ファイル削除 (`package main` のみ) | `app_window_api.go`, `app_window_api_test.go` | 極小 | ○ | ファイル削除のみ |
| 3 | I-03 | `ApplyLayoutPreset` 正常系テスト追加 | `app_pane_api_test.go` | 中 | ○ | 1-window モデル向け新規テスト |
| 4 | I-04 | テスト名文字列マッチ依存の解消 | `command_router_handlers_window_test.go` | 小 | ○ | 構造体にフィールド追加 |
| 5 | I-05 | 未使用テストヘルパー関数の削除 | `app_session_log_test.go` | 極小 | △ | I-07,S-10,S-11,S-12 と同一ファイル |
| 6 | I-06 | `RenameWindowByID` ユニットテスト追加 | `session_manager_window_test.go` | 中 | ○ | 新規テスト追加 |
| 7 | I-07 | `readJSONLFile` の最終行破棄バグ修正 | `app_session_log_test.go` | 小 | △ | I-05 と同一ファイル（未使用なら I-05 で削除） |
| 8 | I-08 | `//go:fix inline` の重複削除 | `app_session_api_test.go` | 極小 | ○ | 1行削除 |
| 9 | I-09 | Error Log 初期フェッチの競合修正 | `useBackendSync.ts`, `errorLogStore.ts` | 中 | × | I-10, I-11 と同時修正推奨 |
| 10 | I-10 | `setEntries` に `unreadCount` リセット追加 | `errorLogStore.ts` | 極小 | × | I-09 と同一改修 |
| 11 | I-11 | Error Log エントリに上限追加 | `errorLogStore.ts` | 小 | × | I-09, I-10 と同一ファイル |
| 12 | I-12 | `validateRequired` の重複統合 | `parse.go` | 小 | ○ | ケース文の統合のみ |

### Suggestion タスク

| # | ID | タスク | 対象ファイル | 工数 | 並列 | 備考 |
|---|-----|-------|------------|------|------|------|
| 13 | S-02 | `app.go` のコメント修正 | `app.go` | 極小 | △ | I-01 と同一ファイル |
| 14 | S-03 | Godoc ステップ数の修正 | `command_router_handlers_window.go` | 小 | ○ | コメント修正のみ |
| 15 | S-04 | `[DEBUG-WS]` のログレベル修正 | `app.go` | 極小 | △ | I-01, S-02 と同一ファイル |
| 16 | S-10 | テスト期待値を定数から算出式へ | `app_session_log_test.go` | 小 | △ | I-05, I-07 と同一ファイル |
| 17 | S-11 | テストの制御文字エントリ修正 | `app_session_log_test.go` | 極小 | △ | 同上 |
| 18 | S-12 | `filepath` 変数名シャドーイング修正 | `app_session_log_test.go` | 極小 | △ | 同上 |

### 並列作業グループ

以下のように独立グループに分けると効率的に並列作業が可能です：

| グループ | タスク ID | 作業内容 | 依存関係 |
|---------|----------|---------|---------|
| **A: app.go 修正** | I-01, S-02, S-04 | import順序 + コメント + ログレベル | 同一ファイル内で順次適用、他グループとは独立 |
| **B: 空ファイル削除** | I-02 | `app_window_api.go/test` 削除 | 完全独立 |
| **C: テスト追加（バックエンド）** | I-03, I-06 | ApplyLayoutPreset + RenameWindowByID テスト | 別ファイルなので並列可 |
| **D: tmux テスト修正** | I-04 | テスト名依存解消 | 完全独立 |
| **E: session_log テスト修正** | I-05, I-07, S-10, S-11, S-12 | ヘルパー関数整理 + バグ修正 | 同一ファイルで順次適用 |
| **F: shim 修正** | I-08, I-12 | go:fix重複 + validateRequired統合 | 別ファイルなので並列可 |
| **G: フロントエンド修正** | I-09, I-10, I-11 | errorLogStore 改善 | 同一ストアに対する変更群、順次適用 |
| **H: コメント修正** | S-03, S-14 | Godoc + handleNewWindow | 完全独立 |

**グループ A, B, C, D, E, F, G, H はすべて並列作業可能です。**

---

## Recommended Action

1. **最優先**: グループ A, B, F（工数極小、`goimports`/ファイル削除/コード統合で即完了）
2. **次に**: グループ E, G（バグ・メモリリーク系の修正）
3. **その後**: グループ C, D（テストカバレッジ向上）
4. **最後に**: グループ H（コメント品質改善、非機能要件）
5. **修正後**: 対象グループの再レビューを実施して問題解消を確認
