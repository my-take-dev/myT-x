# PR Review Summary — 2026-02-21 14:23

## 変更概要

今回の変更は主に以下の3つの大きな作業に分かれる:

1. **セッションログ機能の新規追加** — バックエンド（`app_session_log.go`, `app_session_log_types.go`, `internal/sessionlog/handler.go`）およびフロントエンド（ErrorLogView, errorLogStore, ActivityStrip バッジ）
2. **1セッション=1ウィンドウモデルへの移行** — `app_window_api.go` 削除、`AddWindow`/`RemoveWindow`/`RenameWindow` API 削除、`handleNewWindow` を子セッション作成に変更、`SessionManager.AddWindow`/`RemoveWindow`/`RenameWindow`/`WindowIndexInSession` 削除
3. **フロントエンドのウィンドウタブUI削除** — `useWindowRename.ts` 削除、`SessionView.tsx` 簡略化、window-tab CSS 削除

---

## Critical Issues（重大: マージ前に必ず修正）

### C-01: `app_session_log.go` — `GetSessionErrorLog` で Mutex のロックに `sync.Mutex` を使用しているが `RLock` が適切
- **ファイル**: `myT-x/app_session_log.go:164`
- **問題**: `GetSessionErrorLog()` は読み取り専用操作であり、書き込みロック（`Lock`）ではなく読み取りロック（`RLock`）を使うべき。同様に `GetSessionLogFilePath()` (L179) も `Lock` ではなく `RLock` が適切。
- **影響**: 高頻度呼び出し時にフロントエンドAPI応答が不必要にブロックされる。 `writeSessionLogEntry` との排他が必要であるため `sessionLogMu` を `sync.RWMutex` に変更し、読み取り側は `RLock` を使う。
- **修正案**:
  ```go
  // app.go のフィールド定義
  sessionLogMu sync.RWMutex  // sync.Mutex → sync.RWMutex に変更
  
  // GetSessionErrorLog
  a.sessionLogMu.RLock()
  defer a.sessionLogMu.RUnlock()
  
  // GetSessionLogFilePath
  a.sessionLogMu.RLock()
  defer a.sessionLogMu.RUnlock()
  ```

### C-02: `app_session_log.go` — `writeSessionLogEntry` でロックを2回取得しており、間に非保護区間がある
- **ファイル**: `myT-x/app_session_log.go:91-137`
- **問題**: `writeSessionLogEntry` 内で `sessionLogMu` を一度アンロック（L115）してから、スロットリング判定のために再度ロック（L132）している。この間に別ゴルーチンが `sessionLogEntries` を変更しうる。現在の実装では `sessionLogLastEmit` のみが2回目のロック区間で参照されるため即座の不整合は無いが、コードレビュー観点で脆弱であり、将来の変更時にバグの温床になりうる。
- **推奨**: 1回のロック区間で `shouldEmit` 判定まで含めるか、`sessionLogLastEmit` を `atomic` 操作に変更する。

### C-03: `command_router_handlers_window.go` — `handleNewWindow` で `resolveEnvForPaneCreation` に `nil` を渡す設計
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go:299`
- **問題**: `resolveEnvForPaneCreation(nil, newSessionName, nil, req.Env, ...)` で第1引数に `nil` を渡し、内部で `GetSession` を再度呼び出している。しかしステップ7で `copySessionFlags` によりフラグをコピーした直後なので、この時点で `GetSession` を呼べばフラグ継承後の状態が得られるのは正しい。ただし、コメント（L296-298）の説明とコードの意図がやや不明瞭。
- **推奨**: `GetSession` の結果を変数に代入して明示的に渡すことで、null 経由の暗黙的再取得を避ける。

---

## Important Issues（重要: 修正すべき）

### I-01: `app_events.go` — `snapshotEventPolicies` に `tmux:window-created` が残っていない確認
- **ファイル**: `myT-x/app_events.go:135-149`
- **問題**: `handleNewWindow` は `tmux:window-created` ではなく `tmux:session-created` を emit するよう変更されている。`snapshotEventPolicies` に `tmux:window-created` が含まれていないことは正しいが、旧コードとの互換性の観点でフロントエンドが `window-created` イベントを Listen していないか確認が必要。
- **確認済み**: `useBackendSync.ts` に `window-created` のハンドラは存在しないため、この変更は安全。

### I-02: `handleNewWindow` — 親セッションの `GetSession` が deep clone を返す前提
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go:242`
- **問題**: L242 の `parentSession` は deep clone。しかし L285 の `copySessionFlags` で `parentSession.IsAgentTeam` 等を参照する際、別ゴルーチンが元のセッションを変更しても clone には影響しないため安全。ただし、この設計前提がコメントに記載されているのは L240-241 のみ。`copySessionFlags` の呼び出し元にも clone 前提であることを明記すべき。

### I-03: `session_manager_windows.go` — `RemoveWindow` と `AddWindow` の削除で外部からの呼び出しが残っていないか
- **ファイル**: `myT-x/internal/tmux/session_manager_windows.go`
- **問題**: `AddWindow`, `RemoveWindow`, `RenameWindow`, `WindowIndexInSession` が削除された。これらの関数を参照するテストコードも削除されているが、他のファイルから間接的に呼び出されていないかの確認が必要。
- **確認済み**: `app_window_api.go` (削除済み), `app_window_api_test.go` (削除済み), テストファイルから直接呼び出されていたケースは全て削除済み。`RemoveWindowByID` と `RenameWindowByID` は残存しており、`handleKillWindow` と `handleRenameWindow` から使用されている。

### I-04: `errorLogStore.ts` — `setEntries` のマージロジックで `ts+msg` キーの衝突リスク
- **ファイル**: `myT-x/frontend/src/stores/errorLogStore.ts:36`
- **問題**: 重複排除キーが `${e.ts}|${e.msg}` だが、同一秒・同一メッセージで複数エントリが発生した場合に正当なエントリが除去される。タイムスタンプの精度が秒単位（`20060102150405`）であるため、高頻度ログバーストでは重複排除が誤動作する。
- **推奨**: バックエンド側で一意IDを付与するか、`ts+level+msg+source` のような複合キーを使用する。

### I-05: `ErrorLogView.tsx` — `selectionchange` イベントの自動コピーがユーザー体験に影響
- **ファイル**: `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx:41-69`
- **問題**: テキスト選択時にクリップボードに自動コピーする挙動は、既存ターミナルビューと一貫性があるが、一般的なWebアプリケーションのユーザーにとっては予期しない動作。CLAUDE.md の製品仕様（L37-38: 内部使用Webアプリ）に基づけば許容範囲だが、注意が必要。
- **確認**: 既存のターミナルコンポーネントと同パターンであることを確認済み。

### I-06: `app_lifecycle.go` — `slog.SetDefault` の呼び出しがグローバルロガーを変更する
- **ファイル**: `myT-x/app_lifecycle.go:143`
- **問題**: `slog.SetDefault(slog.New(teeHandler))` はプロセスレベルのグローバルロガーを変更する。テスト実行時に他のテストに影響を与える可能性がある。
- **許容**: アプリケーション起動時の1回のみ呼び出されるため、本番環境では問題ない。テストでは `runtimeEventsEmitFn` のオーバーライドで回避されている。

### I-07: `useErrorLog.ts` — `isMountedRef` が初期ロード以外で使用されていない
- **ファイル**: `myT-x/frontend/src/components/viewer/views/error-log/useErrorLog.ts:21-31`
- **問題**: `isMountedRef` が設定されているが、フック内で実際に参照していない。初期ロードは `useBackendSync.ts` に移動済みと記載されているが、`isMountedRef` 自体が不要なコードとして残っている。
- **推奨**: 不要であれば削除する。

### I-08: `app_session_log.go` — `cleanupOldSessionLogs` が `initSessionLog` 内で同期的に呼ばれる
- **ファイル**: `myT-x/app_session_log.go:41`
- **問題**: 100ファイル以上のログファイルが存在する場合、起動時のI/Oが増加する。非同期化またはバックグラウンドワーカーでの処理を検討。
- **許容**: 起動時の1回のみであり、100ファイル程度のディレクトリスキャンは高速（<10ms）。

### I-09: `usePrefixKeyMode.ts` — Prefix+c が無効化されている件のコメント
- **ファイル**: `myT-x/frontend/src/hooks/usePrefixKeyMode.ts:123-129`
- **問題**: Prefix+c が `return` で無効化されているが、コメントに理由が記載されている。1セッション=1ウィンドウモデルへの変更に伴う正常な対応。

---

## Suggestions（提案）

### S-01: `TeeHandler` の `Handle` メソッドでエラー時のコールバック呼び出しスキップ
- **ファイル**: `myT-x/internal/sessionlog/handler.go:53-62`
- **提案**: ベースハンドラがエラーを返した場合でもコールバックを呼び出すオプションを検討。ただし、現在の実装（ベースエラー → コールバックスキップ）は妥当。エラーログが消失するリスクがあるが、ベースハンドラ（stderr書き込み）のエラーは通常深刻な問題を示す。

### S-02: `formatIndexAsTimestamp` テストヘルパーの日付計算が不正確
- **ファイル**: `myT-x/app_session_log_test.go:759-791`
- **提案**: 月末の日付処理が簡略化されている（L778-782: 28日を超えたら3月へ進む）。テスト目的であれば問題ないが、`time.Date` を使った正確な実装に置き換えると保守性が向上する。

### S-03: `ErrorLogView` — エントリ数が多い場合の仮想スクロール
- **ファイル**: `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx:147`
- **提案**: `MAX_ENTRIES = 10000` のエントリをすべてDOMに描画するのは重い可能性がある。`react-virtuoso` 等の仮想スクロールの導入を検討。

### S-04: `app.go` — `sessionLogMu` のロック順序ドキュメント
- **ファイル**: `myT-x/app.go:96-104`
- **提案**: `sessionLogMu` のロック順序が他のmutexとの関係でドキュメント化されていない。L27-42 のロック順序コメントに `sessionLogMu` を追加すべき。
  ```go
  // Independent locks 行に sessionLogMu を追加:
  //   windowMu, outputMu, snapshotRequestMu, snapshotMetricsMu,
  //   startupWarnMu, activeSessMu, ctxMu, sessionLogMu
  ```

### S-05: `models.ts` — `SessionLogEntry` クラスの空行
- **ファイル**: `myT-x/frontend/wailsjs/go/models.ts`
- **提案**: Wails 自動生成ファイルだが、`export namespace main` の直後に不要な空行がある。自動生成のためコード修正は不要だが、Wails の binding 再生成時に確認。

### S-06: `ViewerSystem.tsx` — Error Log のキーバインド `Ctrl+Shift+L` の潜在的衝突
- **ファイル**: `myT-x/frontend/src/components/viewer/ViewerSystem.tsx:48`
- **提案**: ブラウザのアドレスバーフォーカス（通常 `Ctrl+L`）とは衝突しないが、ターミナル内でのキー入力との干渉を確認。`e.defaultPrevented` チェックがL20で行われているため、ターミナルがフォーカスしている場合は問題ない。

### S-07: `handleNewWindow` の -n フラグ必須化
- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go:236-238`, `myT-x/cmd/tmux-shim/parse.go:111-114`
- **提案**: バックエンドとshim両方で `-n` フラグの必須チェックが行われているのは正しい防御的コーディング。ただし、エラーメッセージの文言統一を検討（shim: `%s requires -n`, handler: `new-window requires -n with new session name`）。

---

## Strengths（良い点）

1. **デッドロック防止の設計**: `writeSessionLogEntry` で `slog.Warn/Error` をロック外で呼び出し、`TeeHandler` → `writeSessionLogEntry` 再帰を防止する設計が優秀。
2. **TOCTOU 対策**: `handleNewWindow` のステップ4でのセッション名重複チェックにTOCTOU注意コメントが適切に付与されている（L248-251）。
3. **ロールバックパターンの統一**: `handleNewWindow` と `handleNewSession` のロールバック関数パターンが統一されている。
4. **テストカバレッジ**: `TeeHandler` に対して境界条件テスト（nil callback, nested groups, WithAttrs）が網羅的。
5. **フロントエンドのレース条件対策**: `errorLogStore.setEntries` でのマージロジック（IMP-02）により、イベント購読とAPIフェッチの順序問題を解決。
6. **コピー安全性**: `GetSessionErrorLog` がスライスコピーを返す設計で並行安全性を確保。
7. **スロットリング**: `sessionLogEmitMinInterval` (50ms) によるWails IPC過負荷防止。

---

## 削除ファイル一覧

| ファイル | 理由 |
|---|---|
| `myT-x/app_window_api.go` | 1セッション=1ウィンドウモデルへの移行で不要 |
| `myT-x/app_window_api_test.go` | 上記に対応するテスト |
| `myT-x/frontend/src/hooks/useWindowRename.ts` | ウィンドウタブUI削除で不要 |
| `SessionManager.AddWindow` | マルチウィンドウ→子セッション方式に変更 |
| `SessionManager.RemoveWindow` (byIndex) | byID のみ残存 |
| `SessionManager.RenameWindow` (byIndex) | byID のみ残存 |
| `SessionManager.WindowIndexInSession` | 外部呼び出し箇所なし |

---

## 新規ファイル一覧

| ファイル | 内容 |
|---|---|
| `myT-x/app_session_log.go` | セッションログの書き込み・読み取り・クリーンアップ |
| `myT-x/app_session_log_types.go` | `SessionLogEntry` 構造体定義 |
| `myT-x/app_session_log_test.go` | セッションログのテスト（init, write, cap, cleanup, close, path） |
| `myT-x/internal/sessionlog/handler.go` | `TeeHandler` slog ハンドラ |
| `myT-x/internal/sessionlog/handler_test.go` | `TeeHandler` テスト |
| `myT-x/frontend/src/stores/errorLogStore.ts` | Zustand エラーログストア |
| `myT-x/frontend/src/components/viewer/icons/ErrorLogIcon.tsx` | SVG アイコン |
| `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx` | エラーログ表示コンポーネント |
| `myT-x/frontend/src/components/viewer/views/error-log/useErrorLog.ts` | エラーログフック |
| `myT-x/frontend/src/components/viewer/views/error-log/index.ts` | ビュー登録 |

---

## タスク一覧・並列作業可否表

以下は指摘事項の修正タスクを整理し、**並列で同時に作業しても問題がないか**を示した表です。

| # | タスク | 対象ファイル | 優先度 | 並列作業 | 理由・備考 |
|---|---|---|---|---|---|
| C-01 | `sessionLogMu` を `sync.RWMutex` に変更 + 読み取り操作を `RLock` に | `app.go`, `app_session_log.go` | 🔴 Critical | ⚠️ C-02 と同時不可 | C-02 と同じ `sessionLogMu` を変更するため、同一作業者が順次対応 |
| C-02 | `writeSessionLogEntry` のロック区間統合 | `app_session_log.go` | 🔴 Critical | ⚠️ C-01 と同時不可 | C-01 と同じファイル・同じ mutex を変更 |
| C-03 | `handleNewWindow` で `resolveEnvForPaneCreation` に明示的セッション渡し | `command_router_handlers_window.go` | 🔴 Critical | ✅ 他と独立 | `internal/tmux/` のみ変更、他のタスクと干渉しない |
| I-04 | `errorLogStore` の重複排除キー改善 | `errorLogStore.ts` | 🟡 Important | ✅ 他と独立 | フロントエンドストアのみ変更 |
| I-07 | `useErrorLog.ts` の不要な `isMountedRef` 削除 | `useErrorLog.ts` | 🟡 Important | ✅ 他と独立 | 単一ファイルの小変更 |
| S-02 | `formatIndexAsTimestamp` を `time.Date` ベースに改善 | `app_session_log_test.go` | 🟢 Suggestion | ✅ 他と独立 | テストヘルパーのみの変更 |
| S-03 | ErrorLogView に仮想スクロール導入 | `ErrorLogView.tsx`, `package.json` | 🟢 Suggestion | ✅ 他と独立 | フロントエンドUIのみ変更 |
| S-04 | ロック順序コメントに `sessionLogMu` 追加 | `app.go` | 🟢 Suggestion | ⚠️ C-01 と同時不可 | 同じファイル `app.go` を編集 |
| S-07 | `new-window` エラーメッセージ文言統一 | `parse.go`, `command_router_handlers_window.go` | 🟢 Suggestion | ✅ 他と独立 | 文字列リテラルのみの変更 |

### 並列作業マトリックス（衝突関係のみ抜粋）

```
C-01 ←→ C-02  ：同一ファイル・同一フィールド変更 → 順次作業
C-01 ←→ S-04  ：同一ファイル `app.go` 変更 → 順次作業（C-01 完了後に S-04）
C-03, I-04, I-07, S-02, S-03, S-07 ：互いに独立 → 全て並列作業可能
```

### 推奨作業順序

```
Phase 1（並列可能）:
  ├── 作業者A: C-01 → C-02 → S-04  （app.go / app_session_log.go 関連を一括）
  ├── 作業者B: C-03                  （command_router_handlers_window.go）
  ├── 作業者C: I-04 + I-07           （フロントエンド小修正）
  └── 作業者D: S-02                  （テストヘルパー改善）

Phase 2（Phase 1 完了後）:
  └── S-03, S-07（優先度低、任意タイミングで対応）
```
