# コードレビュー結果 (myT-x 配下ファイル)

本レビューは `review-pr-para.prompt.md` のガイドラインに準拠し、コミット前の `myT-x` 配下の差分を「深く」「広範囲に」「入念に」調査した結果です。
差分量（約200KB、1万行以上）に対応するため、各領域の専門エージェント（仮想）による指摘を統合しています。
類似処理に対する指摘漏れを防ぐため、設計の根本的な課題から実装の細部まで網羅的に洗い出しました。また、修正工数を最適化するためにサブエージェントが**並列で機能修正タスクを実行できるよう**、カテゴリと並列作業の可否を整理しています。

---

## 1. 📂 レビュー対象カテゴリと担当アサイン方針

差分は大きく分けて以下の4つのカテゴリに分類されます。サブエージェントにアサインする際はこちらの単位で分割するとコンフリクトなく効率的に作業が可能です。

1. **Category A: Session Log (ログ基盤・エラー収集)**
   - 対象ファイル: `app_session_log*.go`, `internal/sessionlog/*`, `app_lifecycle.go`
   - 担当観点: Async/Silent-Failure-Hunter, Code-Reviewer
2. **Category B: Tmux Router & Single-Window Model (1ウィンドウ制移行)**
   - 対象ファイル: `app_window_api*.go` (削除), `internal/tmux/*`, `cmd/tmux-shim/*`
   - 担当観点: Type-Design-Analyzer, Pr-Test-Analyzer
3. **Category C: Frontend (UI/ErrorLog画面, Zustand)**
   - 対象ファイル: `frontend/src/components/*`, `frontend/src/hooks/*`, `frontend/src/api.ts`
   - 担当観点: Code-Reviewer, Code-Simplifier
4. **Category D: App API & Settings (フロント・バックエンド連携)**
   - 対象ファイル: `app.go`, `app_events.go`, `app_pane_api_test.go`
   - 担当観点: Code-Reviewer

---

## 2. 🚨 検出された問題点・指摘事項 (Agent連携分析)

### 🔴 Critical Issues (修正必須)

- [Silent-Failure-Hunter] **セッションログの O(N) スライスコピー問題 (Category A)**
  - `app_session_log.go` の `writeSessionLogEntry` において、`sessionLogMaxEntries` を超えた際に `a.sessionLogEntries = a.sessionLogEntries[len(a.sessionLogEntries)-sessionLogMaxEntries:]` で配列を毎度詰め直しています。エラーが頻発した際、スライスの再割り当てと全要素コピーが毎度発生し、システム負荷（CPUストール・GC圧迫）を引き起こします。
  - **推奨修正**: 配列のスライスではなく、**Ring Buffer（リングバッファ構造）** を採用し、論理的なインデックス管理で上書きするように修正してください。
- [Code-Reviewer] **エラーイベントの発火 (Wails IPC) の排他制御のブレ (Category A)**
  - 同 `writeSessionLogEntry` にて、ファイル/メモリへの書き込み用に `sessionLogMu.Lock()` を取得・解放した後、再度 `sessionLogMu.Lock()` を取得して時間判定を行っています。この間に別ゴルーチンのエラーが割り込むと、イベント発行（`app:error-logged`）のタイミングが逆転したり、通知されるエラー内容に不整合が生じるレースコンディションが発生するおそれがあります。
  - **推奨修正**: 1度の `Lock()` の中で時間判定と追加処理を完結させ、`shouldEmit` フラグとともにイベント発行ペイロードのコピーを返し、`Unlock()` 後に確実に順序通り `Emit` する形にリファクタリングしてください。
- [Code-Reviewer] **Windows GUI 上での os.Stderr の不安定性 (Category A)**
  - `app_lifecycle.go` にて `slog.NewTextHandler(os.Stderr, nil)` を Base Handler として作成しています。Wails でビルドされた Windows アプリケーション（コンソールを持たないGUIモード）では `os.Stderr` への書き込みがパニックを引き起こすか、意図せずサイレントフェイルする可能性があります（特にリダイレクトされていない場合）。
  - **推奨修正**: `os.Stderr` へ直接書き込む前にファイルディスクリプタが有効かテストするか、またはファイル（ファイルロガー）のみに吐き出す等の代替案を検討してください。

### 🟡 Important Issues (強く修正を推奨)

- [Type-Design-Analyzer] **Child Session 移行によるフロントエンドの Event 追従漏れ (Category B, C)**
  - `app_events.go` では `tmux:window-created` などのイベントトリガーを外していますが、`handleNewWindow` が `tmux:session-created` を発行するようになりました。フロントエンド側 (`useBackendSync.ts` 等) で `tmux:session-created` イベント発火時に適切にスナップショットのリフレッシュが行われるか、意図した挙動になるかの確認が漏れているように見受けられます。変更後、セッションが即座にUIへ反映されるか担保してください。
- [Code-Reviewer] **フロントエンドの Timestamp Format 脆弱生 (Category C)**
  - `useErrorLog.ts` 内の `formatTimestamp(ts: string)` において、パースする際に無条件に `ts.slice` で 14文字の "YYYYMMDDHHMMSS" 形式を前提としています（`if (ts.length !== 14) return ts;` とあるので防御的ではありますが）。データ構造が堅牢であれば問題ありませんが、フォーマットエラー値が入ってきた場合の fallback に考慮の余地があります。
- [Type-Design-Analyzer] **Test のポインタ生成の非効率さ (Category B)**
  - `ptrBool` 関数を `new(true)` 等に置換していますが、`new(true)` は Go 1.20~ の新構文・定石ではなく、通常 `func ptr[T any](v T) *T { return &v }` のようなジェネリクスヘルパーを使用する方が汎用性が高いです。特に複数のテストファイルで同じ定義が散在しているため、`internal/testutil` 等にまとめるべきです。

### 🔵 Suggestions (提案・改善)

- [Code-Simplifier] `Frontend` で `onDetachSession` の処理をリファクタする際、`if (props.session?.name == null || props.session.name === "")` を用いていますが、Zustand Store または selector を活用して Props バケツリレーを減らせるはずです。（コンポーネントの依存整理）
- [Comment-Analyzer] `handleNewWindow` などのコメントに `13-step process` と詳細が記載されていますが、ステップ番号のメンテナンスは今後のコード変化で「コメントの腐敗（Comment Rot）」を起こしやすくなります。処理ブロックごとにインラインで意図を書く程度に簡略化するか、設計ドキュメントへ移譲することを推奨します。

---

## 3. 📋 タスク修正の並列作業マトリクス (サブエージェント向け)

差分が広範囲にわたるため、並列にサブエージェントを稼働させて修正を行うことが可能です。以下の表で、並列作業が可能か（ファイル競合が発生しないか）、依存関係があるかを整理しました。**作業者（エージェント）目線で、コンフリクトを回避して安全に進められる**よう構成しています。

| タスクID | 修正対象カテゴリ | 修正内容概要 | 対象ファイル群 | 並列作業時の安全性 (問題有無) | 注意事項・依存関係 |
|:---:|:---|:---|:---|:---:|:---|
| **T-1** | ログ基盤 (Backend) | `sessionLog` のリングバッファ化、2回ロック問題の解消、GUIアプリの stderr 安全対策 | `app_session_log.go`, `app_lifecycle.go` | **問題なし (安全)** | 他のバックエンドロジックと独立しているため、完全並列可能。フロントへの `app:error-logged` のペイロード型だけは変えないこと。 |
| **T-2** | Tmux (Backend) | 新規セッション作成時の `tmux:session-created` 発行イベントの精査、テストのヘルパー関数(`ptrBool`) 共通化 | `internal/tmux/*`, `app_session_api_test.go` | **問題なし (安全)** | `T-1` とファイルが完全に分離されているため安全。`T-3` を行うエージェントとイベント名の認識を合わせる必要あり。 |
| **T-3** | UI同期 (Frontend) | `tmux:session-created` 受信時のUI更新担保、タイムスタンプパースの堅牢化 | `frontend/src/hooks/useBackendSync.ts`, `frontend/src/components/viewer/views/error-log/useErrorLog.ts` | **基本安全 (要注意)** | バックエンドの修正 `T-2` に対して暗黙のインターフェース依存あり。並列着手は可能だが、最終結合テスト必須。 |
| **T-4** | UI改善 (Frontend) | 不要な引数・オプショナルチェーンの整理、デタッチまわりの無駄なレンダリング回避 | `frontend/src/components/SessionView.tsx`, `api.ts` | **問題なし (安全)** | Reactコンポーネント内だけの変更のため、他タスクから完全に切り離して作業可能。 |

### 💡 サブエージェントへの指示（割り当て方針）
上記の表に従い、下記の手順で並列実行を行います：
1. **Agent A** に `T-1` をアサイン（パフォーマンス改善・スレッドセーフ化）
2. **Agent B** に `T-2` をアサイン（テストコードのリファクタ・イベント送信の正常化）
3. **Agent C** に `T-3` と `T-4` をアサイン（フロントエンド側の一括改善）

それぞれ触るディレクトリ空間が分離（`myT-x/`, `myT-x/internal/tmux/`, `myT-x/frontend/`）されているため、**コンフリクトの問題なく一括・並列での修正が可能**です。
