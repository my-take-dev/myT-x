# PR Review 統合サマリー — 2026-02-21 14:54

> **元ファイル**: `review-20260221142319.md` + `review-20260221143721.md` を重複排除・統合

本レビューは `review-pr-para.prompt.md` のガイドラインに準拠し、コミット前の `myT-x` 配下の差分を「深く」「広範囲に」「入念に」調査した結果です。
サブエージェントによる並列修正タスク実行を考慮し、カテゴリ・並列作業可否を整理しています。

---

## 変更概要

今回の変更は主に以下の3つの大きな作業に分かれる:

1. **セッションログ機能の新規追加** — バックエンド（`app_session_log.go`, `app_session_log_types.go`, `internal/sessionlog/handler.go`）およびフロントエンド（ErrorLogView, errorLogStore, ActivityStrip バッジ）
2. **1セッション=1ウィンドウモデルへの移行** — `app_window_api.go` 削除、`AddWindow`/`RemoveWindow`/`RenameWindow` API 削除、`handleNewWindow` を子セッション作成に変更、`SessionManager.AddWindow`/`RemoveWindow`/`RenameWindow`/`WindowIndexInSession` 削除
3. **フロントエンドのウィンドウタブUI削除** — `useWindowRename.ts` 削除、`SessionView.tsx` 簡略化、window-tab CSS 削除

---

## レビュー対象カテゴリ（サブエージェント割り当て方針）

差分は以下の4カテゴリに分類。サブエージェントアサイン時はこの単位で分割するとコンフリクトなく効率的に作業可能。

| カテゴリ | 対象ファイル | 観点 |
|:---:|:---|:---|
| **Category A** ログ基盤・エラー収集 | `app_session_log*.go`, `internal/sessionlog/*`, `app_lifecycle.go` | async/silent-failure, スレッドセーフ性 |
| **Category B** Tmux Router・1ウィンドウ制 | `app_window_api*.go`（削除）, `internal/tmux/*`, `cmd/tmux-shim/*` | 型設計, テスト, API削除の影響 |
| **Category C** Frontend UI・Zustand | `frontend/src/components/*`, `frontend/src/hooks/*`, `frontend/src/api.ts` | UI品質, イベント連携 |
| **Category D** App API・設定 | `app.go`, `app_events.go`, `app_pane_api_test.go` | バックエンド/フロント連携 |

---

## 🔴 Critical Issues（修正必須）

### C-01: `app_session_log.go` — `GetSessionErrorLog` / `GetSessionLogFilePath` が `RLock` ではなく `Lock` を使用

- **ファイル**: `myT-x/app_session_log.go:164, 179`
- **問題**: 読み取り専用操作に書き込みロック（`Lock`）を使用している。高頻度呼び出し時にフロントエンドAPI応答が不必要にブロックされる。
- **修正案**:
  ```go
  // app.go のフィールド定義
  sessionLogMu sync.RWMutex  // sync.Mutex → sync.RWMutex に変更

  // GetSessionErrorLog / GetSessionLogFilePath 両方
  a.sessionLogMu.RLock()
  defer a.sessionLogMu.RUnlock()
  ```

### C-02: `app_session_log.go` — `writeSessionLogEntry` でロックを2回取得、間に非保護区間あり（レースコンディション）

- **ファイル**: `myT-x/app_session_log.go:91-137`
- **問題**: `sessionLogMu` をL115で一度アンロック後、スロットリング判定のためにL132で再ロックしている。この間に別ゴルーチンが `sessionLogEntries` を変更しうる。コードレビュー観点で脆弱であり、将来の変更時のバグ温床になりうる。また、イベント発行（`app:error-logged`）のタイミング逆転・通知内容不整合のリスクもある。
- **修正案**:
  - 1回のロック区間で `shouldEmit` 判定まで含めるか、`sessionLogLastEmit` を `atomic` 操作に変更する。
  - ロック解放後に `shouldEmit` フラグとペイロードコピーを使って順序通り `Emit` する形にリファクタリングする。

### C-03: `command_router_handlers_window.go` — `resolveEnvForPaneCreation` に `nil` を渡す設計が不明瞭

- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go:299`
- **問題**: `resolveEnvForPaneCreation(nil, newSessionName, nil, req.Env, ...)` で第1引数に `nil` を渡し、内部で `GetSession` を再度呼び出している。コメントの説明とコードの意図がやや不明瞭。
- **修正案**: `GetSession` の結果を変数に代入して明示的に渡すことで、null 経由の暗黙的再取得を避ける。

### C-04: `app_lifecycle.go` — Windows GUI 上での `os.Stderr` の不安定性

- **ファイル**: `myT-x/app_lifecycle.go`
- **問題**: `slog.NewTextHandler(os.Stderr, nil)` をベースハンドラとして使用。Wailsでビルドされた Windows アプリケーション（コンソール非保有のGUIモード）では `os.Stderr` への書き込みがパニックを引き起こすか、意図せずサイレントフェイルする可能性がある（特にリダイレクトされていない場合）。
- **修正案**: `os.Stderr` へ書き込む前にファイルディスクリプタが有効かテストするか、ファイルロガーのみに出力する代替案を検討。

### C-05: `app_session_log.go` — `sessionLogEntries` の O(N) スライスコピー問題

- **ファイル**: `myT-x/app_session_log.go`
- **問題**: `writeSessionLogEntry` において `sessionLogMaxEntries` を超えた際に `a.sessionLogEntries = a.sessionLogEntries[len(a.sessionLogEntries)-sessionLogMaxEntries:]` で毎度スライスを詰め直している。エラーが頻発した際にスライスの再割り当てと全要素コピーが毎度発生し、CPUストール・GC圧迫を引き起こす。
- **修正案**: **Ring Buffer（リングバッファ構造）** を採用し、論理的なインデックス管理で上書きするよう修正する。

---

## 🟡 Important Issues（強く修正を推奨）

### I-01: `app_events.go` — `tmux:window-created` → `tmux:session-created` 移行の影響確認

- **ファイル**: `myT-x/app_events.go:135-149`
- **問題**: `handleNewWindow` が `tmux:session-created` を emit するよう変更。`snapshotEventPolicies` に `tmux:window-created` が含まれないことは正しいが、フロントエンドが旧 `window-created` をListenしていないかの確認が必要。
- **確認済み**: `useBackendSync.ts` に `window-created` ハンドラは存在しないため、この変更は安全。ただし、`tmux:session-created` 受信時のUI即時反映（スナップショットリフレッシュ）が担保されているか確認すること。

### I-02: `command_router_handlers_window.go` — `handleNewWindow` の deep clone 設計前提の明記不足

- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go:242`
- **問題**: L242 の `parentSession` は deep clone。L285 の `copySessionFlags` 呼び出し元にも clone 前提であることを明記すべき。
- **推奨**: `copySessionFlags` 付近にコメントを追加する。

### I-03: `session_manager_windows.go` — 削除関数の呼び出し残存確認

- **ファイル**: `myT-x/internal/tmux/session_manager_windows.go`
- **問題**: `AddWindow`, `RemoveWindow`, `RenameWindow`, `WindowIndexInSession` が削除。他のファイルから間接的に呼び出されていないかの確認が必要。
- **確認済み**: `app_window_api.go`（削除済み）、`app_window_api_test.go`（削除済み）から直接呼び出しされていたケースは全て削除済み。`RemoveWindowByID` と `RenameWindowByID` は残存し、`handleKillWindow` と `handleRenameWindow` から使用されている。

### I-04: `errorLogStore.ts` — `setEntries` の重複排除キー `ts+msg` 衝突リスク

- **ファイル**: `myT-x/frontend/src/stores/errorLogStore.ts:36`
- **問題**: 重複排除キーが `${e.ts}|${e.msg}` だが、同一秒・同一メッセージで複数エントリが発生した場合に正当なエントリが除去される。タイムスタンプ精度が秒単位（`20060102150405`）のため、高頻度ログバーストで誤動作しうる。
- **推奨**: バックエンド側で一意IDを付与するか、`ts+level+msg+source` の複合キーを使用する。

### I-05: `ErrorLogView.tsx` — `selectionchange` 自動コピーのユーザー体験への影響

- **ファイル**: `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx:41-69`
- **問題**: テキスト選択時にクリップボードへ自動コピーする挙動は一般的なWebアプリユーザーには予期しない動作。CLAUDE.md の内部使用Webアプリ仕様に基づけば許容範囲。
- **確認**: 既存のターミナルコンポーネントと同パターンであることを確認済み。

### I-06: `app_lifecycle.go` — `slog.SetDefault` によるグローバルロガー変更のテスト影響

- **ファイル**: `myT-x/app_lifecycle.go:143`
- **問題**: `slog.SetDefault(slog.New(teeHandler))` はプロセスレベルのグローバルロガーを変更し、テスト実行時に他のテストへ影響を与える可能性がある。
- **許容**: アプリケーション起動時の1回のみ呼び出されるため、本番環境では問題なし。テストでは `runtimeEventsEmitFn` のオーバーライドで回避されている。

### I-07: `useErrorLog.ts` — 不要な `isMountedRef` の残存

- **ファイル**: `myT-x/frontend/src/components/viewer/views/error-log/useErrorLog.ts:21-31`
- **問題**: `isMountedRef` が設定されているが、フック内で実際に参照されていない。初期ロードは `useBackendSync.ts` に移動済みとのことなので、`isMountedRef` は不要なコードとして残っている。
- **推奨**: 削除する。

### I-08: `app_session_log.go` — `cleanupOldSessionLogs` が起動時に同期的に呼ばれる

- **ファイル**: `myT-x/app_session_log.go:41`
- **問題**: 100ファイル以上のログファイルが存在する場合、起動時のI/Oが増加する。非同期化またはバックグラウンドワーカーでの処理を検討。
- **許容**: 起動時の1回のみであり、100ファイル程度のディレクトリスキャンは高速（<10ms）。現状許容範囲。

### I-09: `usePrefixKeyMode.ts` — Prefix+c 無効化のコメント記載

- **ファイル**: `myT-x/frontend/src/hooks/usePrefixKeyMode.ts:123-129`
- **問題**: Prefix+c が `return` で無効化されているが、コメントに理由が記載されており、1セッション=1ウィンドウモデルへの変更に伴う正常な対応。対応済み。

### I-10: テストの `ptrBool` ヘルパー関数の分散（旧T-2系）

- **ファイル**: `app_session_api_test.go` 等の複数テストファイル
- **問題**: `ptrBool` 関数を複数のテストファイルで個別定義。通常 `func ptr[T any](v T) *T { return &v }` のようなジェネリクスヘルパーを使用する方が汎用性が高い。複数テストファイルで同じ定義が散在している。
- **推奨**: `internal/testutil` 等にまとめる。

---

## 🔵 Suggestions（提案・改善）

### S-01: `handler.go` — `TeeHandler.Handle` でのエラー時コールバックスキップ

- **ファイル**: `myT-x/internal/sessionlog/handler.go:53-62`
- **提案**: ベースハンドラがエラーを返した場合でもコールバックを呼び出すオプションを検討。ただし、現在の実装（ベースエラー → コールバックスキップ）は妥当。エラーログが消失するリスクがあるが、ベースハンドラのエラーは通常深刻な問題を示す。

### S-02: `app_session_log_test.go` — `formatIndexAsTimestamp` テストヘルパーの日付計算が不正確

- **ファイル**: `myT-x/app_session_log_test.go:759-791`
- **提案**: 月末の日付処理が簡略化されている（L778-782: 28日を超えたら3月へ進む）。テスト目的であれば問題ないが、`time.Date` を使った正確な実装に置き換えると保守性が向上する。

### S-03: `ErrorLogView.tsx` — エントリ数が多い場合の仮想スクロール

- **ファイル**: `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx:147`
- **提案**: `MAX_ENTRIES = 10000` のエントリをすべてDOMに描画するのは重い可能性がある。`react-virtuoso` 等の仮想スクロールの導入を検討。

### S-04: `app.go` — `sessionLogMu` のロック順序ドキュメント不足

- **ファイル**: `myT-x/app.go:96-104`
- **提案**: `sessionLogMu` のロック順序が他のmutexとの関係でドキュメント化されていない。L27-42 のロック順序コメントに `sessionLogMu` を追加すべき。
  ```go
  // Independent locks 行に sessionLogMu を追加:
  //   windowMu, outputMu, snapshotRequestMu, snapshotMetricsMu,
  //   startupWarnMu, activeSessMu, ctxMu, sessionLogMu
  ```

### S-05: `models.ts` — `SessionLogEntry` クラス直後の不要な空行

- **ファイル**: `myT-x/frontend/wailsjs/go/models.ts`
- **提案**: Wails 自動生成ファイルであり `export namespace main` の直後に不要な空行がある。Wails の binding 再生成時に確認。コード修正不要。

### S-06: `ViewerSystem.tsx` — `Ctrl+Shift+L` キーバインドの潜在的衝突

- **ファイル**: `myT-x/frontend/src/components/viewer/ViewerSystem.tsx:48`
- **提案**: ブラウザのアドレスバーフォーカス（`Ctrl+L`）とは衝突しないが、ターミナル内でのキー入力との干渉を確認。`e.defaultPrevented` チェックがL20で行われているため、ターミナルフォーカス時は問題ない。

### S-07: `handleNewWindow` の `-n` フラグエラーメッセージ文言の統一

- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go:236-238`, `myT-x/cmd/tmux-shim/parse.go:111-114`
- **提案**: バックエンドとshim両方で `-n` フラグの必須チェックが行われているのは正しい防御的コーディング。エラーメッセージの文言統一を検討（shim: `%s requires -n` / handler: `new-window requires -n with new session name`）。

### S-08: `handleNewWindow` 等のコメントの Comment Rot リスク

- **ファイル**: `myT-x/internal/tmux/command_router_handlers_window.go`
- **提案**: `handleNewWindow` のコメントに `13-step process` と詳細が記載されているが、ステップ番号のメンテナンスは今後のコード変化で「コメントの腐敗（Comment Rot）」を起こしやすい。処理ブロックごとにインラインで意図を書く程度に簡略化するか、設計ドキュメントへ移譲することを推奨。

### S-09: `SessionView.tsx` — Zustand Selector の活用による Props バケツリレー削減

- **ファイル**: `myT-x/frontend/src/components/SessionView.tsx`
- **提案**: `onDetachSession` の処理をリファクタする際、`if (props.session?.name == null || props.session.name === "")` を用いているが、Zustand Store または selector を活用して Props バケツリレーを減らせるはず。（コンポーネントの依存整理）

---

## ✅ Strengths（良い点）

1. **デッドロック防止の設計**: `writeSessionLogEntry` で `slog.Warn/Error` をロック外で呼び出し、`TeeHandler` → `writeSessionLogEntry` 再帰を防止する設計が優秀。
2. **TOCTOU 対策**: `handleNewWindow` のステップ4でのセッション名重複チェックにTOCTOU注意コメントが適切に付与されている（L248-251）。
3. **ロールバックパターンの統一**: `handleNewWindow` と `handleNewSession` のロールバック関数パターンが統一されている。
4. **テストカバレッジ**: `TeeHandler` に対して境界条件テスト（nil callback, nested groups, WithAttrs）が網羅的。
5. **フロントエンドのレース条件対策**: `errorLogStore.setEntries` でのマージロジックにより、イベント購読とAPIフェッチの順序問題を解決。
6. **コピー安全性**: `GetSessionErrorLog` がスライスコピーを返す設計で並行安全性を確保。
7. **スロットリング**: `sessionLogEmitMinInterval` (50ms) によるWails IPC過負荷防止。

---

## ファイル変更一覧

### 削除ファイル

| ファイル | 理由 |
|---|---|
| `myT-x/app_window_api.go` | 1セッション=1ウィンドウモデルへの移行で不要 |
| `myT-x/app_window_api_test.go` | 上記に対応するテスト |
| `myT-x/frontend/src/hooks/useWindowRename.ts` | ウィンドウタブUI削除で不要 |
| `SessionManager.AddWindow` | マルチウィンドウ→子セッション方式に変更 |
| `SessionManager.RemoveWindow` (byIndex) | byID のみ残存 |
| `SessionManager.RenameWindow` (byIndex) | byID のみ残存 |
| `SessionManager.WindowIndexInSession` | 外部呼び出し箇所なし |

### 新規ファイル

| ファイル | 内容 |
|---|---|
| `myT-x/app_session_log.go` | セッションログの書き込み・読み取り・クリーンアップ |
| `myT-x/app_session_log_types.go` | `SessionLogEntry` 構造体定義 |
| `myT-x/app_session_log_test.go` | セッションログのテスト（init, write, cap, cleanup, close, path） |
| `myT-x/internal/sessionlog/handler.go` | `TeeHandler` slog ハンドラ |
| `myT-x/internal/sessionlog/handler_test.go` | `TeeHandler` テスト |
| `myT-x/frontend/src/stores/errorLogStore.ts` | Zustand エラーログストア |
| `myT-x/frontend/src/components/viewer/icons/ErrorLogIcon.tsx` | SVG アイコン |
| `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx` | エラーログ表示コンポーネント |
| `myT-x/frontend/src/components/viewer/views/error-log/useErrorLog.ts` | エラーログフック |
| `myT-x/frontend/src/components/viewer/views/error-log/index.ts` | ビュー登録 |

---

## 📋 並列作業表（サブエージェント向け）

ファイル競合・依存関係を整理し、**コンフリクトなく安全に並列作業できる**よう構成しています。

| タスクID | カテゴリ | 優先度 | 修正内容概要 | 対象ファイル群 | 並列作業 | 注意事項・依存関係 |
|:---:|:---|:---:|:---|:---|:---:|:---|
| **C-01** | A: ログ基盤 | 🔴 Critical | `sessionLogMu` を `sync.RWMutex` に変更 + 読み取り操作を `RLock` に | `app.go`, `app_session_log.go` | ⚠️ C-02・S-04 と同時不可 | C-02 と同じファイル・同じmutexを変更するため同一作業者が順次対応 |
| **C-02** | A: ログ基盤 | 🔴 Critical | `writeSessionLogEntry` のロック区間統合 + `shouldEmit` フラグ化 | `app_session_log.go` | ⚠️ C-01 と同時不可 | C-01 完了後に対応。同一ファイル・同一mutex |
| **C-03** | B: Tmux | 🔴 Critical | `resolveEnvForPaneCreation` に明示的セッション渡し | `command_router_handlers_window.go` | ✅ 他と独立 | `internal/tmux/` のみ変更、他タスクと干渉なし |
| **C-04** | A: ログ基盤 | 🔴 Critical | Windows GUI での `os.Stderr` 安全対策 | `app_lifecycle.go` | ✅ 他と独立 | ファイルが他タスクと分離されており安全 |
| **C-05** | A: ログ基盤 | 🔴 Critical | `sessionLogEntries` のリングバッファ化（O(N)コピー解消） | `app_session_log.go` | ⚠️ C-01・C-02 と同時不可 | 同一ファイルのデータ構造変更のため同一作業者が一括対応推奨 |
| **I-04** | C: Frontend | 🟡 Important | `errorLogStore` 重複排除キーを `ts+level+msg+source` に改善 | `errorLogStore.ts` | ✅ 他と独立 | フロントエンドストアのみ変更 |
| **I-07** | C: Frontend | 🟡 Important | `useErrorLog.ts` の不要な `isMountedRef` 削除 | `useErrorLog.ts` | ✅ 他と独立 | 単一ファイルの小変更 |
| **I-10** | B: Tmux | 🟡 Important | テストの `ptrBool` 等ヘルパーを `internal/testutil` に共通化 | `internal/testutil/`, 各 `*_test.go` | ✅ C-03 と独立 | テストコードのみ変更。I-01確認と合わせて実施 |
| **S-02** | A: ログ基盤 | 🟢 Suggestion | `formatIndexAsTimestamp` を `time.Date` ベースに改善 | `app_session_log_test.go` | ✅ 他と独立 | テストヘルパーのみの変更 |
| **S-03** | C: Frontend | 🟢 Suggestion | `ErrorLogView` に仮想スクロール（react-virtuoso）導入 | `ErrorLogView.tsx`, `package.json` | ✅ 他と独立 | フロントエンドUIのみ変更 |
| **S-04** | A: ログ基盤 | 🟢 Suggestion | ロック順序コメントに `sessionLogMu` 追加 | `app.go` | ⚠️ C-01 完了後 | 同じファイル `app.go` を編集するため C-01 完了後に対応 |
| **S-07** | B: Tmux | 🟢 Suggestion | `new-window` エラーメッセージ文言統一 | `parse.go`, `command_router_handlers_window.go` | ✅ 他と独立 | 文字列リテラルのみの変更 |
| **S-09** | C: Frontend | 🟢 Suggestion | `SessionView.tsx` の Props バケツリレー削減（Zustand selector 活用） | `SessionView.tsx`, `api.ts` | ✅ 他と独立 | Reactコンポーネント内だけの変更 |

### 衝突関係（順次作業が必要なもの）

```
C-01 ←→ C-02 ←→ C-05 ：同一ファイル `app_session_log.go` + 同一フィールド変更
                          → 同一作業者が C-01 → C-02 → C-05 の順で対応
C-01 ←→ S-04            ：同一ファイル `app.go` 変更
                          → C-01 完了後に S-04 を実施

C-03, C-04, I-04, I-07, I-10, S-02, S-03, S-07, S-09 ：互いに独立 → 全て並列作業可能
```

### 推奨作業フロー

```
Phase 1（並列実行可能）:
  ├── 作業者A: C-01 → C-02 → C-05 → S-04   (app.go / app_session_log.go 関連を一括)
  ├── 作業者B: C-04                           (app_lifecycle.go)
  ├── 作業者C: C-03 + I-10 + S-07            (internal/tmux/ 関連を一括)
  └── 作業者D: I-04 + I-07 + S-09            (フロントエンド小修正を一括)

Phase 2（Phase 1 完了後・任意タイミング）:
  └── 作業者E: S-02 + S-03                   (テストヘルパー改善 + 仮想スクロール導入)
```

> **ディレクトリ空間**: `myT-x/`（作業者A・B）、`myT-x/internal/tmux/`・`cmd/tmux-shim/`（作業者C）、`myT-x/frontend/`（作業者D）は完全に分離されており、**コンフリクトなく並列修正が可能**です。
