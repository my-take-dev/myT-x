# 総合PRレビュー結果

**生成日時:** 2026-02-21 15:36:26
**レビュー方針:** `review-pr-para.prompt.md` に準拠し、バグの未然検知、パフォーマンス、設計方針の妥当性を中心に深掘りして調査を行いました。

## 1. 概要
本レビューでは、`myT-x` ディレクトリ配下における差分を「バックエンド(ログ・ライフサイクル)」「バックエンド(Tmux・ウィンドウ管理)」「フロントエンド」の3カテゴリに分割して分析しています。
多くのリファクタリング（とくに1-Windowモデル化への変更およびSessionエラーログの実装）は高品質ですが、**設計上見落とされがちな隠れたバグ（UI通知抜け）やパフォーマンスの懸念** がいくつか発見されました。

---

## 2. カテゴリ別 詳細指摘事項

### 2-1. バックエンド: Session Logging & ライフサイクル管理
**該当ファイル:** `app_session_log.go`, `app_session_log_types.go`, `app_lifecycle.go` ほか

*   **[Critical Bug] `app:error-logged` イベントの UI 間引き（Throttling）によるデータ欠落**
    *   **箇所:** `app_session_log.go` の `writeSessionLogEntry`
    *   **事象:** `now.Sub(a.sessionLogLastEmit) >= sessionLogEmitMinInterval (50ms)` の判定で、50ms以内に連続発生した `error` や `warn` レベルのエラーはイベント送信がスキップ (`shouldEmit = false`) されます。
    *   **影響:** 画面（WebUI）側では `app:error-logged` イベントで送られてきたログをStoreへ追記する設計（`useBackendSync.ts`）になっているため、間引かれたエラーは**フロントエンドのメモリ上から完全に欠落**し、再ロードするまで画面に一切表示されません。
    *   **対応案:** イベントに実際のログ `entry` を乗せる仕様をやめ、フロントエンドへは「更新があった (`app:error-log-updated`)」という Ping のみを間引き送信するようにし、フロント側で必要に応じて `GetSessionErrorLog()` をフェッチ（Debounce管理）する仕組みに変更することを強く推奨します。あるいは、スロットル時には配列に溜め込んだログを一括送信（バッチ処理）する方式にしてください。
*   **[Performance] Mutexロック下での同期的なファイル同期 (`Sync`)**
    *   **箇所:** `app_session_log.go` の `writeSessionLogEntry`
    *   **事象:** `a.sessionLogMu.Lock()` を取得したまま、`entry.Level == "error"` の場合は `a.sessionLogFile.Sync()` によるファイルシステムへの同期（強制フラッシュ）を行っています。
    *   **影響:** ディスクI/Oが遅延した場合、本関数を呼び出している `slog.Error()` 系の処理および Wails のログ監視全体がストールします。
    *   **対応案:** ファイルI/Oについてはチャネルを介した非同期ワーカーゴルーチンへ逃がすなど、防衛的な設計を検討してください。

### 2-2. フロントエンド: UI & 状態管理
**該当ファイル:** `frontend/src/stores/errorLogStore.ts`, `frontend/src/hooks/useBackendSync.ts` ほか

*   **[Logic Flaw] エラーログの重複排除キー（Deduplication Key）**
    *   **箇所:** `frontend/src/stores/errorLogStore.ts`
    *   **事象:** バックエンドからのSnapshotデータと既存データをマージする際、`${e.ts}|${e.level}|${e.msg}|${e.source}` をキーとしています。
    *   **影響:** バックエンドの `ts` が 14桁（例: `20060102150405`：秒単位の精度）であるため。**「同一秒」に起きた「同じエラー内容」の別々のエラーが誤って重複排除の対象となってしまう**リスクがあります。（一秒間に5回同じエラーが発報された場合など、マージ時に齟齬が出ます）。
    *   **対応案:** バックエンド (`SessionLogEntry`) 側で UUID やインクリメントされる順序ID (`seq`) を持たせ、それをキーとする堅牢な仕様に変更することを推奨します。

### 2-3. バックエンド: Tmux 1-windowモデル改修
**該当ファイル:** `app_window_api.go` (削除), `internal/tmux/*`

*   **[確認済み / Good] ウィンドウ→セッションモデルへの移行**
    *   **事象:** プロジェクトが 1-Window ごとのセッションモデルへ移行し、`new-window` コマンドが新セッション作成を指すよう大幅な改修が行われました。
    *   **影響・対応:** 親セッションが持つ状態（`IsAgentTeam`, `UseClaudeEnv`）も `copySessionFlags` 経由で適切に子セッションへ伝播しており、防衛的な実装や単体テストも充実しています。現状このカテゴリに関しては直ちに修正を要するCriticalな問題はありません。

---

## 3. タスク整理・並列作業可否表

サブエージェントに並列で役割を分担させ、最も効率よく修正作業にあたれるようタスクと依存関係を整理しました。

| タスクID | 分類カテゴリ | 対象ファイル群 | 指摘内容サマリー | 優先度 | 並列作業 | 依存・干渉タスク | 備考 |
|----------|------------|--------------|----------------|-------|--------|----------------|------|
| **Task-1** | Backend | `app_session_log.go`<br>`app_session_log_types.go` | **Throttleによるイベント欠落バグ修正**<br>配列一括送信、または更新通知＋フェッチ方式へのアーキテクチャ改修 | **高** | **可** | なし | 最重要課題。 |
| **Task-2** | Backend | `app_session_log_types.go`<br>`app_session_log.go` | **データ一意性のための識別子導入**<br>`SessionLogEntry` に `ID` (UUID/Sequence) を追加 | **高** | **可** | Task-1 | 同じファイルを扱うため、Task-1を担当するエージェントが一緒に対応するのが最も安全。 |
| **Task-3** | Backend | `app_session_log.go` | **Mutexロック内のSync処理の非同期化**<br>ファイルI/Oのブロック回避 | 中 | **可** | Task-1 | 時間がかかる場合は後回しでも可だが、ファイルが被るため担当をまとめる。 |
| **Task-4** | Frontend | `useBackendSync.ts`<br>`errorLogStore.ts` | **ログデータ取得側・ストア側の改修**<br>Task-1 で変更した連携方式への追従対応 | **高** | **可** | *Task-1* | フロントとバックの並行作業（別エージェント）が可能ですが、データ連携仕様だけ事前に合意（例：配列を待つ、イベント名など）必要。 |
| **Task-5** | Frontend | `errorLogStore.ts` | **Deduplication ロジックの堅牢化**<br>重複排除キーを秒単位のものから Backend で採番された `ID` に変更 | **高** | **可** | *Task-2* | バックエンドでID実装さえ完了(合意)していれば、独立して改修可能。 |

### 💡 サブエージェントを活用した並列実行プラン提案

差分量と対象コンテキストを踏まえ、**フロントエンド専門エージェント**と**バックエンド専門エージェント**の2つのサブエージェントを立てることで、効率的に並列作業を進めることが可能です。

1.  **Backend エージェント**:
    *   担当: **`Task-1`, `Task-2`, `Task-3`**
    *   作業: Goロジック側で `ID` 発行の実装、`app_session_log.go` のThrottling方式の修正（Ping通知等）、そして `Sync()` のチャネル非同期化を実施。
2.  **Frontend エージェント**:
    *   担当: **`Task-4`, `Task-5`**
    *   作業: React/Zustand の `errorLogStore.ts` における重複排除キー（秒単位の時刻 → Backend が発行する `ID`）のリファクタおよび、UIデータのフェッチ方法への追従を対応。

（※両エージェントに「新しい Payload 定義」や「識別子 ID」のルールのみ事前に渡しておくことで、並列でデグレードなく作業を完遂できます。）
