# PR Review Summary — 2026-02-21 22:37

## 対象: myT-x 配下コミット前レビュー (34ファイル / 2925行差分)

### レビューカテゴリ
| # | カテゴリ | ファイル数 | 差分行数 |
|---|---------|----------|---------|
| 1 | DevPanel API（新機能） | 3 | 834 |
| 2 | Session Log | 5 | 355 |
| 3 | App Core & Events | 4 | 44 |
| 4 | tmux互換レイヤー | 8 | 454 |
| 5 | Frontend (TypeScript/React/CSS) | 10 | 308 |
| 6 | Wails生成コード・横断レビュー | 7 | 横断 |

---

## Critical Issues (4件)

### C-1: [app_session_log.go] `sessionLogFile` のロック外アクセスによるデータ競合
**カテゴリ**: 2 (Session Log) / 6 (横断)
**ファイル**: `app_session_log.go:145-149`

`needSync` 判定後にロックを解放してから `a.sessionLogFile.Sync()` を呼んでいる。この間に `closeSessionLog()` がロックを取得し `a.sessionLogFile = nil` を書き込む可能性があり、Go のメモリモデル上はデータ競合となる。

特に `shutdown()` 内の `waitWithTimeout` にタイムアウトがあるため、タイムアウト後にバックグラウンドワーカーが `slog.Warn/Error` → `TeeHandler` → `writeSessionLogEntry` を呼び出すと `closeSessionLog()` との間で nil ポインタデリファレンスが発生し得る。

**修正案**: ロック内でファイルポインタをローカル変数にキャプチャする：
```go
var syncFile *os.File
a.sessionLogMu.Lock()
// ... existing logic ...
if entry.Level == "error" {
    syncFile = a.sessionLogFile
}
a.sessionLogMu.Unlock()

if syncFile != nil {
    if syncErr := syncFile.Sync(); syncErr != nil {
        fmt.Fprintf(os.Stderr, "[session-log] failed to sync log file: %v\n", syncErr)
    }
}
```

---

### C-2: [app_devpanel_types.go:27] `GitGraphCommit.Parents` のコメントが実装と不一致
**カテゴリ**: 1 (DevPanel API)
**ファイル**: `app_devpanel_types.go:27` / `app_devpanel_api.go:243`

コメントでは `parent short hashes (for graph drawing)` とあるが、実装では `%P`（**フルハッシュ**）でパースしている。フロントエンドが short hash を前提としている場合、グラフ描画で parent 照合に失敗する。

**修正案**: コメントを `parent full hashes (for graph drawing)` に修正するか、フォーマットを `%p`（short hash）に変更する。

---

### C-3: [errorLogStore.ts:18-19] `ErrorLogEntry.seq` が optional でバックエンドとの型不一致
**カテゴリ**: 5 (Frontend)
**ファイル**: `frontend/src/stores/errorLogStore.ts:18-19`

バックエンドの `SessionLogEntry` では `seq: number` は **required** だが、フロントエンドの `ErrorLogEntry` で `seq?: number` と optional にしたことで型の不一致が生じている。`seq` が `undefined` の場合、フォールバックキーが `${e.ts}|${e.level}|${e.msg}|${e.source}` になり、同じ秒に同じメッセージが複数回記録された場合に重複排除でエントリ消失につながる。

**修正案**: バックエンドの `seq` は常に存在するので `seq: number` に変更する。

---

### C-4: [errorLogStore.ts:39-49] `setEntries` のマージロジックの設計意図が不明確
**カテゴリ**: 5 (Frontend)
**ファイル**: `frontend/src/stores/errorLogStore.ts:39-49`

"ping + fetch" モデルではバックエンドが常にフルスナップショットを返すため、`liveOnly` エントリが存在するケースは通常ない。それにもかかわらずマージロジックがあり、万一同じ `seq` を持つが内容が異なるエントリが来た場合にデータ不整合が発生しうる。

**修正案**: シンプルにスナップショット置換にするか、マージが必要な理由をコメントで詳細に明記する。

---

## Important Issues (14件)

### I-1: [app_devpanel_api.go:315-318] `commitHash` の前に `--` 引数終端が未挿入
**カテゴリ**: 1 (DevPanel API)

`ValidateCommitish` が `-` を含む文字列（`--something` 等）もマッチするため、`diff-tree` のオプションと誤解釈される可能性がある。

**修正案**: `args := []string{"diff-tree", "--root", "-p", "--", commitHash}`

---

### I-2: [app_devpanel_api.go:348-356] `DevPanelWorkingDiff` のエラーログレベルが不適切
**カテゴリ**: 1 (DevPanel API)

`git diff HEAD` が初回コミット前以外のエラー（corrupt index 等）でも `slog.Debug` でログ出力される。

**修正案**: `slog.Debug` → `slog.Warn` に変更。

---

### I-3: [app_devpanel_api.go:170, 416] `bytes.ContainsRune(probe, '\x00')` が意味的に不明瞭
**カテゴリ**: 1 (DevPanel API)

**修正案**: `bytes.Contains(probe, []byte{0})` または `bytes.IndexByte(probe, 0) >= 0` に変更。2箇所に同一パターンあり。

---

### I-4: [app_devpanel_api.go:362-366] untracked ファイル収集時の `consumedSize` チェック漏れ
**カテゴリ**: 1 (DevPanel API)

`buildUntrackedFileDiffs` がディレクトリの場合に複数エントリを返すが、内側ループで `consumedSize >= devPanelMaxDiffSize` のチェックがない。サイズ制限超過の可能性あり。

**修正案**: 内側ループにも `consumedSize` チェックを追加。

---

### I-5: [app_devpanel_api.go:128-131] 孤立コメント
**カテゴリ**: 1 (DevPanel API)

隠しファイルに関するコメントが、対応するフィルタリングコードなしに存在。

**修正案**: コメント削除か意図の明確化。

---

### I-6: [app_session_log_types.go:34] `newSessionLogRingBuffer` の容量0防御なし
**カテゴリ**: 2 (Session Log)

`capacity` が 0 の場合、`push()` 内 `% cap` でゼロ除算パニック。

**修正案**: `if capacity <= 0 { capacity = 1 }` を追加。

---

### I-7: [app_session_log_types.go:42] `cap` がビルトイン関数を隠蔽
**カテゴリ**: 2 (Session Log)

`cap := len(rb.buf)` がビルトイン `cap()` を隠蔽。

**修正案**: `bufCap` や `capacity` に改名。

---

### I-8: [app_lifecycle.go:311, 319] 同一ログメッセージを異なる原因に使用
**カテゴリ**: 3 (App Core)

`a.hotkeys == nil` と `spec == ""` の2つの異なるケースで同じデバッグメッセージ。

**修正案**: メッセージを分ける。

---

### I-9: [command_router_handlers_window.go:264-268] `removeWindowAtIndexLocked` の初期不要アロケーション
**カテゴリ**: 4 (tmux)

`window != nil` のケースで最初の `make` が即座に破棄される。

**修正案**: `var removedPanes []*TmuxPane` に変更。

---

### I-10: [command_router_handlers_window_test.go:296-345] マルチウィンドウ時の `TestHandleKillWindow` テスト不足
**カテゴリ**: 4 (tmux)

`wantSessionAlive: true` のシナリオ（セッション存続パス）がテスト未カバー。

---

### I-11: [ErrorLogView.tsx:33-43, 46-68] `useRef` を useEffect 依存配列に含めても効果なし
**カテゴリ**: 5 (Frontend)

`bodyRef` は安定参照のため依存配列に入れても再実行トリガーにならない。2箇所で同一パターン。

---

### I-12: [viewerRegistry.ts:14-18] HMR で `registry` がクリアされない
**カテゴリ**: 5 (Frontend)

Vite HMR 時に古い `component` 参照が残り続ける可能性。

---

### I-13: [testutil/helpers.go:11] `new(v)` は型ではなく値を渡しており不正
**カテゴリ**: 6 (testutil)

Go の `new` は型を引数に取る。`new(v)` は正しくない。現時点で呼び出し元が0件のため実害なし。

**修正案**: `new(v)` → `&v` に変更、もしくは関数自体を削除。

---

### I-14: [app_session_log.go:145-148] コメントの根拠が不正確
**カテゴリ**: 2 (Session Log)

「全ライターが停止後」という前提は、`waitWithTimeout` のタイムアウト存在により厳密には保証されない。

---

## Suggestions (20件)

### S-1: [app_devpanel_api.go:44-62] `resolveSessionDir` がO(n)線形スキャン
**カテゴリ**: 1 — SessionManagerに名前引き取得メソッドがあれば使用推奨。

### S-2: [app_devpanel_api.go:275-280] `strings.SplitSeq` と `strings.Split` のスタイル混在
**カテゴリ**: 1 — 統一性のためどちらかに揃える（優先度低）。

### S-3: [app_devpanel_api.go:300] `fmt.Sscanf` → `strconv.Atoi` への変更でオーバーヘッド削減
**カテゴリ**: 1

### S-4: [app_devpanel_api_test.go:460] `countStructFields` のテストヘルパーファイルへの移動
**カテゴリ**: 1 — 他のテストからも再利用できるように。

### S-5: [app_devpanel_api_test.go:244-253] worktree セッションのテストケース追加
**カテゴリ**: 1 — `resolveSessionDir` の `preferWorktree` 分岐カバレッジ。

### S-6: [app_devpanel_api.go:209] デフォルト `maxCount=100` のマジックナンバー定数化
**カテゴリ**: 1

### S-7: [app_session_log.go:101] スロットリング間隔のテスト容易性向上
**カテゴリ**: 2 — 関数内 `const` → パッケージレベル定数。

### S-8: [app_session_log_test.go] 並行書き込みテスト・closeSessionLog後のwriteテスト追加
**カテゴリ**: 2

### S-9: [app_session_log_types.go:7-12] `Level` を型付き定数 `SessionLogLevel` に
**カテゴリ**: 2

### S-10: [app_session_log_types.go:9] Timestamp に RFC3339 またはタイムゾーン情報付加
**カテゴリ**: 2

### S-11: [app_events.go:119] TODO にイシュー番号/条件追加
**カテゴリ**: 3

### S-12: [app_events.go:137-147] `tmux:pane-destroyed` の不在理由コメント
**カテゴリ**: 3

### S-13: [session_manager_pane_io_test.go:186-209] テスト名を実際の動作に合わせる
**カテゴリ**: 4

### S-14: [errorLogStore.ts:7] `MAX_ENTRIES = 10000` のメモリ圧迫リスク
**カテゴリ**: 5 — 1000程度への削減検討。

### S-15: [ViewerSystem.tsx:28-62] ショートカットキーのハードコーディング重複
**カテゴリ**: 5 — `viewerRegistry` から動的に生成するか一箇所で管理。

### S-16: [ActivityStrip.tsx:13] `views.filter()` のメモ化
**カテゴリ**: 5 — `useMemo` でフィルタ結果をメモ化。

### S-17: [ErrorLogView.tsx:14-16] `markAllRead()` の useEffect 依存配列の意図明記
**カテゴリ**: 5

### S-18: [viewer.css] `.error-log-level.info` スタイル未定義
**カテゴリ**: 5 — `info` レベル用スタイル追加。

### S-19: [base.css:51-52] z-indexの管理ルールをコメントに追記
**カテゴリ**: 5

### S-20: [app_devpanel_api_test.go:13-27] テスト用シェル名 `"bash"` の Windows 非互換
**カテゴリ**: 1 — `"cmd.exe"` や `"test-shell"` に変更推奨。

---

## Positive Observations（良い点）

### 全体
- **パストラバーサル防御が多層的で堅牢**: `filepath.IsLocal` → `EvalSymlinks` → `isPathWithinBase` の3段階チェック
- **定数による制限値の一元管理**: `devPanelMaxFileSize`, `devPanelMaxDirEntries` 等
- **テーブル駆動テストの一貫した採用**: 境界値、エッジケースの網羅性が高い
- **フィールドカウントガードテスト**: 構造体変更時のフロントエンド同期漏れをCIで検出
- **ロック順序ドキュメント**: デッドロック防止の設計意図が明確

### DevPanel API
- **untracked ファイルの合成diff生成**: `git add` 前でもフロントエンドでdiff表示可能
- **NUL区切りの安全なgitパス解析**: 改行やスペースを含むファイル名を正しく処理
- **quotedパスのデコード対応**: 日本語ファイル名等のオクタルエスケープを正しくデコード

### Session Log
- **リングバッファ設計**: O(1) push、アロケーション無し
- **デッドロック防止**: `fmt.Fprintf(os.Stderr)` による再帰デッドロック回避
- **"ping + fetch" モデル**: スロットリングによるデータロスを構造的に排除
- **TeeHandler の責務分離**: Clean Architectureに準拠

### App Core & Events
- **スナップショットイベントポリシーの集約設計**: OCP準拠
- **値型 `PaneOutputEvent` の防御的コピー**: データ競合防止
- **CAS ガードによる Quake Window トグル保護**

### tmux互換レイヤー
- **環境変数マージの5レイヤー設計と包括的テスト**
- **ディープコピーの一貫した検証**: ロック外露出によるデータ競合防止
- **handleNewWindowの13ステップロールバック設計**
- **TOCTOU リスクの明示的認知と対応**

### Frontend
- **堅牢なイベントハンドリング設計**: `BackendEventMap` による型付きイベント登録
- **防御的なペイロード検証**: `asObject`/`asArray` によるランタイム検証
- **デバッグログプレフィックスの統一**: `[DEBUG-SYNC]`, `[error-log]` 等
- **Viewer プラグインアーキテクチャ**: 拡張性の高い設計
- **CSS変数の体系的な管理**

### 横断
- **イベント名の整合性**: Go側とフロントエンドの全イベントが一致
- **初期化・シャットダウン順序**: セッションログが最初に準備され最後に閉じられる

---

## タスク一覧・修正時の並列作業可否

以下の表は、各指摘事項を修正する際に**他のタスクと並列で作業可能かどうか**を示します。

| タスクID | 重要度 | 修正概要 | 対象ファイル | 並列作業 | 備考 |
|---------|--------|---------|-------------|---------|------|
| **C-1** | Critical | `sessionLogFile` のロック外アクセス修正 | `app_session_log.go` | ⚠️ C-1のみ単独 | Session Log系は相互依存の為、C-1を先に修正してからI-6,I-7,I-14に着手 |
| **C-2** | Critical | `Parents` コメント修正 or `%P`→`%p` | `app_devpanel_types.go`, `app_devpanel_api.go` | ✅ 可能 | フロントエンドの parent 照合ロジック確認が必要 |
| **C-3** | Critical | `seq` を required に変更 | `errorLogStore.ts` | ⚠️ C-4と同時推奨 | C-4のマージロジック修正と密接に関連 |
| **C-4** | Critical | `setEntries` のマージロジック修正/明確化 | `errorLogStore.ts` | ⚠️ C-3と同時推奨 | C-3の型修正と同じファイル |
| **I-1** | Important | `--` 引数終端挿入 | `app_devpanel_api.go` | ✅ 可能 | 他の修正と独立 |
| **I-2** | Important | `slog.Debug` → `slog.Warn` | `app_devpanel_api.go` | ✅ 可能 | I-1と同一ファイルだが異なる箇所 |
| **I-3** | Important | `bytes.ContainsRune` → `bytes.Contains` | `app_devpanel_api.go` | ✅ 可能 | 2箇所あり。I-1,I-2と同一ファイルだが独立箇所 |
| **I-4** | Important | untracked 収集の `consumedSize` チェック追加 | `app_devpanel_api.go` | ✅ 可能 | 同上 |
| **I-5** | Important | 孤立コメント削除/修正 | `app_devpanel_api.go` | ✅ 可能 | 同上 |
| **I-6** | Important | リングバッファ容量0防御 | `app_session_log_types.go` | ⚠️ C-1完了後 | Session Log系 |
| **I-7** | Important | `cap` 変数名変更 | `app_session_log_types.go` | ⚠️ I-6と同時推奨 | 同一ファイル |
| **I-8** | Important | ログメッセージ分離 | `app_lifecycle.go` | ✅ 可能 | 他の修正と独立 |
| **I-9** | Important | 不要アロケーション除去 | `command_router_handlers_window.go` | ✅ 可能 | tmux系で独立 |
| **I-10** | Important | マルチウィンドウKillテスト追加 | `command_router_handlers_window_test.go` | ✅ 可能 | テスト追加のみ |
| **I-11** | Important | `useRef` 依存配列修正 | `ErrorLogView.tsx` | ✅ 可能 | フロントエンドで独立 |
| **I-12** | Important | HMR対応ガード追加 | `viewerRegistry.ts` | ✅ 可能 | フロントエンドで独立 |
| **I-13** | Important | `new(v)` → `&v` 修正 | `internal/testutil/helpers.go` | ✅ 可能 | 完全に独立 |
| **I-14** | Important | コメント修正（前提条件明記） | `app_session_log.go` | ⚠️ C-1完了後 | C-1と同一ファイル |

### 推奨修正順序

```
Phase 1 (並列可能グループA — DevPanel API修正):
  I-1 + I-2 + I-3 + I-4 + I-5 + C-2 → 全て app_devpanel_api.go / app_devpanel_types.go

Phase 1 (並列可能グループB — 独立修正):
  I-8 (app_lifecycle.go)
  I-9 + I-10 (command_router_handlers_window*.go)
  I-11 + I-12 (Frontend)
  I-13 (testutil/helpers.go)

Phase 1 (並列可能グループC — エラーログストア):
  C-3 + C-4 (errorLogStore.ts) — 同一ファイルだが独立箇所

Phase 2 (グループA完了後):
  C-1 → I-14 → I-6 + I-7 (Session Log系、依存あり)
```

### 並列作業サマリ

| グループ | タスク | 他グループとの並列 |
|---------|--------|-----------------|
| **A: DevPanel API** | C-2, I-1, I-2, I-3, I-4, I-5 | ✅ B, C と並列OK |
| **B: 独立修正** | I-8, I-9, I-10, I-11, I-12, I-13 | ✅ A, C と並列OK |
| **C: エラーログストア** | C-3, C-4 | ✅ A, B と並列OK |
| **D: Session Log** | C-1 → I-14 → I-6, I-7 | ⚠️ 内部は順次。A,B,C とは並列OK |

---

## Recommended Action

1. **Phase 1**: Critical Issues (C-1, C-2, C-3, C-4) を最優先で修正
2. **Phase 2**: Important Issues (I-1 ～ I-14) を上記グループ分けに従い並列修正
3. **Phase 3**: Suggestions は優先度に応じて対応
4. **Phase 4**: 修正後に再レビュー実施
