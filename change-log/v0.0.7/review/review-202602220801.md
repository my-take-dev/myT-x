# 統合 PR Review Summary — 2026-02-22

このレビューレポートは、複数のレビュー結果を重複なく統合したものです。

## Critical Issues (6件)

### C-1: `sessionLogFile` のミューテックス外アクセスによるデータレース (競合)
**対象ファイル**: `app_session_log.go`
**内容**: `needSync` 判定後、ロックを解放してから `a.sessionLogFile.Sync()` を呼び出している部分について。この間に `closeSessionLog()` が実行されると `a.sessionLogFile` が `nil` になる可能性があり、`Sync()` 呼び出しでパニック（nilポインタデリファレンス）が発生します。
**修正案**: ミューテックスを保持したままローカル変数にファイルポインタをキャプチャし、その後で `Sync()` を呼び出すように変更してください。

### C-2: `GitGraphCommit.Parents` のコメントが実装と不一致
**対象ファイル**: `app_devpanel_types.go`, `app_devpanel_api.go`
**内容**: 構造体のコメントでは `short hashes` と記載されていますが、実装（`diff-tree` フォーマットの `%P`）ではフルハッシュが使われています。
**修正案**: コメントを `full hashes` に直すか、実装を短縮ハッシュ `%p` に変更してください。

### C-3: `ErrorLogEntry.seq` 型不一致およびReactキー衝突リスク
**対象ファイル**: `errorLogStore.ts`, `ErrorLogView.tsx`
**内容**: バックエンドでは `Seq` は必須ですが、フロントエンドで `seq?: number` とオプショナルになっています。また、`ErrorLogView.tsx` で `key={entry.seq}` としているため、`seq` が undefined になると全ての要素が同じキーとなりレンダリングが破綻します。
**修正案**:
1. `seq: number` を必須にする。
2. マップ時のキーを `entry.seq ?? 'fallback-${entry.ts}-${i}'` のように安全にする。

### C-4: `setEntries` のマージロジックの設計意図が不明確
**対象ファイル**: `errorLogStore.ts`
**内容**: フルフェッチバックエンドによる ping + fetch モデルにもかかわらず、既存のエントリとのマージロジックが存在し、不要かつデータ不整合の懸念があります。
**修正案**: シンプルなスナップショット全体の置換にするか、マージを維持する理由をコメントで明記してください。

### C-5: `diff-view` ディレクトリが未ステージ
**対象ファイル**: `frontend/src/components/viewer/views/diff-view/*`
**内容**: `ViewerSystem.tsx` などで `diff-view` がインポートされていますが、該当ディレクトリ全体がGitに追加されていないため、クリーンリポジトリでビルドすると失敗します。
**修正案**: `git add frontend/src/components/viewer/views/diff-view/` でファイル群をステージしてください。

### C-6: "Expand hidden lines" ボタンが展開コンテンツを表示しない
**対象ファイル**: `DiffContentViewer.tsx`
**内容**: 展開バーをクリックしてフラグが立っても、その後コンテキスト行をレンダリングする処理が存在せず、何も表示されません。
**修正案**: ボタンを一時的に非表示または無効化するか、コンテキスト行を取得・表示するロジックを実装してください。

---

## Important Issues (20件)

### 【DevPanel 周辺】
- **I-1**: `app_devpanel_api.go` - `commitHash` 引数の前に `--`（オプション終端記号）が未挿入。ハイフン開始のハッシュなどで誤作動の原因となります。
- **I-2**: `app_devpanel_api.go` - untrackedファイルの `DevPanelWorkingDiff` ループ内側 (`buildUntrackedFileDiffs`呼び出し先など) で `consumedSize` 超過チェックが漏れており、大量のファイルで上限を超過します。
- **I-3**: `app_devpanel_api_test.go` - 各種テスト内の `os.WriteFile` や `os.MkdirAll` のエラーハンドリングが握りつぶされており、予期せぬテスト失敗の原因究明が困難になります。
- **I-4**: `app_devpanel_api.go` - `DevPanelWorkingDiff` にて、gitの一般的なエラーが `slog.Debug` 出力になっており、トラブルシュート時に気づけません。`slog.Warn` 推奨。
- **I-5**: `app_devpanel_api.go` - ヌル文字チェックにおける `bytes.ContainsRune(probe, '\x00')` は意図が伝わりにくいため、`bytes.Contains(probe, []byte{0})` または `bytes.IndexByte(probe, 0) >= 0` にしてください。
- **I-6**: `app_devpanel_api.go` - 実装がなく放置された隠しファイルフィルタリング関連の孤立コメントがあります。

### 【フロントエンド Diff View 周辺】
- **I-7**: `diff-view/index.ts` - プラグイン定義に `position` フィールドが設定されていないため、ActivityStrip の配置がデフォルトの `top` となります。意図的でない場合は `bottom` などを明記してください。
- **I-8**: `useDiffView.ts` - 依存配列（`activeSession`）の問題で、セッション変更時に `resetEffect` パターンと `loadDiff` が二重に呼び出され API コールが重複します。
- **I-9**: `DiffFileSidebar.tsx` - `FixedSizeList` コンポーネント用のコンテナ高さの初期値が `400px` とハードコードされており、一瞬レイアウトが崩壊（レイアウトシフト）します。

### 【tmux / ルーター 周辺】
- **I-10**: `command_router_handlers_window.go` - `rollbackSession` が何をロールバックするのかについてコメントが不足しており理解の妨げになります。
- **I-11**: `command_router_handlers_window.go` - `removeWindowAtIndexLocked` 内での最初の不必要な `make` アロケーション（即座に破棄される場合がある）が行われています。
- **I-12**: `command_router_handlers_window_test.go` - マルチウィンドウシナリオにおいて、`wantSessionAlive: true` のケースのユニットテストによるカバーが不足しています。

### 【Session Log / Core 周辺】
- **I-13**: `app_session_log.go` - `sessionLogFile` のミューテックス外アクセスに関して「安全である」と記されたコメントが、実際には安全ではないため、誤認させる内容になっています。C-1対応時に合わせて修正してください。
- **I-14**: `app_session_log_types.go` - `newSessionLogRingBuffer` に容量 `capacity: 0` 防御がないため、ゼロ除算パニックの懸念があります。
- **I-15**: `app_session_log_types.go` - 変数名 `cap` がビルトイン関数の名前を隠蔽（シャドーイング）しています。`bufCap` 等に変更してください。
- **I-16**: `app_lifecycle.go` - 全く別の原因であるにもかかわらず、同じデバッグログメッセージを利用している箇所があります。

### 【フロントエンド エラーログ / 基盤 周辺】
- **I-17**: `errorLogStore.ts` - `unreadCount` の算出ロジックが配列の長さの単純な引き算になっているため、フェッチモデルで新着未読を取りこぼす可能性が高いです。`seq` ベースの差分計算に修正してください。
- **I-18**: `ErrorLogView.tsx` - 依存配列に `useRef` を含めている箇所がありますが、安定参照のため制約なく再レンダリングを起こす等効果がありません。
- **I-19**: `viewerRegistry.ts` - ViteのHMR環境下において、`registry` 変数が適切にクリアされず古い参照が生き残る不具合があります。

### 【その他】
- **I-20**: `testutil/helpers.go` - `new(v)` の利用が誤っています（Go の `new` は型を引数に取るため）。実害は出ていませんが、直すか削除を検討してください。

---

## Suggestions (推奨改善)

1. **S-1**: `app_devpanel_api.go` — WalkDir 内でエラーが出た場合のデバッグログ追加推奨。
2. **S-2**: `app_devpanel_api.go` — 文字列長切り詰めの際にマルチバイト・UTF-8文字の泣き別れを考慮する。
3. **S-3**: `app_devpanel_api.go` — `resolveSessionDir` で線形走査している部分をSessionManagerの引当て機能等で効率化。
4. **S-4**: `app_devpanel_api.go` — `strings.SplitSeq` と `strings.Split` の記述スタイル統一。
5. **S-5**: `app_devpanel_api.go` — `fmt.Sscanf` から `strconv.Atoi` によるオーバーヘッド削減。
6. **S-6**: `app_devpanel_api.go` — `maxCount=100` のマジックナンバーを定数化。
7. **S-7**: `app_devpanel_api_test.go` — 構造体フィールド数を数えるヘルパー関数を共通層へ移動。
8. **S-8**: `app_devpanel_api_test.go` — worktree 制御パスのテスト追加。
9. **S-9**: `app_devpanel_api_test.go` — `bash` 直書きではなく Windows 互換（`cmd.exe` やモック）への置き換え。
10. **S-10**: `session_manager_window_test.go` 等 — `AddWindow` を用いず直接内部配列を操作しているテストについて、安定性のためのヘルパー関数整備。
11. **S-11**: `session_manager_pane_io_test.go` — テスト名が実際の動作内容と不一致になっている名前の見直し。
12. **S-12**: `viewerRegistry.ts` — `position` フィールドのデフォルト動作（undefined なら top）をコメント明示。
13. **S-13**: `DiffContentViewer.tsx` — 複雑な IIFE (即時実行関数) を用いている JSX 埋め込み条件分岐のリファクタ。
14. **S-14**: `diffViewTypes.ts` / `models.ts` — 手動型定義と Wails JSモデルの型重複解消。
15. **S-15**: `useBackendSync.ts` — `let errorLogDebounceTimer` 等のスコープ関連コメント追加。
16. **S-16**: `app_session_log_types.go` — JSON時の `uint64` 精度限界問題の明記。
17. **S-17**: `app_session_log.go` — スロットリング遅延・間隔などの定数・変数のテスト容易性向上。
18. **S-18**: `app_session_log_test.go` — 並行走書き・close状態でのテスト追加充実。
19. **S-19**: `app_session_log_types.go` — `Level` 文字列を `SessionLogLevel` 等の型付定数化。
20. **S-20**: `app_session_log_types.go` — Timestamp にタイムゾーン情報の付加。
21. **S-21**: `app_events.go` — TODO部分に発行元Issueや完了条件などの明記。
22. **S-22**: `app_events.go` — `tmux:pane-destroyed` が発行されない等の理由の記述。
23. **S-23**: `errorLogStore.ts` — 最大上限 `10000` エントリはUIメモリ圧迫リスクがあるため `1000` などの縮小検討。
24. **S-24**: `ViewerSystem.tsx` — ショートカットキーハードコーディングの重複排除。
25. **S-25**: `ActivityStrip.tsx` — React の `useMemo` による view 配列 filter レスポンスのキャッシュ。
26. **S-26**: `ErrorLogView.tsx` — `markAllRead` useEffect の依存関係の意図コメント追加。
27. **S-27**: `viewer.css` — infoレベル用のスタイルが未実装。
28. **S-28**: `base.css` — z-index 階層ツリー・ルールをコメントなどで明記。

---

## Positive Observations (優れていた点)

- **堅牢なパス操作**: シンボリックリンク解決やパストラバーサル防御などが多層的に行われている。
- **TeeHandlerとRingBuffer**: Clean Architecture に準拠し、非同期ログとスレッドセーフなリングバッファ構造により、アロケーションフリーかつ堅牢。
- **アーキテクチャの統一**: バックエンド/フロントエンドでのping型フェッチ通知や重複排除のイベントロジックが美しく、パケット溢れを防げる設計。
- **Windows / 特殊文字配慮**: `"diff-tree"` NUL終端でのパス切り出しや、パスの quoted デコードによりファイルや改行コード等の各種異常系を防御している。

---

## 並列表ワーキング作業票

各担当領域を可能な限り独立させて並列作業が進められるように整理した一覧表です。

| 作業フェーズ | タスクID群 | 重要度 | サマリ | 主な対象ファイル群 | 並列作業可否 / 依存 |
|---|---|---|---|---|---|
| **Phase 1-A** | C-1, I-13 | Critical | セッションログの競合パニック除去 | `app_session_log.go` | 完全独立 (単体作業) |
| **Phase 1-B** | C-3, C-4 | Critical | フロント型修正 / マージロジック改修 | `errorLogStore.ts`, `ErrorLogView.tsx` | 独立並列 |
| **Phase 1-C** | C-5 | Critical | diff-view の Git Add 漏れ追加 | `diff-view/` フォルダ配下 | 独立並列 |
| **Phase 2-C** | C-6, I-7, I-8, I-9 | Critical/Impl | 1-C(Add)完了後の Diff 画面修正一式 | `diff-view/` フォルダ配下 | Phase 1-C 完了待ちで並列可 |
| **Phase 2-A** | C-2, I-1, I-2, I-4, I-5, I-6 | Critical/Impl | DevPanel API 側の各種細かな修正 | `app_devpanel_api.go`, `app_devpanel_types.go` | 独立並列 |
| **Phase 2-D** | I-3, I-10, I-11, I-12 | Impl | tmux, Dev API 等のテスト周り / make除去 | `*_test.go`, `command_router_*.go` | 独立並列 |
| **Phase 2-E** | I-14, I-15, I-16 | Impl | Session Log 構造体, ログメッセージ分離等 | `app_session_log_types.go`, `app_lifecycle.go` | 独立並列 |
| **Phase 2-F** | I-17, I-18, I-19 | Impl | 未読数(unreadCount)、Ref依存、HMR等 | `errorLogStore.ts`, `viewerRegistry.ts` 他 | 独立並列 |
| **Phase X** | I-20, S-1 〜 S-28 | Impl/Sugg | ヘルパー等や提案改善 | その他全般 | 任意で手すきのタイミング |

> **推奨進行フロー**
> - **Worker 1**: Phase 1-A (Go 致命的箇所)
> - **Worker 2**: Phase 1-B (TS/React 致命的箇所)
> - **Worker 3**: Phase 1-C → Phase 2-C (Diff 新機能関連)
> (Phase 1が完了次第、空いた人が順次 Phase 2の各グループに着手する)
