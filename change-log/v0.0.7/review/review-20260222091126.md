# Comprehensive PR Review Report

## 1. 📂 レビュー対象ファイルのカテゴリ分け (サブエージェント並列レビュー用)
効率的にレビューおよび修正が行えるよう、取得した35ファイルの差分を以下のカテゴリに分類しました。

1. **Category A: App Core & DevPanel (Go)**
   - `myT-x_app*`, `myT-x_internal_testutil_helpers.go`
   - ロジック中心。フロントエンドに提供するGit拡張やDiff解析ロジックを含む。
   
2. **Category B: Frontend (TypeScript/React/CSS)**
   - `myT-x_frontend_src_*`
   - エラーログ表示やポーリング機構（Ping + Fetch）、ショートカットとStoreの管理など。

3. **Category C: Tmux Session Management (Go)**
   - `myT-x_internal_tmux_*`
   - 1-window modelの強化に伴うセッション管理の安全確保ロジックや、Terminal破棄漏れ対応など。

4. **Category D: Session Error Log & Handler (Go)**
   - `myT-x_internal_sessionlog_*`
   - TeeHandler を使ったログ収集基盤の並行性確保とエラーハンドリング。

---

## 2. 🚨 レビュー指摘事項 (深く・広範囲の調査結果)

### Category A: App Core & DevPanel (Go)

**[Critical] `app_devpanel_api.go`: 空白を含むファイル名でのパース確実な失敗**
- 対象: `app_devpanel_api.go` の `parseDiffHeaderPaths` および `takeDiffHeaderPathSpec`
- 問題点:
  `git -c core.quotepath=false diff HEAD` を実行した際、スペースを含むファイル名（例: `diff --git a/my file.txt b/my file.txt`）は**ダブルクォーテション (`"`) で囲まれません**。
  現在の実装では `strings.IndexAny(trimmed, " \t")` で最初の空白をパスの終端と見なすため、空白が入った時点でパースに失敗(`ok = false`)し、そのファイルのdiffブロック全体がスキップされる不具合があります（テストコードにクォートなしのスペースを含むファイルパスのケース漏れがあります）。
- 修正案:
  文字列の空白検索（`strings.IndexAny`）に頼るのではなく、` b/` の部分をデリミタとして分割する、または先頭 `a/` パスと `b/` パスが同一長であることを前提にした文字列中心分割等の対応が必要です。

**[Suggestion] 定数値へのポインタ生成 `new(true)` が多用されていることのチーム開発上の注意**
- 対象: `app_session_api_test.go` 等
- 問題点: `testutil.Ptr(true)` から `new(true)` へのリファクタリングが広く行われています。最新の機能や特定のエイリアスによってビルド可能な環境であっても、`new(true)` はイディオムとして直感的でなく（`new` は通常 Type をとる）、保守の観点から新任のエンジニアが混乱する可能性があります。

### Category B: Frontend (TypeScript/React/CSS)

**[Positive] `useBackendSync.ts` と `errorLogStore.ts` の設計改善**
- Ping + Fetch（`app:error-log-updated` イベント到着後に `GetSessionErrorLog` 実行）への移行は、Wails の IPC キュー詰まり時のデータロストを根絶できる大変堅牢な設計です。Debounce (80ms) の導入も適切です。

**[Important] `errorLogStore.ts` における `unreadCount` の安全性に関する追記推奨**
- 対象: `errorLogStore.ts` の `setEntries`
- 問題点:
  `incoming` に含まれる `seq` が全て `state.lastReadSeq` 以下の古いものだった場合でも、正しく `unreadCount` が `0` に計算されるようになっていますが、バッファリング上限 (`MAX_ENTRIES`) によるエビクション（古いログの追い出し）が発生して未読分が消滅した場合、ユーザーには未読数が加算された状態で残る仕様なのか、それとも Snapshot のみに依存する（表示中のみ）なのかをコードコメント等の仕様として明記しておくことを推奨します。現状ロジック自体は安全です。

**[Important] `ViewerSystem.tsx` キーボードショートカット定数の二重管理**
- 対象: `ViewerSystem.tsx` および `viewerRegistry.ts` の各ビュー
- 状況:
  ```typescript
  // Ctrl+Shift+D: toggle Diff.
  if (e.ctrlKey && e.shiftKey && (e.key === "D" || e.key === "d")) { toggleView("diff"); }
  ```
  この実装自体は動作しますが、Diffビューアの `id` を登録する Registry 側 (`shortcut` プロパティ) と、`ViewerSystem.tsx` のハードコーディングとでキーボードショートカットが二重管理になっています。今後、ショートカット変更・追加の際に漏れを生む原因となるため、全ビューのショートカット判定を `ViewerRegistry` から動的に構築する仕組みにリファクタリングすることを推奨します。

### Category C: Tmux Session Management (Go)

**[Positive] 1-window model の厳密なカプセル化**
- 対象: `session_manager_windows.go` およびテストコード
- 複数ウィンドウの内部生成テストを明示的に行い、`DirNext` / `DirPrev` がウィンドウ境界を跨がないことを検証している点は極めて信頼性が高い対応です。Active Window 消失時の自己回復 (`ResolveTargetRepairsStaleActiveWindowID`) も堅牢です。

**[Important] `RemoveWindowByID` の返却プロパティ `Terminal` 等のクリーンアップ漏れ確認**
- 対象: `session_manager_window_test.go` (機能テスト追加部分)
- 問題点: `RemovedPanes` に格納された `Terminal` のポインタが保護され返却されます（`TestRemoveWindowByID_ConcreteTerminalPreserved` の検証）。ただし、これを呼び出しているルーター（コントローラー）層で確実に `Terminal.Close()` やリソースの解放を行っているかどうか、一連のフローを含めて再度全体のコードパスで「不要なプロセスが残存しないか」を確認してください。

### Category D: Session Error Log & Handler (Go)

**[Positive] ファイル出力時のロック競合回避**
- 対象: `sessionlog_handler.go`, `app_session_log.go`
- ログ書き込み直後に `Sync()` を行わず、ロック解放後に `Sync()` を行うように改善された点や、ミューテックス保持中の Wails イベント発行をPingモデルによって最小化した点は、デッドロックや I/O レテンシによるパフォーマンス劣化を防ぐ優れた変更です。

---

## 3. 📋 タスク整理と並列化適正表 (パラレルワーク管理)

指摘されたタスクに関して、複数エージェントや複数人で **並列作業** した場合に生じる競合のリスク（対象ファイルのバッティングや依存関係）を基に、問題ある/無しのステータス表を作成しました。作業者目線での安全な着手順序としてご活用ください。

| タスク ID | 修正/確認事項の概要 | 対象カテゴリ | 主な作業ファイル | 並列作業可否 | コンフリクトの懸念・備考 |
|:-:|---|---|---|:-:|---|
| **T-01**<br>*(優先)* | **`parseDiffHeaderPaths` の空白ファイル名解析バグ修正** | Category A | `app_devpanel_api.go`<br>`app_devpanel_api_test.go` | 🟢 並列可 | バックエンドの内部ロジック変更のみのため、他に影響を与えません。最優先の Critical タスクです。 |
| **T-02** | `new(true)` のポインタの書き換え(またはチーム確認) | Category A,C | `*_test.go` 複数 | 🟡 要注意 | 本体への影響はありませんが、T-01 と同じテストファイルを修正する可能性があります。T-01 完了後に実施推奨。 |
| **T-03** | フロントエンドのショートカットとRegistry定義の二重管理解消 | Category B | `ViewerSystem.tsx`<br>`viewerRegistry.ts` | 🟢 並列可 | フロントエンド固有のUIコンポーネントであり、バックエンド (T-01 等) の作業とは **完全に独立** しています。同時着手可能です。 |
| **T-04** | `RemoveWindowByID` 返却後の `Terminal` リソースクリーンアップのフロー確認 | Category C | (`command_router_*.go`) | 🟢 並列可 | ルーター側の呼び出し元実装に対する仕様確認及び修正。T-01, T-03 とは独立して調査・対応可能です。 |
| **T-05** | `errorLogStore.ts` の未読仕様に対するドキュメント追記 | Category B | `errorLogStore.ts` | 🟢 並列可 | T-03 と領域が異なる（StoreとComponent）ため、同じフロントエンド枠であっても並行作業が容易です。 |

### 💡 作業者へのアドバイス（効率的なアプローチ）
1. **フロントエンド (T-03, T-05) と バックエンド (T-01, T-04) の完全並列:** リポジトリの修正領域が全く重ならないため、これらのタスク群は サブエージェント に同時にアサインして構いません。
2. **Criticalタスク (T-01) の即時着手:** 空白を含むファイル名でのDiff出力失敗・スキップは、DevPanel 利用中に表示が欠落して開発者を混乱させるため、最優先で修正してください。
3. **テスト修正 (T-02) のタイミング:** T-02 に関するテストコードのリファクタリング（必要であれば）は、機能修正 (T-01) が落ちついた最後のフェーズで一括置換で行うと、マージコンフリクトのリスクを低減できます。
