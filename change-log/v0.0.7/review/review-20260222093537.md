# PR Review Summary

- **レビュー日時**: 2026-02-22 09:35:37
- **対象差分**: `D:\myT-x\dev-myT-x\review\temp\*.diff` (全37ファイル)
- **レビューカテゴリ**: 6カテゴリ（並列レビュー実施）

---

## カテゴリ分類

| カテゴリ | 対象ファイル | レビュー概要 |
|---------|------------|------------|
| A. App Core & Lifecycle | `app.go`, `app_lifecycle.go`, `app_events.go`, `app_lifecycle_test.go` | seq 導入、イベント名変更、ログメッセージ改善 |
| B. DevPanel API | `app_devpanel_api.go`, `app_devpanel_api_test.go`, `app_devpanel_types.go` | WorkingDiff 機能の新規追加 |
| C. Session Log | `app_session_log.go`, `app_session_log_test.go`, `app_session_log_types.go`, `app_session_api_test.go` | ping+fetch モデル、seq フィールド、リングバッファ改善 |
| D. Frontend | `api.ts`, `ActivityStrip.tsx`, `ViewerSystem.tsx`, `viewerRegistry.ts`, `ErrorLogView.tsx`, `error-log/index.ts`, `useBackendSync.ts`, `errorLogStore.ts`, `base.css`, `viewer.css` | エラーログUIのseq対応、Diff View追加、viewerRegistry改善 |
| E. Internal SessionLog & TestUtil | `internal/sessionlog/handler.go`, `handler_test.go`, `internal/testutil/helpers.go` | TeeHandler改善、Ptr関数のinline化 |
| F. Tmux | `command_router_env_test.go`, `handlers_window.go`, `handlers_window_test.go`, `session_manager_*.go/test.go` | 1-window model 対応、ロールバック改善、テスト追加 |

---

## Critical Issues (2件)

### CRIT-01: [code] `new(true)` / `new(false)` はGo言語でコンパイルエラー
- **ファイル**: `app_session_api_test.go`, `command_router_env_test.go`, `command_router_handlers_window_test.go`
- **該当行**: 全 `new(true)` / `new(false)` の使用箇所
- **説明**: Go言語の `new()` ビルトイン関数は型（type）を引数に取るため、`new(true)` や `new(false)` はコンパイルエラーとなる。`testutil.Ptr(true)` を `new(true)` に一括置換しているが、これは不正。
- **背景**: `testutil.Ptr` に `//go:fix inline` ディレクティブが追加されており、`go fix ./...` によって自動インライン化された結果と推察される。Go 1.26 の `go fix` がこの変換をサポートしている可能性があるが、標準的な Go では `new(T)` は型引数のみを受け付ける。
- **影響**: Go 1.26 の `go fix` による自動変換であり、Go 1.26 環境でビルドが通る前提であれば問題無い可能性がある。CLAUDE.md に「Go言語は、1.26が最新」「go fix ./... を用いてコードをモダン化」と記載があるため、Go 1.26 固有の新構文として許容される可能性がある。
- **推奨**: Go 1.26 で `new(true)` 構文がサポートされていること（テンプレートリテラルのnew構文）を確認の上、全置換箇所が正しいことを検証すること。もし非対応であれば全箇所を `testutil.Ptr(true)` へ戻す必要がある。

**影響箇所一覧（漏れなし）**:
| ファイル | 変更箇所 |
|---------|---------|
| `app_session_api_test.go` | 6箇所: `testutil.Ptr(true)` → `new(true)` |
| `command_router_env_test.go` | 12箇所: `testutil.Ptr(true/false)` → `new(true/false)` |
| `command_router_handlers_window_test.go` | 2箇所: `boolPtr(true/false)` → `new(true/false)` |

### CRIT-02: [code] `DevPanelCommitDiff` の `--` とcommitHashの引数順序
- **ファイル**: `app_devpanel_api.go:473`
- **変更前**: `[]string{"diff-tree", "--root", "-p", commitHash}`
- **変更後**: `[]string{"diff-tree", "--root", "-p", "--", commitHash}`
- **説明**: `--` は「以降はオプションではなくパス指定」というGitの慣例。しかし `diff-tree` では `--` の後はパスフィルタとして解釈されるため、commitHash が tree-ish ではなくパスとして扱われる可能性がある。`git diff-tree` のシンタックスは `git diff-tree [options] <tree-ish> [<path>...]` であり、`--` はオプション終端を示す。commitHash はバリデーション済みのコミットハッシュであるため、`--` の前に置くべき。
- **推奨**: `--` を commitHash の**後**に移動する: `[]string{"diff-tree", "--root", "-p", commitHash, "--"}`、もしくは `--` を完全に削除して元の形に戻す。commitHashは ValidateCommitish でバリデーション済みのため、`--` 無しでもインジェクションリスクはない。

---

## Important Issues (8件)

### IMP-01: [errors] `DevPanelWorkingDiff` - `git diff HEAD` のエラー処理が寛容すぎる
- **ファイル**: `app_devpanel_api.go:73-81`
- **説明**: `git diff HEAD` が失敗した場合にWarnログを出して空の output で続行している。フレッシュリポジトリ（コミットゼロ）のケースは正当だが、他のエラー（ディスクI/Oエラーなど）も同様に無視される。
- **推奨**: エラー種別を判別し、HEADが存在しない場合（`exit status 128` + "unknown revision" メッセージ）のみ空outputで続行、それ以外はエラー返却する。

### IMP-02: [code] `parseWorkingDiff` で `\r\n` 正規化後、diff ブロックにはCRLFが残る
- **ファイル**: `app_devpanel_api.go:279-280`
- **説明**: `raw` 文字列の改行は正規化されるが、各ファイルの `block` (= `"diff --git " + part`) にはCRLF正規化後の文字列が格納される。問題ないように見えるが、`block` を `file.Diff` フィールドに格納する際、元の `raw` からではなく前処理済み文字列なのでフロントエンドの差分表示が微妙にオリジナルと異なる可能性がある。
- **推奨**: ドキュメントにこの正規化の意図的な動作を記載するか、元のraw文字列から各ブロックの開始・終了位置を計算する方法を検討する。

### IMP-03: [types] `WorkingDiffFile.Status` が文字列型で型安全でない
- **ファイル**: `app_devpanel_types.go:23`
- **説明**: `Status` フィールドが `string` 型で、コメントに `"modified" | "added" | "deleted" | "renamed"` と記載されているが、実装では `"untracked"` も使われている (`buildUntrackedFileDiffSingle`)。コメントとの不一致。
- **推奨**: コメントの Status リストに `"untracked"` を追加する。また、将来的には `type DiffFileStatus string` のような名前付き型を定義して列挙値を定数化することを検討。

### IMP-04: [errors] `buildUntrackedFileDiffs` walkのエラーハンドリング
- **ファイル**: `app_devpanel_api.go:184`
- **説明**: `filepath.WalkDir` のエラー返り値を `_ =` で無視している。WalkDir 自体がエラーを返す場合（権限不足等）も含めて無視される。
- **推奨**: WalkDir の戻り値エラーをログ出力するか、少なくともデバッグログに残す。

### IMP-05: [code] `errorLogStore.ts` - `normalizeEntries` がseq無効なエントリを静かに除外
- **ファイル**: `frontend/src/stores/errorLogStore.ts:22-24`
- **説明**: `isValidSeq` で `seq > 0` かつ有限数でないエントリをフィルタリングしているが、バックエンドから万一 seq=0 のエントリが来た場合、UIに表示されなくなる。デバッグが困難。
- **推奨**: `import.meta.env.DEV` ガード付きで、フィルタで除外されたエントリ数を `console.warn` で出力する。

### IMP-06: [tests] `TestBuildUntrackedFileDiffSingle` - `devPanelMaxUntrackedFileSize` 超過テスト欠如
- **ファイル**: `app_devpanel_api_test.go`
- **説明**: `buildUntrackedFileDiffSingle` のテストでバイナリファイル・ディレクトリ・不在ファイルはカバーされているが、100KB (`devPanelMaxUntrackedFileSize`) を超えるファイルに対するスキップ動作のテストが無い。
- **推奨**: 100KB超のテキストファイルを生成してnilが返ることを確認するテストケースを追加。

### IMP-07: [code] `TeeHandler.Handle` のコールバック内パニック未考慮
- **ファイル**: `internal/sessionlog/handler.go:51-54`
- **説明**: callback がパニックした場合、baseハンドラのエラーが失われる。callbackは呼び出し元（writeSessionLogEntry）内だが、callbackのrecover処理がないため、パニックが伝搬する。
- **推奨**: callback呼び出しを `defer/recover` で囲むか、少なくともこの動作についてコメントで明記する。

### IMP-08: [code] `syncFile`の参照がロック外で使用される安全性
- **ファイル**: `app_session_log.go:138-143`
- **説明**: `syncFile = a.sessionLogFile` でファイルポインタをロック下でキャプチャし、ロック解放後に `syncFile.Sync()` を呼んでいる。`closeSessionLog()` が並行して呼ばれた場合、ファイルが既にCloseされた状態で Sync() が呼ばれる可能性がある。
- **推奨**: ファイルclose競合の可能性について、closeSessionLogが呼ばれるタイミング（シャットダウン時のみ）を考慮の上、許容範囲かどうかコメントで明記する。シャットダウン時は新規ログ書き込みが停止するため、実質的なリスクは低いが明記しておくべき。

---

## Suggestions (12件)

### SUG-01: [simplify] `viewer.css` - `.diff-expand-bar:hover` のスタイルが非hover時と同一
- **ファイル**: `frontend/src/styles/viewer.css:134-137`
- **説明**: `.diff-expand-bar:hover` の `background` と `color` が通常状態と同じ値に設定されており、hoverエフェクトが実質的に無い。意図的であれば問題ないが、通常はhover時に視覚的フィードバックを提供する。
- **推奨**: hover効果を意図的に無効化しているのであれば、コメントで理由を記載。そうでなければ、`background` を若干変更（例: `var(--accent-10)`）してhoverフィードバックを提供する。

### SUG-02: [comments] `collectUntrackedFiles` のコメントが文字化け
- **ファイル**: `app_devpanel_api.go:131-133`
- **説明**: コメントがUTF-8エンコードの問題で文字化けしている（`縺ｨ` 等の文字列）。日本語コメントがShift-JISまたはEUC-JPで保存されたように見える。
- **推奨**: CLAUDE.mdの「全てUTF8でBOM無し」ルールに違反している。コメントをUTF-8で再エンコードして修正する。

### SUG-03: [simplify] `devPanelMaxDiffSize` が `DevPanelWorkingDiff` で参照されるが定義差分に無い
- **ファイル**: `app_devpanel_api.go:85,96,102`
- **説明**: `devPanelMaxDiffSize` が複数箇所で参照されているが、この定数の定義が本差分に含まれていない。既存コードに定義があるものと推測されるが確認が必要。
- **推奨**: 既存定義の確認。また、`devPanelMaxDiffSize` と `devPanelMaxUntrackedFileSize` の関係性をコメントで明記すると可読性が向上する。

### SUG-04: [code] `viewerRegistry.ts` - HMR dispose でregistryをクリアするが、再登録タイミングの保証
- **ファイル**: `frontend/src/components/viewer/viewerRegistry.ts:40-44`
- **説明**: `import.meta.hot.dispose` でレジストリをクリアしているが、HMR再実行時に各ビューの `registerView` が確実に再呼び出されることが前提。モジュール依存関係によっては再登録が遅延する可能性。
- **推奨**: HMR使用時の再登録順序について、開発時に問題が発生していないか確認。問題があれば `import.meta.hot.accept` 側で明示的に再登録をトリガーする。

### SUG-05: [simplify] `ErrorLogView.tsx` - `useEffect` の依存配列を空配列に変更
- **ファイル**: `frontend/src/components/viewer/views/error-log/ErrorLogView.tsx:10,19`
- **説明**: 2つの `useEffect` で依存配列を `[bodyRef]` から `[]` に変更。`bodyRef` は `useRef` で作成されるため参照は不変であり、変更は正しい。Reactの lint ルール（exhaustive-deps）でも ref は依存に含める必要がないため妥当。
- **評価**: 問題なし、適正な修正。

### SUG-06: [code] `ActivityStrip.tsx` - `renderViewButton` に `key` を設定
- **ファイル**: `frontend/src/components/viewer/ActivityStrip.tsx`
- **説明**: `renderViewButton` 内で `<button>` に `key={view.id}` を設定しているが、`.map(renderViewButton)` 形式で呼び出す場合、`key` は JSX の属性ではなく配列要素のキーとして機能しない。Reactの `key` はリスト内で直接レンダリングされる要素に設定する必要がある。
- **推奨**: `.map((view) => renderViewButton(view))` ではなく、現在の `.map(renderViewButton)` では React がインデックスベースの key を使用する可能性がある。`key` が `<button>` の props に含まれているので、React はこれを正しく `key` として認識する。動作上は問題ないが、明示的に `.map((view) => <Fragment key={view.id}>{renderViewButton(view)}</Fragment>)` パターンを使うと意図が明確になる。

### SUG-07: [code] `parseWorkingDiff` の additions/deletions カウントロジック
- **ファイル**: `app_devpanel_api.go:329-333`
- **説明**: `+` で始まるが `+++` で始まらない行を additions、`-` で始まるが `---` で始まらない行を deletions としてカウントしている。これは標準的な unified diff の解析として正しいが、`++++` のような行が来た場合にカウントされる。実務上はほぼ発生しないが、厳密には `@@ ` で始まるハンクヘッダ以降のみカウントすべき。
- **推奨**: 現状で実用上問題なし。厳密性を求める場合はハンクヘッダ検出後のみカウントするよう修正。

### SUG-08: [code] `buildUntrackedFileDiffSingle` で `\r\n` 改行のファイルが考慮されていない
- **ファイル**: `app_devpanel_api.go:242`
- **説明**: `strings.Split(content, "\n")` でファイルを行分割しているが、Windows環境のファイルは `\r\n` 改行の可能性がある。その場合、各行末に `\r` が残りdiffに表示される。
- **推奨**: Windowsアプリケーションであるため、`\r\n` → `\n` の正規化を行分割前に追加するか、`strings.ReplaceAll(content, "\r\n", "\n")` を適用する。

### SUG-09: [code] `newSessionLogRingBuffer(0)` のクランプにテスト追加済み（良好）
- **ファイル**: `app_session_log_types.go:24-26`, `app_session_log_test.go:203-220`
- **説明**: `capacity < 1` の場合に `1` にクランプする防御コードが追加されており、対応するテストも追加されている。良好な変更。

### SUG-10: [code] リングバッファの `cap` → `bufCap` リネーム
- **ファイル**: `app_session_log_types.go`
- **説明**: Go の組み込み関数 `cap()` とのシャドウイングを回避するために `cap` を `bufCap` にリネーム。正しい対応。

### SUG-11: [code] snapshot の `min()` ビルトイン使用
- **ファイル**: `app_session_log_types.go:66`
- **説明**: `if first > rb.count { first = rb.count }` を `first := min(bufCap-rb.head, rb.count)` に簡略化。Go 1.21+ の `min` ビルトインの活用で可読性が向上。

### SUG-12: [tests] テスト内のマルチウィンドウ状態構築パターンの重複
- **ファイル**: `session_manager_window_test.go`, `session_manager_directional_test.go`, `command_router_handlers_window_test.go`
- **説明**: 複数のテストで `manager.mu.Lock()` → `secondWindow` / `secondPane` 作成 → `manager.mu.Unlock()` という同一パターンが繰り返されている（5箇所以上）。AddWindow APIが削除されたため直接操作が必要だが、ヘルパー関数に切り出すとメンテナンス性が向上する。
- **推奨**: `injectTestWindow(t, manager, sessionName, windowName string) (*TmuxWindow, *TmuxPane)` のようなテストヘルパーを作成し、重複を排除する。

---

## Strengths（良い点）

1. **ping+fetch モデルへの移行**: イベントからペイロードを除去し、フロントエンドがスナップショットをfetchする設計に変更。これによりスロットリング時のデータロス問題が根本的に解消される。アーキテクチャ的に優れた改善。

2. **seq フィールドの導入**: 秒精度のタイムスタンプに依存した重複排除から、単調増加シーケンス番号による安定した identification に変更。フロントエンドの `key` にも `seq` を使用し、Reactの再レンダリング効率も向上。

3. **リングバッファの堅牢化**: `capacity < 1` のクランプ、`bufCap == 0` のガード、`cap` → `bufCap` リネーム、`min()` ビルトイン使用など、防御的プログラミングが適切に適用されている。

4. **Sync()のロック外移行**: ディスクI/OレイテンシがsessionLogMuのロック保持時間に影響しないよう、`syncFile` をキャプチャしてロック外でSyncする設計。ロック粒度の最適化として良い。

5. **TeeHandlerのcallback独立化**: base handlerのエラーに関わらずcallbackが呼び出されるよう変更。disk-full時でもUI通知が可能になり、ユーザー体験が向上。

6. **viewerRegistry のグローバルシングルトン化とHMR対応**: `globalThis` を使ったレジストリの永続化とHMR dispose対応により、開発時のホットリロードが安定。既存エントリの更新（上書き）もサポート。

7. **1-window model のドキュメント充実**: コメントで1-window model の設計意図とマルチウィンドウ復活時のガイドラインが明記されている。将来のメンテナに対する配慮がある。

8. **テストカバレッジの充実**: 新機能（WorkingDiff、seq、ping+fetch）に対して十分なテーブル駆動テストが追加されている。フィールドカウントガードテストも含まれている。

---

## Recommended Action

1. **CRIT-01**: `new(true)` の Go 1.26 対応を確認。非対応なら全箇所を `testutil.Ptr()` に戻す
2. **CRIT-02**: `diff-tree` の `--` の位置を修正
3. **IMP-01〜08**: 各指摘を確認し対応判断
4. **SUG-02**: 文字化けコメントの修正（CLAUDE.mdルール違反）
5. **SUG-08**: Windows環境での `\r\n` 改行ファイルの考慮追加
6. **SUG-12**: テストヘルパー関数の作成

---

## 並列作業可否判定表

以下の表は、各修正タスクを並列で実施する際の安全性を示しています。

### 凡例
- ⭕ = 並列作業可能（他タスクと依存無し）
- ⚠️ = 条件付き並列可能（記載の注意事項を守れば並列可能）
- ❌ = 順次作業必要（他タスクの完了を待つ必要あり）

| タスクID | 概要 | 対象ファイル | 並列可否 | 依存先 | 備考 |
|---------|------|------------|---------|-------|------|
| CRIT-01 | `new(true/false)` → Go 1.26対応確認 | `app_session_api_test.go`, `command_router_env_test.go`, `command_router_handlers_window_test.go` | ⭕ | なし | Go 1.26の `new()` 仕様確認が先決。非対応なら3ファイル同時修正可能（各ファイルの変更は独立） |
| CRIT-02 | `diff-tree` の `--` 位置修正 | `app_devpanel_api.go` | ⚠️ | IMP-01, SUG-03と同ファイル | 同ファイル内だが変更箇所が離れているため、同時編集しなければ並列可 |
| IMP-01 | `git diff HEAD` エラー種別判別 | `app_devpanel_api.go` | ⚠️ | CRIT-02と同ファイル | CRIT-02とは変更箇所が異なるため条件付き並列可能 |
| IMP-02 | `parseWorkingDiff` CRLF正規化のドキュメント化 | `app_devpanel_api.go` | ⚠️ | CRIT-02, IMP-01と同ファイル | コメント追加のみ。変更箇所が離れていれば並列可 |
| IMP-03 | `WorkingDiffFile.Status` コメント修正 | `app_devpanel_types.go` | ⭕ | なし | 独立したファイル |
| IMP-04 | `buildUntrackedFileDiffs` WalkDirエラーログ出力 | `app_devpanel_api.go` | ⚠️ | CRIT-02, IMP-01, IMP-02と同ファイル | 変更箇所は独立 |
| IMP-05 | `normalizeEntries` フィルタ除外ログ追加 | `frontend/src/stores/errorLogStore.ts` | ⭕ | なし | フロントエンド独立ファイル |
| IMP-06 | ファイルサイズ超過テスト追加 | `app_devpanel_api_test.go` | ⭕ | なし | テストファイルへの追加のみ |
| IMP-07 | TeeHandler callbackパニック対策 | `internal/sessionlog/handler.go` | ⭕ | なし | 独立モジュール |
| IMP-08 | syncFile競合リスクのコメント追記 | `app_session_log.go` | ⭕ | なし | コメント追加のみ |
| SUG-01 | `diff-expand-bar:hover` スタイル修正 | `frontend/src/styles/viewer.css` | ⭕ | なし | CSS独立 |
| SUG-02 | 文字化けコメント修正 | `app_devpanel_api.go` | ⚠️ | CRIT-02, IMP-01等と同ファイル | 変更箇所は独立 |
| SUG-08 | CR/LF改行正規化追加 | `app_devpanel_api.go` | ⚠️ | CRIT-02等と同ファイル | `buildUntrackedFileDiffSingle` 内の変更 |
| SUG-12 | テストヘルパー関数作成 | 新規ファイル + テスト複数ファイル | ❌ | CRIT-01 | ヘルパー作成後にテストファイルを修正するため順次作業 |

### 並列作業グループ提案

効率的に修正を進めるため、以下のグループ分けを推奨します。

#### グループ1: Go バックエンド - DevPanel API（同一ファイル集中修正）
**順次作業推奨**: `app_devpanel_api.go` に集中する CRIT-02, IMP-01, IMP-02, IMP-04, SUG-02, SUG-08 をまとめて1人が対応
- 作業者: 1名
- 対象: `app_devpanel_api.go` 関連すべて

#### グループ2: Go バックエンド - Session Log & Types
⭕ グループ1と並列可能
- 作業者: 1名
- 対象: IMP-03(`app_devpanel_types.go`), IMP-08(`app_session_log.go`)

#### グループ3: Go バックエンド - Internal モジュール
⭕ グループ1, 2と並列可能
- 作業者: 1名
- 対象: IMP-07(`internal/sessionlog/handler.go`)

#### グループ4: Go テスト修正
⭕ グループ2, 3と並列可能 / ⚠️ グループ1完了後にSUG-12着手
- 作業者: 1名
- 対象: CRIT-01（全テストファイル）, IMP-06(`app_devpanel_api_test.go`), SUG-12

#### グループ5: フロントエンド修正
⭕ 全Goグループと並列可能
- 作業者: 1名
- 対象: IMP-05(`errorLogStore.ts`), SUG-01(`viewer.css`)

### 作業順序の簡易フロー

```
[並列開始]
├── グループ1: DevPanel API 修正（CRIT-02 → IMP-01 → IMP-02 → IMP-04 → SUG-02 → SUG-08）
├── グループ2: Session Log & Types 修正（IMP-03, IMP-08）
├── グループ3: Internal モジュール修正（IMP-07）
├── グループ4: テスト修正（CRIT-01）
│   └── ※ CRIT-01完了後 → SUG-12（テストヘルパー作成）→ IMP-06
└── グループ5: フロントエンド修正（IMP-05, SUG-01）
[全グループ完了] → 統合確認 → ビルド & テスト実行
```
