# PR Review: コミット前 myT-x 差分レビュー
**日時:** 2026-02-22 12:29:55  
**対象:** `git diff HEAD -- myT-x/`  
**レビュー方式:** カテゴリ別並列レビュー（6エージェント）

---

## 変更概要

| カテゴリ | 主な変更内容 |
|---|---|
| A: Go バックエンド Core | DevPanelWorkingDiff 新機能、ログプレフィックス整理 |
| B: Session Log | ping+fetch アーキテクチャ移行、SeqNo 追加、TeeHandler 改善 |
| C: Frontend | errorLogStore seq ベース管理、ViewerRegistry グローバル化、callback ref 化 |
| D: tmux internal | 1-window モデル cleanup、handleNewWindow rollback 改善 |
| E: テストコード | 新規テスト大量追加、testutil.Ptr → new() 移行 |
| F: 横断的観点 | API 整合性、セキュリティ、パフォーマンス確認 |

---

## Critical Issues（マージ前必須修正）

### [A-CRIT-1] `buildUntrackedFileDiffSingle` のシンボリックリンクによるパストラバーサル
**ファイル:** `myT-x/app_devpanel_api.go`（`buildUntrackedFileDiffSingle` 関数）  
**優先度:** Critical

**問題:**  
`isPathWithinBase(absPath, workDir)` は `filepath.Rel` ベースのレキシカルなパス比較のみを行い、ファイルシステム上のシンボリックリンクを解決しない。  
一方 `DevPanelReadFile` に使われる `resolveAndValidatePath` は `filepath.EvalSymlinks` による二段保護を持つ。この非対称性が穴になる。

```
# 攻撃シナリオ
workDir/evil-link -> /etc/passwd   (untracked symlink)
git ls-files --others が evil-link を報告
isPathWithinBase("/workDir/evil-link", "/workDir") = true  ← パストラバーサル通過
os.ReadFile("/workDir/evil-link") は /etc/passwd を読む
```

**推奨修正:**

```go
// os.Stat → os.Lstat に変更してシンボリックリンク追跡を防ぐ
info, err = os.Lstat(absPath)
if err != nil { ... }
// シンボリックリンクはスキップ
if info.Mode()&os.ModeSymlink != 0 {
    slog.Debug("[DEVPANEL] skipping symlink in untracked files", "path", relPath)
    return nil
}
```

または追加でシンボリックリンク解決後に再チェック:

```go
resolvedWorkDir, _ := filepath.EvalSymlinks(workDir)
resolvedAbs, err := filepath.EvalSymlinks(absPath)
if err != nil { return nil }  // 壊れたシンボリックリンクもスキップ
if !isPathWithinBase(resolvedAbs, resolvedWorkDir) {
    slog.Warn("[DEVPANEL] untracked path escapes workDir after symlink resolution", "path", relPath)
    return nil
}
```

---

## Important Issues（修正推奨）

### [A-IMP-1] `removeWindowAtIndexLocked` のコメントと実装が矛盾
**ファイル:** `myT-x/internal/tmux/session_manager_windows.go`（~L108-L119）

**問題:**  
コメント「Always initialize to an empty slice (not nil)」に対し、`var removedPanes []*TmuxPane` は nil で宣言している。  
else 分岐で必ず `make` が呼ばれるため動作は正しいが、コメントの保証をコードで体現していない。

**推奨修正:**

```go
// Before
var removedPanes []*TmuxPane
if window != nil && len(window.Panes) > 0 {
    removedPanes = make([]*TmuxPane, len(window.Panes))
    copy(removedPanes, window.Panes)
} else {
    removedPanes = make([]*TmuxPane, 0)
}

// After: コメントを体現する構造に
removedPanes := make([]*TmuxPane, 0)
if window != nil && len(window.Panes) > 0 {
    removedPanes = make([]*TmuxPane, len(window.Panes))
    copy(removedPanes, window.Panes)
}
```

---

### [A-IMP-2] DevPanel 関連ログプレフィックスの不整合
**ファイル:** 複数ファイル

**問題:**  
今回 `[DEBUG-DEVPANEL]` → `[DEVPANEL]` への変更が行われたが、他のファイルでは `[DEBUG-*]` プレフィックスが残存している。  
grep による一括削除運用が部分的に壊れる。

| ファイル | 残存プレフィックス |
|---|---|
| app_events.go | `[DEBUG-EVENT]` |
| app_lifecycle.go | `[DEBUG-HOTKEY]`, `[DEBUG-IPC]`, `[DEBUG-SHIM]`, `[DEBUG-CONFIG]` |
| app_pane_api.go | `[DEBUG-PANE]` |
| command_router_handlers_window.go | `[DEBUG-WINDOW]` |

**推奨:** 今後のプレフィックス方針を統一する。削除予定のデバッグログを `[DEBUG-*]` に集約するか、全て廃止して `[<MODULE>]` 形式に移行するかを決定。

---

### [A-IMP-3] `collectUntrackedFiles` の出力サイズ上限なし
**ファイル:** `myT-x/app_devpanel_api.go`（`parseNULSeparatedGitPaths`）

**問題:**  
`.gitignore` が不完全な大規模リポジトリ（node_modules 未除外など）では `git ls-files` が数万エントリを返す可能性があり、全件を `strings.Split` でメモリ展開する。  
diff サイズは `devPanelMaxDiffSize` で制限されるが、スライス確保は先行するため OOM の温床になりえる。

**推奨修正:**

```go
const maxUntrackedFilePaths = 10000

func parseNULSeparatedGitPaths(raw []byte) []string {
    entries := strings.Split(string(raw), "\x00")
    paths := make([]string, 0, min(len(entries), maxUntrackedFilePaths))
    for _, entry := range entries {
        if entry == "" {
            continue
        }
        if len(paths) >= maxUntrackedFilePaths {
            break
        }
        paths = append(paths, filepath.ToSlash(entry))
    }
    return paths
}
```

---

### [A-IMP-4] `app_events.go` の日本語・英語コメント重複
**ファイル:** `myT-x/app_events.go`（~L149）

**問題:**  
英語の NOTE コメントが上部に追加されたが、日本語の旧コメントが以下の重複として残存：

```go
// NOTE(1-window model): 現在のアーキテクチャは 1 セッション = 1 ウィンドウ構成。
// セッションごとにウィンドウは常に 1 つしか存在しないため、ウィンドウ関連イベントは
// 実行時には発行されない。...
```

英語版のみ残し、旧日本語コメントを削除する。

---

### [A-IMP-5] `rollbackSession` 内の `[DEBUG-WINDOW]` ログがプロダクション重要ログ
**ファイル:** `myT-x/internal/tmux/command_router_handlers_window.go`（~L285）

**問題:**  
```go
slog.Warn("[DEBUG-WINDOW] failed to remove session during rollback", ...)
```
`[DEBUG-WINDOW]` プレフィックスを持つが、これはロールバック失敗という本番でも問題になりえる重大な事象。  
一括削除時に重要な障害情報が消える。

**推奨:** `[WARN-WINDOW]` または `[WINDOW]` に変更。

---

### [A-IMP-6] `WorkingDiffStatus = string` のコメントが技術的に不正確
**ファイル:** `myT-x/app_devpanel_types.go`（~L50）

**問題:**  
```go
// NOTE: ... a defined type would require custom MarshalJSON/UnmarshalJSON
// to round-trip correctly through the Wails IPC layer.
```
`type WorkingDiffStatus string` は `encoding/json` 標準で追加実装なしに文字列としてシリアライズされる。コメントの技術的説明が不正確。

**推奨修正:**
```go
// NOTE: This is a type alias (= string), not a defined type. Using a type alias
// allows the Wails TypeScript binding generator to emit the fields as plain
// string literals in the generated .d.ts, enabling direct use of string constants
// ("modified", "added", etc.) on the frontend without additional type casting.
// Trade-off: type safety at compile time is sacrificed.
```

---

### [B-IMP-1] `handler.go` `return err` 変更による slog 二重出力の可能性
**ファイル:** `myT-x/internal/sessionlog/handler.go`（~L72）

**問題:**  
Go の `log/slog` は `Handle()` がエラーを返すと内部的に `fmt.Fprintf(os.Stderr, "slog: %v\n", err)` を出力する。  
旧 `return nil` では発生しなかったこの二重出力が、base handler failure 時に起きうる。

**推奨:** コメントでこの副作用を明記：
```go
// NOTE: Returning the base error here may cause slog's internal error reporter
// to emit "slog: <err>" to stderr in addition to any logging done by callers.
// This is acceptable: the callback (UI notification) takes priority over
// suppressing the secondary stderr output.
return err
```

---

### [B-IMP-2] `initSessionLog()` のロック外フィールド書き込み
**ファイル:** `myT-x/app_session_log.go`（~L25-L41）

**問題:**  
`a.sessionLogFile = f` と `a.sessionLogPath = fullPath` が `sessionLogMu` なしで書き込まれている。  
現状は `slog.SetDefault` 前に呼ばれるため安全だが、将来の変更時に data race を引き起こすリスクがある。

**推奨:** 安全性の前提条件をコメントで明示：
```go
// Direct field assignment is safe: initSessionLog() is always called before
// slog.SetDefault(teeHandler), so no concurrent writeSessionLogEntry() exists.
```

---

### [C-IMP-1] `bodyRef` の二重オーナーシップ問題
**ファイル:** `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx`

**問題:**  
`useErrorLog` フックが内部で `useRef` を生成・公開し、`ErrorLogView` が callback ref 内で `bodyRef.current = el` と直接書き換えている。  
これはフックの内部状態をコンシューマーが破壊できる設計（レイヤー越境）。

**推奨:** `useErrorLog` から `bodyRef` を公開するのをやめ、`registerBodyElement: (el: HTMLDivElement | null) => void` 形式のコールバックを返す。

---

### [C-IMP-2] バックエンド単独再起動時の `lastReadSeq` リセット問題
**ファイル:** `myT-x/frontend/src/stores/errorLogStore.ts`

**問題:**  
バックエンドプロセス再起動後 seq が 1 から振り直された場合、フロントエンドで `lastReadSeq = 500` (例) のまま残ると、新規エントリ (seq 1〜500) が全て「既読」として処理される。  

**確認事項:** このアーキテクチャでバックエンド単独再起動が発生しうるか確認。発生しうる場合は再起動を検知して `lastReadSeq = 0` にリセットするロジックが必要。

---

### [C-IMP-3] `bodyRefCallback` の deps が `[bodyRef]` だが実質 `[]`
**ファイル:** `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx`

**問題:**  
`useRef` の返り値は生涯同一オブジェクトのため `[bodyRef]` という deps は `[]` と等価。  
eslint-plugin-react-hooks の exhaustive-deps に従えばこの書き方は混乱を招く。

**推奨:** `[]` に変更。

---

### [D-IMP-1] C-7b テストが C-7 の検証パターンを踏襲していない
**ファイル:** `myT-x/internal/tmux/session_manager_window_test.go`（~L417）

**問題:**  
`TestRemoveWindowByID_NonActiveWindowKeepsActiveID` は `result.SurvivingWindowID` だけを確認する。  
`TestRemoveWindowByID_ActiveWindowTransitions` と同様に `GetSession()` → `afterSession.ActiveWindowID` の直接検証を追加することで、将来の実装変更を即座に捉えられる。

---

### [E-IMP-1] `TestTeeHandler_WithGroupEmpty_PreservesExistingGroup` の型アサーションが unsafe
**ファイル:** `myT-x/internal/sessionlog/handler_test.go`

**問題:**  
```go
grouped := h.WithGroup("foo").(*TeeHandler)
```
型アサーションが失敗すると `runtime error: interface conversion` パニックとなりテスト内容ではなくランタイムエラーとして報告される。

**推奨:**
```go
got, ok := h.WithGroup("foo").(*TeeHandler)
if !ok {
    t.Fatalf("WithGroup(\"foo\") returned %T, want *TeeHandler", h.WithGroup("foo"))
}
grouped := got
```

---

### [E-IMP-2] `TestWriteSessionLogEntry_EmitsCorrectEventName` のアサーション順序が false-positive リスク
**ファイル:** `myT-x/app_session_log_test.go`

**問題:**  
```go
if capturedEventName != tt.expectedEventName {
    t.Errorf(...)  // non-fatal → 後続継続
}
if capturedPayload != nil {  // emit されなかった場合も nil で偽陽性
    t.Errorf(...)
}
```
イベントが一度も emit されなかった場合、両チェックが通過（偽陽性）する。

**推奨:** 1つ目のチェックを `t.Fatalf` に変更。

---

## Suggestions（改善提案）

### [A-SUG-1] `isFreshRepo` のログメッセージが誤解を招く
**ファイル:** `myT-x/app_devpanel_api.go`（~L441）

`headErr != nil` の理由が "fresh repo" 以外（git バイナリ不在、権限エラー等）にもありえる。  
推奨: `"HEAD not resolvable (possibly fresh repo or git error), falling back to untracked-only"`

---

### [A-SUG-2] WalkDir コールバックで `d.Info()` を `buildUntrackedFileDiffSingle` に渡していない
**ファイル:** `myT-x/app_devpanel_api.go`（~L530）

WalkDir コールバックでは `d.Info()` が利用可能で追加 `os.Stat` を省略できる。多数ファイル処理時の I/O 削減になる。

---

### [A-SUG-3] `parseDiffHeaderPaths` の対称性ガード条件にコメント補足
**ファイル:** `myT-x/app_devpanel_api.go`（~L619）

`2*pathLen+3 == len(content)` が `(len(content)-3) % 2 == 0` の言い換えであることをコメントで補足すると意図が明確になる。

---

### [B-SUG-1] `snapshot()` の `min()` 不変条件コメント
**ファイル:** `myT-x/app_session_log_types.go`（~L90）

`min(bufCap-rb.head, rb.count)` が正しく機能する理由（head > 0 はバッファ full 時のみ）をコメントで補足すると自己文書化が進む。

---

### [C-SUG-1] `errorLogStore.ts` の `markAllRead` を O(n) → O(1) に
**ファイル:** `myT-x/frontend/src/stores/errorLogStore.ts`

entries は seq 昇順保証済みのため末尾要素が最大値:
```typescript
const lastReadSeq = state.entries.at(-1)?.seq ?? state.lastReadSeq;
```

---

### [C-SUG-2] `BackendEventMap` の `"app:error-log-updated"` 型修正
**ファイル:** `myT-x/frontend/src/hooks/useBackendSync.ts`（~L41）

バックエンドが `nil` を送信するためランタイムでは `null` が届く。`Record<string, never>` より `null` または `undefined` の方が型定義として正確。

---

### [D-SUG-1] `window == nil` 時のサイレント空スライス返却にログ追加
**ファイル:** `myT-x/internal/tmux/session_manager_windows.go`（~L113）

```go
if window == nil {
    slog.Warn("[DEBUG-WINDOW] removeWindowAtIndexLocked: nil window at index",
        "session", session.Name, "windowIdx", windowIdx)
}
```

---

### [D-SUG-2] `injectTestWindow` に ActiveWindowID 未更新の NOTE 追加
**ファイル:** `myT-x/internal/tmux/command_router_test_helpers_test.go`

```go
// NOTE: The injected window is NOT set as active.
// session.ActiveWindowID remains the original window.
// Callers that need the injected window to be active must update it manually.
```

---

### [E-SUG-1] `TestTeeHandler_CallbackPanic_DoesNotPropagate` にノイズ出力の説明コメント
**ファイル:** `myT-x/internal/sessionlog/handler_test.go`

```go
// NOTE: This test intentionally panics inside the callback.
// The production handler recovers and logs the stack trace to stderr;
// that output in test logs is expected and does not indicate a failure.
```

---

### [E-SUG-2] `TestNewSessionLogRingBuffer_ClampsNonPositiveCapacity/autoincrement` サブテストの configPath 省略
**ファイル:** `myT-x/app_session_log_test.go`

`configPath: "config.yaml"` はこのサブテストで使われない。フィールドを省略するか `// not used` コメントを付ける。

---

## 良い点

### セキュリティ
- **git コマンドの injection 耐性:** 全 DevPanel 関数が git コマンド引数を固定 `[]string` で構築。`commitHash` は `ValidateCommitish` でバリデーション済み
- **`git diff-tree --`**: commit hash とパス指定の曖昧さを解消する重要なセキュリティ修正

### アーキテクチャ
- **ping + fetch の race condition 対策が包括的:**
  1. monotonic fetch counter (`errorLogFetchSeq`) で古いレスポンスの stale overwrite 防止
  2. `isMountedRef` でアンマウント後の state 更新をブロック
  3. subscribe → fetch 順序保証で取りこぼし防止
- **SessionLogEntry.Seq によるフロントエンドの安定 deduplication:** `ts|level|msg|source` の弱い複合キーから seq による単純・確実な方式へ

### Go コード品質
- **`bytes.IndexByte(probe, 0)` by `bytes.ContainsRune(probe, '\x00')`:** 意図明確かつ効率的
- **`cap` → `bufCap` リネーム:** Go 組み込み関数シャドウを解消
- **`min()` 導入:** snapshot() のセグメント計算が簡潔に
- **`TeeHandler` callback panic recovery:** `os.Stderr` 経由で slog ループバックを回避
- **`WithGroup("")` ガード:** slog.Handler 仕様に完全準拠
- **IMP-02: locale-independent な fresh repo 検出:** 文字列マッチングから exit-code 判定へ

### フロントエンド品質
- **callback ref パターン:** `useRef + useEffect([])` の silent failure リスクを回避し、コメントで理由も説明
- **`key={entry.seq}` への変更:** index key に比べてスクロール状態の予期しない喪失を防ぐ
- **`normalizeEntries` の `isValidSeq`:** Go zero value (seq=0) を明示的に弾く防御ライン
- **`shortcutMap` の `useMemo([], [])` キャッシュ:** 動的ルックアップによる extensibility と、生成コストの最小化を両立
- **ViewerRegistry の HMR 対応:** `registry.length = 0` のインプレースクリアで参照安定性と HMR クリーンアップを同時に満たす

### テストコード品質
- **`new(true)` migration:** `testutil.Ptr(true)` との意味的等価性確認済み（全テスト pass）
- **C-3 ウィンドウスコープ分離テスト:** 6方向の境界ケースが網羅
- **`TestTeeHandler_CallbackPanic_DoesNotPropagate`:** recovery 削除等への即座な検出が可能なリグレッションテスト
- **`injectTestWindow` ヘルパー:** 削除された `AddWindow` を使わずに multi-window 状態をテスト構築

---

## 修正作業タスク一覧

以下のタスクについて、並列作業の可否と影響範囲を整理します。

| # | タスク | 優先度 | ファイル | 単独作業可 | 備考 |
|---|---|---|---|---|---|
| T-1 | `buildUntrackedFileDiffSingle` のシンボリックリンク対策 | **Critical** | `app_devpanel_api.go` | ✅ 可 | `os.Stat` → `os.Lstat` 変更。他タスクと独立 |
| T-2 | `removeWindowAtIndexLocked` の var宣言を `:=` に変更 | 重要 | `session_manager_windows.go` | ✅ 可 | コメントと実装の整合のみ |
| T-3 | DevPanel ログプレフィックス方針の決定と統一 | 重要 | 複数ファイル | ⚠️ 要調整 | 方針決定後に一括変更。T-5 と連動 |
| T-4 | `collectUntrackedFiles` の出力サイズ上限追加 | 重要 | `app_devpanel_api.go` | ✅ 可 | T-1 と同ファイルだが独立した変更 |
| T-5 | `rollbackSession` 内の `[DEBUG-WINDOW]` プレフィックス変更 | 重要 | `command_router_handlers_window.go` | ✅ 可 | T-3 の方針に依存するが先行変更可 |
| T-6 | `app_events.go` 日本語コメント重複削除 | 重要 | `app_events.go` | ✅ 可 | 他に影響なし |
| T-7 | `WorkingDiffStatus` type alias のコメント修正 | 重要 | `app_devpanel_types.go` | ✅ 可 | コメント修正のみ |
| T-8 | `handler.go` `return err` 副作用コメント追加 | 重要 | `internal/sessionlog/handler.go` | ✅ 可 | コメント追加のみ |
| T-9 | `initSessionLog` ロック外書き込みコメント追加 | 重要 | `app_session_log.go` | ✅ 可 | コメント追加のみ |
| T-10 | `bodyRef` 二重オーナーシップのリファクタリング | 重要 | `ErrorLogView.tsx`, `useErrorLog.ts` など | ⚠️ 要調整 | フロントエンド複数ファイルに影響 |
| T-11 | バックエンド再起動時の `lastReadSeq` リセット問題確認 | 重要 | `errorLogStore.ts`, `useBackendSync.ts` | ⚠️ 調査先行 | 発生可否の確認が先決 |
| T-12 | `bodyRefCallback` の deps を `[bodyRef]` → `[]` に | 重要 | `ErrorLogView.tsx` | ✅ 可 | T-10 と連動するが先行可能 |
| T-13 | C-7b テストに `ActiveWindowID` 直接検証を追加 | 重要 | `session_manager_window_test.go` | ✅ 可 | テスト追加のみ |
| T-14 | `TestTeeHandler_WithGroupEmpty_PreservesExistingGroup` の型アサーション安全化 | 重要 | `handler_test.go` | ✅ 可 | テスト修正のみ |
| T-15 | `TestWriteSessionLogEntry_EmitsCorrectEventName` の first check を `t.Fatalf` に | 重要 | `app_session_log_test.go` | ✅ 可 | テスト修正のみ |
| T-16 | `isFreshRepo` ログメッセージ修正 | 提案 | `app_devpanel_api.go` | ✅ 可 | ログ文言変更のみ |
| T-17 | WalkDir コールバックで `d.Info()` 渡し | 提案 | `app_devpanel_api.go` | ✅ 可 | T-1/T-4 と同ファイル、独立 |
| T-18 | `markAllRead` を O(1) に | 提案 | `errorLogStore.ts` | ✅ 可 | 単ファイル変更 |
| T-19 | `BackendEventMap` 型修正 (`Record<string, never>` → `null`) | 提案 | `useBackendSync.ts` | ✅ 可 | 型定義変更のみ |
| T-20 | `injectTestWindow` に ActiveWindowID 未更新の NOTE 追加 | 提案 | `command_router_test_helpers_test.go` | ✅ 可 | コメント追加のみ |
| T-21 | test ノイズ出力の説明コメント追加 | 提案 | `handler_test.go` | ✅ 可 | コメント追加のみ |
| T-22 | `TestNewSessionLogRingBuffer` サブテストの configPath 整理 | 提案 | `app_session_log_test.go` | ✅ 可 | コメント修正のみ |

### 並列作業グループ

優先度別・ファイル重複なしで並列実行可能なグループ：

```
グループ1（Critical・最優先）
  └── T-1: buildUntrackedFileDiffSingle シンボリックリンク対策

グループ2（重要、同時作業可）
  ├── T-2: session_manager_windows.go var宣言修正
  ├── T-5: rollbackSession ログプレフィックス変更
  ├── T-6: app_events.go 日本語コメント削除
  ├── T-7: WorkingDiffStatus コメント修正
  ├── T-8: handler.go return err コメント追加
  └── T-9: initSessionLog コメント追加

グループ3（T-1 完了後に同ファイル中の追加作業）
  ├── T-4: collectUntrackedFiles 上限追加 (app_devpanel_api.go)
  ├── T-16: isFreshRepo ログ修正 (app_devpanel_api.go)
  └── T-17: WalkDir d.Info() 渡し (app_devpanel_api.go)

グループ4（フロントエンド同時作業可）
  ├── T-12: bodyRefCallback deps 修正
  ├── T-18: markAllRead O(1) 化
  └── T-19: BackendEventMap 型修正

グループ5（テスト修正、同時作業可）
  ├── T-13: C-7b テスト追記
  ├── T-14: 型アサーション安全化
  ├── T-15: t.Fatalf 修正
  ├── T-20: injectTestWindow コメント
  ├── T-21: test ノイズコメント
  └── T-22: configPath 整理

グループ6（調査が先決）
  ├── T-10: bodyRef 二重オーナーシップ (要設計レビュー)
  ├── T-11: lastReadSeq リセット問題 (発生可否確認後)
  └── T-3: ログプレフィックス方針 (方針決定後に一括)
```

---

## 修正優先度サマリー

| 分類 | 件数 | 対応必要性 |
|---|---|---|
| Critical（マージ前必須） | 1件 | T-1: シンボリックリンク対策 |
| 重要（修正推奨） | 14件 | T-2〜T-15 |
| 提案（Nice to Have） | 7件 | T-16〜T-22 |
