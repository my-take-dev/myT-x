# PR レビュー結果

**日時**: 2026年02月22日 13:13:23  
**対象ブランチ**: 未ステージ変更 (コミット前レビュー)  
**レビュー方式**: カテゴリ別並列レビュー (5エージェント同時実行)

---

## 変更概要

| カテゴリ | 変更ファイル | 主な変更内容 |
|---------|------------|------------|
| **A. DevPanel WorkingDiff** | `app_devpanel_api.go`, `app_devpanel_types.go`, `app_devpanel_api_test.go` | `DevPanelWorkingDiff` 新機能追加 (未追跡ファイルdiff生成) |
| **B. セッションログ** | `app_session_log.go`, `app_session_log_types.go`, `app_session_log_test.go` | Seq番号追加、PID付きファイル名、ping-onlyイベントモデル |
| **C. ハンドラー・ライフサイクル** | `app_lifecycle.go`, `internal/sessionlog/handler.go`, `internal/sessionlog/handler_test.go`, `internal/testutil/helpers.go` | TeeHandler callback panic recovery、EntryCallback パラメータ名変更 |
| **D. tmux 実装・テスト** | `internal/tmux/command_router_handlers_window.go`, `internal/tmux/session_manager_windows.go`, tmux*_test.go x7 | 1-windowモデル強化、rollback修正、injectTestWindow追加 |
| **E. フロントエンド** | `frontend/src/**/*.{ts,tsx,css}`, `wailsjs/**` | ErrorLogのseq-based管理、ping+fetchモデル、DiffView追加 |
| **F. イベント横断** | `app_events.go`, `app_lifecycle_test.go`, `app_session_api_test.go` | snapshotEventPolcies整合、testutil.Ptr→new()移行 |

---

## Critical Issues (0件)

なし

---

## Important Issues (10件)

### [Important-01] app_devpanel_api.go: `buildUntrackedFileDiffSingle` シンボリックリンクエスケープ未対応

**発生箇所**: `app_devpanel_api.go` - `buildUntrackedFileDiffSingle` 関数

**問題**:  
`isPathWithinBase` はシンボリックリンクを解決しない文字列ベースのチェックのため、コメントに書かれた「symlink escape 防止」が実際には機能しない。  
`workDir` 内に外部を指すシンボリックリンクが存在した場合、`os.ReadFile` がリンクを辿り `workDir` 外のファイルを読み込む。  
コードの別箇所 (`resolveAndValidatePath`) では `filepath.EvalSymlinks` を使って正しく防御しているが、この関数では同等の保護がない。

**問題のコード**:
```go
// IMP-03: Verify the resolved path stays within workDir to prevent
// symlink or path traversal escapes from untracked file listings.
if !isPathWithinBase(absPath, workDir) {   // ← EvalSymlinks を経由していない
    slog.Warn("[DEVPANEL] untracked path escapes workDir", "path", relPath)
    return nil
}
```

**推奨修正**:
```go
resolvedAbs, evalErr := filepath.EvalSymlinks(absPath)
if evalErr != nil {
    slog.Debug("[DEVPANEL] failed to resolve symlinks for untracked path", "path", relPath, "error", evalErr)
    return nil
}
resolvedBase, evalErr := filepath.EvalSymlinks(workDir)
if evalErr != nil {
    return nil
}
if !isPathWithinBase(resolvedAbs, resolvedBase) {
    slog.Warn("[DEVPANEL] untracked path escapes workDir after symlink resolution", "path", relPath)
    return nil
}
```

**注意**: テスト `TestBuildUntrackedFileDiffSingle_PathEscape` もシンボリックリンクケースを追加する必要がある。

---

### [Important-02] app_devpanel_api.go: `DevPanelWorkingDiff` フレッシュリポジトリでステージ済みファイルが不可視

**発生箇所**: `app_devpanel_api.go` - `DevPanelWorkingDiff` 関数

**問題**:  
`isFreshRepo = true` (初回コミット前の状態) の場合、`git ls-files --others --exclude-standard` のみに頼る。  
このコマンドは未追跡ファイルしか返さないため、`git add` 済みのステージされたファイルは完全に不可視になる。

**問題のコード**:
```go
if isFreshRepo {
    slog.Warn("[DEVPANEL] HEAD does not exist (fresh repo), continuing with untracked only", "error", headErr)
    // output は空のまま → staged ファイルがDiffに現れない
} else { ... }
```

**推奨修正**:
```go
if isFreshRepo {
    slog.Info("[DEVPANEL] HEAD does not exist (fresh repo), showing staged files only")
    var gitErr error
    output, gitErr = gitpkg.RunGitCLIPublic(workDir, []string{
        "-c", "core.quotepath=false",
        "diff", "--cached", "--no-color",  // staged only vs empty tree
    })
    if gitErr != nil {
        slog.Debug("[DEVPANEL] git diff --cached failed in fresh repo", "error", gitErr)
        output = nil
    }
}
```

また、フレッシュリポジトリは異常状態ではないため `slog.Warn` → `slog.Info` に下げることを推奨。

---

### [Important-03] app_devpanel_api.go: `collectUntrackedFiles` サイレントエラーで不完全結果を無通知で返す

**発生箇所**: `app_devpanel_api.go` - `collectUntrackedFiles` 関数

**問題**:  
`git ls-files` が失敗した場合に `nil` を返して処理を続行するが、呼び出し元 `DevPanelWorkingDiff` は `Truncated: false` のまま不完全な結果を返す。  
フロントエンドは結果が不完全であることを知る手段がない。一方で `git diff HEAD` の失敗は正しくエラーとして伝播されており、**エラーハンドリングの一貫性がない**。

**問題のコード**:
```go
func collectUntrackedFiles(workDir string) []string {
    output, err := gitpkg.RunGitCLIPublic(workDir, []string{...})
    if err != nil {
        slog.Warn("[DEVPANEL] git ls-files for untracked files failed", "error", err)
        return nil  // ← 呼び出し元に失敗が伝わらない
    }
    ...
}
```

**推奨修正** (最小変更):
```go
// DevPanelWorkingDiff 側で ls-files エラーを Truncated に反映
untrackedFiles, hasLsErr := collectUntrackedFiles(workDir)
if hasLsErr {
    truncated = true
}
```

---

### [Important-04] app_devpanel_api.go: `buildUntrackedFileDiffs` サイズ予算管理の欠如

**発生箇所**: `app_devpanel_api.go` - `buildUntrackedFileDiffs` 関数

**問題**:  
`buildUntrackedFileDiffs` はディレクトリを全件 `WalkDir` し、返却後に外側でサイズカットを行う。  
例えば未追跡ディレクトリに10ファイル × 100KB が存在した場合、一時的に1MB以上をアロケートしてから大半を捨てる。

**推奨修正**:  
残余サイズ予算をパラメータで渡すか、`WalkDir` 内で `fs.SkipAll` (Go 1.20+) を使う:
```go
func buildUntrackedFileDiffs(workDir, relPath string, budgetRemaining int) ([]WorkingDiffFile, bool) {
    // WalkDir 内で budgetRemaining を消費、超過で fs.SkipAll
}
```

---

### [Important-05] app_session_log.go: `cleanupOldSessionLogs` 現在のセッションファイルを削除し得る

**発生箇所**: `app_session_log.go` - `cleanupOldSessionLogs` 関数

**問題**:  
現在のセッションファイルが削除候補の `session-*.jsonl` パターンにマッチするため、超過分の削除対象に含まれ得る。  
通常は最新タイムスタンプで末尾にソートされるが、同一秒内に起動した複数プロセスでPIDが最小値 (例: テスト環境でのPID=1相当) の場合、lexicographic ソートの先頭に来て削除対象になる可能性がある。

**問題のコード**:
```go
// 現状: 現在のファイルも session-*.jsonl にマッチするため候補に含まれる
for _, name := range logFiles[:excess] {
    target := filepath.Join(logDir, name)
    if err := os.Remove(target); err != nil {
```

**推奨修正**:
```go
currentFile := filepath.Base(a.sessionLogPath)
for _, name := range logFiles[:excess] {
    if name == currentFile { // 現在のセッションファイルは除外
        continue
    }
    ...
}
```

---

### [Important-06] ErrorLogView.tsx: `markAllRead` がフェッチ完了前に呼ばれるとバッジが再浮上

**発生箇所**: `frontend/src/components/viewer/views/error-log/ErrorLogView.tsx`

**問題**:  
ビュー開時 `markAllRead()` を `useEffect` で呼ぶが、`fetchErrorLog` の初期ロードがまだ完了していない場合 (`entries` = 空)、`lastReadSeq` は `0` のまま更新されない。  
その後 `setEntries(result)` が呼ばれると全エントリが `seq > 0` であるため未読として計算され、ビューを開いているにもかかわらずバッジが再表示される。

**問題のコード**:
```typescript
useEffect(() => {
    markAllRead();   // entries が空のまま呼ばれると lastReadSeq=0 のまま
}, [markAllRead]);  // entries が変化しても再実行されない
```

**推奨修正**:
```typescript
useEffect(() => {
    markAllRead();
}, [entries, markAllRead]);  // entries 更新時も再実行して既読化
```

---

### [Important-07] viewerRegistry.ts: `registerView` 重複ショートカット検出で大文字小文字のミスマッチ

**発生箇所**: `frontend/src/components/viewer/viewerRegistry.ts` - `registerView` 関数

**問題**:  
重複ショートカット検出は `===`（大文字小文字区別あり）で比較するが、`shortcutMap.set` は `toLowerCase()` で正規化する。  
`"Ctrl+Shift+L"` と `"ctrl+shift+l"` は重複検出をすり抜けるが `shortcutMap` では後者で上書きされる。

**問題のコード**:
```typescript
const existing = registry.find(v => v.shortcut === plugin.shortcut && v.id !== plugin.id);
// ↑ 大文字小文字区別 → "Ctrl+Shift+L" と "ctrl+shift+l" をすり抜ける
```

**推奨修正**:
```typescript
const normalized = plugin.shortcut?.toLowerCase();
const existing = registry.find(
    v => v.shortcut?.toLowerCase() === normalized && v.id !== plugin.id
);
```

---

### [Important-08] viewer.css: `--surface-3` CSS変数が未定義

**発生箇所**: `frontend/src/styles/viewer.css` - `.diff-expand-bar:hover`

**問題**:  
`--surface-3` が `base.css` にも `viewer.css` にも定義されていない。フォールバック `var(--accent-10)` が動作するが、意図した視覚表現になっていない。

**問題のコード**:
```css
.diff-expand-bar:hover {
    background: var(--surface-3, var(--accent-10));  /* --surface-3 は未定義 */
}
```

**推奨修正**: `base.css` の `:root` に `--surface-3` を定義するか、フォールバックを明示的な値に置き換える。

---

### [Important-09] app_events.go: `tmux:window-created` ポリシーエントリが欠損

**発生箇所**: `app_events.go` - `snapshotEventPolicies`

**問題**:  
var レベルの NOTE に「`tmux:window-created/renamed/removed event emissions` を復元せよ」と書かれているが、`tmux:window-created` のポリシーエントリが**マップに存在しない**。  
`tmux:window-renamed` と `tmux:window-destroyed` にはエントリがあるが `window-created` は未登録。  
マルチウィンドウ対応時に `window-created` イベントの発行を追加しても、ポリシーエントリがないためスナップショットがトリガーされず**無音バグ**になる。

**問題のコード**:
```go
var snapshotEventPolicies = map[string]snapshotEventPolicy{
    // ...
    "tmux:window-destroyed": {trigger: true, bypassDebounce: true},
    "tmux:window-renamed":   {trigger: true, bypassDebounce: true},
    // tmux:window-created エントリが存在しない ← 将来バグの罠
}
```

**推奨修正**:
```go
"tmux:window-created":   {trigger: true, bypassDebounce: true}, // retained for multi-window
"tmux:window-destroyed": {trigger: true, bypassDebounce: true},
"tmux:window-renamed":   {trigger: true, bypassDebounce: true},
```

---

### [Important-10] command_router_handlers_window.go: 「到達不能」コメントとテストの矛盾

**発生箇所**: `internal/tmux/command_router_handlers_window.go` - `handleKillWindow` の else ブランチ

**問題**:  
コメントには「到達不能」と書かれているが、`TestHandleKillWindow` の `"kill one window in multi-window session keeps session alive"` テストケースが `injectTestWindow` を通じてそのブランチを実際に実行する。コメントが実態と乖離し、将来の読み手に誤解を与える。

**推奨修正**: コメントを実態に合わせる。
```go
} else {
    // NOTE(1-window model): 通常運用では1ウィンドウのみのためこのedeはほぼ到達しない。
    // injectTestWindow によるテストや将来のマルチウィンドウ拡張のために保持。
    r.emitter.Emit("tmux:window-destroyed", ...)
}
```

---

## Suggestions (13件)

### [Suggestion-01] app_devpanel_api.go: `buildUntrackedFileDiffs` WalkDir内でd.Info()を未活用

`WalkDir` コールバック内で `fs.DirEntry.Info()` が利用可能にもかかわらず、`buildUntrackedFileDiffSingle` に渡されず内部で余計な `os.Stat` が発生する。

```go
// 改善: d.Info() をキャッシュして渡す
info, infoErr := d.Info()
if infoErr != nil { return nil }
entry := buildUntrackedFileDiffSingle(workDir, normalized, info)
```

---

### [Suggestion-02] app_devpanel_types.go: `WorkingDiffStatus` 型エイリアスで型安全性が欠如

`type WorkingDiffStatus = string` により任意の文字列が代入可能。コメントで意図的とされているが、予期しない値が混入してもコンパイルエラーにならない。少なくともテストでの網羅チェックを追加することを推奨。

---

### [Suggestion-03] app_devpanel_api.go: 合成diffの `index` ヘッダー行欠落

`buildUntrackedFileDiffSingle` で生成する合成 diff に `index 0000000..0000000` 行がなく、`diff2html` などのパーサーが誤作動する可能性がある。

```go
fmt.Fprintf(&sb, "diff --git a/%s b/%s\n", diffPath, diffPath)
sb.WriteString("new file mode 100644\n")
sb.WriteString("index 0000000..0000000\n")  // 追加推奨
sb.WriteString("--- /dev/null\n")
```

---

### [Suggestion-04] app_session_log_types.go: `push()` の `bufCap == 0` ガードが実質デッドコード

`newSessionLogRingBuffer` で capacity < 1 をクランプするため `len(rb.buf) == 0` には正規コンストラクタ経由では到達不能。ガードの存在が「zero-value での使用を黙示的に許容する」かのように誤読される。コメントで設計意図を明示すること。

---

### [Suggestion-05] internal/sessionlog/handler_test.go: `base error + callback panic` の複合ケース未テスト

`TestTeeHandler_CallbackPanic_DoesNotPropagate` はbase handlerが成功するケースのみ。「base handlerがエラーを返しかつcallbackがpanicする」複合ケースでbaseエラーが正しく返るかが未検証。

---

### [Suggestion-06] app_session_log.go: `"warn"` レベルのSync省略が暗黙的

`"error"` レベルのみ post-lock Sync を行い `"warn"` は省略しているが、その意図を示すコメントがない。エラーストーム時に最後の warn エントリが失われる可能性の設計判断を明示するコメントが必要。

---

### [Suggestion-07] internal/sessionlog/handler.go: `WithAttrs` で空スライス時に不要なアロケーション

`slog.Handler` の仕様では「attrs が空の場合は receiver を返す」が、現実装は `len(attrs) == 0` の場合も新規 `TeeHandler` を生成する。

```go
func (h *TeeHandler) WithAttrs(attrs []slog.Attr) slog.Handler {
    if len(attrs) == 0 { return h }
    // ...
}
```

---

### [Suggestion-08] command_router_test_helpers_test.go: `injectTestWindow` で mutation tracking が未呼び出し

`injectTestWindow` はセッション内部を直接書き換えるが `markTopologyMutationLocked()` を呼ばない。今後 `GetSnapshotDelta` などmutation追跡に依存するアサーションを追加した際にデバッグが困難になる。NOTEコメントで意図を明示することを推奨。

---

### [Suggestion-09] session_manager_windows.go: `var removedPanes []*TmuxPane` とコメントの表現の乖離

コメントには「Always initialize to an empty slice (not nil)」とあるが、`var` 宣言直後の値は nil。if-else で常に非nilが割り当てられるため最終的には正しいが、変数の初期状態と意図の表現が噛み合っていない。

```go
removedPanes := make([]*TmuxPane, 0)  // 初期値を明示
if window != nil && len(window.Panes) > 0 {
    removedPanes = make([]*TmuxPane, len(window.Panes))
    copy(removedPanes, window.Panes)
}
```

---

### [Suggestion-10] useBackendSync.ts: `Record<string, never>` の型精度

「ペイロードなし」の表現として意味論的に不正確。`Record<string, never>` は `string` キーが存在できるが値は代入不能な型。

```typescript
// 推奨: 完全に空のオブジェクト型
"app:error-log-updated": Record<never, never>;
```

---

### [Suggestion-11] app_events.go: NOTE のイベント名用語不一致 (`removed` vs `destroyed`)

var レベル NOTE が `"tmux:window-removed"` と書いているが実際のマップキーは `"tmux:window-destroyed"`。将来の開発者が `removed` イベントを発行してポリシーと食い違うバグを起こすリスク。

```go
// 修正: "destroyed" に統一
// When re-enabling, also emit tmux:window-created/renamed/destroyed events.
```

---

### [Suggestion-12] app_events.go: 1-windowモデルのコメントが英語・日本語で重複

var 宣言直上の英語ブロックコメントと `tmux:window-*` エントリ直前の日本語インラインコメントが実質同じ内容を重複説明。メンテナンス時に片方だけ更新されてコメントが乖離するリスク。どちらかに一本化を推奨。

---

### [Suggestion-13] command_router_env_test.go: `copy` 変数名がビルトインをシャドウ

```go
copy := copyBoolPtr(tt.input)   // 組み込み copy() 関数を shadow
```

このスコープ内では `copy()` が使えなくなる。`got` などの変数名に変更を推奨。

---

## テストカバレッジギャップ (5件)

| # | ギャップ | 対象ファイル |
|---|---------|-----------|
| T-01 | `DevPanelWorkingDiff` E2Eテストなし (`git init` + `t.TempDir()` を使ったリポジトリでの統合テスト) | `app_devpanel_api_test.go` |
| T-02 | フレッシュリポジトリでのステージ済みファイル (`git add` 後の動作確認) | `app_devpanel_api_test.go` |
| T-03 | トランケーション動作 (`devPanelMaxDiffSize` 到達時の `Truncated: true`) | `app_devpanel_api_test.go` |
| T-04 | `buildUntrackedFileDiffSingle` でシンボリックリンクが `workDir` 外を指すケース | `app_devpanel_api_test.go` |
| T-05 | `collectUntrackedFiles` 失敗時に `DevPanelWorkingDiff` が適切に対処するかの確認 | `app_devpanel_api_test.go` |

---

## 発見した問題 総数サマリー

| カテゴリ | Critical | Important | Suggestion | テストギャップ | 小計 |
|---------|---------|----------|-----------|-------------|-----|
| A. DevPanel WorkingDiff | 0 | 4 | 3 (S01〜S03) | 5 | **12** |
| B. セッションログ | 0 | 1 (I05) | 3 (S04〜S06) | 0 | **4** |
| C. ハンドラー・ライフサイクル | 0 | 0 | 2 (S07, S05) | 0 | **2** |
| D. tmux 実装・テスト | 0 | 1 (I10) | 3 (S08, S09, S13) | 0 | **4** |
| E. フロントエンド | 0 | 2 (I06, I07, I08) | 3 (S10, S11, S12) | 0 | **6** |
| F. イベント横断 | 0 | 1 (I09) | 2 | 0 | **3** |
| **合計** | **0** | **10** | **13** | **5** | **28** |

---

## 修正優先度 アクションプラン

### 即時修正推奨 (Important群 — マージ前対応)

1. `[I-01]` **シンボリックリンクエスケープ対応** `buildUntrackedFileDiffSingle` に `filepath.EvalSymlinks` を追加
2. `[I-02]` **フレッシュリポジトリでステージ済みファイルを表示** `git diff --cached` を使用
3. `[I-03]` **`collectUntrackedFiles` エラーを呼び出し元に通知** `Truncated: true` にセット
4. `[I-05]` **`cleanupOldSessionLogs` で現在ファイルを削除対象から除外**
5. `[I-06]` **`ErrorLogView` の `markAllRead` 依存配列に `entries` を追加**
6. `[I-07]` **`viewerRegistry` 重複ショートカット検出を `toLowerCase()` で統一**
7. `[I-08]` **`--surface-3` CSS変数を定義**
8. `[I-09]` **`tmux:window-created` ポリシーエントリを追加**
9. `[I-10]` **「到達不能」コメントを実態に合わせて修正**

### 品質改善 (Suggestion群 — 次サイクルまでに対応)

10. `[S-01]` `d.Info()` をキャッシュして不要な `os.Stat` を削減
11. `[S-03]` 合成 diff に `index` ヘッダー行を追加
12. `[S-05]` `base error + callback panic` の複合テストケース追加
13. `[S-11]` NOTE のイベント名用語 (`removed` → `destroyed`) を修正
14. `[I-04]` `buildUntrackedFileDiffs` にサイズ予算パラメータを追加 (パフォーマンス改善)

### テストカバレッジ追加 (次サイクルまでに対応)

15. `[T-01/T-02]` `DevPanelWorkingDiff` の統合テスト + フレッシュリポジトリテスト
16. `[T-03]` トランケーション境界値テスト
17. `[T-04]` シンボリックリンクエスケープテスト (`[I-01]` の修正と連動)

---

## タスク並列実施可否 一覧表

作業者が修正を実施する際の参考として、各タスクの並列実施可否を整理します。

| # | タスク | 対象ファイル | 並列実施 | 理由 |
|---|--------|------------|---------|------|
| **P1** | [I-01] シンボリックリンク対応 (`buildUntrackedFileDiffSingle`) | `app_devpanel_api.go` | ✅ **可** | 独立した関数修正 |
| **P2** | [I-02] フレッシュリポジトリ staged ファイル対応 | `app_devpanel_api.go` | ⚠️ **P1と同ファイル** | P1と同時編集は行わない |
| **P3** | [I-03] `collectUntrackedFiles` エラー通知 | `app_devpanel_api.go` | ⚠️ **P1と同ファイル** | P1/P2と同時編集は行わない |
| **P4** | [I-04] サイズ予算パラメータ追加 | `app_devpanel_api.go` | ⚠️ **P1と同ファイル** | P1/P2/P3と同時編集は行わない |
| **まとめ** | P1〜P4 は `app_devpanel_api.go` をまとめて1回で修正 | `app_devpanel_api.go` | ✅ **1人で一括修正** | ファイル競合回避のため |
| **P5** | [I-05] `cleanupOldSessionLogs` 現在ファイル除外 | `app_session_log.go` | ✅ **可** | 他ファイルと独立 |
| **P6** | [I-06] `markAllRead` 依存配列修正 | `ErrorLogView.tsx` | ✅ **可** | 他ファイルと独立 |
| **P7** | [I-07] 重複ショートカット検出修正 | `viewerRegistry.ts` | ✅ **可 (P6と同時)** | 独立ファイル |
| **P8** | [I-08] `--surface-3` CSS変数定義 | `base.css` | ✅ **可 (P6/P7と同時)** | 独立ファイル |
| **P9** | [I-09] `tmux:window-created` ポリシーエントリ追加 | `app_events.go` | ✅ **可** | 他ファイルと独立 |
| **P10** | [I-10] 「到達不能」コメント修正 | `command_router_handlers_window.go` | ✅ **可 (P9と同時)** | コメント修正のみ |
| **P11** | [S-05] `base error + callback panic` テスト追加 | `internal/sessionlog/handler_test.go` | ✅ **可** | テストファイルのみ |
| **P12** | [S-11/S-12] NOTE用語統一・コメント重複削除 | `app_events.go` | ⚠️ **P9と同ファイル** | P9と合わせて実施 |
| **P13** | [T-01〜T-04] テストカバレッジ追加 | `app_devpanel_api_test.go` | ✅ **可 (P1〜P4完了後)** | 実装修正後に実施 |

### 推奨並列作業グループ

```
【グループ1: app_devpanel_api.go 一括修正】
  担当: 1名
  タスク: P1(シンボリックリンク) + P2(フレッシュリポジトリ) + P3(エラー通知) + P4(サイズ予算)
  
【グループ2: フロントエンド修正】
  担当: 1名 (グループ1と並行可)
  タスク: P6(markAllRead) + P7(重複ショートカット) + P8(CSS変数)

【グループ3: Go イベント・コメント修正】
  担当: 1名 (グループ1/2と並行可)
  タスク: P5(cleanupOldSessionLogs) + P9(window-created) + P10(コメント修正) + P12(NOTE用語統一)

【グループ4: テスト補強】
  担当: 1名 (グループ1完了後に開始)
  タスク: P11(handler_testケース追加) + P13(devpanel統合テスト追加)
```

### 修正時の注意点

| 状況 | 対処方法 |
|-----|---------|
| `app_devpanel_api.go` は変更量が多い | P1〜P4は1人が順次修正してビルド確認後にコミット |
| フロントエンド修正後はビルド確認必須 | `npm run build` または `wails build` で型エラーを確認 |
| P13(統合テスト)はP1〜P4完了後に実施 | シンボリックリンク・フレッシュリポジトリの修正後にテスト設計する |
| `app_events.go` のP9とP12は同ファイル | まとめて1回で修正する |

---

## 正常に動作している部分 (Strengths)

- ✅ **ping+fetchモデルの設計**: `app:error-logged` → `app:error-log-updated` + `GetSessionErrorLog()` の分離は適切。スロットリングによるデータ損失リスクを排除している
- ✅ **Seq番号によるデduplication**: タイムスタンプベースの弱い複合キーから単調増加カウンタへの移行は堅牢
- ✅ **TeeHandler callback panic recovery**: `recover()` + `debug.Stack()` の実装は適切。再帰的なslog呼び出しを避けてstderrに直接書き込む判断は正しい
- ✅ **PID付きセッションログファイル名**: サブ秒リスタートでのファイル名衝突防止は実用的
- ✅ **`injectTestWindow` のロック安全性**: `t.Fatalf` は `runtime.Goexit()` 経由で `defer Unlock()` を実行するため安全
- ✅ **`testutil.Ptr` → `new()` の移行**: `//go:fix inline` ディレクティブと合わせた段階的移行アプローチは適切
- ✅ **`parseDiffHeaderPaths` の対称性ヒューリスティック**: リネーム差分では精度が落ちること(IMP-01)が明示的にコメントされており、`rename from/to` でオーバーライドされる設計は正しい
- ✅ **`rollbackSession` の設計**: `stage` パラメータが内部診断目的のみでクライアント向けエラーに含まれない設計は適切
- ✅ **`viewerRegistry.ts` のHMR対応**: `globalThis` ベースのシングルトンレジストリ + `dispose` による再登録パターンは、Viteの通常のHMR挙動（view moduleが先に再実行される）に対しては機能する
- ✅ **`normalizeEntries` の `seq <= 0` フィルタリング**: バックエンドの zero-value guard と整合している
- ✅ **`cleanupOldSessionLogs` のコメント**: PIDによる lexicographic ソートの注記は適切
