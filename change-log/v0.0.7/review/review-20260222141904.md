# PR レビュー結果 (詳細・並列作業支援版)

## 📁 レビュー対象カテゴリ (並列レビュー分割方針)
差分量が多く広範囲にわたるため、効率よくサブチームやサブエージェントへタスクを割り当てて並列レビューおよび修正を実施できるよう、以下の4つのカテゴリに分割して分析を行いました。
1. **[UI/Frontend] React & Global Stores** (`myT-x_frontend_src_*`)
2. **[Go/Backend] DevPanel API & Git Utils** (`myT-x_app_devpanel*.go`)
3. **[Go/Backend] Session Logs** (`myT-x_app_session_log*.go`, `myT-x_internal_sessionlog_handler*.go`)
4. **[Go/Backend] Tmux Handlers** (`myT-x_internal_tmux_*.go`)

---

## 🛑 Critical Issues (修正必須)

該当コードが動作しなくなる、あるいは全体ビルドを破壊する恐れのある項目です。

- **[Backend] `stubRuntimeEventsEmit` の未定義によるコンパイルエラー懸念**
  - **対象ファイル:** `myT-x/app_session_log_test.go`
  - **内容の詳細:** セッションログ周りのテストコードにて、旧来の `runtimeEventsEmitFn = func...` 周りのコードが一掃され、代わりに `stubRuntimeEventsEmit(t)` 関数が多用されるようになっています。しかし、取得済みの差分内にはこの `stubRuntimeEventsEmit` 関数の実装が含まれていません。
  - **アクション:** 別のPRや非変更ファイル（`testutil` など）で事前に定義されている場合は問題ありません。もし未定義・追加漏れである場合、このまま結合するとテストプロセス時のコンパイルエラーとなるため実装を補填してください。

## ⚠️ Important Issues (強く修正を推奨)

動作はするものの、パフォーマンスやシステム全体の挙動に悪影響を及ぼす可能性が高い項目です。類似箇所がある場合は一括で対処してください。

- **[Backend] エラーログ永続化時のI/O律速・パフォーマンス悪化リスク (`Sync()` の即時実行)**
  - **対象ファイル:** `myT-x/app_session_log.go` (146行目 `syncFile.Sync()`)
  - **内容の詳細:** `syncFile.Sync()` を RWMutex のロック外に出すことでロック競合（デッドロック含む）は回避されています。しかし、アプリ上でエラーが連続して発生した際に、1エラーのたびに同一直列で `Sync()`（ディスクへのfsyncsyscall等）が全発火します。仮に1秒間に100回のエラーが起これば、I/O遅延が直接Wailsのゴルーチン側に蓄積し、アプリ全体のパフォーマンスを著しく低下させます。
  - **アクション:** `error` レベルの場合であっても都度同期するのではなく、非同期ワーカーによる定周期のフラッシュ機構 (例: 1秒バッファや `bufio` 等のフラッシュ制御) を導入するか否かを検討してください。

- **[Frontend] `markAllRead` 実行時の未読カウンター計算が非効率**
  - **対象ファイル:** `myT-x/frontend/src/stores/errorLogStore.ts` (83行目)
  - **内容の詳細:** 未読を全て既読化する際、最大で1万件ある `state.entries` をすべて走査（forループ）し、最大の `seq` を求めています。該当のストアでは、データ書き込み関数である `normalizeEntries` によって既に `seq` は昇順にソートされていることが保証されています。
  - **アクション:** ループによるO(n)計算を行わず、単に `const maxSeq = state.entries[state.entries.length - 1]?.seq ?? state.lastReadSeq;` のように O(1) で末尾から取得するロジックに修正してください。類似のソート済み配列での最大値探索処理がないか他ストアも確認推奨です。

## 💡 Suggestions (提案・最適化)

コードの品質や将来の保守性をより高めるための細かな提案です。

- **[Backend] 差分パース処理時の一時文字列確保によるメモリアロケーション重複排除**
  - **対象ファイル:** `myT-x/app_devpanel_api.go` (327行目)
  - **内容の詳細:** `buildUntrackedFileDiffSingle` クラス内にて対象ファイルを読み込んだ後 `content = strings.ReplaceAll(content, "\r\n", "\n")`、さらに `\r` を置換しています。1ファイル最大100KBとはいえ、文字列型のまま全体置換を複数回走らせるのは一時アロケーションを無駄に増やします。
  - **アクション:** 文字列化する前にバイト配列のまま `bytes.ReplaceAll` するか、改行でSplitした後のループ内で各行の `\r` をトリム (`strings.TrimSuffix(line, "\r")`) する方法へ変更するとメモリ使用量が削減されクリーンです。

- **[Frontend] ショートカットキー判定ロジックの一貫性**
  - **対象ファイル:** `myT-x/frontend/src/components/viewer/ViewerSystem.tsx` (79行目)
  - **内容の詳細:** ショートカットの起動判定として `e.key.toLowerCase()` の文字列ベース比較を用いています。アルファベットキーでは問題ありませんが、OSや入力環境特有の修飾キー時の挙動などでバグの元となることがあります。「Ctrl+Shift+Escape」等特殊な文字が今後追加されることに備え、`Event.code` をベースにするなど拡張性の高い処理へシフトしておくか留意してください。

## 🌟 Strengths (優れた実装パターン・ポジティブな観察)
レビューにおいて特に保守性が高く素晴らしいと感じた実装を挙げます。

- **非同期状態管理の堅牢化 (Frontend):** `errorLogStore.ts` の `useBackendSync` 機構において、単なる追記(`addEntry`)を廃止し、バックエンドからのPing到達時に `setEntries` で非同期全量フェッチして状態を統合する方式に変わりました。また `fetchSeq` を用いて、非同期リクエストの前後交差による古い状態の遅延上書き（IMP-13）を見事に解決しており、状態不整合が起こらない堅牢な設計になっています。
- **エラー・パニックの分離 (Backend):** `myT-x/internal/sessionlog/handler.go` における `h.callback()` で `recover()` を設定している点は非常に強力です。UIなどサイドエフェクトのロギング発行処理で万が一パニックが起きても、本体（Goのエラー表示・コマンド実行など）がクラッシュしないように防御されています。
- **可読性の追求 (アーキテクチャメモ):** `NOTE(1-window model):` や `NOTE(A-0):` といった、ビジネスロジック・アーキテクチャの制約を注記するルールが整備されており、将来の1-window -> multi-window機能リバイバル時の修正箇所が明確にコード上に記録されています。

---

## 🛠️ タスク整理と並列作業・修正プラン（作業者向け）

以下の表は、上記のレビューで洗い出された指摘とタスクをまとめたものです。
**作業者目線**で、各タスクが「他の作業者と並列で同時に修正できるか？（Gitコンフリクトやロジック干渉が起きないか）」を判定しています。

| タスク ID | 担当・対象スコープ | 修正対象ファイル | 要件・修正アクション | 並列作業 | 作業者へのコメント・注意事項 |
| :---: | :--- | :--- | :--- | :---: | :--- |
| **T-1** | **Backend (Core / Fix)** | `app_session_log_test.go` | テスト用ヘルパー `stubRuntimeEventsEmit` の定義追加およびコンパイル確認。 | **✅ 可能** | 本体のロジックには影響しない「テスト限定」の対応です。他のフロント改修やAPI処理と完全に並列化できます。必ず「go test実装前」にローカル確認してください。 |
| **T-2** | **Backend (Core / Perf)** | `app_session_log.go` | エラーログ保存時の即時 `Sync()` 処理を、非同期バッファリングや定周期タイマーによるフラッシュに変更・最適化。 | **✅ 可能** | 独立した関数 `writeSessionLogEntry` 周辺の閉じた修正です。T-1とマージ時競合する可能性があるので、T-1(テスト改修)の担当者とレビューを合わせてください。 |
| **T-3** | **Frontend (React)** | `errorLogStore.ts` | `markAllRead` 関数における1万件のループ走査を削除し、ソート済み配列末尾からの直接参照(O(1))へ修正。 | **✅ 可能** | フロントエンドのZustandストア内のみの小規模な改修です。T-2のようなバックエンド改修と完全に依存関係なく進められます。 |
| **T-4** | **Backend (API / Refactor)** | `app_devpanel_api.go` | `buildUntrackedFileDiffSingle` クラス内に行われている String メモリアロケーション重複の排除。Byte型操作等へ最適化。 | **✅ 可能** | Goの文字列処理リファクタリングです。Tmux操作系やLogger部分ともファイル・機能が分離されているため、安全に独自ブランチで切り出して作業可能です。 |
| **T-5** | **Frontend (React)** | `ViewerSystem.tsx` | (Optional) ショートカット登録システムでのキー判定ロジック見直し検討。 | **✅ 可能** | 機能要件ではないため優先度は低めですが、もし実施する場合はT-3と同一のフロントエンド作業者が並行して着手すると効率的です。 |

> **【サブエージェント／作業チームへの並列割り当て方針】**
> - **【Agent A: Frontend Team】** に `T-3`（と任意で `T-5`）をアサインします。
> - **【Agent B: Backend Logging Team】** に `T-1` と `T-2` をアサインします。ロギング周りのテストと実コードの変更が交差するため、同一エージェント・担当者がまとめて実装することで動作確認の二度手間を防ぎます。
> - **【Agent C: Backend API Team】** に `T-4` をアサインします。こちらはDevPanel周りの文字列処理に特化するため、ロギング系とは別口で並行実施させます。
