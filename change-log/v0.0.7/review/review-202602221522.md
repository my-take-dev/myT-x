# PR Review 統合版 — 2026-02-22 15:22

**統合元レビュー:**
- `review-20260222122955.md`
- `review-20260222131323.md`
- `review-20260222132710.md`
- `review-20260222141904.md`
- `review-20260222151825.md`

**対象:** `git diff HEAD -- myT-x/` 未ステージ変更（コミット前レビュー）  
**レビュー方式:** カテゴリ別並列レビュー

---

## 変更概要

| カテゴリ | 主な変更内容 |
|---|---|
| A: Go バックエンド — DevPanel API | `DevPanelWorkingDiff` 新機能（未追跡ファイルdiff生成）、ログプレフィックス整理 |
| B: Go バックエンド — Session Log | ping+fetch アーキテクチャ移行、SeqNo 追加、TeeHandler 改善、PID付きファイル名 |
| C: Go バックエンド — Internal層 | TeeHandler callback panic recovery、EntryCallback パラメータ名変更 |
| D: Go バックエンド — tmux | 1-window モデル cleanup、handleNewWindow rollback 改善、injectTestWindow 追加 |
| E: フロントエンド | errorLogStore seq ベース管理、ViewerRegistry グローバル化、callback ref 化、DiffView追加 |
| F: テストコード | 新規テスト大量追加、testutil.Ptr → new() 移行、stubRuntimeEventsEmit 共通化 |
| G: 横断的観点 | API 整合性、イベント名統一、セキュリティ、パフォーマンス確認 |

---

## Critical Issues（マージ前必須修正）

### [CRIT-01] `buildUntrackedFileDiffSingle` のシンボリックリンクによるパストラバーサル
**ファイル:** `myT-x/app_devpanel_api.go`（`buildUntrackedFileDiffSingle` 関数）  
**優先度:** Critical  
**出典:** 122955(A-CRIT-1), 131323(Important-01), 132710(IMP-A01)

**問題:**  
`isPathWithinBase(absPath, workDir)` は `filepath.Rel` ベースのレキシカルなパス比較のみを行い、ファイルシステム上のシンボリックリンクを解決しない。  
一方 `DevPanelReadFile` に使われる `resolveAndValidatePath` は `filepath.EvalSymlinks` による二段保護を持つ。この非対称性が攻撃経路となる。

```
# 攻撃シナリオ
workDir/evil-link -> /etc/passwd   (untracked symlink)
git ls-files --others が evil-link を報告
isPathWithinBase("/workDir/evil-link", "/workDir") = true  ← パストラバーサル通過
os.ReadFile("/workDir/evil-link") は /etc/passwd を読む
```

**推奨修正:**
```go
// os.Stat → os.Lstat に変更してシンボリックリンク追跡を防ぐ
info, err = os.Lstat(absPath)
if err != nil { ... }
if info.Mode()&os.ModeSymlink != 0 {
    slog.Debug("[DEVPANEL] skipping symlink in untracked files", "path", relPath)
    return nil
}
// または追加でシンボリックリンク解決後に再チェック:
resolvedAbs, evalErr := filepath.EvalSymlinks(absPath)
if evalErr != nil { return nil }
resolvedBase, _ := filepath.EvalSymlinks(workDir)
if !isPathWithinBase(resolvedAbs, resolvedBase) {
    slog.Warn("[DEVPANEL] untracked path escapes workDir after symlink resolution", "path", relPath)
    return nil
}
```

**注意:** テスト `TestBuildUntrackedFileDiffSingle_PathEscape` にもシンボリックリンクケースを追加する必要がある。

---

### [CRIT-02] `parseWorkingDiff` の `strings.Split` による diff 境界分割の脆弱性
**ファイル:** `myT-x/app_devpanel_api.go`（`parseWorkingDiff` 関数）  
**優先度:** Critical  
**出典:** 132710(CRI-A02)

**問題:**  
コメント (IMP-05) で「ファイル内容に `diff --git ` が含まれると誤分割する」と記載済みだが、ユーザーのリポジトリに `.patch` ファイルやdiff出力を含むテキストファイルがある場合、**diffブロックの誤分割（silent data corruption）**が発生する。

**推奨修正:**  
`strings.Split` ではなく行スキャンで `\ndiff --git ` を境界とする行ベースパーサーへ移行。

---

### [CRIT-03] バックエンド再起動時の `lastReadSeq` リセット問題（通知消失）
**ファイル:** `myT-x/frontend/src/stores/errorLogStore.ts`  
**優先度:** Critical  
**出典:** 122955(C-IMP-2), 151825(Critical)

**問題:**  
バックエンドプロセス再起動後 `sessionLogSeq` がメモリ上で `1` から振り直されるが、フロントエンド（Zustand State）の `lastReadSeq` はリセットされない。新しいエラーログの `seq`（1, 2...）が元の `lastReadSeq`（例: 50）より小さくなり、全て「既読済み」と誤判定されて未読バッジが消失する。

**推奨修正:**
```typescript
// 新しい entries の最大 seq が state.lastReadSeq より小さい場合、
// シーケンスのリセットを検知して lastReadSeq を 0 に戻す
const maxNewSeq = entries.at(-1)?.seq ?? 0;
if (maxNewSeq > 0 && maxNewSeq < state.lastReadSeq) {
    state.lastReadSeq = 0; // seq リセット検知
}
```

---

### [CRIT-04] `new(true)` / `new(false)` の Go 1.26 互換性確認
**ファイル:** 複数テストファイル  
**優先度:** Critical（コンパイル不可の可能性）  
**出典:** 132710(CRI-C01)

**問題:**  
`testutil.Ptr(true)` を `new(true)` に置換しているが、Go標準の `new` は型名を引数に取る（`new(bool)` は有効だが `new(true)` は Go 1.25 以前ではコンパイルエラー）。Go 1.26で `new(value)` パターンが有効な言語拡張が入っている可能性があるため、仕様確認が必要。

**影響ファイル:**
- `myT-x/app_session_api_test.go`: 7箇所
- `myT-x/internal/tmux/command_router_env_test.go`: 14箇所
- `myT-x/internal/tmux/command_router_handlers_window_test.go`: 2箇所

**対応推奨:** Go 1.26 の `new` built-in 仕様変更を確認。無効であれば全箇所の修正が必要。

---

## Important Issues（修正推奨）

### [IMP-01] `removeWindowAtIndexLocked` のコメントと実装が矛盾
**ファイル:** `myT-x/internal/tmux/session_manager_windows.go`（~L108-L119）  
**出典:** 122955(A-IMP-1), 131323(Suggestion-09), 132710(IMP-B03)

**問題:**  
コメント「Always initialize to an empty slice (not nil)」に対し、`var removedPanes []*TmuxPane` は nil で宣言。

**推奨修正:**
```go
removedPanes := make([]*TmuxPane, 0) // 初期値を明示
if window != nil && len(window.Panes) > 0 {
    removedPanes = make([]*TmuxPane, len(window.Panes))
    copy(removedPanes, window.Panes)
}
```

---

### [IMP-02] DevPanel ログプレフィックスの不整合
**ファイル:** 複数ファイル  
**出典:** 122955(A-IMP-2), 132710(SUG-A01)

**問題:**  
`[DEBUG-DEVPANEL]` → `[DEVPANEL]` への変更が行われたが、他ファイルに `[DEBUG-*]` プレフィックスが残存。

| ファイル | 残存プレフィックス |
|---|---|
| app_events.go | `[DEBUG-EVENT]` |
| app_lifecycle.go | `[DEBUG-HOTKEY]`, `[DEBUG-IPC]`, `[DEBUG-SHIM]`, `[DEBUG-CONFIG]` |
| app_pane_api.go | `[DEBUG-PANE]` |
| command_router_handlers_window.go | `[DEBUG-WINDOW]` |

**推奨:** プレフィックス方針を統一（`[<MODULE>]` 形式への移行 or `[DEBUG-*]` に集約）。

---

### [IMP-03] `collectUntrackedFiles` の出力サイズ上限なし
**ファイル:** `myT-x/app_devpanel_api.go`（`parseNULSeparatedGitPaths`）  
**出典:** 122955(A-IMP-3), 132710(IMP-A05)

**問題:**  
`.gitignore` が不完全な大規模リポジトリ（node_modules 未除外等）では `git ls-files` が数万エントリを返す可能性があり、OOM の温床になりえる。

**推奨修正:**
```go
const maxUntrackedFilePaths = 10000
func parseNULSeparatedGitPaths(raw []byte) []string {
    // ... 上限以降は打ち切り
}
```

---

### [IMP-04] `collectUntrackedFiles` サイレントエラーで不完全結果を無通知で返す
**ファイル:** `myT-x/app_devpanel_api.go`  
**出典:** 131323(Important-03)

**問題:**  
`git ls-files` が失敗した場合に `nil` を返して処理を続行するが、呼び出し元 `DevPanelWorkingDiff` は `Truncated: false` のまま不完全な結果を返す。

**推奨修正:**
```go
untrackedFiles, hasLsErr := collectUntrackedFiles(workDir)
if hasLsErr {
    truncated = true
}
```

---

### [IMP-05] `app_events.go` 日本語・英語コメント重複
**ファイル:** `myT-x/app_events.go`（~L149）  
**出典:** 122955(A-IMP-4), 131323(Suggestion-12)

**問題:**  
英語の NOTE コメントが上部に追加されたが、日本語の旧コメントが重複として残存。

**推奨:** 英語版のみ残し、旧日本語コメントを削除する。

---

### [IMP-06] `rollbackSession` 内の `[DEBUG-WINDOW]` ログがプロダクション重要ログ
**ファイル:** `myT-x/internal/tmux/command_router_handlers_window.go`（~L285）  
**出典:** 122955(A-IMP-5)

**問題:**  
ロールバック失敗は本番でも問題になりえる重大事象だが `[DEBUG-WINDOW]` プレフィックスを持つ。一括削除時に重要障害情報が消える。

**推奨:** `[WINDOW]` に変更。

---

### [IMP-07] `WorkingDiffStatus = string` のコメントが技術的に不正確
**ファイル:** `myT-x/app_devpanel_types.go`（~L50）  
**出典:** 122955(A-IMP-6), 131323(Suggestion-02), 132710(IMP-A04), 151825(Suggestion)

**問題:**  
type alias コメントが Wails 互換性理由を不正確に説明。

**推奨修正:**
```go
// NOTE: This is a type alias (= string), not a defined type. Using a type alias
// allows the Wails TypeScript binding generator to emit the fields as plain
// string literals in the generated .d.ts, enabling direct use of string constants
// on the frontend without additional type casting.
// Trade-off: type safety at compile time is sacrificed.
```

---

### [IMP-08] `handler.go` `return err` 変更による slog 二重出力の可能性
**ファイル:** `myT-x/internal/sessionlog/handler.go`（~L72）  
**出典:** 122955(B-IMP-1), 132710(IMP-B01)

**問題:**  
Go の `log/slog` は `Handle()` がエラーを返すと `fmt.Fprintf(os.Stderr, "slog: %v\n", err)` を出力。この副作用が新設。

**推奨:** コメントで副作用を明記。

---

### [IMP-09] `initSessionLog()` のロック外フィールド書き込み
**ファイル:** `myT-x/app_session_log.go`（~L25-L41）  
**出典:** 122955(B-IMP-2)

**問題:**  
`a.sessionLogFile = f` と `a.sessionLogPath = fullPath` が `sessionLogMu` なしで書き込み。

**推奨:** 安全性の前提条件をコメントで明示。

---

### [IMP-10] `bodyRef` の二重オーナーシップ問題
**ファイル:** `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx`  
**出典:** 122955(C-IMP-1)

**問題:**  
`useErrorLog` フックが内部 `useRef` を公開し、`ErrorLogView` が callback ref 内で `bodyRef.current = el` と直接書き換え — レイヤー越境。

**推奨:** `registerBodyElement: (el: HTMLDivElement | null) => void` 形式のコールバックを返す。

---

### [IMP-11] `bodyRefCallback` の deps が `[bodyRef]` だが実質 `[]`
**ファイル:** `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx`  
**出典:** 122955(C-IMP-3)

**推奨:** `[]` に変更。

---

### [IMP-12] `markAllRead` がフェッチ完了前に呼ばれるとバッジが再浮上
**ファイル:** `myT-x/frontend/src/components/viewer/views/error-log/ErrorLogView.tsx`  
**出典:** 131323(Important-06)

**問題:**  
ビュー開時 `markAllRead()` を `useEffect` で呼ぶが、`fetchErrorLog` の初期ロードが未完了（entries = 空）のとき `lastReadSeq` は `0` のまま。fetch 完了後に全エントリが未読扱いになりバッジが再表示される。

**推奨修正:**
```typescript
useEffect(() => {
    markAllRead();
}, [entries, markAllRead]);  // entries 更新時も再実行
```

---

### [IMP-13] `viewerRegistry` 重複ショートカット検出で大文字小文字ミスマッチ
**ファイル:** `myT-x/frontend/src/components/viewer/viewerRegistry.ts`  
**出典:** 131323(Important-07)

**問題:**  
重複ショートカット検出は `===` で比較するが、`shortcutMap.set` は `toLowerCase()` で正規化。

**推奨修正:**
```typescript
const normalized = plugin.shortcut?.toLowerCase();
const existing = registry.find(
    v => v.shortcut?.toLowerCase() === normalized && v.id !== plugin.id
);
```

---

### [IMP-14] `--surface-3` CSS変数が未定義
**ファイル:** `myT-x/frontend/src/styles/viewer.css`（`.diff-expand-bar:hover`）  
**出典:** 131323(Important-08)

**推奨:** `base.css` の `:root` に `--surface-3` を定義するか、フォールバックを明示的な値に置換。

---

### [IMP-15] `tmux:window-created` ポリシーエントリが欠損
**ファイル:** `myT-x/app_events.go`（`snapshotEventPolicies`）  
**出典:** 131323(Important-09)

**問題:**  
`tmux:window-destroyed` と `tmux:window-renamed` にはエントリがあるが `window-created` は未登録。マルチウィンドウ対応時に無音バグになる。

**推奨修正:**
```go
"tmux:window-created":   {trigger: true, bypassDebounce: true},
```

---

### [IMP-16] `handleKillWindow` 「到達不能」コメントとテストの矛盾
**ファイル:** `myT-x/internal/tmux/command_router_handlers_window.go`  
**出典:** 131323(Important-10)

**問題:**  
コメントには「到達不能」と書かれているが、テストが `injectTestWindow` で当該ブランチを実行する。

**推奨修正:**
```go
} else {
    // NOTE(1-window model): 通常運用では1ウィンドウのため到達しない。
    // injectTestWindow によるテストや将来の拡張のために保持。
    r.emitter.Emit("tmux:window-destroyed", ...)
}
```

---

### [IMP-17] `DevPanelWorkingDiff` フレッシュリポジトリでステージ済みファイルが不可視
**ファイル:** `myT-x/app_devpanel_api.go`（`DevPanelWorkingDiff` 関数）  
**出典:** 131323(Important-02)

**問題:**  
`isFreshRepo = true` の場合、`git ls-files --others --exclude-standard` のみに頼るため `git add` 済みファイルが見えない。

**推奨修正:**
```go
if isFreshRepo {
    slog.Info("[DEVPANEL] HEAD does not exist (fresh repo), showing staged files only")
    output, _ = gitpkg.RunGitCLIPublic(workDir, []string{
        "-c", "core.quotepath=false",
        "diff", "--cached", "--no-color",
    })
}
```

---

### [IMP-18] `cleanupOldSessionLogs` 現在のセッションファイルを削除し得る
**ファイル:** `myT-x/app_session_log.go`  
**出典:** 131323(Important-05)

**問題:**  
現在のセッションファイルが `session-*.jsonl` パターンにマッチし、条件次第で削除対象になりえる。

**推奨修正:**
```go
currentFile := filepath.Base(a.sessionLogPath)
for _, name := range logFiles[:excess] {
    if name == currentFile { continue }
    // ...
}
```

---

### [IMP-19] `buildUntrackedFileDiffs` サイズ予算管理の欠如
**ファイル:** `myT-x/app_devpanel_api.go`  
**出典:** 131323(Important-04)

**問題:**  
全件 `WalkDir` 後に外側でサイズカット。一時的に大量メモリをアロケートしてから大半を捨てる。

**推奨修正:** 残余サイズ予算をパラメータで渡し、`WalkDir` 内で `fs.SkipAll` を使う。

---

### [IMP-20] `writeSessionLogEntry` — `syncFile.Sync()` のWindows環境対応
**ファイル:** `myT-x/app_session_log.go`  
**出典:** 132710(IMP-A03)

**問題:**  
ロック外 `Sync()` 実行時、Windows環境では `os.ErrClosed` ではなく `syscall.EINVAL` が返される場合がある。

**推奨:** Windows固有のエラーもハンドリングする。

---

### [IMP-21] `app:error-logged` → `app:error-log-updated` イベント名変更の全箇所統一確認
**ファイル:** コードベース全体  
**出典:** 132710(IMP-F01)

**推奨:** コードベース全体で旧イベント名 `app:error-logged` を grep し残存箇所がないことを確認。

---

### [IMP-22] `errorLogStore` の `addEntry` メソッド削除の影響確認
**ファイル:** フロントエンド全体  
**出典:** 132710(IMP-F02)

**推奨:** `addEntry` の参照をコードベース全体で検索・確認。

---

### [IMP-23] `stubRuntimeEventsEmit(t)` の未定義によるコンパイルエラー懸念
**ファイル:** `myT-x/app_session_log_test.go`  
**出典:** 132710(IMP-C01), 141904(Critical)

**問題:**  
テストコードで多用される `stubRuntimeEventsEmit(t)` の定義が本 PR の差分に含まれていない。

**対応:** 別 PR/非変更ファイルで事前定義されているか確認。未定義ならコンパイルエラー。

---

### [IMP-24] エラーログ永続化時の Sync() パフォーマンスリスク
**ファイル:** `myT-x/app_session_log.go`（~L146）  
**出典:** 141904(Important)

**問題:**  
1エラーごとに `syncFile.Sync()`（fsync syscall）が発火。エラーストーム時にI/O遅延が蓄積。

**推奨:** 非同期ワーカーによる定周期フラッシュ機構の導入検討。

---

### [IMP-25] `app_events.go` NOTE のイベント名用語不一致 (`removed` vs `destroyed`)
**ファイル:** `myT-x/app_events.go`  
**出典:** 131323(Suggestion-11)

**問題:**  
NOTE が `"tmux:window-removed"` と書いているが実際のマップキーは `"tmux:window-destroyed"`。

**推奨:** `"destroyed"` に統一。

---

### [IMP-26] `parseDiffHeaderPaths` の対称性チェックにおける偶数長パスの挙動
**ファイル:** `myT-x/app_devpanel_api.go`（`parseDiffHeaderPaths` 関数）  
**出典:** 132710(IMP-A02)

**問題:**  
偶数長パスが常に fallback に流れることが明記されていない。

**推奨:** 意図的な設計であればコメントで補足。

---

### [IMP-27] `errorLogStore` 初回ロード時に全エントリが unread 扱い
**ファイル:** `myT-x/frontend/src/stores/errorLogStore.ts`  
**出典:** 132710(IMP-D01)

**問題:**  
アプリ起動直後 `lastReadSeq = 0` で全エントリが未読としてバッジに大きな数値が表示される。

**推奨:** 初回 `setEntries` 時に `lastReadSeq` を最大 seq にセットして既存ログを既読化。

---

## Suggestions（改善提案）

### [SUG-01] `isFreshRepo` のログメッセージが誤解を招く
**ファイル:** `myT-x/app_devpanel_api.go`（~L441）  
**出典:** 122955(A-SUG-1)

推奨: `"HEAD not resolvable (possibly fresh repo or git error), falling back to untracked-only"`

---

### [SUG-02] WalkDir コールバックで `d.Info()` を `buildUntrackedFileDiffSingle` に渡していない
**ファイル:** `myT-x/app_devpanel_api.go`（~L530）  
**出典:** 122955(A-SUG-2), 131323(Suggestion-01), 132710(CRI-A01)

WalkDir 内で `d.Info()` を取得し `cachedInfo` として渡すことで不要な `os.Stat` を省略可能。

---

### [SUG-03] `parseDiffHeaderPaths` の対称性ガード条件にコメント補足
**ファイル:** `myT-x/app_devpanel_api.go`（~L619）  
**出典:** 122955(A-SUG-3)

---

### [SUG-04] `snapshot()` の `min()` 不変条件コメント
**ファイル:** `myT-x/app_session_log_types.go`（~L90）  
**出典:** 122955(B-SUG-1)

---

### [SUG-05] `errorLogStore.ts` の `markAllRead` を O(n) → O(1) に
**ファイル:** `myT-x/frontend/src/stores/errorLogStore.ts`  
**出典:** 122955(C-SUG-1), 141904(Important-markAllRead)

```typescript
const lastReadSeq = state.entries.at(-1)?.seq ?? state.lastReadSeq;
```

---

### [SUG-06] `BackendEventMap` の `"app:error-log-updated"` 型修正
**ファイル:** `myT-x/frontend/src/hooks/useBackendSync.ts`（~L41）  
**出典:** 122955(C-SUG-2), 131323(Suggestion-10), 132710(SUG-D01)

バックエンドが `nil` を送信するため `Record<string, never>` → `null` の方が正確。

---

### [SUG-07] `window == nil` 時のサイレント空スライス返却にログ追加
**ファイル:** `myT-x/internal/tmux/session_manager_windows.go`（~L113）  
**出典:** 122955(D-SUG-1)

---

### [SUG-08] `injectTestWindow` に ActiveWindowID 未更新の NOTE 追加
**ファイル:** `myT-x/internal/tmux/command_router_test_helpers_test.go`  
**出典:** 122955(D-SUG-2), 131323(Suggestion-08)

mutation tracking (`markTopologyMutationLocked()`) を呼ばない点もコメントで明記。

---

### [SUG-09] `TestTeeHandler_CallbackPanic_DoesNotPropagate` にノイズ出力の説明コメント
**ファイル:** `myT-x/internal/sessionlog/handler_test.go`  
**出典:** 122955(E-SUG-1)

---

### [SUG-10] `TestNewSessionLogRingBuffer` サブテストの configPath 省略
**ファイル:** `myT-x/app_session_log_test.go`  
**出典:** 122955(E-SUG-2)

---

### [SUG-11] `TestTeeHandler_WithGroupEmpty_PreservesExistingGroup` の型アサーションが unsafe
**ファイル:** `myT-x/internal/sessionlog/handler_test.go`  
**出典:** 122955(E-IMP-1)

**推奨:** `got, ok := h.WithGroup("foo").(*TeeHandler)` + `t.Fatalf` パターン。

---

### [SUG-12] `TestWriteSessionLogEntry_EmitsCorrectEventName` のアサーション順序が false-positive リスク
**ファイル:** `myT-x/app_session_log_test.go`  
**出典:** 122955(E-IMP-2)

**推奨:** 1つ目のチェックを `t.Fatalf` に変更。

---

### [SUG-13] C-7b テストに `ActiveWindowID` 直接検証を追加
**ファイル:** `myT-x/internal/tmux/session_manager_window_test.go`（~L417）  
**出典:** 122955(D-IMP-1)

---

### [SUG-14] 合成 diff の `index` ヘッダー行欠落
**ファイル:** `myT-x/app_devpanel_api.go`  
**出典:** 131323(Suggestion-03)

合成 diff に `index 0000000..0000000` 行がなく、`diff2html` 等のパーサーが誤作動する可能性。

---

### [SUG-15] `push()` の `bufCap == 0` ガードが実質デッドコード
**ファイル:** `myT-x/app_session_log_types.go`  
**出典:** 131323(Suggestion-04)

コメントで設計意図を明示すること。

---

### [SUG-16] `base error + callback panic` の複合テストケース未テスト
**ファイル:** `myT-x/internal/sessionlog/handler_test.go`  
**出典:** 131323(Suggestion-05)

---

### [SUG-17] `warn` レベルの Sync 省略が暗黙的
**ファイル:** `myT-x/app_session_log.go`  
**出典:** 131323(Suggestion-06)

設計判断を明示するコメントが必要。

---

### [SUG-18] `WithAttrs` で空スライス時に不要なアロケーション
**ファイル:** `myT-x/internal/sessionlog/handler.go`  
**出典:** 131323(Suggestion-07)

```go
func (h *TeeHandler) WithAttrs(attrs []slog.Attr) slog.Handler {
    if len(attrs) == 0 { return h }
    // ...
}
```

---

### [SUG-19] `copy` 変数名がビルトインをシャドウ
**ファイル:** `myT-x/internal/tmux/command_router_env_test.go`  
**出典:** 131323(Suggestion-13)

`got` などの変数名に変更を推奨。

---

### [SUG-20] `needsGitQuoting` テストで CR/LF カバレッジ不足
**ファイル:** `myT-x/app_devpanel_api.go`  
**出典:** 132710(SUG-A02)

---

### [SUG-21] `devPanelMaxUntrackedFileSize` の 100KB 引き上げ検討
**ファイル:** `myT-x/app_devpanel_api.go`  
**出典:** 132710(SUG-A04)

256KB や 512KB への引き上げで中規模ファイルのdiffが見えるようになる。

---

### [SUG-22] `ActivityStrip` の `position` デフォルト値明示
**ファイル:** `myT-x/frontend/src/components/viewer/ActivityStrip.tsx`  
**出典:** 132710(SUG-D03)

---

### [SUG-23] `registerView` のidempotent更新時にshortcut重複チェックが走らない
**ファイル:** `myT-x/frontend/src/components/viewer/viewerRegistry.ts`  
**出典:** 132710(SUG-D05)

---

### [SUG-24] 差分パース時のメモリアロケーション重複排除
**ファイル:** `myT-x/app_devpanel_api.go`（~L327）  
**出典:** 141904(Suggestion)

`strings.ReplaceAll` 複数回の代わりに `bytes.ReplaceAll` か行単位の `strings.TrimSuffix` に変更推奨。

---

### [SUG-25] ショートカットキー判定を `e.key` から `Event.code` ベースへ
**ファイル:** `myT-x/frontend/src/components/viewer/ViewerSystem.tsx`  
**出典:** 141904(Suggestion)

---

### [SUG-26] `testutil.Ptr` の `go fix` 全体適用タスク
**ファイル:** テストファイル群  
**出典:** 151825(Suggestion)

CI/CD に `go fix ./...` を組み込んで `testutil.Ptr` を段階的に払拭する。

---

## テストカバレッジギャップ

| # | ギャップ | 対象ファイル |
|---|---------|-----------|
| TG-01 | `DevPanelWorkingDiff` E2E テスト（`git init` + `t.TempDir()` を使った統合テスト） | `app_devpanel_api_test.go` |
| TG-02 | フレッシュリポジトリでのステージ済みファイル動作確認 | `app_devpanel_api_test.go` |
| TG-03 | トランケーション動作（`devPanelMaxDiffSize` 到達時の `Truncated: true`） | `app_devpanel_api_test.go` |
| TG-04 | `buildUntrackedFileDiffSingle` でシンボリックリンクが workDir 外を指すケース | `app_devpanel_api_test.go` |
| TG-05 | `collectUntrackedFiles` 失敗時に `DevPanelWorkingDiff` が適切に対処するか | `app_devpanel_api_test.go` |
| TG-06 | `handleNewWindow` snapshot refetch 失敗 → rollback パスのテスト | `command_router_handlers_window_test.go` |

---

## 良い点（Strengths）

- **ping+fetch モデルの設計**: `app:error-log-updated` + `GetSessionErrorLog()` 分離によるスロットリング時のデータ損失排除
- **Seq 番号による deduplication**: タイムスタンプベースの弱い複合キーからモノトニックカウンターへの堅牢な移行
- **TeeHandler callback panic recovery**: `recover()` + `debug.Stack()` + stderr 直接書き込み（slog ループバック回避）
- **PID付きセッションログファイル名**: サブ秒リスタートでのファイル名衝突防止
- **git コマンド injection 耐性**: 全 DevPanel 関数が固定 `[]string` で構築、`ValidateCommitish` バリデーション済み
- **`git diff-tree --`**: commit hash とパス指定の曖昧さ解消（セキュリティ修正）
- **callback ref パターン**: `useRef + useEffect([])` の silent failure リスク回避
- **`key={entry.seq}`**: index key 比較でのスクロール状態喪失を防止
- **`normalizeEntries` の `isValidSeq`**: Go zero value (seq=0) を明示的に弾く防御
- **ViewerRegistry の HMR 対応**: `globalThis` シングルトン + `dispose` フック + idempotent `registerView`
- **`shortcutMap` 動的バインディング**: ハードコードからの拡張性向上
- **`rollbackSession` 設計**: `stage` パラメータが内部診断目的のみ
- **`injectTestWindow` のロック安全性**: `t.Fatalf` → `runtime.Goexit()` → `defer Unlock()` で安全
- **コメント品質**: `IMP-01`〜`IMP-06`, `SUG-05`〜`SUG-07` 等の識別子付きコメントで設計判断の背景が明確

---

## 修正優先度サマリー

| 分類 | 件数 | 代表タスク |
|---|---|---|
| Critical（マージ前必須） | 4件 | CRIT-01〜CRIT-04 |
| Important（修正推奨） | 27件 | IMP-01〜IMP-27 |
| Suggestion（Nice to Have） | 26件 | SUG-01〜SUG-26 |
| テストギャップ | 6件 | TG-01〜TG-06 |

---

## 並列作業表

### タスク一覧と並列作業可否

| タスクID | 重要度 | 概要 | 対象ファイル | 並列OK? | 備考 |
|:---:|:---:|---|---|:---:|---|
| **CRIT-01** | Critical | シンボリックリンクパストラバーサル対策 | `app_devpanel_api.go` | ⚠️ 同ファイル集約 | グループA |
| **CRIT-02** | Critical | `parseWorkingDiff` 分割方式改善 | `app_devpanel_api.go` | ⚠️ 同ファイル集約 | グループA |
| **CRIT-03** | Critical | `lastReadSeq` リセット問題 | `errorLogStore.ts` | ✅ 可 | グループC と並列 |
| **CRIT-04** | Critical | `new(true)` Go 1.26 互換性確認 | テストファイル複数 | ✅ 可 | 確認作業、グループE |
| **IMP-01** | Important | `removedPanes` 初期化修正 | `session_manager_windows.go` | ✅ 可 | グループD |
| **IMP-02** | Important | ログプレフィックス方針統一 | 複数ファイル | ⚠️ 要調整 | 方針決定後一括 |
| **IMP-03** | Important | untracked ファイル数上限追加 | `app_devpanel_api.go` | ⚠️ 同ファイル集約 | グループA |
| **IMP-04** | Important | `collectUntrackedFiles` エラー通知 | `app_devpanel_api.go` | ⚠️ 同ファイル集約 | グループA |
| **IMP-05** | Important | 日本語コメント重複削除 | `app_events.go` | ✅ 可 | グループD |
| **IMP-06** | Important | rollback ログプレフィックス変更 | `command_router_handlers_window.go` | ✅ 可 | グループD |
| **IMP-07** | Important | WorkingDiffStatus コメント修正 | `app_devpanel_types.go` | ✅ 可 | グループD |
| **IMP-08** | Important | handler.go return err コメント | `internal/sessionlog/handler.go` | ✅ 可 | グループD |
| **IMP-09** | Important | initSessionLog コメント追加 | `app_session_log.go` | ✅ 可 | グループB |
| **IMP-10** | Important | bodyRef 二重オーナーシップ | `ErrorLogView.tsx`, `useErrorLog.ts` | ⚠️ 要設計 | グループF |
| **IMP-11** | Important | bodyRefCallback deps 修正 | `ErrorLogView.tsx` | ✅ 可 | グループC |
| **IMP-12** | Important | markAllRead 依存配列修正 | `ErrorLogView.tsx` | ✅ 可 | グループC |
| **IMP-13** | Important | 重複ショートカット検出修正 | `viewerRegistry.ts` | ✅ 可 | グループC |
| **IMP-14** | Important | `--surface-3` CSS 変数定義 | `base.css` | ✅ 可 | グループC |
| **IMP-15** | Important | `window-created` ポリシー追加 | `app_events.go` | ✅ 可 | IMP-05と同ファイル集約 |
| **IMP-16** | Important | 「到達不能」コメント修正 | `command_router_handlers_window.go` | ✅ 可 | グループD |
| **IMP-17** | Important | フレッシュリポジトリ staged 対応 | `app_devpanel_api.go` | ⚠️ 同ファイル集約 | グループA |
| **IMP-18** | Important | セッションファイル自己削除防止 | `app_session_log.go` | ✅ 可 | グループB |
| **IMP-19** | Important | WalkDir サイズ予算管理 | `app_devpanel_api.go` | ⚠️ 同ファイル集約 | グループA |
| **IMP-20** | Important | Sync() Windows対応 | `app_session_log.go` | ✅ 可 | グループB |
| **IMP-21** | Important | 旧イベント名残存確認 | コードベース全体 | ✅ 可 | grep確認のみ |
| **IMP-22** | Important | `addEntry` 参照確認 | フロントエンド全体 | ✅ 可 | grep確認のみ |
| **IMP-23** | Important | `stubRuntimeEventsEmit` 存在確認 | テストヘルパー | ✅ 可 | 確認のみ |
| **IMP-24** | Important | Sync() パフォーマンス改善検討 | `app_session_log.go` | ✅ 可 | グループB |
| **IMP-25** | Important | NOTE イベント名用語統一 | `app_events.go` | ✅ 可 | IMP-05/15と集約 |
| **IMP-26** | Important | parseDiffHeaderPaths コメント補足 | `app_devpanel_api.go` | ⚠️ 同ファイル集約 | グループA |
| **IMP-27** | Important | 初回ロードunread問題 | `errorLogStore.ts` | ✅ 可 | CRIT-03と連動 |

### 推奨並列作業グループ

```
【グループA: app_devpanel_api.go 一括修正】 ← 最優先
  担当: 1名（順次修正）
  タスク: CRIT-01, CRIT-02, IMP-03, IMP-04, IMP-17, IMP-19, IMP-26
  関連SUG: SUG-01, SUG-02, SUG-03, SUG-14, SUG-20, SUG-21, SUG-24
  注意: 同一ファイルへの変更が集中。並列不可、1人で一括修正。

【グループB: session_log.go 修正】
  担当: 1名（グループA/C/Dと並列OK）
  タスク: IMP-09, IMP-18, IMP-20, IMP-24
  関連SUG: SUG-04, SUG-10, SUG-12, SUG-17

【グループC: フロントエンド修正】
  担当: 1名（グループA/B/Dと並列OK）
  タスク: CRIT-03, IMP-11, IMP-12, IMP-13, IMP-14, IMP-27
  関連SUG: SUG-05, SUG-06, SUG-22, SUG-23, SUG-25

【グループD: Go バックエンド（その他）修正】
  担当: 1名（グループA/B/Cと並列OK）
  タスク: IMP-01, IMP-05, IMP-06, IMP-07, IMP-08, IMP-15, IMP-16, IMP-25
  関連SUG: SUG-07, SUG-08, SUG-18, SUG-19

【グループE: テスト修正】
  担当: 1名（グループB/C/Dと並列OK、グループA完了後に一部開始）
  タスク: CRIT-04, SUG-11, SUG-13, SUG-16
  テストギャップ: TG-01〜TG-06

【グループF: 設計レビュー・調査先行】
  タスク: IMP-02（方針決定後一括）, IMP-10（要設計レビュー）, IMP-21〜23（grep確認）
```

### グループ間の依存関係

```
              ┌─────────────────────────────────────────────┐
              │           事前調査 (グループF)                │
              │  IMP-02(方針決定) IMP-10(設計) IMP-21〜23    │
              └──────┬──────────────────────────────────────┘
                     │ 方針決定後
    ┌────────────────┼────────────────────────────────────┐
    │                │                                    │
    ▼                ▼                   ▼                ▼
┌────────┐   ┌────────────┐   ┌──────────────┐   ┌────────────┐
│グループA│   │ グループB   │   │ グループC     │   │ グループD   │
│DevPanel│   │ SessionLog │   │ Frontend     │   │ Go Other   │
│API一括 │   │            │   │              │   │            │
└───┬────┘   └────────────┘   └──────────────┘   └────────────┘
    │ 完了後
    ▼
┌────────────┐
│ グループE   │
│ テスト補強  │
└────────────┘
```

### 修正時の注意事項

| 状況 | 対処方法 |
|-----|---------|
| `app_devpanel_api.go` は変更量が多い | グループAは1人が順次修正してビルド確認後にコミット |
| `app_events.go` の IMP-05/15/25 は同ファイル | まとめて1回で修正する |
| `app_session_log.go` の IMP-09/18/20/24 は同ファイル | まとめて1回で修正する |
| フロントエンド修正後はビルド確認必須 | `npm run build` で型エラーを確認 |
| グループ E（統合テスト）はグループ A 完了後 | シンボリックリンク・フレッシュリポジトリ修正後にテスト設計する |
| CRIT-04 は Go 1.26 仕様確認が先決 | 仕様確認で `new(true)` が有効なら対応不要 |
