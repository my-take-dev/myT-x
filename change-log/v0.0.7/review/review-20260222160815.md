# PR Review Summary

**レビュー日時**: 2026-02-22 16:08  
**対象**: `D:\myT-x\dev-myT-x\review\temp` 配下の差分ファイル38件  
**レビュー方針**: `review-pr-para.prompt.md` 準拠 + `CLAUDE.md` 製品仕様遵守

---

## 変更概要

本PRは以下の主要な変更を含む:

1. **DevPanel WorkingDiff 機能追加** — `DevPanelWorkingDiff` APIの新規追加（git diff HEAD + untracked files の合成diff）
2. **SessionLog ping+fetch モデルへの移行** — イベントモデルを `app:error-logged`（ペイロード付き）から `app:error-log-updated`（pingのみ）に変更
3. **SessionLogEntry に `Seq` フィールド追加** — フロントエンドの重複排除をseqベースに変更
4. **TeeHandler の改善** — コールバックpanic保護、base handler error時もコールバック実行
5. **viewerRegistry のHMR対応・position サポート** — グローバルレジストリ＋position:"bottom"
6. **ログプレフィックスの統一** — `[DEBUG-*]` → `[*]` への一括リネーム
7. **tmux 1-window model 関連テスト・コメント強化** — `injectTestWindow` ヘルパー追加、マルチウィンドウテスト補完
8. **リングバッファ防御的改善** — `cap` → `bufCap` リネーム、0/負値クランプ
9. **testutil.Ptr の `go:fix inline` ディレクティブ追加**

---

## Critical Issues (3 件)

### C-1: `buildUntrackedFileDiffsWithBudget` — 到達不能な予算チェック (バグ)
- **ファイル**: `app_devpanel_api.go` (diff 行304)
- **深刻度**: Critical
- **詳細**:
```go
if remainingBudget >= 0 && remainingBudget <= 0 {
    budgetExceeded = true
    return fs.SkipAll
}
```
`remainingBudget >= 0 && remainingBudget <= 0` は `remainingBudget == 0` と等価であり、ループ内で `remainingBudget` を減算する処理がこのチェックの**後**にしかないため、初回の `remainingBudget == 0` 以外のケースでは機能しない。本来の意図は `remainingBudget <= 0` のみであるべき。

これにより、予算が枯渇してもディレクトリwalk内のファイル処理が停止せず、devPanelMaxDiffSizeを大幅に超過する可能性がある。

**修正案**:
```go
if remainingBudget >= 0 && remainingBudget <= 0 {
```
を以下に修正:
```go
if remainingBudget == 0 {
```
あるいは、ループ下部の `remainingBudget -= len(entry.Diff)` 後に `remainingBudget < 0` をチェックする方が正確:
```go
if remainingBudget < 0 {
    budgetExceeded = true
    return fs.SkipAll
}
```

---

### C-2: `buildUntrackedFileDiffSingle` — cachedInfo と lstatInfo の不整合リスク
- **ファイル**: `app_devpanel_api.go` (diff 行369-384)
- **深刻度**: Critical
- **詳細**:
`buildUntrackedFileDiffSingle` は `Lstat` でシンボリックリンクチェックを行った後、`cachedInfo` が渡されていればそれを `info` として使用する。しかし `cachedInfo` は呼び出し元 (`buildUntrackedFileDiffsWithBudget`) で `d.Info()` により取得された `os.FileInfo` であり、これはシンボリックリンクを**解決した後**の情報を返す場合がある(`filepath.WalkDir`は通常シンボリックリンクをfollowしない設計だが、`d.Info()`は`Lstat`相当)。

一方、直後に `os.ReadFile(resolvedAbs)` でEvalSymlinks後のパスを読んでいるため、`cachedInfo.Size()` と実際に読まれるファイルサイズが不一致になるケースが存在する。

**リスク**: `cachedInfo.Size()` が `devPanelMaxUntrackedFileSize` 以下でも、`resolvedAbs` (シンボリックリンク解決後) のファイルが巨大である場合、メモリ過剰消費が発生する。

ただし、直前の `Lstat` + シンボリックリンクチェックでシンボリックリンクは弾かれるため、実際には `resolvedAbs == absPath` となるケースが大半。**シンボリックリンクがディレクトリの途中にある場合**には不整合が起きうる。

**修正案**: `info.Size()` のチェック後に `len(data)` も同様にチェックを追加するか、`cachedInfo` の使用を `lstatInfo` で統一する。

---

### C-3: `initSessionLog` — ロック範囲の不足
- **ファイル**: `app_session_log.go` (diff 行36-39)
- **深刻度**: Critical
- **詳細**:
```go
a.sessionLogMu.Lock()
a.sessionLogFile = f
a.sessionLogPath = fullPath
a.sessionLogMu.Unlock()
```
`initSessionLog` は `startup` から呼ばれ、通常は単一goroutineで実行されるため実質的には安全である。
しかし、`cleanupOldSessionLogs()` が**ロック解放後**に呼ばれるため、ロック取得時点で `cleanupOldSessionLogs` が別goroutineから呼ばれた場合（理論上はない）一貫性が崩れる。

より大きな問題は、**`initSessionLog` で `sessionLogFile` を設定してからロック取得するまでの間** に `writeSessionLogEntry` が呼ばれた場合。ただし `initSessionLog` は `startup` の早期段階で呼ばれるため、slogの `TeeHandler` 設定前であり、実質的なレースは発生しない。

→ **既存の変更は改善方向であり安全ではあるが**、`os.OpenFile` の結果を即座にロック内で設定する現在のパターンは正しい。追加の対応は不要。

**判定**: 既存の修正は適切。ただし、ドキュメントのコメントで「startupは単一goroutineで実行されるためレースはない」旨を明示することを推奨。

---

## Important Issues (9 件)

### I-1: `parseWorkingDiff` — `+++ ` / `--- ` 行がadditions/deletionsカウントに含まれる可能性
- **ファイル**: `app_devpanel_api.go` (diff 行521-524)
- **深刻度**: Important
- **詳細**:
```go
} else if strings.HasPrefix(line, "+") && !strings.HasPrefix(line, "+++") {
    file.Additions++
} else if strings.HasPrefix(line, "-") && !strings.HasPrefix(line, "---") {
    file.Deletions++
}
```
このロジックは `+++ b/path` と `--- a/path` を除外しているが、diff ブロック全体の行を走査しているため、`index ...` や `similarity index ...` といったメタデータ行が `+` や `-` で始まるケースでは誤カウントする。実際のgit diff出力ではメタデータ行はこれらの文字で始まらないため、現実的な問題はほぼないが、将来的にカスタムdiff出力が混在した場合のリスクあり。

**修正案**: hunkヘッダ (`@@`) を検出してからカウントを開始するように制御フローを変更。

---

### I-2: `errorLogStore` — `setEntries` で初回ロード時に全エントリを既読扱い
- **ファイル**: `errorLogStore.ts` (diff 行79-81)
- **深刻度**: Important
- **詳細**:
```ts
if (state.entries.length === 0 && state.lastReadSeq === 0 && maxNewSeq > 0) {
    lastReadSeq = maxNewSeq;
}
```
アプリ起動直後の初回フェッチで既存エラーログが全て既読になる。これは意図的な設計判断として文書化されているが、ユーザーが前回未確認のエラーを見逃す可能性がある。

**推奨**: 設計判断として許容するが、将来的に `lastReadSeq` をローカルストレージに永続化することを検討。

---

### I-3: `TeeHandler.Handle` — panic recovery のスタックトレース出力先
- **ファイル**: `internal/sessionlog/handler.go` (diff 行58-65)
- **深刻度**: Important
- **詳細**:
```go
defer func() {
    if r := recover(); r != nil {
        fmt.Fprintf(os.Stderr, "[session-log] callback panicked: %v\n%s\n", r, debug.Stack())
    }
}()
```
panic時のスタックトレースが `os.Stderr` に書き出されるが、これは正しい判断（slogを使うとTeeHandlerの再帰呼び出しになる）。ただし、`debug.Stack()` のサイズが非常に大きくなる可能性があり、ログファイルの可読性を損なう可能性がある。

**推奨**: スタックトレースの最大サイズを制限するか、最初のN行のみ出力することを検討。

---

### I-4: `viewerRegistry` — globalThis への直接書き込み
- **ファイル**: `viewerRegistry.ts` (diff 行25-37)
- **深刻度**: Important
- **詳細**:
```ts
const REGISTRY_KEY = "__mytx_view_registry__" as const;
// ...
function resolveRegistry(): ViewPlugin[] {
    const globalObject = globalThis as RegistryGlobal;
    if (!globalObject[REGISTRY_KEY]) {
        globalObject[REGISTRY_KEY] = [];
    }
    return globalObject[REGISTRY_KEY];
}
```
HMR対応のためにglobalThisにレジストリを保持する設計は理解できるが、`__mytx_view_registry__` が他のライブラリやユーザースクリプトと衝突するリスクがある。

**修正案**: `Symbol.for("mytx.view.registry")` を使用してキー衝突を防止。ただし、CLAUDE.mdにて「アプリケーションである為、内部的に使うWeb通信に対しては外部公開リスクとしての脆弱性の影響を指摘しない事」とあるため、現状は許容範囲。

---

### I-5: `DevPanelWorkingDiff` — 空リポジトリでのエラーハンドリング非対称性
- **ファイル**: `app_devpanel_api.go` (diff 行137-158)
- **深刻度**: Important
- **詳細**:
freshRepoの場合、`git diff --cached` が失敗するとwarningのみでuntracked-onlyにフォールバック（`diffLoadIncomplete = true`）。一方、通常リポジトリでは `git diff HEAD` がエラーの場合は即座にエラーを返す。

この非対称性は意図的な設計であるが、freshRepoでstaged diffが失敗する原因（例: 破損したindex）がuntrackedファイルの取得にも影響する場合、ユーザーに不正確な結果を返す可能性がある。

**推奨**: コメントで非対称性の理由を明示するか、freshRepoのエラーも通常リポジトリと同じ扱いにすることを検討。

---

### I-6: `ErrorLogView.tsx` — callback ref の `cleanupRef` がコンポーネントアンマウント時にクリーンアップされない可能性
- **ファイル**: `ErrorLogView.tsx` (diff 行31-83)
- **深刻度**: Important
- **詳細**:
`bodyRefCallback` はcallback refとして `ref={bodyRefCallback}` に渡されている。Reactがコンポーネントをアンマウントする際、callback refに `null` を渡すため `cleanupRef.current()` が呼ばれる。これは正しい。

ただし、`useCallback` の依存配列が `[registerBodyElement]` のみであり、`registerBodyElement` は `useCallback([], [])` で安定化されているため再生成されない。つまり `bodyRefCallback` 自体はコンポーネントのライフタイム中に1回しか生成されない。これにより、`cleanupRef.current` が意図通りクリーンアップされる。

→ **問題なし。設計は正しい。**

---

### I-7: `useBackendSync.ts` — errorLogDebounceTimer のリフレッシュタイミング
- **ファイル**: `useBackendSync.ts` (diff 行72-73)
- **深刻度**: Important
- **詳細**:
```ts
if (errorLogDebounceTimer != null) {
    clearTimeout(errorLogDebounceTimer);
}
errorLogDebounceTimer = setTimeout(fetchErrorLog, ERROR_LOG_DEBOUNCE_MS);
```
デバウンスロジックでは、新しいpingが到着するたびにタイマーがリセットされる。連続的にログエントリが追加される場合（例: 高頻度のエラー発生）、フェッチが無限に延期される可能性がある。

**修正案**: 最大待機時間を設けて、デバウンスが一定回数以上リセットされた場合は強制フェッチする（leading+trailing debounce パターン）。ただし、バックエンドのセッションログにはスロットリング（`sessionLogLastEmit`）が既にあるため、ping自体の頻度は制限されており、実質的な問題にはなりにくい。

---

### I-8: `handleNewWindow` — snapshot-refetch 失敗時のロールバック先変更
- **ファイル**: `command_router_handlers_window.go` (diff 行306-312)
- **深刻度**: Important
- **詳細**:
旧コードでは `GetSession` に失敗した場合、`newSessionSnap = nil` にセットしてlegacy pathにフォールバックしていた。新コードでは `rollbackSession` でセッション自体を削除する。

この変更は安全方向への変更だが、「セッション作成直後に `GetSession` が失敗する」状況は内部一貫性の崩壊を意味するため、ロールバックは過剰反応の可能性もある。ただし、部分的に初期化されたセッションを残すよりは安全。

→ **変更は適切。ただし、テストで `GetSession` 失敗パスをカバーするべき。**

---

### I-9: `cleanupOldSessionLogs` — 現在のファイルをスキップするが、ソート順に依存
- **ファイル**: `app_session_log.go` (diff 行74-78)
- **深刻度**: Important
- **詳細**:
```go
for _, name := range logFiles[:excess] {
    if name == currentFile {
        // Never delete the active session log file for this process.
        continue
    }
```
`currentFile` がソート順で `logFiles[:excess]` の範囲に入った場合、スキップにより実際に削除されるファイル数が `excess - 1` になる。これにより、`sessionLogMaxFiles` を1つ超えたファイルが残る可能性がある。

→ 厳密な上限管理よりも、アクティブファイルの保護を優先する設計は適切。minor issue。

---

## Suggestions (12 件)

### S-1: `parseNULSeparatedGitPaths` — バックスラッシュパスの正規化漏れ
- **ファイル**: `app_devpanel_api.go` (diff 行248)
- **詳細**: `filepath.ToSlash(entry)` は各パスに適用されているが、Windows上で `git ls-files -z` がバックスラッシュパスを返すケースは稀（gitはforward slashを返すことが多い）。現状は問題ないが、念のため正規化が行われている点は良い設計。

### S-2: `WorkingDiffStatus` が型エイリアス（`= string`）
- **ファイル**: `app_devpanel_types.go` (diff 行26)
- **詳細**: コメントにトレードオフが記述されており、Wails TSバインディングの制約上は適切な判断。将来的にWails v3でTypeScript型生成が改善された際に、defined typeへの移行を検討可能。

### S-3: テストコードでの `stubRuntimeEventsEmit(t)` 共通化
- **ファイル**: `app_session_log_test.go` (複数箇所)
- **詳細**: 以前の `oldEmitFn` パターンが `stubRuntimeEventsEmit(t)` に統一されており、テストの可読性とメンテナンス性が向上。良いリファクタリング。

### S-4: `snapshotEventPolicies` のコメント文字化け
- **ファイル**: `app_events.go` (diff 行63-72, 85-86)
- **詳細**: 差分上で文字化けしているコメントがある:
  - `窶・retained for future` — `—` (em dash) が化けている
  - `迴ｾ蝨ｨ縺ｮ繧｢繝ｼ繧ｭ繝`, `繧ｻ繝・す繝ｧ繝ｳ縺斐→縺ｫ` — 日本語コメントが完全に文字化け

  **修正必須**: UTF-8 BOMなしで再保存し、コメントが正しくエンコードされていることを確認する。`CLAUDE.md` の仕様「全てUTF8でBOM無しとする」に準拠しているか確認が必要。

### S-5: `bytes.IndexByte(probe, 0)` への変更
- **ファイル**: `app_devpanel_api.go` (diff 行59)
- **詳細**: `bytes.ContainsRune(probe, '\x00')` から `bytes.IndexByte(probe, 0) >= 0` への変更。`IndexByte` の方がパフォーマンスが良い（ルーンデコード不要）。良い改善。

### S-6: `DevPanelCommitDiff` に `--` 追加
- **ファイル**: `app_devpanel_api.go` (diff 行99)
- **詳細**: `diff-tree` コマンドに `--` を追加してオプション終端を明示。commitHashが `ValidateCommitish` で検証済みであるため実質的リスクは低いが、防御的コーディングとして適切。

### S-7: `ringBuffer.push` の `cap` → `bufCap` リネーム
- **ファイル**: `app_session_log_types.go` (diff 行38-54)
- **詳細**: Go組み込み関数 `cap()` との名前衝突を回避するリネーム。良い改善。

### S-8: `snapshot()` での `min()` 使用
- **ファイル**: `app_session_log_types.go` (diff 行70)
- **詳細**: 
```go
first := min(bufCap-rb.head, rb.count)
```
Go 1.21+ の組み込み `min` を使用。可読性が向上。

### S-9: `go:fix inline` ディレクティブ
- **ファイル**: `internal/testutil/helpers.go` (diff 行15)
- **詳細**: Go 1.24+ の `go:fix inline` を使用して `testutil.Ptr` のインライン化を指示。`CLAUDE.md` で Go 1.26 が最新とされているため、互換性に問題なし。

### S-10: `injectTestWindow` テストヘルパー
- **ファイル**: `command_router_test_helpers_test.go` (diff 行28-65)
- **詳細**: `AddWindow` が削除されたため、インジェクションヘルパーで内部状態を直接操作。テスト目的としては適切だが、`SessionManager` 内部の構造変更時に追従が必要。`t.Helper()` 呼び出しも正しい。

### S-11: `ActivityStrip` の position フィルタリング
- **ファイル**: `ActivityStrip.tsx` (diff 行23-24)
- **詳細**: `top` / `bottom` でビューを分離し、spacerで視覚的に区切る設計は直感的。ただし、`position` のデフォルト値が `undefined`（= topとして扱われる）であることを明示するコメントがあるとより良い。

### S-12: `ErrorLogView.tsx` の key 変更
- **ファイル**: `ErrorLogView.tsx` (diff 行119)
- **詳細**: `key={\`${entry.ts}-${i}\`}` から `key={entry.seq}` への変更。`seq` は一意かつ安定した識別子であるため、React の再レンダリング最適化に有効。良い改善。

---

## Positive Observations (良い点)

1. **ping+fetch モデルへの移行**: スロットリングによるデータ損失の完全排除は、アーキテクチャ上の正しい判断。
2. **防御的コーディングの徹底**: パストラバーサル防止（`isPathWithinBase` + `EvalSymlinks`）、シンボリックリンクスキップ、バイナリ検出など多層防御が実装されている。
3. **テストの充実**: 新規追加コードに対するテスト網羅率が高い。特にエッジケース（空ファイル、パスエスケープ、シンボリックリンク、文字化けパス）のテストが適切。
4. **テストヘルパーの共通化**: `stubRuntimeEventsEmit(t)` パターンの導入でテストコードの重複が削減。
5. **コメントの質**: IMP/SUG/NOTE プレフィックスによる設計意図の文書化が一貫している。
6. **イベント処理のFetchSeq**: `errorLogFetchSeq` による古いレスポンスの破棄は、非同期レースコンディションの適切な対処。

---

## Recommended Action

1. **C-1 (Critical) を最優先で修正**: `buildUntrackedFileDiffsWithBudget` の予算チェック条件バグ
2. **S-4 のコメント文字化けを確認・修正**: エンコーディング問題が実ファイルに存在するか確認
3. **I-1, I-5 の非対称エラーハンドリングを検討**
4. **I-8 のテスト追加を検討**: snapshot-refetch 失敗パスのテスト
5. 他の指摘は次スプリントで対応可

---

## 並列作業可否テーブル

以下は各タスクの修正に関して並列で作業可能かどうかの判定表です。  
**作業者が複数人いる場合**に、同時着手しても安全かを示しています。

| # | タスクID | 対象ファイル | 指摘概要 | 優先度 | 作業量(目安) | 並列OK | 競合リスクのあるタスク | 備考 |
|---|---------|------------|---------|--------|------------|--------|-------------------|------|
| 1 | C-1 | `app_devpanel_api.go` | `buildUntrackedFileDiffsWithBudget` の予算チェック条件バグ修正 | 🔴 Critical | 小 (1行) | ✅ 可 | なし | 独立した関数内の修正。他タスクと競合しない |
| 2 | C-2 | `app_devpanel_api.go` | `buildUntrackedFileDiffSingle` の cachedInfo/lstatInfo 不整合対応 | 🔴 Critical | 中 (数行) | ⚠️ 条件付き | C-1 (同一ファイル) | C-1と同じファイルだが関数が異なる。C-1と**同時に修正する場合は1人が担当**すること |
| 3 | C-3 | `app_session_log.go` | `initSessionLog` のロック範囲コメント追加 | 🔴 Critical | 小 (コメントのみ) | ✅ 可 | なし | コメント追加のみ。他ファイルへの影響なし |
| 4 | I-1 | `app_devpanel_api.go` | `parseWorkingDiff` のカウントロジック改善 | 🟡 Important | 中 | ⚠️ 条件付き | C-1, C-2 (同一ファイル) | C-1/C-2と同じファイル。**同一ファイルの修正は1人にまとめる**のが安全 |
| 5 | I-2 | `errorLogStore.ts` | 初回ロード時の既読扱いの設計検討 | 🟡 Important | 小 (設計判断) | ✅ 可 | なし | フロントエンドのみ。バックエンドと独立 |
| 6 | I-3 | `handler.go` | panic recovery のスタックサイズ制限検討 | 🟡 Important | 小 | ✅ 可 | なし | 独立した内部パッケージ |
| 7 | I-4 | `viewerRegistry.ts` | globalThis キー衝突防止の検討 | 🟡 Important | 小 | ✅ 可 | なし | フロントエンドのみ |
| 8 | I-5 | `app_devpanel_api.go` | freshRepo エラーハンドリング非対称性修正 | 🟡 Important | 中 | ⚠️ 条件付き | C-1, C-2, I-1 (同一ファイル) | **`app_devpanel_api.go` の全修正は1人が担当**すべき |
| 9 | I-7 | `useBackendSync.ts` | デバウンスに最大待機時間を設ける | 🟡 Important | 中 | ✅ 可 | なし | フロントエンドのみ。errorLogStoreとは直接競合しない |
| 10 | I-8 | `command_router_handlers_window.go` + テスト | snapshot-refetch 失敗パスのテスト追加 | 🟡 Important | 中 | ✅ 可 | なし | tmuxパッケージ内で完結 |
| 11 | I-9 | `app_session_log.go` | cleanupでcurrentFileスキップ時の削除数不足 | 🟡 Important | 小 | ⚠️ 条件付き | C-3 (同一ファイル) | C-3と同じファイル。コメントvs実装の修正なので**まとめて1人が対応**が安全 |
| 12 | S-4 | `app_events.go` | コメント文字化けの確認・修正 | 🟡 Important | 小 | ✅ 可 | なし | 独立したファイルのコメント修正 |
| 13 | S-11 | `ActivityStrip.tsx` | position デフォルト値のコメント追加 | 🟢 Suggestion | 極小 | ✅ 可 | なし | フロントエンドのみ |

### 並列作業の推奨グルーピング

実際に並列作業を行う場合、以下のグループ分けを推奨します:

| グループ | 担当タスク | 理由 |
|---------|----------|------|
| **グループA: バックエンド DevPanel** | C-1, C-2, I-1, I-5 (+ I-4相談) | 全て `app_devpanel_api.go` への修正。**1人で担当必須** |
| **グループB: バックエンド SessionLog** | C-3, I-9, I-11 | `app_session_log.go` への修正。**1人で担当推奨** |
| **グループC: バックエンド internal** | I-3, I-8, I-10 | `internal/` パッケージの修正。各ファイル独立のため並列OK |
| **グループD: フロントエンド** | I-2, I-7, S-11, S-12, S-13 | フロントエンドファイルのみ。バックエンドと完全独立で並列OK |
| **グループE: コメント/エンコーディング** | S-4, S-11 | コメントのみの修正。他グループと並列OK |

### 凡例

- ✅ **可**: 他のタスクと完全に独立しており、別の作業者が同時に着手可能
- ⚠️ **条件付き**: 同一ファイルまたは密接に関連するコードへの変更があるため、条件付きで並列可能（グルーピング参照）
- ❌ **不可**: 直列で実施する必要がある（該当なし）
