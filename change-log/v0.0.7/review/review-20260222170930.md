# PR Review Summary
**レビュー日時:** 2026-02-22 17:09  
**対象:** コミット前差分 40ファイル  
**レビュー方針:** [review-pr-para.prompt.md](../../.github/prompts/review-pr-para.prompt.md) 準拠  
**CLAUDE.md準拠確認:** ✅ 確認済み

---

## 変更概要

本PRは以下の主要な変更を含む:

1. **DevPanel WorkingDiff API** — 新規 `DevPanelWorkingDiff` エンドポイント（Git作業ディレクトリ差分 + Untrackedファイル合成差分）
2. **Session Log イベントモデル刷新** — `app:error-logged`（ペイロード付き）→ `app:error-log-updated`（ping+fetch）方式
3. **SessionLogEntry に `Seq` フィールド追加** — monotonic sequence numberによるフロントエンド安定重複排除
4. **TeeHandler 改善** — コールバックpanic recovery、base handler error時もコールバック実行継続
5. **フロントエンド Viewer レジストリ刷新** — globalThis シングルトン化、HMR対応、position属性追加
6. **Tmux Window管理強化** — `handleNewWindow` snapshot-refetch ロールバック、`injectTestWindow` テストヘルパー
7. **ログプレフィックス統一** — `[DEBUG-*]` → `[CATEGORY]` 形式に全面置換

---

## レビューカテゴリ別分類

### カテゴリA: DevPanel API / WorkingDiff（7ファイル）
- `app_devpanel_api.go` (+591行)
- `app_devpanel_api_test.go` (+731行)
- `app_devpanel_types.go` (+35行)
- `frontend/wailsjs/go/main/App.d.ts`, `App.js`, `models.ts`
- `frontend/src/api.ts`

### カテゴリB: Session Log / Error Log バックエンド（6ファイル）
- `app.go`, `app_session_log.go`, `app_session_log_test.go`
- `app_session_log_types.go`
- `app_lifecycle.go`, `app_lifecycle_test.go`

### カテゴリC: Frontend Viewer / ErrorLog（11ファイル）
- `errorLogStore.ts`, `useBackendSync.ts`
- `ActivityStrip.tsx`, `ViewerSystem.tsx`, `viewerRegistry.ts`
- `ErrorLogView.tsx`, `useErrorLog.ts`, `error-log/index.ts`
- `DiffViewer.tsx`, `base.css`, `viewer.css`

### カテゴリD: TeeHandler / SessionLog内部（4ファイル）
- `internal/sessionlog/handler.go`, `handler_test.go`
- `internal/testutil/helpers.go`

### カテゴリE: Tmux Window管理（10ファイル）
- `command_router.go`, `command_router_handlers_window.go`
- `command_router_handlers_window_test.go`
- `command_router_test_helpers_test.go`, `command_router_env_test.go`
- `session_manager_windows.go`
- `session_manager_directional_test.go`, `session_manager_pane_io_test.go`
- `session_manager_test.go`, `session_manager_window_test.go`

### カテゴリF: ログプレフィックス統一 / 軽微変更（2ファイル）
- `app_pane_api.go`, `app_events.go`, `app_events_test.go`

---

## Critical Issues（3件）

### CRIT-01: `buildUntrackedFileDiffSingle` — `os.Lstat` + `EvalSymlinks` の冗長ダブルstat
**ファイル:** `app_devpanel_api.go` (差分 L343-L384)  
**カテゴリ:** A  
**詳細:**  
`buildUntrackedFileDiffSingle` は以下の順序で操作を行う:
1. `isPathWithinBase(absPath, workDir)` — 字面チェック
2. `filepath.EvalSymlinks(workDir)` + `filepath.EvalSymlinks(absPath)` — symlink解決
3. `isPathWithinBase(resolvedAbs, resolvedBase)` — 解決後チェック
4. `os.Lstat(absPath)` — symlink判定
5. `lstatInfo.Mode()&os.ModeSymlink != 0` — symlink除外

**問題:** ステップ2の `filepath.EvalSymlinks(absPath)` はターゲットが存在しない場合にエラーを返す（`os.Lstat` より先にfailする）。しかし呼び出し元の `buildUntrackedFileDiffsWithBudget` が先に `os.Lstat` を行い、その結果 `cachedInfo` として渡している。**渡された `cachedInfo` が `os.Stat` の結果（symlink解決済み）だと、ステップ4の `os.Lstat` と矛盾が発生する。**

具体的に、呼び出し元の `buildUntrackedFileDiffsWithBudget` L276 では:
```go
entry := buildUntrackedFileDiffSingle(workDir, relPath, info)
```
この `info` は `d.Info()` から取得しており、`fs.DirEntry.Info()` は `os.Lstat` 相当の情報を返す（symlink解決しない）ため問題は起きない。

しかし、テスト `TestBuildUntrackedFileDiffSingle_CachedFileInfo` (差分 L749-L767) では `os.Stat` を使用:
```go
info, err := os.Stat(filepath.Join(tmpDir, "cached.txt"))
```
`os.Stat` は symlink を解決した結果を返すため、もし `cached.txt` が symlink だった場合、`cachedInfo` は解決先のファイル情報を持つが、`os.Lstat` はsymlink自体の情報を返す。テストでは通常のファイルなので問題ないが、テストの意図としてAPIの正当性を証明するには不十分。

**修正案:** テスト `TestBuildUntrackedFileDiffSingle_CachedFileInfo` を `os.Lstat` に変更するか、コメントでSymlink以外用途であることを明記する。

---

### CRIT-02: `DevPanelWorkingDiff` — fresh repo 時の `diff --cached` に `--` ターミネーター未付与
**ファイル:** `app_devpanel_api.go` (差分 L140-L143)  
**カテゴリ:** A  
**詳細:**  
`DevPanelCommitDiff` では `commitHash` 後に `"--"` を追加（差分 L99）しているが、fresh repo パスの `git diff --cached --no-color` にはターミネーターが無い:
```go
output, gitErr = gitpkg.RunGitCLIPublic(workDir, []string{
    "-c", "core.quotepath=false",
    "diff", "--cached", "--no-color",
})
```
通常パス `git diff HEAD --no-color` にも `"--"` が無い:
```go
output, gitErr = gitpkg.RunGitCLIPublic(workDir, []string{
    "-c", "core.quotepath=false",
    "diff", "HEAD", "--no-color",
})
```

**リスク:** ファイル名が `--` で始まる場合にgitがオプションとして解釈する可能性がある。`DevPanelCommitDiff` で `"--"` を追加した同じ理由がここにも当てはまる。

**修正案:** 両方のgit diffコマンドの末尾に `"--"` を追加する。

---

### CRIT-03: `writeSessionLogEntry` — Sync() 中に `closeSessionLog()` が先に完了するとファイルが閉じた状態でSyncが呼ばれる
**ファイル:** `app_session_log.go` (差分 L147-L159)  
**カテゴリ:** B  
**詳細:**  
ロック外での `syncFile.Sync()` は意図的に設計されている（コメントA-0b）。しかし、以下のレース:
1. `writeSessionLogEntry` がロック内で `syncFile = a.sessionLogFile` をキャプチャ
2. ロック解放
3. `closeSessionLog()` がロック取得 → `a.sessionLogFile.Close()` → `a.sessionLogFile = nil`
4. `writeSessionLogEntry` が `syncFile.Sync()` を実行 → 閉じたファイルへのSync

コードには既にこのレースを認識したコメントとエラーハンドリングがある:
```go
isExpectedCloseRace := errors.Is(syncErr, os.ErrClosed) ||
    (runtime.GOOS == "windows" && errors.Is(syncErr, syscall.EINVAL))
```
これは**設計上許容されたレース**であり、エラーハンドリングも適切。

**評価:** 当コードは正しく処理されており、コメントも十分。**Criticalではなく、設計意図の確認として記録**。

**→ 再評価: このレースは設計ドキュメント通りに適切にハンドリングされている。Critical取り下げ → Strengthsに移動。**

---

## Important Issues（8件）

### IMP-01: `parseDiffHeaderPaths` — rename時のフォールバック分割で ` b/` を含むパスに誤判定
**ファイル:** `app_devpanel_api.go` (差分 L573-L608)  
**カテゴリ:** A  
**詳細:**  
コメント IMP-01 で既に認識済み。rename時の `" b/"` でのフォールバック分割は、旧パスに `" b/"` を含む場合に不正確な結果を返す。`parseWorkingDiff` の `rename from`/`rename to` 行で上書きされるため実質的には問題ないが、中間状態で不正パスが一時的にセットされる。

**影響度:** 低（後段で修正される）  
**修正案:** コメントで十分にドキュメント化されている。追加アクション不要だが、パスに ` b/` を含むrename時のテストケース追加を推奨する。

---

### IMP-02: `collectUntrackedFiles` — git ls-files の `-z` 出力で改行を含むパスが `parseNULSeparatedGitPaths` で正しく処理されるか
**ファイル:** `app_devpanel_api.go` (差分 L214-L251)  
**カテゴリ:** A  
**詳細:**  
`-z` オプションにより NUL区切りで出力されるため、改行を含むファイル名も正しく分割される。テスト `TestParseNULSeparatedGitPaths` (差分 L497-L511) で `dir/line\nbreak.txt` を含むケースが検証されている。

**評価:** 実装・テストともに適切。テストケースが存在していることを確認。

---

### IMP-03: `buildUntrackedFileDiffSingle` — `cachedInfo` variadic引数のAPI設計
**ファイル:** `app_devpanel_api.go` (差分 L343)  
**カテゴリ:** A  
**詳細:**  
```go
func buildUntrackedFileDiffSingle(workDir, relPath string, cachedInfo ...os.FileInfo) *WorkingDiffFile {
```
Variadic `cachedInfo` で0個または1個の `os.FileInfo` を渡す設計。Go的には一般的だが、2個以上渡された場合のハンドリングが無い（`cachedInfo[0]` のみ使用）。公開されていない内部関数のため問題は小さいが、コメントに「0 or 1 only」と明記すべき。

**修正案:** コメントに `cachedInfo` は最大1個であることを明記する。

---

### IMP-04: `errorLogStore.ts` — `normalizeEntries` でのfilter + sort + sliceは毎回全配列操作
**ファイル:** `frontend/src/stores/errorLogStore.ts` (差分 L29-L34)  
**カテゴリ:** C  
**詳細:**  
```typescript
function normalizeEntries(incoming: ErrorLogEntry[]): ErrorLogEntry[] {
    return incoming
        .filter((entry) => isValidSeq(entry.seq))
        .sort((a, b) => a.seq - b.seq)
        .slice(-MAX_ENTRIES);
}
```
毎回 `setEntries` が呼ばれるたびに全配列をfilter → sort → sliceする。MAX_ENTRIES=10000の範囲では性能問題にならないが、`useBackendSync` のデバウンスが80msなので、高頻度ログ環境では毎回の配列操作コストが蓄積する可能性がある。

**影響度:** 低（10000エントリの配列操作は数ms以内）  
**修正案:** 現状で問題ない。パフォーマンス問題が観測された場合にのみ最適化を検討。

---

### IMP-05: `viewerRegistry.ts` — `import.meta.hot.dispose` 後の `registry.length = 0` がHMR時に既存View参照を破壊
**ファイル:** `frontend/src/components/viewer/viewerRegistry.ts` (差分 L41-L44)  
**カテゴリ:** C  
**詳細:**  
```typescript
if (import.meta.hot) {
    import.meta.hot.dispose(() => {
        registry.length = 0;
    });
}
```
`dispose` で配列をクリアした後、各viewモジュールが再インポートされて `registerView` が再実行される。`globalThis` ベースのシングルトンにより、HMR時に配列参照が維持される設計。

**リスク:** `dispose` のタイミングと各viewモジュールの再実行タイミングに依存するが、Vite HMRの動作上、dispose → 再実行の順序は保証される。

**評価:** 設計として適切。

---

### IMP-06: `handleNewWindow` — snapshot-refetch失敗時のロールバックでイベント漏れ防止
**ファイル:** `internal/tmux/command_router_handlers_window.go` (差分 L304-L309)  
**カテゴリ:** E  
**詳細:**  
```go
newSessionSnap, snapOk := getSession(newSessionName)
if !snapOk {
    return rollbackSession("snapshot-refetch", fmt.Errorf("session disappeared after flag copy: %s", newSessionName))
}
```
snapshot-refetch失敗時にロールバックを実行する改善。テスト `TestHandleNewWindow` に `wantRollback` フラグが追加され、ロールバック時に `tmux:session-created` イベントが漏れないことも検証されている。

**評価:** 良い改善。テストカバレッジも適切。

---

### IMP-07: `useBackendSync.ts` — `errorLogFetchSeq` リセットがunmount時に `0` に設定される
**ファイル:** `frontend/src/hooks/useBackendSync.ts` (差分 L117)  
**カテゴリ:** C  
**詳細:**  
```typescript
return () => {
    isMountedRef.current = false;
    errorLogFetchSeq = 0;  // ← リセット
```
これはクリーンアップ時に正しい動作。次のマウント時に `fetchErrorLog` が新しいseqから始まるため問題ない。

**評価:** 適切。

---

### IMP-08: `initSessionLog` でのロック追加 — 初期化時のロック粒度
**ファイル:** `app_session_log.go` (差分 L37-L41)  
**カテゴリ:** B  
**詳細:**  
```go
a.sessionLogMu.Lock()
a.sessionLogFile = f
a.sessionLogPath = fullPath
a.sessionLogMu.Unlock()
```
`initSessionLog` は起動時の `startup()` から呼ばれる。この時点で並行アクセスが発生する可能性は低いが、防御的にロックを追加。`cleanupOldSessionLogs` 内でも `RLock` で `sessionLogPath` を読み取る改善が入っている。

**評価:** 正しい防御的コーディング。特に `cleanupOldSessionLogs` が別のgoroutineから呼ばれる可能性を考慮した適切な変更。

---

## Suggestions（10件）

### SUG-01: `buildUntrackedFileDiffSingle` — ファイルサイズ上限をconst参照に統一
**ファイル:** `app_devpanel_api.go`  
**カテゴリ:** A  
`devPanelMaxUntrackedFileSize` (100KB) と `devPanelMaxDiffSize` (500KB) の関係をコメントで明記。1つのuntrackedファイルが最大100KBで、全体が500KB制限。

---

### SUG-02: `parseWorkingDiff` — `\r\n` → `\n` 正規化がdiffコンテンツの内部行にも影響
**ファイル:** `app_devpanel_api.go` (差分 L469-L470)  
**カテゴリ:** A  
正規化は差分ヘッダーのパス抽出精度向上が目的だが、diff本文の `\r\n` も正規化される。Windows環境のgitは通常LFで出力するため実質的な影響はないが、コメントでスコープを明記すべき。

---

### SUG-03: `ErrorLogView.tsx` のCallback ref — `cleanupRef` パターン
**ファイル:** `frontend/src/components/viewer/views/error-log/ErrorLogView.tsx` (差分 L32-L85)  
**カテゴリ:** C  
callback refによるDOM要素のリスナー管理パターンとしてよく設計されているが、`bodyRefCallback` の deps に `registerBodyElement` を含めている:
```typescript
}, [registerBodyElement]);
```
`registerBodyElement` は `useCallback([], [])` で安定しているので問題ない。

---

### SUG-04: `cleanupOldSessionLogs` — currentFile の自己削除防止ロジック
**ファイル:** `app_session_log.go` (差分 L77-L85)  
**カテゴリ:** B  
```go
if name == currentFile {
    // Never delete the active session log file for this process.
    continue
}
```
良い改善。テスト `TestCleanupOldSessionLogs_PreservesCurrentFile` (差分 L143-L170) も追加されている。

---

### SUG-05: `sessionLogRingBuffer` — `cap` → `bufCap` の変数名変更
**ファイル:** `app_session_log_types.go` (差分 L38-L57)  
**カテゴリ:** B  
Go の組み込み関数 `cap()` とのシャドウイングを回避する適切な変更。`bufCap == 0` のガード追加も防御的。

---

### SUG-06: `ActivityStrip.tsx` — `position` による上下分割
**ファイル:** `frontend/src/components/viewer/ActivityStrip.tsx` (差分 L23-L24)  
**カテゴリ:** C  
```typescript
const topViews = views.filter((view) => view.position !== "bottom");
const bottomViews = views.filter((view) => view.position === "bottom");
```
error-logが `position: "bottom"` に配置される設計。spacerの `flex: 1` で上下を分離。

---

### SUG-07: `testutil.Ptr` — `//go:fix inline` ディレクティブ
**ファイル:** `internal/testutil/helpers.go` (差分 L15)  
**カテゴリ:** D  
Go 1.24+ の `go fix` インライン化ディレクティブ追加。CLAUDE.md に「Go 1.26」と記載があるため互換性問題なし。

---

### SUG-08: `injectTestWindow` テストヘルパー — SessionManager内部直接操作
**ファイル:** `internal/tmux/command_router_test_helpers_test.go` (差分 L22-L65)  
**カテゴリ:** E  
`AddWindow` が1-windowモデルで削除されたため、テスト用に内部フィールドを直接操作するヘルパー。マルチウィンドウ経路のテストに必要な設計上のトレードオフ。

---

### SUG-09: `ViewerSystem.tsx` — `shortcutMap` の `useMemo([], [])` 
**ファイル:** `frontend/src/components/viewer/ViewerSystem.tsx` (差分 L41-L50)  
**カテゴリ:** C  
```typescript
const shortcutMap = useMemo(() => {
    const views = getRegisteredViews();
    const map = new Map<string, string>();
    for (const view of views) {
        if (view.shortcut) {
            map.set(view.shortcut.toLowerCase(), view.id);
        }
    }
    return map;
}, []);
```
空依存配列でモジュール評価後のレジストリが安定している前提。コメントで注意書きがあり適切。

---

### SUG-10: `command_router_env_test.go` — `copy` → `got` 変数名変更
**ファイル:** `internal/tmux/command_router_env_test.go` (差分 L9-L37)  
**カテゴリ:** E  
Go の組み込み関数 `copy()` とのシャドウイング回避。適切なリファクタリング。

---

## Strengths（良い点）

### STR-01: ping+fetch イベントモデル（A-0）
`app:error-logged` → `app:error-log-updated` への変更は、スロットリングによるデータ損失を完全に排除する優れた設計変更。バックエンドはペイロードなしのpingを送信し、フロントエンドが `GetSessionErrorLog()` で完全スナップショットをフェッチする。

### STR-02: monotonic sequence number (Seq)
`SessionLogEntry.Seq` の追加により、弱い複合キー（ts|level|msg|source、秒精度で衝突）に代わる安定した重複排除が実現。uint64で3000年以上のオーバーフロー耐性。

### STR-03: TeeHandler のpanic recovery
コールバックのpanicがアプリケーション全体をクラッシュさせないよう `defer recover` を追加。stderrへの出力でslog再帰を回避。

### STR-04: テストカバレッジの充実
WorkingDiff関連の新テストが700行以上追加。parseWorkingDiff、buildUntrackedFileDiffs、parseDiffHeaderPaths、needsGitQuoting等、全ての新関数にテーブル駆動テストが実装されている。

### STR-05: フィールド数ガードテスト
`TestWorkingDiffFileFieldCountGuard` / `TestWorkingDiffResultFieldCountGuard` によるフィールド追加時のフロントエンド整合性検知メカニズム。

### STR-06: Sync() の closeSessionLog レース対策
`isExpectedCloseRace` による `os.ErrClosed` / Windows `EINVAL` のgracefulハンドリング。設計上許容されたレースを正しく処理。

### STR-07: `stubRuntimeEventsEmit(t)` テストヘルパー統一
テスト全体で `runtimeEventsEmitFn` のスタブ化パターンを共通化。DRY原則に準拠。

### STR-08: セキュリティ — パストラバーサル防止
`buildUntrackedFileDiffSingle` での字面ガード + symlink解決後のガードの二重チェック。パストラバーサル攻撃を防止。CLAUDE.md の「内部利用のため外部公開リスクは指摘しない」という方針があるが、防御的に実装されている点は優れている。

---

## Recommended Action

1. **CRIT-01:** テストの `os.Stat` → `os.Lstat` 変更またはコメント追記
2. **CRIT-02:** `git diff --cached` / `git diff HEAD` への `"--"` ターミネーター追加
3. IMP-01〜IMP-08 は既存コードと整合性があり、指摘事項の対応は推奨レベル
4. SUG-01〜SUG-10 はコード品質改善の提案

---

## 並列作業可否一覧表

以下の表は、各タスクの修正作業を**並列（パラレル）で実施する際に競合が発生するか**を示します。

| # | 重要度 | タスクID | タスク内容 | 対象ファイル | 並列作業 | 補足（競合リスク） |
|---|--------|----------|-----------|-------------|---------|-------------------|
| 1 | Critical | CRIT-01 | `TestBuildUntrackedFileDiffSingle_CachedFileInfo` の `os.Stat` → `os.Lstat` 変更 | `app_devpanel_api_test.go` | ✅ 可能 | テストファイルのみの変更。他タスクと競合なし |
| 2 | Critical | CRIT-02 | `DevPanelWorkingDiff` の git diff コマンドに `"--"` ターミネーター追加 | `app_devpanel_api.go` | ✅ 可能 | IMP-03と同一ファイルだが別関数・別行。並行編集可 |
| 3 | Important | IMP-01 | `parseDiffHeaderPaths` rename + ` b/` パス含有テスト追加 | `app_devpanel_api_test.go` | ⚠️ 注意 | CRIT-01と同一ファイル。テスト追加のみなので末尾付近に追記すれば競合低 |
| 4 | Important | IMP-03 | `buildUntrackedFileDiffSingle` の `cachedInfo` コメント追記 | `app_devpanel_api.go` | ✅ 可能 | CRIT-02と同一ファイルだがコメント追記のみで別の関数 |
| 5 | Important | IMP-04 | `normalizeEntries` 性能コメント追記 | `errorLogStore.ts` | ✅ 可能 | 単独ファイル、コメントのみ |
| 6 | Important | IMP-05 | `viewerRegistry.ts` HMR dispose 設計確認 | `viewerRegistry.ts` | ✅ 可能 | 単独ファイル |
| 7 | Important | IMP-06 | `handleNewWindow` snapshot-refetch ロールバック確認 | `command_router_handlers_window.go` | ✅ 可能 | 変更なし（確認のみ） |
| 8 | Important | IMP-08 | `initSessionLog` ロック追加確認 | `app_session_log.go` | ✅ 可能 | 変更なし（確認のみ） |
| 9 | Suggestion | SUG-01 | ファイルサイズ制限関係のコメント追加 | `app_devpanel_api.go` | ⚠️ 注意 | CRIT-02/IMP-03と同一ファイル。コメントのみなので低リスク |
| 10 | Suggestion | SUG-02 | `parseWorkingDiff` CR/LF正規化スコープコメント追加 | `app_devpanel_api.go` | ⚠️ 注意 | 上記同一ファイル |

### 並列作業ガイド

```
【グループ1 — 独立作業可能】
├── CRIT-01: app_devpanel_api_test.go (テスト修正)
├── IMP-04:  errorLogStore.ts (コメント追記)
├── IMP-05:  viewerRegistry.ts (確認のみ)
├── IMP-06:  command_router_handlers_window.go (確認のみ)
└── IMP-08:  app_session_log.go (確認のみ)

【グループ2 — 同一ファイル注意】
├── CRIT-02: app_devpanel_api.go (git diffに"--"追加)
├── IMP-03:  app_devpanel_api.go (コメント追記)
├── SUG-01:  app_devpanel_api.go (コメント追記)
└── SUG-02:  app_devpanel_api.go (コメント追記)
→ これらは順次作業を推奨 or 一括修正

【グループ3 — 同一テストファイル注意】
├── CRIT-01: app_devpanel_api_test.go (テスト修正)
└── IMP-01:  app_devpanel_api_test.go (テスト追加)
→ ファイル末尾への追記とL749-L767の修正で位置が離れているため並列可能
```

### 作業者向けまとめ

| 作業順序 | 推奨アクション | 所要時間（目安） | 依存関係 |
|---------|-------------|----------------|---------|
| 1st | CRIT-02 修正（git diff に `"--"` 追加） | 5分 | なし |
| 1st | CRIT-01 修正（テストの `os.Stat` → `os.Lstat`） | 3分 | なし |
| 2nd | IMP-01 テスト追加（rename + ` b/` パス） | 10分 | CRIT-01と同一ファイルだが離れた位置 |
| 2nd | IMP-03 コメント追記 | 2分 | CRIT-02と同一ファイルだが別関数 |
| 3rd | SUG-01/02 コメント追記 | 5分 | グループ2の一括作業推奨 |
| Any | IMP-04〜08, SUG-03〜10 | 各2-5分 | 独立作業可能 |
