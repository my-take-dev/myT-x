# PR Review Summary

**レビュー日時**: 2026-02-22 17:10  
**対象ファイル数**: 40  
**レビュー方針**: review-pr-para.prompt.md + CLAUDE.md準拠  

---

## 変更概要

本PRは以下の主要な機能/改善を含む大規模なコミットです：

1. **DevPanel Working Diff機能** — `DevPanelWorkingDiff` API + diff解析ロジック + untracked file合成diff
2. **Session Log改善** — ping+fetchモデルへ移行、seq番号追加、PIDベースファイル命名
3. **TeeHandler改善** — panic recovery、base handler error時のcallback実行保証
4. **ログプレフィクス統一** — `[DEBUG-*]` → `[*]` への全面的リネーム
5. **フロントエンド改善** — errorLogStore seq対応、viewer registry HMR対応、ActivityStrip position対応
6. **tmux window関連** — window-createdイベント登録、injectTestWindow ヘルパー、handleNewWindow rollback改善
7. **リングバッファ改善** — capacity ≤ 0クランプ、cap→bufCapリネーム
8. **testutil改善** — `go:fix inline`ディレクティブ追加、boolPtr→testutil.Ptr統一

---

## カテゴリ分類（並列レビュー用）

| カテゴリ | ファイル群 |
|---------|-----------|
| **A: DevPanel API & Working Diff** | `app_devpanel_api.go`, `app_devpanel_api_test.go`, `app_devpanel_types.go` |
| **B: Session Log (Backend)** | `app_session_log.go`, `app_session_log_test.go`, `app_session_log_types.go`, `app.go` |
| **C: TeeHandler (Internal)** | `internal/sessionlog/handler.go`, `internal/sessionlog/handler_test.go` |
| **D: Events & Lifecycle** | `app_events.go`, `app_events_test.go`, `app_lifecycle.go`, `app_lifecycle_test.go`, `app_pane_api.go` |
| **E: Frontend ErrorLog & Store** | `errorLogStore.ts`, `useBackendSync.ts`, `ErrorLogView.tsx`, `useErrorLog.ts`, `error-log/index.ts` |
| **F: Frontend Viewer System** | `ActivityStrip.tsx`, `ViewerSystem.tsx`, `viewerRegistry.ts`, `DiffViewer.tsx`, CSSファイル群 |
| **G: Wails Bindings (生成物)** | `App.d.ts`, `App.js`, `models.ts`, `api.ts` |
| **H: tmux Window/Session Manager** | `command_router.go`, `command_router_handlers_window.go`, `command_router_handlers_window_test.go`, `command_router_test_helpers_test.go`, `session_manager_windows.go`, `session_manager_*_test.go` 群 |
| **I: テストユーティリティ** | `internal/testutil/helpers.go`, `command_router_env_test.go` |

---

## Critical Issues (0 found)

レビューの結果、Critical（マージ前に必ず修正すべき）レベルの問題は検出されませんでした。

---

## Important Issues (6 found)

### IMP-01: [code] `buildUntrackedFileDiffSingle` — cachedInfoとlstatInfoの一貫性問題  
**ファイル**: `app_devpanel_api.go` (差分 line 379-384)

```go
var info os.FileInfo
if len(cachedInfo) > 0 && cachedInfo[0] != nil {
    info = cachedInfo[0]
} else {
    info = lstatInfo
}
```

**問題**: `cachedInfo`は呼び出し元(`buildUntrackedFileDiffsWithBudget`)の`d.Info()`由来で、`os.Stat`相当（symlink解決済み）のinfoを返します。一方`lstatInfo`は`os.Lstat`由来（symlink未解決）です。`cachedInfo`が渡された場合と渡されない場合で、`info.Size()`や`info.IsDir()`の判定対象が異なる可能性があります。

しかし実際にはこの関数の前段でsymlinkチェックが行われており、symlinkは除外されているため、実害は発生しません。ただし、防御的コーディングの観点からコメントで意図を明記すべきです。

**推奨**: cachedInfoが渡された場合はsymlink解決後のinfoであることをコメントに追記する。

---

### IMP-02: [code] `buildUntrackedFileDiffSingle` — 二重stat（Lstat + EvalSymlinks）のコスト  
**ファイル**: `app_devpanel_api.go` (差分 line 354-384)

```go
resolvedBase, baseErr := filepath.EvalSymlinks(workDir)
// ...
resolvedAbs, evalErr := filepath.EvalSymlinks(absPath)
// ...
lstatInfo, err := os.Lstat(absPath)
```

**問題**: `filepath.EvalSymlinks`は内部でstat相当の処理を行い、さらに`os.Lstat`で再度statしています。cachedInfoが渡されていても常にLstat→EvalSymlinksが実行されます。ファイル数が多い場合（最大10000ファイル）、パフォーマンスに影響する可能性があります。

**推奨**: パスが既にsymlinkでないことがWalkDir経由で確認されている場合、`buildUntrackedFileDiffsWithBudget`内の呼び出し時にEvalSymlinks/Lstatの省略を検討するか、キャッシュ化を検討する。ただし、セキュリティガードとしての意図があるため、トレードオフを文書化すること。

---

### IMP-03: [code] `parseWorkingDiff` — `+++ b/path` とhunkの `+` 行の区別が不完全  
**ファイル**: `app_devpanel_api.go` (差分 line 521-525)

```go
} else if strings.HasPrefix(line, "+") && !strings.HasPrefix(line, "+++") {
    file.Additions++
} else if strings.HasPrefix(line, "-") && !strings.HasPrefix(line, "---") {
    file.Deletions++
}
```

**問題**: `"++ "` で始まる行（例: `++ some text`）は`++`で始まるが`+++`ではないため、加算行としてカウントされません。これは正常です。

ただし、`index`行や`similarity index`行なども`-`/`+`で始まりうるヘッダー行の可能性は低いですが、行頭が`+`/`-`かつhunk内でない場合のカウントが起こりえます。現在のコードはblockの全行をイテレートしており、hunkの開始を追跡していません。

しかし標準的なgit diffフォーマットでは、ヘッダー行は`diff --git`, `index`, `---`, `+++`, `@@`等で始まるため、実害は低いです。

**推奨**: hunk内のみでadditions/deletionsをカウントするロジックへの改善を検討。現状はbest-effortとして許容可能。

---

### IMP-04: [errors] `writeSessionLogEntry` — syncFileのクローズレースでのWindows EINVALハンドリング  
**ファイル**: `app_session_log.go` (差分 line 147-159)

```go
isExpectedCloseRace := errors.Is(syncErr, os.ErrClosed) ||
    (runtime.GOOS == "windows" && errors.Is(syncErr, syscall.EINVAL))
```

**問題**: `syscall.EINVAL`はWindows上で`FlushFileBuffers`がクローズ後のハンドルに対して返すエラーですが、他の無効な操作でもEINVALが返る場合があります。条件が広すぎる可能性があります。

**推奨**: コメントでEINVALがクローズレース以外でも発報する可能性を明記し、将来的な調査ポイントとする。現状の対応は合理的。

---

### IMP-05: [types] `WorkingDiffStatus = string` — 型エイリアスによる型安全性低下  
**ファイル**: `app_devpanel_types.go` (差分 line 26)

```go
type WorkingDiffStatus = string
```

**問題**: コメントにトレードオフが明記されていますが、Go側で任意のstringがWorkingDiffStatusとして渡されてもコンパイルエラーにならないため、typo等のバグがテストでしか検出できません。

**推奨**: 現時点では意図した設計のため問題なし。ただし将来的にWailsバインディングジェネレーターが改善された場合、defined typeへの変更を検討。

---

### IMP-06: [code] `ErrorLogView.tsx` — cleanupRefのuseRef + bodyRefCallbackパターンのエッジケース  
**ファイル**: `ErrorLogView.tsx` (差分 line 32-85)

**問題**: `bodyRefCallback`は`[registerBodyElement]`に依存していますが、`registerBodyElement`は`useCallback([], ...)`で安定しているため、実質的に一度しか呼ばれません。しかし、Reactの`ref`属性にcallbackを渡した場合、コンポーネントの再マウント時に`null`→`element`の順で呼ばれます。`cleanupRef.current()`が`null`呼び出し時に正しくクリーンアップされ、その後新しい要素で再登録されるため、このパターンは正しく動作します。

ただし、`cleanupRef`のクリーンアップがコンポーネントのアンマウント時に呼ばれない可能性があります（Reactがrefに`null`を渡すのはDOM要素がアンマウントされる時ですが、`bodyRefCallback`内のクリーンアップはコンポーネント全体のアンマウントでは呼ばれない場合があります）。

**推奨**: コンポーネントのアンマウント時に`cleanupRef.current?.()`を呼ぶuseEffectを追加するか、現状の動作を文書化する。Reactはrefにnullを渡すタイミングでcleanupが呼ばれるため、現状でも問題は発生しない。

---

## Suggestions (11 found)

### SUG-01: [simplify] `buildUntrackedFileDiffsWithBudget` — `remainingBudget == 0` チェック位置の最適化  
**ファイル**: `app_devpanel_api.go` (差分 line 304-307)

```go
if remainingBudget == 0 {
    budgetExceeded = true
    return fs.SkipAll
}
```

WalkDir内でループの最初にチェックしていますが、`remainingBudget`の一数が負数にはならないことが保証されていません。`remainingBudget >= 0` かつ `len(entry.Diff) > remainingBudget` の二段チェックが存在するため、実害はありませんが、`remainingBudget < 0`のケースにも防御的に対応すると安全です。

**推奨**: `remainingBudget == 0` → `remainingBudget <= 0` への変更を検討。

---

### SUG-02: [comments] `parseDiffHeaderPaths` — symmetry heuristicの説明コメント改善  
**ファイル**: `app_devpanel_api.go` (差分 line 586-598)

symmetry heuristicのロジックは正しいですが、`len(content) >= 3`と`2*pathLen+3 == len(content)`の意味（`" b/"` の3文字を跨ぐ分割）をもう少し明示的にコメントすると可読性が向上します。

---

### SUG-03: [simplify] `cleanupOldSessionLogs` — `currentFile`のスキップロジック  
**ファイル**: `app_session_log.go` (差分 line 77-85)

現在のファイルをスキップする処理は正しいですが、`logFiles[:excess]`をスライスする代わりにループ全体を走査するため、excessが大きい場合のパフォーマンスが若干低下します。ただし、`sessionLogMaxFiles = 100`なので実害はありません。

---

### SUG-04: [code] `errorLogStore.ts` — `normalizeEntries`のソートコスト  
**ファイル**: `errorLogStore.ts` (line 26-31)

```typescript
function normalizeEntries(incoming: ErrorLogEntry[]): ErrorLogEntry[] {
    return incoming
        .filter((entry) => isValidSeq(entry.seq))
        .sort((a, b) => a.seq - b.seq)
        .slice(-MAX_ENTRIES);
}
```

バックエンドからの応答は既にseq順に並んでいるはずですが、フロントエンドで常にソートしています。大量エントリ（最大10000件）がある場合のソートコストは軽微ですが、既ソート検出を入れることで最適化可能です。

---

### SUG-05: [tests] テスト内の `t.Fatal` vs `t.Fatalf` — 一貫性  
**ファイル**: `app_devpanel_api_test.go` 全般

テスト内で`t.Fatal(err)`と`t.Fatalf("...")`が混在しています。エラーメッセージの一貫性のため、`t.Fatalf`でコンテキスト情報を含めることを推奨します。ただしGo testの慣習的にはどちらも許容されます。

---

### SUG-06: [code] `viewerRegistry.ts` — globalThis への書き込み  
**ファイル**: `viewerRegistry.ts` (差分 line 31-37)

`globalThis`を型キャストして書き込むアプローチは、HMRで重複登録を防ぐため有効ですが、非標準であり、他のライブラリとのキー衝突リスクがあります。キー名`__mytx_view_registry__`は十分にユニークですが、Symbol を使うとさらに安全です。

---

### SUG-07: [code] `ViewerSystem.tsx` — `useMemo([], ...)` のショートカットマップ  
**ファイル**: `ViewerSystem.tsx` (差分 line 41-50)

`useMemo`の依存配列が空のため、初期化時のみ実行されます。レジストリが非reactiveであることはコメントで明記されており、現時点では正しいです。将来的にdynamic plugin登録が必要になった場合、reactiveなトリガーが必要になることをコメントに追記済みなので問題ありません。

---

### SUG-08: [code] `ActivityStrip.tsx` — `viewer-strip-spacer` のフレックスレイアウト  
**ファイル**: `ActivityStrip.tsx`, `viewer.css`

`flex: 1; min-height: 0;` でspacerを実現しています。親要素(`viewer-activity-strip`)が`flex-direction: column`であることを確認済みで、正しい実装です。

---

### SUG-09: [tests] `TestCleanupOldSessionLogs_PreservesCurrentFile` — Race condition考慮  
**ファイル**: `app_session_log_test.go` (差分 line 143-170)

テストではAppの`sessionLogMu`をロックせずに`sessionLogPath`を設定していますが、テスト内では並行アクセスがないため問題ありません。本番コードでは`initSessionLog()`が適切にロックしているので、テストの簡便さとしては妥当です。

---

### SUG-10: [code] `handler.go` (TeeHandler) — `debug.Stack()` の出力  
**ファイル**: `internal/sessionlog/handler.go` (差分 line 63)

```go
fmt.Fprintf(os.Stderr, "[session-log] callback panicked: %v\n%s\n", r, debug.Stack())
```

`debug.Stack()`はパフォーマンスコストがありますが、パニック時のみ実行されるため問題ありません。本番環境でのデバッグに有用な情報を提供します。

---

### SUG-11: [comments] `go:fix inline` ディレクティブ  
**ファイル**: `internal/testutil/helpers.go` (差分 line 15)

Go 1.24+の`go:fix inline`ディレクティブは、CLAUDE.mdで指定されたGo 1.26環境では利用可能です。段階的な移行を可能にする良い追加です。

---

## Strengths (良い点)

1. **セキュリティ意識**: `buildUntrackedFileDiffSingle`のレキシカルガード + シンボリックリンク解決後の二段階パス検証は堅牢
2. **ping+fetchモデル**: スロットリングによるデータロスを完全に排除し、frontendは常に最新のスナップショットを取得
3. **seq番号導入**: `ts|level|msg|source` の弱い複合キーからモノトニックseqへの移行は、重複排除の信頼性を大幅に向上
4. **リングバッファの防御的改善**: capacity ≤ 0のクランプ、`cap`→`bufCap`リネームによるビルトイン関数との衝突回避
5. **TeeHandlerの堅牢化**: panicリカバリ、base handler error時のcallback保証、WithAttrs/WithGroupの空引数最適化
6. **テスト品質**: field count guard（構造体変更検出）、rollback path検証、symlink skip、path escape、空ファイル等の網羅的テスト
7. **ログプレフィクス統一**: `[DEBUG-*]` → 機能別プレフィクスへの一貫した変更（全箇所漏れなく対応）
8. **HMR対応**: viewerRegistryのglobalThis + disposeパターンによる開発体験改善
9. **ドキュメンテーション**: NOTE, IMP, SUG等のトラッカーIDを用いた設計決定の記録
10. **Windows対応**: `syscall.EINVAL`のハンドリング、CR/LF正規化、`filepath.ToSlash`等

---

## Recommended Action

1. **IMP-01～IMP-06** のImportant issuesを確認し、必要に応じて対応
2. ログプレフィクスの変更が既存のログ監視/解析ツールに影響しないか確認
3. 本PRで追加されたdiff-viewのCSSスタイルに関連するフロントエンドコンポーネント（`diff-view`ディレクトリ）がimportされている（ViewerSystem.tsx）が、diff-view自体のコンポーネントファイルが差分に含まれていない → 別コミットまたは未コミットの可能性を確認

---

## 本番コード確認による追加レビュー

差分だけでなく、本番コードの周辺調査を実施した結果：

### A-01: `app_session_log.go` — `closeSessionLog` と `writeSessionLogEntry` のレースウィンドウ

本番コードの`closeSessionLog()`（line 203-217）と`writeSessionLogEntry()`（line 110-201）を確認：

- `closeSessionLog()`はWrite Lockで`sessionLogFile = nil`を設定
- `writeSessionLogEntry()`はLock取得後に`sessionLogFile != nil`をチェック
- ロック外の`syncFile.Sync()`は、`closeSessionLog`と競合する可能性がある

差分で追加された`isExpectedCloseRace`のハンドリング（`os.ErrClosed` / `syscall.EINVAL`）は、このレースウィンドウを正しく処理しています。**対応済み**。

### A-02: `app_events.go` — `tmux:window-created`イベントの発火元確認

本番コードの`snapshotEventPolicies`に`tmux:window-created`が追加されましたが、本番コード内で`tmux:window-created`を`Emit`している箇所を確認：

```go
// command_router_handlers_window.go handleNewWindow line ~360
r.emitter.Emit("tmux:session-created", ...)
```

`handleNewWindow`は`tmux:session-created`を発火しており、`tmux:window-created`は直接発火されていません。snapshotEventPoliciesに登録されているが未発火のイベントは、コメント（NOTE(1-window model)）で意図的に文書化されています。**設計意図通り**。

### A-03: `errorLogStore.ts` — `addEntry`の削除影響

旧コードには`addEntry`メソッドがあり、`useBackendSync.ts`から呼ばれていました。差分で`addEntry`が削除され、`setEntries`に一本化されています。`addEntry`の他の呼び出し元がないか確認：

本番コードの`errorLogStore.ts`を確認 → `addEntry`は完全に削除され、`setEntries`のみが公開APIとなっています。`useBackendSync.ts`の差分でも`addEntry`の呼び出しが`setEntries`に置換されています。**影響範囲は適切にカバー**。

### A-04: `handler.go` — `Handle`のbase handler error後もcallback呼び出し

旧コード: base handler errorがあれば即return（callbackスキップ）  
新コード: base handler errorに関わらずcallback呼び出し

この変更は `app_lifecycle.go` の `startup()` 内で登録されるcallback（`writeSessionLogEntry`呼び出し）に影響します。base handler（stderr出力）が失敗しても、session-logにメモリエントリが追加され、フロントエンドに通知されます。これは意図された動作改善です。**設計意図通り**。

### A-05: `useBackendSync.ts` — `errorLogFetchSeq`のリセットタイミング

cleanup関数内で`errorLogFetchSeq = 0`にリセットされています。再マウント時に`fetchErrorLog()`が呼ばれ、`++errorLogFetchSeq`で1になるため、前回の応答（seq=0以前）は破棄されます。**正しい動作**。

### A-06: diff-viewのimport確認

`ViewerSystem.tsx`で`import "./views/diff-view";`が追加されていますが、diff-viewディレクトリのファイル自体は本差分に含まれていません。本番コードに存在する可能性があります。

→ このimportが存在するということは、diff-viewモジュールが確実に存在する必要があります。差分に含まれていないということは、別のコミットで既に追加済み、または未コミットの可能性があります。**確認推奨**。

---

## 並列作業可否テーブル

以下は各タスクの修正作業を並列で実施できるかどうかの一覧表です。

| # | タスクID | 概要 | 対象ファイル群 | カテゴリ | 並列作業可否 | 理由 |
|---|---------|------|------------|---------|:---------:|------|
| 1 | IMP-01 | cachedInfo/lstatInfo一貫性コメント追記 | `app_devpanel_api.go` | A | ✅ 可 | コメント追記のみ。他ファイルに影響なし |
| 2 | IMP-02 | 二重statパフォーマンス改善 | `app_devpanel_api.go` | A | ⚠️ 条件付き可 | IMP-01と同一ファイル。IMP-01と同時修正推奨 |
| 3 | IMP-03 | parseWorkingDiffのhunk追跡改善 | `app_devpanel_api.go` | A | ⚠️ 条件付き可 | IMP-01/02と同一ファイル。同一担当者推奨 |
| 4 | IMP-04 | EINVAL条件のコメント追記 | `app_session_log.go` | B | ✅ 可 | コメント追記のみ。カテゴリAと独立 |
| 5 | IMP-05 | WorkingDiffStatus型の文書化 | `app_devpanel_types.go` | A | ✅ 可 | 将来検討事項のみ。修正不要 |
| 6 | IMP-06 | ErrorLogView.tsx cleanupRef改善 | `ErrorLogView.tsx` | E | ✅ 可 | フロントエンドのみ。バックエンドと独立 |
| 7 | SUG-01 | remainingBudget <= 0 ガード改善 | `app_devpanel_api.go` | A | ⚠️ 条件付き可 | IMP-01/02/03と同一ファイル |
| 8 | SUG-02 | parseDiffHeaderPathsコメント改善 | `app_devpanel_api.go` | A | ⚠️ 条件付き可 | 同上 |
| 9 | SUG-03 | cleanupOldSessionLogsパフォーマンス | `app_session_log.go` | B | ✅ 可 | IMP-04と同一ファイルだが独立セクション |
| 10 | SUG-04 | normalizeEntries最適化 | `errorLogStore.ts` | E | ✅ 可 | フロントエンドのみ |
| 11 | SUG-05 | テストのt.Fatal一貫性 | `app_devpanel_api_test.go` | A | ✅ 可 | テストファイルのみ |
| 12 | SUG-06 | viewerRegistry Symbol化検討 | `viewerRegistry.ts` | F | ✅ 可 | フロントエンドのみ |
| 13 | A-06 | diff-view importの存在確認 | `ViewerSystem.tsx` | F | ✅ 可 | 確認作業のみ |

### 並列作業の推奨グルーピング

```
グループ1 (Backend - DevPanel): IMP-01, IMP-02, IMP-03, SUG-01, SUG-02, SUG-05
  → 同一ファイル（app_devpanel_api.go, app_devpanel_api_test.go）のため
    1人の担当者が一括で修正するのが効率的

グループ2 (Backend - Session Log): IMP-04, SUG-03
  → app_session_log.go の修正。グループ1と並列作業可能

グループ3 (Frontend - ErrorLog): IMP-06, SUG-04, SUG-10
  → フロントエンドファイルの修正。バックエンドと完全に独立

グループ4 (Frontend - Viewer): SUG-06, A-06
  → Viewerシステム関連。グループ3と並列作業可能

グループ5 (確認のみ): IMP-05
  → 修正不要。将来検討事項として記録
```

### 作業者向け注意事項

| 注意点 | 詳細 |
|-------|------|
| ⚠️ ファイル競合回避 | グループ1 内の修正は **必ず1人で実施** すること。`app_devpanel_api.go` への並列コミットはコンフリクトの原因になります |
| ✅ Backend/Frontend分離 | グループ1-2（Go）とグループ3-4（TypeScript/React）は **安全に並列作業可能** |
| ℹ️ テスト変更なし | 今回のImportant issuesのほとんどはコメント追記/ドキュメント改善であり、テストの追加・修正は不要 |
| ℹ️ ビルド確認 | 全グループの修正後、`go build ./...` と `npm run build` で全体のビルド確認を推奨 |
