# PR Review Summary — 2026-02-22 17:10

レビュー対象: `D:\myT-x\dev-myT-x\review\temp` 配下の40ファイル差分  
レビュー方針: `review-pr-para.prompt.md` + `CLAUDE.md` 準拠  
差分レビュー + 本番コード確認の二段階レビュー実施

---

## ファイルカテゴリ分類

| カテゴリ | ファイル |
|---------|--------|
| **A. バックエンド: DevPanel API (Working Diff新機能)** | `app_devpanel_api.go`, `app_devpanel_api_test.go`, `app_devpanel_types.go` |
| **B. バックエンド: Session Log (イベントモデル刷新)** | `app.go`, `app_session_log.go`, `app_session_log_test.go`, `app_session_log_types.go` |
| **C. バックエンド: Session Log Handler** | `internal/sessionlog/handler.go`, `internal/sessionlog/handler_test.go` |
| **D. バックエンド: イベント・ライフサイクル** | `app_events.go`, `app_events_test.go`, `app_lifecycle.go`, `app_lifecycle_test.go`, `app_pane_api.go` |
| **E. バックエンド: tmux Window ハンドラ** | `command_router.go`, `command_router_handlers_window.go`, `command_router_handlers_window_test.go`, `command_router_test_helpers_test.go`, `command_router_env_test.go` |
| **F. バックエンド: tmux Session Manager** | `session_manager_windows.go`, `session_manager_test.go`, `session_manager_window_test.go`, `session_manager_directional_test.go`, `session_manager_pane_io_test.go` |
| **G. フロントエンド: Error Log (Ping+Fetch移行)** | `errorLogStore.ts`, `useErrorLog.ts`, `ErrorLogView.tsx`, `error-log/index.ts`, `useBackendSync.ts` |
| **H. フロントエンド: Viewer System (レジストリ + Diff View)** | `viewerRegistry.ts`, `ViewerSystem.tsx`, `ActivityStrip.tsx`, `DiffViewer.tsx`, `api.ts` |
| **I. フロントエンド: スタイル** | `base.css`, `viewer.css` |
| **J. Wails バインディング (自動生成)** | `App.d.ts`, `App.js`, `models.ts` |
| **K. ユーティリティ** | `internal/testutil/helpers.go` |

---

## Critical Issues (0件)

差分および本番コードを確認した結果、クリティカルな問題は検出されませんでした。

---

## Important Issues (6件)

### IMP-01: `buildUntrackedFileDiffSingle` — 二重 Lstat によるパフォーマンスペナルティ [app_devpanel_api.go]

**問題**: `buildUntrackedFileDiffsWithBudget` は呼び出し前に `os.Lstat(absPath)` を実行し、その `info` を `cachedInfo` として `buildUntrackedFileDiffSingle` に渡している。しかし `buildUntrackedFileDiffSingle` 内で再度 `os.Lstat(absPath)` を実行し、シンボリンクチェックを行っている。呼び出し元で既にシンボリンクチェック済み（`info.Mode()&os.ModeSymlink != 0` で skip 済み）のため、ファイルパスに対して2回の Lstat が走る。

**影響**: untracked ファイルが大量にある場合（最大10000パス）、不要なシステムコール2倍によりパフォーマンス劣化。

**対象箇所**: `app_devpanel_api.go` 差分の `buildUntrackedFileDiffSingle` 関数内 L369–L377、および `buildUntrackedFileDiffsWithBudget` L264–L283

**推奨**: `buildUntrackedFileDiffSingle` が `cachedInfo` を受け取った場合、内部の `os.Lstat` を省略する条件を追加するか、呼び出し元（`buildUntrackedFileDiffsWithBudget`）が既にチェック済みである事実を活用してシンボリンクガードをスキップする。

---

### IMP-02: `buildUntrackedFileDiffSingle` — `os.Lstat` と `filepath.EvalSymlinks` の順序問題 [app_devpanel_api.go]

**問題**: 以下の順序で処理が行われる:
1. `isPathWithinBase(absPath, workDir)` — 字句的チェック
2. `filepath.EvalSymlinks(workDir)` + `filepath.EvalSymlinks(absPath)` — シンボリンク解決後チェック
3. `os.Lstat(absPath)` — Lstat でシンボリンクか確認

ステップ2 の `filepath.EvalSymlinks(absPath)` は、absPath がシンボリンクの場合にリンク先を解決してしまう。つまり **ステップ3でシンボリンクを検出する前に、ステップ2がリンク先のパスをすでに使用している**。ステップ2で `evalErr` が発生しない場合、`resolvedAbs` はリンク先を指し、ステップ3の `os.Lstat` は元パスに対して実行される。

**影響**: セキュリティ上の問題は `isPathWithinBase` が先に字句チェックしているため限定的だが、ロジック上の順序が不自然。

**推奨**: `os.Lstat` をシンボリンク判定として最初に実行し、シンボリンクならその時点で return nil。シンボリンクでない場合のみ `EvalSymlinks` によるパストラバーサルチェックを実行する。

---

### IMP-03: `parseWorkingDiff` — diff行内の `"+"`/`"-"` 判定でファイルヘッダ行を誤カウントする可能性 [app_devpanel_api.go]

**問題**: `parseWorkingDiff` 内の additions/deletions カウントロジック:
```go
} else if strings.HasPrefix(line, "+") && !strings.HasPrefix(line, "+++") {
    file.Additions++
} else if strings.HasPrefix(line, "-") && !strings.HasPrefix(line, "---") {
    file.Deletions++
}
```
これは `index abc1234..def5678 100644` のような行は問題ないが、`similarity index 85%` の行も問題ない。しかし、Git の combined diff や `diff --cc` 形式では `++` や `--` で始まる行が存在し得る。現在の `git diff HEAD --no-color` 出力ではこの形式は出ないが、将来的にマージコンフリクト等を扱う場合にカウントがずれる可能性がある。

**影響**: 現時点では顕在化しないが、将来のマージコンフリクト対応時に潜在バグとなる。

**推奨**: コメントで `// NOTE: This parser only handles standard unified diff format (not combined diff).` を追記し、制限事項を明示する。

---

### IMP-04: `cleanupOldSessionLogs` — 現在のファイル名パターンが複数プロセスのファイルを跨いで削除する可能性 [app_session_log.go]

**問題**: 本番コード確認結果、`cleanupOldSessionLogs` は `currentFile` (=自プロセスのログファイル) のみ保護し、他の同時実行中プロセスのログファイルは保護しない。`session-20260222-150405-1234.jsonl` と `session-20260222-150405-5678.jsonl` が同時に存在する場合、一方のプロセスがもう一方のアクティブファイルを削除する可能性がある。

**影響**: 開発フェーズでは複数プロセスの同時起動は稀であり、実用上の影響は低い。ただしデータ損失の可能性がある。

**推奨**: ファイルロック (`os.O_EXCL` 検査) やプロセス生存チェックは過剰だが、コメントで既知の制限事項として明記する。

---

### IMP-05: `errorLogStore.ts` — `normalizeEntries` のフィルタリングで `seq=0` が無効と判定される [errorLogStore.ts]

**問題**: `isValidSeq` は `seq > 0` を要求する。バックエンド側で `a.sessionLogSeq++` が先に実行されるため `seq=0` は発生しないが、Wails の TypeScript バインディングで `SessionLogEntry` の `seq` フィールドのデフォルト値が `0` となるケースがある（例: バインディング初期化エラー、ネットワーク切断時のデシリアライゼーション失敗）。このとき、全エントリが `normalizeEntries` でフィルタアウトされ、UIにエントリが全く表示されなくなる。

**影響**: APIからの応答が不正な場合にサイレントにデータがドロップされる。

**推奨**: `setEntries` 内で `normalizeEntries` がすべてフィルタアウトした場合のログ出力を追加（DEV モードのみ）。

---

### IMP-06: `useBackendSync.ts` — エラーログ fetch のリトライ機能がない [useBackendSync.ts]

**問題**: `fetchErrorLog` で `api.GetSessionErrorLog()` が失敗した場合、DEV モードの `console.warn` のみでリトライは行われない。一時的なネットワークエラーやバックエンドの負荷で失敗した場合、次の `app:error-log-updated` イベントが来るまでフロントエンドのエラーログは更新されない。

**影響**: バックエンドが一時的に応答不能な状態で、エラーログの表示が古いまま残る。

**推奨**: 失敗時に一定間隔後のリトライ（最大1回）を追加するか、コメントで意図的な設計判断として明記する。

---

## Suggestions (17件)

### SUG-01: `DevPanelWorkingDiff` — `consumedSize` の初期値に注意 [app_devpanel_api.go]

`consumedSize := len(raw)` は、truncation後の `raw` の長さを使用している。これは正しいが、`raw` が truncation された場合、untracked ファイル用の残りバジェットが少なくなる。意図通りだがコメントで明示するとよい。

### SUG-02: `parseNULSeparatedGitPaths` — Windows パス区切り文字の正規化 [app_devpanel_api.go]

`filepath.ToSlash(entry)` で正規化しているが、git の `-z` オプションは常に `/` を使用するため、この正規化は冗長。ただし防御的コーディングとして問題なし。

### SUG-03: `needsGitQuoting` — `\t` (タブ) がスペースと同じく引用対象 [app_devpanel_api.go]

`b < 0x20` の条件でタブ (`0x09`) は既にカバーされているが、コメントに `spaces, tabs,` と明示すると可読性が向上する。

### SUG-04: テストコード — `TestBuildUntrackedFileDiffSingle_SymlinkSkipped` の Skip 条件 [app_devpanel_api_test.go]

`os.Symlink` が失敗した場合に `t.Skipf` でスキップしている。これはWindows環境で管理者権限がない場合に発生する。テストの意図としては正しい。

### SUG-05: `WorkingDiffStatus` — type alias の設計判断 [app_devpanel_types.go]

`type WorkingDiffStatus = string` は type alias であり、型安全性がない。コメントでその理由（Wails TypeScript バインディングとの互換性）が明示されているため問題なし。ただし将来的に `type WorkingDiffStatus string` への移行を検討する場合、Wails バインディングジェネレーターの更新が必要。

### SUG-06: `snapshotEventPolicies` — `tmux:window-created` の追加 [app_events.go]

`tmux:window-created` がポリシーマップに追加されているが、本番コード確認によると `handleNewWindow` は `tmux:session-created` を emit し、`tmux:window-created` は emit しない。このイベントは将来のマルチウィンドウ対応向けの予約であるため、現在は到達不能。テストの `want: true` 変更と整合しているが、コメントで「現在は未使用」と明記すると混乱を避けられる。

### SUG-07: `TeeHandler.Handle` — callback panic リカバリ [internal/sessionlog/handler.go]

`defer recover()` による panic リカバリは良い改善。ただし、`debug.Stack()` の出力は非常に長くなる可能性がある。プロダクション環境ではスタックトレースの最初の数行のみ出力するオプションを検討。

### SUG-08: `TeeHandler.Handle` — baseHandler エラー時もコールバック実行 [internal/sessionlog/handler.go]

従来は `if err != nil { return err }` でコールバックをスキップしていた。新仕様ではベースハンドラエラーに関わらずコールバックを実行する。UI通知の確実性が向上するが、ベースハンドラが「ログ不要」を意味するエラーを返すケースがあれば不要な通知が発生する。現在のベースハンドラ（TextHandler）ではこのケースは発生しないため、現状は問題なし。

### SUG-09: `initSessionLog` — ロック取得位置の改善 [app_session_log.go]

`a.sessionLogMu.Lock()` が `os.OpenFile` の後に追加された。これは正しい修正で、`sessionLogFile` と `sessionLogPath` の書き込みを一貫して保護する。

### SUG-10: `writeSessionLogEntry` — Sync のロック外実行 [app_session_log.go]

`syncFile = a.sessionLogFile` をロック内でキャプチャし、ロック外で `syncFile.Sync()` を実行する設計は正しい。`closeSessionLog()` との競合に対しても `os.ErrClosed` / `syscall.EINVAL` のハンドリングが適切。

### SUG-11: `viewerRegistry.ts` — グローバルレジストリのHMR対応 [viewerRegistry.ts]

`globalThis` ベースのレジストリに変更し、`import.meta.hot.dispose` でクリアする仕組みは HMR 問題への適切な対応。ただし `registry.length = 0` は配列内のオブジェクト参照をGCに委ねるため、明示的に `registry.splice(0)` でも同等。

### SUG-12: `ErrorLogView.tsx` — callback ref パターン [ErrorLogView.tsx]

`useRef` から callback ref への移行は正しい。`cleanupRef` パターンで前のクリーンアップを確実に実行する設計は信頼性が高い。ただし `registerBodyElement` は `useCallback(..., [])` であり依存配列が空のため、`bodyRefCallback` の `useCallback` の依存配列 `[registerBodyElement]` も安定する。これは意図通り。

### SUG-13: `errorLogStore.ts` — `lastReadSeq` のリグレッション検知 [errorLogStore.ts]

バックエンド再起動時に `maxNewSeq < lastReadSeq` で `lastReadSeq = 0` にリセットする処理は良い設計。ただし、初回ロード時（`state.entries.length === 0 && state.lastReadSeq === 0`）に既存エントリを全て既読とする処理は、アプリ起動前に発生したエラーをユーザーに通知しないことを意味する。意図的な設計かのコメントが差分に含まれているため問題なし。

### SUG-14: `injectTestWindow` — テストヘルパー関数のスコープ [command_router_test_helpers_test.go]

`injectTestWindow` は `_test.go` ファイル内で定義されており、テスト専用である。内部状態（`manager.sessions`, `manager.nextWindowID`, `manager.nextPaneID`）に直接アクセスしているが、テスト用途として適切。

### SUG-15: `testutil.Ptr` — `//go:fix inline` ディレクティブ [internal/testutil/helpers.go]

Go 1.24+ の `go fix` インライン指示が追加されている。CLAUDE.md の「Go言語は1.26が最新」の記載から、この機能は利用可能。ただし `go fix ./...` を実行するまでは効果がないため、移行時の注意事項としてコメントが適切。

### SUG-16: `DiffViewer.tsx` — hunk header 不一致時の `continue` [DiffViewer.tsx]

`if (!match) continue;` への変更は、不正な hunk header を含む diff を安全にスキップする改善。従来の `if (match) {...}` では不正ヘッダ後に `currentHunk` が前の値のまま残り、後続行が前の hunk に追加される問題があった。

### SUG-17: ログプレフィックス統一 — `[DEBUG-*]` → `[*]` [全ファイル]

`[DEBUG-DEVPANEL]` → `[DEVPANEL]`, `[DEBUG-EVENT]` → `[EVENT]` 等のプレフィックス統一は良い改善。CLAUDE.md の「デバッグ用としてログ名を統一して削除しやすくしておく事」に準拠。ただし `[DEBUG-SYNC]` が `useBackendSync.ts` 内に残っている（L73: `console.warn("[DEBUG-SYNC] GetSessionErrorLog failed:", err);`）。統一するなら `[SYNC]` に変更を推奨。

---

## Positive Observations (良い点)

1. **ping + fetch モデルへの移行** (A-0): エラーログのイベントモデルを「エントリ送信」から「ピング + フェッチ」に変更。スロットリングによるデータロスを構造的に排除した優れた設計変更。

2. **monotonic sequence (Seq)**: `uint64` のシーケンス番号追加により、フロントエンドの重複排除が `ts|level|msg|source` の弱い複合キーから安定した一意識別子に改善。

3. **セキュリティ防御**: `buildUntrackedFileDiffSingle` は字句的ガード + EvalSymlinks ガードの二重チェックを実施。パストラバーサル攻撃への防御が適切。

4. **予算管理**: `buildUntrackedFileDiffsWithBudget` の `remainingBudget` パターンは、メモリ消費の上限を効果的に管理。

5. **TeeHandler のパニックリカバリ**: コールバックの panic がベースハンドラの結果に影響しないよう、`defer recover()` で保護。

6. **テストカバレッジ**: 新機能に対して網羅的なテストが追加されている（field count guard, boundary tests, rollback tests, symlink tests等）。

7. **テストヘルパーの共通化**: `stubRuntimeEventsEmit(t)` への統一により、テストコードの boilerplate が削減。

8. **cleanupOldSessionLogs の改善**: 現在のプロセスのログファイルを削除しないガード追加。

9. **HMR 対応**: `viewerRegistry.ts` のグローバルレジストリ + `import.meta.hot.dispose` パターンは、開発時の HMR 問題を適切に解決。

10. **`commitHash` への `"--"` 追加**: `DevPanelCommitDiff` の git コマンドに `"--"` を追加し、特殊なコミットハッシュがオプションとして誤解釈されるリスクを排除。

---

## Recommended Action

1. **IMP-01〜IMP-06 を確認・対応** — 特に IMP-01, IMP-02 のパフォーマンス・ロジック問題を優先
2. **SUG-17 のログプレフィックス残り** (`[DEBUG-SYNC]`) を統一
3. **テスト実行** で既存テストの回帰確認
4. **フロントエンドのビルド確認** (event名変更 `app:error-logged` → `app:error-log-updated` の影響)

---

## 並列作業可否テーブル

以下は、指摘事項の修正について並列作業の可否を示します。

| # | 分類 | 指摘ID | 概要 | 対象ファイル | 並列作業 | 備考 |
|---|------|--------|------|-------------|----------|------|
| 1 | Important | IMP-01 | `buildUntrackedFileDiffSingle` 二重Lstat | `app_devpanel_api.go` | ✅ 可能 | 同ファイルの IMP-02 と同時修正推奨 |
| 2 | Important | IMP-02 | Lstat / EvalSymlinks の順序 | `app_devpanel_api.go` | ⚠️ IMP-01と同時 | IMP-01と同じ関数内のため一括修正が効率的 |
| 3 | Important | IMP-03 | diff行カウント制限コメント追加 | `app_devpanel_api.go` | ⚠️ IMP-01/02と同時 | 同ファイル別関数、コメント追記のみなので衝突可能性低 |
| 4 | Important | IMP-04 | cleanupOldSessionLogs コメント追記 | `app_session_log.go` | ✅ 可能 | 他の指摘と独立 |
| 5 | Important | IMP-05 | normalizeEntries フィルタアウト時のログ | `errorLogStore.ts` | ✅ 可能 | フロントエンド単独変更 |
| 6 | Important | IMP-06 | fetchErrorLog リトライ or コメント | `useBackendSync.ts` | ✅ 可能 | フロントエンド単独変更 |
| 7 | Suggestion | SUG-06 | window-created コメント追記 | `app_events.go` | ✅ 可能 | コメントのみ |
| 8 | Suggestion | SUG-17 | `[DEBUG-SYNC]` → `[SYNC]` 統一 | `useBackendSync.ts` | ⚠️ IMP-06と同時 | 同ファイル |

### 凡例
- ✅ **可能**: 他の修正と独立して並列作業可能
- ⚠️ **条件付き**: 記載の指摘と同一ファイルのため、同時修正を推奨（別作業者が同時に触るとコンフリクトリスクあり）
- ❌ **不可**: 依存関係あり、順序を守る必要あり

### 推奨作業グループ

| グループ | 作業者 | 対象 | 推定工数 |
|---------|--------|------|---------|
| **G1: DevPanel API修正** | 作業者A | IMP-01 + IMP-02 + IMP-03 (app_devpanel_api.go) | 小〜中 |
| **G2: Session Log修正** | 作業者B | IMP-04 (app_session_log.go) + SUG-06 (app_events.go) | 小 |
| **G3: フロントエンド修正** | 作業者C | IMP-05 (errorLogStore.ts) + IMP-06 + SUG-17 (useBackendSync.ts) | 小 |

G1, G2, G3 は**完全に並列実行可能**です。各グループ内の修正は同一ファイルまたは強い関連があるため、一括で対応してください。
