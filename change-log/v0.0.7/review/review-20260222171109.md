# PR Review Summary — 2026/02/22 17:11

## レビュー対象

差分ファイル数: **40件**

### カテゴリ分類

| カテゴリ | ファイル数 | 対象ファイル |
|---------|----------|-------------|
| A. DevPanel API (Working Diff 新規機能) | 4 | `app_devpanel_api.go`, `app_devpanel_api_test.go`, `app_devpanel_types.go`, `frontend/wailsjs/go/models.ts` |
| B. Session Log (ping+fetchモデル, Seq導入) | 6 | `app.go`, `app_session_log.go`, `app_session_log_test.go`, `app_session_log_types.go`, `internal/sessionlog/handler.go`, `internal/sessionlog/handler_test.go` |
| C. Frontend ErrorLog (store/hook/view リファクタ) | 6 | `frontend/src/stores/errorLogStore.ts`, `frontend/src/hooks/useBackendSync.ts`, `frontend/src/components/viewer/views/error-log/ErrorLogView.tsx`, `frontend/src/components/viewer/views/error-log/useErrorLog.ts`, `frontend/src/components/viewer/views/error-log/index.ts`, `frontend/src/api.ts` |
| D. Frontend Viewer System (レジストリ/ショートカット) | 4 | `frontend/src/components/viewer/ViewerSystem.tsx`, `frontend/src/components/viewer/ActivityStrip.tsx`, `frontend/src/components/viewer/viewerRegistry.ts`, `frontend/src/components/viewer/views/git-graph/DiffViewer.tsx` |
| E. Frontend スタイル・Wails Binding | 5 | `frontend/src/styles/base.css`, `frontend/src/styles/viewer.css`, `frontend/wailsjs/go/main/App.d.ts`, `frontend/wailsjs/go/main/App.js`, `frontend/wailsjs/go/models.ts` |
| F. Tmux Window Handler & Events | 8 | `app_events.go`, `app_events_test.go`, `app_lifecycle.go`, `app_lifecycle_test.go`, `app_pane_api.go`, `internal/tmux/command_router.go`, `internal/tmux/command_router_handlers_window.go`, `internal/tmux/command_router_handlers_window_test.go` |
| G. Tmux Session Manager テスト強化 | 6 | `internal/tmux/command_router_test_helpers_test.go`, `internal/tmux/session_manager_directional_test.go`, `internal/tmux/session_manager_pane_io_test.go`, `internal/tmux/session_manager_test.go`, `internal/tmux/session_manager_window_test.go`, `internal/tmux/session_manager_windows.go` |
| H. その他 (testutil, env_test, command_router_env_test) | 3 | `internal/testutil/helpers.go`, `internal/tmux/command_router_env_test.go`, `internal/tmux/command_router_test_helpers_test.go` |

---

## Critical Issues (0 件)

重大なバグや致命的な問題は検出されませんでした。

---

## Important Issues (5 件)

### IMP-01: `buildUntrackedFileDiffSingle` — cachedInfo と lstatInfo の不整合リスク
- **ファイル**: `app_devpanel_api.go` (diff行 343-384)
- **カテゴリ**: A
- **詳細**: `buildUntrackedFileDiffSingle` は `cachedInfo` (呼び出し元が取得した `os.FileInfo`) と `lstatInfo` (関数内で取得した `os.Lstat` 結果) の両方を使用する。`cachedInfo` が `os.Stat` で取得された場合 (シンボリックリンク解決済み)、`lstatInfo` は `os.Lstat` （シンボリックリンク非解決）であるため、ファイルサイズ判定で不整合が生じる可能性がある。
  - 具体的には: `cachedInfo` が `os.Stat` 経由で symlink を解決し実体ファイルの info を返す一方、`lstatInfo` は symlink そのものの info を返す。`info.Size() > devPanelMaxUntrackedFileSize` の判定(行389)で使われる `info` が `cachedInfo` (symlink解決済みの実体サイズ) の場合、`lstatInfo.Mode()&os.ModeSymlink != 0` の symlink チェック(行374) で先にスキップされるため**実害は無い**が、設計意図が不明瞭。
- **推奨**: `cachedInfo` は呼び出し元 (`buildUntrackedFileDiffsWithBudget`) で `d.Info()` (実質 `Lstat` 結果) を渡しているため、現在の呼び出しパターンでは問題ない。ただし、コメントに「`cachedInfo` は `Lstat` 結果であることを期待する」旨を追記すると安全性が向上する。

### IMP-02: `DevPanelWorkingDiff` — isFreshRepo 判定時のエラー詳細未検証
- **ファイル**: `app_devpanel_api.go` (diff行 131-133)
- **カテゴリ**: A
- **詳細**: `git rev-parse --verify HEAD` の失敗を「fresh repo」と判定しているが、gitが見つからない・権限エラー等の異常ケースも全て fresh repo 扱いになる。`slog.Info` のログにエラーを出力しているが、false positive のリスクがある。
- **推奨**: CLAUDE.mdの仕様「tmux-shimでの変換失敗時は原文をそのまま転送する」精神と整合するため（エラーでも止めない）、現行コードで許容可能。ただし、エラー種別を `slog.Warn` に格上げするか、git コマンド自体の存在確認を先に行うことを検討。

### IMP-03: `errorLogStore.ts` — `normalizeEntries` のソートパフォーマンス
- **ファイル**: `frontend/src/stores/errorLogStore.ts` (diff行 29-34)
- **カテゴリ**: C
- **詳細**: `normalizeEntries` はバックエンドから受信する度に全エントリを `filter` → `sort` → `slice` する。MAX_ENTRIES=10000 での sort は O(N log N) ≈ 13万回の比較となり、高頻度更新時にパフォーマンスに影響する可能性がある。バックエンドが常に seq 順でソート済みデータを返すなら、sort は冗長。
- **推奨**: バックエンドの `snapshot()` が常にchronological order（seq順）を返すことが保証されているため、`sort` を省略し、`filter` + `slice` のみにすることでパフォーマンスを改善可能。ただし、防御的コーディングとして sort を残す判断も妥当。

### IMP-04: `writeSessionLogEntry` — Sync のレースコンディション (shutdown 時)
- **ファイル**: `app_session_log.go` (diff行 146-159)
- **カテゴリ**: B
- **詳細**: `syncFile` をロック内でキャプチャし、ロック解放後に `Sync()` を呼ぶ設計は、`closeSessionLog()` と競合した場合に `os.ErrClosed` や `EINVAL` が発生する。コード上で `isExpectedCloseRace` としてこれらのエラーを抑制しており、**意図的な設計判断**と理解できる。
- **備考**: コメントで十分に記述されており、Windowsの `EINVAL` 対応も入っている。問題なし。ただし、`runtime.GOOS == "windows"` の条件はビルド時に定数化されないため、パフォーマンスへの影響はゼロだが、ビルドタグ分離も将来的な選択肢。

### IMP-05: `handleNewWindow` — `getSessionForNewWindowFn` のnilガード冗長性
- **ファイル**: `internal/tmux/command_router_handlers_window.go` (diff行 304-308)
- **カテゴリ**: F
- **詳細**: `getSessionForNewWindowFn` は `NewCommandRouter` で必ず初期化される (`router.getSessionForNewWindowFn = sessions.GetSession`)。しかし `handleNewWindow` 内で `if getSession == nil` のフォールバックが入っている。
- **推奨**: 防御的コーディングとして適切。`NewCommandRouter` 以外の経路でRouterが初期化される可能性（テスト等）を考慮した正しい設計。問題なし。

---

## Suggestions (12 件)

### SUG-01: テストでの `stubRuntimeEventsEmit(t)` ヘルパーの共通化
- **ファイル**: `app_session_log_test.go` (複数箇所)
- **カテゴリ**: B
- **詳細**: 複数のテストで `runtimeEventsEmitFn` のスタブ化が行われていたものが `stubRuntimeEventsEmit(t)` に統一された。良いリファクタリング。ただし、`stubRuntimeEventsEmit` の定義場所が差分に含まれていないため、本番コードで実装済みであることを確認する必要がある（テストヘルパーとして定義されていると推測）。

### SUG-02: `parseDiffHeaderPaths` — symmetry heuristic のエッジケース
- **ファイル**: `app_devpanel_api.go` (diff行 573-609)
- **カテゴリ**: A
- **詳細**: パス長対称ヒューリスティックは非リネームケースの大多数をカバーするが、偶数長パスで `" b/"` を含むケースでは不正確な分割が発生しうる。コメント(IMP-01)で「rename from/rename to で上書きされる」と明記されており、設計意図は明確。
- **推奨**: 問題なし。コメントが十分に説明している。

### SUG-03: `needsGitQuoting` での非ASCII判定
- **ファイル**: `app_devpanel_api.go` (diff行 689-696)
- **カテゴリ**: A
- **詳細**: `b >= 0x80` で非ASCII判定しているが、Git は `core.quotePath` の設定に依存してクオーティング動作が異なる。ここでは `-c core.quotepath=false` を `git diff` に渡しているため整合性はある。synthetic diff ヘッダーに対してのみ適用される関数であり問題ない。

### SUG-04: `ErrorLogView.tsx` — `useEffect` の deps に `entries` を追加
- **ファイル**: `frontend/src/components/viewer/views/error-log/ErrorLogView.tsx` (diff行 24-27)
- **カテゴリ**: C
- **詳細**: `useEffect(() => { markAllRead(); }, [entries, markAllRead]);` で、`entries` が変わるたびに `markAllRead` を呼ぶ設計。エントリが高頻度で追加される場合、`markAllRead` の呼び出しも高頻度になるが、`markAllRead` は `set()` のみでside-effectは軽量なため問題ない。
- **推奨**: 意図的な設計（ビュー表示中は即座に既読化）。問題なし。

### SUG-05: `viewerRegistry.ts` — HMR の `dispose` で `registry.length = 0`
- **ファイル**: `frontend/src/components/viewer/viewerRegistry.ts` (diff行 41-45)
- **カテゴリ**: D
- **詳細**: HMR dispose 時にレジストリをクリアし、各ビューモジュールの再実行で `registerView` が再呼び出しされる設計。globalThis にレジストリを保持する `resolveRegistry()` と組み合わせることで、バンドラーのモジュール再評価順に依存しない堅牢な設計。
- **推奨**: 問題なし。良い設計。

### SUG-06: `injectTestWindow` — テストヘルパーの内部ロック直接操作
- **ファイル**: `internal/tmux/command_router_test_helpers_test.go` (diff行 28-65)
- **カテゴリ**: G
- **詳細**: `manager.mu.Lock()` を直接取得して内部状態を操作する。テストヘルパーとしては適切だが、`AddWindow` が削除されたことの代替として正当化されている。コメントで警告（"Callers must NOT hold manager.mu"）されており問題ない。

### SUG-07: `app_events.go` — `tmux:window-created` ポリシー追加
- **ファイル**: `app_events.go` (diff行 84)
- **カテゴリ**: F
- **詳細**: `tmux:window-created` が `snapshotEventPolicies` に追加されたが、CLAUDE.md の NOTE(1-window model) コメントで述べられている通り、この変更のポリシー追加のイベントが現在エミットされているかを確認する必要がある。`handleNewWindow` を確認したところ、`tmux:session-created` がエミットされ、`tmux:window-created` はエミットされていない。ポリシーに登録するだけでイベントがエミットされなければ、動作上の影響はない。
- **推奨**: 問題なし。将来のマルチウィンドウ拡張に備えた正当な変更。

### SUG-08: `app_devpanel_types.go` — `WorkingDiffStatus` を type alias (= string) にした理由
- **ファイル**: `app_devpanel_types.go` (diff行 19-26)
- **カテゴリ**: A
- **詳細**: コメントで「Wails TypeScript binding generator が plain string literals として出力するため」と理由が明記されている。型安全性のトレードオフが文書化されており問題ない。

### SUG-09: `useBackendSync.ts` — `ERROR_LOG_DEBOUNCE_MS` のモジュールスコープ定数化
- **ファイル**: `frontend/src/hooks/useBackendSync.ts` (diff行 16)
- **カテゴリ**: C
- **詳細**: `const ERROR_LOG_DEBOUNCE_MS = 80;` がモジュールスコープに移動された（SUG-20）。レンダリング毎の再生成を避ける正当な最適化。
- **推奨**: 問題なし。

### SUG-10: `command_router_env_test.go` — `copy` → `got` 変数名変更
- **ファイル**: `internal/tmux/command_router_env_test.go` (diff行 9-38)
- **カテゴリ**: H
- **詳細**: Go 1.26 の `copy` ビルトインとの名前衝突回避のためのリネーム。正当な変更。

### SUG-11: `internal/testutil/helpers.go` — `//go:fix inline` ディレクティブ
- **ファイル**: `internal/testutil/helpers.go` (diff行 9-16)
- **カテゴリ**: H
- **詳細**: Go 1.24+ の `go fix ./...` でインライン化を指示するディレクティブ。CLAUDE.md の Go 1.26 準拠方針と整合している。コメントに意図が明記されており問題ない。

### SUG-12: `DiffViewer.tsx` — hunk header 不一致時の `continue`
- **ファイル**: `frontend/src/components/viewer/views/git-graph/DiffViewer.tsx` (diff行 9-15)
- **カテゴリ**: D
- **詳細**: `if (!match) continue;` に変更し、マッチしないhunkヘッダーをスキップする。以前は `if (match) { ... }` でフォールスルーしていた。動作的には等価だが、`continue` の方が意図が明確で、後続の `currentHunk = ...` が不要ケースで実行されないため、わずかにパフォーマンスも向上。
- **推奨**: 問題なし。良い改善。

---

## Positive Observations (良い点)

### 設計面
1. **ping+fetch モデル (A-0)**: `app:error-logged` → `app:error-log-updated` (payload=null) + `GetSessionErrorLog()` フェッチモデルへの移行は、スロットリングによるデータ損失を根本的に解決する優れた設計。
2. **モノトニックSeq (A-seq)**: `uint64` シーケンス番号による安定デデュプリケーションは、タイムスタンプ秒精度の衝突問題を解決。`2^53-1` までの安全性もコメントで十分に説明。
3. **TeeHandler の panic recovery**: コールバックパニックがログ基盤全体を崩壊させないための `recover()` は堅牢な設計。
4. **PID付きログファイル名 (A-2)**: サブ秒リスタートでのファイル名衝突防止。

### コード品質
5. **DEBUG- プレフィックスの統一**: `[DEBUG-DEVPANEL]` → `[DEVPANEL]` 等のログプレフィックス統一は、ログのgrep可能性を向上。
6. **`cap` → `bufCap` 変数名変更**: Go ビルトイン `cap` との名前衝突回避は最新版言語仕様準拠として適切。
7. **テストカバレッジ**: 新機能に対する包括的なテスト（field count guard, monotonic seq, event name, PID in filename, ring buffer 境界条件）が追加されている。
8. **`cleanupOldSessionLogs` のカレントファイル保護**: 自プロセスのアクティブログファイルを削除しないガード追加。

### フロントエンド
9. **shortcutMap の `useMemo` 化**: レジストリベースの動的ショートカットマッピングへの移行で、各ビューの shortcut が一元管理。
10. **Callback ref パターン**: `ErrorLogView.tsx` での `useRef` + `useEffect` → callback ref パターンへの移行は、DOM要素マウントタイミングの問題を解消。
11. **`lastReadSeq` による正確な未読数管理**: seq ベースの未読判定は、インデックスベースよりも堅牢。

---

## Recommended Action

1. **IMP-01 ~ IMP-05** を確認し、必要に応じてコメント追記等の対応
2. **SUG-01** の `stubRuntimeEventsEmit` 定義がテストヘルパーに存在するか確認
3. All Critical Issues: **0件** — マージブロッカーなし
4. テスト実行による回帰確認を推奨

---

## 並列作業可否テーブル

以下のテーブルは、各指摘事項を修正する際に**他の修正作業と並列で進められるかどうか**を示します。

| ID | 指摘種別 | ファイル | 概要 | 並列作業 | 理由 |
|-----|---------|--------|------|---------|------|
| IMP-01 | Important | `app_devpanel_api.go` | `cachedInfo` のコメント追記 | ✅ 可能 | 他ファイルへの影響なし。コメント追記のみ。 |
| IMP-02 | Important | `app_devpanel_api.go` | isFreshRepo 判定のログレベル変更検討 | ✅ 可能 | 同一ファイルだが IMP-01 とは異なる関数。 |
| IMP-03 | Important | `errorLogStore.ts` | `normalizeEntries` のソート省略検討 | ✅ 可能 | フロントエンドのみの変更。バックエンドに影響なし。 |
| IMP-04 | Important | `app_session_log.go` | Sync レース — 確認済み（対応不要） | — | 対応不要。設計意図が文書化済み。 |
| IMP-05 | Important | `command_router_handlers_window.go` | nilガード — 確認済み（対応不要） | — | 対応不要。防御的コーディングとして適切。 |
| SUG-01 | Suggestion | `app_session_log_test.go` | `stubRuntimeEventsEmit` 定義確認 | ✅ 可能 | テストファイルのみ。 |
| SUG-02 | Suggestion | `app_devpanel_api.go` | parseDiffHeaderPaths — 確認済み（対応不要） | — | 対応不要。 |
| SUG-03 | Suggestion | `app_devpanel_api.go` | needsGitQuoting — 確認済み（対応不要） | — | 対応不要。 |
| SUG-04 | Suggestion | `ErrorLogView.tsx` | markAllRead deps — 確認済み（対応不要） | — | 対応不要。 |
| SUG-05 | Suggestion | `viewerRegistry.ts` | HMR dispose — 確認済み（対応不要） | — | 対応不要。 |
| SUG-06 | Suggestion | `command_router_test_helpers_test.go` | injectTestWindow — 確認済み（対応不要） | — | 対応不要。 |
| SUG-07 | Suggestion | `app_events.go` | window-created ポリシー — 確認済み（対応不要） | — | 対応不要。 |
| SUG-08 | Suggestion | `app_devpanel_types.go` | WorkingDiffStatus — 確認済み（対応不要） | — | 対応不要。 |
| SUG-09 | Suggestion | `useBackendSync.ts` | 定数化 — 確認済み（対応不要） | — | 対応不要。 |
| SUG-10 | Suggestion | `command_router_env_test.go` | 変数名変更 — 確認済み（対応不要） | — | 対応不要。 |
| SUG-11 | Suggestion | `testutil/helpers.go` | go:fix inline — 確認済み（対応不要） | — | 対応不要。 |
| SUG-12 | Suggestion | `DiffViewer.tsx` | continue 変更 — 確認済み（対応不要） | — | 対応不要。 |

### 並列作業ガイド

```
並列 OK グループ:
  ┌─ IMP-01 (app_devpanel_api.go コメント追記)
  ├─ IMP-02 (app_devpanel_api.go ログレベル変更) ← IMP-01と同一ファイルだが異なる関数なので並列可
  ├─ IMP-03 (errorLogStore.ts ソート省略検討)
  └─ SUG-01 (app_session_log_test.go ヘルパー確認)

対応不要 (設計意図確認済み):
  IMP-04, IMP-05, SUG-02 ~ SUG-12
```

### 作業者向け補足

| 優先度 | 実施内容 | 想定工数 | 注意点 |
|-------|---------|---------|--------|
| 🟡 任意 | IMP-01: `buildUntrackedFileDiffSingle` に `cachedInfo` の期待値コメント追記 | 5分 | `// cachedInfo must be from Lstat (not Stat) to preserve symlink detection` 等 |
| 🟡 任意 | IMP-02: `slog.Info` → `slog.Warn` 格上げ検討 | 5分 | git コマンドエラーへの通知精度向上 |
| 🟡 任意 | IMP-03: `normalizeEntries` のソート省略 | 10分 | バックエンドが seq 順保証を利用して `sort` を `// defensive sort — backend guarantees order` コメントに変更 |
| ✅ 確認 | SUG-01: `stubRuntimeEventsEmit` ヘルパー定義確認 | 2分 | テスト用ヘルパーファイルにあるか grep で確認 |
