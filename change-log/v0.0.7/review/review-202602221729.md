# PR Review — 統合版 2026-02-22 17:29

統合元レビュー: `review-20260222170825.md`, `review-20260222170930.md`, `review-20260222171000.md`, `review-20260222171004.md`, `review-20260222171109.md`  
レビュー対象: 未コミット変更全ファイル（40ファイル）  
レビュー方式: 3カテゴリ並列レビュー（Go App層 / Go 内部パッケージ / フロントエンド）+ 本番コード確認の二段階レビュー

---

## 変更サマリー

| カテゴリ | 変更ファイル数 | 主な変更 |
|---------|-------------|---------|
| Go App層 | 12ファイル | DevPanelWorkingDiff新機能、SessionLog改善(Seq/PID/ping-fetch)、ログプレフィックス統一 |
| Go 内部パッケージ | 12ファイル | TeeHandler改善、1-window model整理、テストシーム追加、boolPtr→testutil.Ptr |
| フロントエンド | 15ファイル | ErrorLog ping+fetchモデル、ViewerRegistry HMR対応、ActivityStrip position分割 |

### カテゴリ別ファイル分類

| カテゴリ | ファイル群 |
|---------|-----------|
| **A: DevPanel API & Working Diff** | `app_devpanel_api.go`, `app_devpanel_api_test.go`, `app_devpanel_types.go` |
| **B: Session Log (Backend)** | `app.go`, `app_session_log.go`, `app_session_log_test.go`, `app_session_log_types.go` |
| **C: TeeHandler / SessionLog内部** | `internal/sessionlog/handler.go`, `internal/sessionlog/handler_test.go` |
| **D: Events & Lifecycle** | `app_events.go`, `app_events_test.go`, `app_lifecycle.go`, `app_lifecycle_test.go`, `app_pane_api.go` |
| **E: Frontend ErrorLog & Store** | `errorLogStore.ts`, `useBackendSync.ts`, `ErrorLogView.tsx`, `useErrorLog.ts`, `error-log/index.ts` |
| **F: Frontend Viewer System** | `ActivityStrip.tsx`, `ViewerSystem.tsx`, `viewerRegistry.ts`, `DiffViewer.tsx`, CSSファイル群 |
| **G: Wails Bindings (生成物)** | `App.d.ts`, `App.js`, `models.ts`, `api.ts` |
| **H: tmux Window/Session Manager** | `command_router.go`, `command_router_handlers_window.go`, テスト群, `session_manager_windows.go` 等 |
| **I: テストユーティリティ** | `internal/testutil/helpers.go`, `command_router_env_test.go` |

---

## Critical Issues（必ず修正）

### CRIT-01 — `DevPanelWorkingDiff`: `git diff --cached` / `git diff HEAD` に `"--"` ターミネーター未付与
**ファイル:** `app_devpanel_api.go`  
**出典:** review-170930

**概要:**  
`DevPanelCommitDiff` では `commitHash` 後に `"--"` を追加しているが、fresh repo パスの `git diff --cached --no-color` および通常パスの `git diff HEAD --no-color` にはターミネーターが無い。

**リスク:** ファイル名が `--` で始まる場合にgitがオプションとして解釈する可能性がある。`DevPanelCommitDiff` で `"--"` を追加した同じ理由がここにも当てはまる。

**修正案:** 両方のgit diffコマンドの末尾に `"--"` を追加する。

---

## Important Issues（対応推奨）

### Go App層

#### I-A01 — TOCTOU: buildUntrackedFileDiffSingle のサイズガード
**ファイル:** `app_devpanel_api.go` / `buildUntrackedFileDiffSingle`  
**出典:** review-170825

**概要:**  
ファイルサイズガード（100KB）に TOCTOU（Time-Of-Check-Time-Of-Use）レースが存在する。  
`cachedInfo[0]` または `lstatInfo` のサイズは WalkDir/Lstat 時点の値であり、その後 `os.ReadFile(resolvedAbs)` を呼ぶまでの間にファイルが肥大化した場合、ガードが無効化される。

**修正案:**  
`os.ReadFile` の代わりに `os.Open` → `io.LimitReader(f, devPanelMaxUntrackedFileSize+1)` → `io.ReadAll` パターンに変更し、ハードな byte 上限を保証する。

```go
f, err := os.Open(resolvedAbs)
if err != nil { ... }
defer f.Close()
limited := io.LimitReader(f, devPanelMaxUntrackedFileSize+1)
data, err := io.ReadAll(limited)
if int64(len(data)) > devPanelMaxUntrackedFileSize {
    return nil // ファイルが読み取り中に上限超えた
}
```

---

#### I-A02 — buildUntrackedFileDiffSingle: 二重 Lstat / EvalSymlinks の順序・パフォーマンス問題
**ファイル:** `app_devpanel_api.go`  
**出典:** review-171000, review-171004, review-171109（統合）

**概要:**  
`buildUntrackedFileDiffsWithBudget` が呼び出し前に `os.Lstat(absPath)` を実行しシンボリンクチェック済みだが、`buildUntrackedFileDiffSingle` 内で再度 `os.Lstat(absPath)` + `filepath.EvalSymlinks` を実行している。untracked ファイルが大量にある場合（最大10000パス）パフォーマンス劣化。

また `filepath.EvalSymlinks(absPath)` は symlink の場合にリンク先を解決してしまうため、`os.Lstat` での symlink 検出より先にリンク先パスを使用する順序の不自然さもある。

**補足:** `cachedInfo` は呼び出し元で `d.Info()`（実質 `Lstat` 結果）を渡しているため現在の呼び出しパターンでは実害なし。ただしコメントで期待値を明記すべき。

**修正案:**  
- `cachedInfo` が渡された場合の内部 `os.Lstat` を省略する条件を追加。  
- `EvalSymlinks(workDir)` は呼び出し元で一度だけ計算し引数で渡す。  
- `cachedInfo` に「Lstat 結果であることを期待する」コメントを追記。

---

#### I-A03 — app:error-log-updated イベント名とセマンティクスの乖離
**ファイル:** `app_session_log.go` / `writeSessionLogEntry`  
**出典:** review-170825

**概要:**  
イベント名 `app:error-log-updated` は TeeHandler のしきい値 `slog.LevelWarn` に起因し、WARN レベルのエントリでも発火する。フロントエンド開発者が「このイベントは error 専用」と誤解するリスクがある。

**修正案:**  
イベント名を `app:session-log-updated` 等に変更する（warn/error 両方をカバーすることを名前で明示）。最低限コメント内に「warn/error 両方をカバーする」旨を明示する。フロントエンド側の `BackendEventMap` も合わせて変更が必要。

---

#### I-A04 — tmux:window-created の policy 追加とコメント・テスト名の不整合
**ファイル:** `app_events.go`, `app_events_test.go`  
**出典:** review-170825, review-171004, review-171109（統合）

**概要:**  
`tmux:window-created` が `{trigger:true, bypassDebounce:true}` として policy map に新規追加されたが、コードベース全体に `tmux:window-created` を emit するコードパスが存在しない（`handleNewWindow` は `tmux:session-created` を emit）。テストの `want: false → want: true` 変更が実際のemit有無と乖離し、レビュー者の誤解を招くリスク。

**修正案:**  
`tmux:window-created` のエントリに個別コメントを追加する:
```go
"tmux:window-created": {trigger: true, bypassDebounce: true},
// NOTE(1-window model): Policy registered for future multi-window support.
// No emitter currently exists for this event; it is unreachable at runtime.
```
テストの name も `"window created (policy registered, no emitter yet)"` 等として意図を明示する。

---

#### I-A05 — DevPanelWorkingDiff: isFreshRepo 判定時のエラー詳細未検証
**ファイル:** `app_devpanel_api.go`  
**出典:** review-171109

**概要:**  
`git rev-parse --verify HEAD` の失敗を「fresh repo」と判定しているが、gitが見つからない・権限エラー等の異常ケースも全て fresh repo 扱いになる。`slog.Info` のログにエラーを出力しているが、false positive のリスクがある。

**修正案:**  
エラー種別を `slog.Warn` に格上げするか、git コマンド自体の存在確認を先に行うことを検討。

---

#### I-A06 — parseWorkingDiff: diff行カウントが unified diff 限定
**ファイル:** `app_devpanel_api.go`  
**出典:** review-171000, review-171004（統合）

**概要:**  
additions/deletions カウントロジックは `+`/`-` プレフィックスで判定しているが、hunk 内であるかの追跡がないため、ヘッダー行の誤カウントの可能性（実害は低い）。また Git の combined diff (`++`/`--`) 形式には対応していない。

**修正案:**  
コメントで `// NOTE: This parser only handles standard unified diff format (not combined diff).` を追記し、制限事項を明示する。

---

### Go 内部パッケージ

#### I-B01 — go:fix inline ディレクティブのジェネリック関数対応と誤ったコメント
**ファイル:** `internal/testutil/helpers.go`  
**出典:** review-170825

**概要:**  
`//go:fix inline` はジェネリック関数(`Ptr[T any]`)への適用が Go 1.24 時点では未サポートまたは制限付き。docコメントに「new(T) or address-of-literal pattern」と記載されているが実際の展開形と不一致。

**修正案:**  
`go tool fix -explain` 等で実際にインライン対象と認識されるか確認。コメントは実際の展開形 `{ v := <arg>; return &v }` を明示するように更新する。

---

#### I-B02 — snapshot-refetch エラーメッセージに内部フェーズ名が漏出
**ファイル:** `internal/tmux/command_router_handlers_window.go` / `handleNewWindow`  
**出典:** review-170825

**概要:**  
`snapOk=false` 時のエラーメッセージ `"session disappeared after flag copy: <name>"` に実装内部語彙 "flag copy" が含まれており、tmux shim クライアントの `ipc.TmuxResponse.Stderr` に内部フェーズ名が漏出する。

**修正案:**  
エラーメッセージを tmux 互換の語彙に統一し、内部フェーズ詳細は `slog.Warn` のストラクチャードフィールドに限定する。

---

#### I-B03 — rollback 失敗時に RemoveSession エラー文字列がクライアントに漏出
**ファイル:** `internal/tmux/command_router_handlers_window.go` / `rollbackSession`  
**出典:** review-170825

**概要:**  
rollback 自体が失敗した場合、`errResp(fmt.Errorf("%w (rollback failed: %v)", originalErr, rmErr))` として RemoveSession のエラー文字列がクライアント向けレスポンスに含まれる。

**修正案:**  
ロールバック失敗の詳細は `slog.Warn` のみに留め、クライアントには `originalErr` だけを返す。

---

#### I-B04 — getSessionForNewWindowFn の nil ガードの妥当性確認
**ファイル:** `internal/tmux/command_router.go`, `command_router_handlers_window.go`  
**出典:** review-170825, review-171109（統合）

**概要:**  
`NewCommandRouter` で常に初期化しているにもかかわらず、`handleNewWindow` 内で nil ガードを行っている。「nil になり得る」という誤解を招く一方、防御的コーディングとして正当化する見方もある。

**修正案:**  
nil ガードを残すなら防御的コーディングの意図をコメントで明記する。または不要であれば削除する。

---

### フロントエンド

#### I-C01 — ErrorLogView の markAllRead 2段階レンダー（バッジフラッシュ）
**ファイル:** `ErrorLogView.tsx`  
**出典:** review-170825

**概要:**  
ErrorLogView が開いている状態で新エントリが届くと、`setEntries()` → ActivityStrip バッジ描画 → 非同期 useEffect で `markAllRead()` の2段階レンダーが発生し、unreadCount バッジが 1 フレーム以上点滅する可能性がある。

**修正案:**  
`useLayoutEffect` 化してペイント前に解決させる:
```typescript
useLayoutEffect(() => {
    markAllRead();
}, [entries, markAllRead]);
```

---

#### I-C02 — backend restart 後の unreadCount 計算の不整合
**ファイル:** `errorLogStore.ts` / `setEntries`  
**出典:** review-170825

**概要:**  
backend restart シナリオで `lastReadSeq` のリセットと first-load 判定ロジックが連動しておらず、全新エントリが unread 扱いになる可能性。

**修正案:**  
backend restart 検出時に `lastReadSeq` を `maxNewSeq` にセットし、既読扱いにする:
```typescript
if (maxNewSeq > 0 && maxNewSeq < lastReadSeq) {
    lastReadSeq = maxNewSeq;
}
```

---

#### I-C03 — HMR 後に shortcutMap が更新されない（DEV 環境のみ）
**ファイル:** `ViewerSystem.tsx`  
**出典:** review-170825

**概要:**  
`shortcutMap` は `useMemo([])` で1回のみ計算。HMR 時に view の shortcut を変更してもキーバインドが更新されず、ページリロードが必要。

**修正案 (DEV 環境のみ):**  
`import.meta.hot.accept` で viewerRegistry.ts の HMR 更新を ViewerSystem に通知し、state フラグで `useMemo` を再計算させる。

---

#### I-C04 — models.ts の WorkingDiffResult.convertValues インデント不整合と in-place mutation
**ファイル:** `frontend/wailsjs/go/models.ts`  
**出典:** review-170825

**概要:**  
mixed インデント（メソッドのみ tab、他は 4-space）。`asMap=true` ブランチが入力オブジェクトを in-place mutate する dead code。

**修正案:**  
Wails 自動生成コードのため手動修正は最小限。`prettier` フォーマット実行でインデント統一。

---

#### I-C05 — auto-scroll の useEffect が Strict Mode 初回に no-op になる可能性
**ファイル:** `useErrorLog.ts`  
**出典:** review-170825

**概要:**  
Strict Mode（二重 invoke）では初回 effect が `bodyRef` 登録前に走り `el=null` で no-op になる可能性。開発時に自動スクロールが効かないケースがある。

**修正案:**  
```typescript
useEffect(() => {
    const el = bodyRef.current;
    if (!el) return;
    el.scrollTop = el.scrollHeight;
}, [entries.length, registerBodyElement]);
```

---

#### I-C06 — useBackendSync: エラーログ fetch のリトライ機能がない
**ファイル:** `useBackendSync.ts`  
**出典:** review-171004

**概要:**  
`fetchErrorLog` で `api.GetSessionErrorLog()` が失敗した場合、リトライなし。次の `app:error-log-updated` イベントが来るまでフロントエンドのエラーログは更新されない。

**修正案:**  
失敗時に一定間隔後のリトライ（最大1回）を追加するか、コメントで意図的な設計判断として明記する。

---

#### I-C07 — ErrorLogView.tsx の cleanupRef: アンマウント時のクリーンアップ
**ファイル:** `ErrorLogView.tsx`  
**出典:** review-171000

**概要:**  
`cleanupRef` のクリーンアップがコンポーネント全体のアンマウント時に呼ばれない場合がある（Reactが ref に null を渡すタイミング依存）。

**修正案:**  
コンポーネントのアンマウント時に `cleanupRef.current?.()` を呼ぶ useEffect を追加するか、現状の動作を文書化する。React は ref に null を渡すタイミングで cleanup が呼ばれるため、現状でも実害は発生しない。

---

## Suggestions（考慮推奨）

### Go App層

#### S-A01 — parseDiffHeaderPaths のコメント改善
**ファイル:** `app_devpanel_api.go`  
奇数長かつ rename で `P1≠P2` の場合（フォールバック）が未言及。symmetry heuristic の `2*pathLen+3 == len(content)` の意味を明示するコメント追加を推奨。

#### S-A02 — buildUntrackedFileDiffSingle の EvalSymlinks(workDir) 重複呼び出し最適化
**ファイル:** `app_devpanel_api.go`  
`buildUntrackedFileDiffsWithBudget` の先頭で一度だけ計算し引数で渡す形に変更することを検討。

#### S-A03 — sessionLogEmitMinInterval をパッケージレベル定数に昇格
**ファイル:** `app_session_log.go`  
一貫性のためパッケージレベルに昇格させる。

#### S-A04 — TestWriteSessionLogEntry_EmitsCorrectEventName のテーブル形式冗長
**ファイル:** `app_session_log_test.go`  
テストケースが1つだけのテーブル形式は冗長。直接記述への変更を検討。

#### S-A05 — decodeGitPathLiteral の strconv.Unquote 互換性をコメントで明示
**ファイル:** `app_devpanel_api.go`  
Git の octal escape と Go の `strconv.Unquote` の互換性についてコメント追記。

#### S-A06 — rename + old path に " b/" を含むケースのテスト追加
**ファイル:** `app_devpanel_api_test.go`  
補正パスのテストを追加することを推奨。

#### S-A07 — consumedSize の初期値に関するコメント
**ファイル:** `app_devpanel_api.go`  
`consumedSize := len(raw)` は truncation 後の長さ。意図通りだがコメントで明示。

#### S-A08 — `buildUntrackedFileDiffSingle` cachedInfo variadic引数のAPI設計
**ファイル:** `app_devpanel_api.go`  
cachedInfo は最大1個であることをコメントに明記すべき。

#### S-A09 — `buildUntrackedFileDiffsWithBudget`: remainingBudget ≤ 0 ガード改善
**ファイル:** `app_devpanel_api.go`  
`remainingBudget == 0` → `remainingBudget <= 0` への変更を検討。

#### S-A10 — `parseWorkingDiff`: CR/LF 正規化スコープコメント追加
**ファイル:** `app_devpanel_api.go`  
Windows環境の git は通常 LF 出力のため実質的影響なしだが、コメントでスコープを明記すべき。

#### S-A11 — cleanupOldSessionLogs: 複数プロセスのアクティブファイル削除可能性
**ファイル:** `app_session_log.go`  
`currentFile` のみ保護し他の同時実行中プロセスのログファイルは保護しない。コメントで既知の制限事項として明記する。

#### S-A12 — `[DEBUG-SYNC]` ログプレフィックスの統一漏れ
**ファイル:** `useBackendSync.ts`  
`[DEBUG-SYNC]` が残存。統一するなら `[SYNC]` に変更を推奨。

---

### Go 内部パッケージ

#### S-B01 — removedPanes の make に容量ヒント追加
**ファイル:** `session_manager_windows.go`  
`make([]*TmuxPane, 0, len(window.Panes))` に変更でアロケーション最適化。

#### S-B02 — TestTeeHandler_BaseHandlerError_ErrorPropagated のテスト精度
**ファイル:** `handler_test.go`  
`errors.Is(err, innerErr)` まで assert することで透過性を完全に証明。

#### S-B03 — pane ID 文字列生成ロジックの集約
**ファイル:** `command_router_test_helpers_test.go`  
`formatPaneIDString(id int) string` のようなパッケージプライベート関数に集約。

#### S-B04 — パニック発生時の stderr 出力テスト
**ファイル:** `handler_test.go`  
os.Stderr を `bytes.Buffer` にリダイレクトして出力内容を assert するテスト追加を検討。

#### S-B05 — injectTestWindow で使用する terminal.Terminal{} の意図明記
**ファイル:** `session_manager_window_test.go`  
ゼロ値インスタンスの意図（ポインタ等価性チェックのみ）をコメントで明記する。

#### S-B06 — TeeHandler debug.Stack() の出力長
**ファイル:** `internal/sessionlog/handler.go`  
パニック時のみ実行のため問題なし。プロダクション環境ではスタックトレースの最初の数行のみ出力するオプションを検討。

---

### フロントエンド

#### S-C01 — useBackendSync の errorLogFetchSeq = 0 リセットは dead code
**ファイル:** `useBackendSync.ts`  
cleanup 内の `errorLogFetchSeq = 0` は `isMountedRef.current` ガードにより事実上到達不能。削除するか意図コメント追加。

#### S-C02 — normalizeEntries の ts/msg フィールド検証追加
**ファイル:** `errorLogStore.ts`  
`isValidSeq(seq)` のみ検証。最低限 `typeof entry.ts === 'string' && typeof entry.msg === 'string'` のガード追加を検討。

#### S-C03 — RegistryGlobal 型定義の可読性改善
**ファイル:** `viewerRegistry.ts`  
`[K in typeof REGISTRY_KEY]?` の mapped type は可読性が低い。`Record<typeof REGISTRY_KEY, ViewPlugin[] | undefined>` 等に変更を検討。

#### S-C04 — ActivityStrip.tsx の renderViewButton をコンポーネント外関数化
**ファイル:** `ActivityStrip.tsx`  
`useCallback` でメモ化するか、コンポーネント外の純粋関数化を検討。

#### S-C05 — ViewPlugin.position の型を明示的 union に変更
**ファイル:** `viewerRegistry.ts`  
将来の値追加で silent な誤動作が生じうる。switch 文や厳密な列挙チェックに変更を検討。

#### S-C06 — globalThis への書き込みで Symbol を使用
**ファイル:** `viewerRegistry.ts`  
キー名 `__mytx_view_registry__` は十分にユニークだが、Symbol を使うとさらに安全。

#### S-C07 — normalizeEntries のソート省略検討
**ファイル:** `errorLogStore.ts`  
バックエンドが seq 順保証を返すなら `sort` を省略可能。防御的コーディングとして残す判断も妥当。

#### S-C08 — normalizeEntries 全フィルタアウト時のDEVログ
**ファイル:** `errorLogStore.ts`  
`setEntries` 内で `normalizeEntries` がすべてフィルタアウトした場合のログ出力を追加（DEV モードのみ）。

---

## 良い点（Strengths）

### Go App層
1. **三重セキュリティ防御（buildUntrackedFileDiffSingle）**: lexical `isPathWithinBase`、EvalSymlinks 後の containment 再確認、Lstat ModeSymlink 検出の多層防御設計。
2. **Sync()-outside-lock パターン (A-0b)**: ファイルポインタをロック内でキャプチャし Sync() はロック外で実行。EINVAL/os.ErrClosed のクローズ競合を benign として処理。
3. **ping+fetch イベントモデル (A-0)**: throttle 発生時でも次回 ping でフルスナップショット取得が保証。データ損失ゼロの設計。
4. **PID をファイル名に付与 (A-2)**: sub-second 再起動によるファイル名衝突を防止。
5. **parseDiffHeaderPaths の対称性ヒューリスティック**: ` b/` を内包するパスを正しく処理。
6. **sessionLogSeq の race-free 採番**: ロック内の単一インクリメントで単調増加が保証。
7. **stubRuntimeEventsEmit(t) ヘルパー**: テストの重複ボイラープレートを大幅削減。`t.Cleanup` による自動リストア。
8. **commitHash への `"--"` 追加**: `DevPanelCommitDiff` の git コマンドに `"--"` を追加し、特殊なコミットハッシュのオプション誤解釈リスクを排除。

### Go 内部パッケージ
1. **Handle() の設計変更（base error にも callback を呼ぶ）**: UI 可用性を優先した明確な設計判断。
2. **debug.Stack() を os.Stderr に直接書く**: TeeHandler の再帰呼び出しを回避。
3. **WithAttrs/WithGroup の empty guard**: slog.Handler 仕様準拠の専用テストで回帰防止。
4. **injectTestWindow ヘルパー**: AddWindow API 削除後もマルチウィンドウテストの網羅性を維持。
5. **boolPtr → testutil.Ptr 統合**: テストパッケージ間の冗長ユーティリティを削減し DRY 原則に適合。
6. **snapshot-refetch 失敗時の即時ロールバック**: nil セッションでの処理継続という脆弱パスを排除。
7. **removedPanes の空スライス保証**: JSON シリアライズで null ではなく [] になるメリットが丁寧に説明。
8. **TestResolveDirectionalPane_MultipleWindowScopeIsolation**: DirNext/DirPrev がウィンドウ境界をまたがないことを 4 方向すべてで検証。
9. **`cap` → `bufCap` 変数名変更**: Go ビルトイン `cap` との名前衝突回避。
10. **リングバッファの capacity ≤ 0 クランプ**: 防御的改善。

### フロントエンド
1. **ping+fetch パターン**: `addEntry` の削除により重複排除ロジックが不要に。
2. **IMP-13 fetchSeq モノトニックカウンター**: `isMountedRef`（第1ガード）と seq 比較（第2ガード）の二重防御。
3. **callback ref パターン**: `useRef+useEffect([])` の無音な失敗リスクを根本的に解消。
4. **viewerRegistry の globalThis + HMR 設計**: dispose → 再充填の設計が正確。
5. **normalizeEntries のパイプライン**: filter(seq>0) → sort(seq) → slice(-MAX_ENTRIES) がシンプルかつ正確。
6. **DiffViewer parseDiff 修正**: `if (!match) continue` 変更により hunk header マッチ失敗時のゴミデータ混入を防止。
7. **key={entry.seq}**: React reconciliation に対して安定かつ一意なキー。
8. **shortcutMap のデータドリブン化**: Ctrl+Shift+E/G/L のハードコードを廃止。
9. **--warning/--warning-10 CSS 変数トークン化**: テーマ変更の一元管理が可能に。
10. **`lastReadSeq` による未読数管理**: seq ベースの未読判定はインデックスベースより堅牢。
11. **ログプレフィックス統一**: `[DEBUG-*]` → 機能別プレフィクスへの一貫した変更。

---

## 本番コード確認による追加レビュー

### 確認-01: `writeSessionLogEntry` と `closeSessionLog` のレースウィンドウ → **設計意図通り（対応済み）**
`isExpectedCloseRace` のハンドリング（`os.ErrClosed` / `syscall.EINVAL`）で正しく処理。

### 確認-02: `tmux:window-created` イベントの発火元 → **設計意図通り**
`handleNewWindow` は `tmux:session-created` を emit。`tmux:window-created` は将来のマルチウィンドウ対応向け予約。

### 確認-03: `addEntry` の削除影響 → **影響範囲は適切にカバー**
`setEntries` のみが公開API。`useBackendSync.ts` で置換済み。

### 確認-04: `Handle` のbase handler error後もcallback呼び出し → **設計意図通り**
UI可用性を優先した意図的な変更。

### 確認-05: diff-view の import 確認 → **要確認**
`ViewerSystem.tsx` で `import "./views/diff-view"` が追加されているが、diff-view ディレクトリのファイルは本差分に含まれていない。別コミットで追加済み、または未コミットの可能性がある。

---

## まとめ

| 項目 | 数 |
|------|---|
| Critical Issues | 1 |
| Important Issues | 17 |
| Suggestions | 24 |
| 合計タスク | 42 |

**最優先対応:** CRIT-01（git diff の `--` ターミネーター追加）  
**高優先対応:** I-A01（TOCTOU サイズガード）、I-C01（バッジフラッシュ）、I-C02（backend restart unreadCount）

---

## タスク整理表（修正作業の並列可否）

### 凡例
- 🔴 **Critical**: 必ず修正
- 🟥 **Important**: 対応推奨の修正
- 🟨 **Suggestion**: 考慮推奨の改善
- ✅ 並列作業可 | ⚠️ 同一ファイル注意 | → 依存あり

---

### 並列作業グループ表

| タスクID | 優先度 | 対象ファイル | 作業内容 | 並列可否 |
|---------|-------|------------|---------|---------|
| **[T-1]** | 🔴 CRIT-01 | `app_devpanel_api.go` | git diff コマンドに `"--"` ターミネーター追加 | ✅ 独立 |
| **[T-2]** | 🟥 I-A01 | `app_devpanel_api.go` | buildUntrackedFileDiffSingle のサイズTOCTOU修正（io.LimitReader採用） | ⚠️ T-1と同ファイル |
| **[T-3]** | 🟥 I-A02 | `app_devpanel_api.go` | 二重Lstat/EvalSymlinks最適化 + cachedInfoコメント追記 | ⚠️ T-1/T-2と同ファイル |
| **[T-4]** | 🟥 I-A03 | `app_session_log.go`, `app_events.go`, `useBackendSync.ts` | イベント名 app:error-log-updated → app:session-log-updated へ変更 | ✅ 独立 |
| **[T-5]** | 🟥 I-A04 | `app_events.go`, `app_events_test.go` | tmux:window-created へのコメント追加とテスト名改善 | ⚠️ T-4と`app_events.go`共有 |
| **[T-6]** | 🟥 I-A05 | `app_devpanel_api.go` | isFreshRepo 判定のログレベル格上げ検討 | ⚠️ T-1/T-2/T-3と同ファイル |
| **[T-7]** | 🟥 I-A06 | `app_devpanel_api.go` | parseWorkingDiff に unified diff 限定コメント追記 | ⚠️ T-1/T-2/T-3と同ファイル |
| **[T-8]** | 🟥 I-B01 | `internal/testutil/helpers.go` | go:fix inline のジェネリック対応確認・コメント修正 | ✅ 独立 |
| **[T-9]** | 🟥 I-B02 | `command_router_handlers_window.go` | エラーメッセージ "flag copy" を tmux互換語彙に変更 | ✅ 独立 |
| **[T-10]** | 🟥 I-B03 | `command_router_handlers_window.go` | rollback失敗時の rmErr をクライアントから隠蔽 | ⚠️ T-9と同ファイル |
| **[T-11]** | 🟥 I-B04 | `command_router_handlers_window.go` | getSessionForNewWindowFn の nil ガード意図コメント追記 | ⚠️ T-9/T-10と同ファイル |
| **[T-12]** | 🟥 I-C01 | `ErrorLogView.tsx` | markAllRead の useEffect → useLayoutEffect 化 | ✅ 独立 |
| **[T-13]** | 🟥 I-C02 | `errorLogStore.ts` | backend restart 後の lastReadSeq リセットロジック修正 | ✅ 独立 |
| **[T-14]** | 🟥 I-C03 | `ViewerSystem.tsx` | HMR 後の shortcutMap 再計算対応（DEV環境） | ✅ 独立 |
| **[T-15]** | 🟥 I-C04 | `wailsjs/go/models.ts` | prettier フォーマット実行でインデント統一 | ✅ 独立 |
| **[T-16]** | 🟥 I-C05 | `useErrorLog.ts` | auto-scroll useEffect に registerBodyElement 依存追加 | ✅ 独立 |
| **[T-17]** | 🟥 I-C06 | `useBackendSync.ts` | fetchErrorLog リトライ or コメント追記 | ⚠️ T-4と同ファイル |
| **[T-18]** | 🟥 I-C07 | `ErrorLogView.tsx` | cleanupRef アンマウント時のクリーンアップ確認 | ⚠️ T-12と同ファイル |
| **[T-19]** | 🟨 S-A01 | `app_devpanel_api.go` | parseDiffHeaderPaths コメント改善 | ⚠️ T-1～T-3と同ファイル |
| **[T-20]** | 🟨 S-A02 | `app_devpanel_api.go` | EvalSymlinks(workDir) 呼び出し元で一度だけ計算 | ⚠️ T-1～T-3と同ファイル |
| **[T-21]** | 🟨 S-A03 | `app_session_log.go` | sessionLogEmitMinInterval パッケージレベルへ昇格 | ⚠️ T-4と同ファイル |
| **[T-22]** | 🟨 S-A04 | `app_session_log_test.go` | テスト単純化 | ✅ 独立 |
| **[T-23]** | 🟨 S-A05 | `app_devpanel_api.go` | decodeGitPathLiteral 互換性コメント追記 | ⚠️ T-1～T-3と同ファイル |
| **[T-24]** | 🟨 S-A06 | `app_devpanel_api_test.go` | rename + " b/" テスト追加 | ✅ 独立 |
| **[T-25]** | 🟨 S-A07～S-A10 | `app_devpanel_api.go` | コメント系改善（一括作業推奨） | ⚠️ T-1～T-3と同ファイル |
| **[T-26]** | 🟨 S-A11 | `app_session_log.go` | cleanupOldSessionLogs 制限事項コメント追記 | ⚠️ T-4と同ファイル |
| **[T-27]** | 🟨 S-A12 | `useBackendSync.ts` | `[DEBUG-SYNC]` → `[SYNC]` 統一 | ⚠️ T-17と同ファイル |
| **[T-28]** | 🟨 S-B01 | `session_manager_windows.go` | make 容量ヒント追加 | ✅ 独立 |
| **[T-29]** | 🟨 S-B02 | `handler_test.go` | wrapped error アンラップ assert 追加 | ✅ 独立 |
| **[T-30]** | 🟨 S-B03 | `command_router_test_helpers_test.go` | pane ID 文字列生成ロジック集約 | ✅ 独立 |
| **[T-31]** | 🟨 S-B04 | `handler_test.go` | callback panic stderr 出力テスト追加 | ⚠️ T-29と同ファイル |
| **[T-32]** | 🟨 S-B05 | `session_manager_window_test.go` | terminal.Terminal{} 意図コメント追加 | ✅ 独立 |
| **[T-33]** | 🟨 S-C01 | `useBackendSync.ts` | errorLogFetchSeq dead code 削除/コメント | ⚠️ T-17/T-27と同ファイル |
| **[T-34]** | 🟨 S-C02 | `errorLogStore.ts` | normalizeEntries フィールド検証追加 | ⚠️ T-13と同ファイル |
| **[T-35]** | 🟨 S-C03 | `viewerRegistry.ts` | RegistryGlobal 型定義可読性改善 | ✅ 独立 |
| **[T-36]** | 🟨 S-C04 | `ActivityStrip.tsx` | renderViewButton 関数化/メモ化 | ✅ 独立 |
| **[T-37]** | 🟨 S-C05 | `viewerRegistry.ts` | position union 型厳密化 | ⚠️ T-35と同ファイル |
| **[T-38]** | 🟨 S-C06 | `viewerRegistry.ts` | globalThis キーを Symbol に変更 | ⚠️ T-35/T-37と同ファイル |
| **[T-39]** | 🟨 S-C07 | `errorLogStore.ts` | normalizeEntries ソート省略検討 | ⚠️ T-13/T-34と同ファイル |
| **[T-40]** | 🟨 S-C08 | `errorLogStore.ts` | normalizeEntries フィルタアウト時DEVログ | ⚠️ T-13/T-34と同ファイル |

---

### 担当者別推奨グループ（例：3名体制）

| 担当 | タスク群 | 主対象ファイル |
|-----|---------|--------------| 
| **担当A（Go App + DevPanel）** | T-1, T-2, T-3, T-6, T-7, T-19, T-20, T-23, T-24, T-25 | `app_devpanel_api.go`, `app_devpanel_api_test.go` |
| **担当B（Go Internal tmux + sessionlog）** | T-5, T-8, T-9, T-10, T-11, T-22, T-28, T-29, T-30, T-31, T-32 | `command_router_*.go`, `handler*.go`, `session_manager_*.go` |
| **担当C（フロントエンド + イベント名変更）** | T-4※Go側は担当Aと調整, T-12, T-13, T-14, T-15, T-16, T-17, T-18, T-21, T-26, T-27, T-33, T-34, T-35, T-36, T-37, T-38, T-39, T-40 | `*.tsx`, `*.ts`, `app_session_log.go`, `app_events.go` |

> ※ T-4 はGoファイル変更とTSファイル変更が分岐するため、イベント名を先に決定した上で並行実施可能。

---

### 作業フェーズ

```
フェーズ1（全並列・Critical + Important優先）:
  担当A: T-1 → T-2 → T-3（同ファイル順次）, T-6, T-7
  担当B: T-8, T-9→T-10→T-11（同ファイル順次）
  担当C: T-12→T-18（同ファイル）, T-13, T-14, T-16

フェーズ2（Important残り + Suggestion）:
  担当A: T-19, T-20, T-23, T-24, T-25
  担当B: T-5（T-4のイベント名決定後）, T-22, T-28, T-29→T-31, T-30, T-32
  担当C: T-4（イベント名変更・Go+TS）, T-15, T-17→T-27→T-33, T-21, T-26
          T-34→T-39→T-40, T-35→T-37→T-38, T-36
```
