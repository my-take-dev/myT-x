# DIFFサイドバーにおけるサブディレクトリ・ファイル非表示問題の詳細調査と最終修正計画

## 概要
myT-xの右サイドバー（DIFF差分表示画面）において、サブディレクトリおよびその配下のファイルが表示されない問題についての最終的な調査結果と、具体的な修正計画をまとめる。

## テスト環境（ユーザー環境）
- **OS**: Windows
- **リポジトリパス**: `D:\test_repository\test_repo`
- **ディレクトリ構造の特徴**: 
  - 英語のフォルダ名（`plans/`など）をベースとしている
  - その配下に、日本語やスペース、特殊文字を含むフォルダ名・ファイル名が存在している（例: `plans - コピー/`, `新規 テキスト ドキュメント.txt`）

## 調査結果と根本原因
前回の調査で「ディレクトリ階層を持たないバックスラッシュ区切りのファイル（例：`a\b\file.txt`）としてすらも画面に表示されない」ことが判明した点について、ユーザー環境のリポジトリで実際にコマンド挙動を確認した結果、**バックエンド（Go）がGitの出力をパースする最序盤の段階で対象ファイルの情報が完全に破棄（スキップ）されている** ことが根本原因であると特定した。

### 原因1: マルチバイト文字列等のクオートとエスケープ（`git ls-files` / `git diff`）
Gitはデフォルト動作（`core.quotepath = true`）において、ファイル名やディレクトリ名に**日本語（全角文字）やスペース**が含まれている場合、出力するパスを `"`（ダブルクォート）で囲み、さらに非ASCII文字を8進数エスケープ（例: `\343\202\263...`）して出力してしまう。

**実際の出力例（Untracked Files）:**
```text
"plans/plans - \343\202\263\343\203\224\343\203\274/新規 テキスト ドキュメント.txt"
```

この仕様により、バックエンド（`app_devpanel_api.go`）で以下の2つの致命的な不具合が発生していた：

1. **Untrackedファイルのスキップ消失**
   `collectUntrackedFiles` メソッド内で、Gitから返されたエスケープ・クオート付きの文字列（`"plans/...txt"`）をそのままローカルファイルシステムのパスとして扱い `os.Stat` 等で存在確認を行ってしまっている。しかし、ファイルシステム上に「先頭にダブルクォートが付いた変な文字化けファイル」は存在しないため、エラーとなり何もせずに静かに破棄される。
2. **Trackedファイル（`git diff HEAD`）のパース漏れ**
   `parseWorkingDiff` 内で、変更ファイルのパスが `a/` から始まっているかを判定している（`strings.HasPrefix(part, "a/")`）。しかしパスがクオートされると `"a/` から始まってしまうため判定条件に合致せず、差分情報から完全に除外される。

### 原因2: フロントエンドへ渡すパス区切り文字のOS依存（バックスラッシュ問題）
Go言語内でファイルパスの区切り文字としてWindows標準の `\`（バックスラッシュ）を使用し、そのままフロントエンド（React等）のAPIレスポンスとして渡してしまうと、フロント側の `file.path.split("/")` ではパスが正しく分割できず、ディレクトリツリーが構築できない。
これが原因で、仮に原因1をクリアしてフロントにデータを渡せたとしても「フラットな1つの長い名前のファイル」として処理されてしまいサブディレクトリ構造が作れない。

---

## 修正計画（対処すべき方法）

以上の原因をすべて解消するため、以下の修正をバックエンド（`myT-x/app_devpanel_api.go`）に対して適用する。
フロントエンド側の処理（ツリー構築など）は正しい実装になっているため修正は原則不要となる。

### 1. Gitの環境依存出力（クオート・エスケープ）を無効化する
Gitコマンドの実行時に、ユーザーの設定やOSに依存しない素直なパス（UTF-8・クオートなし）を強制出力させるためのオプションを付与する。

- **`git diff HEAD` へのオプション付与**
  `DevPanelWorkingDiff` 等で `git diff` を実行する際、引数に `-c core.quotepath=false` を追加し、マルチバイト文字等がエスケープ・クオートされないようにする。
  ```go
  args := []string{"-c", "core.quotepath=false", "diff", "HEAD", "--no-color"}
  ```

- **`git ls-files` の NUL字（ゼロバイト）区切り化**
  `collectUntrackedFiles` で `git ls-files` を実行する際、引数に `-z` オプションを追加する。
  これにより、クオートやエスケープが一切行われず、かつ空白を含むパスでも安全にパース可能になる。出力が改行ではなく `\0`（NUL）で区切られるようになるため、取得結果を `strings.Split(string(output), "\x00")` のように一意で安全な分割方式に変更する。

### 2. パス区切り文字のフロントエンド向け標準化（`/` への統一）
Goの処理内でファイルの存在チェック等を行うフェーズではOSに依存したセパレータ（`filepath.FromSlash` など）を使用して正しくアクセスするが、**APIレスポンスとしてフロントエンドに `WorkingDiffFile` やツリー構造を返す直前**で、必ず `filepath.ToSlash(path)` を適用し、パスセパレータを `/`（スラッシュ）に統一・正規化する。
これにより、フロントエンドはOS環境に関わらず `split("/")` のみで安全にディレクトリ階層をパース・構築できる。

### 3. パーサーの不要かつ危険な文字トリミング処理の削除
`collectUntrackedFiles` に存在する、文字集合としてトリムしてしまう危険な実装 `strings.TrimRight(line, "/\\")` 等を削除・修正する。
`-z` 導入に伴いNUL単位で正確に要素を分割するため、これらの安全ではない独自末尾削除処理自体が不要となる。

---

## 期待される効果
本修正を行うことで、テスト環境で用いているような「日本語フォルダ」や「スペースを含むファイル名」（例: `plans - コピー/新規 テキスト ドキュメント.txt`）であってもエラーにならず正しくファイル一覧として認識され、かつバックスラッシュに起因する階層化失敗も防げるため、DIFFサイドバーのツリー画面上に正しいディレクトリ構造で過不足なく表示されるようになる。
