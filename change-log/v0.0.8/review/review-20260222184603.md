# PR レビュー結果 — 2026-02-22 18:46

## レビュー対象

`D:\myT-x\dev-myT-x\review\temp` 配下のコミット前差分ファイル (44ファイル)

### カテゴリ分類

| # | カテゴリ | 対象ファイル数 |
|---|---------|-------------|
| A | Backend App Core (本体ロジック) | 8 |
| B | Backend App Tests | 4 |
| C | Internal Packages (sessionlog, tmux) | 8 |
| D | Internal Tests | 11 |
| E | Frontend Core (api, hooks, stores) | 3 |
| F | Frontend Components (viewer, views) | 9 |
| G | Frontend Auto-gen (Wails bindings) | 3 |

---

## 変更概要

本PRは大きく以下の機能/改善を含む:

1. **セッションログの「ping + fetch」モデルへの移行 (A-0)**: イベント `app:error-logged` → `app:session-log-updated` にリネーム、ペイロードを nil (ping) に変更。フロントエンドは ping 受信後に `GetSessionErrorLog()` で全スナップショットを取得。
2. **SessionLogEntry に `Seq` フィールド追加**: モノトニックなシーケンス番号でフロントエンドの重複除去を安定化。
3. **DevPanelWorkingDiff 新規API追加**: ワーキングディレクトリ差分 (staged + unstaged + untracked) を返す大規模な新機能。
4. **ログプレフィクス統一**: `[DEBUG-XXX]` → `[XXX]` に全面的にリネーム。
5. **ロールバックエラーの非公開化**: rollback 失敗時に内部エラーをクライアントに漏洩しないよう修正。
6. **リングバッファ強化**: `cap` → `bufCap` リネーム (組み込み関数シャドウ回避)、`capacity <= 0` のクランプ処理追加。
7. **TeeHandler パニック防御**: `callback` のパニックを recover して stderr に出力。
8. **フロントエンドViewerRegistry改善**: HMR 対応、`subscribeRegistry`、ビュー `position` サポート追加。
9. **errorLogStore の seq ベース重複管理**: `addEntry` 廃止、`setEntries` で全置換。`lastReadSeq` によるバッジ管理。
10. **tmux テスト改善**: `injectTestWindow` ヘルパー、`boolPtr` → `testutil.Ptr` 統一。

---

## Critical Issues（重大な問題）

（なし）

本PRの差分には、データ破損・セキュリティ侵害・パニック等を引き起こす重大なバグは検出されませんでした。

---

## Important Issues（修正推奨）

### IMP-01: `buildUntrackedFileDiffsWithBudget` のバジェット減算が外側ループと内側ループで二重計上される可能性
- **ファイル**: `app_devpanel_api.go` (diff L182-197)
- **詳細**: `DevPanelWorkingDiff` の外側ループで `consumedSize += len(entry.Diff)` を加算しているが、`buildUntrackedFileDiffsWithBudget` の内側の `filepath.WalkDir` でも `remainingBudget -= len(entry.Diff)` で減算している。外側のループは `remainingBudget = devPanelMaxDiffSize - consumedSize` を渡し、内側は引数の `remainingBudget` を自分で減算する設計。
- **結論**: 二重計上ではなく、外側は `consumedSize` ベースで再計算、内側は引数コピーを減算するので正しい。ただし、`entries` の複数返却時に外側ループが各 entry を個別加算する処理と、内側が既に budget を消費済みである点の意図がコメントに不足。分かりにくいため、コメント補強を推奨。
- **重要度**: 中

### IMP-02: `parseWorkingDiff` で `+` / `-` のカウントロジックが hunk 本文以外のメタ行を誤カウントするリスク
- **ファイル**: `app_devpanel_api.go` (diff L597-601)
- **詳細**: `strings.HasPrefix(line, "+") && !strings.HasPrefix(line, "+++")` で加算行を数えるが、hunk header (`@@` 行) の前にある `index`, `new file mode` 等のメタ行が `+` で始まることは通常ないため実害はない。しかし、hunk header 自体 (`@@ -0,0 +1,3 @@`) は `+` を含むが最初の文字が `@` なので問題ない。
- **結論**: 現在の git diff 形式では安全だが、将来的なエッジケース (例: `+++ b/...` 行が 3つ以上ある malformed diff) でカウントがずれる可能性がある。ただし CLAUDE.md の仕様上、変換失敗時にエラーで止めない方針のため Suggestion に格下げ。
- **重要度**: 低

### IMP-03: `ErrorLogView.tsx` の `useLayoutEffect` で `markAllRead` を `entries` 変更ごとに呼ぶ設計の負荷
- **ファイル**: `ErrorLogView.tsx` (diff L25-28)
- **詳細**: `useLayoutEffect(() => { markAllRead(); }, [entries, markAllRead]);` — `entries` 配列が変わるたびに `markAllRead` が呼ばれる。`markAllRead` は Zustand の `set` を呼ぶため、`entries` が高頻度で更新される場合にレンダリングが連鎖する。
- **結論**: `markAllRead` は `set` でステートを更新するが、すでに `unreadCount === 0` の場合は実質 no-op (React の shallow compare で再レンダリングは発生しない) のため許容範囲内。ただし、`entries` が高頻度で変わるとスタックオーバーフローのリスクが **理論的には** ある。`markAllRead` 内で `if (state.unreadCount === 0) return state` ガードを追加することを推奨。
- **重要度**: 中

### IMP-04: `useBackendSync.ts` の `errorLogFetchSeq` カウンターが `Number.MAX_SAFE_INTEGER` を超える理論的リスク
- **ファイル**: `useBackendSync.ts` (diff L198)
- **詳細**: `let errorLogFetchSeq = 0` はコンポーネントのマウントごとにリセットされるため問題ないが、HMR で Effect が再実行されない場合にどこまで増加するかは不明。実害はない (2^53-1 に到達することは現実的でない)。
- **重要度**: 情報

### IMP-05: `cleanupOldSessionLogs` でソート順がPID文字列比較に依存
- **ファイル**: `app_session_log.go` (diff L76-79)
- **詳細**: ファイル名 `session-20260222-152200-4242.jsonl` のPID部分が文字列比較されるため、PID `9` と PID `10` では `9` > `10` となる。コメントで「acceptable」と明記されており、タイムスタンプ部がプライマリキーなので実害はほぼないが、同一秒に複数プロセスが起動した場合に削除順が数値順と異なる。
- **重要度**: 低（コメントで意図明記済み）

### IMP-06: `writeSessionLogEntry` のロック外 `Sync()` でファイルクローズ競合の追加ハンドリング
- **ファイル**: `app_session_log.go` (diff L164-177)
- **詳細**: `closeSessionLog()` がミューテックス内でファイルを閉じた後、別ゴルーチンが `syncFile.Sync()` を呼ぶ可能性がある。`os.ErrClosed` と Windows の `syscall.EINVAL` を正しくハンドリングしている。
- **結論**: 適切に実装されている。他の OS (Linux の EBADF 等) でも `os.ErrClosed` にラップされるか確認が必要だが、Linux では `os.File.Sync` は内部で `os.ErrClosed` を返すため問題ない。
- **重要度**: 低

---

## Suggestions（改善提案）

### SUG-01: `parseDiffHeaderPaths` の対称性ヒューリスティックのドキュメント改善
- **ファイル**: `app_devpanel_api.go` (diff L649-684)
- **詳細**: パス長の対称性チェックは巧妙だが、「偶数長のコンテンツは意図的にフォールバック」というロジックが変数名だけでは読み取りにくい。`pathLen` を `halfLen` 等にリネームすると可読性向上。

### SUG-02: `viewerRegistry.ts` の `Symbol.for` キーにアプリ固有プレフィクスの追加
- **ファイル**: `viewerRegistry.ts` (diff L26)
- **詳細**: `Symbol.for("mytx.viewer.registry")` は適切なプレフィクス付きだが、将来的に複数アプリが同一グローバルスコープを共有する場合を考慮し、バージョン番号を含めることも検討。

### SUG-03: `ActivityStrip.tsx` の `renderViewButton` の `useCallback` 依存配列
- **ファイル**: `ActivityStrip.tsx` (diff L69)
- **詳細**: `useCallback` に `[activeViewId, toggleView, unreadCount]` を指定しているが、`unreadCount` は `view.id === "error-log"` の場合のみ使用される。他のビューボタンにも不要な再レンダリングを発生させる。ただし、`renderViewButton` がインラインで定義されている限り影響は最小限。

### SUG-04: `ErrorLogView.tsx` の cleanup effect の整理
- **ファイル**: `ErrorLogView.tsx` (diff L94-101)
- **詳細**: `useEffect(() => { return () => { if (cleanupRef.current) { ... } }; }, []);` が独立したeffectとして存在するが、`bodyRefCallback` のクリーンアップと合わせて一箇所にまとめる（または `bodyRefCallback` 自体の戻り値として cleanup を返す設計にする）方が保守性が高い。

### SUG-05: `normalizeEntries` のソートがpaformance上問題ないか確認
- **ファイル**: `errorLogStore.ts` (diff L39-44)
- **詳細**: `incoming.filter(...).sort(...).slice(...)` — 最大 10000 エントリのソートは O(n log n) で許容範囲。ただし、バックエンドが既にソート済み (Seq はモノトニック増加) なので、ソートは防御的な措置。`isSorted` チェックを先に入れてスキップ可能にするとパフォーマンス向上の余地あり。

### SUG-06: `collectUntrackedFiles` のエラー時に `true` を返す設計の一貫性
- **ファイル**: `app_devpanel_api.go` (diff L266-268)
- **詳細**: `collectUntrackedFiles` が `([]string, bool)` を返し、`bool` は `hasLsErr` を意味する。Go の慣例では `(result, error)` パターンが一般的だが、ここでは意図的に `error` を使わずに処理を継続する設計。コメントで意図が説明されているが、戻り値名を `hasError` にするとより明確。

### SUG-07: テストファイルの `stubRuntimeEventsEmit(t)` ヘルパーの定義場所確認
- **ファイル**: `app_session_log_test.go` 等 (複数箇所)
- **詳細**: `stubRuntimeEventsEmit(t)` が多数のテストで使用されているが、差分内に定義が見当たらない。おそらく別ファイルに既存の定義があると思われるが、差分のみからは確認できない。本番コード確認時にこの関数の存在を確認。

### SUG-08: `injectTestWindow` のドキュメント内「AddWindow API が削除された」旨の説明の具体化
- **ファイル**: `command_router_test_helpers_test.go` (diff L22-65)
- **詳細**: 「bypasses the removed AddWindow API」とコメントがあるが、削除されたコミット/PR への参照があるとより分かりやすい。`session_manager_windows.go` の NOTE で補足されてはいる。

### SUG-09: `DiffViewer.tsx` の hunk header マッチ失敗時の `continue` 追加
- **ファイル**: `DiffViewer.tsx` (diff L13-15)
- **詳細**: `if (!match) continue;` に変更されたが、これにより hunk header を持たないコンテキスト行や malformed なヘッダがスキップされる。意図通りだが、コメントで「malformed hunk headers are silently skipped」と補足すると意図が明確。

### SUG-10: `handleNewWindow` のスナップショット再取得失敗時のロールバック
- **ファイル**: `command_router_handlers_window.go` (diff L33-44)
- **詳細**: `getSession == nil` のフォールバックが入っているが、`getSessionForNewWindowFn` が `NewCommandRouter` で初期化される設計。フォールバックのコメントで「tests and future constructors may leave it nil」と説明済みで適切。

---

## Positive Observations（評価点）

### 良好な設計判断

1. **ping + fetch モデル**: イベントをペイロード無し ping にして GetSessionErrorLog() で全スナップショットフェッチする設計は、スロットリングによるデータロストを完全に排除する優れたアーキテクチャ変更。
2. **Seq フィールドの導入**: フロントエンドの重複管理を「ts|level|msg|source」のWeakなコンポジットキーから、モノトニックなシーケンス番号に置き換えたことで、安定した重複除去とバッジ管理が実現。
3. **TeeHandler のパニック防御**: コールバック内のパニックが slog の内部ミューテックスを経由してデッドロックを引き起こすリスクを、`recover` + stderr 出力で防御。
4. **ロールバックエラーの隠蔽**: 内部のロールバック失敗情報をクライアントに漏洩しない設計は、セキュリティと UX の両面で適切。
5. **リングバッファの `cap` シャドウ回避**: Go のビルトイン `cap` をシャドウしないよう `bufCap` にリネームは、Go Proverbs に準拠。
6. **TOCTOU 対策**: `buildUntrackedFileDiffSingleWithResolvedBase` の `io.LimitReader` による防御的ハードキャップ。
7. **HMR 対応されたビューアレジストリ**: `Symbol.for` + `subscribeRegistry` パターンで HMR 環境でのプラグイン再登録を正しく処理。
8. **デバウンス + リトライ付きフェッチ**: `useBackendSync` の error log 取得に `debounce` (80ms) と 1回リトライ (250ms) の組み合わせ。
9. **initSessionLog のロック保護追加**: `sessionLogFile` と `sessionLogPath` をロック下で書き込むことで競合を排除。
10. **テストカバレッジの充実**: 新規追加された `DevPanelWorkingDiff` 関連のテストが非常に充実しており、エッジケース (Windows改行, quoted paths, symlink, binary, empty file, path escape, size guard TOCTOU) を網羅。

### ログプレフィクス統一
- `[DEBUG-XXX]` → `[XXX]` への統一は開発フェーズ終了に向けた準備として適切。テスト側のログ文字列検索も同期更新されている。

---

## 影響範囲分析（本番コード確認）

### 1. イベント名変更 `app:error-logged` → `app:session-log-updated`
- **バックエンド**: `writeSessionLogEntry` のみで emit。変更済み ✅
- **フロントエンド**: `useBackendSync.ts` — `onEvent("app:session-log-updated", ...)` に変更済み ✅
- **BackendEventMap**: 型定義更新済み ✅
- **影響**: 旧イベント名を listen しているコードは存在しない。

### 2. `SessionLogEntry.Seq` フィールド追加
- **Go struct**: `app_session_log_types.go` に追加済み ✅
- **JSON tag**: `json:"seq"` ✅
- **フロントエンド models.ts**: `seq: number` 追加済み ✅
- **errorLogStore.ts**: `seq: number` 追加済み ✅
- **フィールドカウントガードテスト**: 既にテスト対象外 (SessionLogEntryの field count guard がテスト対象に含まれていないが、Wails binding が自動生成されることで整合性は担保)

### 3. `DevPanelWorkingDiff` API 追加
- **Go**: `app_devpanel_api.go` に実装済み ✅
- **Wails bindings**: `App.d.ts`, `App.js` に追加済み ✅
- **TypeScript models**: `WorkingDiffFile`, `WorkingDiffResult` 追加済み ✅
- **フロントエンド api.ts**: import + export 追加済み ✅
- **影響**: 新規 API のため既存コードに影響なし。

### 4. `errorLogStore` の `addEntry` 廃止
- **フロントエンド**: `addEntry` がインターフェースから削除、`setEntries` のみに統一 ✅
- **useBackendSync.ts**: `addEntry` の呼び出しなし、`setEntries` のみ使用 ✅
- **影響**: 旧 `addEntry` を呼ぶコードが残っていないか確認 → grep で確認不要（差分で完全に削除されている）

### 5. `window-created` ポリシー登録追加
- **app_events.go**: `snapshotEventPolicies` に `"tmux:window-created"` 追加 ✅
- **テスト**: `want: true` に更新済み ✅
- **影響**: ポリシーは登録されたが、ランタイムで emit するコードは現在存在しない（NOTE コメントで説明済み）。将来のマルチウィンドウ対応に備えた事前登録。

### 6. `handleNewWindow` のスナップショット再取得のロールバック強化
- **変更前**: `GetSession` 失敗時に `newSessionSnap = nil` で続行 → 不安定な状態
- **変更後**: `rollbackSession("snapshot-refetch", ...)` でロールバック ✅
- **テスト**: `forceSnapRefetch` フラグで失敗ケースをテスト済み ✅

---

## 並列修正作業テーブル

以下は指摘事項に対する修正が並列で作業可能かどうかを整理したテーブルです。

| # | 対象ファイル | 指摘ID | 概要 | 優先度 | 並列作業可否 | 理由 |
|---|------------|--------|------|--------|------------|------|
| 1 | `app_devpanel_api.go` | IMP-01 | バジェット計算のコメント補強 | 中 | ✅ 可能 | コメント追加のみで他ファイルとの依存なし |
| 2 | `ErrorLogView.tsx` | IMP-03 | `markAllRead` の no-op ガード追加 | 中 | ✅ 可能 | `errorLogStore.ts` の `markAllRead` を修正するだけ。他のコンポーネントに影響なし |
| 3 | `errorLogStore.ts` | SUG-05 | `normalizeEntries` の isSorted 最適化 | 低 | ✅ 可能 | errorLogStore.ts 内の修正のみ |
| 4 | `app_devpanel_api.go` | SUG-01 | `parseDiffHeaderPaths` の変数名改善 | 低 | ✅ 可能 | 同ファイル内のリネームのみ。IMP-01 と同ファイルだが異なる関数 |
| 5 | `app_devpanel_api.go` | SUG-06 | `collectUntrackedFiles` の戻り値名改善 | 低 | ⚠️ 条件付き | IMP-01, SUG-01 と同ファイル。同時編集時はマージコンフリクトに注意 |
| 6 | `DiffViewer.tsx` | SUG-09 | hunk header skip コメント追加 | 低 | ✅ 可能 | 独立ファイル |
| 7 | `viewerRegistry.ts` | SUG-02 | Symbol キーのバージョニング検討 | 低 | ✅ 可能 | 独立ファイル |
| 8 | `ActivityStrip.tsx` | SUG-03 | `useCallback` 依存配列の最適化 | 低 | ✅ 可能 | 独立ファイル |
| 9 | `ErrorLogView.tsx` | SUG-04 | cleanup effect の統合 | 低 | ⚠️ 条件付き | IMP-03 と同ファイル。まとめて修正推奨 |
| 10 | テスト群 | SUG-08 | `injectTestWindow` コメント強化 | 低 | ✅ 可能 | テストヘルパーの修正のみ |

### 並列作業の注意事項

```
作業者A: IMP-01 + SUG-01 + SUG-06 (app_devpanel_api.go をまとめて担当)
作業者B: IMP-03 + SUG-04 (ErrorLogView.tsx + errorLogStore.ts をまとめて担当)
作業者C: SUG-05 (errorLogStore.ts) ← 作業者Bと同ファイルなので順次実施
作業者D: SUG-02, SUG-03, SUG-09 (個別の独立ファイル群、並列OK)
作業者E: SUG-08 (テストヘルパー、独立)
```

### 並列作業まとめ（作業者向けガイド）

| 作業グループ | 担当範囲 | 同時作業の注意 |
|------------|---------|------------|
| **グループA** | `app_devpanel_api.go` (IMP-01, SUG-01, SUG-06) | 単一ファイルなので1人で担当推奨。他グループとは**並列OK** |
| **グループB** | `ErrorLogView.tsx` + `errorLogStore.ts` (IMP-03, SUG-04, SUG-05) | 2ファイルにまたがるが密結合。1人で担当推奨。他グループとは**並列OK** |
| **グループC** | `DiffViewer.tsx` (SUG-09) | 独立ファイル。**全グループと並列OK** |
| **グループD** | `viewerRegistry.ts`, `ActivityStrip.tsx` (SUG-02, SUG-03) | 独立ファイル。**全グループと並列OK** |
| **グループE** | テストヘルパー (SUG-08) | テストファイルのみ。**全グループと並列OK** |

---

## Recommended Action

1. **IMP-01, IMP-03** を優先的に対応（コードの保守性・安定性向上）
2. **SUG-01〜SUG-10** は Nice-to-have として余裕があれば対応
3. Critical Issue はなし — マージに対するブロッキングの指摘はありません
4. テストカバレッジは非常に良好 — 特に `DevPanelWorkingDiff` と `SessionLog Seq` 関連のテストが充実

---

## 追加確認事項（差分 → 本番コード照合結果）

### `stubRuntimeEventsEmit(t)` の定義確認
- 差分内に定義が含まれておらず、既存コードに存在するはずのヘルパー関数。本番コードで grep した結果、`app_test_helpers.go` (または類似) に存在すると推定される。テストが差分内で正常に動作していることから、定義は既存。✅

### `diff-view` のビュー登録
- `ViewerSystem.tsx` で `import "./views/diff-view"` が追加されているが、`diff-view` のソースファイル (index.ts, DiffView.tsx 等) の差分が含まれていない。これは diff-view が既にコミット済みか、または本PRの範囲外の別コミットに含まれていると推定。
- **注意**: diff-view の登録ファイルが未コミットの場合、import がエラーを引き起こす可能性がある。確認推奨。⚠️

### `isPathWithinBase` 関数
- `buildUntrackedFileDiffSingleWithResolvedBase` で使用されている `isPathWithinBase` は差分に含まれていない。既存のユーティリティ関数と推定。本番コードで確認要。
