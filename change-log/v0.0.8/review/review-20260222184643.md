# PR Review Summary — 2026-02-22 18:46

## レビュー対象
- 差分ファイル数: **44**
- カテゴリ: 6グループ（バックエンドDevPanel API / Events & Lifecycle / SessionLog / Tmux / フロントエンドコア / フロントエンドViewer・UI）

## 総合評価
全体として**高品質な変更**であり、設計意図が明確にドキュメント化されている。セキュリティ対策（パストラバーサル防止、シンボリックリンクスキップ）、パフォーマンス最適化（ロック外Sync、バジェット管理）、テストカバレッジも充実。以下に各カテゴリ別の指摘事項を記載する。

---

## Critical Issues (0件)

現時点でマージをブロックする重大な問題は確認されなかった。

---

## Important Issues (6件)

### IMP-01: `buildUntrackedFileDiffsWithBudget` — `remainingBudget` の関数パラメータ変更がサイドエフェクトを持つ

**ファイル**: `app_devpanel_api.go` (diff L304–L386)  
**重要度**: Important  

`buildUntrackedFileDiffsWithBudget` 内の`filepath.WalkDir`クロージャで `remainingBudget` を直接デクリメントしている（L376-377）。これはパラメータのシャドウイングではなく、外側の変数をキャプチャしているため**意図通りに動作する**が、コード可読性の観点から `remainingBudget` をローカル変数にコピーしてから操作した方が意図が明確になる。

```go
// 現状（動作はするが可読性の懸念）
if remainingBudget >= 0 {
    remainingBudget -= len(entry.Diff)
}
```

**推奨**: クロージャ内での外部変数キャプチャであることをコメントで明示するか、ローカル変数 `budget` にコピーして操作すること。

---

### IMP-02: `parseWorkingDiff` — 行カウントで `+++ ` 行が除外されていない

**ファイル**: `app_devpanel_api.go` (diff L597–L601)  
**重要度**: Important  

```go
} else if strings.HasPrefix(line, "+") && !strings.HasPrefix(line, "+++") {
    file.Additions++
} else if strings.HasPrefix(line, "-") && !strings.HasPrefix(line, "---") {
    file.Deletions++
}
```

この実装は正しく `+++` と `---` を除外しているが、Gitのバイナリファイル差分行（`Binary files ... differ`）やdiffヘッダ行内の `+` で始まるパスが誤カウントされるエッジケースがある。ただし、バイナリファイルの場合はhunkが生成されないため、実用上の影響は極めて低い。

**推奨**: hunkヘッダ（`@@`）の出現以降のみカウントするよう、状態変数 `inHunk` を追加することを検討。

---

### IMP-03: `useErrorLog.ts` — `registerBodyElement` を `useEffect` の依存配列に入れる意味

**ファイル**: `useErrorLog.ts` (diff L22)  
**重要度**: Important  

```typescript
}, [entries.length, registerBodyElement]);
```

`registerBodyElement` は `useCallback([], [])` でメモ化されており参照が変わらないため、依存配列に含めても実害はないが、`entries.length` が変わるたびにスクロール処理が発生する設計意図と無関係なため、リンターのexhaustive-deps対応であることをコメントで明示すべき。

**推奨**: `// eslint exhaustive-deps: included because useCallback guarantees stable reference` 等のコメントを追加。

---

### IMP-04: `errorLogStore.ts` — バックエンド再起動時の `lastReadSeq` リセットロジック

**ファイル**: `errorLogStore.ts` (diff L87–L90)  
**重要度**: Important  

```typescript
// Backend restart resets seq to 1. If the latest seq regresses, clear read marker.
if (maxNewSeq > 0 && maxNewSeq < lastReadSeq) {
    lastReadSeq = maxNewSeq;
}
```

バックエンド再起動でseqがリセットされた場合、`lastReadSeq` を `maxNewSeq` に設定するのは正しいが、この場合**全エントリが「既読」扱いになる**。バックエンド再起動後の最初のロードで新しいエラーが全て既読になる可能性がある。

**推奨**: バックエンド再起動検出時は `lastReadSeq = 0` にリセットして、再起動後の全エントリを未読として扱うことを検討。もしくは、現在の動作が意図的であることをコメントで明記。

---

### IMP-05: `cleanupOldSessionLogs` — 削除ループが `logFiles` 全体を走査する

**ファイル**: `app_session_log.go` (diff L87–L108)  
**重要度**: Important  

```go
for _, name := range logFiles {
    if deleted >= excess {
        break
    }
    if name == currentFile {
        continue
    }
    // ...
    deleted++
}
```

`currentFile` が `logFiles[:excess]` に含まれている場合、`excess` 個のファイルを削除しきれず、期待より1個多くファイルが残る可能性がある。例えば、`currentFile` がリストの最初にあり `excess=3` の場合、古い順に3番目のファイルではなく4番目まで走査する必要がある。現在のコードは `logFiles` 全体をrangeしているため正しく動作するが、全ファイル走査が意図的であることをコメントに明記すべき。

**推奨**: 既存コメント `// NOTE: Cleanup only protects...` に加え、`currentFile` スキップの影響で `excess` 以上のファイルが残りうる旨を明記。

---

### IMP-06: `TeeHandler.Handle` — コールバックをgoroutine/IIFE内で実行する安全性

**ファイル**: `internal/sessionlog/handler.go` (diff L57–L67)  
**重要度**: Important  

```go
func() {
    defer func() {
        if r := recover(); r != nil {
            fmt.Fprintf(os.Stderr, "[session-log] callback panicked: %v\n%s\n", r, debug.Stack())
        }
    }()
    h.callback(record.Time, record.Level, record.Message, h.group)
}()
```

パニックリカバリの追加は良い改善。ただし、`debug.Stack()` の呼び出しはパフォーマンスコストがある。高頻度ロギング環境でコールバックが頻繁にパニックする場合（通常は起こらないが）、スタックトレース取得がオーバーヘッドとなる。

**推奨**: 現状維持で問題なし。パニックは異常ケースであり、パフォーマンスへの影響は無視できる。

---

## Suggestions (12件)

### SUG-01: `[DEBUG-*]` ログプレフィックスの統一

**ファイル**: 複数ファイル  
**重要度**: Suggestion  

`[DEBUG-DEVPANEL]` → `[DEVPANEL]`、`[DEBUG-EVENT]` → `[EVENT]` 等のプレフィックス統一は良い変更。ただし、以下のファイルに**統一漏れ**がある：

- `command_router_handlers_pane.go` L7: `[DEBUG-SPLIT]` が残存
- `command_router_handlers_pane.go` L16: `[DEBUG-SPLIT]` が残存
- `command_router_handlers_session.go` L8: `[DEBUG-SESSION]` が残存

**推奨**: 上記箇所も `[SPLIT]`、`[SESSION]` に統一する。

---

### SUG-02: `WorkingDiffStatus` の型エイリアス使用

**ファイル**: `app_devpanel_types.go` (diff L26)  
**重要度**: Suggestion  

```go
type WorkingDiffStatus = string
```

型エイリアスを使う理由（Wails TypeScript binding生成の互換性）が丁寧にコメントされており良い。しかし、Go側でのコンパイル時型安全性が犠牲になっている。

**推奨**: 現状維持。Wailsとの互換性を優先する判断は妥当。将来的にWailsがnamed typeをサポートした場合は `type WorkingDiffStatus string` に変更を検討。

---

### SUG-03: `parseDiffHeaderPaths` — 対称性ヒューリスティックの複雑さ

**ファイル**: `app_devpanel_api.go` (diff L649–L685)  
**重要度**: Suggestion  

パス対称性による分割ロジックは巧妙だが、コードが複雑。IMP-01のコメントでリネース時の制限が説明されており適切。

**推奨**: 現状維持。テストケースで空白やb/を含むパスが十分カバーされている。

---

### SUG-04: `ActivityStrip` — `renderViewButton` の `useCallback` 依存配列

**ファイル**: `ActivityStrip.tsx` (diff L69)  
**重要度**: Suggestion  

```tsx
const renderViewButton = useCallback((view: ViewPlugin) => {
    // ...
}, [activeViewId, toggleView, unreadCount]);
```

`key={view.id}` が `renderViewButton` 内にあるが、`map` で使う場合は `key` プロパティの設定が正しく機能する。ただし、`useCallback` の中で `key` プロパティを設定しているため、Reactの仮想DOM比較に影響はないが、慣例的には `map` のコールバック外で `key` を設定する方が一般的。

**推奨**: 動作上は問題なし。コードスタイルの好みの範囲。

---

### SUG-05: `viewerRegistry.ts` — `Symbol.for` によるグローバルレジストリ

**ファイル**: `viewerRegistry.ts` (diff L26–L46)  
**重要度**: Suggestion  

```typescript
const REGISTRY_KEY = Symbol.for("mytx.viewer.registry");
```

`Symbol.for` はグローバルシンボルレジストリを使うため、同じ文字列キーを持つ他のライブラリとの衝突リスクがある。ただし、`mytx.viewer.registry` は十分に固有なキーであり、実用上は問題ない。

**推奨**: 現状維持。HMR対応のためのSingletonパターンとして適切。

---

### SUG-06: `ErrorLogView.tsx` — クリーンアップ用 `useEffect` の重複

**ファイル**: `ErrorLogView.tsx` (diff L94–L101)  
**重要度**: Suggestion  

```tsx
useEffect(() => {
    return () => {
        if (cleanupRef.current) {
            cleanupRef.current();
            cleanupRef.current = null;
        }
    };
}, []);
```

この `useEffect` はアンマウント時のクリーンアップ専用。`bodyRefCallback` 内の `cleanupRef.current` 設定と連携しているが、`bodyRefCallback` 自体がアンマウント時に `el=null` で呼ばれるため（React callback refの仕様）、この `useEffect` は**冗長**になる可能性がある。

**推奨**: React callback refはアンマウント時に `null` で呼ばれるため、`bodyRefCallback` 内のクリーンアップロジックで十分。ただし、安全マージンとして残すのは防御的でもあるため、コメントで理由を明記。

---

### SUG-07: `useBackendSync.ts` — `fetchErrorLog` のリトライ回数ハードコード

**ファイル**: `useBackendSync.ts` (diff L219)  
**重要度**: Suggestion  

```typescript
if (attempt >= 1) {
    return;
}
```

リトライ回数が `1` にハードコードされている。定数化して可読性を向上させることを推奨。

**推奨**: `const ERROR_LOG_FETCH_MAX_RETRIES = 1;` として定数化。

---

### SUG-08: `errorLogStore.ts` — `normalizeEntries` のソート安定性

**ファイル**: `errorLogStore.ts` (diff L39–L44)  
**重要度**: Suggestion  

```typescript
function normalizeEntries(incoming: ErrorLogEntry[]): ErrorLogEntry[] {
    return incoming
        .filter((entry) => isValidEntryShape(entry))
        .sort((a, b) => a.seq - b.seq)
        .slice(-MAX_ENTRIES);
}
```

`seq` は一意かつ単調増加であるため、ソートの安定性は保証される。しかし、`incoming` が空の場合の処理は `filter` → 空配列 → `sort` → 空配列 → `slice` → 空配列となり正常。

**推奨**: 現状維持で問題なし。

---

### SUG-09: `injectTestWindow` — テストヘルパーの `idString` 直接設定

**ファイル**: `command_router_test_helpers_test.go` (diff L47–L50)  
**重要度**: Suggestion  

```go
pane := &TmuxPane{
    ID:       manager.nextPaneID,
    idString: fmt.Sprintf("%%%d", manager.nextPaneID),
```

`idString` フィールドを直接設定しているが、本番コードでは `IDString()` メソッドが `idString` を返す。テストヘルパーで内部フィールドを直接操作するのは、将来のリファクタリング時に壊れるリスクがある。

**推奨**: 可能であれば `TmuxPane` のコンストラクタまたはファクトリーメソッドを使用。テストヘルパーであるため現状維持も許容。

---

### SUG-10: `commitHash` への `--` 追加

**ファイル**: `app_devpanel_api.go` (diff L99)  
**重要度**: Suggestion  

```go
output, gitErr := gitpkg.RunGitCLIPublic(repoDir, []string{"diff-tree", "--root", "-p", commitHash, "--"})
```

`--` の追加はGitコマンドの安全性を向上させる良い変更（パスとオプションの曖昧さ回避）。

**推奨**: 同様のパターンが他のGitコマンド呼び出しにもあるか確認し、一貫性を保つ。

---

### SUG-11: `bytes.IndexByte` への変更

**ファイル**: `app_devpanel_api.go` (diff L59)  
**重要度**: Suggestion  

```go
if bytes.IndexByte(probe, 0) >= 0 {
```

`bytes.ContainsRune(probe, '\x00')` から `bytes.IndexByte(probe, 0)` への変更はパフォーマンス改善として適切（ルーンデコードのオーバーヘッド回避）。

**推奨**: 良い変更。

---

### SUG-12: `cap` → `bufCap` のリネーム

**ファイル**: `app_session_log_types.go` (diff L38–L55)  
**重要度**: Suggestion  

```go
bufCap := len(rb.buf)
```

Go組み込み関数 `cap()` とのシャドウイング回避は好ましい変更。

**推奨**: 良い変更。

---

## Positive Observations（良い点）

1. **「ping + fetch」モデルの導入** (`app:session-log-updated`): スロットリングによるデータ損失を根本的に解消する優れた設計変更
2. **monotonic sequence number (`sessionLogSeq`)**: 安定したフロントエンドdeduplication基盤
3. **パストラバーサル防止**: `isPathWithinBase` + `EvalSymlinks` の二重ガード
4. **TOCTOU防止**: `LimitReader` による防御的読み取り
5. **ロールバックエラーの隠蔽**: クライアントにロールバック内部情報を漏洩しない設計
6. **包括的テストカバレッジ**: フィールド数ガードテスト、エッジケーステスト、ロールバックテストが充実
7. **HMR対応のレジストリ設計**: `Symbol.for` + `subscribeRegistry` パターン
8. **initSessionLogの排他制御強化**: `sessionLogFile`/`sessionLogPath` の書き込みをロック内に移動
9. **PID付きファイル名**: サブセカンド再起動時の衝突防止
10. **TeeHandlerのパニックリカバリ**: コールバックパニックがアプリケーション全体を巻き込まない設計

---

## Recommended Action

1. **Important Issues** の対応（特にIMP-04のバックエンド再起動時のlastReadSeqリセットロジック確認）
2. **SUG-01** のログプレフィックス統一漏れ修正
3. **SUG-06** の冗長useEffectの判断
4. テスト実行による動作確認

---

## 本番コード確認結果

差分から関連する本番コードのパターンも確認した結果、以下の追加指摘はない：

- `resolveSessionWorkDir` は差分のDevPanelWorkingDiffから正しく呼ばれている
- `gitpkg.IsGitRepository` / `gitpkg.RunGitCLIPublic` / `gitpkg.ValidateCommitish` のAPI使用は既存パターンに準拠
- `sessionLogRingBuffer` のリングバッファ操作は `push`/`snapshot` ともに正しく `bufCap` でモジュロ演算
- `devPanelExcludedDirs` はWalkDir内で正しく使用されている
- イベント名 `app:session-log-updated` はバックエンド（`writeSessionLogEntry`）とフロントエンド（`useBackendSync.ts`）で一致
- `WorkingDiffFile` / `WorkingDiffResult` のフィールドはWails生成の `models.ts` と一致

### 周辺影響範囲

| 変更箇所 | 影響範囲 | リスク |
|---------|---------|--------|
| イベント名 `app:error-logged` → `app:session-log-updated` | フロントエンドのイベントリスナー | ✅ 全て変更済み |
| `SessionLogEntry` に `Seq` フィールド追加 | Wails models.ts, errorLogStore | ✅ 全て変更済み |
| `DevPanelWorkingDiff` API追加 | api.ts, App.d.ts, App.js | ✅ 全て変更済み |
| `viewerRegistry` にposition追加 | ActivityStrip, error-log/index.ts | ✅ 全て変更済み |
| `subscribe/notify` パターンのレジストリ | ViewerSystem | ✅ 変更済み |
| `addEntry` 削除 → `setEntries` 一本化 | errorLogStore消費元 | ✅ useBackendSyncで一本化済み |
| ロールバック時のエラー隠蔽 | session/pane/window handler | ✅ 3箇所全て変更済み |
| `[DEBUG-*]` プレフィックス変更 | テストコードのログ検証 | ✅ テスト側も変更済み（一部漏れあり→SUG-01） |
| `TeeHandler.Handle` — base error時もcallback実行 | sessionlog callback | ✅ テスト追加済み |

---

## 並列作業可否テーブル

| # | タスク | ファイル | 並列OK | 備考 |
|---|--------|---------|:------:|------|
| IMP-01 | `buildUntrackedFileDiffsWithBudget` コメント追加 | `app_devpanel_api.go` | ✅ | コメント追加のみ。他タスクと独立 |
| IMP-02 | `parseWorkingDiff` hunkスコープカウント検討 | `app_devpanel_api.go` | ⚠️ | IMP-01と同一ファイル。**IMP-01と順次実行推奨** |
| IMP-03 | `useErrorLog.ts` 依存配列コメント追加 | `useErrorLog.ts` | ✅ | フロントエンド独立ファイル |
| IMP-04 | `errorLogStore.ts` lastReadSeq リセットロジック確認 | `errorLogStore.ts` | ✅ | ストア単独。他と独立 |
| IMP-05 | `cleanupOldSessionLogs` コメント明記 | `app_session_log.go` | ✅ | コメント追加のみ。他と独立 |
| IMP-06 | `TeeHandler.Handle` 現状維持確認 | `handler.go` | ✅ | 対応不要（現状維持） |
| SUG-01a | `[DEBUG-SPLIT]` → `[SPLIT]` 統一 | `command_router_handlers_pane.go` | ✅ | Tmuxカテゴリ。他SUG-01と独立 |
| SUG-01b | `[DEBUG-SESSION]` → `[SESSION]` 統一 | `command_router_handlers_session.go` | ✅ | Tmuxカテゴリ。他SUG-01と独立 |
| SUG-06 | `ErrorLogView.tsx` 冗長useEffect判断 | `ErrorLogView.tsx` | ✅ | フロントエンド独立ファイル |
| SUG-07 | `useBackendSync.ts` リトライ定数化 | `useBackendSync.ts` | ✅ | フロントエンド独立ファイル |
| SUG-09 | `injectTestWindow` コンストラクタ検討 | `command_router_test_helpers_test.go` | ✅ | テスト専用。他と独立 |
| SUG-10 | 他Gitコマンドへの `--` 追加確認 | `app_devpanel_api.go` 他 | ⚠️ | IMP-01/IMP-02と同一ファイル。**順次実行推奨** |

### 並列可否の凡例
- ✅ = 他タスクと並列で修正可能
- ⚠️ = 同一ファイルへの変更があるため、順次実行を推奨
- ❌ = 依存関係があり並列不可

### 同一ファイル競合グループ

| グループ | ファイル | 含まれるタスク |
|---------|---------|---------------|
| **A** | `app_devpanel_api.go` | IMP-01, IMP-02, SUG-10 |
| **B** | `useErrorLog.ts` | IMP-03 (単独) |
| **C** | `errorLogStore.ts` | IMP-04 (単独) |
| **D** | `app_session_log.go` | IMP-05 (単独) |
| **E** | `handler.go` | IMP-06 (単独・対応不要) |
| **F** | `command_router_handlers_pane.go` | SUG-01a (単独) |
| **G** | `command_router_handlers_session.go` | SUG-01b (単独) |
| **H** | `ErrorLogView.tsx` | SUG-06 (単独) |
| **I** | `useBackendSync.ts` | SUG-07 (単独) |

**結論**: グループA（3タスク）のみ順次実行が必要。他の全タスクは並列で作業可能。
