# PR Review Summary — 20260222184845

## レビュー対象

44 差分ファイル（Go バックエンド / TypeScript フロントエンド / CSS / Wails バインディング）。
主要な変更領域:

| カテゴリ | ファイル数 | 概要 |
|---|---|---|
| A: DevPanel API (Working Diff 新規) | 4 | `DevPanelWorkingDiff` 新API + diff パーサー + untracked diff 生成 |
| B: Session Log リファクタ | 6 | ping+fetchモデル移行, seq追加, ring buffer改善 |
| C: TeeHandler (sessionlog) | 2 | callback panic recover, base handler error時の動作変更 |
| D: Frontend — Error Log/Store | 5 | seq基盤一意キー, ping+fetchイベント, callback ref |
| E: Frontend — Viewer System | 5 | ViewerRegistry HMR対応, position サポート, ショートカット動的化 |
| F: Frontend — Diff View (新規) | 2 | CSS追加, import side-effect |
| G: Tmux Router/Handler | 12 | ロールバックエラー隠蔽, window-created ポリシー追加, テストヘルパー |
| H: ログプレフィックス統一 | 8 | `[DEBUG-*]` → `[*]` 一括リネーム |

---

## Critical Issues (2 件)

### CRIT-01: `buildUntrackedFileDiffsWithBudget` — `remainingBudget` がディレクトリwalk中に呼び出し元と同期しない
**[code-reviewer]** `app_devpanel_api.go` (新規 `DevPanelWorkingDiff`)

`DevPanelWorkingDiff` で `buildUntrackedFileDiffsWithBudget` を呼ぶ際、`remainingBudget` はループ外の `consumedSize` から計算されるが、`buildUntrackedFileDiffsWithBudget` 内部のディレクトリwalkでは **引数の `remainingBudget` をローカルで減算** している。しかし呼び出し元は戻り値の `entries` から `len(entry.Diff)` を加算して `consumedSize` を更新する。

この設計自体は動作するが、**ディレクトリwalk内でremainingBudgetが0以下になっても `fs.SkipAll` を返す前に既に追加済みの entries は返却される** ため、`consumedSize` が `devPanelMaxDiffSize` をわずかに超過する可能性がある。

```go
// app_devpanel_api.go L353
if remainingBudget == 0 {
    budgetExceeded = true
    return fs.SkipAll
}
```

**問題**: `remainingBudget` が 0 **ちょうど** の場合のみ SkipAll。直前のファイルで `remainingBudget -= len(entry.Diff)` した結果が **負** になった場合、次のイテレーションで `remainingBudget == 0` は false になり、さらにファイルが処理される。

**推奨修正**:
```go
if remainingBudget <= 0 {
    budgetExceeded = true
    return fs.SkipAll
}
```

**影響箇所**: `app_devpanel_api.go` L353

---

### CRIT-02: `handleNewWindow` — snapshot-refetch失敗時のロールバックでイベントリーク
**[code-reviewer]** `command_router_handlers_window.go`

`handleNewWindow` の snapshot-refetch 失敗パスで `rollbackSession("snapshot-refetch", ...)` が呼ばれるが、ロールバック前に **Step 7（フラグコピー）** が既に完了しており、`tmux:session-created` イベントが Step 6 の `r.sessions.CreateSession` 直後（Step 6b相当）にまだ emit されていないことを前提としている。

テストコード (`TestHandleNewWindow`) では `wantRollback: true` 時に `tmux:session-created` イベントが emit されていないことを検証しているが、**実装上イベントは `okResp` の直前で emit される構造なのでロールバックパスでは emit されない** — これは正しい動作。

ただし、**`getSessionForNewWindowFn` のデフォルト値 (`sessions.GetSession`) がnilになるケースはNewCommandRouterのデフォルト初期化で防がれているが、テスト外で `CommandRouter` を手動初期化した場合のnilガードが新たに追加された**。この防御的ガードは適切だが、`getSessionForNewWindowFn` が nil の場合にフォールバックする設計は、**将来 `GetSession` のシグネチャが変更された場合にフォールバックパスとの不整合が発生するリスク** がある。

**推奨**: `NewCommandRouter` 内でのワイヤリングをドキュメント化し、nilガードのコメントにリスクを明記。

**影響箇所**: `command_router_handlers_window.go` L304-L312, `command_router.go` L364

---

## Important Issues (9 件)

### IMP-01: `parseDiffHeaderPaths` — パスに `" b/"` を含むリネーム時の誤解析
**[code-reviewer]** `app_devpanel_api.go` L649-L684

コメント (IMP-01) で既に認識されているが、**フォールバック分岐 `strings.Index(header, " b/")` はパス自体に ` b/` を含む場合に誤った分割** を行う。リネームのテストケース (`TestParseWorkingDiff` の "rename where old path contains literal b/ segment") では `rename from` / `rename to` 行で上書きされるため結果は正しいが、**`parseDiffHeaderPaths` 単体としては誤ったパスを返す**。

パーサーの単体テスト `TestParseDiffHeaderPaths` が存在しない。

**推奨**: `parseDiffHeaderPaths` の単体テストを追加して、既知の制約をテストレベルでドキュメント化する。

**影響箇所**: `app_devpanel_api.go` L649-L684, `app_devpanel_api_test.go` (テスト不足)

---

### IMP-02: `decodeGitPathLiteral` — Go の `strconv.Unquote` と Git の octal escape の互換性
**[code-reviewer]** `app_devpanel_api.go` L745-L762

コメントでは「Git's quoted path format uses C-style escapes, which are compatible with strconv.Unquote」とあるが、**Git は 3桁の octal escape (`\146` = 'f') を使用するのに対し、Go の `strconv.Unquote` は octal を `\NNN` (3桁) としてサポートしていない**。Go 1.26 の `strconv.Unquote` は `\x`, `\u`, `\U` 形式のみ。

テストケース (`"quoted header with octal escapes"`) で `"a/dir/\146\151\154\145\040name.txt"` をテストしているが、このテストが通るのは **diff出力自体がテスト入力文字列として直接提供されている** ため。実際の `git diff` 出力でoctalエスケープが使われた場合、`strconv.Unquote` は失敗する可能性がある。

**推奨**: Git の octal エスケープを独自にデコードするか、`strconv.Unquote` の制約をドキュメント化する。

**影響箇所**: `app_devpanel_api.go` L745-L762

---

### IMP-03: `isPathWithinBase` 関数の未定義参照
**[code-reviewer]** `app_devpanel_api.go` L405, L438

`isPathWithinBase(absPath, workDir)` と `isPathWithinBase(resolvedAbs, resolvedBase)` が呼ばれているが、差分には `isPathWithinBase` の定義が含まれていない。この関数は既存コードに存在するはずだが、差分に含まれないため、パストラバーサル防御の正確性を検証できない。

**推奨**: `isPathWithinBase` の実装が `filepath.Rel` + プレフィックスチェックの標準パターンであることを確認。

**影響箇所**: `app_devpanel_api.go` L405, L438

---

### IMP-04: `writeSessionLogEntry` — `syncFile` の TOCTOU
**[silent-failure-hunter]** `app_session_log.go` L169-L177

`syncFile` はロック内でキャプチャされ、ロック外で `Sync()` が呼ばれる。この間に `closeSessionLog()` が呼ばれると `os.ErrClosed` が返るが、これは `isExpectedCloseRace` で適切にハンドルされている。

ただし、**Windows固有の `syscall.EINVAL` チェック** (`runtime.GOOS == "windows"`) は **ビルドタグではなくランタイムチェック** であるため、Linux/macOS ビルドでも `syscall.EINVAL` がインポートされる。Go の `syscall` パッケージは OS 固有定数のクロスプラットフォーム互換性を保証していないため、**非Windows環境でのコンパイルエラーのリスク** がある。

**推奨**: CLAUDE.md に「Windows対応アプリケーション」と明記されているため、現時点では問題なし。ただしクロスプラットフォームビルドを将来検討する場合は `//go:build windows` ガードを検討。

**影響箇所**: `app_session_log.go` L171-L172

---

### IMP-05: `useErrorLog.ts` — `registerBodyElement` を `useEffect` の依存配列に含める誤り
**[code-reviewer]** `useErrorLog.ts` L31

```typescript
}, [entries.length, registerBodyElement]);
```

`registerBodyElement` は `useCallback([], [])` で安定化されているため依存値としては無害だが、**自動スクロールのeffectに `registerBodyElement` を依存に含める意味が不明**。`entries.length` のみが実効的なトリガー。

**推奨**: 不必要な依存を削除するか、意図をコメントで明記。

**影響箇所**: `useErrorLog.ts` L31

---

### IMP-06: `ErrorLogView.tsx` — クリーンアップeffectの重複
**[code-reviewer]** `ErrorLogView.tsx` L94-L101

```tsx
useEffect(() => {
    return () => {
        if (cleanupRef.current) {
            cleanupRef.current();
            cleanupRef.current = null;
        }
    };
}, []);
```

この unmount クリーンアップは `bodyRefCallback` の中でも既に `cleanupRef.current` をチェック・実行している。**callback ref は React が要素のアンマウント時に `null` で再呼び出し** するため、`bodyRefCallback(null)` が呼ばれた時点でクリーンアップが実行される。

つまり、この `useEffect` と callback ref の両方でクリーンアップが走り、**二重クリーンアップのリスク** がある（cleanupRef.current = null でガードされているため実害はないが冗長）。

**推奨**: どちらか一方に統一してコメントで理由を明記。

**影響箇所**: `ErrorLogView.tsx` L94-L101, L35-L42

---

### IMP-07: `errorLogStore.ts` — `normalizeEntries` のパフォーマンス
**[code-simplifier]** `errorLogStore.ts` L39-L44

```typescript
function normalizeEntries(incoming: ErrorLogEntry[]): ErrorLogEntry[] {
    return incoming
        .filter((entry) => isValidEntryShape(entry))
        .sort((a, b) => a.seq - b.seq)
        .slice(-MAX_ENTRIES);
}
```

`setEntries` が呼ばれるたびに **全エントリの filter → sort → slice** が実行される。バックエンドからのスナップショットは既に seq 順でソート済み（Go側の ring buffer は FIFO）なので、ソートは原則不要。MAX_ENTRIES=10000 の場合、毎回のソートは O(n log n) のオーバーヘッド。

**推奨**: バックエンドが既にソート済みであることを前提に、`sort` をスキップするか、ソート済みチェック (`isSorted` ガード) を追加。

**影響箇所**: `errorLogStore.ts` L39-L44

---

### IMP-08: `viewerRegistry.ts` — `Symbol.for()` による グローバル汚染
**[code-reviewer]** `viewerRegistry.ts` L26

```typescript
const REGISTRY_KEY = Symbol.for("mytx.viewer.registry");
```

`Symbol.for()` は **グローバルシンボルレジストリ** を使用するため、同じページ上の他のスクリプトが同名のシンボルを使用した場合に衝突する。Wails アプリは内部使用のため実質的なリスクは低いが、ライブラリ的な設計パターンとしては `Symbol()` (ローカルシンボル) のほうが安全。

**推奨**: HMR対応のために `Symbol.for` が必要であることをコメントで明記。（HMR時にモジュールが再評価されても同一シンボルを参照する必要がある）

**影響箇所**: `viewerRegistry.ts` L26

---

### IMP-09: `ActivityStrip.tsx` — `renderViewButton` の `key` prop が不足
**[code-reviewer]** `ActivityStrip.tsx` L54

```tsx
<button key={view.id} ...>
```

`renderViewButton` は `useCallback` でメモ化されているが、`key` prop は JSX 内で直接指定されている。`map` のコールバックとして使用される場合は問題ないが、`key` は呼び出し元の `map` で管理するのが React の推奨パターン。現在の実装でも動作するため、軽微。

**影響箇所**: `ActivityStrip.tsx` L54, L77-L79

---

## Suggestions (11 件)

### SUG-01: `DevPanelWorkingDiff` — トランケーション境界の改善
**[code-simplifier]** `app_devpanel_api.go` L161-L168

```go
if lastIdx := strings.LastIndex(raw, "diff --git "); lastIdx > 0 {
    raw = raw[:lastIdx]
}
```

トランケーション時に最後の不完全なdiffブロックを除去する処理は良い設計だが、`lastIdx > 0` のチェックにより、**最初のdiffブロックの途中でトランケーションされた場合は空文字列にならず、不完全なブロックが残る**。`lastIdx == 0` の場合は raw が `"diff --git ..."` のみになる。

**推奨**: `lastIdx >= 0` で空文字列にフォールバックする方が安全。

---

### SUG-02: `buildUntrackedFileDiffSingle` の variadic `cachedInfo` パターン
**[code-simplifier]** `app_devpanel_api.go` L771-L782

`cachedInfo ...os.FileInfo` の variadic パターンは柔軟だが、Go では optional parameter のイディオムとして少し非標準。`len(cachedInfo) > 0 && cachedInfo[0] != nil` のチェックも冗長。

**推奨**: 将来的には `*os.FileInfo` (nilableポインタ) パターンを検討。現時点では動作に問題なし。

---

### SUG-03: `isFreshRepoStatusOutput` — ローカライズされた git 出力への対応
**[code-reviewer]** `app_devpanel_api.go` L239-L254

```go
return strings.HasPrefix(line, "## No commits yet on ") ||
    strings.HasPrefix(line, "## Initial commit on ")
```

`LANG` 環境変数によっては git の status 出力がローカライズされる可能性がある（例: 日本語環境では異なるメッセージ）。

**推奨**: git コマンドに `LC_ALL=C` を設定するか、ローカライズされたメッセージへの対応を検討。

---

### SUG-04: テストの `stubRuntimeEventsEmit` ヘルパー追加
**[pr-test-analyzer]** `app_session_log_test.go`

テスト全体で繰り返されていた `runtimeEventsEmitFn` のスタブ設定が `stubRuntimeEventsEmit(t)` ヘルパーに集約された。これは良いリファクタリング。ただし、**ヘルパーの定義が差分に含まれていない**。

**推奨**: `stubRuntimeEventsEmit` の実装を確認し、`t.Cleanup` で復元が行われていることを確認。

---

### SUG-05: CSS変数の一貫性
**[code-reviewer]** `viewer.css` L140

```css
background: var(--surface-3, var(--accent-10));
```

`--surface-3` が `base.css` で新たに定義されているが、フォールバック値 `var(--accent-10)` も設定されている。フォールバックが不要なら削除を検討。

---

### SUG-06: `useBackendSync.ts` — デバウンスタイマーのクリーンアップ順序
**[code-reviewer]** `useBackendSync.ts` L276-L283

クリーンアップ関数内で `errorLogDebounceTimer` と `errorLogRetryTimer` のクリアが `cleanupFns` のループ前に配置されている。順序は正しいが、**クリーンアップの意図（イベントタイマーを先にクリアしてからリスナーを解除）をコメントで明記** すると保守性が向上する。

---

### SUG-07: `TeeHandler.Handle` — callback呼び出しのIIFEパターン
**[code-simplifier]** `handler.go` L57-L67

```go
func() {
    defer func() {
        if r := recover(); r != nil { ... }
    }()
    h.callback(record.Time, record.Level, record.Message, h.group)
}()
```

IIFE + defer recover パターンは正しいが、**名前付き関数に抽出** すると可読性が向上する（例: `h.safeInvokeCallback(record)`）。

---

### SUG-08: `WorkingDiffStatus` — type alias の意図的なトレードオフ
**[type-design-analyzer]** `app_devpanel_types.go` L26

```go
type WorkingDiffStatus = string
```

コメントで「type safety at compile time is sacrificed」と明記されており、Wails TSバインディングとの互換性のためのトレードオフとして適切に文書化されている。将来的に Wails が定義型をサポートする場合は defined type に変更を検討。

---

### SUG-09: `parseNULSeparatedGitPaths` — `filepath.ToSlash` の適用タイミング
**[code-reviewer]** `app_devpanel_api.go` L291

```go
paths = append(paths, filepath.ToSlash(entry))
```

NUL区切りの git 出力は既にスラッシュ区切り（git の標準出力）であるため、`filepath.ToSlash` は Windows でのバックスラッシュ変換のみに有効。git の `-z` オプション出力では通常スラッシュが使われるため冗長だが、防御的コーディングとして許容。

---

### SUG-10: `TestCleanupOldSessionLogs_PreservesCurrentFile` — ファイル名パターンの整合性
**[pr-test-analyzer]** `app_session_log_test.go` L150

```go
currentName := "session-20260222-152200-4242.jsonl"
```

テストでハードコードされたファイル名は PID 形式 (`-4242`) を含んでいるが、ダミーファイルの生成では `formatIndexAsTimestamp(i)` が使われており、PID部分のバリエーションが不足。実際のファイル名パターンとの整合性は取れているが、PIDBが数値として小さいファイル名 vs 大きい PID のソート順テストがあると更に堅牢。

---

### SUG-11: `Wails バインディング` — `App.d.ts` / `App.js` の関数順序変更
**[comment-analyzer]** `App.d.ts.diff`, `App.js.diff`

`GetSessionErrorLog` と `GetSessionLogFilePath` がアルファベット順に移動されている。これは Wails のコード生成による自動変更と思われる。機能的な変更なし。

---

## Strengths（良い点）

1. **ping + fetch モデル** (`app:session-log-updated`)：スロットリングによるデータ損失を構造的に排除した優れたアーキテクチャ変更。`seq` フィールドによる安定した重複排除も適切。

2. **包括的なテストカバレッジ**: `TestParseWorkingDiff`, `TestBuildUntrackedFileDiffs`, `TestDetectFreshRepoState` 等、新規追加コードに対して網羅的なテーブル駆動テストが追加されている。

3. **防御的コーディング**: `buildUntrackedFileDiffSingleWithResolvedBase` での二重パストラバーサルガード（lexical + symlink resolution）、TOCTOU対策の `LimitReader`、ring buffer の capacity≤0 クランプなど。

4. **TeeHandler の panic recovery**: callback パニック時にログハンドラ全体を壊さない設計は実運用で重要。

5. **ログプレフィックス統一**: `[DEBUG-*]` → `[*]` の一貫した変更により、ログの可読性が向上。テストも追従して更新されている。

6. **ロールバックエラーの隠蔽**: 内部ロールバック失敗の詳細をクライアントに漏らさない設計変更は、API の公開面としての品質向上。

7. **ViewerRegistry HMR 対応**: `Symbol.for` + `subscribeRegistry` + `import.meta.hot.dispose` の組み合わせにより、開発時のHMRで view の再登録が正しく動作する。

8. **フィールドカウントガードテスト**: `TestWorkingDiffFileFieldCountGuard`, `TestWorkingDiffResultFieldCountGuard` による フロントエンド同期チェックは、構造体変更時の漏れ防止に有効。

---

## Recommended Action

1. **CRIT-01 を修正** — `remainingBudget <= 0` に変更
2. **CRIT-02 のリスクをドキュメント化** — `getSessionForNewWindowFn` の nil ガードコメントを強化
3. **IMP-01**: `parseDiffHeaderPaths` の単体テストを追加
4. **IMP-02**: `strconv.Unquote` と Git octal escape の互換性を検証
5. **IMP-06**: クリーンアップ effect の重複を整理
6. 他の Important / Suggestion は優先度に応じて対応

---

## 並列作業可否表

以下は修正タスクの一覧と、各タスクを並列で作業した場合の競合リスクを示します。

| # | タスクID | 対象ファイル | 修正内容 | 並列作業 | 競合リスク | 備考 |
|---|---------|-------------|---------|---------|-----------|------|
| 1 | CRIT-01 | `app_devpanel_api.go` | `remainingBudget <= 0` に修正 | ✅ 可能 | なし | 他タスクと独立 |
| 2 | CRIT-02 | `command_router_handlers_window.go`, `command_router.go` | `getSessionForNewWindowFn` のコメント強化 | ✅ 可能 | なし | コメント変更のみ |
| 3 | IMP-01 | `app_devpanel_api_test.go` | `parseDiffHeaderPaths` 単体テスト追加 | ✅ 可能 | ⚠️ 低 | CRT-01と同ファイルだが別関数のテスト |
| 4 | IMP-02 | `app_devpanel_api.go` | octal escape 対応の検証/修正 | ⚠️ 注意 | ⚠️ 中 | CRIT-01, IMP-01 と同ファイル。順次推奨 |
| 5 | IMP-03 | `app_devpanel_api.go` (既存) | `isPathWithinBase` 実装確認 | ✅ 可能 | なし | 読み取り専用作業 |
| 6 | IMP-04 | `app_session_log.go` | `syscall.EINVAL` のコメント追加 | ✅ 可能 | なし | コメント変更のみ |
| 7 | IMP-05 | `useErrorLog.ts` | 不要な依存削除 | ✅ 可能 | なし | フロントエンド独立 |
| 8 | IMP-06 | `ErrorLogView.tsx` | クリーンアップeffect整理 | ✅ 可能 | ⚠️ 低 | IMP-05と同系統だが別ファイル |
| 9 | IMP-07 | `errorLogStore.ts` | sort スキップ検討 | ✅ 可能 | なし | フロントエンド独立 |
| 10 | IMP-08 | `viewerRegistry.ts` | `Symbol.for` の意図コメント | ✅ 可能 | なし | コメント変更のみ |
| 11 | IMP-09 | `ActivityStrip.tsx` | key prop 整理 (軽微) | ✅ 可能 | なし | フロントエンド独立 |
| 12 | SUG-01 | `app_devpanel_api.go` | トランケーション境界修正 | ⚠️ 注意 | ⚠️ 中 | CRIT-01, IMP-04 と同ファイル |
| 13 | SUG-03 | `app_devpanel_api.go` | `LC_ALL=C` 検討 | ⚠️ 注意 | ⚠️ 中 | 同ファイルの他修正と競合 |
| 14 | SUG-04 | テストヘルパー | `stubRuntimeEventsEmit` 確認 | ✅ 可能 | なし | 読み取り専用作業 |
| 15 | SUG-07 | `handler.go` | IIFE をメソッドに抽出 | ✅ 可能 | なし | internal パッケージ独立 |

### 並列作業のグルーピング推奨

作業を効率的に進めるために、以下のグループに分けて並列作業を推奨します：

| グループ | 担当タスク | 理由 |
|---------|-----------|------|
| **グループA: DevPanel API (Go)** | CRIT-01, IMP-01, IMP-02, IMP-04確認, SUG-01, SUG-03 | **同一ファイル (`app_devpanel_api.go`) を触るため順次作業が必要**。他グループとは並列OK |
| **グループB: Session Log (Go)** | IMP-04, IMP-06コメント, SUG-04確認 | `app_session_log.go` 中心。グループAと並列OK |
| **グループC: TeeHandler (Go)** | SUG-07 | `internal/sessionlog/handler.go` 単独。他全グループと並列OK |
| **グループD: Frontend Error Log** | IMP-05, IMP-06, IMP-07, IMP-09 | フロントエンド独立ファイル群。Go側と完全並列OK |
| **グループE: Frontend Viewer** | IMP-08 | `viewerRegistry.ts` 単独。グループDと並列OK |
| **グループF: Tmux Router (Go)** | CRIT-02 | `command_router*.go` 単独。他全グループと並列OK |

> **注**: グループA内のタスクは同一ファイルを修正するため **順次作業** を推奨。グループ間は全て並列作業可能です。
