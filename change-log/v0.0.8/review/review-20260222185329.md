# 総合PRレビュー結果

本ドキュメントは、提供された `review/temp` 配下の全44ファイルの差分および関連する本番コード（`app_session_log.go`, `app_devpanel_api.go`, `errorLogStore.ts` 等）に基づき、[review-pr-para.prompt.md](../.github/prompts/review-pr-para.prompt.md) の方針に従って深く広範囲に実施したレビューの結果です。

作業の並列化（サブエージェントまたは複数開発者による効率的な分担）を目的とし、ファイルをカテゴリ別に分類した上で、それぞれのレビュー結果と並列作業時の整合性・競合リスクをまとめています。

---

## 📂 ファイルのカテゴリ分類（並列レビュー・作業アサイン用）

差分ファイルが多岐にわたるため、以下の4カテゴリに分割して並列処理・レビューが可能な状態としています。

1. **Category A: フロントエンド（UIコンポーネント・スタイル）**
   - 対象: `*ActivityStrip.tsx`, `*ViewerSystem.tsx`, `*viewerRegistry.ts`, `*ErrorLogView.tsx`, `*DiffViewer.tsx`, `*.css`
2. **Category B: フロントエンド（状態管理・同期通信）**
   - 対象: `*useBackendSync.ts`, `*errorLogStore.ts`, `api.ts`, `App.d.ts` 等自動生成スタブ
3. **Category C: バックエンド（DevPanel API 拡張・ログハンドリング）**
   - 対象: `*app_devpanel_api.go`, `*app_devpanel_api_test.go`, `*app_session_log.go`, `*sessionlog_handler.go` 等
4. **Category D: バックエンド（Tmuxルーター・ライフサイクル・テスト）**
   - 対象: `*app_lifecycle.go`, `*app_events.go`, `*tmux_command_router*.go`, `*tmux_session_manager*.go` 等

---

## 🔍 カテゴリ別指摘事項および推奨事項

### Category A: フロントエンド（UIコンポーネント・スタイル）
**対象ファイル:** `*ErrorLogView.tsx`, `*ViewerSystem.tsx`, `*.css` 等

#### 💡 Suggestions（推奨事項）
- **[code-simplifier] Reactイベントハンドリングへの移行:**  
  `ErrorLogView.tsx` の130行目付近において、`useCallback` と `useEffect` を組み合わせたネイティブDOM API (`addEventListener`) を使用して `keydown` や `selectionchange` をバインドしています。`selectionchange` は document 全体へのバインドが必要なため妥当ですが、コピーハンドリング (`ctrl+c`) に関しては対象の `<div>` に対し React の `onKeyDown={handleKeyDown}` を利用する方がライフサイクル管理が簡潔になり、コンポーネントのアンマウントエラーを防ぎやすくなります。
- **[comment-analyzer] Wails IME制御の対応:**  
  `ViewerSystem.tsx` にて `isImeTransitionalEvent(e)` が適切に導入されている点を評価します（IME入力中のバグ回避に有効です）。同系統のイベントハンドリング（DevPanelの他のテキスト入力部等）にも漏れなく適用されていることを確認してください。

### Category B: フロントエンド（状態管理・同期通信）
**対象ファイル:** `*useBackendSync.ts`, `*errorLogStore.ts`

#### ⚠️ Important Issues（重要事項）
- **[silent-failure-hunter / types] Sequence IDの型とエッジケース保護:**  
  `errorLogStore.ts` の `normalizeEntries` や読み込み判定において、新たに追加された `seq` は非常に堅牢な設計（バックエンドのリスタートに伴う seq の退行を検知して既読マーカーを補正する点）です。しかし、シーケンス番号を用いた重複排除やソートにおいては、`Number.isFinite(seq)` で評価を行っていますが、長期間稼働での数値の限界を考慮すると、JSのNumber安全整数制約に抵触しない限りは安全です。（1万件の上限があるので問題ありません）。
  
#### 💡 Suggestions（推奨事項）
- **[code-simplifier] 不要なPromiseネスト処理の回避:**  
  `useBackendSync.ts` に導入された debounce ベースの `fetchErrorLog` および `errorLogFetchSeq` の単調増加チェックは、並行フェッチとレースコンディション崩れを見事に防ぐ優れた非同期パターンです。この完成度であれば特に修正は不要ですが、同様のPing-Fetchパターンが他コンポーネント（GitDiff等）に波及する場合は独自フック（例: `usePingFetch`）として整理するとさらなる保守性向上が見込めます。

### Category C: バックエンド（DevPanel API 拡張・ログハンドリング）
**対象ファイル:** `*app_devpanel_api.go`, `*app_session_log.go`, `*sessionlog_handler.go`

#### 🔴 Critical Issues（必須修正事項: 本番コードとの整合性）
- **[silent-failure-hunter] `git status` 系のロケール依存リスク:**  
  `app_devpanel_api.go` の `detectFreshRepoState` 関数内において、`isFreshRepoStatusOutput` が `## No commits yet on ` という英語のGit出力文字列を直接比較しています。
  ユーザーの環境においてGitの言語設定(`LANG=ja_JP.UTF-8` 等)が日本語などになっている場合、この判定が誤爆（常に false と判定される等）する危険性が高いです。
  **対策:** `RunGitCLIPublic` の実行時に `c.Env = append(os.Environ(), "LC_ALL=C", "LANG=C")` を注入するなどして、Gitコマンドから必ず英語表記が返却される体制を保証してください。類似のGit出力をパースする箇所全体への横断的な修正が必要です。

#### ⚠️ Important Issues（重要事項）
- **[code-reviewer] 大量ファイル読み込み時のメモリ防衛（Budgeting）:**  
  `app_devpanel_api.go` の `buildUntrackedFileDiffsWithBudget` は、非常に優れた防衛的実装です（巨大なUntracked Filesを解析する際のOOMを回避）。ここでは Symlink 解決（`filepath.EvalSymlinks`）とディレクトリトラバーサルを行っていますが、Windows 特有の深いネスト（パス長260文字制約）でエラーが発生した際のエラーハンドリング (`slog.Debug`) が一部握りつぶしに近い形になっています。Windows特有の挙動を考慮し、パス長超過時は警告(`slog.Warn`)ログを残すようにしてください。

#### 💡 Suggestions（推奨事項）
- **[errors] Mutex運用と後処理の工夫:**  
  `app_session_log.go` の `writeSessionLogEntry` にて、ロック内で `syncFile` を捕捉し、アンロック後に `Sync()` を呼び出しているアーキテクチャはディスクI/Oロックの遅延防止として完璧です。このパターンは他箇所のログ永続化にも水平展開可能です。

### Category D: バックエンド（Tmuxルーター・ライフサイクル・テスト）
**対象ファイル:** `*app_lifecycle.go`, `*internal_tmux_*.go`

#### ⚠️ Important Issues（重要事項）
- **[pr-test-analyzer] テストファイルにおけるモック関数の挙動:**  
  各 `*_test.go` ファイルにおいて `stubRuntimeEventsEmit(t)` というヘルパーが利用されるようになりましたが、これによって並列実行時(`t.Parallel()`) にグローバルなWails Emit関数（`runtimeEventsEmitFn`）との競合が起きないか確認が必要です。もしパッケージレベルのグローバル変数をモックしている場合、`t.Parallel()` によって他のテストと競合する可能性があります。関数スタブを利用しているテストは直列実行に留めるか、App構造体にEventEmitterインターフェースを持たせるDIアプローチでのリファクタリングを将来的に検討してください。

---

## 🌎 本番コード（Peripheral Impact）を含む二次レビュー結果

周囲の依存コード（`main.go`, `wails.json` 及び既存のバインディング等）への影響範囲を考慮した場合の評価を含みます。

1. **Wailsのイベントディスパッチモデルとの整合性:**
   以前はバックエンドから直接ペイロードを含んだ重いイベントを発火させていましたが、Ping-Fetchモデル(`app:session-log-updated` 無ペイロード送信 -> FrontendからのPull)へと変わったことで、Wails内部のWebSocketのバッファ詰まり現象が完全に解消されます。周辺の影響としては、フロントにデータ保持の責任が移るためStoreのメモリ肥大化をケアする必要がありますが、`MAX_ENTRIES = 10000` の設計が追加されているため安全です。
2. **Tmuxのルーティングイベント:**
   将来的拡張用の `tmux:window-created` 等のポリシーが追加されただけで既存のルーティングには影響がなく、安定して稼働する見込みです。

---

## 📊 タスク整理と並列対応の可否（作業者向けマトリクス）

チーム内での作業分担や、サブエージェントへの個別割り当てをスムーズに行うためのサマリー表です。「問題なし(✅)」の項目はそれぞれ完全に独立して作業可能です。「要注意(⚠️)」の箇所は、依存するバックエンドAPIや共通変数の変更を取り込んでから実装を行う必要があります。

| ID | カテゴリ | タスク内容 (Issue / Suggestion) | 並列作業可否 | 依存・制約 |
| :-- | :-- | :-- | :--: | :-- |
| **TSK-1** | 🎨 Frontend | `ErrorLogView.tsx` のネイティブイベント監視処理を React の `onKeyDown` プロパティへ移行する（リファクタ） | ✅ 問題なし | 独立したUI改修。他の修正と影響なし |
| **TSK-2** | 🧠 Frontend | `useBackendSync.ts` で実装したPing-Fetchパターン（debounce & counter）の他機能への横展開の検討またはヘルパー化 | ✅ 問題なし | 既存の同期ロジックに限定されるため安全 |
| **TSK-3** | ⚙️ Backend | **[🚨必須]** `detectFreshRepoState` (`app_devpanel_api.go`) におけるGit出力結果の言語依存バグ修正(`LC_ALL=C` の指定) | ✅ 問題なし | コマンド呼び出し引数の修正。直ちにアサイン可能 |
| **TSK-4** | ⚙️ Backend | `buildUntrackedFileDiffsWithBudget` 内での Windows パス長限界時におけるエラーログのレベル引き上げ（Debug -> Warn） | ✅ 問題なし | 独立したロギング設定の修正 |
| **TSK-5** | 🧪 Testing | `stubRuntimeEventsEmit` 利用テスト群の並列実行性(`t.Parallel`)リスクの調査と、必要に応じたDI化への切り替え方針策定 | ⚠️ 要注意 | `App` 構造体への広範なインタフェース注入が将来的に必要になる可能性有 |

### 総評
追加された差分は、大規模なファイルや膨大なログをフロント・バック間で安全にやり取りするための防御的プログラミングが徹底されています（バジェット管理・debounce等）。特にPing-Fetchアーキテクチャの導入は秀逸です。
本番適用にあたっては、Gitロケール依存のリスク(**TSK-3**) のみ対応必須のクリティカル課題として扱い、それ以外の項目はリファクタリング・最適化の枠組みで随時採り入れてください。
