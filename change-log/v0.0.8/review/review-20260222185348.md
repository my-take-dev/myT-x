# 包括的コードレビュー報告レポート

対象: `D:\myT-x\dev-myT-x\review\temp` 配下のコミット前差分
担当カテゴリ: 全体統合レビューおよび並列処理向けカテゴリ化

本レビューは、並行処理を可能とするためのファイルベースのカテゴリ分けと、バックエンド・フロントエンドの実装に対する影響範囲（メモリ使用量・競合状態・エラーハンドリング等）を考慮した深堀りレビューが含まれています。同種の処理に対する反復的な指摘漏れを防ぐため、ロジック全体を一貫した基準で検証しています。

## 1. カテゴリ別レビュー結果と詳細指摘事項

### カテゴリA: DevPanel API (Git差分・Untrackedファイル取得処理周辺)
**対象ファイル:** `*devpanel_api.go`, `*devpanel_api_test.go`

- **(指摘) メモリ確保とパフォーマンスの懸念 (重要度: 低〜中):**
  `app_devpanel_api.go`内の`parseWorkingDiff`にて、数MBにも及ぶ可能性のあるディフ結果の文字列全体に対し、`strings.ReplaceAll(raw, "\r\n", "\n")` や `strings.ReplaceAll(...)` を実行しています。`devPanelMaxDiffSize`で上限(500KB)を設けているためメモリ爆発には至りませんが、巨大なファイルに対して複数回の再アロケーションが発生するため、本番環境の負荷の状況によっては`bytes.ReplaceAll`などのバイトスライスによる処置や、Streaming parseへの切り替え方針も考慮する余地があります。
- **(評価) シンボリックリンク・セキュリティ考慮:**
  Untrackedのファイル読み込み時、`EvalSymlinks`を用いたシンボリックリンク解決後にも再度 `isPathWithinBase` を用いて、ワークスペース外へのディレクトリトラバーサルを確実に防御している点は非常に堅牢です。

### カテゴリB: Session & Error Log（状態監視・バックエンドイベント）
**対象ファイル:** `*session_log.go`, `*session_log_types.go`, `internal/sessionlog/handler.go`

- **(指摘/確認) uint64とJSONとの互換性による精度落ちリスク (重要度: 低):**
  `SessionLogEntry`の`Seq`プロパティはGo側で`uint64`となっており、JSONとして出力されますが、フロントエンド側(TypeScript)のStoreでは`number`として受け取っています。JavaScriptの`Number.MAX_SAFE_INTEGER`（2^53-1）を超えることは実運用上想定されないというコメントは妥当ですが、将来的に型エラーや他の用途に転用された際の予期せぬパース失敗を避けるため、万全を期すならJSONシリアライズ時に値を`string`にするか、安全な範囲への切り捨て・明示的なエラー処理の採用をおすすめします。
- **(評価) ロックの粒度とI/O分離:**
  `app_session_log.go` の `writeSessionLogEntry` において、ログファイルへのI/Oであり時間のかかる`Sync()`処理を、ミューテックス(`sessionLogMu.Unlock()`)の後に分離させた設計は、他スレッドやイベントループのブロッキングを防ぎ極めて適正に実施されています。
- **(指摘) パニックからのリカバリ処理の安全性:**
  `TeeHandler`内でコールバック発行時の`panic`を`recover()`で捕捉していますが、ログのシステムは汎用的であるため、状態が中途半端に更新されたままリカバリすると次の処理で二次障害を起こす可能性があります。当該部分はイベント通知処理限定と見受けられますが、その前提条件が将来崩れないように内部コメント等で明記されることを推奨します。

### カテゴリC: Tmux Event Handlers
**対象ファイル:** `*tmux_command_router*.go`

- **(指摘) Rollback時のエラーラップ追跡:**
  `handleNewWindow` 処理内の `rollbackSession` で、`RemoveSession` が失敗した際など、エラーログを出力するだけで、`return errResp(originalErr)` を返しています。元の`handleNewSession`と同等の挙動にしている点は一貫していますが、複数エラー（オリジナルのエラー自体と、クリーンアップ時の二次エラー）のトレーサビリティを考慮すると、内部ログだけでなくコンテキストにも複数エラー群のサマリ(`errors.Join`の活用等)が含まれるようにしておくと、後の運用デバッグでより詳細な原因特定が可能になります。

### カテゴリD: Frontend (Store, WS Sync, イベント監視)
**対象ファイル:** `useBackendSync.ts`, `errorLogStore.ts`, `ErrorLogView.tsx`

- **(評価) イベント購読の競合防止とPing+Fetch:**
  Wailsからの大量イベント通知の代わりに「Ping+Fetchアーキテクチャ」へ移行したのは、データロスを防ぎフロントエンドの処理落ちを予防する優れたアプローチです。`useBackendSync.ts` で `errorLogFetchSeq` のシーケンス番号を用いて、複数非同期リクエストが前後した際のリクエスト競合（古いレスポンスが新しい状態を上書きする問題）を防ぐ実装は非常に堅実です。
- **(指摘) DOMリファレンス管理とクリーンアップ漏れの懸念 (重要度: 中):**
  `ErrorLogView.tsx` の `bodyRefCallback`（コールバックref）対応は、マウントのタイミング問題の回避として妥当です。しかし、内部でキーボードイベント(`keydown`)やドキュメントレベルの`selectionchange`イベントへの登録・解除処理を`cleanupRef`に手動で委譲して実行するアプローチを取っているため、Reactのライフサイクル（特にStrict Mode利用等の複数回のMount/Unmount時）において適切にクリーンアップされるか、予期せぬリスナーの多重登録が発生しないかを本番環境でも入念に検証してください。

---

## 2. タスク整理表 (並列作業の可否と割り当て)

作業者やサブエージェントが差分の修正・最適化に一括で、かつ競合せずに効率よく着手できるようカテゴリ別のタスク表を作成しました。類似の処理にも同様の指摘が波及しないよう、対応する際は該当カテゴリ内を横断的に確認しながら修正を実施してください。

| カテゴリID | 対象モジュール範囲 | 修正・確認タスク内容 | 依存関係・ファイル競合リスク | 並列作業の可否 | 実装ガイド・備考 |
| :---: | :--- | :--- | :--- | :---: | :--- |
| **A** | DevPanel API バックエンド<br>`app_devpanel_*.go` | 【パフォーマンス改善検証】<br>・ `parseWorkingDiff` 文字列処理 (`strings.ReplaceAll`) をバイトスライス処理やStream等へ最適化するかの検討。<br>・大容量差分データのメモリ使用量再チェック。 | 他サブシステムへの影響なし | **◎ 即座に可能** | 内部ロジックのみかつ閉じた領域の変更のため、他カテゴリと一切衝突せず独立対応が可能です。 |
| **B** | セッション・エラーログ管理<br>`*session_log*.go`<br>`internal/sessionlog/*` | 【型安全性と堅牢性の向上】<br>・JSONの`uint64`(`seq`)の扱いをフロントエンドと再確認（不安があれば string へ）。<br>・TeeHandler コールバックの panic 復旧に対するコメント追記や安全機構の補足。 | フロントエンド(D)のAPI仕様・モデルと密接に結合 | **△ 要事前調整** | API通信の型プロパティ(`seq`)等が絡むため、作業前にDのフロント担当と要件（型）を合意後に進めること。 |
| **C** | Tmux Command Router<br>`*tmux_command_*.go` | 【エラー可視化の強化】<br>・エラーロールバック時（`RemoveSession`失敗時等）のエラー合成（`errors.Join`使用など）によるトレーサビリティの向上。<br>・類似のロールバック実装一斉点検。 | なし | **◎ 即座に可能** | 既存ロジック・IFを変更せず、内部のエラー返却形式の向上に留まるため安全に並列着手できます。 |
| **D** | Frontend View & Store<br>`*.ts`, `*.tsx` | 【メモリリーク/競合の検証】<br>・`ErrorLogView.tsx`のコールバックref移行に伴うイベント多重登録・クリーンアップ漏れの徹底検証（Strict Mode含む）。<br>・大容量ログ受信時のUI描画遅延のチェック。 | バックエンド(B)のAPIレスポンスのスキーマ変更の影響を受ける | **〇 Bの仕様確定後** | Bで行う `seq` の型仕様（パース戦略）の決定に合わせて修正を並行実施することで、二度手間を防げます。 |

**【並列レビュー・開発実行の推奨作業フロー】**
1. **フェーズ1 (プロトコル・型仕様の確定)**：カテゴリ B (バックエンドAPI) と D (フロントエンド呼び出し層) 間のデータモデル（特に `Seq` フィールドの型制約）に関する合意形成を迅速に行う。
2. **フェーズ2 (パラレル作業開始)**：
   - 【 サブエージェント1 】: **カテゴリA** の処理パフォーマンス、文字変換等の最適化を図る。
   - 【 サブエージェント2 】: **カテゴリC** のエラー処理の統合・ロギングの改良を一気に修正する。
   - 【 サブエージェント3 】: **カテゴリB & D** (フェーズ1確定後) の実装への修正・ブラッシュアップを行う。
これにより、相互の影響やGitコンフリクトを最小限に抑えつつ、効率よく且つ漏れのない一括修正が可能です。
