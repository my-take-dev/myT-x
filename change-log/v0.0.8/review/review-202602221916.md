# PR 総合レビュー結果 — 2026-02-22 19:16

> **統合元:** review-20260222184600〜185831 の 10ファイル（並列レビュー結果を重複排除・統合）
> **レビュー対象:** コミット前差分 44ファイル（Go バックエンド / TypeScript フロントエンド / CSS / Wails バインディング）
> **レビュー方針:** [review-pr-para.prompt.md](../.github/prompts/review-pr-para.prompt.md) 準拠

---

## 1. 変更概要

| カテゴリ | 主な変更内容 | 変更規模 |
|---|---|---|
| **A. DevPanel WorkingDiff** | 新API `DevPanelWorkingDiff`（staged + unstaged + untracked差分取得）追加 | +1730行 |
| **B. SessionLog 刷新** | ping+fetchモデル移行 (`app:error-logged` → `app:session-log-updated`)、`Seq` フィールド追加、リングバッファ改善 | +900行 |
| **C. TeeHandler 改善** | callbackパニック回復、base handler エラー時のコールバック継続実行 | +100行 |
| **D. ログプレフィックス統一** | `[DEBUG-*]` → `[*]` への全面リネーム | 複数ファイル |
| **E. エラー隠蔽修正** | rollback失敗時の内部エラーをクライアントに漏らさない設計に変更 | 小規模 |
| **F. Tmux テスト追加** | `injectTestWindow` ヘルパー、マルチウィンドウ境界テスト | +830行 |
| **G. フロントエンド改善** | ViewerRegistry HMR対応、diff-view新規追加、ActivityStrip位置対応 | +1100行 |
| **H. session_manager** | `removeWindowAtIndexLocked` の `RemovedPanes` を nil → 空スライスに変更 | 小規模 |

---

## 2. Critical Issues（必ず対応）

### CRIT-01: `cleanupOldSessionLogs` — 削除カウンタロジックの論理的バグ

**ファイル:** `app_session_log.go` L87-L112  
**重要度:** 🔴 Critical  
**出典:** review-185831(CRIT-02)、review-184643(IMP-05)、review-184845(IMP-06確認済み扱い)

```go
deleted := 0
for _, name := range logFiles {
    if deleted >= excess {
        break
    }
    if name == currentFile {
        continue  // ← deleted をインクリメントせずにスキップ
    }
    // ... os.Remove ...
    deleted++
}
```

`excess = len(logFiles) - sessionLogMaxFiles` は current を含む総数で計算される。  
current をスキップしても `excess` 個削除されてしまうため、currentを除外した論理ファイル数でexcessを再計算するか、currentスキップ時にexcessをデクリメントする必要がある。

**修正案:**
```go
// current を除いてから excess を計算する、または
// スキップ時に excess を1減らす
if name == currentFile {
    excess--  // current は対象外のため削除上限を調整
    continue
}
```

**確認事項:** テスト `TestCleanupOldSessionLogs_PreservesCurrentFile` で実際の動作を確認・検証すること。

---

### CRIT-02: `errorLogStore.ts` — バックエンド再起動後のバッジが出ない（`lastReadSeq` のリセット不正）

**ファイル:** `frontend/src/stores/errorLogStore.ts`  
**重要度:** 🔴 Critical（仕様の意図確認が必要）  
**出典:** review-184719(D-1)、review-184643(IMP-04)、review-185831(IMP-04)

```typescript
// 現状コード
if (maxNewSeq > 0 && maxNewSeq < lastReadSeq) {
    lastReadSeq = maxNewSeq;  // コメントは "clear read marker" だが実際はmaxNewSeqにリセット
}
```

`lastReadSeq = maxNewSeq` にすると全エントリが既読扱いになりバッジが出ない可能性がある。  
コメントとコードの意図が矛盾している。

**2択で意図を確定すること:**
- **「再起動後エントリを未読にしたい」→** `lastReadSeq = 0` に変更
- **「全既読扱い（初回と同様）」→** コメントを `"treat as already read (same as first-load)"` に修正

---

### CRIT-03: `models.ts` — `SessionLogEntry` の `seq=0` / `seq` なし旧データが消える

**ファイル:** `frontend/wailsjs/go/models.ts`, `frontend/src/stores/errorLogStore.ts`  
**重要度:** 🔴 Critical（後方互換性）  
**出典:** review-185831(CRIT-03)

既存のJSONLファイルには `seq` フィールドがないため、読み込み時に `seq=undefined` → `isValidSeq` で `false` → フィルタリング除外される。既存ログが再起動後に表示されなくなる。

**修正案（どちらか選択）:**
```typescript
// 案1: isValidSeq を seq >= 0 に緩和（0 = レガシー）
function isValidSeq(seq: number): boolean {
    return typeof seq === "number" && Number.isFinite(seq) && seq >= 0;
}

// 案2: models.ts でデフォルト値を明示（Wails再生成時に消える点を考慮）
this.seq = source["seq"] ?? 0;
```

---

### CRIT-04: `isFreshRepoStatusOutput` — gitコマンドのロケール依存バグ

**ファイル:** `app_devpanel_api.go`（`detectFreshRepoState`）  
**重要度:** 🔴 Critical  
**出典:** review-185329(Category C)、review-184845(SUG-03)

```go
return strings.HasPrefix(line, "## No commits yet on ") ||
    strings.HasPrefix(line, "## Initial commit on ")
```

ユーザーの `LANG=ja_JP.UTF-8` 等の設定でgitが日本語出力する場合、判定が常に `false` になる。

**修正案:** `RunGitCLIPublic` 呼び出し時に `LC_ALL=C` を環境変数として注入する:
```go
// git status 呼び出し時に LC_ALL=C を指定
```

---

## 3. Important Issues（修正推奨）

### IMP-01: `buildUntrackedFileDiffsWithBudget` — `remainingBudget <= 0` チェックの漏れ

**ファイル:** `app_devpanel_api.go` L353  
**出典:** review-184845(CRIT-01)

```go
// 現状（問題あり）
if remainingBudget == 0 {
    budgetExceeded = true
    return fs.SkipAll
}
// 修正
if remainingBudget <= 0 {
    budgetExceeded = true
    return fs.SkipAll
}
```

直前のファイルでremainingBudgetが負になった場合、次イテレーションで `== 0` にならずさらにファイルが処理され、devPanelMaxDiffSize をわずかに超過する可能性がある。

---

### IMP-02: `parseDiffHeaderPaths` — パスに `" b/"` を含む場合の誤パース（テスト不足）

**ファイル:** `app_devpanel_api.go` L649-L684, `app_devpanel_api_test.go`  
**出典:** review-184600(IMP-01)、review-184845(IMP-01)、review-185831(IMP-01)

フォールバック分岐 `strings.Index(header, " b/")` は、パス自体に ` b/` を含む場合に誤った分割を行う可能性がある（リネーム時は `rename from/to` で上書きされるため結果は正しいが、`parseDiffHeaderPaths` 単体の動作は誤り）。

**推奨:** `parseDiffHeaderPaths` の単体テスト `TestParseDiffHeaderPaths` を追加してエッジケースを文書化する。

---

### IMP-03: `decodeGitPathLiteral` — `strconv.Unquote` と Git の octal escape の非互換

**ファイル:** `app_devpanel_api.go` L745-L762  
**出典:** review-184845(IMP-02)

Git は3桁のoctal escape（`\146`=`f`）を使用するが、Go の `strconv.Unquote` は octal エスケープをサポートしていない（`\x`/`\u`/`\U` のみ）。実際の `git diff` 出力でoctalエスケープが使われた場合に失敗する可能性がある。

**推奨:** Git のoctalエスケープを独自デコードするか、`strconv.Unquote` の制約をコメントで明文化する。

---

### IMP-04: `handler_test.go` — `writePipe` の二重クローズ

**ファイル:** `internal/sessionlog/handler_test.go`  
**出典:** review-184719(A-1)

```go
_ = writePipe.Close()                          // テスト本体でClose
t.Cleanup(func() { _ = writePipe.Close() })    // Cleanupでも再度Close
```

`t.Cleanup` 内の `writePipe.Close()` を削除すること。

---

### IMP-05: `DevPanelGitLog` — HEAD ref 検出の誤検知リスク

**ファイル:** `app_devpanel_api.go`  
**出典:** review-184719(A-2)

```go
// 現状（誤検知あり: "tag: v1.0-HEAD" など）
if strings.Contains(fields[6], "HEAD") {
// 修正案（単語境界で判定）
isHeadAttached := strings.Contains(fields[6], "HEAD -> ") ||
    fields[6] == "HEAD" ||
    strings.HasSuffix(fields[6], ",HEAD") ||
    strings.HasSuffix(fields[6], ", HEAD")
```

---

### IMP-06: `app_lifecycle.go` — `[shim]` ログプレフィックスが小文字で不統一

**ファイル:** `app_lifecycle.go`  
**出典:** review-184719(B-1)

同ファイル内の他プレフィックス（`[CONFIG]`, `[HOTKEY]`, `[IPC]`）はすべて大文字だが `[shim]` のみ小文字。

**修正:** `[shim]` → `[SHIM]` に統一する（1行変更）。

---

### IMP-07: `[DEBUG-SPLIT]` / `[DEBUG-SESSION]` — ログプレフィックスの統一漏れ

**ファイル:** `command_router_handlers_pane.go`, `command_router_handlers_session.go`  
**出典:** review-184600(SUG-09)、review-184643(SUG-01)

- `command_router_handlers_pane.go` L72,97: `[DEBUG-SPLIT]` が残存
- `command_router_handlers_session.go` L8: `[DEBUG-SESSION]` が残存（一部レビューで指摘）

**修正:** `[DEBUG-SPLIT]` → `[SPLIT]` または `[PANE]`、`[DEBUG-SESSION]` → `[SESSION]` に統一する。

---

### IMP-08: `injectTestWindow` — `markTopologyMutationLocked()` 未呼出し

**ファイル:** `internal/tmux/command_router_test_helpers_test.go`  
**出典:** review-184719(C-1)

`injectTestWindow` が `session.Windows = append(...)` と `manager.panes[pane.ID] = pane` を行うが `markTopologyMutationLocked()` を呼ばないため、`generation` / `topologyGeneration` が実態と乖離する。

**修正案:**
```go
session.Windows = append(session.Windows, window)
manager.panes[pane.ID] = pane
manager.markTopologyMutationLocked()  // keep generation in sync
```
または意図的スキップをコメントで明示する。

---

### IMP-09: `ErrorLogView.tsx` — `useLayoutEffect` でストア更新は不適切

**ファイル:** `frontend/src/components/viewer/views/error-log/ErrorLogView.tsx`  
**出典:** review-184719(D-2)

`markAllRead()` はDOM操作を行わないストア状態更新なのに `useLayoutEffect` を使用。React公式は `useLayoutEffect` をDOM読み書きに限定することを推奨。Strict Modeでは二重実行される。

**修正:** `useLayoutEffect` → `useEffect` に変更。

---

### IMP-10: `useBackendSync.ts` — `errorLogRetryTimer` のクリア漏れ

**ファイル:** `frontend/src/hooks/useBackendSync.ts`  
**出典:** review-185309(1-1)

`app:session-log-updated` 受信時、`errorLogDebounceTimer` はクリアされているが `errorLogRetryTimer` がクリアされていない。イベントが連続発生しつつAPIエラーが重なると重複リトライタイマーが蓄積し、多重リクエストが発生する。

**修正案:** イベント受信直後に `clearTimeout(errorLogRetryTimer); errorLogRetryTimer = null;` を追加する。

---

### IMP-11: `DiffContentViewer.tsx` — 仮想化なしの大量行レンダリング

**ファイル:** `frontend/src/components/viewer/views/diff-view/DiffContentViewer.tsx`  
**出典:** review-184719(E-1)

`DiffFileSidebar.tsx` では `react-window` + `FixedSizeList` による仮想化が実装されているが、差分行のコンテンツ側は全行をDOMに展開している。依存関係ファイルなど数千行の変更がある場合にパフォーマンスが劣化する。

**修正:** `FixedSizeList` またはスクロール内仮想リスト実装を検討する。

---

### IMP-12: `DiffFileSidebar.tsx` — ARIA tree キーボードナビゲーション不足

**ファイル:** `frontend/src/components/viewer/views/diff-view/DiffFileSidebar.tsx`  
**出典:** review-184719(E-2)

`role="tree"` / `role="treeitem"` と `tabIndex={0}` が設定され Enter/Space は実装済みだが、ARIA tree spec が要求する `ArrowDown`/`ArrowUp`/`ArrowRight`/`ArrowLeft` キー対応がない。

---

### IMP-13: `viewer.css` — `.diff-expand-bar:hover` の `cursor: pointer` が誤解を招く

**ファイル:** `frontend/src/styles/viewer.css`  
**出典:** review-184719(E-3)

基本ルールで `cursor: default` が指定されているのに、`.diff-expand-bar:hover` で `cursor: pointer` に上書きしている。`title` 属性には「expansion is not available」と書かれておりクリックしても何も起きないためUXが誤解を招く。

**修正:** `:hover` の `cursor: pointer` を削除する。

---

### IMP-14: `test_diff_tree.js` — デバッグ用スクリプトがリポジトリに残存

**ファイル:** `myT-x/test_diff_tree.js`  
**出典:** review-184719(E-4)

`buildDiffTree` の動作確認用プロトタイプスクリプト。本番モジュールではないため `.gitignore` に追加するか削除すること。

---

### IMP-15: `ActivityStrip.tsx` — `subscribeRegistry` を利用していない

**ファイル:** `frontend/src/components/viewer/ActivityStrip.tsx`  
**出典:** review-184719(D-3)

`getRegisteredViews()` をモジュールレベルシングルトンから直接取得しているが、registry変更を自分でサブスクライブしていない。現在は `ViewerSystem` の `registryVersion` state更新で間接的に動作しているが、将来 `ActivityStrip` が `ViewerSystem` の外に移動した場合に無音で壊れる。

**修正案:** propsで `views` を受け取るか、`subscribeRegistry` で独立したreactivityを持たせる。

---

## 4. Suggestions（余裕があれば対応）

### SUG-01: `buildUntrackedFileDiffsWithBudget` — バジェット計算のコメント補強

**ファイル:** `app_devpanel_api.go`  
内側と外側のバジェット計算の設計意図がコードだけでは読み取りにくい。クロージャキャプチャとloopの関係をコメントで補強する。

---

### SUG-02: `collectUntrackedFiles` — `io.ReadAll` によるメモリスパイク対策

**ファイル:** `app_devpanel_api.go` L260付近  
`git ls-files --others -z` の結果を全量受け取った後 `strings.Split("\x00")` するため、untracked ファイルが大量の場合（node_modules 漏れ等）に数百MBのメモリスパイクが発生しうる。`bytes.IndexByte` ループで上限到達時に早期breakする最適化を検討する。

---

### SUG-03: `parseWorkingDiff` — hunkスコープ外の行カウント誤検知の軽減

**ファイル:** `app_devpanel_api.go` L597-L601  
`+`/`-` カウントが hunk header 以降のみに限定されていない。状態変数 `inHunk` を追加して `@@` 出現以降のみカウントする設計を検討する（現状の git diff 形式では実害はほぼない）。

---

### SUG-04: `WorkingDiffStatus` — 型エイリアスから defined type への将来移行パスをドキュメント化

**ファイル:** `app_devpanel_types.go` L26  
Wails TSバインディング互換性のための `type WorkingDiffStatus = string` は適切だが、将来Wailsがnamed typeをサポートした際の移行パスをコメントに追記する。

---

### SUG-05: `parseDiffHeaderPaths` — 変数名 `pathLen` を `halfLen` にリネームして可読性向上

**ファイル:** `app_devpanel_api.go` L649-L685  
対称性ヒューリスティックのロジックが変数名だけでは読み取りにくい。

---

### SUG-06: `buildUntrackedFileDiffSingle` — `cachedInfo` の variadic パラメータ

**ファイル:** `app_devpanel_api.go`  
`cachedInfo ...os.FileInfo` は最大1要素想定のvariadicで非標準。`*os.FileInfo`（nilableポインタ）パターンの方がAPIの意図が明確。

---

### SUG-07: `isFreshRepoStatusOutput` — テスト追加（`## Initial commit on` 等）

**ファイル:** `app_devpanel_api_test.go`  
境界ケースのテストを追加して、ロケール依存バグ（CRIT-04）の修正後の動作を保証する。

---

### SUG-08: `devPanelExcludedDirs` — 可変スライスで外部変更リスク

**ファイル:** `app_devpanel_api.go`  
```go
var devPanelExcludedDirs = []string{".git", "node_modules"}
```
`[...]string` 配列または関数で返すパターンに変更してテスト汚染リスクを排除する。

---

### SUG-09: `cleanupOldSessionLogs` — ファイル名フォーマット変更時のソート崩れ警告

**ファイル:** `app_session_log.go`  
`session-YYYYMMDD-HHMMSS-PID.jsonl` 形式の文字列ソートが日時順と一致する前提で動作しているが、将来のフォーマット変更時にソートが崩れる可能性がある。`sort.Strings` 付近にコメントで注意を残す。

---

### SUG-10: `useBackendSync.ts` — リトライ回数の定数化とコメント明記

**ファイル:** `frontend/src/hooks/useBackendSync.ts`  
```typescript
const ERROR_LOG_FETCH_MAX_RETRIES = 1;  // 最大2回試行（attempt >= 1 で停止）
if (attempt >= ERROR_LOG_FETCH_MAX_RETRIES) { return; }
```

---

### SUG-11: `useBackendSync.ts` — `clearAndNullTimer` ユーティリティ関数化

**ファイル:** `frontend/src/hooks/useBackendSync.ts`  
`clearTimeout` + `null` 代入パターンが複数箇所にある。ユーティリティ関数にまとめると保守性向上。

---

### SUG-12: `ErrorLogView.tsx` — クリーンアップ effect の冗長性

**ファイル:** `frontend/src/components/viewer/views/error-log/ErrorLogView.tsx` L94-L101  
callback ref は React がアンマウント時に `null` で呼び出すため、`bodyRefCallback` 側のクリーンアップで十分。`useEffect` のクリーンアップは冗長（ただし `removeEventListener` は冪等なので安全）。コメントで理由を明記する。

---

### SUG-13: `useErrorLog.ts` — `registerBodyElement` の依存配列への不要な含め

**ファイル:** `views/error-log/useErrorLog.ts`  
`registerBodyElement` は `useCallback([], [])` で安定参照のため、依存配列への追加は実質no-op。コメントで理由を明記するか除去する。

---

### SUG-14: `viewerRegistry.ts` — `resolveRegistryState` のローカル変数改善

**ファイル:** `frontend/src/components/viewer/viewerRegistry.ts`  
```typescript
// 現状（冗長）
globalObject[REGISTRY_KEY] = { plugins: [], listeners: new Set() };
return globalObject[REGISTRY_KEY] as RegistryState;
// 改善
const state: RegistryState = { plugins: [], listeners: new Set() };
globalObject[REGISTRY_KEY] = state;
return state;
```

---

### SUG-15: `ActivityStrip.tsx` — spacer 表示条件に `topViews.length > 0 &&` を追加

**ファイル:** `frontend/src/components/viewer/ActivityStrip.tsx`  
`bottomViews.length > 0` のみで spacer を表示する条件になっているため、`topViews.length === 0` でも spacer が先頭に表示される可能性がある。

---

### SUG-16: 各種テスト追加推奨

| テスト | ファイル | 内容 |
|---|---|---|
| `parseDiffHeaderPaths` 単体テスト | `app_devpanel_api_test.go` | 旧パスに ` b/` を含むエッジケース |
| nil スライス保証テスト | `app_session_log_test.go` | `GetSessionErrorLog()` が non-nil を返すことの確認 |
| 並行write Seq唯一性テスト | `app_session_log_test.go` | 複数goroutineからの同時呼び出し |
| `window-created` TODO コメント | `app_events_test.go` | emitter追加時のテストケース名更新案内 |
| split-window rollbackイベント漏れ | `command_router_handlers_pane_test.go` | ロールバック後にイベントが emit されないことの検証 |
| spec=="" ホットキーログテスト | `app_lifecycle_test.go` | 空スペック時のホットキーログ検証 |
| エラーログストア包括テスト | `frontend/tests/errorLogStore.test.ts` | markAllRead後のunreadCount確認、eviction、seq regress |

---

## 5. Positive Observations（評価点）

1. **ping + fetch モデル** (`app:session-log-updated`)：スロットリングによるデータ損失を構造的に排除する優れたアーキテクチャ変更。
2. **Seq フィールドの導入**：フロントエンドの deduplication が `ts|level|msg|source` の弱い複合キーから単調増加の `uint64 seq` に移行し安定化。
3. **パストラバーサル防止**：`buildUntrackedFileDiffSingleWithResolvedBase` の 5段階チェック（lexical guard → Lstat → symlink check → EvalSymlinks → post-resolution guard）は堅牢。
4. **TeeHandler のパニック回復**：`defer recover()` でコールバックのパニックが slog 全体を停止させない設計。ディスク障害時もUIへの通知が継続。
5. **ロールバックエラーの隠蔽**：`fmt.Errorf("%w (rollback failed: %v)", ...)` → `return errResp(originalErr)` に変更し、内部ロールバック詳細をクライアントに漏らさない。
6. **リングバッファの堅牢化**：`cap` → `bufCap` リネーム（組み込み関数シャドウ回避）、`capacity <= 0` のクランプ処理、`bufCap == 0` の防御。
7. **ViewerRegistry の HMR 対応**：`Symbol.for` + `subscribeRegistry` パターンで HMR 時のビュー再登録が安全に処理される。
8. **テストカバレッジの充実**：`TestParseWorkingDiff`、`TestBuildUntrackedFileDiffs`、`TestDetectFreshRepoState` 等、新規追加コードへの包括的テーブル駆動テスト。
9. **フィールドカウントガードテスト**：`TestWorkingDiffFileFieldCountGuard` / `TestWorkingDiffResultFieldCountGuard` によるフロントエンド同期チェック。
10. **initSessionLog の排他制御強化**：`sessionLogFile`/`sessionLogPath` の書き込みをロック内に移動し競合を排除。

---

## 6. 本番コード確認による追加レビュー（影響範囲分析）

| 変更箇所 | 影響範囲 | 状態 |
|---|---|---|
| `app:error-logged` → `app:session-log-updated` | フロントエンドのイベントリスナー | ✅ 全て変更済み |
| `SessionLogEntry` に `Seq` フィールド追加 | Wails models.ts, errorLogStore | ✅ 全て変更済み |
| `DevPanelWorkingDiff` API 追加 | api.ts, App.d.ts, App.js | ✅ 全て変更済み |
| `addEntry` 削除 → `setEntries` 一本化 | errorLogStore 消費元 | ✅ useBackendSync で一本化済み |
| ロールバック時のエラー隠蔽 | session/pane/window handler | ✅ 3箇所全て変更済み |
| `[DEBUG-*]` プレフィックス変更 | テストコードのログ検証 | ⚠️ 一部残存あり（IMP-06,07） |
| `TeeHandler.Handle` — base error時もcallback実行 | sessionlog callback | ✅ テスト追加済み |
| `tmux:window-created` ポリシー追加 | 現在emitコードなし | ✅ 将来対応への準備として適切 |

---

## 7. 並列作業テーブル

作業者目線でのタスク一覧です。各タスクが他のタスクと並列で作業可能かどうかを示します。

### 7.1 Critical/Important タスク

| # | タスクID | 対象ファイル | 内容 | 優先度 | 並列作業 | 備考 |
|---|---|---|---|---|---|---|
| 1 | CRIT-01 | `app_session_log.go` | cleanupOldSessionLogs 削除カウンタ修正 | 🔴 必須 | ✅ 可 | 独立ファイル |
| 2 | CRIT-02 | `errorLogStore.ts` | lastReadSeq リセット方針の確定・修正 | 🔴 必須 | ✅ 可 | 仕様確認が先決 |
| 3 | CRIT-03 | `errorLogStore.ts`, `models.ts` | seq=0/undefined の旧データ扱い修正 | 🔴 必須 | ⚠️ 条件付き | CRIT-02と同ファイル。まとめて担当推奨 |
| 4 | CRIT-04 | `app_devpanel_api.go` | git コマンドへ LC_ALL=C 注入 | 🔴 必須 | ⚠️ 条件付き | IMP-01,02と同ファイル |
| 5 | IMP-01 | `app_devpanel_api.go` | remainingBudget <= 0 チェック修正 | 🟠 推奨 | ⚠️ 条件付き | CRIT-04と同ファイル |
| 6 | IMP-02 | `app_devpanel_api.go`, `_test.go` | parseDiffHeaderPaths 単体テスト追加 | 🟠 推奨 | ⚠️ 条件付き | CRIT-04と同ファイル |
| 7 | IMP-03 | `app_devpanel_api.go` | strconv.Unquote と octal escape の互換性確認 | 🟠 推奨 | ⚠️ 条件付き | 同ファイル群 |
| 8 | IMP-04 | `handler_test.go` | writePipe 二重クローズ修正 | 🟠 推奨 | ✅ 可 | テスト独立 |
| 9 | IMP-05 | `app_devpanel_api.go` | HEAD ref 検出の word-boundary 修正 | 🟠 推奨 | ⚠️ 条件付き | 同ファイル群 |
| 10 | IMP-06 | `app_lifecycle.go` | `[shim]` → `[SHIM]` 大文字統一 | 🟠 推奨 | ✅ 可 | 1行変更 |
| 11 | IMP-07 | `command_router_handlers_pane.go`, `_session.go` | `[DEBUG-SPLIT]`/`[DEBUG-SESSION]` プレフィックス統一漏れ修正 | 🟠 推奨 | ✅ 可 | 独立ファイル |
| 12 | IMP-08 | `command_router_test_helpers_test.go` | injectTestWindow に markTopologyMutationLocked() 追加 | 🟠 推奨 | ✅ 可 | テスト独立 |
| 13 | IMP-09 | `ErrorLogView.tsx` | useLayoutEffect → useEffect 変更 | 🟠 推奨 | ✅ 可 | フロントエンド独立 |
| 14 | IMP-10 | `useBackendSync.ts` | errorLogRetryTimer クリア漏れ修正 | 🟠 推奨 | ✅ 可 | フロントエンド独立 |
| 15 | IMP-11 | `DiffContentViewer.tsx` | 仮想化（react-window）実装 | 🟠 推奨 | ✅ 可 | 大規模変更 |
| 16 | IMP-12 | `DiffFileSidebar.tsx` | ARIA キーボードナビゲーション実装 | 🟠 推奨 | ✅ 可 | アクセシビリティ |
| 17 | IMP-13 | `viewer.css` | `.diff-expand-bar:hover` の cursor: pointer 削除 | 🟠 推奨 | ✅ 可 | 1行変更 |
| 18 | IMP-14 | `test_diff_tree.js` | デバッグスクリプト削除 or .gitignore 追加 | 🟠 推奨 | ✅ 可 | 独立 |
| 19 | IMP-15 | `ActivityStrip.tsx` | subscribeRegistry で独立 reactivity 実現 | 🟠 推奨 | ⚠️ SUG-15と関連 | |

### 7.2 Suggestion タスク

| # | タスクID | 対象ファイル | 内容 | 優先度 | 並列作業 | 備考 |
|---|---|---|---|---|---|---|
| 20 | SUG-01 | `app_devpanel_api.go` | バジェット計算のコメント補強 | 🟡 任意 | ⚠️ 条件付き | CRIT-04等と同ファイル |
| 21 | SUG-02 | `app_devpanel_api.go` | collectUntrackedFiles メモリスパイク対策 | 🟡 任意 | ⚠️ 条件付き | 同ファイル群 |
| 22 | SUG-03 | `app_devpanel_api.go` | parseWorkingDiff hunkスコープカウント改善 | 🟡 任意 | ⚠️ 条件付き | 同ファイル群 |
| 23 | SUG-04 | `app_devpanel_types.go` | WorkingDiffStatus 型エイリアス将来パスをコメント追記 | 🟡 任意 | ✅ 可 | コメントのみ |
| 24 | SUG-05 | `app_devpanel_api.go` | parseDiffHeaderPaths 変数名改善 | 🟡 任意 | ⚠️ 条件付き | 同ファイル群 |
| 25 | SUG-06 | `app_devpanel_api.go` | cachedInfo variadic → ポインタ引数への変更検討 | 🟡 任意 | ⚠️ 条件付き | 同ファイル群 |
| 26 | SUG-07 | `app_devpanel_api_test.go` | 各種テスト追加（parseDiffHeaderPaths等） | 🟡 任意 | ✅ 可 | テストのみ |
| 27 | SUG-08 | `app_devpanel_api.go` | devPanelExcludedDirs を配列/関数化 | 🟡 任意 | ⚠️ 条件付き | 同ファイル群 |
| 28 | SUG-09 | `app_session_log.go` | ファイル名フォーマット変更時の警告コメント追記 | 🟡 任意 | ✅ 可 | コメントのみ |
| 29 | SUG-10 | `useBackendSync.ts` | リトライ回数の定数化 | 🟡 任意 | ✅ 可 | フロントエンド独立 |
| 30 | SUG-11 | `useBackendSync.ts` | clearAndNullTimer ユーティリティ化 | 🟡 任意 | ✅ 可 | フロントエンド独立 |
| 31 | SUG-12 | `ErrorLogView.tsx` | 冗長クリーンアップ effect にコメント追記 | 🟡 任意 | ✅ 可 | フロントエンド独立 |
| 32 | SUG-13 | `useErrorLog.ts` | registerBodyElement 依存配列コメント追記 | 🟡 任意 | ✅ 可 | フロントエンド独立 |
| 33 | SUG-14 | `viewerRegistry.ts` | resolveRegistryState ローカル変数改善 | 🟡 任意 | ✅ 可 | フロントエンド独立 |
| 34 | SUG-15 | `ActivityStrip.tsx` | spacer 表示条件 topViews.length > 0 && 追加 | 🟡 任意 | ✅ 可 | フロントエンド独立 |
| 35 | SUG-16 | 各テストファイル | 各種テスト追加（詳細は §4 参照） | 🟡 任意 | ✅ 可 | テストのみ |

---

## 8. 並列作業グループ（推奨分担）

作業効率を最大化するためのグループ化案です。

```
■ Group 1: Go バックエンド DevPanel API（順次実施が必要）
  担当ファイル: app_devpanel_api.go / app_devpanel_api_test.go
  タスク: CRIT-04 → IMP-01 → IMP-02 → IMP-03 → IMP-05
         → SUG-01〜06,08 (まとめて1人で担当)
  ※ 同一ファイルを修正するため必ず順次実施

■ Group 2: Go バックエンド SessionLog（並列可）
  担当ファイル: app_session_log.go
  タスク: CRIT-01, SUG-09
  ※ Group 1と完全に独立して並列作業可能

■ Group 3: Go バックエンド その他（並列可）
  担当ファイル: app_lifecycle.go, handler_test.go
  タスク: IMP-04, IMP-06
  ※ 全グループと並列作業可能

■ Group 4: Tmux 内部実装（並列可）
  担当ファイル: command_router_handlers_pane.go, _session.go, test_helpers_test.go
  タスク: IMP-07, IMP-08
  ※ 全グループと並列作業可能

■ Group 5: フロントエンド Store・Hooks（順次注意）
  担当ファイル: errorLogStore.ts, models.ts, useBackendSync.ts
  タスク: CRIT-02, CRIT-03（同ファイルのためまとめて担当）, IMP-10, SUG-10, SUG-11
  ※ CRIT-02とCRIT-03は同ファイルのためまとめて1人で担当推奨

■ Group 6: フロントエンド View・コンポーネント（並列可）
  担当ファイル: ErrorLogView.tsx, useErrorLog.ts, ActivityStrip.tsx
  タスク: IMP-09, IMP-15, SUG-12, SUG-13, SUG-15
  ※ Group 5と並列作業可能

■ Group 7: diff-view 新機能（並列可）
  担当ファイル: DiffContentViewer.tsx, DiffFileSidebar.tsx, viewer.css
  タスク: IMP-11, IMP-12, IMP-13
  ※ 全グループと並列作業可能

■ Group 8: その他・クリーンアップ（並列可）
  担当ファイル: test_diff_tree.js, viewerRegistry.ts, ViewerSystem.tsx
  タスク: IMP-14, SUG-14
  ※ 全グループと並列作業可能
```

### 並列可否の凡例

| 記号 | 意味 |
|---|---|
| ✅ 可 | 他のタスクと完全に独立して作業可能。先に着手してOK |
| ⚠️ 条件付き | 同一ファイルを修正するため、同グループ内は順次実施推奨。他グループとは並列OK |
| ❌ 不可 | 前提タスクの完了を待つ必要あり（今回は該当なし） |

### 推奨作業フロー

```
フェーズ1（並列）: Group 1〜8 を同時スタート
                  ただし Group 1 内部は CRIT-04 → IMP-01 → IMP-02 → ... の順を守る
                  Group 5 内部は CRIT-02 + CRIT-03 をまとめて着手

フェーズ2: 各グループの修正後、結合テスト実施
           「Ping+Fetch」シナリオ（Ping受信→fetchErrorLog→UI表示）の動作確認
           seq regress（バックエンド再起動）シナリオの動作確認
```
