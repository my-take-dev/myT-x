# PR Review Summary

**レビュー日時:** 2026-02-23 19:33:18  
**対象差分ファイル数:** 28  
**レビュー方針:** review-pr-para.prompt.md 準拠  
**CLAUDE.md準拠:** 確認済み

---

## カテゴリ分類

| カテゴリ | 対象ファイル |
|---------|------------|
| A. バックエンド: Input History 機能 | `app.go`, `app_lifecycle.go`, `app_pane_api.go` (差分のみ。本体 `app_input_history.go`, `app_input_history_types.go`, `app_input_history_test.go` は新規追加で差分外) |
| B. バックエンド: Frontend Event Logging | `app_session_log.go`, `app_session_log_test.go` |
| C. バックエンド: Go言語モダン化 (go fix) | `app_devpanel_api.go`, `app_session_log_test.go` (一部), `internal/testutil/helpers.go`, `app_session_api_test.go`, `command_router_env_test.go`, `command_router_handlers_window_test.go` |
| D. バックエンド: Config / ViewerShortcuts | `internal/config/config.go`, `internal/config/config_test.go`, `config.yaml` |
| E. フロントエンド: Input History 機能 | `api.ts`, `inputHistoryStore.ts` (新規), `ActivityStrip.tsx`, `useBackendSync.ts` (input history 部分) |
| F. フロントエンド: Viewer Shortcuts 設定 | `ViewerSystem.tsx`, `viewerRegistry.ts`, `ActivityStrip.tsx`, `SettingsModal.tsx`, `KeybindSettings.tsx`, `settingsReducer.ts`, `settingsValidation.ts`, `types.ts`, `ViewerShortcutSettings.tsx` (新規) |
| G. フロントエンド: エラーハンドリング | `main.tsx`, `ErrorBoundary.tsx` (新規) |
| H. フロントエンド: バックエンド同期追加 | `useBackendSync.ts` (LogFrontendEvent 呼び出し部分) |
| I. Wails 自動生成 / 型定義 | `App.d.ts`, `App.js`, `models.ts`, `types/tmux.ts` |

---

## Critical Issues (3件)

### C-1 [code-reviewer]: `new(true)` / `new(false)` はGo 1.26ではコンパイルエラーの可能性

**ファイル:** `app_session_api_test.go`, `command_router_env_test.go`, `command_router_handlers_window_test.go`, `internal/testutil/helpers.go`

**概要:** `testutil.Ptr(true)` → `new(true)` への置換が行われているが、Go標準の `new` 組み込み関数は **型** を引数に取る (`new(T)`)。`new(true)` はリテラル値 `true` を型として解釈できず、**コンパイルエラーになる**。

Go 1.26 で `new(value)` の構文が新しく導入された可能性があるが、公式仕様では `new` はゼロ値を持つ型のポインタを返すのみ。`go fix` による自動変換結果を検証する必要がある。

**対象箇所:**
- `app_session_api_test.go`: L9-12, L21, L30, L39, L48, L55-57 (計7箇所)
- `command_router_env_test.go`: L19, L26, L36-37, L47-48, L57, L67-68, L78-79, L89-90, L100-101 (計14箇所)
- `command_router_handlers_window_test.go`: L18, L27 (計2箇所)
- `internal/testutil/helpers.go`: L12 (`func Ptr[T any](v T) *T { return new(v) }`)

**リスク:** ビルド失敗

**推奨対応:** Go 1.26 で実際に `new(value)` が有効な構文かどうか確認し、無効であれば元の `testutil.Ptr(true)` に戻す。`//go:fix inline` ディレクティブも同様に確認が必要。

---

### C-2 [silent-failure-hunter]: `app_pane_api.go` — `recordInput` のエラー有無にかかわらず SendInput が成功を返す

**ファイル:** `app_pane_api.go` L42-43, L57-58

**概要:** `recordInput` は戻り値を返さない (void) が、内部でファイル書き込みエラーが発生した場合にも `SendInput` / `SendSyncInput` は成功応答を返す。CLAUDE.md の仕様「tmux-shimについて: エラーはログにだけ出力しておくこと」に従っている可能性はあるが、**入力履歴がサイレントに失われるリスク**がある。

**リスク:** ユーザーの入力履歴が知らないうちに欠落する

**推奨対応:** 現在の `recordInput` 内で `fmt.Fprintf(os.Stderr, ...)` でエラーが出力されていることを確認済み。CLAUDE.md仕様「エラーで動作を止めない」に合致しているため、**設計上は意図通り**。ただし、ファイルI/Oエラーが継続する場合の再試行/通知メカニズムの検討を推奨。

---

### C-3 [code-reviewer]: `settingsValidation.ts` — import の配置が不適切

**ファイル:** `frontend/src/components/settings/settingsValidation.ts` L37

**概要:** `validateViewerShortcuts` 関数と `VIEWER_VIEW_IDS` 定数がファイルの先頭（L2-36）に追加されているが、既存の `import` 文（L37: `import {EFFORT_LEVEL_KEY, ...} from "./constants"`）の **前** に配置されている。TypeScriptの慣例として、import文はファイルの最上部にまとめるべき。

```diff
+ // 新規追加コードがimportの前に配置されている
+ const VIEWER_VIEW_IDS = [...]
+ export function validateViewerShortcuts(...) { ... }
  import {EFFORT_LEVEL_KEY, ...} from "./constants"; // ← 既存のimportがvalidateViewerShortcutsの後
```

**リスク:** 可読性の問題。ESLintの `import/first` ルールに違反する可能性。

**推奨対応:** `VIEWER_VIEW_IDS` と `validateViewerShortcuts` を既存のimport文の **後** に移動する。

---

## Important Issues (8件)

### I-1 [code-reviewer]: Input History のシャットダウン時のロック順序

**ファイル:** `app_lifecycle.go` L18-19（差分）、`app_input_history.go` L314-353

**概要:** `shutdown` で `flushAllLineBuffers()` → `closeInputHistory()` → `closeSessionLog()` の順で呼ばれている。`flushAllLineBuffers` は `inputLineBufMu` を取得し、ロック解放後に `writeInputHistoryEntry` を呼ぶ（`inputHistoryMu` 取得）。これは `app_input_history.go` L167 のコメント「Lock ordering: inputLineBufMu → (release) → inputHistoryMu」に準拠しており正しい。

ただし、`flushAllLineBuffers()` 実行中にタイマーコールバック (`flushLineBuffer`) が並行して実行される可能性がある。`flushAllLineBuffers` 内でタイマーを `Stop()` しているが、Stop が `false` を返した場合（既に発火済み）、別のgoroutineの `flushLineBuffer` がまだ完了していない可能性がある。

**リスク:** シャットダウン時のレースコンディション（低確率）

**推奨対応:** `flushAllLineBuffers` で `a.inputLineBuffers = nil` を設定した後、`flushLineBuffer` 側は `!exists || lb == nil` チェックで早期リターンするため実害は低い。ただし、`writeInputHistoryEntry` の呼び出しが `closeInputHistory` 完了後に発生する可能性は残るため、`closeInputHistory` 内の `a.inputHistoryFile = nil` チェックで書き込みはスキップされる設計であることを確認。**現在の実装は問題なし**だが、コメントにこの競合パターンの安全性を明記しておくことを推奨。

---

### I-2 [pr-test-analyzer]: `app_session_log_test.go` — `TestLogFrontendEvent_TruncatesLongInputs` のテスト漏れ

**ファイル:** `app_session_log_test.go` L141-206

**概要:** テストケースで msg と source の両方が制限を超えるケースがテストされていない。`msgRunes = frontendLogMaxMsgLen + 100` かつ `sourceRunes = frontendLogMaxSourceLen + 50` の同時超過ケースを追加すべき。

**リスク:** 同時切り捨て時の予期しない動作の検出漏れ

**推奨対応:** 以下のテストケースを追加:
```go
{
    name:         "both msg and source over limit",
    msgRunes:     frontendLogMaxMsgLen + 100,
    sourceRunes:  frontendLogMaxSourceLen + 50,
    expectMsgLen: frontendLogMaxMsgLen,
    expectSrcLen: frontendLogMaxSourceLen,
},
```

---

### I-3 [code-reviewer]: `useBackendSync.ts` — `LogFrontendEvent` 呼び出しの重複パターン

**ファイル:** `frontend/src/hooks/useBackendSync.ts` L235-241, L249-255, L263-269, L274-286, L480-486, L494-500, L508-515, L522-530

**概要:** `void api.LogFrontendEvent(...).catch(() => { ... })` のパターンが **8箇所** で繰り返されている。コメント文も全て同一（`// Silently discard: logging must not throw during error recovery.`）。DRY原則に反する。

**リスク:** 保守性の低下。将来ログ出力方法を変更する際に全箇所修正が必要。

**推奨対応:** ヘルパー関数を作成して共通化:
```typescript
function logFrontendEventSafe(level: string, msg: string, source: string): void {
    void api.LogFrontendEvent(level, msg, source).catch(() => {
        // Silently discard: logging must not throw during error recovery.
    });
}
```

---

### I-4 [code-reviewer]: `ViewerSystem.tsx` — ショートカットの衝突検出がない

**ファイル:** `frontend/src/components/viewer/ViewerSystem.tsx` L50-63

**概要:** `shortcutMap` は `Map<string, string>` で構築されるが、設定からのショートカットが重複した場合（例: 2つのビューに同じキーを割り当てた場合）、後から登録されたビューが前のビューを上書きし、先のビューのショートカットが機能しなくなる。

`settingsValidation.ts` の `validateViewerShortcuts` で保存時のバリデーションはあるが、**ランタイムでの衝突検出がない**（手動でconfig.yamlを編集した場合など）。

**リスク:** config.yaml手動編集時にショートカット衝突が発生しても無警告

**推奨対応:** `shortcutMap` 構築時に重複検出を追加し、`console.warn` で開発者へ通知:
```typescript
if (map.has(effectiveShortcut.toLowerCase())) {
    if (import.meta.env.DEV) {
        console.warn(`[viewer] duplicate shortcut "${effectiveShortcut}" for view "${view.id}"`);
    }
}
```

---

### I-5 [comment-analyzer]: `app_pane_api.go` — TODOコメントの追跡

**ファイル:** `app_pane_api.go` L9, L19

**概要:** 2箇所の同一TODOコメント `// TODO: populate session name from pane-to-session mapping when available.` が追加されている。session名が空文字で渡されており、InputHistoryEntry の session フィールドが常に空になる。

**リスク:** 入力履歴のセッション情報が欠落。将来のセッション別フィルタリング機能に影響。

**推奨対応:** TODOコメントをIssueトラッカーに登録し、追跡可能にする。当面は問題なし。

---

### I-6 [code-reviewer]: `settingsValidation.ts` — `VIEWER_VIEW_IDS` と `ViewerShortcutSettings.tsx` の `VIEWER_SHORTCUTS` の二重管理

**ファイル:** `settingsValidation.ts` L10-12, `ViewerShortcutSettings.tsx` L6-12

**概要:** ビューIDのリストが2箇所で管理されている:
- `settingsValidation.ts`: `VIEWER_VIEW_IDS = ["file-tree", "git-graph", "error-log", "diff", "input-history"]`
- `ViewerShortcutSettings.tsx`: `VIEWER_SHORTCUTS` 配列のviewIdフィールド

新しいビューを追加する際に両方を更新する必要があり、片方の更新漏れが発生するリスクがある。

**リスク:** ビュー追加時の更新漏れ

**推奨対応:** 共通の定数を1箇所で定義し、両ファイルからインポートする。SYNCコメントが両ファイルにあるのは良い対策だが、共通化した方がより安全。

---

### I-7 [type-design-analyzer]: `models.ts` — `InputHistoryEntry` と `inputHistoryStore.ts` の型定義の重複

**ファイル:** `frontend/wailsjs/go/models.ts` L25-46, `frontend/src/stores/inputHistoryStore.ts` L3-11

**概要:** `InputHistoryEntry` の型が2箇所で定義されている：
- `models.ts` (Wails自動生成): クラスとして定義
- `inputHistoryStore.ts`: インターフェースとして定義

フィールドは一致しているが、将来バックエンド側にフィールドを追加した場合、`inputHistoryStore.ts` 側の更新を忘れるリスクがある。

**リスク:** バックエンドとフロントエンドの型不整合

**推奨対応:** `inputHistoryStore.ts` で Wails自動生成の `main.InputHistoryEntry` をインポートするか、少なくとも `// SYNC: Must match main.InputHistoryEntry in models.ts` のようなコメントを追加。ただし、errorLogStore.ts も同様のパターン（独自インターフェース定義）を使用しているため、プロジェクト全体の方針として一貫性がある。

---

### I-8 [code-reviewer]: `app.go` — `inputLineBuffers` の遅延初期化と `NewApp()` での初期化の不一致

**ファイル:** `app.go` L32（差分: `inputLineBuffers map[string]*inputLineBuffer`）、`app_input_history.go` L183-185

**概要:** `NewApp()` では `inputLineBuffers` が初期化されておらず（nil）、`recordInput` 内で遅延初期化されている（L183-185）。他のマップフィールド（`snapshotCache`）は `NewApp()` で初期化されている。

CLAUDE.md の `defensive-coding-checklist` に従い、nilマップへのread操作はpanicしないが、遅延初期化パターンは `recordInput` が呼ばれる前に `flushAllLineBuffers` が呼ばれた場合に `nil` チェックが必要（L316: 実装済み）。

**リスク:** 低（既にnilチェック実装済み）

**推奨対応:** `NewApp()` で `inputLineBuffers: make(map[string]*inputLineBuffer)` を追加する方が一貫性がある。ただし、現在の実装で機能的な問題はない。

---

## Suggestions (7件)

### S-1 [code-simplifier]: `useBackendSync.ts` — Input History と Error Log の共通パターン抽出

**ファイル:** `frontend/src/hooks/useBackendSync.ts`

**概要:** Input History の fetch/debounce/retry ロジック（L139-197）は Error Log のパターン（差分外の既存コード）とほぼ同一。debounceタイマー、fetchSeq、retryロジックが完全に重複している。

**推奨:** 共通のfetchWithDebounce/retryユーティリティを抽出することで、将来の類似パターン追加時の保守性が向上する。

---

### S-2 [code-simplifier]: `ActivityStrip.tsx` — バッジ表示のハードコード

**ファイル:** `frontend/src/components/viewer/ActivityStrip.tsx` L37-42

**概要:** `error-log` と `input-history` のバッジ（未読マーク）表示が個別にハードコードされている。今後バッジ付きビューが増える場合、各ビューにバッジプロバイダーを指定する拡張性のある設計が望ましい。

```tsx
// 現在: ハードコード
{view.id === "error-log" && unreadCount > 0 && (<span className="viewer-strip-badge" />)}
{view.id === "input-history" && inputHistoryUnreadCount > 0 && (<span className="viewer-strip-badge" />)}
```

**推奨:** ViewPlugin インターフェースに `badgeCount?: () => number` のようなファクトリを追加し、一般化する。

---

### S-3 [comment-analyzer]: `ViewerSystem.tsx` — サイドバー配置ルールのコメントが優れている

**ファイル:** `frontend/src/components/viewer/ViewerSystem.tsx` L22-27

**概要:** サイドバーアイコンの配置ルールが明確にコメントで記載されており、今後のメンテナーにとって非常に有用。

---

### S-4 [code-reviewer]: `main.tsx` — `container!` の非nullアサーションから明示的チェックへの改善

**ファイル:** `frontend/src/main.tsx` L44-47

**概要:** `container!` (非nullアサーション) から明示的な `if (!container) throw` パターンへの変更は防御的コーディングの良い実践。

---

### S-5 [code-reviewer]: `config.yaml` — ViewerShortcuts のコメント付きデフォルト設定

**ファイル:** `config.yaml` L9-16

**概要:** コメントアウトされたデフォルト値の記載は、ユーザーが設定を追加する際の参考として適切。CLAUDE.md の「yamlへの設定事項追加時の動作」仕様に準拠。

---

### S-6 [code-reviewer]: `app_devpanel_api.go` — `strings.SplitSeq` と `strings.CutPrefix` への移行

**ファイル:** `app_devpanel_api.go` L10, L20-28

**概要:** `strings.Split` → `strings.SplitSeq`、`strings.HasPrefix + TrimPrefix` → `strings.CutPrefix` への変更は Go言語のモダン化として適切。`SplitSeq` はイテレータベースで、大きな文字列のメモリ効率が向上する。`CutPrefix` は冗長な二重プレフィックス確認を排除する。

---

### S-7 [pr-test-analyzer]: `config_test.go` — テストカバレッジが十分

**ファイル:** `internal/config/config_test.go` L10-119

**概要:** `ViewerShortcuts` に対して以下のテストが網羅されている：
- フィールドカウントガード更新 (11→12)
- `isZeroConfig` テストケース追加
- Load テスト (nil / 設定あり)
- Clone テスト (nil / ディープコピー / 独立性)
- Save → Load ラウンドトリップ

CLAUDE.md の テスト方針に準拠。

---

## Strengths (良い点)

1. **Input History のアーキテクチャが session log と一貫している**: リングバッファ、JSONL ファイル、ping+fetch モデル、throttling すべてが session log と同じパターンを踏襲しており、保守性が高い。

2. **ロック設計が明確にドキュメント化されている**: `app.go` のロックコメントが `inputHistoryMu`, `inputLineBufMu` を追加し、ロック順序が明記されている。デッドロック防止の設計意図が明確。

3. **ErrorBoundary + グローバルエラーハンドラの導入**: `main.tsx` の `window.addEventListener("error"/"unhandledrejection")` と `ErrorBoundary` コンポーネントの組み合わせにより、フロントエンドの未処理エラーがバックエンドの session log に記録される。デバッグ効率が大幅に向上する。

4. **HMR対応のグローバルハンドラ登録**: `Symbol.for("mytx.global.error.handlers")` を使用して HMR によるリスナーの二重登録を防止している設計は秀逸。

5. **frontier event の入力サニタイゼーション**: `LogFrontendEvent` でレベルの正規化、メッセージ/ソースのトリム&rune制限、空メッセージの無視が適切に実装されている。

6. **processInputString のエスケープシーケンス除去が堅牢**: CSI, OSC, SS3 各種ターミナルシーケンスの除去ロジックが包括的に実装されており、テストケースも豊富。

7. **ViewerShortcuts のバリデーション**: 設定画面でのショートカット重複検出が実装されている（`validateViewerShortcuts`）。

8. **テストの充実**: 新機能に対して十分なテストが書かれており、境界値テスト、マルチバイト文字テスト、独立性テストなど品質が高い。

---

## Recommended Action

1. **C-1 を最優先で確認**: `new(true)` の構文がGo 1.26で有効かどうか検証。無効であればビルドが通らない。
2. **C-3 を修正**: `settingsValidation.ts` の import 順序を修正。
3. **I-2, I-3, I-4, I-6 を対応**: テストケース追加、コード共通化、衝突検出追加。
4. **S-1, S-2 は今後の開発で検討**: リファクタリングタスクとして記録。
5. 修正後、レビューを再実行して問題が解消されていることを確認。

---

## 並列作業可否テーブル

以下の表は、各レビュー指摘事項を修正する際に **並列で作業可能か** を示しています。

| タスクID | 分類 | 内容（概要） | 対象ファイル | 並列作業 | 備考 |
|----------|------|------------|------------|:--------:|------|
| C-1 | Critical | `new(true)` 構文の確認・修正 | `app_session_api_test.go`, `command_router_env_test.go`, `command_router_handlers_window_test.go`, `internal/testutil/helpers.go` | ⚠️ 条件付き | `helpers.go` の `Ptr` 関数本体の変更が他テストファイルに影響する。`helpers.go` を先に修正し、テストファイルは並列修正可能。ただし `helpers.go` を変更しない場合（`new(true)` がGo 1.26で有効な場合）はそもそも修正不要。|
| C-2 | Critical | `recordInput` のサイレントエラー確認 | `app_pane_api.go` | ✅ 可 | 他タスクと独立。設計確認のみで変更不要の可能性あり。 |
| C-3 | Critical | `settingsValidation.ts` の import 順序修正 | `settingsValidation.ts` | ✅ 可 | 他ファイルに依存しない単体修正。 |
| I-1 | Important | シャットダウン時ロック順序のコメント追加 | `app_input_history.go` または `app_lifecycle.go` | ✅ 可 | コメント追加のみ。 |
| I-2 | Important | テストケース追加（msg+source同時超過） | `app_session_log_test.go` | ✅ 可 | テストファイルへの追加のみ。 |
| I-3 | Important | `LogFrontendEvent` ヘルパー関数の共通化 | `useBackendSync.ts` | ⚠️ 注意 | `useBackendSync.ts` を変更するため、同ファイルを修正するH系タスクとは直列作業が必要。 |
| I-4 | Important | ショートカット衝突検出の追加 | `ViewerSystem.tsx` | ✅ 可 | 他タスクと独立。 |
| I-5 | Important | TODOコメントのIssue登録 | `app_pane_api.go` | ✅ 可 | Issue作成のみ。コード変更なし。 |
| I-6 | Important | `VIEWER_VIEW_IDS` と `VIEWER_SHORTCUTS` の共通化 | `settingsValidation.ts`, `ViewerShortcutSettings.tsx` | ⚠️ 注意 | `settingsValidation.ts` を C-3 と同時に修正する場合は直列作業が必要。 |
| I-7 | Important | 型定義の重複に対するSYNCコメント追加 | `inputHistoryStore.ts` | ✅ 可 | コメント追加のみ。 |
| I-8 | Important | `inputLineBuffers` の初期化方法見直し | `app.go` | ✅ 可 | `NewApp()` の変更のみ。 |
| S-1 | Suggestion | fetch/debounce/retry の共通化 | `useBackendSync.ts` | ❌ 不可 | I-3 と同じファイルを大幅に修正するため、直列作業必須。 |
| S-2 | Suggestion | バッジ表示の一般化 | `ActivityStrip.tsx`, `viewerRegistry.ts` | ✅ 可 | 他タスクと独立。 |

### 並列作業マトリックス（主要タスク間の依存関係）

```
        C-1  C-2  C-3  I-1  I-2  I-3  I-4  I-5  I-6  I-7  I-8  S-1  S-2
C-1      -    ○    ○    ○    ○    ○    ○    ○    ○    ○    ○    ○    ○
C-2      ○    -    ○    ○    ○    ○    ○    ○    ○    ○    ○    ○    ○
C-3      ○    ○    -    ○    ○    ○    ○    ○    ×    ○    ○    ○    ○
I-1      ○    ○    ○    -    ○    ○    ○    ○    ○    ○    ○    ○    ○
I-2      ○    ○    ○    ○    -    ○    ○    ○    ○    ○    ○    ○    ○
I-3      ○    ○    ○    ○    ○    -    ○    ○    ○    ○    ○    ×    ○
I-4      ○    ○    ○    ○    ○    ○    -    ○    ○    ○    ○    ○    ○
I-5      ○    ○    ○    ○    ○    ○    ○    -    ○    ○    ○    ○    ○
I-6      ○    ○    ×    ○    ○    ○    ○    ○    -    ○    ○    ○    ○
I-7      ○    ○    ○    ○    ○    ○    ○    ○    ○    -    ○    ○    ○
I-8      ○    ○    ○    ○    ○    ○    ○    ○    ○    ○    -    ○    ○
S-1      ○    ○    ○    ○    ○    ×    ○    ○    ○    ○    ○    -    ○
S-2      ○    ○    ○    ○    ○    ○    ○    ○    ○    ○    ○    ○    -
```
**凡例:** ○ = 並列作業可能、× = 直列作業必要（同一ファイルを変更）

### 作業者向け推奨作業順序

```
Phase 1 (並列実行可能):
├── 作業者A: C-1 (Go テスト全体 — new(true)の確認)
├── 作業者B: C-3 + I-6 (settingsValidation.ts — import順序 + 共通化)  ← 同一ファイルなのでまとめて
├── 作業者C: I-2 (session_log テストケース追加)
├── 作業者D: I-4 (ViewerSystem.tsx — 衝突検出)
└── 作業者E: I-1 + I-8 (app.go/app_input_history.go — コメント追加 + 初期化)

Phase 2 (Phase 1 完了後):
├── 作業者A: I-3 + S-1 (useBackendSync.ts — ヘルパー関数共通化 + fetch共通化)
└── 作業者B: S-2 (ActivityStrip.tsx — バッジ一般化)
       ↑ I-3/S-1 完了を待つ必要はない（別ファイル）

Phase 3 (確認):
└── 全体: ビルド確認 + テスト実行
```

---

## 本番コード確認による追加レビュー

差分に含まれていないが、差分から参照される本番コードを確認した結果の追加指摘です。

### PA-1 [code-reviewer]: `app_input_history.go` — `cleanupOldInputHistory` の命名パターンの一貫性 ✅

**確認結果:** `cleanupOldInputHistory` は `cleanupOldSessionLogs` と同一のパターンで実装されている。ファイルの選別（prefix + suffix）、ソート、excess計算、削除ループがすべて一貫。問題なし。

### PA-2 [code-reviewer]: `inputHistoryStore.ts` — `errorLogStore.ts` との構造的一貫性 ✅

**確認結果:** `inputHistoryStore.ts` は `errorLogStore.ts` と以下の点で完全に一貫:
- `isValidSeq` / `isValidEntryShape` / `normalizeEntries` の構造
- zustand store の `setEntries` / `markAllRead` パターン
- seq リグレッション検出、初回ロード時の already-read 設定
- unreadCount のスキャンロジック

### PA-3 [code-reviewer]: `ErrorBoundary.tsx` — コンポーネントスタックのクリッピング ✅

**確認結果:** `componentStack` を300文字にクリップし、さらにGo側の `frontendLogMaxSourceLen` (200 rune) に合わせて `rawSource.slice(0, 200)` を適用。二重の安全策が適切。

### PA-4 [code-reviewer]: `ViewerShortcutSettings.tsx` — バリデーションエラー表示 ✅

**確認結果:** `s.validationErrors[errorKey]` によるインラインエラー表示が実装されている。`validateViewerShortcuts` が返す `viewer_shortcut_${viewId}` キーと一致。

### PA-5 [silent-failure-hunter]: `app_input_history.go` — `writeInputHistoryEntry` での Sync() 省略

**確認結果:** コメント L362-365 に明記：
> NOTE: Unlike writeSessionLogEntry, Sync() is intentionally omitted here.
> Input history is high-frequency, non-critical data (keystrokes). The cost
> of fsync per batch outweighs the risk of losing a few entries on crash.

session log との意図的な差異であり、高頻度データに対する適切なトレードオフ判断。問題なし。

### PA-6 [code-reviewer]: `app_input_history.go` L367-370 — slog 使用制限コメント ✅

**確認結果:** `writeInputHistoryEntry` 内で `slog.Warn/Error` を使わず `fmt.Fprintf(os.Stderr, ...)` を使用している理由が明記されている。TeeHandler の再帰リスク回避として適切。

---

## 総合評価

| 観点 | 評価 |
|------|------|
| 設計の一貫性 | ⭐⭐⭐⭐⭐ session log パターンの踏襲が優秀 |
| ロック設計 | ⭐⭐⭐⭐⭐ ドキュメント化・順序設計が明確 |
| テストカバレッジ | ⭐⭐⭐⭐ 充実しているが一部追加推奨 |
| エラーハンドリング | ⭐⭐⭐⭐ CLAUDE.md 仕様に準拠 |
| コード品質 | ⭐⭐⭐⭐ DRY違反が一部あるが全体的に高品質 |
| Go モダン化 | ⭐⭐⭐ `new(true)` の有効性要確認 |
| フロントエンド設計 | ⭐⭐⭐⭐ 既存パターンとの一貫性が高い |
