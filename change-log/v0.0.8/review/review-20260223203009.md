# PR Review Summary

**レビュー日時**: 2026-02-23 20:30:09  
**レビュー対象**: `D:\myT-x\dev-myT-x\review\temp` 配下の27個の差分ファイル  
**レビュー方針**: `review-pr-para.prompt.md` に準拠

---

## 変更概要

本PRは以下の主要機能・改善を含みます:

1. **Input History 機能** — ターミナル入力のバッファリング・永続化・UI表示
2. **LogFrontendEvent** — フロントエンドエラーのバックエンドセッションログへの記録
3. **ErrorBoundary + グローバルエラーハンドラ** — React クラッシュ・未処理例外のキャプチャ
4. **Viewer Shortcuts 設定** — 右サイドバーのショートカットキーのカスタマイズ対応
5. **Go Modernization (`go fix`)** — `strings.SplitSeq`, `CutPrefix`, range integer化
6. **テストコードのリファクタリング** — `testutil.Ptr` → `boolPtrTest` へのインライン化

---

## カテゴリ別レビュー

### カテゴリ A: Go バックエンド — App 構造体・Input History コア

**対象ファイル**:
- `myT-x_app.go.diff`
- `myT-x_app_lifecycle.go.diff`
- `myT-x_app_pane_api.go.diff`
- `myT-x_app_session_log.go.diff`

### カテゴリ B: Go バックエンド — Config・テストユーティリティ

**対象ファイル**:
- `myT-x_internal_config_config.go.diff`
- `myT-x_internal_config_config_test.go.diff`
- `myT-x_internal_testutil_helpers.go.diff`

### カテゴリ C: Go バックエンド — テストモダナイズ（tmux パッケージ）

**対象ファイル**:
- `myT-x_internal_tmux_command_router_env_test.go.diff`
- `myT-x_internal_tmux_command_router_handlers_window_test.go.diff`
- `myT-x_app_session_log_test.go.diff`

### カテゴリ D: フロントエンド — Input History UI・ストア・同期

**対象ファイル**:
- `myT-x_frontend_src_hooks_useBackendSync.ts.diff`
- `myT-x_frontend_src_api.ts.diff`
- `myT-x_frontend_src_main.tsx.diff`
- `myT-x_frontend_src_types_tmux.ts.diff`

### カテゴリ E: フロントエンド — Settings・Viewer Shortcuts

**対象ファイル**:
- `myT-x_frontend_src_components_SettingsModal.tsx.diff`
- `myT-x_frontend_src_components_settings_KeybindSettings.tsx.diff`
- `myT-x_frontend_src_components_settings_settingsReducer.ts.diff`
- `myT-x_frontend_src_components_settings_settingsValidation.ts.diff`
- `myT-x_frontend_src_components_settings_types.ts.diff`

### カテゴリ F: フロントエンド — Viewer System・ActivityStrip

**対象ファイル**:
- `myT-x_frontend_src_components_viewer_ActivityStrip.tsx.diff`
- `myT-x_frontend_src_components_viewer_ViewerSystem.tsx.diff`
- `myT-x_frontend_src_components_viewer_viewerRegistry.ts.diff`

### カテゴリ G: 設定ファイル・Wails 自動生成バインディング

**対象ファイル**:
- `myT-x_config.yaml.diff`
- `myT-x_frontend_wailsjs_go_main_App.d.ts.diff`
- `myT-x_frontend_wailsjs_go_main_App.js.diff`
- `myT-x_frontend_wailsjs_go_models.ts.diff`

---

## Critical Issues (0 件)

**該当なし** — 本PRにはマージをブロックするレベルの致命的な問題は発見されませんでした。

---

## Important Issues (5 件)

### I-1: `validateViewerShortcuts` — デフォルトショートカットとの重複チェックが行われていない

- **レビュー観点**: silent-failure-hunter / code-reviewer
- **ファイル**: `settingsValidation.ts` (diff L10-L32)
- **本番コード確認**: `ViewerShortcutSettings.tsx` L15-L21

**詳細**:
`validateViewerShortcuts` は入力されたショートカット同士の重複チェックのみを行っていますが、**他のビューのデフォルトショートカット**との重複を検証していません。

例: `file-tree` のデフォルトは `Ctrl+Shift+E`。ユーザーが `git-graph` に `Ctrl+Shift+E` を設定した場合、`file-tree` は空（= デフォルト使用）のため `seenShortcuts` に登録されず、重複として検出されません。結果的に同じキーに2つのビューがバインドされ、`shortcutMap` ではどちらか一方しか有効にならないサイレントな競合が発生します。

**影響範囲**:
- `ViewerSystem.tsx` の `shortcutMap` 構築ロジック（L50-L59）で同一キーに後勝ちで上書きされる
- `ActivityStrip.tsx` のツールチップ表示にも影響

**推奨修正**:
```typescript
// 空のエントリにはデフォルトショートカットをseenShortcutsに事前登録する
for (const {viewId, defaultShortcut} of VIEWER_SHORTCUTS) {
    const raw = (viewerShortcuts[viewId] ?? "").trim();
    const effective = raw || defaultShortcut;
    const normalized = effective.toLowerCase();
    // ...重複チェック
}
```

---

### I-2: `ViewerSystem.tsx` — ショートカットキーのフォーマット正規化の不一致リスク

- **レビュー観点**: code-reviewer
- **ファイル**: `ViewerSystem.tsx` (diff L50-L59)
- **本番コード確認**: `ViewerSystem.tsx` L40-L63

**詳細**:
`shortcutMap` はキーを `.toLowerCase()` で正規化して格納しています。一方、`buildShortcutString`（キーボードイベントから文字列生成）の出力フォーマットと `configShortcut` からのフォーマットが必ずしも一致するとは限りません。

例えば、ユーザーが設定画面で `ctrl+shift+e` と入力した場合と `Ctrl+Shift+E` と入力した場合の正規化は `.toLowerCase()` で統一されますが、**キーボードイベント側の `buildShortcutString` が大文字小文字をどう生成するか**と一致しているかの保証がコードから確認できません。

本番コード（`ViewerSystem.tsx` の `handler` 関数内）を確認すると、`buildShortcutString(e).toLowerCase()` でマッチングしているため、**現時点では問題なし**ですが、`ShortcutInput` コンポーネントが自由入力を許容する場合、今後のメンテナンスで不整合が発生しうるため、入力時の正規化処理の統一を推奨します。

**推奨**: `ShortcutInput` のonChange内で入力値を正規化してから保存する方式を検討。

---

### I-3: `app_pane_api.go` — `recordInput` の呼び出しがエラー後にも実行される考慮

- **レビュー観点**: code-reviewer
- **ファイル**: `app_pane_api.go` (diff L9-L10, L18-L19)

**詳細**:
`SendInput` / `SendSyncInput` では、tmuxへの送信が**成功した場合のみ**（`return err` の前の`return nil` パスで）`recordInput` が呼ばれます。これは正しい実装です。

ただし、`recordInput` の第4引数 `session` が常に空文字列 `""` で渡されており、TODO コメントで「pane-to-session mapping when available」と記載されています。

**推奨**: 現時点では問題ないが、session 名が空のままJSONLファイルに永続化されるため、将来的にsession情報の追跡が必要になった場合にデータ移行が発生する可能性があることを認識しておく。

---

### I-4: `useBackendSync.ts` — `logFrontendEventSafe` 呼び出しの英語/日本語メッセージ混在

- **レビュー観点**: comment-analyzer
- **ファイル**: `useBackendSync.ts` (diff 全体)

**詳細**:
`notifyWarn` に渡すユーザー向けメッセージは日本語（`"設定の読み込みに失敗しました。"`）と英語（`"Failed to load session list."`）が混在しています。これは既存の問題ですが、新規追加の `logFrontendEventSafe` の第2引数（msg）は全て英語で統一されており、これ自体は内部ログとして適切です。

ただし、`notifyWarn` に渡すメッセージの日英混在は既存問題であるため、本PRの指摘対象外として記録のみ留めます。

**影響**: `logFrontendEventSafe` 自体には問題なし。

---

### I-5: `app_session_log.go` に追加された `normalizeLogLevel` — `"debug"` レベルのドキュメント不整合

- **レビュー観点**: comment-analyzer / code-reviewer
- **ファイル**: `app_session_log.go` (diff L17-L31)
- **本番コード確認**: `app_session_log.go` L250-L264

**詳細**:
`normalizeLogLevel` の **GoDocコメント**（L18-L19）では:
> maps an arbitrary level string to one of the canonical values used by the session log system: **"error", "warn", or "info"**.

と3つの値のみを列挙していますが、実装では `case "debug": return "debug"` が存在し、**4つの正規値**を返します。GoDocとの不一致があります。

テストコード（`TestNormalizeLogLevel`）では `debug` が `debug` に正規化されることが正しくテストされています。

**推奨修正**: GoDoc を修正し `"error", "warn", "debug", or "info"` と記載する。

---

## Suggestions (8 件)

### S-1: `app.go` — `inputLineBuffers` の初期化を `NewApp()` で行う

- **ファイル**: `app.go` (diff L50-L51)
- **本番コード確認**: `app_input_history.go` L183-L185

**詳細**:
`inputLineBuffers` は `recordInput` 内で遅延初期化（lazy init）されています:
```go
if a.inputLineBuffers == nil {
    a.inputLineBuffers = make(map[string]*inputLineBuffer)
}
```

一方、`inputHistoryEntries` は `NewApp()` で初期化されています（diff L51）。一貫性のため、`inputLineBuffers` も `NewApp()` で初期化する方が、nil チェックの分岐を省略でき可読性が向上します。

ただし、`recordInput` が呼ばれない場合の不要なメモリ確保を避けるための意図的な設計と解釈もでき、パフォーマンス影響は軽微です。

---

### S-2: `app_lifecycle.go` — `initInputHistory()` の呼び出し位置

- **ファイル**: `app_lifecycle.go` (diff L9)

**詳細**:
`initInputHistory()` は `slog.SetDefault(slog.New(teeHandler))` の直後、`config.EnsureFile()` の前に呼ばれています。これは `sessionLogPath` の設定よりも先に実行されるため、input historyのディレクトリパスが `configPath` から導出されます。ロジック的には正しいですが、config の読み込みに依存する設定がある場合を考慮すると、将来的に移動が必要になる可能性があります。

現状では問題ありません。

---

### S-3: `app_devpanel_api.go` — `strings.SplitSeq` への変更は正しいモダナイゼーション

- **ファイル**: `app_devpanel_api.go` (diff L9-L10)

**詳細**:
Go 1.26 の `strings.SplitSeq` を使用しています。これはイテレータベースで不要なスライス割り当てを回避するため、パフォーマンスが向上します。`CutPrefix` への移行も同様に適切です。

ただし、`SplitSeq` は `range` ループでのみ使用可能であり、インデックスアクセスはできません。当該コードでは `for line := range` で使用されており正しいです。

**問題なし — 良い変更です。**

---

### S-4: `main.tsx` — `container!` の非nullアサーションから明示的チェックへの変更は適切

- **ファイル**: `main.tsx` (diff L44-L48)

**詳細**:
```typescript
// Before: const root = createRoot(container!)
// After:
const container = document.getElementById("root");
if (!container) {
    throw new Error("[main] Root element #root not found in document");
}
const root = createRoot(container);
```

defensive-coding-checklist に準拠した適切な改善です。

**問題なし — 良い変更です。**

---

### S-5: `main.tsx` — `Symbol.for()` による HMR 対策は適切

- **ファイル**: `main.tsx` (diff L15-L42)

**詳細**:
`Symbol.for("mytx.global.error.handlers")` を使用してグローバルエラーハンドラの二重登録を防止しています。HMR（Hot Module Replacement）環境での重複リスナー回避は実践的な手法です。

`window.addEventListener("error")` と `window.addEventListener("unhandledrejection")` の両方で `LogFrontendEvent` を fire-and-forget で呼び出しており、`.catch(() => {})` でサイレントに失敗を無視しています。エラーリカバリ中にログ処理が例外を投げないようにする適切な設計です。

**問題なし — 良い変更です。**

---

### S-6: `ActivityStrip.tsx` — badge の汎用化検討

- **ファイル**: `ActivityStrip.tsx` (diff L40-L42)

**詳細**:
現在、unread badge の表示ロジックは `error-log` と `input-history` でそれぞれ個別に条件分岐しています:
```tsx
{view.id === "error-log" && unreadCount > 0 && (<span className="viewer-strip-badge"/>)}
{view.id === "input-history" && inputHistoryUnreadCount > 0 && (<span className="viewer-strip-badge"/>)}
```

今後さらに別のビューにバッジを付ける場合、この方式では `ActivityStrip` の肥大化につながります。ViewPlugin インターフェースに `getBadgeCount?: () => number` のようなフックを追加し、レジストリ経由でバッジ表示を委譲する設計も検討に値します。

ただし、現時点で2種類のみであり、過度な抽象化を避ける方が保守コストは低いため、**現状維持で問題ありません**。

---

### S-7: `settingsReducer.ts` — `UPDATE_VIEWER_SHORTCUT` の exhautsive check

- **ファイル**: `settingsReducer.ts` (diff L25-L29)

**詳細**:
新しい `case "UPDATE_VIEWER_SHORTCUT"` が `default` の exhautsive check (`const _exhaustive: never = action`) の直前に追加されており、TypeScript の網羅的チェックは維持されています。

**問題なし — 正しい位置に追加されています。**

---

### S-8: `config.yaml` — viewer_shortcuts のコメントにデフォルト値の明記

- **ファイル**: `config.yaml` (diff L9-L16)

**詳細**:
コメントアウトされた設定例が追加されており、ユーザーが参照しやすい形になっています。ただし、CLAUDE.md の「yamlへの設定事項追加時の動作」ルールに従い、README.md への記載も併せて行うべきです。

**推奨**: README.md に `viewer_shortcuts` 設定の説明を追加する（もし未実施の場合）。

---

## Positive Observations (Strengths)

### P-1: Input History の設計品質が高い
- Session Log と同一のアーキテクチャパターン（JSONL永続化 + リングバッファ + ping+fetchイベントモデル）を採用しており、一貫性のある設計
- ロック順序の明文化（`inputLineBufMu` → `inputHistoryMu` を同時保持しない）
- タイマー世代管理（`timerGen`）による stale callback 防止
- `processInputString` によるエスケープシーケンス除去は堅牢

### P-2: ErrorBoundary + グローバルエラーハンドラの実装が適切
- React の `componentDidCatch` と `window.error` / `window.unhandledrejection` の3層でエラーをキャプチャ
- 全箇所で `.catch(() => {})` によるサイレントフォールバックを徹底
- `ErrorBoundary` にリトライボタンを提供し、ユーザー体験を考慮

### P-3: defensive-coding-checklist に準拠したコーディング
- `container!` の non-null assertion をランタイムチェックに置換
- `Clone()` で `ViewerShortcuts` の deep copy を正しく実装
- Config field count guard テスト（`TestConfigStructFieldCounts`）の更新を忘れずに実施

### P-4: テストの充実
- `normalizeLogLevel` のテーブル駆動テスト（12パターン）
- `LogFrontendEvent` の正常系・空メッセージ・文字数切り詰めの各パターンを網羅
- `TestLogFrontendEvent_MultibyteSafeRune` でUTF-8安全性を検証
- Config の round-trip テスト、Clone 独立性テストが追加

### P-5: Go modernization の適切な適用
- `strings.SplitSeq` はイテレータベースでメモリ効率が向上
- `strings.CutPrefix` は `HasPrefix` + `TrimPrefix` の2回スキャンを1回に削減
- `for i := 0; i < N; i++` → `for i := range N` の慣用句化
- `//go:fix inline` ディレクティブの追加は `go fix` ツールチェーンとの統合に適切

---

## Recommended Action

1. **I-5 を修正** — `normalizeLogLevel` の GoDoc コメント修正（軽微）
2. **I-1 を検討** — `validateViewerShortcuts` でデフォルトショートカットとの重複検証を追加（中程度）
3. **S-8 を確認** — README.md に `viewer_shortcuts` の説明が記載されているか確認
4. 残りの Suggestions は将来の改善候補として記録

---

## 並列作業可否 タスク一覧表

以下の表は、各タスクを修正する際に**並列で作業しても問題ないか**を示しています。同じファイルを編集する必要がある場合や、前後の依存関係がある場合は「要順次」と記載しています。

| # | カテゴリ | タスクID | 内容 | 対象ファイル | 優先度 | 並列作業 | 備考 |
|---|---------|---------|------|-------------|--------|---------|------|
| 1 | E | I-1 | `validateViewerShortcuts` にデフォルトショートカットとの重複チェック追加 | `settingsValidation.ts` | Important | ✅ 可能 | 他タスクとファイル競合なし |
| 2 | F | I-2 | `ShortcutInput` の入力正規化の統一検討 | `ShortcutInput.tsx` (新規修正), `ViewerSystem.tsx` | Important | ⚠️ I-1と同時に着手可能だが、I-1のデフォルト重複ロジックとUI整合性確認が必要 | I-1 との関連あり |
| 3 | A | I-3 | `recordInput` の session 引数（将来対応メモ） | `app_pane_api.go` | Important | ✅ 可能 | TODO コメントの追記のみなら即時可。実装は別タスクで管理推奨 |
| 4 | A | I-5 | `normalizeLogLevel` の GoDoc コメント修正 | `app_session_log.go` | Important | ✅ 可能 | 1行のコメント修正のみ。他タスクと競合なし |
| 5 | G | S-8 | README.md に `viewer_shortcuts` 設定の説明追加 | `README.md` | Suggestion | ✅ 可能 | 他タスクとファイル競合なし |
| 6 | A | S-1 | `inputLineBuffers` の `NewApp()` 初期化 | `app.go` | Suggestion | ✅ 可能 | 軽微な変更。他タスクと競合なし |
| 7 | F | S-6 | ActivityStrip の badge 汎用化検討 | `ActivityStrip.tsx` | Suggestion | ✅ 可能 | 将来改善。現時点で修正不要 |

### 並列作業ガイド

```
並列グループ 1（即座に着手可能・相互依存なし）:
  ├── I-1: validateViewerShortcuts の修正    [settingsValidation.ts]
  ├── I-5: normalizeLogLevel GoDoc修正        [app_session_log.go]
  ├── S-8: README.md 更新                     [README.md]
  └── S-1: inputLineBuffers 初期化            [app.go]

並列グループ 2（グループ1 の I-1完了後に着手推奨）:
  └── I-2: ShortcutInput 正規化統一           [ShortcutInput.tsx]

独立タスク（いつでも着手可能）:
  ├── I-3: session 引数 TODO 整理              [app_pane_api.go]
  └── S-6: badge 汎用化検討                    [将来タスクとして管理]
```

---

## 本番コード確認による追加レビュー

差分レビュー完了後、本番コードも確認して周辺の影響範囲や処理の差異を追加調査しました。

### 追加確認 1: `app_input_history.go` 本番コード — `processInputString` のエッジケース

- **ファイル**: `myT-x/app_input_history.go` L96-L153

`processInputString` は `\x7f` (DEL) を「保持」しますが、これは `recordInput` 内で Backspace として解釈されます。つまり、processInputString の出力に `\x7f` が残り、それを `recordInput` が消費する二段構成になっています。この設計は正しく動作するものの、processInputString の GoDoc コメント（L100-L102）で DEL (0x7f) が "Kept" リストに含まれていることを確認済みです。

- **問題なし**: 設計意図通り。

### 追加確認 2: `inputHistoryStore.ts` vs `errorLogStore.ts` — 構造の一貫性

- **ファイル**: `myT-x/frontend/src/stores/inputHistoryStore.ts`, `errorLogStore.ts`

両ストアは同一のアーキテクチャパターン（`normalizeEntries`, `isValidSeq`, `isValidEntryShape`, `setEntries`, `markAllRead`）を採用しており、完全に一貫しています。`inputHistoryStore` は `errorLogStore` を参考に正しく実装されています。

- **問題なし**: パターンの一貫性が保たれています。

### 追加確認 3: `ErrorBoundary.tsx` — `componentDidCatch` の source 長制限

- **ファイル**: `myT-x/frontend/src/components/ErrorBoundary.tsx` L33-L38

```typescript
const rawSource = firstNonEmptyLine !== "" ? `frontend/react ${firstNonEmptyLine}` : "frontend/react";
const source = Array.from(rawSource).slice(0, 200).join("");
```

フロントエンド側で200文字にクリップしており、バックエンド側の `frontendLogMaxSourceLen = 200` と一致しています。二重のガードになっていますが、どちらかが変更された場合に不整合が起きる可能性があります。

- **推奨**: 定数を共有するか、バックエンド側のみに任せるか方針を統一する（低優先度）。

### 追加確認 4: `useBackendSync.ts` — Input History の fetch パターン

- **ファイル**: `myT-x/frontend/src/hooks/useBackendSync.ts` (diff全体)

Input History の「ping + fetch」パターンは Error Log のパターンと完全に一致しています:
- debounce + retry: 同一の定数値（80ms / 250ms）
- `isMountedRef` チェック
- fetch seq による stale response 排除
- cleanup でのタイマークリア

- **問題なし**: error log の実績あるパターンの忠実な適用。

### 追加確認 5: `command_router_env_test.go` — `boolPtrTest` のスコープ

- **ファイル**: `myT-x/internal/tmux/command_router_env_test.go`

`boolPtrTest` は `command_router_env_test.go` で定義され、同一パッケージ `tmux` の `command_router_handlers_window_test.go` からも参照されます。Go のテストファイルは同一パッケージ内であれば相互参照可能であるため、問題ありません。

ただし、元の `testutil.Ptr[T]` はジェネリクスで型安全でしたが、新しい `boolPtrTest` は `*bool` 専用です。`//go:fix inline` ディレクティブにより `testutil.Ptr` の呼び出しがインライン展開された結果です。

- **問題なし**: `go fix` による自動変換の正しい結果。

### 追加確認 6: `ViewerShortcutSettings.tsx` — SYNC コメントの整合性

- **ファイル**: `myT-x/frontend/src/components/settings/ViewerShortcutSettings.tsx` L5, L14

```typescript
/** SYNC: viewId values must match view registrations in components/viewer/views/*/index.ts */
// SYNC: Must match view registrations in components/viewer/views/*/index.ts
```

`VIEWER_SHORTCUTS` 配列に `input-history` が含まれており、`views/input-history/index.ts`（自動登録ファイル）からの import が `ViewerSystem.tsx` に存在することを確認済みです。SYNC コメントの整合性は保たれています。

- **問題なし**。

### 追加確認 7: `config.go` — `ViewerShortcuts` の omitempty 動作

- **ファイル**: `myT-x/internal/config/config.go` (diff L12)

```go
ViewerShortcuts map[string]string `yaml:"viewer_shortcuts,omitempty" json:"viewer_shortcuts,omitempty"`
```

`omitempty` により、nil の場合は YAML/JSON 出力から省略されます。フロントエンド側では `cfg.viewer_shortcuts ?? {}` で null/undefined を安全にハンドリングしています。

- **問題なし**: nil safety が両サイドで適切に処理されています。

### 追加確認 8: `app_session_log_test.go` — `TestLogFrontendEvent_WritesToSessionLog` のアサーション網羅性

- **ファイル**: `app_session_log_test.go` (diff L57-L149)

テストでは `GetSessionErrorLog()` の結果を検証していますが、`GetSessionErrorLog` は **全エントリ**を返すメソッドです。`LogFrontendEvent` で `debug` レベルを指定した場合、テストケース `"debug level normalized to debug"` では `expectedLevel: "debug"` と検証されていますが、`GetSessionErrorLog` が `debug` レベルのエントリもフィルタなしで返すことが前提です。

本番コード（`app_session_log.go` L227-L231）を確認:
```go
func (a *App) GetSessionErrorLog() []SessionLogEntry {
    a.sessionLogMu.RLock()
    defer a.sessionLogMu.RUnlock()
    return a.sessionLogEntries.snapshot()
}
```

`snapshot()` はフィルタリングなしで全エントリを返すため、テストの前提は正しいです。ただし、メソッド名 `GetSessionErrorLog` は「エラーログ」を想起させますが、実際には全レベルのログを返します。命名の改善は将来の検討事項です。

- **問題なし**（機能的に正しい）。命名は既存の問題であり本PRの範囲外。

---

## 最終サマリ

| 分類 | 件数 |
|------|------|
| Critical Issues | 0 |
| Important Issues | 5 |
| Suggestions | 8 |
| Positive Observations | 5 |

**総合評価**: 本PRは高品質な実装であり、既存のアーキテクチャパターンに忠実に従っています。Important Issues は全て軽微〜中程度の改善であり、マージをブロックするものではありません。特に I-1（デフォルトショートカットとの重複チェック）は実装を推奨しますが、他は今後の改善として管理可能です。
