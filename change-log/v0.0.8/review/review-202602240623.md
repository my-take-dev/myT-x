# PR Review 統合レポート

**レビュー作成日時**: 2026-02-24 06:23  
**レビュー対象**: `D:\myT-x\dev-myT-x\review\temp` 配下の差分ファイルおよび本番コード  

---

## 1. 概要・総評

本PRは、**Input History 機能**, **Frontend Error 収集**, **ViewerShortcuts 設定**, **Go モダン化** を主軸とする大規模な変更を含みます。
複数のエージェント・観点からレビューを行った結果、マージをブロックするレベルの **Critical Issues は 0 件** であり、既存のアーキテクチャやロック制御の設計に忠実に従った高品質な実装であると評価できます。

ただし、いくつかのエッジケースや、UIと設定間のフォーマット不一致、テストの網羅性などに対する **Important Issues (指摘事項/要修正)** が存在します。これらを修正することで、より堅牢なシステムとなります。

---

## 2. 優れた実装 (Strengths & Positives)

1. **Input History の堅牢な設計**: Session Log と同一のリングバッファ + JSONL永続化 + ping-onlyイベントモデルを踏襲し、一貫性を保っています。fsync省略のトレードオフ判断も適切に明記されています。
2. **ロック制御と並行安全性**: `app.go` にロック順序が明記され、`inputLineBufMu` → `inputHistoryMu` のデッドロック防止が徹底されています。また、`timerGen` による stale フラッシュ防止も適切です。
3. **エラーハンドリングの徹底**: ErrorBoundary とグローバルエラーハンドラの多層構造、およびHMR (Hot Module Replacement) を考慮した `Symbol.for` の採用は実践的です。非同期エラーがサイレントに握りつぶしリカバリを阻害しない点も評価できます。
4. **Go 1.22+ モダン化**: `strings.SplitSeq`, `CutPrefix`, `for i := range N`, `//go:fix inline` など、モダンなイディオムがパフォーマンスと可読性向上のために正しく適用されています。
5. **堅牢なバリデーションとテスト**: ルーン安全な文字列切り詰め、深いコピー(`maps.Copy`)、Configのラウンドトリップ検証など、防御的プログラミングの要件を満たすテストが充実しています。

---

## 3. 指摘事項 (Important Issues)

| ID | カテゴリ | 対象ファイル | 概要 |
|---|---|---|---|
| **A-I-1** | Go Backend | `app_input_history.go` | `flushLineBuffer` のタイムアウトフラッシュ時、既存バッファに対する `source`/`session` フィールドの更新漏れ。 |
| **A-I-2** | Go Backend | `app_input_history.go` | `cleanupOldInputHistory` で PID 付のファイル名ソートが辞書順となっており、最古のファイルが先に消えない可能性がある。 |
| **A-I-3** | Go Backend | `app_input_history.go` | Windows環境等で削除失敗時に MAX_FILES 超過が残る。仕様としてコメント明示を推奨。 |
| **A-I-4** | Go Backend | `app_pane_api.go` | `recordInput` 呼び出し時の引数 `session` が空文字のまま。(将来対応のTODO) |
| **A-I-5** | Go Backend | `app_session_log.go` | `normalizeLogLevel` の GoDoc が "debug" レベルの追加を反映していない。 |
| **B-I-1** | Go Tests | `app_session_api_test.go` | `testutil.Ptr` を `boolPtrTest` に移行する対応が未適用。`go fix ./...` を推奨。 |
| **B-I-2** | Go Tests | `app_input_history_test.go` | `TestFlushAllLineBuffers_PersistsPendingBuffers` において、書き込まれた各エントリの文字列・PaneIDの検証がない（件数のみ確認）。 |
| **B-I-3** | Go Tests | `app_input_history_test.go` | カレントファイル保持や最古ファイルの削除など、クリーンアップの正確性を保証するテストが不足。 |
| **C-I-1** | Frontend | `main.tsx`, `ErrorBoundary.tsx`| `api.LogFrontendEvent` 呼び出し時、Wails 未初期化などにより同期エラーが発生した場合の try-catch 保護がない。 |
| **D-I-1** | Frontend UI| `settingsValidation.ts` | 純粋関数であるべきバリデーションが UI コンポーネント (`ViewerShortcutSettings.tsx`) に依存し、循環依存を招いている。 |
| **D-I-2** | Frontend UI| `settingsValidation.ts` | ViewerShortcuts の重複チェックで、**デフォルトショートカット**との衝突検証が行われていない。 |
| **D-I-3** | Frontend UI| `ViewerSystem.tsx` | 入力されたショートカットとキーイベント(`buildShortcutString`)から生成される文字列の大文字小文字などの正規化不一致のリスク。 |
| **D-I-4** | Frontend UI| `ActivityStrip.tsx` 等 | `effectiveShortcut` (設定値優先、次点でデフォルト) の取得・判別ロジックが2箇所で重複し、型不一致が発生している。 |

---

## 4. 改善提案 (Suggestions)

| ID | カテゴリ | 対象ファイル | 概要 |
|---|---|---|---|
| **A-S-1** | Go Backend | `app_input_history.go` | `processInputString` で C1制御文字 (U+0080–U+009F) がフィルタされず透過する。 |
| **A-S-2** | Go Backend | `app_input_history.go` | `flushLineBuffer` 内の複数 `Unlock()` を `defer` パターンにリファクタリングして保守性を向上。 |
| **A-S-3** | Go Backend | `app_input_history.go` | `flushLineBuffer(gen=0)` のケースで明示的に `lb.timer.Stop()` を呼ぶべき。 |
| **A-S-4** | Go Backend | `app_input_history.go`他| `sort.Strings` を Go 1.21+ の `slices.Sort` へ移行統一。 |
| **A-S-5** | Go Backend | `app_devpanel_api.go` | `ok0` などの変数名を `found` や `hasPrefix` に改名して可読性向上。 |
| **A-S-6** | Go Backend | `app.go` 他 | `inputLineBuffers` は遅延初期化、`inputHistoryEntries` は事前初期化で非対称。理由の明記か統一を推奨。 |
| **A-S-7** | Go Backend | `app_lifecycle.go` | `initInputHistory()` の呼び出し位置に関する懸念（設定等への依存が発生した場合の実行順整理）。 |
| **B-S-1** | Go Tests | `app_session_log_test.go` | `TestNormalizeLogLevel` に "WARNING" （大文字）の検証ケース追加。 |
| **B-S-2** | Go Tests | `app_session_log_test.go` | 空白付き source の Trim 検証テストケース追加。 |
| **B-S-3** | Go Tests | `app_input_history_test.go`| マジックナンバー (`expectedAfter: 11`) を動的な計算式 (`tt.filesToCreate + 1`) へ変更。 |
| **B-S-4** | Go Tests | `app_input_history_test.go`| スナップショット取得後、元のバッファが更新・修正されても影響を受けないことの独立性確認ケースを追加。 |
| **B-S-5** | Go Tests | `app_input_history_test.go`| リングバッファ emit が初回はスルーされる暗黙的前提 (`inputHistoryLastEmit` の初期値) を明示的コメント化。 |
| **C-S-1** | Frontend | `*Store.ts` | Go 構造体からの生成型（DRIFT）対応と Store 側の独自定義型の同期手順コメントを追加する。 |
| **C-S-2** | Frontend | `useBackendSync.ts` | `fetchInputHistory` の retry 時に、Error Log 側と同様の DEV ログ追加。 |
| **C-S-3** | Frontend | `useBackendSync.ts` | `INPUT_HISTORY_DEBOUNCE_MS` と `ERROR_LOG_DEBOUNCE_MS` が同値である理由のコメント追加。 |
| **C-S-4** | Frontend | `useBackendSync.ts` | *既存問題*: `notifyWarn` 呼び出しにハードコードされた英語・日本語エラーメッセージの混在を解消する。 |
| **D-S-1** | Frontend UI| `settingsValidation.ts` | 3つ以上の重複ショートカット設定時でも `seenShortcuts` を更新しないことの設計意図をコメント明記。 |
| **D-S-2** | Frontend UI| `ViewerShortcutSettings.tsx`| JSDoc コメント内の複数行コメント `*/` が意図せずブロックを早期に終了させるリスク（グロブ記述の修正）。 |
| **D-S-3** | Frontend UI| `ActivityStrip.tsx` 等 | バッジ表示の対象有無条件（`unreadCount`等）を `view.id` ハードコードではなく `ViewPlugin` 等で抽象化を検討。 |
| **D-S-4** | Frontend UI| `ViewerShortcutSettings.tsx`| UI上でのデフォルトショートカット（表示用）と、Goバックエンドのデフォルト値が将来乖離する運用リスクへの対応。 |
| **D-S-5** | Frontend UI| `ErrorBoundary.tsx` | UI描画用 (`getDerivedStateFromError`) とエラーログ配信用 (`componentDidCatch`) でデフォルトエラー文言が不一致。 |
| **E-S-1** | Config | `README.md` | `viewer_shortcuts` 設定機能を追加したことに伴う README.md への機能説明追記。 |

---

## 5. 並列作業可否 タスク一覧表 (並列作業マトリクス)

以下の表は、各タスクの並行対応が可能かどうか、および競合を避けるための作業グループ分けです。
同等のグループ内は基本的に同一のコンテキスト・同一ファイルが多いため、同じ作業者がまとめて対応することで Git コンフリクトを防ぎ、並列作業が可能となります。

| 作業グループ | 状態 | タスクID | 対象ファイル群 | 概要 | 優先度 | 並行作業について |
|---|:---:|---|---|---|---|---|
| **グループ 1**<br>Input Historyコア | [ ] | A-I-1, A-I-2, A-I-3<br>A-S-1, A-S-2, A-S-3<br>A-S-4 | `app_input_history.go` 他 | バッファリングロジック、クリーンアップ、制御文字フィルター等コア部分の修正。 | High | グループ1内は密結合しているため、1人がまとめて一挙に作業することを強く推奨。(他グループとは完全並行可) |
| **グループ 2**<br>Go テスト補強 | [ ] | B-I-1, B-I-2, B-I-3<br>B-S-1 〜 B-S-5 | `*_test.go` 系 | `go fix ./...` 適用、および検証テストの拡充（バリデーションやマジックナンバー対応等）。 | High | テスト専用のため、グループ1や3等と**並列に作業可能**。 |
| **グループ 3**<br>Frontend エラー系 | [ ] | C-I-1<br>D-S-5<br>C-S-1 〜 C-S-4 | `main.tsx`<br>`ErrorBoundary.tsx`<br>`useBackendSync.ts`<br>`*Store.ts` | 同期エラーハンドリングの保護、ログ実装、リトライのログ出力等の調整。 | High | React/Wails関連。Goバックエンドやショートカット設定とは独立しているため**並列作業可能**。 |
| **グループ 4**<br>Frontend UI設定系 | [ ] | D-I-1, D-I-2, D-I-3<br>D-I-4<br>D-S-1 〜 D-S-4 | `settingsValidation.ts`<br>`ViewerShortcut*.tsx`<br>`ViewerSystem.tsx`<br>`ActivityStrip.tsx` | 設定項目・UIコンポーネント同士の循環依存整理、ショートカットキー重複・正規化、およびデフォルト値判定ロジックの見直し。 | High | Viewerシステムやショートカットに特化しているため、**並列作業可能**。ただし定数ファイルの切り出しなどインポート追従が必要。 |
| **グループ 5**<br>独立・軽微タスク | [ ] | A-I-4, A-I-5<br>A-S-5, A-S-6, A-S-7<br>E-S-1 | `app_pane_api.go`<br>`app_session_log.go`<br>`README.md` 等 | 将来対応のTODO整理、GoDoc修正、README変更などの軽微なタスク。 | Low/Mid | ファイルの競合が発生しにくいため、**誰でも随時並行して着手可能**。 |

### ★ 推奨される並行作業の手順例
- **Aさんが グループ1 (Go バックエンドコア)** を担当
- **Bさんが グループ4 (Frontend ショートカットUI・設定)** を担当
- **Cさんが グループ2 (Go テスト拡充)** を担当（※本体コード完成前でもテストケース構築に着手可能）
- 上記に依存しない **グループ3** や **グループ5** は、手が空いたメンバーが随時ピックアップして進める形式が最も効率的です。
