# PR Review Summary

## レビュー概要

- **レビュー日時**: 2026-02-24 07:36 JST
- **対象差分**: 34ファイル（`D:\myT-x\dev-myT-x\review\temp` 配下）
- **レビュー方針**: `review-pr-para.prompt.md` に準拠
- **プロジェクトルール**: `CLAUDE.md` / `AGENTS.md` に準拠

### 変更概要

本差分は以下の3つの主要機能追加・改善を含む大規模変更です：

1. **入力履歴（Input History）機能** — バックエンド（Go）+ フロントエンド（React）の新規機能
2. **ビューアーショートカット設定** — 設定画面でのカスタマイズ機能追加
3. **フロントエンドエラーログ永続化** — `LogFrontendEvent` / `ErrorBoundary` / グローバルエラーハンドラ
4. **Go 1.26 モダナイゼーション** — `go fix` による `new(v)` / `SplitSeq` / `CutPrefix` 等への移行

---

## カテゴリ分類（並列レビュー対象）

| カテゴリ | 対象ファイル数 | 概要 |
|---|---|---|
| **A. バックエンド: 入力履歴機能** | 5 | app.go, app_lifecycle.go, app_pane_api.go, app_pane_api_test.go, (新規: app_input_history.go, app_input_history_types.go, app_input_history_test.go) |
| **B. バックエンド: セッションログ改善** | 2 | app_session_log.go, app_session_log_test.go |
| **C. バックエンド: 設定・テスト** | 5 | config.go, config_test.go, config.yaml, testutil/helpers.go, command_router_env_test.go, command_router_handlers_window_test.go |
| **D. フロントエンド: ビューアーシステム** | 10 | ViewerSystem.tsx, viewerRegistry.ts, ActivityStrip.tsx, viewerShortcutDefinitions.ts, viewerShortcutUtils.ts, 各views/*/index.ts |
| **E. フロントエンド: 設定画面** | 6 | SettingsModal.tsx, KeybindSettings.tsx, settingsReducer.ts, settingsValidation.ts, types.ts, settingsValidation.test.ts |
| **F. フロントエンド: エラーログ・同期** | 8 | main.tsx, ErrorBoundary.tsx, logFrontendEventSafe.ts, useBackendSync.ts, api.ts, types/tmux.ts, wailsjs/* |
| **G. Go 1.26 モダナイゼーション** | 3 | app_devpanel_api.go, app_session_api_test.go, testutil/helpers.go |

---

## Critical Issues (2件)

### C-1. `testutil.Ptr` の `//go:fix inline` ディレクティブ重複
- **[code-reviewer]**: `myT-x/internal/testutil/helpers.go:16-17`
- `//go:fix inline` が2行連続で記述されています。これはコピーペーストミスと考えられます。
- Go の `//go:fix inline` はコンパイラディレクティブであり、重複記述は意図されていません。1行にすべきです。
- **同様箇所**: `command_router_env_test.go:16` にも `boolPtrTest` 関数に `//go:fix inline` が付与されていますが、こちらは1行のみで正常です。

```diff
 //go:fix inline
-//go:fix inline
 func Ptr[T any](v T) *T { return new(v) }
```

### C-2. `new(true)` / `new(false)` 構文の Go 互換性確認
- **[code-reviewer]**: `app_session_api_test.go`, `command_router_env_test.go`, `command_router_handlers_window_test.go` の複数箇所
- `new(true)` は Go 1.26 の `go fix` によるインライン展開結果ですが、`new` ビルトインは従来 **型** を引数に取る関数です（`new(bool)` で `*bool` を返す）。`new(true)` のように **値** を渡す構文は Go 1.26 で導入された新しい仕様であることを確認する必要があります。
- Go 1.26 では `new(v)` で `v` のコピーへのポインタを返す新しいオーバーロードが追加されています。CLAUDE.md に「Go言語は、1.26が最新」と記載があるため、この変更自体は正当です。
- **ただし**、`boolPtrTest` 関数が `app_session_api_test.go:10` に定義されていますが、差分内で実際に使用されている箇所が見当たりません。未使用関数として残っている可能性があります。

---

## Important Issues (12件)

### I-1. `parseInputHistoryFileName` と `parseSessionLogFileSortKey` のロジック重複
- **[code-simplifier]**: `app_input_history.go:57-78` vs `app_session_log.go:53-75`
- セッションログとインプット履歴の両方にほぼ同一のファイル名パース関数が存在します。プレフィックス（`session-` / `input-`）のみ異なります。
- 共通のヘルパー関数に抽出して DRY 原則に従うことを推奨します。
- 同様に `cleanupOldInputHistory` と `cleanupOldSessionLogs` も構造がほぼ同一です。

### I-2. `sortInputHistoryFilesForCleanup` と `cleanupOldSessionLogs` のソートロジック差異
- **[code-reviewer]**: `app_input_history.go:80-102` vs `app_session_log.go:99-121`
- セッションログのソートでは非標準名が末尾に配置されますが（`return leftOK` で OK なものを前に）、インプット履歴では非標準名が先頭に配置されます（`return !leftOK` で非OK を前に）。
- この動作差異は **意図的** かもしれませんが（非標準名を先に削除するため）、同じクリーンアップ目的で動作が異なるのは混乱を招きます。統一するか、差異が意図的であることをコメントで明記すべきです。

### I-3. `resolveSessionNameForPane` のエラーハンドリング
- **[silent-failure-hunter]**: `app_pane_api.go:9-19`
- `ResolveTarget` 失敗時にデバッグログを出力して空文字列を返していますが、`SendInput` / `SendSyncInput` からは戻り値がチェックされません。
- セッション名が空文字列の場合、input history エントリの `session` フィールドが空になり、フロントエンド側でセッションによるフィルタリングが困難になります。
- 現状の動作自体は安全ですが（セッション名はオプショナル扱い）、将来のフィルタリング機能追加時に問題になる可能性があります。

### I-4. `SendInput` / `SendSyncInput` での `recordInput` 呼び出しの位置
- **[code-reviewer]**: `app_pane_api.go:55-56`, `app_pane_api.go:70-71`
- `recordInput` は `sessions.SendInput()` / `sessions.SendSyncInput()` の **成功後** に呼ばれていますが、`resolveSessionNameForPane` は成功後に改めて `sessions` を使ってセッション名を解決しています。
- `recordInput` がエラーなしの場合のみ実行されるのは正しい設計です（失敗した入力は記録しない）。

### I-5. `initInputHistory` の呼び出し順序
- **[code-reviewer]**: `app_lifecycle.go:161`
- `initInputHistory()` が `slog.SetDefault()` の直後、`config.EnsureFile()` の **前** に呼ばれています。
- `configPath` は `NewApp()` で設定済みのため問題はありませんが、設定ファイルの読み込み前にファイルI/Oを行うことになります。
- `initSessionLog()` が同様の位置で呼ばれているため、一貫性があります。

### I-6. `inputLineBuffers` の nil マップ初期化
- **[code-reviewer]**: `app_input_history.go:267-269`
- `inputLineBuffers` は `NewApp()` では初期化されず、`recordInput` 内で遅延初期化されています。
- `flushAllLineBuffers`（shutdown時）は nil チェックを行っていますが、`flushLineBuffer`（タイマー起動）も `exists` チェックで安全にハンドリングしています。
- ただし、`NewApp()` で `inputLineBuffers` を初期化する方が防御的です。`sessionLogEntries` や `snapshotCache` は `NewApp()` で初期化されています。

### I-7. `ViewerSystem.tsx` のショートカットハンドリング変更
- **[code-reviewer]**: `ViewerSystem.tsx:74-94`
- 従来は `e.ctrlKey && e.shiftKey` のガードがありましたが、新しいコードでは `buildShortcutFromKeyboardEvent` を無条件に呼び出しています。
- `buildShortcutFromKeyboardEvent` は modifier キー単独押下では空文字を返すため安全ですが、**修飾キーなしの通常キー入力もすべてマッチング対象になる** ようになっています。
- たとえばユーザーが "e" キーでショートカットを設定した場合、テキスト入力中に意図せずビューが開閉する可能性があります。
- **推奨**: 少なくとも1つの修飾キー（Ctrl/Shift/Alt/Meta）が必要というガードを追加すべきです。

### I-8. `ActivityStrip.tsx` の依存配列
- **[code-reviewer]**: `ActivityStrip.tsx:51`
- `renderViewButton` の `useCallback` 依存配列に `viewerShortcutsConfig` が追加されていますが、`viewerShortcutsConfig` はオブジェクト参照です。
- `useTmuxStore` は config 更新のたびに新しいオブジェクト参照を返す可能性があり、不要な再レンダリングが発生する可能性があります。
- これは既存の他のストア使用パターンと一致しているため、パフォーマンス上の問題が顕在化しない限り許容範囲です。

### I-9. `settingsValidation.ts` のバリデーションロジック
- **[code-reviewer]**: `settingsValidation.ts:11-44`
- `validateViewerShortcuts` は `getEffectiveViewerShortcut` を使って実効ショートカットを計算し、重複チェックを行っています。
- ただし、`normalizeShortcut` が空文字列を返すケース（不正なショートカット形式）に対するエラーメッセージがありません。
- たとえば `+++` のような無効な値を入力した場合、正規化結果が空文字列となり、単にスキップされます。ユーザーへのフィードバックが不足しています。

### I-10. `useBackendSync.ts` の `logFrontendEventSafe` 呼び出しの一貫性
- **[code-reviewer]**: `useBackendSync.ts:237, 248, 263, 468, 473, 483, 497`
- 起動時の3つの失敗ケースに `logFrontendEventSafe` が追加されていますが、他の部分（例: `onEvent("tmux:snapshot-delta"...)` のエラーパス）には追加されていません。
- 全てのエラーパスに一貫して追加するか、重要度に基づく選択基準をコメントで明示すべきです。

### I-11. `boolPtrTest` 関数の重複定義
- **[code-reviewer]**: `app_session_api_test.go:10` と `command_router_env_test.go:16`
- `boolPtrTest` が2つのテストファイルで独立して定義されています。
- 同じパッケージ内であれば定義が衝突する可能性があります（`app_session_api_test.go` は `main` パッケージ、`command_router_env_test.go` は `tmux` パッケージなので衝突しません）。
- ただし、`testutil.Ptr` が既に存在し `//go:fix inline` でインライン化されるのであれば、`boolPtrTest` のような別名関数を新たに定義する必要性が不明確です。

### I-12. `app_devpanel_api.go` の `strings.SplitSeq` 使用
- **[code-reviewer]**: `app_devpanel_api.go:10`
- `strings.SplitSeq` は Go 1.26 で追加されたイテレーター版ですが、`for line := range strings.SplitSeq(normalized, "\n")` の `line` は `string` 型で、元の `for _, line := range strings.Split(...)` と動作は同等です。
- ただし、`strings.SplitSeq` は結果をスライスとして保持しないため、大量の行がある場合にメモリ効率が向上します。
- 変更自体に問題はありませんが、他の `strings.Split` 使用箇所に同様の変更が適用されていない点が不一致です。

---

## Suggestions (10件)

### S-1. 入力履歴のリングバッファとセッションログのリングバッファの共通化
- **[code-simplifier]**: `app_input_history_types.go` vs 既存の `sessionLogRingBuffer`
- `inputHistoryRingBuffer` と `sessionLogRingBuffer` はほぼ同一の構造をしています（型パラメータが異なるのみ）。
- Go 1.26 のジェネリクスを活用して、共通のリングバッファ型 `RingBuffer[T any]` に統合することを推奨します。

### S-2. `InputHistoryView.tsx` の CSS クラス再利用
- **[code-simplifier]**: `InputHistoryView.tsx`
- `error-log-*` CSSクラスを再利用していることがコメントで説明されていますが、意味論的に `error-log` と `input-history` は異なるコンテキストです。
- 将来的に独自のCSS名前空間（`input-history-view`, `input-history-body` 等）を用意し、共通スタイルは別途抽出することを推奨します。

### S-3. `logFrontendEventSafe` のテストカバレッジ
- **[pr-test-analyzer]**: `frontend/tests/logFrontendEventSafe.test.ts` が存在するが差分には含まれていません。
- テストが最新の実装と整合しているか確認してください。

### S-4. `viewerShortcutDefinitions.ts` と各 `views/*/index.ts` の同期保証
- **[comment-analyzer]**: `viewerShortcutDefinitions.ts:8`
- "Keep this list in sync with viewer registrations under views/*/index.ts." とコメントがありますが、同期が壊れた場合のランタイムエラー検出は `mustGetViewerShortcutDef` のみに依存しています。
- DEVモードでのスタートアップチェック（登録されたビューIDが全て定義に存在するか）を追加することを推奨します。

### S-5. `normalizeShortcut` の空白混在入力への対応
- **[code-reviewer]**: `viewerShortcutUtils.ts:27-53`
- `Ctrl + Shift + E` のようにプラス記号の前後にスペースが含まれる入力は、`split("+")` で正しくトークン化され、各トークンの `trim()` で処理されます。
- ただし、`Ctrl++` のようなプラスキー自体をショートカットにする場合は空トークンが発生します。現在のフィルタ `token !== ""` で除外され、プラスキーは利用できません。これは Windows アプリとしては許容範囲です。

### S-6. `main.tsx` の `Symbol.for()` によるHMR対策
- **[code-reviewer]**: `main.tsx:15-18`
- `Symbol.for("mytx.global.error.handlers")` を使ってHMRでのリスナー重複を防止する設計は適切です。
- ただし、`globalThis` へのキャストが冗長です。型定義を別途ファイルに切り出すと見通しがよくなります。

### S-7. `config.yaml` のコメントアウトされたショートカット設定
- **[comment-analyzer]**: `config.yaml:9-16`
- 新しい `viewer_shortcuts` セクションが日本語コメント付きで追加されていますが、AGENTS.md に「基本的にファイルへの書き込みには、全て英語を利用する事」と記載があります。
- config.yaml は設定ファイルであるため、「既存の日本語のコメントや画面表示は変更しない事」のルールを適用して日本語コメントを許容するか、英語に変更するか判断が必要です。
- **ただし**: 既存の config.yaml に日本語コメントが含まれていた場合は変更不要です（AGENTS.md ルール通り）。

### S-8. `parseSessionLogFileSortKey` の timestamp 長チェック
- **[code-reviewer]**: `app_session_log.go:68`
- `len(timestamp) != len("20060102-150405")` は定数 `15` と比較するよりも意図が明確で良いですが、`len("20060102-150405")` は15文字です。将来的にこの値を const にすると再利用性が高まります。

### S-9. `ErrorBoundary` の再試行ボタンの動作
- **[code-reviewer]**: `ErrorBoundary.tsx:47-49`
- `handleReset` は `hasError` を `false` にリセットするだけですが、根本原因が解消されていない場合、同じエラーが即座に再発する可能性があります。
- リトライ回数の上限やバックオフ機構の追加を検討してください。

### S-10. `useBackendSync.ts` の Input History 同期コードの構造的重複
- **[code-simplifier]**: `useBackendSync.ts:555-614`
- `fetchErrorLog` と `fetchInputHistory` のコード構造がほぼ同一です。
- 汎用的な「ping + fetch」パターンを関数に抽出して、DRY 原則に従うことを推奨します。

---

## Strengths（良い点）

1. **ロック設計の一貫性**: `inputHistoryMu` と `inputLineBufMu` の分離設計が明確で、ロック順序のドキュメントが充実しています（`app.go:30-31`）。
2. **リングバッファの採用**: `O(1)` の push 操作で大量のエントリを効率的に管理しています。
3. **テストカバレッジ**: 新規機能に対して包括的なテーブル駆動テストが用意されています（`app_input_history_test.go`: 1141行）。
4. **防御的コーディング**: `logFrontendEventSafe` の fire-and-forget パターン、`ErrorBoundary` の React エラー境界、グローバルエラーハンドラの HMR 対策が適切です。
5. **ショートカット正規化**: `normalizeShortcut` による修飾キー順序の統一が、設定値とキーボードイベントの比較を安全にしています。
6. **セッションログソートの改善**: PID の数値ソートにより、同一タイムスタンプのファイル順序が正確になりました。
7. **フロントエンドイベントの永続化**: UI エラーがバックエンドのセッションログに記録されるようになり、デバッグ効率が向上しています。
8. **Go 1.26 対応**: `CutPrefix`, `SplitSeq`, `new(v)` 等のモダンな構文への移行が適用されています。
9. **スロットリング設計**: `inputHistoryEmitMinInterval` (50ms) による IPC 負荷の制御が適切です。
10. **設定のディープコピー**: `config.Clone()` に `ViewerShortcuts` のマップコピーが正しく追加されています。

---

## Recommended Action

1. **Critical Issues (C-1, C-2)** を最優先で修正する
2. **Important Issues (I-1〜I-12)** を優先度に応じて対応する
3. Suggestions は将来の改善として検討する
4. 修正後にレビューを再実行する

---

## 並列作業可否テーブル

以下は各指摘事項のタスク化と、並列作業の可否を整理した表です。

### 並列作業テーブルの見方

| 記号 | 意味 |
|---|---|
| ✅ | 他タスクとの依存関係なし。並列作業可能 |
| ⚠️ | 条件付きで並列可能（依存先を先に完了すれば可） |
| ❌ | 他タスクと排他。順序制約あり |

### タスク一覧と並列作業判定

| タスクID | 重要度 | 対象ファイル | 修正内容 | 並列可否 | 依存関係・備考 |
|---|---|---|---|---|---|
| **C-1** | Critical | `internal/testutil/helpers.go` | `//go:fix inline` の重複削除 | ✅ | 他ファイルに影響なし。1行削除のみ |
| **C-2** | Critical | `app_session_api_test.go` | 未使用の `boolPtrTest` 関数の削除確認 | ✅ | `app_session_api_test.go` のみ。Go 1.26の `new(v)` 構文はそのまま |
| **I-1** | Important | `app_input_history.go`, `app_session_log.go` | ファイル名パース関数の共通化 | ⚠️ | I-2 と同時に実施推奨。共通ヘルパーの設計が必要 |
| **I-2** | Important | `app_input_history.go`, `app_session_log.go` | ソートロジックの差異のコメント明記または統一 | ⚠️ | I-1 と同時に実施推奨 |
| **I-3** | Important | `app_pane_api.go` | `resolveSessionNameForPane` のドキュメント改善 | ✅ | コメント追加のみ |
| **I-4** | Important | `app_pane_api.go` | 設計確認のみ（修正不要） | — | 確認タスク。修正なし |
| **I-5** | Important | `app_lifecycle.go` | 設計確認のみ（修正不要） | — | 確認タスク。修正なし |
| **I-6** | Important | `app.go` (NewApp) | `inputLineBuffers` の初期化追加 | ✅ | `NewApp()` 関数のみの変更 |
| **I-7** | Important | `ViewerSystem.tsx` | 修飾キー必須ガードの追加 | ✅ | フロントエンドのみ。バックエンドに影響なし |
| **I-8** | Important | `ActivityStrip.tsx` | パフォーマンス確認（修正不要の可能性） | — | 確認タスク |
| **I-9** | Important | `settingsValidation.ts` | 無効ショートカット形式のバリデーション追加 | ✅ | フロントエンドのバリデーションのみ |
| **I-10** | Important | `useBackendSync.ts` | `logFrontendEventSafe` の一貫性確保 | ✅ | フロントエンドのみ |
| **I-11** | Important | `app_session_api_test.go`, `command_router_env_test.go` | `boolPtrTest` の必要性確認・整理 | ⚠️ | C-2 と同時に確認推奨 |
| **I-12** | Important | `app_devpanel_api.go` | 他の `strings.Split` 箇所への `SplitSeq` 適用検討 | ✅ | 独立したリファクタリング |
| **S-1** | Suggestion | `app_input_history_types.go` | ジェネリックリングバッファの共通化 | ⚠️ | I-1 と関連。大規模リファクタリング |
| **S-2** | Suggestion | `InputHistoryView.tsx` | CSS クラス名の整理 | ✅ | フロントエンドのみ |
| **S-3** | Suggestion | `logFrontendEventSafe.test.ts` | テストの最新性確認 | ✅ | テストファイルのみ |
| **S-4** | Suggestion | `viewerShortcutDefinitions.ts` | DEV モードでの同期チェック追加 | ✅ | フロントエンドのみ |
| **S-5** | Suggestion | `viewerShortcutUtils.ts` | エッジケースの文書化 | ✅ | コメント追加のみ |
| **S-6** | Suggestion | `main.tsx` | 型定義の整理 | ✅ | フロントエンドのみ |
| **S-7** | Suggestion | `config.yaml` | コメント言語の判断 | ✅ | 設定ファイルのみ |
| **S-8** | Suggestion | `app_session_log.go` | タイムスタンプ長の定数化 | ✅ | 独立した変更 |
| **S-9** | Suggestion | `ErrorBoundary.tsx` | リトライ上限の追加 | ✅ | フロントエンドのみ |
| **S-10** | Suggestion | `useBackendSync.ts` | ping+fetch パターンの共通化 | ✅ | フロントエンドのみ |

### 並列作業のグルーピング推奨

作業者が複数いる場合、以下のグループ分けで効率的に並列作業できます：

| グループ | 担当範囲 | 含まれるタスク | 備考 |
|---|---|---|---|
| **Group A: バックエンドGo** | Goファイルの修正 | C-1, C-2, I-1, I-2, I-3, I-6, I-11, I-12, S-1, S-8 | I-1 と I-2 は同時に着手推奨 |
| **Group B: フロントエンドReact** | TSX/TSファイルの修正 | I-7, I-9, I-10, S-2, S-3, S-4, S-5, S-6, S-9, S-10 | 全て独立して作業可能 |
| **Group C: 設定・ドキュメント** | config.yaml等 | S-7 | 独立タスク |

**注意**: Group A 内の I-1, I-2, S-1 は相互に関連するため、**同一作業者が担当** することを推奨します。

---

## 本番コードベースとの整合性確認結果

差分レビューに加えて、本番コードも含めた調査を実施しました。

### 新規ファイル確認結果

| ファイル | 存在確認 | 状態 |
|---|---|---|
| `app_input_history.go` | ✅ | 580行。差分外の新規ファイル。ロジック問題なし |
| `app_input_history_types.go` | ✅ | 121行。型定義。問題なし |
| `app_input_history_test.go` | ✅ | 1141行。包括的テスト。問題なし |
| `inputHistoryStore.ts` | ✅ | 87行。Zustandストア。問題なし |
| `viewerShortcutDefinitions.ts` | ✅ | 32行。定義ファイル。問題なし |
| `viewerShortcutUtils.ts` | ✅ | 89行。ユーティリティ。問題なし |
| `logFrontendEventSafe.ts` | ✅ | 24行。安全なラッパー。問題なし |
| `ErrorBoundary.tsx` | ✅ | 68行。React エラー境界。問題なし |
| `ViewerShortcutSettings.tsx` | ✅ | 40行。設定UI。問題なし |
| `views/input-history/` | ✅ | 3ファイル。InputHistoryView.tsx, index.ts, useInputHistory.ts |
| `InputHistoryIcon.tsx` | ✅ | `icons/InputHistoryIcon.tsx` に存在。差分外の新規ファイル。問題なし |

### 周辺影響範囲の確認

1. **`testutil.Ptr` の使用箇所**: 本番コード内では全て `new(v)` にインライン化済み。`testutil.Ptr` 関数自体は残存している（`//go:fix inline` 付き）ため、今後のインライン化のフォールバックとして機能。
2. **`config.Config` のフィールド数ガードテスト**: `12` に正しく更新されている。
3. **Wails バインディング生成ファイル（`App.d.ts`, `App.js`, `models.ts`）**: 自動生成ファイルとして適切に更新されている。
4. **`useBackendSync` のクリーンアップ**: 新規タイマー（`inputHistoryDebounceTimer`, `inputHistoryRetryTimer`）のクリーンアップが return 関数に正しく追加されている。
5. **ビュー登録順序**: `ViewerSystem.tsx` で import 順序がサイドバーアイコンの表示順序を決定する設計になっており、コメントでルールが明確に文書化されている。
