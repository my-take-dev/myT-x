# コードレビュー統合レポート

**作成日時**: 2026年02月24日 08:34
**レビュー対象**: `D:\myT-x\dev-myT-x\review\temp` 配下の差分（入力履歴、ビューアーショートカット、フロントエンドエラーログ等）

本レポートは、3つの独立したレビュー結果（20260224073615, 20260224074322, 20260224080946）を、内容が重複しないように集約・整理した統合版です。

---

## 1. Critical Issues & Bugs (最優先修正事項)
実行時エラー、コンパイルエラー、または深刻な機能不全を引き起こす問題です。直ちに修正を行ってください。

* **[CRIT-1] `new(v)` の誤用によるポインタ値破壊** (`internal/testutil/helpers.go`, 各種テストファイル)
  * `testutil.Ptr(v)` 内部で `return new(v)` と記述されていますが、Goの `new` 関数は「型」を受け取るため、値を渡すと仕様違反となり意図しない初期値ポインタが返却されます。
  * `return &v` に修正してください。併せて各テストコード群で使用されている `new(true)`, `new(false)` の直接記述を `testutil.Ptr(true)` などの正しい記述にすべて置換してください。
* **[CRIT-2] `//go:fix inline` の重複記述** (`internal/testutil/helpers.go:16-17`)
  * コンパイラディレクティブがコピー＆ペーストミスにより2行連続で記述されています。1行削除してください。
* **[CRIT-3] 未使用関数 `boolPtrTest` の残存** (`app_session_api_test.go` 等)
  * 定義されていますが未使用のデッドコードです。削除を推奨します。
* **[BUG-1] `cleanupOldSessionLogs` のソート方向が逆** (`app_session_log.go`)
  * 上限到達時に古いログを削除するロジックで `return leftOK` となっており、正常なファイルから優先的に削除される致命的なバグです。`inputHistory` と同様に `return !leftOK` へ修正してください。
* **[BUG-2] DCS/SOS/PM/APC ターミナルシーケンスのスキップ漏れ** (`app_input_history.go`)
  * `processInputString` でエスケープシーケンス判定中、これらが `default:` に落ちて元の文字として流れてしまいます。終端 (`ST`) までスキップする新しいステートを追加してください。
* **[BUG-3] `InputHistoryView` のバッジフリッカー描画問題** (`InputHistoryView.tsx`)
  * `useEffect` を使って既読マーカーをつけているため、エントリ追加時に非同期描画でバッジが一瞬フリッカーします。ペイント前にフックする `useLayoutEffect` へ変更してください（`ErrorLogView` と揃える）。
* **[BUG-4] 入力制御文字の正規表現フィルタリング漏れ** (`useInputHistory.ts`)
  * `formatInputForDisplay` の変換用正規表現 (`/[\x00-\x08\x0b\x0c\x0e-\x1f]/g`) から CR(`\x0d`), LF(`\x0a`), DEL(`\x7f`) が漏れており、ターミナルユーザーの `^M` などの入力が正しく変換されず改行や空白になります。

## 2. High & Important Issues (重要修正事項)
実装の不整合や意図しない影響・設計の原則違反に対する修正です。

* **[HIGH-1] `resolveSessionNameForPane` の引数削減及びエラー処理** (`app_pane_api.go`)
  * 第1引数に `sessions *tmux.SessionManager` を受け取っていますが、レシーバ (`a *App`) メソッドのため `a.sessions` が直に参照できます。冗長な引数を削減してください。
  * 失敗時に空文字を返す設計ですが、呼び出し元から黙殺されています。将来の問題を防ぐためコメントまたは対応を追加。
* **[HIGH-2] 変数 `ok0` の非標準的なシャドウイング** (`app_devpanel_api.go`)
  * `strings.CutPrefix` 実行時の戻り値で `ok0` を使用していますが、Goのイディオムから外れます。標準の `ok` でシャドウイングするように修正してください。
* **[HIGH-3] ショートカット設定のモディファイアキー必須化** (`settingsValidation.ts`, `ViewerSystem.tsx`)
  * 単一キー（`"f"`, `"a"`等）がビューアーショートカットとして通過してしまいます。最低一つのモディファイア（Ctrl/Shift/Alt/Meta）を含むかのバリデーションを追加してください。
* **[HIGH-4] Global Hotkey との競合チェック漏れ** (`settingsValidation.ts`)
  * メインウィンドウ呼び出し用の `globalHotkey` と、サイドバービューアー側のショートカットが全く同じキーに設定された場合の検証が行われていません。
* **[HIGH-5] `ActivityStrip` の OCP (開放閉鎖の原則) 違反** (`ActivityStrip.tsx`)
  * バッジ表示数が `view.id === "error-log"` 等とハードコードされています。レジストリ等で各ビューアがバッジ情報を柔軟に提供できるように設計を見直してください。
* **[HIGH-6] `settingsReducer.test.ts` フィールドガード検証の陳腐化** (`settingsReducer.test.ts`)
  * `INITIAL_FORM` に `viewerShortcuts` が追加されましたが、キー数チェックなどのガードテストが更新されていません。
* **[HIGH-7] `normalizeKeyboardKey` のデッドコード** (`viewerShortcutUtils.ts`)
  * 三項演算子の両分岐 (`rawKey.length === 1`) で全く同じ `.toLowerCase()` 処理が行われており無意味になっています。

## 3. Medium Issues (要改善・対応事項)
中規模の改善タスクや、各エッジケースへの対応です。

* **[MED-1] O(N) の文字列再構築コストの改善** (`app_input_history.go`)
  * バックスペース (`\x08`, `\x7f`) 処理で毎度 `strings.Builder` を再構築しているため、`[]rune` 配列による管理に変更し O(1) に最適化してください。
* **[MED-2] 非同期シャットダウン後の残留タイマー競合** (`app_input_history.go`)
  * 終了指示(`closeInputHistory`)後でも発火した残留タイマーによる `recordInput` → ファイル書き込みが行われるリスクがあります。終了フラグ `shuttingDown` 等でガードしてください。
* **[MED-3] `ErrorBoundary` 無限再試行問題** (`ErrorBoundary.tsx`)
  * リセット上限がないため、永続的エラーで無限に再試行ボタンが押せます。3回程度のカウント制限を追加してください。
* **[MED-4] UI 及びキー操作周りの不整合**
  * `ShortcutInput` コンポーネントで `Meta` キーが捕捉されない動作 (`ViewerShortcutSettings.tsx`)
  * `shortcutMap` 重複登録時、タイトルは最初のビュー優先・実効設定は後のビュー優先になるなどの不透明な競合の警告処理。
  * `getEffectiveViewerShortcut` が未正規化文字列を返すケースがある。
* **[MED-5] 初期化とカバレッジ不足の補填**
  * `NewApp()` 内で `inputLineBuffers` マップの初期化が漏れています (`app.go`)。
  * `TestNormalizeLogLevel` に `"WARNING"` （全て大文字）のケースの追加 (`app_session_log_test.go`)。
  * トランケーションテスト時に `initSessionLog()` の呼び出し追加。
* **[MED-6] `inputHistoryStore.ts` コメントの乖離** (`inputHistoryStore.ts`)
  * 「再起動後の全エントリが既読扱い」になる実装と、「未読マーカーをクリアする」の記述などバックエンド再起動後のコメントが乖離しています。

## 4. Low & Suggestions (最適化・提案)
パフォーマンス、コードの統一感、UX やアクセシビリティ向上を目的とする変更です。

* **Goバックエンド関連**
  * `LogFrontendEvent` ログ長切り詰め: 長い場合のみ `[]rune()` アロケーションするよう、`utf8.RuneCountInString` の判定を先に挟む。
  * ファイル名のパースや、`pendingEntry` 構造体重複などの類似コード群のリファクタリング及び共通化(`cleanOld...`等)。
  * `isAllDecimalDigits` を削除し `strconv.Atoi` にエラーを一任。`RingBuffer[T any]` を用いたジェネリクス化、定数の切り出し、冗長代入文(`source != ""`)の整理など。
* **フロントエンド関連**
  * `SettingsModal.tsx` で設定保存の際にキーボードショートカット情報を `trim()` する。
  * `<label>` タグと `input` 間の `htmlFor`, `id` 属性付与などアクセシビリティ担保。
  * Windows 環境にて、`Alt+` 系ショートカット登録時、システム制御系との競合可能性を UI 上で警告表示する機能。
  * `InputHistoryView.tsx` の `markAllRead` フックの依存配列を `entries.at(-1)?.seq` など対象を絞り過剰な発火を抑止。
  * 同期エラー処理時、`fetchInputHistory` 側にも `catch` の `console.warn` 等を付与する。

---

## 🏗️ 並列作業表 (タスク管理用)

修正タスクを、関連性およびファイル競合を回避するようにグループ化しました。複数エージェントや作業者で並行して取り掛かる際に便利です。

| タスクID | 優先度 | タスク内容 | 対象ファイル | 並列可否 | 依存・備考 |
|---|---|---|---|:---:|---|
| **P-1** | 🔴 CRIT | `new(true)` / `new(v)` ポインタバグの完全修正、および `//go:fix inline` 重複の除去 | `helpers.go`<br>`*_test.go` | **可能** | 最優先。全バックエンドのテストが誤った動作をしているため、まず着手。 |
| **P-2** | 🔴 CRIT | 未使用 `boolPtrTest` 関数・デッドコードの削除 | 各テストファイル | **可能** | P-1と同ジャンルで直ぐに処理可能。 |
| **P-3** | 🔴 BUG | `cleanupOldSessionLogs` 削除ルールの逆転バグ (`return !leftOK`) 修正 | `app_session_log.go` | **可能** | 正規ファイルの消失を防ぐ重大修正。本番ロジックに影響。 |
| **P-4** | 🔴 BUG | `processInputString` での DCS / PM などのエスケープシーケンススキップ漏れの対応 | `app_input_history.go` | **可能** | 入力履歴機能のロジック固有。 |
| **P-5** | 🟡 HIGH | `resolveSessionNameForPane` 引数削減、および `ok0` → `ok` シャドウイングの修正 | `app_pane_api.go`<br>`app_devpanel_api.go` | **可能** | バックエンドの軽微で独立したリファクタ。 |
| **P-6** | 🟡 HIGH | フロントのレンダルフリッカー対応 (`useLayoutEffect` 切替)、CR/LF等の正規表現適正化 | `InputHistoryView.tsx`<br>`useInputHistory.ts` | **可能** | フロント専任タスクとして完全に機能別で分離可能。 |
| **P-7** | 🟡 HIGH | ショートカット設定のバリデーション強化（モディファイア必須、競合検知、デッドコード削除） | `settingsValidation.ts`<br>`viewerShortcutUtils.ts`<br>`ViewerSystem.tsx` | **可能** | 設定関連ロジックに限定しており並列での安全な着手が可能。 |
| **P-8** | 🟠 MED | `ActivityStrip` のバッジ表示ハードコーディングを解消する OCP リファクタリング | `ActivityStrip.tsx`<br>その他関連設定 | **可能** | UIコンポーネントにおける拡張性の設計変更。 |
| **P-9** | 🟠 MED | 非同期タイマー残留対策(`shuttingDown` フラグ)、`[]rune`のO(1)パフォーマンス改善対応 | `app_input_history.go` | **注意** | P-4の修正と修正ファイルが被るため、順番に対応するか同一担当者が実施。 |
| **P-10**| 🟠 MED | テストの拡充（`WARNING`、`initSessionLog`、初期設定値など）と `ErrorBoundary` リトライ上限追加 | Goテスト群<br>`ErrorBoundary.tsx` | **可能** | 独立性の高い修正群。安全にアサイン可能。 |
| **P-11**| 🟢 LOW | 最適化など提案事項の対応（Rune字数最適化、入力値のTrim、UIアクセシビリティ対応等） | 各該当ファイル群 | **可能** | バージョン影響などを確認の上、細かく分散してアサイン可能。 |

**【並列作業に関する推奨事項】**
* バックエンド担当者は **P-1, P-2** (テスト修復) と **P-3, P-4** (ロジック修復) の両優先グループを順番に各個撃破することが可能です。
* フロントエンド担当者は **P-6, P-7, P-8** を同時に着手しても影響範囲が被らない（View, Settings, Layout）ため、コンフリクトせず安全に並列対応可能です。
