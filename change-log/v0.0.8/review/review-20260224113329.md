# myT-x PR レビュー統合結果まとめ

**レビュー日時:** 2026-02-24 11:33
**対象ファイル:** `D:\myT-x\dev-myT-x\review\temp` に出力された複数ファイルの差分
**レビュー方式:** 複数エージェントによる検証結果の重複排除および統合

---

## 🛑 検出された問題と指摘事項

### 🔴 Critical Issues（必須修正）

| ID | ファイル | 指摘事項 |
| :--- | :--- | :--- |
| **C-1** | `app_input_history.go` | **`flushLineBuffer` シャットダウンチェックによるデータ消失**<br>`inputLineBufMu` ロック解放直後の `shuttingDown.Load()` チェックで return してしまうと、リングバッファに書き込まれずデータが永久消失します。第2のガードは不要なため削除してください。 |
| **C-2** | `app_session_log_test.go` | **テストデータ内の文字化け・意図確認**<br>`strings.Repeat("譌･", ...)` が指定されていますが、UTF-8の複数文字になっており、意図したルーンカウントや1文字のマルチバイト文字（`"日"`など）か確認が必要です。 |
| **C-3** | `viewerShortcutUtils.ts` | **`hasShortcutModifier` でのF1〜F12等・単一キー無効化の懸念**<br>無条件に修飾キーなしを無効化すると、`F1`〜`F12`など単独で成立すべきショートカットも機能しなくなります。ファンクションキーの例外追加など、妥当な設計対応（および到達不能なチェック等冗長コードの整理）を実施してください。 |

### 🟡 Important Issues（強く推奨）

| ID | ファイル | 指摘事項 |
| :--- | :--- | :--- |
| **I-1** | `app_input_history_test.go` | **`TestRecordInput_IgnoredDuringShutdown` 暗黙依存**<br>テスト内の `App` 構造体初期化時に `inputLineBuffers` が初期化されておらず実装変更で落ちるリスクがあるため、明示的初期化を行ってください。 |
| **I-2** | `app_session_log.go` | **セッションログ ソートバグ修正のテスト担保**<br>`return !leftOK` によるバグ修正自体は正しいですが、malformedファイルが先にソート（削除）されることを検証するテストケースが不足しています。追加してください。 |
| **I-3** | `config_test.go` | **テスト内の OS 依存パス利用**<br>Windows絶対パス `C:\Users\...` の使用によりLinux等のテストが壊れます。`t.TempDir()` またはOS判定ガードを利用してください。 |
| **I-4** | `settingsValidation.ts` | **エラーメッセージの日本語統一**<br>既存メッセージは日本語ですが、新設エラーで `At least one modifier key is required` と英語が混ざっています。「修飾キーが必要です」などに統一してください。 |
| **I-5** | `SessionView.tsx` | **`SetActiveSession` フロント・バックの更新順序**<br>`QuickStartSession` 後、APIを叩く前にStoreを更新しています。API失敗時に不整合が生じる上、バックエンド側でも発行処理があるため二重更新になります。API成功後にStoreを更新するように順序を整理してください。 |
| **I-6** | `GeneralSettings.tsx` | **アクセシビリティ考慮不足 (`label`/`input` id紐付け)**<br>DefaultSessionDir 用の `<input>` に `id` がなく `<label>` に `htmlFor` がありません。また、フロント側でパスの入力規則（絶対パス）バリデーションも行うとUXが向上します。 |
| **I-7** | `app_pane_api.go` | **`resolveSessionNameForPane` シグネチャ変更による二重取得**<br>呼び出し元で既にセッション取得済みであるにも関わらず、内部で再度 `requireSessions` を呼び出すため二重ロックになっています。また、失敗時の大量デバッグログの出力頻度に注意（許容範囲か検討）してください。 |
| **I-8** | `app_session_api.go` | **`QuickStartSession` 仕様検討（TOCTOU、Symlink）**<br>セッション名衝突時等のTOCTOU競合が許容である旨のコメント追記。また `os.Stat` 時にシンボリックリンク対応（`EvalSymlinks`）や、`ClaudeEnv`等の初期設定をどう引き継ぐかの検討が推奨されます。 |
| **I-9** | `InputHistoryView.tsx` | **`entries.at(-1)` の後方互換性**<br>新設された `Array.prototype.at` は未ポリフィルだとレガシー環境で動かない可能性があります。`entries[entries.length - 1]` への変更が無難です。 |
| **I-10** | `ShortcutInput.tsx` | **既存コメントの英語化**<br>`AGENTS.md` の運用ルール上、既存の日本語コメントを英語化することが妥当か念の為確認してください。 |

### 🟢 Suggestions（改善提案・リファクタリング）

| ID | 関連スコープ | 指摘事項 |
| :--- | :--- | :--- |
| **S-1** | Go バックエンド | `app_input_history.go`: `skipEscString` の戻り値が非対称（BELはインデックス反復、STはインデックス加算）である理由のコメント明記やインライン関数の見直し。 |
| **S-2** | Go / OS | `app.go`: `launchDir` と `workspace` が別管理である意図のコメント追記。<br>`internal/testutil`: `Ptr(true)` 化が他のテストファイルもカバーできているか全体確認。 |
| **S-3** | Go バックエンド | `app_session_api.go`: `QuickStartSession` の `%q` エラーフォーマット利用、および各所の「セッション名による探索 (`Snapshot()` 連携処理)」の共通ヘルパー関数化。 |
| **S-4** | Go バックエンド | `app_session_log.go`: `utf8.RuneCountInString` 活用による最適化（アロケーション回避）の実装意図をコメントに明記。 |
| **S-5** | フロントエンド | `settingsValidation.ts`, `ViewerSystem.tsx`: `normalizeShortcut` が各所で重複呼び出しされているため、1回の呼び出しに削減し効率化する。 |
| **S-6** | フロントエンド | `settingsValidation.test.ts`: デフォルトのショートカット値とグローバルホットキーが競合した場合のエラーテストを追加。 |
| **S-7** | フロントエンド | `ActivityStrip.tsx`: `useSyncExternalStore` 第3引数の省略や、ボタンごとの不要な再レンダリング防止のための `React.memo` 化。 |
| **S-8** | フロントエンド | `index.ts`: ErrorLogとInputHistoryで共通化された Badge API (`getBadgeCount`, `subscribeBadgeCount`) 処理を外部ヘルパー化。<br>それにまつわるRegistryへの制約方針を説明。 |
| **S-9** | フロントエンド | `ErrorBoundary.tsx`: リトライ上限到達時にボタンの `title` 属性で「上限到達のためリロードしてください」等、ユーザーへの表示を追加。 |
| **S-10** | 環境・設定 | `.gitattributes` 追加: LF改行統一のため、`*.tsx`, `*.ts`, `*.go` の `text eol=lf` 定義追加を推奨。 |

---

## 📊 並列作業可否・タスク割り当て表

本レビューに基づいて修正作業を行うためのタスク管理表です。
「領域」が異なるタスクはコンフリクトなく**完全に並列で作業可能**です。

| 領域 | タスク群 (依存順の推奨) | 関連ファイル | 担当・作業優先度 |
| :--- | :--- | :--- | :--- |
| **Go バックエンド <br>(入力履歴・ログ)** | 1. **C-1** (Critical・データ消失回避)<br>2. **I-1** (テスト初期化)<br>3. **I-2** (ソートテスト追加)<br>4. **S-1, S-4** (コメント等の整備) | `app_input_history.go`<br>`app_input_history_test.go`<br>`app_session_log.go / test` | バックエンド担当<br>🔴 最優先進行推奨 |
| **Go バックエンド <br>(構成・セッション)** | 1. **I-3** (OS依存デバッグ)<br>2. **I-7, I-8** (APIシグネチャ・TOCTOU)<br>3. **S-2, S-3** (共通化・安全策)<br>4. **C-2** (テスト文字化け原因) | `config_test.go`<br>`app_pane_api.go`<br>`app_session_api.go`<br>`app_session_log_test.go` | バックエンド担当<br>🟡 高優先度 |
| **フロントエンド <br>(ショートカット)** | 1. **C-3** (Critical・Fキー対応)<br>2. **I-4** (日本語エラー化)<br>3. **I-10** (英語化コメント確認)<br>4. **S-5, S-6** (DRY・テスト追加) | `viewerShortcutUtils.ts`<br>`settingsValidation.ts / test` | フロントエンド担当<br>🔴 最優先進行推奨 |
| **フロントエンド <br>(UI・その他連携)** | 1. **I-5** (Store更新順序)<br>2. **I-6, I-9** (id付与, at後方互換)<br>3. **S-7, S-8, S-9** (Memo化/抽出) | `SessionView.tsx`<br>`GeneralSettings.tsx`<br>`InputHistoryView.tsx`<br>`ActivityStrip.tsx` 他 | フロントエンド担当<br>🟡 独立並行可 |
| **Git / 環境** | 1. **S-10** (CRLF修正) | `.gitattributes` (新規) | プロジェクト管理者<br>🟢 作業序盤に追加 |

> **チームへのアドバイス:**
> * Go側 (バックエンド) と React側 (フロントエンド) を担当するエージェント（またはチーム）を2手に分ければ、相互のコンフリクトを気にせず独立して進めることができます。
> * 各チームは表の上から直列順に消化していくと手戻りがありません。
