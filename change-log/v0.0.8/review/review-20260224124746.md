# 差分（及び本番コード）のレビュー結果

本番プロジェクトの周辺ファイル構成や環境を考慮し、周辺の影響範囲や差異も含めて深く確認を行いました。一括での修正や、サブエージェントごとの作業割り当て・並行処理を効率よく行えるよう、変更内容をカテゴリ別に分けてレビューを実行・整理しています。以下の項目は `.github/prompts/review-pr-para.prompt.md` の要求事項に則した分析結果です。

## カテゴリ基準（並列作業単位での分割）

サブエージェントへのアサインなどに活用できるよう、相互依存の小さい4つのカテゴリに分割しました。

1. **Go Backend: config & session** (設定パースおよびセッション起動系 `app_session_api`, `config.yaml`, `config_test`)
2. **Go Backend: input-history & events** (バッファ・ログ処理系 `app_input_history`, `app_session_log`)
3. **Frontend: Settings UI** (設定ダイアログ・キーバインド入力コンポーネント)
4. **Frontend: Viewers Badging** (Viewer表示状態管理およびリアクティブリロード)

---

## 🚀 Critical Issues (クリティカルな問題)
現在のところ、早期クラッシュや直接的なデータ破壊に繋がる致命的な（Critical）問題は検出されませんでした。差分は全般的に安定しており、コーナーケースへのテストも十分記述されています。

---

## ⚠️ Important Issues (重要な指摘)

### 【Go Backend: config & session】
- **[silent-failure-hunter] `~` (ホームディレクトリ) プレフィックスのサポート不足**:
  - **対象箇所**: `internal/config/config.go` (`validateDefaultSessionDir`)
  - **指摘**: `filepath.IsAbs(dir)` での検証処理において、`~/my-project` といったホームディレクトリ由来の相対指定（ユーザー入力によく見られます）がパースされず、空文字として強制クリアされます。保存されない事の警告ログは出ますが、ユーザーからはサイレントな失敗に見え、「何度設定しても反映されない」といった混乱を招くリスクがあります。`IsAbs` 判定前に `os.UserHomeDir()` とを用いた `~` の展開を行う処理を追加することを推奨します。
- **[code-reviewer] ペイン情報復元時のRace condition懸念**:
  - **対象箇所**: `app_session_api.go` (`QuickStartSession`)
  - **指摘**: 作成済みディレクトリに対して `a.setActiveSessionName(conflict)` を呼び出した後、UIへの同期イベントを送っていますが、該当セッションが裏で終了・ダウンしていた場合などのサニティチェック（存在確認の保証）が、わずかなレイテンシ（TOCTOU）の狭間で保証されません。実用上大きな問題になりにくいですが、可能であれば Activate 直前に tmux の Session 存在確認をもう一度だけ挟み込むか、該当セッションでのリトライ機構を構えるとより万全です。

### 【Go Backend: input-history & events】
- **[silent-failure-hunter] `.shuttingDown` ロックの隙間とタイマーのLeak懸念**:
  - **対象箇所**: `app_input_history.go` (`resetLineBufferTimer` , `flushLineBuffer`)
  - **指摘**: シャットダウン状態を `a.shuttingDown.Load()` で見ていますが、`time.AfterFunc` 自身が生成されて発火するまでの排他とシャットダウン時のキャンセル処理にわずかに競合リスクがあります。実害が出ないように防御されていますが、より堅牢にするため、タイマーの実行処理自体のクロージャー内で再度判定するか、全体の `inputLineBufMu` を取得した中で `shuttingDown` フラグによる早期リターンを処理するように整理すると良いでしょう。

### 【Frontend: Settings UI】
- **[type-design-analyzer] `ShortcutInput.tsx` での「単独キー」の挙動（UXの乖離）**:
  - **対象箇所**: `ShortcutInput.tsx` (`if (parts.length === 0 && !FUNCTION_KEY_PATTERN.test(keyName)) return;`)
  - **指摘**: F1～F24以外のキー（例えば `Esc`, `Insert`, `Delete` など）を修飾キー（Ctrl, Alt等）なしで設定しようとした際、キー情報が無視され `return` されます。仕様上意図されている挙動だとしても、UI側で「修飾キーを含めてください」といった警告が発生しないため、ユーザーが入力に失敗したのかバグなのか判別できません。エラーを吐き出すか一時的なフィードバックを設けるべきです。

### 【Frontend: Viewers Badging】
- **[code-simplifier] `ErrorBoundary.tsx` での `retryCount` リセット時の処理構造**:
  - **対象箇所**: `ErrorBoundary.tsx`
  - **指摘**: 継続的なクラッシュを防ぐ `retryCount` は見事な実装ですが、これらが発火して `setState` が回る際、根本となる `props` （あるいはエラーの起因状態）を変えずに再レンダリングするだけなら即座にまた落ちてループするケースがあります。親コンポーネントに対してリトライアクションをフックできるコールバックか状態リフレッシュを渡す設計があると、さらに汎用的になります。

---

## 💡 Suggestions (改善提案・推奨事項)

- **[comments] `ST` エスケープシーケンス判定へのコメント付与**:
  `skipEscString`（`app_input_history.go`）のロジックが、後続でそのまま親の for ループの `idx++` を流用するために `idx + 1` を返しています。効率的ですがトリッキーな挙動であるため、 `// Return string terminator index, allowing outer loop 'i++' to jump cleanly past it.` のように処理意図のコメントを追加することで、後のサブエージェントや開発者が読み違えるのを防げます。
- **[tests] Arrayプロトタイプにおける `.at()` 使用脱却の統一**:
  Zustandストア（`inputHistoryStore.ts`, `errorLogStore.ts`）で `entries.at(-1)` が Safari/古いWebView2 などでの後方互換性のために `entries[entries.length - 1]` に最適化されていました。同様の旧式ブラウザをターゲットにするのであれば、ESLint設定側（`eslint-plugin-unicorn` 等）または全体プロジェクトレベルで `.at()` の禁止ルールを入れておくことで一括自動指摘が可能になり、他の箇所での使用漏れを防げます。

---

## ✨ Strengths (評価すべき点)

- **メモリとアロケーションの最適化**:
  `app_input_history.go` のパースにおいて `strings.Builder` を捨てて `[]rune` 型に一本化し、さらに長さをスライスの `len` やキャパシティ操作で管理するアプローチは非常に効率的であり、パフォーマンス要件を見事に満たしています。
- **StoreとRegistryの疎結合化**:
  `ActivityStrip.tsx` において Reactの `useSyncExternalStore` をフックとし、ViewerRegistry 自身は React Zustand に直接依存せず `subscribeBadgeCount` や `getBadgeCount` インターフェースのみを提供したことで、モジュラリティが劇的に向上しています。
- **エッジケースのテスト網羅**:
  シャットダウン時に入力履歴が flush されないためのガードや、マルチバイト（日本語）に対しての長すぎるログの文字数超過処理対応も `utf8.RuneCountInString` を使って安全に実装されており、優れたテストが担保されています。

---

## 📅 タスク整理 ＆ 並列作業・問題有無の一覧（作業者向け）

複数のサブエージェントおよび開発者が円滑に作業にあたれるよう、指摘内容を整理しタスク化しました。各タスクの並行作業に影響がないかを明記しています。

| タスクID | カテゴリ | 修正内容 / タスク概要 | 並列作業可否 | 懸念点 / 備考 / 干渉リスク |
| :---: | :--- | :--- | :---: | :--- |
| **Task 01** | Go Config | `validateDefaultSessionDir` 内にて、`~`（Homedir）を使った相対パス入力を解決（`os.UserHomeDir` による展開処理の実装）。 | **🟢 全く問題なし** | 他ファイルと干渉なし。既存のパースロジックの最上段に追加するだけで対応可能です。 |
| **Task 02** | Go Input Hist | `skipEscString` の戻り値に関する動作意図コメントの追加と、`timer` 関連排他制御ブロックによる安全なガード強化。 | **🟢 全く問題なし** | 単一ファイル内でのロジックの微修正に留まるため、他機能と干渉せず安全に並列実施できます。 |
| **Task 03** | フロント: Settings | `ShortcutInput.tsx` で修飾キー不足時（Fキー以外）に、入力を弾くだけでなくTooltip等での警告・UX視覚的フィードバックの実装。 | **🟢 全く問題なし** | 設定ダイアログ内の独立したコンポーネントであり、検証ロジックやGoバックエンドとのコンフリクトは発生しません。 |
| **Task 04** | フロント: Viewer | `ErrorBoundary` でリトライ時に子要素の状態リセットを行うための工夫（`key` の再生成など）またはフォールバック補完。 | **🟢 全く問題なし** | Viewレイヤーの基盤ですが、他のコンポーネント表示機能（Task03など）とは完全に切り離して作業可能です。 |
| **Task 05** | DevOps / CI | JavaScriptコード全体へ向けて、`.at(-1)` 使用禁止などのブラウザ後方互換考慮向け Lint / Rule ルールの強制・適用。 | **🟡 一部注意** | `.eslintrc` など共通設定の修正になるため、導入後に他サブエージェントが生成するコードへのLint適用確認が必要です。 |

> **💡 作業の進め方**：カテゴリ（Goバックエンドとフロントエンド）間で完全に依存がカットされており、`Task 01〜04` は完全に独立して同時にサブエージェントに割り振り、修正を進めることが可能です。
