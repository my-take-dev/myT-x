# 包括的コードレビュー報告 (統合版)

## 概要
複数の観点で実施されたコードレビュー結果（差分的影響・アーキテクチャ・エラーハンドリング等）を統合し、重複を排除しました。修正の優先度に基づき「Critical（修正必須）」「Important（重要な指摘）」「Suggestions（改善提案）」の3つのレベルに分類しています。下部には、サブエージェントや開発者がコンフリクトなく効率的に作業を進められるよう、タスクの並列実行性を示すマトリックスを整備しました。

---

## 🔴 Critical Issues (クリティカルな課題・修正必須)

1. **[C1] `app_session_api.go`: QuickStartSession 既存セッション活性化時のスナップショット欠落**
   - 既存セッションを返す `conflict` パスを通った際、`a.requestSnapshot(true)` が呼ばれていないため、アクティベートさせてもUI（セッションリストやサイドバー）に反映されない。
2. **[C2] `app_session_api_test.go`: QuickStartSession の単体テスト欠落**
   - 新規追加された関数のテストがなく、`DefaultSessionDir` 設定時のフォールバックや未設定・無効パス指定時のエッジケースに関するリグレッションが検知できない。
3. **[C3] `QuickSearch.tsx`: セッション切り替え失敗時のエラーサイレント失敗**
   - APIリクエスト（`SetActiveSession`）失敗時に例外をキャッチしてもユーザーへ通知がない。Sidebar側の実装に合わせ、`addNotification` を用いて警告を表示すること。
4. **[C4] `QuickSearch.tsx`: API待機中のUIブロック**
   - セッションクリック後、バックエンドAPIを待機する設計になったため、ローディング表示のないままダイアログが開いた状態になり無反応と誤認される。
5. **[C5] `ErrorBoundary.tsx`: リトライ上限(MAX_RETRIES)到達後の脱出不可状態**
   - 3回目以降のクラッシュでリトライボタンが押せなくなり、アプリ全体が「詰み」状態になる。代替アクション（アプリの再起動指示など）を提示する必要がある。
6. **[C6] `viewerShortcutUtils.ts`: ファンクションキー判定のバグ**
   - `buildShortcutFromKeyboardEvent` 内の `FUNCTION_KEY_PATTERN` が大文字の "F" に対応しておらず（`/^f...$/`）、単独のファンクションキー設定（例: F12）が全て弾かれ機能しなくなっている（`/i` フラグの追加が必要）。

---

## 🟡 Important Issues (重要な課題・対応推奨)

### 🚀 バックエンド領域 (Go)
7. **[I1] `internal/config/config.go`: `~`（ホームディレクトリ）の展開サポート不足**
   - `validateDefaultSessionDir` において `~/my-project` が無効とみなされる。`os.UserHomeDir()` を利用した展開を行うべき。
8. **[I2] `internal/config/config.go`: 正規化漏れ**
   - `validateDefaultSessionDir` で `filepath.Clean` が走っていないため、非正規化パスがそのまま保存される。
9. **[I3] `internal/config/config_test.go`: `filepath.ToSlash` の不整合**
   - `TestLoadDefaultSessionDir` などのテストで強制的にスラッシュへ変換しており、プロジェクト内での比較検証ロジックの一貫性が損なわれている。
10. **[I4] `app_session_api.go`: セッション名のドライブルートガード漏れ**
    - `string(os.PathSeparator)` を除外しているが、Windows での `C:\` といったドライブルートがパスされた場合に防ぎきれない。
11. **[I5] `app_session_api.go`: `QuickStartSession` の TOCTOU 懸念**
    - セッション存在チェック直後から活性化処理間に裏でセッションがダウンした場合のカバーが薄い。
12. **[I6] `app_session_api.go`: 二重スナップショットの取得**
    - `findSessionByRootPath` 内部で行った直後に `requireSessions` で再度取得しており、無駄なオーバーヘッドと意図しない TOCTOU ウィンドウを作っている。
13. **[I7] `app_input_history.go`: `timerGen` の uint64 オーバーフローとセンチネル衝突**
    - シャットダウン時のセンチネル値 `gen=0` とオーバーフロー後の数値が衝突する理論上のバグが存在。
14. **[I8] `app_input_history.go`: シャットダウン判定ロックの隙間（Timer Leak）**
    - `time.AfterFunc` 実行中にシャットダウンフラグ判定を再度評価せず、中途半端にタイマープロセスが回るリスクがある。
15. **[I9] `app_input_history_test.go`: テストケース不足**
    - DCS/SOSエスケープシーケンス内での `BEL` (`\x07`) 含有パターンのテストが存在しない。
16. **[I10] `app.go`: Read-Only保証コメントの不在**
    - `launchDir` フィールドが `startup()` 以降読み取り専用であることがドキュメント化されていない。

### 🎨 フロントエンド領域 (React / TypeScript)
17. **[I11] `ShortcutInput.tsx`: バリデーションパターンの重複とフィードバック不足**
    - `viewerShortcutUtils.ts` と `FUNCTION_KEY_PATTERN` が重複。修飾キー無しのキー（Fキー以外）を入力した際、ただ無視されエラー表示（UXフィードバック）が出ない。
18. **[I12] `SessionView.tsx`: `QuickStartSession` のコンポーネントアンマウント対策**
    - 非同期呼び出し中に別画面へ遷移した場合の `setQuickStartLoading(false)` 等によるReactステート更新エラーのリスクがある。
19. **[I13] `SessionView.tsx`: `String(err)` の冗長表示コード**
    - エラーメッセージフォーマッタが `ErrorBoundary.ts` (toErrorMessage) と重複実装されており、「Error: 」などのプレフィクスが不格好に露出する可能性。
20. **[I14] `settingsValidation.ts`: globalHotkeyとの競合判定後のcontinue欠如**
    - 競合が検出された後に `continue` されていないため、無関係な後続処理に乗ってしまう。
21. **[I15] `SettingsModal.tsx`: Quake Mode 無効時の過剰な競合チェック**
    - Quake Mode 無効時にもグローバルホットキーの重複チェックが入っており、正しく機能しない場合がある。
22. **[I16] `viewerShortcutUtils.ts`: テスト不足と Dead Code**
    - 結合テスト不足や `hasShortcutModifier` 関数内に到達不能コードが残存している。
23. **[I17] `errorLogStore.ts`: 実態と合わないコメント**
    - "clear" と記載されているのに実際はマーカーを "align" する動作となっている。
24. **[I18] `ActivityStrip.tsx`: React.memo の欠如**
    - `ActivityButton` コンポーネントにメモ化処理がなく、ペイン切り替えごとに全ボタンが不用意に再レンダリングされる。
25. **[I19] `base.css`: フォーカスインジケータ欠如**
    - `.session-quick-start-btn:focus-visible` が定義されておらず、キーボード操作時のアクセシビリティが損なわれている。

---

## 🟢 Suggestions (改善提案・ベストプラクティス)

26. **[S1] 文字列切り詰めのシングルパス最適化**:
    - `app_session_log.go` の UTF-8 クリップ処理において、`[]rune` 全変換を行う代わりにイテレーションベース（1パス・アロケーション不要）なロジックに変更してパフォーマンス向上。
27. **[S2] コメントによる動作の明文化**:
    - `app_input_history.go` の `skipEscString` の戻り値 `idx+1` の意味、および `lb.buf = lb.buf[:0]` でメモリ保持（キャパシティ再利用）を意図している点についてコメントを追及。
    - `InputHistoryView.tsx` の描画チラツキ防止目的の `useLayoutEffect` についてもコメント明示。
28. **[S3] CSS・UI・Lint規則の統一**:
    - `base.css` 内の `transition` 指定ショートハンドのプロジェクト内統一化。
    - `GeneralSettings.tsx` のクリアボタンに対する `aria-label` 追加。
    - Safariなど古いブラウザへ配慮し `.at(-1)` プロパティの使用をプロジェクトLint制限する等の運用ルールの追加。
29. **[S4] 拡張テストケースの追加**:
    - `config_test.go` に UNC パスや空値 (omitempty挙動) にまつわるテストケースの拡充。

---

## ✨ Strengths (本PRの優れた点)

- **GoとReactでの高度なパフォーマンス・メモリ最適化**: 文字列バッファのゼロアロケーション指向へのリファクタ（`[]rune`の活用）が光る。
- **アーキテクチャの疎結合化**: `useSyncExternalStore` や Event Subscriber を駆使し、ViewerRegistry の React への直接依存を剥がした非常に優れた IOC が実施されている。
- **アクセシビリティ対応**: 設定モーダル等で `label` / `htmlFor` が正しくマッピングされ、操作性が確実によくなっている。

---

## 📅 作業分解と並列実行マトリックス (Task Execution Table)

複数のサブエージェントが効率的にコミットを進めるためのテーブルです。
カテゴリ分離・責務分離が明確なため、ほとんどのタスクは**コンフリクトなしで完全並行稼働**できます。

| タスク ID | カテゴリ | 修正内容 / タスク概要 | 並列性 | 優先度 / ブロッカー | 推奨エージェント |
|---|---|---|:---:|---|---|
| **T01** | Go API | [C1] `QuickStartSession` 内での conflict 時スナップショット発行処理の追加 | ◎ | **Critical** (単独実施) | Go/Backend |
| **T02** | Go Test | [C2] `QuickStartSession` のテーブル駆動単体テスト追加 | △ | **Critical** (T01完了後) | Go/Backend |
| **T03** | React UI | [C3] `QuickSearch` のエラーハンドリング ( `addNotification` 連携) | ◎ | **Critical** | Frontend |
| **T04** | React UI | [C4] `QuickSearch` ダイアログ内のローディング・待機表示実装 | △ | **Critical** (T03実装と同列作業) | Frontend |
| **T05** | React UI | [C5] `ErrorBoundary` リトライ上限時の復帰不可問題解消 (リセット等の案内UI追加) | ◎ | **Critical** | Frontend |
| **T06** | React Util | [C6] `viewerShortcutUtils.ts` 内の `FUNCTION_KEY_PATTERN` 正規表現 大文字対応化 | ◎ | **Critical** (T11と統合作業可) | Frontend/Logic |
| **T07** | Go Config | [I1, I2, I3] `config.go` 等のチルダ展開・`filepath.Clean` 正規化周りの補修 | ◎ | Important | Go/Backend |
| **T08** | Go API | [I4, I5, I6] `app_session_api` 周りの TOCTOU、重複スナップ取得、パスガードの整理 | △ | Important (T01の後を推奨) | Go/Backend |
| **T09** | Go History | [I7, I8, I9] 入力履歴周りのタイマー・エッジケーステストの強化 | ◎ | Important | Go/Backend |
| **T10** | React UI | [I11～I15, I21] Settingsや連携コンポーネント(ShortcutInput等)のUX・イベントガード・重複排除・メモ化 | ◎ | Important | Frontend |
| **T11** | React Util | [I16, I17] Shortcut検証系のロジック掃除 (dead code削除とバグ修正) | ◎ | Important | Frontend/Logic |
| **T12** | CSS/Misc | [I18, I19, I20, 全 Suggestions] 各コンポーネントへのコメント追加、CSS修飾、toErrorMessage共通化等の雑務まとめ | ◎ | Important 〜 Sug | Frontend / Go |

> **💡 進め方の推奨アプローチ**
> 1. まず各 Critical タスク (T01, T03, T05, T06) を最優先で並行実行してください。これらは相互干渉しません。
> 2. `QuickStartSession` 周りのバグ修正(T01)を行ってから、それに被せるようにテスト(T02)やリファクタ(T08)をキューに入れるとコンフリクトを完全に回避できます。
> 3. T07, T09, T10, T11 については、他と影響し合わないためいつでも着手・マージ可能です。
