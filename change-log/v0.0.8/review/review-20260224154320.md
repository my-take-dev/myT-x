# 包括的コードレビュー報告書 (PR Review Summary)

## 差分ファイルのカテゴリ分類（サブエージェント並列処理用）

サブエージェントに効率よく割り当てるため、差分ファイルを以下の4つのカテゴリに分類しました。これらは互いに依存度が低く、並列でレビュー・修正作業が可能です。

1. **カテゴリA: フロントエンドUI・セッション制御** (`QuickSearch.tsx`, `SessionView.tsx`, `SettingsModal.tsx`, `GeneralSettings.tsx`, `Sidebar.tsx`, `types/tmux.ts`)
2. **カテゴリB: フロントエンドショートカット・ビュー制御** (`viewerShortcutUtils.ts`, `ViewerSystem.tsx`, `ActivityStrip.tsx`, `viewerRegistry.ts`, `settingsValidation.ts` 等)
3. **カテゴリC: バックエンド・入力履歴管理** (`app_input_history.go`, `app_input_history_types.go`, `app_input_history_test.go`)
4. **カテゴリD: バックエンド・セッション＆設定管理** (`app_session_api.go`, `config.go`, `app_session_log.go`, 各種testファイル)

---

## 周辺の影響範囲・本番コードを踏まえたレビュー結果

### Critical Issues (マージ前の修正必須)
(なし) 現段階の差分および本番コード周辺の解析において、クリティカルなバグ（クラッシュ、深刻なセキュリティリスク、大幅な機能破壊）は見当たりませんでした。全体的にミューテックスでの保護やTOCTOU考慮が含まれており、大変堅牢に実装されています。

### Important Issues (修正を強く推奨)
- **[react-error-boundary / state]**: `QuickSearch.tsx` において、`selectResult` 実行時に `finally` ブロック内で `setSwitching(false)` を呼び出していますが、`onClose()` によってコンポーネントがアンマウントされていた場合、Reactの `setState on unmounted component` 警告が発生する可能性があります。
  - **提案 [カテゴリA]**: 今回の変更で `SessionView.tsx` に実装されている `mountedRef` と同じ安全策（マウント時のみ state を更新するパターン）を `QuickSearch.tsx` にも導入してください。

- **[ux-regression / side effects]**: `viewerShortcutUtils.ts` の `hasShortcutModifier` 関数にて、モディファイアキー（Ctrl, Shift等）が存在しない場合に許可されるのが ファンクションキー (`F1`~`F24`) のみに制限されました。これにより、過去に `Escape` や `Delete` など単一キーをビューアのショートカットに登録していた既存ユーザーは、次回設定保存時に検証エラーになったり、サイレントにショートカットが無効化されたりする「破壊的変更」を受けます。
  - **提案 [カテゴリB]**: ユーザーの既存の作業環境（設定ファイル）を踏まえた破壊的変更であるため、UI上で該当する項目に「このショートカットは無効です」という警告を追加するか、自動的に旧設定をパージする旨の丁寧なUXアナウンスを検討してください。

### Suggestions (改善提案・リファクタリング)
- **[config-defaults / code]**: `app_session_api.go` の `QuickStartSession` にて、セッションの作成のフォールバックとして `CreateSession(dir, sessionName, CreateSessionOptions{})` を呼び出しています。この時 `CreateSessionOptions`（`UseClaudeEnv`, `UsePaneEnv`）が全てゼロ値 (`false`) になります。クイックスタートでもユーザーが設定画面でオンにしたデフォルト設定を引き継いだほうが自然な挙動になる可能性が高いです。
  - **提案 [カテゴリD]**: 運用・業務要件を再確認し、必要であれば `opts` の生成時に `cfg.PaneEnvDefaultEnabled` 等を参照するように動作をリファクタリングしてください。

### Strengths (良い実装・設計)
- **[tests/quality]**: `config_test.go` で `NumField()` を使い、新しい設定構造体フィールドが追加された際にテストのアップデート漏れを自動で防ぐ仕組みは非常に効果的で保守性が高いです。
- **[performance / string processing]**: `app_session_log.go` の `truncateRunes` にて、`for byteIndex := range s` トラップを利用して `s[:byteIndex]` を返すマルチバイト文字の切り捨て手法（サロゲートペアや絵文字で文字化けを起こさせない安全なスライス操作）は極めて効率的かつGoのベストプラクティスに沿っています。`app_input_history.go` における `[]rune` 内部へのバッファリング変更によりアロケーションの無駄も抑制されています。
- **[concurrency]**: `app_session_api.go` の `QuickStartSession` における `findSessionByRootPath` の TOCTOU（Time of Check to Time of Use）対策。スナップショット取得とのギャップでセッションが消失したことを想定した安全なフォールバック設計は素晴らしいです。

---

## 修正タスク整理と並列作業可否

上記から導出された修正タスクを作業者目線で整理しました。
これらはファイルや機能モジュール間の依存性が低く、**すべて並列で作業することが可能です（ブロックする問題はありません）**。

| No | タスク概要 | 対象ファイル / カテゴリ | 並列作業可否 | 備考・注意点 |
|:---|:---|:---|:---:|:---|
| 1 | QuickSearch のアンマウント時警告対応 | `QuickSearch.tsx` (カテゴリA) | **可** | `useRef` を用いたマウント状態判定を導入してください。他のフロントエンドコンポーネントとの干渉はありません。 |
| 2 | ショートカット制限のUX/UI対応 | `viewerShortcutUtils.ts`<br>`settingsValidation.ts` (カテゴリB) | **可** | Fキー以外の単一キー無効化に伴う検証エラー文言の調整、またはレガシー設定のパージ時の警告処理追加等。 |
| 3 | クイックスタート時のオプション（フラグ）精査 | `app_session_api.go` (カテゴリD) | **可** | `CreateSessionOptions{}` に渡すフラグ（ClaudeEnv連携等）が `false` のままで業務要件を満たすか確認・修正してください。 |

※ 【カテゴリC】（Input History周りやテスト）については特に対応すべき不具合や懸念事項がないため、タスクとしては起票不要です（そのまま検証通過・マージ可能です）。
