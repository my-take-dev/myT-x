# 統合コードレビュー報告書

## 概要
4つのレビューファイル（2026-02-24 15:43〜15:51に出力）の指摘内容を整理・統合した最新のレビュー結果です。重複した指摘（例: `QuickSearch.tsx` のアンマウント時ステート問題、TOCTOU問題など）は一貫性を持たせ集約し、修正の難易度や影響範囲ごとに再分類しています。

---

## 🛑 重大な問題 (Critical Issues)

1. **[C1] `ShortcutInput.tsx` — 修飾キー押下でキャプチャが即終了するバグ**
   - **内容**: `Control`, `Shift` 等の修飾キー単体押下時に `setCapturing(false)` を呼び出しているため、それに続くキー入力が認識されず、すべての修飾子付きショートカット（Ctrl+Aなど）が入力不能になっています。
2. **[C2] `app_session_api.go` — `QuickStartSession` での環境変数・チルダの展開漏れ**
   - **内容**: フロントでは `%VAR%` や `~` を許可していますが、バックエンド（`os.MkdirAll` 等）で自動展開されません。`filepath.EvalSymlinks` の前段に `os.ExpandEnv` 等の展開処理が必須です。
3. **[C3] `layout.css` — 未定義CSS変数による背景色透過**
   - **内容**: `.quick-search-loading` に指定された変数（`--bg-secondary`, `--bg-dim`）が存在せず、ロード時に背景が透過しUI要素が重なって表示されます。
4. **[C4] `testutil/helpers.go` — `Ptr[T]` バグのテスト影響確認**
   - **内容**: `new(v)` の誤用によるバグ自体は今回の差分で修正済みですが、旧コードが存在した期間の既存テストが誤って通過していた可能性があります。テストの信頼性担保のため再実行・確認が必要です。

---

## ⚠️ 重要な問題 (Important Issues)

### バックエンド (Go)
5. **[I1] `app_session_api.go` — `QuickStartSession` の TOCTOU の懸念と冗長処理**
   - `os.Stat` して存在しなければ `os.MkdirAll` する処理が冗長かつ非スレッドセーフ（TOCTOU）です。`os.MkdirAll` を先行しその後に状態判定を行うよう修正してください。
6. **[I2] `app_input_history.go` — シャットダウン境界でのエントリ消失パス**
   - `shuttingDown.Store(true)` と `flushAllLineBuffers()` の間に競合ウィンドウがあり、シャットダウン直前のエンターなし入力がフラッシュされずに消失する恐れがあります。
7. **[I3] `app_devpanel_api.go` — 変数シャドウイング**
   - `ok0 → ok` のリネームにより、`if renamedFrom, ok := ...` などが外側の `ok` をシャドウしている箇所が2つあります。
8. **[I4] `config.go` — Windows パス内の `$` 記号の POSIX 変数誤展開**
   - Windows環境で `C:\Users\foo$bar` などのパスが誤ってPOSIX変数として展開される懸念があります。OSごとの差異を処理してください。
9. **[I5] `app_session_api.go` — `slog.Warn` プレフィックスの規約違反**
   - 警告ログに `[DEBUG-SESSION]` プレフィックスが付与されています。規約に従い `[WARN-SESSION]` に修正してください。

### フロントエンド (UI)
10. **[I6] `QuickSearch.tsx` — アンマウント時のステート更新・ハング**
    - 非同期処理完了後に `onClose` でコンポーネントがアンマウントされているにも関わらず、`setSwitching(false)` を呼び出しているため React警告（メモリリークの危険）が出ます。`mountedRef` でのガードや Promise タイムアウト処理が必要です。
11. **[I7] `viewerShortcutUtils.ts` — ショートカット制限の破壊的変更の影響**
    - F1〜F24以外の単一キー登録が無効化されました。過去にエスケープ等の単一キーを登録した既存ユーザーに対し、設定UIで明確なエラー表示・UX対応を追加する必要があります。
12. **[I8] `SessionView.tsx` — `mountedRef` と Strict Mode**
    - React Strict Mode のダブルマウント挙動において、クリーンアップ時に `false` となったフラグが再マウント時に `true` に戻るよう `useEffect` 全体を見直してください。
13. **[I9] `GeneralSettings.tsx` 等 — UIとアクセシビリティの不備**
    - `handlePickDefaultDir` 失敗時のエラー通知UI連動漏れと、`ShortcutInput` や `<select>` 群のラベル `htmlFor` - `id` リレーション欠落があります。

### テスト関連 (Tests)
14. **[I10] テストコードの拡充とクリーンアップ (`app_session_api_test.go`, `config_test.go`, `app_input_history_test.go`)**
    - `QuickStartSession` の空パス等のエラーケース追加、環境変数暗黙依存の排除、SOS/APC/PMの重複エスケープシーケンステストの統合が必要です。

---

## 💡 改善・提案 (Suggestions)
- **ターミナル制御**: C1コントロールの8ビットST `\x9c` の捕捉追加（`app_input_history.go`）。
- **コード堅牢性**: APIコールのハング対応として Promise.race タイムアウト等のフェイルセーフ追加（`QuickSearch.tsx`）。
- **ドキュメント**: 変数 `workspace` の並行アクセスコメント追記。`truncateRunes` への振る舞い注釈追加。JSDoc のコントラクト追記。
- **UI微調整**: `<button>` タグ全てへの `type="button"` 設定漏れ予防やアルファベット順インポートの遵守。

---

## 🌟 評価できる点 (Strengths)
1. **メモリアロケーションの大幅な最適化**: `[]rune` のキャパシティ再利用や `truncateRunes` のスライス直接抽出など、Goでのゼロアロケーション手法が非常に優れています。
2. **非カノニカルファイルのソート順変更**: 古い不完全なログファイルから安全に削除されるロジックへの修正は実用的で素晴らしい改善です。
3. **セーフティ機構の導入**: シャットダウン用タイマーセンチネル（`^uint64(0)`）の実装や各種nilガードなど堅牢性が飛躍的に高まっています。

<br>

---

## 📋 並列表（タスクアサイン）

タスク間の依存関係やコンフリクトを回避すべく、ファイル群・カテゴリでまとめた**並行作業可否の分類マトリクス**です。サブエージェントは各グループを並行して安全に担当できます。

※ **[Global]** のインデント修正タスクは大規模なGitコンフリクトを招くため、**全ての修正完了後、または一番最初**に単独のステップとして実施してください。

| 並行Grp | タスクID | 優先度 | 対象コンポーネント / ファイル | 主な修正内容 | 備考・依存等 |
| :---: | :--- | :--- | :--- | :--- | :--- |
| **G** | **[Global-1]** | 全体 | **フロントエンド全般** | 広範囲のインデント変更(2→4スペース)の統一とPrettier等でのFormat適用 | ※他タスクとの並列不可、前後どちらかに単独で実施 |
| **A** | **[C1]** | Critical | `ShortcutInput.tsx` | 修飾キー押下でのキャプチャ即終了バグ修正 | フロントUI。独立タスク |
| **B** | **[C2], [I1], [I5]** | Critical | `app_session_api.go` | 環境変数・チルダ自動展開漏れの対応、TOCTOU回避（`MkdirAll`先行リファクタ）、ログのプレフィックス名称変更 | バックエンド。ファイルが同一なため1エージェントで一括作業 |
| **C** | **[C3]** | Critical | `layout.css` | `.quick-search-loading` の背景色（CSS変数）定義修正 | CSS修正。独立タスク |
| **D** | **[C4], [I10]** | Important| 各種 `*_test.go`,<br>`testutil/helpers.go` | `Ptr[T]`の全テスト検証、テストケース追加（エラー/環境変数/重複整理） | テストコード全般の保守 |
| **E** | **[I2]** | Important| `app_input_history.go` | シャットダウン境界入力ロス防止、 ST `\x9c` 対応(任意) | 入力履歴機能。独立タスク |
| **F** | **[I3]** | Important| `app_devpanel_api.go` | `ok0 -> ok` による変数シャドウイングの解消 | API機能。独立タスク |
| **G2** | **[I4]** | Important| `config.go` | Windows上のPOSIX変数 `$` 誤展開バグの挙動修正 | Config機能。独立タスク |
| **H** | **[I6], [I8]** | Important| `QuickSearch.tsx`, `SessionView.tsx` | アンマウント時のReact警告回避(`mountedRef`)、Strict Mode時のマウント挙動対応 | ステート管理・ライフサイクル。UI系として一括対応推奨 |
| **I** | **[I7], [I9]** | Important| `GeneralSettings.tsx`, `viewerShortcutUtils.ts` | ショートカット破壊的変更へのUI警告等の連動、未設定ラベル/エラー通知対応 | UIコンポーネント・フィードバック関連 |

> 💡 **進め方のヒント**:
> ① まず初めに **[Global-1]** について方針を決定（あるいは先に適用）します。
> ② グループ **A, B, C, D, E, F, G2, H, I** をそれぞれ独立したサブエージェント等に割り当てて、**完全並列処理による改修**を行います。
> ③ 最後にビルドテストとリンターを実行して完了とします。
